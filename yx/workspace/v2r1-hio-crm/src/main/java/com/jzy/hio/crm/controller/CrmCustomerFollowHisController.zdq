package com.jzy.hio.crm.controller;

import java.util.List;

import com.jzy.hio.base.BaseConstants;
import com.jzy.hio.crm.dto.CrmCustomerFollowHisNewDto;
import com.jzy.hio.crm.service.CrmCustomerService;
import com.jzy.hio.entity.CrmCustomer;
import com.jzy.hio.exception.HioException;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.jzy.hio.base.controller.BaseController;
import com.jzy.hio.crm.param.CrmCustomerFollowHisParam;
import com.jzy.hio.crm.service.CrmCustomerFollowHisService;
import com.jzy.hio.crm.utils.PageResult;
import com.jzy.hio.entity.CrmCustomerFollowHis;
import com.jzy.hio.springmvc.ApiResponse;

/**
 * 跟进记录
 * @author 
 *
 */
@RestController
@RequestMapping("/followHis")
public class CrmCustomerFollowHisController extends BaseController {

	@Autowired
	private CrmCustomerFollowHisService crmCustomerFollowHisService;
	@Autowired
	private CrmCustomerService crmCustomerService;

	
	/**
	 * 查询跟进记录
	 * @param followHis
	 * @return
	 */
	@PostMapping("queryList")
	public ApiResponse<List<CrmCustomerFollowHis>> queryList(@RequestBody CrmCustomerFollowHis followHis) {
		ApiResponse<List<CrmCustomerFollowHis>> res = new ApiResponse<>(200, "查询成功");
		String uid = getUserIdOA();
		followHis.setCreatePersonId(uid);
		List<CrmCustomerFollowHis> followHisList = crmCustomerFollowHisService.queryList(followHis);
		res.setResult(followHisList);
		return res;
	}

	/**
	 * 客户  计划 联系人 商机 跟进记录
	 * @param crmCustomerFollowHisParam
	 * @return
	 */
	@PostMapping("/queryHisList")
	public PageResult queryHisList(@RequestBody CrmCustomerFollowHisParam crmCustomerFollowHisParam){
		String uid = getUserIdOA();
		if (!isRolePermission(BaseConstants.MYSQL_MENU_CODE_CRM_MANAGE)) {
			crmCustomerFollowHisParam.setUid(uid);
		}
	  return crmCustomerFollowHisService.queryHisList(crmCustomerFollowHisParam);
	}
	
	
    /**
     * 查询跟进记录
     *
     * @param id
     * @return
     */
    @PostMapping("/get/{id}")
    public ApiResponse<CrmCustomerFollowHisNewDto> get(@PathVariable("id") String id) {
    	ApiResponse<CrmCustomerFollowHisNewDto> res = new ApiResponse<>(200, "查询成功");
    	CrmCustomerFollowHis customerFollowHis = crmCustomerFollowHisService.getObjectById(id);
    	if (customerFollowHis == null) {
             res.setMessage("跟进记录不存在或已删除");
             res.setStatus(101);
             return res;
         }

		CrmCustomerFollowHisNewDto hisDto = new CrmCustomerFollowHisNewDto();
		BeanUtils.copyProperties(customerFollowHis, hisDto);
		CrmCustomer customerFind = crmCustomerService.getObjectById(customerFollowHis.getCustomerId());
		if (customerFind == null) {
			throw new HioException("未找到客户");
		}
		hisDto.setCustomerName(customerFind.getName());

		if (!isRolePermission(BaseConstants.MYSQL_MENU_CODE_CRM_MANAGE)) {
			String uid = getUserIdOA();

			if (!customerFind.getOwnerPersonId().equals(uid)) {
				throw new HioException("您没有该客户权限");
			}
		}
    	 res.setResult(hisDto);
    	 return res;
    }
    
    
}
