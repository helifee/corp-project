package com.jzy.hio.platform.userinfo.service;

import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitHandler;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.jzy.hio.entity.StarInfo;
import com.jzy.hio.platform.constant.MqCodeConstant;
import com.jzy.hio.platform.login.util.Base;
import com.rabbitmq.client.Channel;

/**
 * 创建特别关注消息消费者
 * @author 
 *
 */
@Component
public class StarInfoReceiver {
	protected Logger logger = LoggerFactory.getLogger(this.getClass());
	
	@Autowired
	private StarInfoService starInfoService;
	
	// chc edit 2018-04-19
	@RabbitListener(queues = "${queue.imStarInfoQueue}", containerFactory="rabbitListenerContainerFactory")
	@RabbitHandler
    public void process(Message message, Channel channel) {
		try {
			Map<String,Object> map = Base.json2map(new String(message.getBody(),"utf-8"));
			StarInfo starInfo = Base.map2obj(map, StarInfo.class);
			switch ((Integer)map.get("code")) {
			case MqCodeConstant.DELETE:
				starInfoService.deleteByUidFid(starInfo);
				break;
			default:
				starInfoService.deleteAndSaveStar(starInfo);
				break;
			}
			channel.basicAck(message.getMessageProperties().getDeliveryTag(), true);
		}catch(Exception e) {
			e.printStackTrace();
			logger.error("特别关注失败：{}" , e.getMessage());
		}
    }
	
}
