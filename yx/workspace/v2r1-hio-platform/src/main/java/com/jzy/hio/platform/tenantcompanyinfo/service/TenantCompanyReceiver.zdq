package com.jzy.hio.platform.tenantcompanyinfo.service;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitHandler;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.jzy.hio.base.Base;
import com.jzy.hio.entity.TenantCompanyInfo;
import com.rabbitmq.client.Channel;

/**
 * 租户信息消费者
 * @author chc
 *	2018年4月3日
 */
@Component
public class TenantCompanyReceiver {
	protected Logger logger = LoggerFactory.getLogger(this.getClass());
	@Autowired
	private TenantCompanyInfoService TenantCompanyInfoService;
	
    /**
     * 消费操作为输出消息的字符串内容
     * @param hello
     */
	@RabbitListener(queues = "${queue.tenantCompanyInfo}", containerFactory="rabbitListenerContainerFactory")
    @RabbitHandler
    public void process(Message message, Channel channel) {
        System.out.println("Receiver : " + message.getBody());
        try {
        TenantCompanyInfo tenantCompanyInfo = Base.json2obj(new String(message.getBody(),"utf-8"), TenantCompanyInfo.class);
	        if(null != TenantCompanyInfoService.getObjectById(tenantCompanyInfo.getId())) {
	        	TenantCompanyInfoService.update(tenantCompanyInfo);
	        }else {
	        	TenantCompanyInfoService.save(tenantCompanyInfo);
	        }
	        channel.basicAck(message.getMessageProperties().getDeliveryTag(), true);
        }catch(Exception e) {
        	logger.error("保存租户信息失败{}" , e.getMessage());
        }
    }
}
