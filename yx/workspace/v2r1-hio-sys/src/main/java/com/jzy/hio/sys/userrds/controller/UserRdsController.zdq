package com.jzy.hio.sys.userrds.controller;

import com.jzy.hio.base.controller.BaseController;
import com.jzy.hio.entity.OaSysRole;
import com.jzy.hio.redis.entity.UserRds;
import com.jzy.hio.redis.service.RedisSetService;
import com.jzy.hio.sys.organization.dto.OrganizationDto;
import com.jzy.hio.sys.organization.service.OrganizationService;
import com.jzy.hio.sys.role.service.RoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

/**
 * userRds相关的操作
 * 
 * @author wt.coffee
 * @date 2018年4月16日下午1:51:44
 */
@RestController
@RequestMapping("userRds")
public class UserRdsController extends BaseController {

	@Autowired
	private OrganizationService organizationService;
	@Autowired
	private RoleService roleService;
	@Autowired
	private RedisSetService redisSetService;

	/**
	 * 把用户信息组装到rds里
	 * 
	 * @param tendId
	 * @param userId
	 * @return
	 */
	@RequestMapping("setUserRds")
	public Object setUserRds(@RequestParam("tendId") String tendId, @RequestParam("userId") String userId) {
		// getLoginUser();
		UserRds userRds = new UserRds();
		userRds.setUserId(userId);
		//
		List<OrganizationDto> orgs = organizationService.queryOrganizationsByUserId(tendId, userId);
		if (isEmpty(orgs)) {
			logger.error("{} 用户{}的组织列表为空", tendId, userId);
		} else {
			List<String> ids = new ArrayList<>();
			for (OrganizationDto org : orgs) {
				ids.add(org.getId());
			}
			userRds.setOrgs(ids);
		}
		//
		List<OaSysRole> roles = roleService.queryRoleByUserId(tendId,userId);
		if (isEmpty(roles)) {
			logger.warn("{} 用户{}的角色列表为空 ", tendId, userId);
		} else {
			Set<String> ids = new HashSet<>();
			for (OaSysRole role : roles) {
				ids.add(role.getId());
			}
			userRds.setRoles(ids);
		}
		redisSetService.setUserDetails(tendId, userRds);
		return true;
	}
}
