package com.jzy.fileserver.printer.handler;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.jzy.fileserver.dao.PrinterDao;
import com.jzy.fileserver.printer.PrintEventMonitor;
import com.jzy.fileserver.printer.msg.BeatHeartMsg;
import com.jzy.fileserver.printer.msg.PrinterMsg;
import com.jzy.fileserver.printer.msg.external.BeatHeartMsgExternal;
import com.jzy.fileserver.socket.ServerBorad;
import com.jzy.fileserver.utils.JacksonUtils;

/**
 * 打印机心跳处理
 *
 * Created by daoqi on 2018年8月13日
 */
@Component
public class BeatHeartHandler extends BaseMsgHandler implements MsgHandler {
	
	@Autowired
	private PrinterDao printerDao;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String handle(PrinterMsg msg, PrintEventMonitor printEventMonitor) {
		super.handle(msg, printEventMonitor);
		
		BeatHeartMsg beatHeartMsg = (BeatHeartMsg)msg;
//		String key = FileServerConstants.TASK_COUNTER + printEventMonitor.getHost();
//		String value = String.valueOf(beatHeartMsg.getTask_num());
//		RedisUtils.set(key, value, timeout, TimeUnit.MINUTES);
		
		int taskNum = beatHeartMsg.getTask_num();
		printerDao.updateTaskNumById(printEventMonitor.getPrinter().getId(), taskNum);
		
		BeatHeartMsgExternal beatHeartMsgExternal = convertToExternalVo(beatHeartMsg);
		
		ServerBorad.broadcast(JacksonUtils.toJson(beatHeartMsgExternal));
		
		return null;
	}

	private BeatHeartMsgExternal convertToExternalVo(BeatHeartMsg beatHeartMsg) {
		BeatHeartMsgExternal ret = new BeatHeartMsgExternal();
		ret.setMsgType(beatHeartMsg.getMsg_type());
		ret.setTaskNum(beatHeartMsg.getTask_num());
		ret.setTimestamp(beatHeartMsg.getTimestamp());
		return ret;
	}

}
