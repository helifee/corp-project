package com.jzy.fileserver.printer.handler;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.jzy.fileserver.dao.PrintTaskDao;
import com.jzy.fileserver.domain.PrintTaskVo;
import com.jzy.fileserver.printer.PrintEventMonitor;
import com.jzy.fileserver.printer.msg.PrinterMsg;
import com.jzy.fileserver.printer.msg.TaskUpdatePriorMsg;
import com.jzy.fileserver.printer.msg.external.TaskUpdatePriorMsgExternal;
import com.jzy.fileserver.socket.ServerBorad;
import com.jzy.fileserver.utils.JacksonUtils;

/**
 * 打印任务更新处理器
 *
 * Created by daoqi on 2018年8月14日
 */
@Component
public class TaskUpdatePriorMsgHandler extends BaseMsgHandler implements MsgHandler {
	
	@Autowired
	private PrintTaskDao printTaskDao;
	
	private static final Logger logger = LoggerFactory.getLogger(TaskUpdatePriorMsgHandler.class);

	@Override
	public String handle(PrinterMsg msg, PrintEventMonitor printEventMonitor) {
		super.handle(msg, printEventMonitor);
		TaskUpdatePriorMsg taskUpdatePriorMsg = (TaskUpdatePriorMsg)msg;
		if(taskUpdatePriorMsg.getRequest_result() == 0) {
			int taskId = taskUpdatePriorMsg.getTask_id();
			int taskPrior = taskUpdatePriorMsg.getTask_prior();
			printTaskDao.updateTaskPrior(taskId, taskPrior);
			
			PrintTaskVo printTaskVo = printTaskDao.findById(taskId);
			taskUpdatePriorMsg.setFile_id(printTaskVo.getFileId());
			TaskUpdatePriorMsgExternal taskAcceptMsgExternal = convertToExternalVo(taskUpdatePriorMsg);
			ServerBorad.broadcast(JacksonUtils.toJson(taskAcceptMsgExternal));
			
			logger.info("任务【{}】级别更新为{}", taskId, taskPrior);
			
		} else {
			
		}
		
		return null;
	}

	private TaskUpdatePriorMsgExternal convertToExternalVo(TaskUpdatePriorMsg taskUpdatePriorMsg) {
		// TODO Auto-generated method stub
		TaskUpdatePriorMsgExternal ret = new TaskUpdatePriorMsgExternal();
		ret.setMsgType(taskUpdatePriorMsg.getMsg_type());
		ret.setConfId(taskUpdatePriorMsg.getConf_id());
		ret.setGroupId(taskUpdatePriorMsg.getGroup_id());
		ret.setFileId(taskUpdatePriorMsg.getFile_id());
		ret.setTaskPrior(taskUpdatePriorMsg.getTask_prior());
		ret.setRequestResult(taskUpdatePriorMsg.getRequest_result());
		return ret;
	}

}
