package com.jzy.hio.base.springmvc;

import java.io.IOException;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.springframework.core.MethodParameter;
import org.springframework.http.converter.HttpMessageConverter;
import org.springframework.web.HttpMediaTypeNotAcceptableException;
import org.springframework.web.accept.ContentNegotiationManager;
import org.springframework.web.context.request.NativeWebRequest;
import org.springframework.web.method.support.ModelAndViewContainer;
import org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor;

import com.jzy.hio.base.exception.HioException;
import com.jzy.hio.base.utils.MessageResult;
import com.jzy.tools.data.JacksonUtils;

/**
 * 处理requestMapping--responseBody
 * 
 * @author coffee<br/>
 *         2018年3月5日上午9:24:19
 */
public class RequestResponseBodyMethodProcessorExt extends RequestResponseBodyMethodProcessor {

	public RequestResponseBodyMethodProcessorExt(List<HttpMessageConverter<?>> messageConverters) {
		super(messageConverters);
	}

	public RequestResponseBodyMethodProcessorExt(List<HttpMessageConverter<?>> messageConverters, ContentNegotiationManager contentNegotiationManager) {
		super(messageConverters, contentNegotiationManager);
	}

	@Override
	public void handleReturnValue(Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)
			throws IOException, HttpMediaTypeNotAcceptableException {
		Object result = returnValue;
		// 暂时兼容老代码
		if (returnValue instanceof MessageResult) {
			super.handleReturnValue(returnValue, returnType, mavContainer, webRequest);
		} else {
			ApiResponse<Object> data = null;
			if (returnValue instanceof HioException) {
				HioException exception = (HioException) returnValue;
				data = new ApiResponse<>(exception);
			} else {
				data = new ApiResponse<>();
				data.setCode(1);
				data.setResult(returnValue);
			}
			result = JacksonUtils.toJson(data);
			super.handleReturnValue(result, returnType, mavContainer, webRequest);
		}
		HttpServletRequest request = (HttpServletRequest) webRequest.getNativeRequest();
		request.setAttribute("responseBody", result);
	}
}
