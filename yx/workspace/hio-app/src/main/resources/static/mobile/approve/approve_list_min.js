var path;$(function(){var E=window.document.location.href;var D=window.document.location.pathname;var A=E.indexOf(D);var B=E.substring(0,A);var C=D.substring(0,D.substr(1).indexOf("/")+1);path=B+C});mui.init();var startPosition1=0;var startPosition2=0;var startPosition3=0;var startPosition4=0;var count1=0;var count2=0;var count3=0;var count4=0;$(function(){initUserInfo();var A=$.getUrlParam("isMy");if(A&&A=="1"){$("#sliderSegmentedControl").remove();$("title").html("我的发起");$("#ds").css("display","none");$("#dy").css("display","none");$("#yb").css("display","none");$("#ds_div").css("display","none");$("#dy_div").css("display","none");$("#yb_div").css("display","none");getToDoData(0,true,3)}else{changeMenu();queryAndShowToDoSum()}});$.getUrlParam=function(B){var C=new RegExp("(^|&)"+B+"=([^&]*)(&|$)");var A=decodeURI(window.location.search).substr(1).match(C);if(A!=null){return unescape(A[2])}return null};function changeMenu(){var A=$.getUrlParam("menu");if(!A){A=0}mui("#slider").slider().gotoItem(A);getToDoData(0,true,A)}function getTextUrlParams(B){var A=B.substring(B.indexOf("?"));A=A.replace("?","").replace(/&/g,'","');A=A.replace(/=/g,'":"');if(A!=""){try{A=JSON.parse('{"'+A+'"}')}catch(C){}}return A}var currentUserLoginName;function initUserInfo(){var B="/sys/org/user/getMyInfo?time="+Math.random();var A=path+B;$.ajax({type:"get",url:A,dataType:"JSON",async:false,success:function(C){currentUserLoginName=C.result.loginName},error:function(D,C,E){alert("获取用户请求失败")}})}function taskView(B){var C=getTextUrlParams(B).tendCode;var A=checkLogin(C);if(!A){if(C){window.open("/platform-app/login.html?tendCode="+C+"&_time="+Math.random(),"_self")}else{window.open("/platform-app/login.html?_time="+Math.random(),"_self")}return}return C}function checkLogin(C){var A=true;var B=path+"/sys/thirdPartyAuthentication/checkLogin?_time="+new Date().getTime();if(currentUserLoginName){B=B+"&loginName="+currentUserLoginName}if(C){B+="&tendCode="+C+"&_s="+C}$.ajax({type:"GET",url:B,dataType:"JSON",async:false,success:function(D){A=D.success},error:function(D){A=false}});return A}function queryAndShowToDoSum(){var A="/platform-app/flow/sysNoticeMsg/queryTwoSumData";$.ajax({type:"POST",url:A,data:JSON.stringify({}),contentType:"application/json",dataType:"JSON",success:function(B){if(B.success){var C=B.result[0];if(C&&C.toDoSum&&C.toDoSum>0){$("#toDoSum").text(C.toDoSum);$("#toDoSum").show()}else{$("#toDoSum").text("");$("#toDoSum").hide()}if(C&&C.toReadSum&&C.toReadSum>0){$("#toReadSum").text(C.toReadSum);$("#toReadSum").show()}else{$("#toReadSum").text("");$("#toReadSum").hide()}}else{$("#toDoSum").text("");$("#toDoSum").hide();$("#toReadSum").text("");$("#toReadSum").hide()}}})}function getToDoData(E,F,B){var C;var A={start:E,limit:25};C="/platform-app/flow/sysNoticeMsg/searchDataByKeyword";if(B==0){A.dataType="DB"}else{if(B==1){A.dataType="DY"}else{if(B==2){A.dataType="HAVE_DONE"}else{if(B==3){A.dataType="FQ"}}}}A.more=true;var D;$.ajax({type:"POST",url:C,data:JSON.stringify(A),contentType:"application/json",dataType:"JSON",success:function(H){var G=H.result;var I=G.list;var K;if(B==0){K=$("#ds_div")}else{if(B==1){K=$("#dy_div")}else{if(B==2){K=$("#yb_div")}else{if(B==3){K=$("#fq_div")}}}}K.find(".mui-pull-loading").html("下拉重新加载");if(I){var J;if(B==0){J=$("#tab_1");count1=G.total}else{if(B==1){J=$("#tab_2");count2=G.total}else{if(B==2){J=$("#tab_3");count3=G.total}else{if(B==3){J=$("#tab_4");count4=G.total}}}}if(F){J.empty()}if(I.length>7){K.find(".mui-pull-loading").html("上拉显示更多")}J.append(showListFragment(I,B))}}})}var showListFragment=function(C,F){var A=document.createDocumentFragment();var E;for(var I=0;I<C.length;I++){var M=C[I];var J;var K;var L;var B;var G=M.sendDate;if(G){var H=G.replace(/-/g,"/");var D=new Date(H);K=D.getTime()}J=new Date().getTime()-K;if(J>0){L=J/(1000*60*60);L=L|0}if(L>0){B="停留"+L+"小时"}else{B="停留0小时"}E=$("<li></li>");E.addClass("mui-table-view-cell");E.attr("id",M.id+"_"+F);E.attr("data-urlText",encodeURI(M.mobibleUrl));var H;if(F==0||F==1){H="<h4 class='mui-ellipsis-2' style='word-break: break-all;word-wrap: break-word;font-weight: normal'>"+M.title+"</h4>";if(B!=undefined){H+="<h5><i class='mui-icon iconfont icon-shijian'></i>"+B+"</h5>"}}else{H="<h4 class='mui-ellipsis-2' style='word-break: break-all;word-wrap: break-word;font-weight: normal'>"+M.title+"</h4>"}$(E).html(H);$(A).append(E)}return A};var keywords=["2017年度考核","2017年考核"];mui(".mui-table-view").on("tap",".mui-table-view-cell",function(){if($(this).parents(".mui-active").attr("id")=="ds_div"){var G=$(this).find("h4").text();var F=false;for(var D in keywords){if(G.indexOf(keywords[D])>-1){F=true}}if(F){alert("请在pc端查看");return}}var B=$(this).attr("id");var C=$(this).attr("data-urlText");var E=taskView(C);var A=B.split("_");setTimeout(function(){var H=C;if(C&&C.indexOf("msgId=")<0){if(C.indexOf("?")>=0){C=C+"&msgId="+A[0]+"&users=[]&isback=N&opCode=NA&tabIdx="+A[1]+"&time="+Math.random()}else{C=C+"?msgId="+A[0]+"&users=[]&isback=N&opCode=NA&tabIdx="+A[1]+"&time="+Math.random()}}else{if(C.indexOf("?")>=0){C=C+"&time="+Math.random()}else{C=C+"?time="+Math.random()}}if(E){C+="&_s="+E}if(C&&C.indexOf("UserId")>0){C=H}if(C&&C.indexOf("http")==0){window.location.href=C}else{window.location.href=path+"/"+C}},1000)});(function(B){var A=mui.os.ios?0.003:0.0009;B(".mui-scroll-wrapper").scroll({bounce:false,indicators:true,deceleration:A});B.ready(function(){B.each(document.querySelectorAll(".mui-slider-group .mui-scroll"),function(D,C){B(C).pullToRefresh({down:{callback:function(){if(D==0){startPosition1=0}else{if(D==1){startPosition2=0}else{if(D==2){startPosition3=0}else{if(D==3){startPosition4=0}}}}var E=this;E.refresh(true);setTimeout(function(){if(D==0){getToDoData(startPosition1,true,D);queryAndShowToDoSum()}else{if(D==1){getToDoData(startPosition2,true,D);queryAndShowToDoSum()}else{if(D==2){getToDoData(startPosition3,true,D)}else{if(D==3){getToDoData(startPosition4,true,D)}}}}E.endPullDownToRefresh()},1000)}},up:{callback:function(){var E=this;if(D==0){startPosition1+=25;if(startPosition1>count1){E.endPullUpToRefresh(true);return}}else{if(D==1){startPosition2+=25;if(startPosition2>count2){E.endPullUpToRefresh(true);return}}else{if(D==2){startPosition3+=25;if(startPosition3>count3){E.endPullUpToRefresh(true);return}}else{if(D==3){startPosition4+=25;if(startPosition4>count4){E.endPullUpToRefresh(true);return}}}}}setTimeout(function(){if(D==0){getToDoData(startPosition1,false,D)}else{if(D==1){getToDoData(startPosition2,false,D)}else{if(D==2){getToDoData(startPosition3,false,D)}else{if(D==3){getToDoData(startPosition4,false,D)}}}}E.endPullUpToRefresh(false)},1000)}}})})})})(mui);document.addEventListener("WeixinJSBridgeReady",function onBridgeReady(){WeixinJSBridge.call("hideOptionMenu");WeixinJSBridge.call("hideToolbar")});document.getElementById("ds").addEventListener("tap",function(){getToDoData(0,true,0);queryAndShowToDoSum()});document.getElementById("dy").addEventListener("tap",function(){getToDoData(0,true,1);queryAndShowToDoSum()});document.getElementById("yb").addEventListener("tap",function(){getToDoData(0,true,2)});document.getElementById("fq").addEventListener("tap",function(){getToDoData(0,true,3)});