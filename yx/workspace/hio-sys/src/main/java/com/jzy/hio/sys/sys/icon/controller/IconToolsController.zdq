package com.jzy.hio.sys.sys.icon.controller;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectOutputStream;
import java.io.PrintWriter;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletResponse;

import org.csource.common.NameValuePair;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;

import com.jzy.hio.base.utils.FastDFSClient;
import com.jzy.hio.base.utils.LoginUtils;
import com.jzy.hio.base.utils.MessageInfo;
import com.jzy.hio.base.utils.MessageResult;
import com.jzy.hio.base.utils.Page;
import com.jzy.hio.base.utils.ResponseModel;
import com.jzy.hio.base.utils.SecurityUserBeanInfo;
import com.jzy.hio.sys.sys.icon.dto.IconToolsDto;
import com.jzy.hio.sys.sys.icon.entity.IconTools;
import com.jzy.hio.sys.sys.icon.service.IconToolsService;
import com.jzy.tools.data.JacksonUtils;

import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;


/**
 * 平台icon控制层
 * @author admin
 *
 */
@Controller
@RequestMapping("/sys/iconTools")
public class IconToolsController {

	private static Logger log = LoggerFactory.getLogger(IconToolsController.class);

	@Value("${attachment.port}")
	private String attachmentPort;
//	@Autowired
//	private IconToolsDtoServiceCustomer iconToolsDtoServiceCustomer;
	@Autowired
    private IconToolsService iconToolsService;
	
	/**
	 * 根据Id获取业务对象
	 * 
	 * @param id  业务对象主键
	 * 
	 * @return     业务对象
	 */
	@ApiOperation(value = "根据Id获取业务对象", notes = "根据Id获取业务对象")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "path", name = "id", dataType = "String", value = "id", required = true)})
	@RequestMapping(value="/get/{id}",method=RequestMethod.GET)
	public @ResponseBody MessageResult get(@PathVariable("id")  String id){
		try {
			IconTools	result = iconToolsService.getObjectById(id);
			return ResponseModel.getResult(MessageInfo.GETSUCCESS,result);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}
		
		/*MessageResult result=new MessageResult();
		try {
			String dubboResultInfo=iconToolsDtoServiceCustomer.getObjectById(getUserInfoJson(), "{\"id\":\""+id+"\"}");
			DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
			if(dubboServiceResultInfo.isSucess()){
				String resultInfo= dubboServiceResultInfo.getResult();
				IconToolsDto iconToolsDto=JacksonUtils.fromJson(resultInfo, IconToolsDto.class);
				result.setResult(iconToolsDto);
				result.setSuccess(MessageInfo.GETSUCCESS.isResult());
				result.setMsg(MessageInfo.GETSUCCESS.getMsg());
			}else{
				result.setSuccess(MessageInfo.GETERROR.isResult());
				result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
			}
		} catch (Exception e) {
			e.printStackTrace();
		    log.error("调用get方法:  【参数"+id+"】======"+"【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.GETERROR.isResult());
			result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		return result;*/
	}
	
	
	/**
	 * 返回分页对象
	 * @param paramater
	 * @return
	 */
	@ApiOperation(value = "返回分页对象", notes = "返回分页对象")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "body", name = "map", dataType = "String", value = "map", required = true)})
	@RequestMapping(value="/page",method={RequestMethod.POST}, consumes="application/json")
	public @ResponseBody MessageResult page(@RequestBody Map<String,Object> map){
		try {
			Page page=iconToolsService.getDataByPage(map);
			return ResponseModel.getResult(MessageInfo.GETSUCCESS,page);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}
		
		/*MessageResult result=new MessageResult();
		String paramaterJson = JacksonUtils.toJson(map);
		try {
		    String dubboResultInfo=iconToolsDtoServiceCustomer.getPage(getUserInfoJson(), paramaterJson);
		    DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
			if(dubboServiceResultInfo.isSucess()){
				String resultInfo= dubboServiceResultInfo.getResult();
				PageBeanInfo pageInfo=JacksonUtils.fromJson(resultInfo, PageBeanInfo.class);
				result.setResult(pageInfo);
				result.setSuccess(MessageInfo.GETSUCCESS.isResult());
				result.setMsg(MessageInfo.GETSUCCESS.getMsg());
			}else{
				result.setSuccess(MessageInfo.GETERROR.isResult());
				result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
			}
		} catch (Exception e) {
			e.printStackTrace();
		    log.error("调用page方法:  【参数"+paramaterJson+"】======"+"【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.GETERROR.isResult());
			result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		return result;*/
	}
	/**
	 * 返回符合条件的列表
	 * @param paramater
	 * @return
	 */
	@ApiOperation(value = "返回符合条件的列表", notes = "返回符合条件的列表")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "body", name = "map", dataType = "String", value = "map", required = true)})
	@RequestMapping(value="/queryList",method={RequestMethod.POST}, consumes="application/json")
	public @ResponseBody MessageResult queryList(@RequestBody Map<String,Object> map){
		try {
			List list=iconToolsService.queryListByExample(map);
			return ResponseModel.getResult(MessageInfo.GETSUCCESS,list);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}
		
		/*MessageResult result=new MessageResult();
		String paramaterJson = JacksonUtils.toJson(map);
		try {
			String dubboResultInfo=iconToolsDtoServiceCustomer.queryList(getUserInfoJson(), paramaterJson);
		    DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
		    if(dubboServiceResultInfo.isSucess()){
				String resultInfo= dubboServiceResultInfo.getResult();
				List<IconToolsDto> list=JacksonUtils.fromJson(resultInfo, ArrayList.class,IconToolsDto.class);
				result.setResult(list);
				result.setSuccess(MessageInfo.GETSUCCESS.isResult());
				result.setMsg(MessageInfo.GETSUCCESS.getMsg());
		    }else{
		    	result.setSuccess(MessageInfo.GETERROR.isResult());
				result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
		    }
			
		} catch (Exception e) {
			e.printStackTrace();
			log.error("调用queryList方法:  【参数"+paramaterJson+"】======"+"【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.GETERROR.isResult());
			result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		return result;*/
	}
	
	/**
	 * 返回符合条件的列表(get请求)
	 * @param paramater
	 * @return
	 */
	@ApiOperation(value = "返回符合条件的列表(get请求)", notes = "返回符合条件的列表(get请求)")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "body", name = "map", dataType = "String", value = "map", required = true)})
	@RequestMapping(value="/getIcon/{code}",method=RequestMethod.GET)
	public @ResponseBody MessageResult getIcon(@PathVariable("code")  String code){
		try {
			Map<String,Object> map = new HashMap<String,Object>();
			map.put("code",code);
			map.put("delflag",0);
			List list=iconToolsService.queryListByExample(map);
			return ResponseModel.getResult(MessageInfo.GETSUCCESS,list);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}
		
		/*MessageResult result=new MessageResult();
		Map<String,Object> map = new HashMap<String,Object>();
		try {
			map.put("code",code);
			map.put("delflag",0);
			String paramaterJson = JacksonUtils.toJson(map);
			String dubboResultInfo=iconToolsDtoServiceCustomer.queryList(getUserInfoJson(), paramaterJson);
		    DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
		    if(dubboServiceResultInfo.isSucess()){
		    	IconToolsDto iconToolsDto = null;
				String resultInfo= dubboServiceResultInfo.getResult();
				List<IconToolsDto> list=JacksonUtils.fromJson(resultInfo, ArrayList.class,IconToolsDto.class);
				if(list.size()>0) iconToolsDto = list.get(0);
				result.setResult(iconToolsDto);
				result.setSuccess(MessageInfo.GETSUCCESS.isResult());
				result.setMsg(MessageInfo.GETSUCCESS.getMsg());
		    }else{
		    	result.setSuccess(MessageInfo.GETERROR.isResult());
				result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
		    }
			
		} catch (Exception e) {
			e.printStackTrace();
			log.error("调用getLogo方法:【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.GETERROR.isResult());
			result.setMsg(MessageInfo.GETERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		return result;*/
	}


	/**
	 * 保存实体对象
	 * @param t
	 * @return
	 */
	@ApiOperation(value = "保存实体对象", notes = "保存实体对象")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "body", name = "bean", dataType = "String", value = "bean", required = true)})
	@RequestMapping(value = "/save",method = RequestMethod.POST)
    public void save(MultipartHttpServletRequest request, HttpServletResponse response) {
		MessageResult result = new MessageResult();
        IconToolsDto t = new IconToolsDto();
        PrintWriter pw = null;
		Boolean isReturn = true;
		try {
			response.setContentType("text/html;charset=UTF-8");
        	pw = response.getWriter();
			MultipartFile uploadfile =  request.getFile("pic");
        	if(uploadfile != null){
        		long length = uploadfile.getSize();
        		if(length>1*1024*1024){
        			result.setSuccess(false);
        			result.setMsg("图片尺寸不能大于1M");
        			pw.print(JacksonUtils.toJson(result));
					pw.flush();
					isReturn = false;
        		}
        	}
    		if(isReturn){
	    		String id = request.getParameter("id");
	    		String name = request.getParameter("name");
				String code = request.getParameter("code");
				String uploadFileName = "";
				String fileExtName = "";
				if (null != uploadfile) {
					// 文件名
					uploadFileName = uploadfile.getOriginalFilename();
					int dotIndex = uploadFileName.lastIndexOf('.');
					fileExtName = uploadFileName.substring(dotIndex + 1);
					// 元数据信息
					NameValuePair[] metaList = new NameValuePair[3];
					metaList[0] = new NameValuePair("fileName", uploadFileName);
					metaList[1] = new NameValuePair("fileExtName",fileExtName );
					metaList[2] = new NameValuePair("fileLength", String.valueOf(uploadfile.getSize()));
					String[] upResults = new FastDFSClient().upload(uploadfile.getBytes(), uploadFileName.substring(0, dotIndex),metaList);
					t.setUrl("http://"+new FastDFSClient().getFileAddrIP(upResults[0], upResults[1])+":"+attachmentPort+"/"+upResults[0] + "/" + upResults[1]);
					t.setExtendName(fileExtName);
					t.setFullName(uploadFileName);
					t.setIconSize(uploadfile.getSize());
				}
				t.setId(id);
				t.setCode(code);
				t.setName(name);
				t.setDelflag(false);
	            String saveJson = JacksonUtils.toJson(t);
	            //校验编码重复
	            Map<String,Object> param=new HashMap<String,Object>();
	            param.put("code", code);
	            Integer isc=iconToolsService.getCodeCount(param);
	            if(isc>0){
	            	String str = "编码重复!";
	            }else{
	            	IconTools iconTools = new IconTools();
	            	BeanUtils.copyProperties(t, iconTools);
	                iconToolsService.save(iconTools);
	            }
	            pw.print(JacksonUtils.toJson(result));
				pw.flush();
    		}
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
		} finally {
			try {
				pw.close();
			} catch (Exception e){}
		}
		
		
        /*MessageResult result = new MessageResult();
        IconToolsDto t = new IconToolsDto();
        PrintWriter pw = null;
		Boolean isReturn = true;
        try {
        	response.setContentType("text/html;charset=UTF-8");
        	pw = response.getWriter();
			MultipartFile uploadfile =  request.getFile("pic");
        	if(uploadfile != null){
        		long length = uploadfile.getSize();
        		if(length>1*1024*1024){
        			result.setSuccess(false);
        			result.setMsg("图片尺寸不能大于1M");
        			pw.print(JacksonUtils.toJson(result));
					pw.flush();
					isReturn = false;
        		}
        	}
    		if(isReturn){
	    		String id = request.getParameter("id");
	    		String name = request.getParameter("name");
				String code = request.getParameter("code");
				String uploadFileName = "";
				String fileExtName = "";
				if (null != uploadfile) {
					// 文件名
					uploadFileName = uploadfile.getOriginalFilename();
					int dotIndex = uploadFileName.lastIndexOf('.');
					fileExtName = uploadFileName.substring(dotIndex + 1);
					// 元数据信息
					NameValuePair[] metaList = new NameValuePair[3];
					metaList[0] = new NameValuePair("fileName", uploadFileName);
					metaList[1] = new NameValuePair("fileExtName",fileExtName );
					metaList[2] = new NameValuePair("fileLength", String.valueOf(uploadfile.getSize()));
					String[] upResults = new FastDFSClient().upload(uploadfile.getBytes(), uploadFileName.substring(0, dotIndex),metaList);
					t.setUrl("http://"+new FastDFSClient().getFileAddrIP(upResults[0], upResults[1])+":"+attachmentPort+"/"+upResults[0] + "/" + upResults[1]);
					t.setExtendName(fileExtName);
					t.setFullName(uploadFileName);
					t.setIconSize(uploadfile.getSize());
				}
				t.setId(id);
				t.setCode(code);
				t.setName(name);
				t.setDelflag(false);
	            String saveJson = JacksonUtils.toJson(t);
	            String dubboResultInfo = iconToolsDtoServiceCustomer.save(getUserInfoJson(), saveJson);
	            DubboServiceResultInfo dubboServiceResultInfo = JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
	            if (dubboServiceResultInfo.isSucess()) {
	                String resultInfo = dubboServiceResultInfo.getResult();
	                ShortcutMenuDto shortcutMenuDto = JacksonUtils.fromJson(resultInfo, ShortcutMenuDto.class);
	                result.setResult(shortcutMenuDto);
	                result.setSuccess(MessageInfo.SAVESUCCESS.isResult());
	                result.setMsg(MessageInfo.SAVESUCCESS.getMsg());
	            } else {
	                result.setSuccess(MessageInfo.SAVEERROR.isResult());
	                String msg = dubboServiceResultInfo.getExceptionMsg()==null?dubboServiceResultInfo.getMsg():dubboServiceResultInfo.getExceptionMsg();
	                result.setMsg(MessageInfo.SAVEERROR.getMsg() + "【" + msg + "】");
	            }
	            pw.print(JacksonUtils.toJson(result));
				pw.flush();
    		}
        } catch (Exception e) {
            try {
                ObjectMapper mapper = new ObjectMapper();
                String paramJson = mapper.writeValueAsString(t);
                log.error("调用save方法:  【参数" + paramJson + "】======" + "【" + e.getMessage() + "】");
                result.setSuccess(MessageInfo.SAVEERROR.isResult());
                result.setMsg(MessageInfo.SAVEERROR.getMsg() + "【" + e.getMessage() + "】");
                pw.print(JacksonUtils.toJson(result));
				pw.flush();
            } catch (JsonProcessingException e1) {
                // TODO Auto-generated catch block
                e1.printStackTrace();
            }

        }finally {
			try {
				pw.close();
			} catch (Exception e){}
		}*/
    }
	
	/**
	 * 删除实体对象
	 * @param t
	 * @return
	 */
	@ApiOperation(value = "删除实体对象", notes = "删除实体对象")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "path", name = "id", value = "id", required = true, dataType = "String")})
	@RequestMapping(value="/delete/{id}",method=RequestMethod.DELETE)
	public @ResponseBody MessageResult delete(@PathVariable("id")  String id){
		try {
			int result= iconToolsService.deleteObjectById(id);
			return ResponseModel.getResult(MessageInfo.DELETESUCCESS,result);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}
		
		
		/*MessageResult result=new MessageResult();
		try {
			String dubboResultInfo=iconToolsDtoServiceCustomer.deleteObjectById(getUserInfoJson(), "{\"id\":\""+id+"\"}");
			DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
			if(dubboServiceResultInfo.isSucess()){
				String resultInfo= dubboServiceResultInfo.getResult();
				IconToolsDto iconToolsDto=JacksonUtils.fromJson(resultInfo, IconToolsDto.class);
				result.setResult(iconToolsDto);
				result.setSuccess(MessageInfo.DELETESUCCESS.isResult());
				result.setMsg(MessageInfo.DELETESUCCESS.getMsg());
			}else{
				result.setSuccess(MessageInfo.DELETEERROR.isResult());
				result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
			}
		} catch (Exception e) {
			e.printStackTrace();
		    log.error("调用delete方法:  【参数"+id+"】======"+"【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.DELETEERROR.isResult());
			result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		
		return result;*/
	}
	
	
	/**
	 * 删除实体对象
	 * @param t
	 * @return
	 */
	@ApiOperation(value = "批量删除实体对象", notes = "批量删除实体对象")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "path", name = "ids", value = "ids", required = true, dataType = "String")})
	@RequestMapping(value="/deleteBatch/{ids}",method=RequestMethod.DELETE)
	public @ResponseBody MessageResult deleteBatch(@PathVariable("ids")  String ids){
		try {
			List<String> list = Arrays.asList(ids.split(","));
            int result= iconToolsService.deleteAllObjectByIds(list);
			return ResponseModel.getResult(MessageInfo.DELETESUCCESS, result);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}

		/*MessageResult result=new MessageResult();
		try {
			String dubboResultInfo=iconToolsDtoServiceCustomer.deleteAllObjectByIds(getUserInfoJson(), "{\"id\":\""+ids+"\"}");
			DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
			if(dubboServiceResultInfo.isSucess()){
				String resultInfo= dubboServiceResultInfo.getResult();
				IconToolsDto iconToolsDto=JacksonUtils.fromJson(resultInfo, IconToolsDto.class);
				result.setResult(iconToolsDto);
				result.setSuccess(MessageInfo.DELETESUCCESS.isResult());
				result.setMsg(MessageInfo.DELETESUCCESS.getMsg());
			}else{
				result.setSuccess(MessageInfo.DELETEERROR.isResult());
				result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
			}
		} catch (Exception e) {
			e.printStackTrace();
		    log.error("调用delete方法:  【参数"+ids+"】======"+"【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.DELETEERROR.isResult());
			result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		
		return result;*/
	}
	
	/**
	 * 修改修改实体对象
	 * @param t
	 * @return
	 */
	@ApiOperation(value = "修改实体对象", notes = "修改实体对象")
    @ApiImplicitParams({@ApiImplicitParam(name = "id", value = "id", required = true, dataType = "Integer", paramType = "path"), @ApiImplicitParam(name = "map", value = "thi is map", dataType = "JSON")})
	@RequestMapping(value = "/update",method = RequestMethod.POST)
	public void update(MultipartHttpServletRequest request, HttpServletResponse response) {
		MessageResult result = new MessageResult();
        PrintWriter pw = null;
		Boolean isReturn = true;
        try {
        	response.setContentType("text/html;charset=UTF-8");
        	pw = response.getWriter();
			MultipartFile uploadfile =  request.getFile("pic");
			SecurityUserBeanInfo userBeanInfo = LoginUtils
					.getSecurityUserBeanInfo();
			String userJson = JacksonUtils.toJson(userBeanInfo);
        	if(uploadfile != null){
        		long length = uploadfile.getSize();
        		if(length>1*1024*1024){
        			result.setSuccess(false);
        			result.setMsg("图片尺寸不能大于1M");
        			pw.print(JacksonUtils.toJson(result));
					pw.flush();
					isReturn = false;
        		}
        	}
    		if(isReturn){
//				IconToolsDto iconToolsDto = new IconToolsDto();
				String id = request.getParameter("id");
				IconTools iconTools = iconToolsService.getObjectById(id);
//				String dubboResultInfo = iconToolsDtoServiceCustomer
//						.getObjectById(userJson, "{\"id\":\"" + id + "\"}");
//				DubboServiceResultInfo dubboServiceResultInfo = JacksonUtils
//						.fromJson(dubboResultInfo, DubboServiceResultInfo.class);

				if (iconTools != null) {
//					String resultInfo = dubboServiceResultInfo.getResult();
//					iconToolsDto = JacksonUtils.fromJson(resultInfo,
//							IconToolsDto.class);
					String name = request.getParameter("name");
					String code = request.getParameter("code");
					String isDelPic = request.getParameter("isDelPic");
					iconTools.setCode(code);
					iconTools.setId(id);
					iconTools.setName(name);
					String uploadFileName = "";
					String fileExtName = "";
					if (null != uploadfile) {
						if (uploadfile.getSize() > 0) {
							// 文件名
							uploadFileName = uploadfile.getOriginalFilename();
							int dotIndex = uploadFileName.lastIndexOf('.');
							fileExtName = uploadFileName.substring(dotIndex + 1);
							// 元数据信息
							NameValuePair[] metaList = new NameValuePair[3];
							metaList[0] = new NameValuePair("fileName", uploadFileName);
							metaList[1] = new NameValuePair("fileExtName",fileExtName );
							metaList[2] = new NameValuePair("fileLength", String.valueOf(uploadfile.getSize()));
							String[] upResults = new FastDFSClient().upload(uploadfile.getBytes(), fileExtName,metaList);
							iconTools.setUrl("http://"+new FastDFSClient().getFileAddrIP(upResults[0], upResults[1])+":"+attachmentPort+"/"+upResults[0] + "/" + upResults[1]);
							iconTools.setExtendName(fileExtName);
							iconTools.setFullName(uploadFileName);
							iconTools.setIconSize(uploadfile.getSize());
						}
					}else if("0".equals(isDelPic)){
						iconTools.setUrl(null);
					}
					iconTools.setDelflag(false);
					//校验编码重复
		            Map<String,Object> param=new HashMap<String,Object>();
		            param.put("code", iconTools.getCode());
		            param.put("id", iconTools.getId());
		            Integer isc=iconToolsService.getCodeCount(param);
		            if(isc>0){
		                String str = "编码重复!";
		            }else {
		                int updatecount = iconToolsService.update(iconTools);
		            }
				} else {
					result.setSuccess(MessageInfo.UPDATEERROR.isResult());
					result.setMsg("不存在更新的对象");
				}
				pw.print(JacksonUtils.toJson(result));
				pw.flush();
			}
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
		}finally {
			try {
				pw.close();
			} catch (Exception e){}
		}
        
		
        /*MessageResult result = new MessageResult();
        PrintWriter pw = null;
		Boolean isReturn = true;
        try {
        	response.setContentType("text/html;charset=UTF-8");
        	pw = response.getWriter();
			MultipartFile uploadfile =  request.getFile("pic");
			SecurityUserBeanInfo userBeanInfo = LoginUtils
					.getSecurityUserBeanInfo();
			String userJson = JacksonUtils.toJson(userBeanInfo);
        	if(uploadfile != null){
        		long length = uploadfile.getSize();
        		if(length>1*1024*1024){
        			result.setSuccess(false);
        			result.setMsg("图片尺寸不能大于1M");
        			pw.print(JacksonUtils.toJson(result));
					pw.flush();
					isReturn = false;
        		}
        	}
    		if(isReturn){
				IconToolsDto iconToolsDto = new IconToolsDto();
				String id = request.getParameter("id");
				String dubboResultInfo = iconToolsDtoServiceCustomer
						.getObjectById(userJson, "{\"id\":\"" + id + "\"}");
				DubboServiceResultInfo dubboServiceResultInfo = JacksonUtils
						.fromJson(dubboResultInfo, DubboServiceResultInfo.class);

				if (dubboServiceResultInfo.isSucess()) {
					String resultInfo = dubboServiceResultInfo.getResult();
					iconToolsDto = JacksonUtils.fromJson(resultInfo,
							IconToolsDto.class);
					String name = request.getParameter("name");
					String code = request.getParameter("code");
					String isDelPic = request.getParameter("isDelPic");
					iconToolsDto.setCode(code);
					iconToolsDto.setId(id);
					iconToolsDto.setName(name);
					String uploadFileName = "";
					String fileExtName = "";
					if (null != uploadfile) {
						if (uploadfile.getSize() > 0) {
							// 文件名
							uploadFileName = uploadfile.getOriginalFilename();
							int dotIndex = uploadFileName.lastIndexOf('.');
							fileExtName = uploadFileName.substring(dotIndex + 1);
							// 元数据信息
							NameValuePair[] metaList = new NameValuePair[3];
							metaList[0] = new NameValuePair("fileName", uploadFileName);
							metaList[1] = new NameValuePair("fileExtName",fileExtName );
							metaList[2] = new NameValuePair("fileLength", String.valueOf(uploadfile.getSize()));
							String[] upResults = new FastDFSClient().upload(uploadfile.getBytes(), fileExtName,metaList);
							iconToolsDto.setUrl("http://"+new FastDFSClient().getFileAddrIP(upResults[0], upResults[1])+":"+attachmentPort+"/"+upResults[0] + "/" + upResults[1]);
							iconToolsDto.setExtendName(fileExtName);
							iconToolsDto.setFullName(uploadFileName);
							iconToolsDto.setIconSize(uploadfile.getSize());
						}
					}else if("0".equals(isDelPic)){
						iconToolsDto.setUrl(null);
					}
					iconToolsDto.setDelflag(false);
					String updateJson = JacksonUtils.toJson(iconToolsDto);
					String updateDubboResultInfo = iconToolsDtoServiceCustomer
							.update(userJson, updateJson);
					DubboServiceResultInfo updateDubboServiceResultInfo = JacksonUtils
							.fromJson(updateDubboResultInfo,
									DubboServiceResultInfo.class);
					if (updateDubboServiceResultInfo.isSucess()) {
						Integer i = JacksonUtils.fromJson(
								updateDubboServiceResultInfo.getResult(),
								Integer.class);
						result.setResult(i);
						result.setSuccess(MessageInfo.UPDATESUCCESS.isResult());
						result.setMsg(MessageInfo.UPDATESUCCESS.getMsg());
					} else {
						result.setSuccess(MessageInfo.UPDATEERROR.isResult());
						result.setMsg(updateDubboServiceResultInfo.getMsg());
					}
				} else {
					result.setSuccess(MessageInfo.UPDATEERROR.isResult());
					result.setMsg("不存在更新的对象");
				}
				pw.print(JacksonUtils.toJson(result));
				pw.flush();
			}
        } catch (Exception e) {
			ObjectMapper mapper = new ObjectMapper();
			result.setSuccess(MessageInfo.SAVEERROR.isResult());
			result.setMsg(MessageInfo.SAVEERROR.getMsg() + "【" + e.getMessage() + "】");
			pw.print(JacksonUtils.toJson(result));
			pw.flush();
        }finally {
			try {
				pw.close();
			} catch (Exception e){}
		}*/
    }

	/**
	 * 伪删除实体对象
	 * @param t
	 * @return
	 */
	@ApiOperation(value = "伪删除实体对象", notes = "伪删除实体对象")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "path", name = "id", value = "id", required = true, dataType = "String")})
	@RequestMapping(value="/deletePseudo/{id}",method=RequestMethod.DELETE)
	public @ResponseBody MessageResult deletePseudo(@PathVariable("id")  String id){
		try {
			int result= iconToolsService.deletePseudoObjectById(id);
			return ResponseModel.getResult(MessageInfo.DELETESUCCESS,result);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}
		
		
		/*MessageResult result=new MessageResult();
		try {
			String dubboResultInfo=iconToolsDtoServiceCustomer.deletePseudoObjectById(getUserInfoJson(), "{\"id\":\""+id+"\"}");
			DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
			if(dubboServiceResultInfo.isSucess()){
				String resultInfo= dubboServiceResultInfo.getResult();
				IconToolsDto iconToolsDto=JacksonUtils.fromJson(resultInfo, IconToolsDto.class);
				result.setResult(iconToolsDto);
				result.setSuccess(MessageInfo.DELETESUCCESS.isResult());
				result.setMsg(MessageInfo.DELETESUCCESS.getMsg());
			}else{
				result.setSuccess(MessageInfo.DELETEERROR.isResult());
				result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
			}
		} catch (Exception e) {
			e.printStackTrace();
		    log.error("调用deletePseudo方法:  【参数"+id+"】======"+"【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.DELETEERROR.isResult());
			result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		
		return result;*/
	}
	
	
	/**
	 * 伪删除实体对象
	 * @param t
	 * @return
	 */
	@ApiOperation(value = "伪批量删除实体对象", notes = "伪批量删除实体对象")
    @ApiImplicitParams({@ApiImplicitParam(paramType = "path", name = "ids", value = "ids", required = true, dataType = "String")})
	@RequestMapping(value="/deletePseudoBatch/{ids}",method=RequestMethod.DELETE)
	public @ResponseBody MessageResult deletePseudoBatch(@PathVariable("ids")  String ids){
		try {
			List<String> list = Arrays.asList(ids.split(","));
            int result= iconToolsService.deletePseudoAllObjectByIds(list);
			return ResponseModel.getResult(MessageInfo.DELETESUCCESS, result);
		} catch (Exception e) {
			log.error("-----------"+e.getMessage()+"------------");   			
			e.printStackTrace();
			return ResponseModel.getErrorResult();
		}

		/*MessageResult result=new MessageResult();
		try {
			String dubboResultInfo=iconToolsDtoServiceCustomer.deletePseudoAllObjectByIds(getUserInfoJson(), "{\"id\":\""+ids+"\"}");
			DubboServiceResultInfo dubboServiceResultInfo= JacksonUtils.fromJson(dubboResultInfo, DubboServiceResultInfo.class);
			if(dubboServiceResultInfo.isSucess()){
				String resultInfo= dubboServiceResultInfo.getResult();
				IconToolsDto iconToolsDto=JacksonUtils.fromJson(resultInfo, IconToolsDto.class);
				result.setResult(iconToolsDto);
				result.setSuccess(MessageInfo.DELETESUCCESS.isResult());
				result.setMsg(MessageInfo.DELETESUCCESS.getMsg());
			}else{
				result.setSuccess(MessageInfo.DELETEERROR.isResult());
				result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+dubboServiceResultInfo.getExceptionMsg()+"】");
			}
		} catch (Exception e) {
			e.printStackTrace();
		    log.error("调用deletePseudoBatch方法:  【参数"+ids+"】======"+"【"+e.getMessage()+"】");
			result.setSuccess(MessageInfo.DELETEERROR.isResult());
			result.setMsg(MessageInfo.DELETEERROR.getMsg()+"【"+e.getMessage()+"】");
		}
		
		return result;*/
	}
	
	/**
	 * 获取用户信息
	 * @return 用户信息JSON格式字符串
	 */
	private String getUserInfoJson(){
		SecurityUserBeanInfo securityUserBeanInfo = LoginUtils.getSecurityUserBeanInfo();
		String userInfo = JacksonUtils.toJson(securityUserBeanInfo);
		return userInfo;
	}
	
	/** 
     * 对象转数组 
     * @param obj 
     * @return 
	 * @throws IOException 
     */  
    public byte[] toByteArray (Object obj) throws IOException {     
        byte[] bytes = null;     
        ByteArrayOutputStream bos = new ByteArrayOutputStream();     
        ObjectOutputStream oos = new ObjectOutputStream(bos);        
        oos.writeObject(obj);       
        oos.flush();        
        bytes = bos.toByteArray ();     
        oos.close();        
        bos.close();       
        return bytes;   
    }  
	
}
