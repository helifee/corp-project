<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jzy.hio.oa.task.mapper.TaskParticipantsMapper">

	<select id="queryTaskParticipantsList" resultType="com.jzy.hio.oa.task.dto.QueryTaskListDto">
		SELECT
		DISTINCT
		a.`task_id` AS taskId,
		a.`task_name` AS taskName,
		a.`task_progress` AS taskProgress,
		a.`end_date` AS endDate,
		a.`task_urgent_flag` AS taskUrgentFlag,
		a.`task_status` AS taskStatus,
		a.`task_liable_id` AS taskLiableId,b.sharedshow_id AS sharedshowiId,
		b.isfollow,b.sharedshow_imid AS sharedshowImid,b.outType,a.create_date AS createDate,
		a.`project_id` AS projectId 
		FROM
		pt_task a,
		pt_task_participants b
		WHERE a.`task_id` = b.`task_id` AND a.delflag = '0' AND b.delflag = '0' 
		
		<if test="taskName != null and taskName != ''">
			AND a.task_name like CONCAT('%',#{taskName},'%')
		</if>
		
		<if test="taskId != null and taskId != ''">
			AND a.task_id = #{taskId}
		</if>
		
		<if test="userId != null and userId != ''">
			AND b.sharedshow_id = #{userId}
		</if>
		
		<if test="taskStatus != null and taskStatus != ''">
			AND a.task_status = #{taskStatus}
		</if>
		
		<if test="dynamicSql == null">
			ORDER BY a.end_date desc
		</if>

		<if test="dynamicSql != null">
			${dynamicSql}
		</if>
		
		<if test="pageNum !=null and pageCount !=null ">
			limit #{pageNum},#{pageCount}
		</if>
		
	</select>
	
	<select id="queryCountTaskParticipantsList" resultType="java.lang.Integer">
		SELECT
		COUNT( DISTINCT a.`task_id`)
		FROM
		pt_task a,
		pt_task_participants b
		WHERE a.`task_id` = b.`task_id` AND a.delflag = '0' AND b.delflag = '0' 
		
		<if test="taskName != null and taskName != ''">
			AND a.task_name like CONCAT('%',#{taskName},'%')
		</if>
		
		<if test="taskId != null and taskId != ''">
			AND a.task_id = #{taskId}
		</if>
		
		<if test="userId != null and userId != ''">
			AND b.sharedshow_id = #{userId}
		</if>
		
		<if test="taskStatus != null and taskStatus != ''">
			AND a.task_status = #{taskStatus}
		</if>
		
		<if test="dynamicSql == null">
			ORDER BY a.end_date desc
		</if>

	</select>
	
	<update id="delete">
		UPDATE `pt_task_participants` a SET a.`delflag` =
		#{delflag} WHERE
		a.`task_id` = #{taskId}
	</update>
	
	<select id="queryList" resultType="com.jzy.hio.entity.TaskParticipants">
		SELECT id,task_id AS taskId,create_person_id AS createPersonId,create_person_name AS createPersonName,
		create_date AS createDate,update_person_id AS updatePersonId,update_person_name AS updatePersonName,
		update_date AS updateDate,type,sharedshow_id AS sharedshowId,delflag,concurrency_version AS concurrencyVersion,
		sharedshow_imid AS sharedshowImid,outType
		FROM pt_task_participants 
		WHERE delflag = '0'
		<if test="taskId != null">
			AND task_id = #{taskId}
		</if>
		<if test="sharedshowId != null">
			AND sharedshow_id = #{sharedshowId}
		</if>
		<if test="type != null">
			AND type = #{type}
		</if>
		<if test="sharedshowImid != null">
			AND sharedshow_imid = #{sharedshowImid}
		</if>
	</select>
	
	<update id="updateIsFollow">
		UPDATE `pt_task_participants` a SET a.`isfollow`
		= #{isfollow}
		WHERE a.`task_id` = #{taskId}
	</update>
</mapper>