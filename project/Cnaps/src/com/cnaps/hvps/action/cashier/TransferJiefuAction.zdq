package com.cnaps.hvps.action.cashier;

import java.util.ArrayList;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.bancstone.action.BaseAction;
import com.bancstone.common.exception.PicpMessageException;
import com.cnaps.coreservices.CommonXMLEntity;
import com.cnaps.coreservices.TransCodeEntity;
import com.cnaps.coreservices.TransServices;
import com.cnaps.hvps.form.transfer.PersonCrashSpanBankExchangeForm;

public class TransferJiefuAction  extends BaseAction<Object> {

	public ActionForward sendMessage(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		PersonCrashSpanBankExchangeForm voform = (PersonCrashSpanBankExchangeForm)form;
		try{
		String transactionid = TransCodeEntity.BEPS_CASHIER_TRANFERJIEFU;//功能代码
		commSetToXML(voform,request,transactionid);
		voform.getPo().setProposerNm(voform.getPo().getPayName());//申请人名称
		voform.getPo().setProposerAcct(voform.getPo().getPayerAcount());//申请人账号
		voform.getPo().setDraweracct(voform.getPo().getPayerAcount());//出票人账号
		voform.getPo().setDrawernm(voform.getPo().getPayName());//出票人全称
		voform.getPo().setIssueState("CN");//证件发行国家
		voform.getPo().setProposerAcctCcy("CNY");
		voform.getPo().setProposerNm1(voform.getPo().getProposerNm());
		voform.getPo().setProposerAcct1(voform.getPo().getProposerAcct());
		voform.getPo().setTotalMoney1(voform.getPo().getTotalMoney());
		voform.getPo().setEndToEndId(voform.getPo().getNotesnum());
		voform.setPmtGrpId(voform.getPo().getPaymentGroupNum());//支付交易组号
		voform.getPo().setSystemcd("BEPS");
		String [] endrsrNms=request.getParameterValues("endrsrNm");//背书人名称
		ArrayList<String> al=new ArrayList<String>();
		if(null!=endrsrNms && endrsrNms.length>0){
			for(int i=0;i<endrsrNms.length;i++){
				al.add(endrsrNms[i]);
			}
		}
		voform.getPo().getPoo().setEndrsrNms(al);
		//处理组装报文，发送解析
		TransServices transServices = (TransServices) this.getBean("transServices");
		CommonXMLEntity commonXMLEntity = null;
			commonXMLEntity = transServices.transProcess(voform, TransCodeEntity.BEPS_CASHIER_TRANFERJIEFU,
					"transaction", "");
		// 发送交易报文 并解析得到回应的信息
		String reslutmessage = "";// 处理信息
		if (!commonXMLEntity.getProcessCode().equals("000000")) {
			throw new PicpMessageException("错误码："
					+ commonXMLEntity.getProcessCode() + "错误信息："
					+ commonXMLEntity.getProcessDes());
		} else {
			reslutmessage = "处理成功码：" + commonXMLEntity.getProcessCode()
					+ "银行本票申请解付业务成功！";
		}
		return toSuccessPage(mapping, request, reslutmessage,voform.getPmtGrpId(),"","");
	} catch (Exception e) {
		e.printStackTrace();
		return toFailedPage(mapping, request, e.getMessage());
	}
		
	}

}
