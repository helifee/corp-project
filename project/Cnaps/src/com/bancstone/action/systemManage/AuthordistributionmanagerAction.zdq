/**
 * <p>项目名称：zhiNengT<p>
 * <ul>
 * <li>1、版权所有：驰波公司</li>
 * <li>2、开发作者：王亮</li>
 * <li>3、开发日期：Aug 18, 2010</li>
 * <li>4、开发时间：3:42:49 PM</li>
 * <li>5、文件名称：AuthordistributionmanagerAction.java</li>
 * <li>6、包路径名：com.bancstone.action.systemManage</li>
 * </ul>
 */
package com.bancstone.action.systemManage;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.bancstone.action.BaseAction;
import com.bancstone.common.utils.BeanUtil;
import com.bancstone.common.utils.StringUtil;
import com.bancstone.constants.MessageConstants;
import com.bancstone.constants.SystemConstants;
import com.bancstone.form.systemManage.AuthordistributionmanagerForm;
import com.bancstone.hibernate.systemManage.Authordistributionmanager;
import com.bancstone.service.systemManage.AuthordistributionmanagerServices;

/**
 * <ul>
 * <li>1、开发日期：Aug 18, 2010</li>
 * <li>2、开发时间：3:42:49 PM</li>
 * <li>3、类型名称：AuthordistributionmanagerAction</li>
 * <li>4、类型意图：权限分配Action</li>
 * </ul>
 * 
 * @author 王亮
 * 
 */
public class AuthordistributionmanagerAction extends BaseAction {
	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Aug 19, 2010</li>
	 * <li>3、开发时间：1:57:20 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：添加或者修改角色权限</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 */
	@SuppressWarnings("unchecked")
	public ActionForward addOrModifyAuthors(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) {
		String extJsRPB = request
				.getParameter(SystemConstants.EXTJS_REQUEST_PARAMETER_BEAN);
		AuthordistributionmanagerForm authordistributionmanagerForm = (AuthordistributionmanagerForm) form;
		Authordistributionmanager authordistributionmanager = new Authordistributionmanager();
		AuthordistributionmanagerServices authordistributioServices = (AuthordistributionmanagerServices) this
				.getBean(AuthordistributionmanagerServices.class);
		Authordistributionmanager am=null;
		try {
			authordistributionmanagerForm = (AuthordistributionmanagerForm) BeanUtil
					.JSONString2Bean(extJsRPB,
							AuthordistributionmanagerForm.class);
			BeanUtil.copyProperties2Object(authordistributionmanager,
					authordistributionmanagerForm);
			System.out.println("数据长度：========："
					+ authordistributionmanager.getMenuindentifiers().length());
			if (!"".equals(StringUtil.nullToString(authordistributionmanager
					.getIndentifier()))) {
				if (request.getParameter("op").equals("add")) {
					authordistributionmanager.setMenuindentifiers(StringUtil
							.stringConcat(this.getUserSystemAuthor(
									authordistributionmanager
											.getRoleindentifier())
									.getMenuindentifiers(),
									authordistributionmanagerForm
											.getMenuindentifiers(), ","));
				}
				authordistributioServices
						.modifyAuthors(authordistributionmanager);
			} else {
				authordistributioServices.addAuthors(authordistributionmanager);
				am = this.getUserSystemAuthor(authordistributionmanager
						.getRoleindentifier());
			}
			if (am != null) {
				return this.writeResponseJson(response, "{success:true,id:'"
						+ am.getIndentifier() + "'}");
			} else {
				return this.writeResponseJson(response,
						"{success:true,id:'-1'}");
			}

		} catch (Exception e) {
			e.printStackTrace();
			return toFailedPage(mapping, request,
					MessageConstants.AUTHOR_DISTRIBUTION_ADD_MODIFY_FAILE);
		}
	}
}
