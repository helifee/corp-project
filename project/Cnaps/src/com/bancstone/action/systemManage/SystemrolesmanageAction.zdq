/**
 * <p>项目名称：zhiNengT<p>
 * <ul>
 * <li>1、版权所有：驰波公司</li>
 * <li>2、开发作者：王亮</li>
 * <li>3、开发日期：Jul 26, 2010</li>
 * <li>4、开发时间：10:07:20 AM</li>
 * <li>5、文件名称：SystemrolesmanageAction.java</li>
 * <li>6、包路径名：com.bancstone.action.systemManage</li>
 * </ul>
 */
package com.bancstone.action.systemManage;

import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.bancstone.action.BaseAction;
import com.bancstone.common.utils.BeanUtil;
import com.bancstone.common.utils.StringUtil;
import com.bancstone.constants.MessageConstants;
import com.bancstone.constants.SystemConstants;
import com.bancstone.form.systemManage.AuthordistributionmanagerForm;
import com.bancstone.form.systemManage.SystemrolesmanageForm;
import com.bancstone.hibernate.systemManage.Authordistributionmanager;
import com.bancstone.hibernate.systemManage.Systemgroupsmanage;
import com.bancstone.hibernate.systemManage.Systemrolesmanage;
import com.bancstone.hibernate.systemManage.Systemusersmanage;
import com.bancstone.service.systemManage.SystemgroupsmanageServices;
import com.bancstone.service.systemManage.SystemrolesmanageServices;

/**
 * <ul>
 * <li>1、开发日期：Jul 26, 2010</li>
 * <li>2、开发时间：10:07:20 AM</li>
 * <li>3、类型名称：SystemrolesmanageAction</li>
 * <li>4、类型意图：系统角色管理</li>
 * </ul>
 * 
 * @author 王亮
 * 
 */
public class SystemrolesmanageAction extends BaseAction<SystemrolesmanageForm> {
	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Jul 29, 2010</li>
	 * <li>3、开发时间：10:48:29 AM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：跳转到角色添加页面</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 */
	@SuppressWarnings("static-access")
	public ActionForward addSystemRoleView(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) {
		try {
			request.setAttribute("user", this.getUserInfo(request));
		} catch (Exception e) {
			e.printStackTrace();
		}
		return mapping.findForward("addSystemRoleView");
	}

	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Jul 26, 2010</li>
	 * <li>3、开发时间：5:03:18 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：添加系统角色</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward addSystemRole(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		SystemrolesmanageForm systemrolesmanageForm = (SystemrolesmanageForm) form;
		Systemrolesmanage systemrolesmanage = new Systemrolesmanage();
		SystemrolesmanageServices systemrolesmanageServices = (SystemrolesmanageServices) this
				.getBean("systemrolesmanageServices");
		BeanUtil
				.copyProperties2Object(systemrolesmanage, systemrolesmanageForm);
		try {
			List list = systemrolesmanageServices.findByName(systemrolesmanageForm.getName());
			if(list.size()>0){
				return toReceiptPage(
						mapping,
						request,
						true,
						"failed",
						"/systemManage/systemRoleManageAction.do?method=querySystemRole",
						"角色已存在");
			}
			systemrolesmanageServices.saveSystemRole(systemrolesmanage);
			// 添加成功
			return toReceiptPage(
					mapping,
					request,
					true,
					"sucess",
					"/systemManage/systemRoleManageAction.do?method=querySystemRole",
					MessageConstants.SYSTEM_ROLE_ADD_SUCCESS);
			// return this.querySystemRole(mapping, form, request, response);
		} catch (Exception e) {
			e.printStackTrace();
			return toReceiptPage(
					mapping,
					request,
					true,
					"failed",
					"/systemManage/systemRoleManageAction.do?method=querySystemRole",
					MessageConstants.SYSTEM_ROLE_ADD_FAILED);
		}
	}

	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Jul 26, 2010</li>
	 * <li>3、开发时间：5:10:39 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：删除系统绝色</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward deleteSystemRole(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) throws Exception {
		String identifier = request.getParameter("indentifier");
		SystemrolesmanageServices systemrolesmanageServices = (SystemrolesmanageServices) this
				.getBean("systemrolesmanageServices");
		List<Systemgroupsmanage> groupList = null;
		try {
			
			Systemrolesmanage systemRole =  systemrolesmanageServices.findByIndentifier(identifier);
			if(systemRole!=null&&"01".equals(systemRole.getIsactivity())){
				
				return toReceiptPage(
						mapping,
						request,
						true,
						"sucess",
						"/systemManage/systemRoleManageAction.do?method=querySystemRole",
						MessageConstants.SYSTEM_ROLE_DELETE_CHECK_FAILED);
			}
			
			systemrolesmanageServices
					.deleteSystemRole(systemrolesmanageServices
							.findSystemRoleByIndentifier(identifier));
			
			
					return toReceiptPage(
							mapping,
							request,
							true,
							"sucess",
							"/systemManage/systemRoleManageAction.do?method=querySystemRole",
							"角色删除成功");
		} catch (Exception e) {
			e.printStackTrace();
			return toReceiptPage(
					mapping,
					request,
					true,
					"failed",
					"/systemManage/systemRoleManageAction.do?method=querySystemRole",
					"角色删除失败");
		}
	}

	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Jul 26, 2010</li>
	 * <li>3、开发时间：5:16:02 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：修改系统绝色</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward modifySystemRole(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) throws Exception {

		Systemrolesmanage systemrolesmanage = new Systemrolesmanage();
		SystemrolesmanageForm systemrolesmanageForm = (SystemrolesmanageForm) form;
		SystemrolesmanageServices systemrolesmanageServices = (SystemrolesmanageServices) this
				.getBean("systemrolesmanageServices");
		try {
			BeanUtil.copyProperties2Object(systemrolesmanage,
					systemrolesmanageForm);
			systemrolesmanageServices.modifySystemRole(systemrolesmanage);
			// 修改成功
			return toReceiptPage(
					mapping,
					request,
					true,
					"sucess",
					"/systemManage/systemRoleManageAction.do?method=querySystemRole",
					MessageConstants.SYSTEM_ROLE_MODIFY_SUCCESS);
			
		} catch (Exception e) {
			e.printStackTrace();
			return toReceiptPage(
					mapping,
					request,
					true,
					"failed",
					"/systemManage/systemRoleManageAction.do?method=querySystemRole",
					MessageConstants.SYSTEM_ROLE_MODIFY_FAILED);
		}
	}

	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Jul 26, 2010</li>
	 * <li>3、开发时间：5:19:00 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：查询系统角色列表</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	@SuppressWarnings("static-access")
	public ActionForward querySystemRole(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) throws Exception {
		SystemrolesmanageForm systemrolesmanageForm = (SystemrolesmanageForm) form;
		SystemrolesmanageServices systemrolesmanageServices = 
			(SystemrolesmanageServices) this.getBean("systemrolesmanageServices");
		List<Systemrolesmanage> systemrolesmanageList = new ArrayList<Systemrolesmanage>();
		this.setPageValue(systemrolesmanageForm, true);
		try {
			systemrolesmanageList = systemrolesmanageServices.querySystemRoleList(systemrolesmanageForm);
			request.setAttribute("orgentity", this.getUserInfo(request)
					.getSystemorganizationsmanage());
			request.setAttribute("roleList", systemrolesmanageList);
			request.setAttribute("user", this.getUserInfo(request));
			this.setQueryPageInfo(request, systemrolesmanageForm,true);
			
			return mapping.findForward("querySystemRole");
		} catch (Exception e) {
			e.printStackTrace();
			return toFailedPage(mapping, request,
					MessageConstants.SYSTEM_ROLE_QUERY_ERROR);
		}
	}

	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Jul 26, 2010</li>
	 * <li>3、开发时间：6:55:46 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：根据标识符查询需要修改的系统角色</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 */
	public ActionForward querySystemRoleByIndentifier(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) {
		String indentifier = request.getParameter("indentifier");
		Systemrolesmanage systemrolesmanage = new Systemrolesmanage();
		SystemrolesmanageServices systemrolesmanageServices = (SystemrolesmanageServices) this
				.getBean("systemrolesmanageServices");
		try {
			systemrolesmanage = systemrolesmanageServices
					.findByIndentifier(indentifier);
			request.setAttribute("entity", systemrolesmanage);
			request.setAttribute("user", this.getUserInfo(request));
			return mapping.findForward("querySystemRoleByIndentifier");
		} catch (Exception e) {
			e.printStackTrace();
			return toFailedPage(mapping, request,
					MessageConstants.SYSTEM_ROLE_DETAIL_FAILED);
		}
	}

	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Jul 21, 2010</li>
	 * <li>3、开发时间：6:01:47 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：查看系统角色的明细信息</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 */
	public ActionForward systemRoleDetail(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) {
		String indentifier = request.getParameter("indentifier");
		Systemrolesmanage systemrolesmanage = new Systemrolesmanage();
		SystemrolesmanageServices systemrolesmanageServices = (SystemrolesmanageServices) this
				.getBean("systemrolesmanageServices");
		try {
			systemrolesmanage = systemrolesmanageServices
					.findByIndentifier(indentifier);
			request.setAttribute("entity", systemrolesmanage);
			return mapping.findForward("systemRoleDetail");
		} catch (Exception e) {
			e.printStackTrace();
			return toFailedPage(mapping, request,
					MessageConstants.SYSTEM_ROLE_DETAIL_FAILED);
		}
	}

	/**
	 * 
	 * <ul>
	 * <li>1、开发作者：王亮</li>
	 * <li>2、开发日期：Aug 19, 2010</li>
	 * <li>3、开发时间：12:11:30 PM</li>
	 * <li>4、返回类型：ActionForward</li>
	 * <li>5、方法含义：</li>
	 * <li>6、方法说明：为指定的角色分配系统权限</li>
	 * </ul>
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 */
	public ActionForward distributionSystemAuthor(ActionMapping mapping,
			ActionForm form, HttpServletRequest request,
			HttpServletResponse response) {
		AuthordistributionmanagerForm authordistributionForm = new AuthordistributionmanagerForm();
		Authordistributionmanager authordistribution = null;
		String rolename="";
		if(request.getParameter("rolename")!=null){
			try {
				rolename = new String (request.getParameter("rolename").getBytes("Iso8859-1"),"GBK");
				
			} catch (UnsupportedEncodingException e) {
				e.printStackTrace();
			}
			
		}
		authordistributionForm.setRoleindentifier(request
				.getParameter("identifier"));// 角色标识符
		authordistributionForm.setRolename(rolename);
//		authordistributionForm.setRolenamecode(request
//				.getParameter("rolenamecode"));
		try {
			authordistribution = this.getUserSystemAuthor(request
					.getParameter("identifier"));
			if (authordistribution != null) {
				BeanUtil.copyProperties2Object(authordistributionForm,
						authordistribution);
				request.setAttribute("entity", authordistributionForm);
			} else {
				request.setAttribute("entity", authordistributionForm);
			}

		} catch (Exception e) {
			e.printStackTrace();
		}
		return mapping.findForward("distributionSystemAuthor");
	}
}
