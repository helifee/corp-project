package com.creditease.b2bsettle.basedata.controller;

import java.util.Date;

import org.apache.commons.codec.digest.DigestUtils;
import org.hibernate.mapping.Map;
import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.client.RestTemplate;

import com.creditease.b2bsettle.basedata.base.ControllerBaseTest;
import com.creditease.b2bsettle.basedata.base.ResultInfo;
import com.creditease.b2bsettle.basedata.constant.AuditStatus;
import com.creditease.b2bsettle.basedata.constant.OperateType;
import com.creditease.b2bsettle.basedata.external.model.ChangePwdParam;
import com.creditease.b2bsettle.basedata.external.model.LoginParam;
import com.creditease.b2bsettle.basedata.external.model.ParamBean;
import com.creditease.b2bsettle.basedata.external.model.RAQueryUserParam;
import com.creditease.b2bsettle.basedata.external.model.RAQueryUserRetVo;
import com.creditease.b2bsettle.basedata.external.model.RaUpdateDnParam;
import com.creditease.b2bsettle.basedata.external.model.UserAuthorityReturnVo;
import com.creditease.b2bsettle.basedata.external.model.UserInfo;
import com.creditease.b2bsettle.basedata.external.model.UserLoginReturnVo;
import com.creditease.b2bsettle.basedata.model.UserAudit;
import com.creditease.b2bsettle.basedata.repository.UserAuditRepository;

public class UserControllerTest extends ControllerBaseTest {
    
    @Autowired
    private RestTemplate restUtil;
    
    @Autowired
	private UserAuditRepository userAuditRepository;
	
	@Test
	public void findUserBy() {
		String url = "http://10.100.142.99:7788/basedata/external/user/finduser";
		RAQueryUserParam user = new RAQueryUserParam();
		user.setUserId("zhangsan");
		RAQueryUserRetVo userRA = this.restUtil.postForObject(url, user, RAQueryUserRetVo.class);
		System.out.println(userRA);
	}
	
	@Test
	public void updateDN() {
		String url = "http://10.100.142.99:7788/basedata/external/user/updatedn";
		RaUpdateDnParam userDN = new RaUpdateDnParam();
		userDN.setCertSubject("xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx");
		userDN.setUserId("zhangsan");
		userDN.setSeriesNum("aaa");
		userDN.setSignInfo("bbb");
		this.restUtil.postForObject(url, userDN, Map.class);
	}
	
	@Test
	public void login() {
		String url = "http://10.100.142.99:7788/basedata/external/user/login";
		LoginParam loginBean = new LoginParam();
		loginBean.setUserId("zhangsan");
		loginBean.setPassword(DigestUtils.md5Hex("111111"));
		loginBean.setMerchId("portal");
		UserLoginReturnVo userLoginReturnVo = this.restUtil.postForObject(url, loginBean, UserLoginReturnVo.class);
		System.out.println(userLoginReturnVo);
	}
	
	@Test
	public void changPwd() {
		String url = "http://10.100.142.99:7788/basedata/external/user/changepwd";
		ChangePwdParam bean = new ChangePwdParam();
		bean.setMerchId("portal");
		bean.setUserId("zhangsan");
		bean.setOrgPwd(DigestUtils.md5Hex("111111"));
		bean.setNewPwd(DigestUtils.md5Hex("111111"));
		super.postAndPrint(url, bean, ResultInfo.class);
	}
	
	@Test
	public void newUser() {
		String url = "http://localhost:8080/basedata/user/addUser";
		UserAudit user = new UserAudit();
		user.setName("lisi");
		user.setPassword(DigestUtils.md5Hex("123456"));
		user.setRealName("李四");
		user.setSource("p");
		user.setTel("13512345678");
		user.setEmail("lisi@gmail.com");
		user.setCardType("1");
		user.setCardNumber("120683198611080318");
		user.setU(false);
		user.setCreatedTime(new Date());
		user.setOperateType(OperateType.ADD);
		super.postAndPrint(url, user, ResultInfo.class);
	}
	
	@Test
	public void pass() {
		String url = "http://localhost:8080/basedata/user/audit/pass";
		UserAudit userAudit = userAuditRepository.findOne((long) 2);
		userAudit.setAuditStatus(AuditStatus.Through);
		userAudit.setAuditText("ok");
		super.postAndPrint(url, userAudit, ResultInfo.class);
	}
	
	@Test
	public void getUserAuthority() {
		String url = "http://10.100.142.99:7788/basedata/external/user/getUserAuthority";
		ParamBean param = new ParamBean();
		param.setUserId("zhangsan");
		param.setMerchId("portal");
		super.postAndPrint(url, param, UserAuthorityReturnVo.class);
	}
	
	@Test
	public void ssoLogin() {
		String url = "http://10.100.142.99:7788/basedata/external/user/ssologin";
		LoginParam param = new LoginParam();
		param.setUserId("zhangsan");
		param.setPassword(DigestUtils.md5Hex("111111"));
		super.postAndPrint(url, param, ResultInfo.class);

	}
	
	@Test
	public void getUserInfo() {
		String url = "http://10.100.142.103:8080/basedata/external/user/getUserInfo";
		ParamBean param = new ParamBean();
		param.setUserId("zhangsan");
		super.postAndPrint(url, param, UserInfo.class);
	}
	
	@Test
	public void validateUser() {
		String url = "http://http://10.100.142.103:8080/basedata/external/user/validateUser";
//		String url = "http://10.100.142.99:7788/basedata/external/user/validateUser";
//		String url = "http://localhost:8080/basedata/external/user/validateUser";
		LoginParam param = new LoginParam();
		param.setUserId("zhangsan");
		param.setKeyInfo("xxx");
		super.postAndPrint(url, param, ResultInfo.class);
	}
}
