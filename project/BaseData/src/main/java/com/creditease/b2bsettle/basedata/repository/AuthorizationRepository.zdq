package com.creditease.b2bsettle.basedata.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.creditease.b2bsettle.basedata.model.Authorization;
import com.creditease.b2bsettle.basedata.model.EsEnterpriseInfo;
import com.creditease.b2bsettle.basedata.model.MenuCorpBean;

/**
 * 授权相关操作
 * @author daoqiangzhang
 *
 */
@Repository
public interface AuthorizationRepository extends JpaRepository<Authorization, Long> {

	//删除指定用户的非对应审核编号的授权关系
	@Modifying
	@Transactional
	@Query("update Authorization auth set auth.deleted = 1 where auth.user = :userId and auth.auditNumber != :auditNo")
	public int delAllNotInAuditNo(@Param("userId")long userId, @Param("auditNo")long auditNo);

	@Modifying
	@Transactional
	@Query("update Authorization auth set auth.deleted = 1 where auth.auditNumber = :auditNo")
	public int delByAuditNo(@Param("auditNo")long auditNo);

	//查询用户有权限的企业
	@Query("select corp from esEnterpriseInfo corp, Authorization auth, AuthorizationAudit aa "
			+ "where auth.user = :userName and auth.auditNumber = aa.cid and aa.auditStatus = 1 and auth.corp = corp.eId group by corp.eId")
	public List<EsEnterpriseInfo> findCorpBy(@Param("userName")String userName);

	@Query("select new com.creditease.b2bsettle.basedata.model.MenuCorpBean("
			+ "corp.eId, corp.eName, menu.code, menu.name, menu.parent, menu.sysId, menu.functionCode, menu.url, menu.isLeaf)"
			+ " from Authorization auth, AuthorizationAudit aa, Role r, RoleMenu rm, Menu menu, esEnterpriseInfo corp"
			+ " where auth.user = :userName and auth.auditNumber = aa.cid and aa.auditStatus = 1 and auth.role = r.id "
			+ "and r.deleted = 0 and auth.role = rm.role and rm.menu = menu.id and menu.deleted = 0 "
			+ "and menu.sysId = :sysId and auth.corp = corp.eId order by menu.id")
	public List<MenuCorpBean> findMenuBy(@Param("userName")String userName, @Param("sysId")String sysId);
}
