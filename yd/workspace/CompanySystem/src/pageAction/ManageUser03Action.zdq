/**
 * プログラム名：管理者担当プロジェクト詳細画面のプログラム
 * 機能概要：管理者担当プロジェクト詳細消息表示されて、管理者担当プロジェクトテープルをExcelに出力、基本情報更新、一般ユーザー選択と表示する
 * 作成者：張瑜
 * 作成日：2008/9/26
 * バージョン：1.0
 * 修正履歴：
 */ 
package pageAction;
import java.util.ArrayList;
import java.util.List;
import org.apache.log4j.Logger;
import parameter.popupPara;

import parameter.ManageUser03Para;
import parameter.ManageUser04Para;
import pojo.Pjinfo;
import pojo.Pjpginfo;
import pojo.TestKey;
import pojo.Usermst;
import pojo.Userkindmst;
import pojo.Busyomst;
import services.ManageUser03Service;

import com.opensymphony.xwork2.ActionSupport;
import com.parameter.ParaManager;
public class ManageUser03Action extends ActionSupport{
	private List<Usermst> result2 = new ArrayList<Usermst>();
	private List<simpleuser> simpleuser =new ArrayList<simpleuser>();
	private String userid;
	public String username;
	private List<List_user> users;
	//プロジェクト番号
	private String projectid_d;
	//所属部門
	private String busyoidname_d;
	//日文名
	private String prjmei_d;
	//プロジェクトの主管者
	private String username_d;
	//予定開始日
	private String ystartdate_d;
	//予定終了日
	private String yenddate_d;
	//実際開始日
	private String startdate_d;
	//実際終了日
	private String enddate_d;
	//開発環境
	private String pjem_d;
	//プロジェクトの概要
	private String pjgaiyou_d;
	//管理者番号
	private String muserid_d;
	//作業量
	private String usernum_d;
	//中文名
	private String projecttyuname_d;
	//英文名
	private String projecteiname_d;
	//客さん名
	private String kyakuname_d;
	//ユーザ類型
	private String userkind_d;
	/**
	 * 一般ユーザー選択テープルの初期化
	 
	 */
	private class simpleuser{
		private String id;
		private String username_b;
		private String userkind_b;
		public String getUserkind_b() {
			return userkind_b;
		}
		public void setUserkind_b(String userkind_b) {
			this.userkind_b = userkind_b;
		}

		public String getUsername_b() {
			return username_b;
		}

		public void setUsername_b(String username_b) {
			this.username_b = username_b;
		}
		public String getId() {
			return id;
		}

		public void setId(String id) {
			this.id = id;
		}
		
	}
	/**
	 * 受信者のアドレスの初期化
	 
	 */
	public class List_user{
		private String userid_a;
		public String username_a;
		private String raddress_a;
		public String getUserid_a() {
			return userid_a;
		}
		public void setUserid_a(String userid_a) {
			this.userid_a = userid_a;
		}
		public String getUsername_a() {
			return username_a;
		}
		public void setUsername_a(String username_a) {
			this.username_a = username_a;
		}
		public String getRaddress_a() {
			return raddress_a;
		}
		public void setRadress_a(String raddress_a) {
			this.raddress_a = raddress_a;
		}
	}
	public String getUserid() {
		return userid;
	}
	public void setUserid(String userid) {
		this.userid = userid;
	}
	public String getUsername() {
		return username;
	}
	public void setUsername(String username) {
		this.username = username;
	}
	public List<List_user> getUsers() {
		return users;
	}
	public void setUsers(List<List_user> users) {
		this.users = users;
	}
	public void setSimpleuser(List<simpleuser> simpleuser) {
		this.simpleuser = simpleuser;
	}

	public List<simpleuser> getSimpleuser(){
		return this.simpleuser;
	}
	public  String getProjectid_d() {
		return projectid_d; 
	}
	public void SetProjectid_d(String projectid_d) { 
		this.projectid_d = projectid_d;
	}	
	public  String getBusyoidname_d() {
		return busyoidname_d; 
	}
	
	public void SetBusyoidname_d(String busyoidname_d) { 
		this.busyoidname_d = busyoidname_d;
	}		
	public  String getYstartdate_d() {
		return ystartdate_d; 
	}
	
	public void SetYstartdate_d(String ystartdate_d) { 
		this.ystartdate_d = ystartdate_d;
	}	
	public  String getYenddate_d() {
		return yenddate_d; 
	}
	
	public void setYenddate_d(String yenddate_d) { 
		this.yenddate_d= yenddate_d;
	}
	public  String getPjem_d() {
		return pjem_d; 
	}
	
	public void setPjem_d(String pjem_d) { 
		this.pjem_d= pjem_d;
	}
	public  String getPjgaiyou_d() {
		return pjgaiyou_d; 
	}
	
	public void setPjgaiyou_d(String pjgaiyou_d) { 
		this.pjgaiyou_d= pjgaiyou_d;
	}
	
	public  String getPrjmei_d() {
		return prjmei_d; 
	}
	
	public void setPrjmei_d(String prjmei_d) { 
		this.prjmei_d= prjmei_d;
	}
	public  String getUsername_d() {
		return username_d; 
	}
	
	public void setUsername_d(String username_d) { 
		this.username_d = username_d;
	}
	public  String getKyakuname_d() {
		return kyakuname_d; 
	}
	
	public void setKyakuname_d(String kyakuname_d) { 
		this.kyakuname_d= kyakuname_d;
	}	
	public  String getStartdate_d() {
		return startdate_d; 
	}
	
	public void setStartdate_d(String startdate_d) { 
		this.startdate_d= startdate_d;
	}	
	public  String getEnddate_d() {
		return enddate_d; 
	}
	
	public void setEnddate_d(String enddate_d) { 
		this.enddate_d= enddate_d;
	}	
	public  String getUsernum_d() {
		return usernum_d; 
	}
	
	public void setUsernum_d(String usernum_d) { 
		this.usernum_d= usernum_d;
	}		
	public  String getProjecttyuname_d() {
		return projecttyuname_d; 
	}
	
	public void setProjecttyuname_d(String projecttyuname_d) { 
		this.projecttyuname_d = projecttyuname_d;
	}		
	public  String getProjecteiname_d() {
		return projecteiname_d; 
	}
	
	public void setProjecteiname_d(String projecteiname_d) { 
		this.projecteiname_d= projecteiname_d;
	}	
	public  String getUserkind_d() {
		return userkind_d; 
	}
	
	public void setUserkind_d(String userkind_d) { 
		this.userkind_d= userkind_d;
	}	
	
	private ManageUser03Service os;

	public void setOs(ManageUser03Service os){
		
		this.os=os;
	}
     public ManageUser03Action(){
    	 
     }
     /**
      * 該当ユーザー所属プロジェクト詳細消息を検索する
      */
	public String ManageUser03_init() {
		
		System.out.println("ManageUser03_init");
		//Simpleuserリストをクリア
		simpleuser onerow =new simpleuser();
		getSimpleuser().clear();
		//sessionでプロジェクト番号を得る
		ParaManager ParaGm =new ParaManager("ManageUser03");
		ManageUser03Para myPara = new ManageUser03Para();
		myPara=(ManageUser03Para)ParaGm.getParameter();
		String myparam1 = myPara.getProjectid();
		SetProjectid_d(myparam1);
		Pjinfo result=new Pjinfo();
		//プロジェクト番号でPjinfoテーブルを検索する
		result = os.findBykeyid(myparam1);
		setKyakuname_d((result).getKyakuname());
		SetYstartdate_d((result).getYstartdate());
		setYenddate_d((result).getYenddate());
		setStartdate_d((result).getStartdate());
		setEnddate_d((result).getEnddate());
		setPrjmei_d((result).getPrjmei());
		setProjecttyuname_d((result).getProjecttyuname());
		setProjecteiname_d((result).getProjecteiname());
		setPjem_d((result).getPjem());
		setPjgaiyou_d((result).getPjgaiyou());
		 
		Usermst result1= new Usermst();	
		//管理者番号でUsermstテーブルを検索する
		result1=os.getUserByUserid(result.getMuserid().toString());
		//リーダー名前を添加する
		setUsername_d((result1).getUsername());
		Busyomst result2=new Busyomst();
		//部門番号でBusyomstテーブルを検索する
		result2=os.getBYBusyomstid(result1.getBusyoid().toString());
		SetBusyoidname_d((result2).getBusyoidname());
		Userkindmst result3=new Userkindmst();
		//ユーザ類型番号でBusyomstテーブルを検索する
		result3=os.getbyUserkindid(result1.getUserkindid().toString());
		//ユーザ類型を添加する
		setUserkind_d(result3.getUserkindname());
		System.out.println("ManageUser03_xiangxi");
		List<Pjpginfo> result4 = new ArrayList<Pjpginfo>();
		//ページのProjectidでPjpginfoテーブルを検索する
		result4=os.findpjbyid(result.getProjectid().toString().trim());
		System.out.println("★★★UserID★★★★"+result.getProjectid());
		String id=" ";
		 if(result4.size()>0){
			 for (int b = 0; b < result4.size(); b++){
				
				 System.out.println("★★★UserID★★★★"+result4.size());
				 id=result4.get(b).getId().getUserid();
				 onerow =new simpleuser();
				 List<Usermst> result6= new ArrayList<Usermst>();
				 result6= os.findbyid(id.trim());
				 String kid=result6.get(0).getUsername();
				 System.out.println("★★★this.getUsername_d()★★★★"+this.getUsername_d());	 
				 if(result6.get(0).getUsername().trim().equals(this.getUsername_d().trim())){
					
					 continue;
				 }
				 // メンバー名前を添加する
				 onerow.setUsername_b(kid);
				 System.out.println("★★★kid★★★★"+kid);
				 // ユーザ類型を添加する
				 onerow.setUserkind_b("成員");
				 this.getSimpleuser().add(onerow);
			 }
			
		 }
		
			
		return "xiangxi";
	}
	/**
	 * 管理者担当プロジェクトテープルをExcelに出力
	 */
	public String output(){
        System.out.println("output_init");
		ParaManager ParaGm =new ParaManager("ManageUser03");
		ManageUser03Para myPara = new ManageUser03Para();
		myPara=(ManageUser03Para)ParaGm.getParameter();
		String myparam1 = myPara.getProjectid();
		SetProjectid_d(myparam1);
		Pjinfo result=new Pjinfo();
		result = os.findBykeyid(myparam1);
		setKyakuname_d((result).getKyakuname());
		SetYstartdate_d((result).getYstartdate());
		setYenddate_d((result).getYenddate());
		setStartdate_d((result).getStartdate());
		setEnddate_d((result).getEnddate());
		setPrjmei_d((result).getPrjmei());
		setProjecttyuname_d((result).getProjecttyuname());
		setProjecteiname_d((result).getProjecteiname());
		setPjem_d((result).getPjem());
		setPjgaiyou_d((result).getPjgaiyou());
		Usermst result1= new Usermst();	
		result1=os.getUserByUserid(result.getMuserid().toString());
		setUsername_d((result1).getUsername());
		Busyomst result2=new Busyomst();
		result2=os.getBYBusyomstid(result1.getBusyoid().toString());
		SetBusyoidname_d((result2).getBusyoidname());
		
		System.out.println("ManageUser03_output");
		return "ouput";
	}

	/**
	 * 基本情報更新のために、ページの管理者のプログラム番号をsessionに預け入れる
	 */

	public String alter(){
		
		System.out.println("projectid="+getProjectid_d());
		ManageUser04Para sendPara=new ManageUser04Para();
		ParaManager ParaGm =new ParaManager("ManageUser04");
		sendPara.setProjectid(getProjectid_d());
		ParaGm.saveParameter(sendPara);
		System.out.println("projectid="+getProjectid_d());
		return ERROR;
	}
		Logger log = Logger.getLogger(this.getClass().getName());
	/**
	 *一般ユーザーの名前と番号をすべて選択て、alter2.jsp のusersのに預け入れる
	 */

	public String Manage_adminselect(){
		List<Usermst> result=null;
		log.info("adminselect -- �J�n�����I�I�I�I");
		//Usermstで一般ユーザーを選択する
		result = os.findums();
		int cnt = result.size();
		List<List_user> temp=new ArrayList<List_user>();
		for (int i = 0; i < cnt; i++) {
			List_user one_list=new List_user();
			one_list.setUserid_a(result.get(i).getUserid());
			one_list.setUsername_a(result.get(i).getUsername());
			temp.add(one_list);
		}
		this.setUsers(temp);
		return SUCCESS;
	}
	/**
	 *  sessionに預け入れる
	 */
	public String Manage_popup(){
		popupPara sendPara=new popupPara();
		ParaManager ParaGm =new ParaManager("alter");
		ParaGm.saveParameter(sendPara);
		return  "success";
	}
	/**
	 * sessionの値を得って、テープルに書いて、データベースに預け入れる
	 */
	public String setvalue(){
		
		
		System.out.println("★★★★★★★★★★★ ★★★");
		System.out.println("PjAction　setvalue 　START！！！");
	
		String userid[] = this.getUsername().trim().split("@");
		System.out.println("userid.length-----"+userid.length);

		List<Pjpginfo> PjpginfoList=os.findpjbyid(this.getProjectid_d());
		List<String> useridList = new ArrayList<String>();
		if(PjpginfoList!=null){
			for(int j=0;j<PjpginfoList.size();j++){
				System.out.println(PjpginfoList.get(j).getId().getUserid().trim());
				useridList.add(PjpginfoList.get(j).getId().getUserid().trim());
			}
			
		}
	 

		for(int i=0;i<userid.length;i++){

			System.out.println("ssss★★★★★★ssssss"+useridList);
			System.out.println(userid[i]+"★★★★★★");

			
		
			if(useridList.contains(userid[i].trim())){
				
				System.out.println("sss");
				continue;
			
			}
		
			System.out.println("★★★★★★★★LOOP★★★ ★★★");
			simpleuser onerow=new simpleuser();
			System.out.println("aaaaaaaaaaaa");
			result2 = os.getbyid(userid[i].trim());
			System.out.println(result2);
			String username = result2.get(0).getUsername().trim();
			System.out.println(username);
			onerow.setUsername_b(username);
			onerow.setUserkind_b("成员");
			onerow.setId(userid[i].subSequence(0, 2).toString().trim()+getProjectid_d().subSequence(0, 2).toString().trim());
			//ユーザ名とユーザ種類をテーブルに書く
			this.getSimpleuser().add(onerow);
			
			//ユーザ名とユーザ種類をデータベースに預け入れる
			Pjpginfo pjpginfo = new  Pjpginfo();
			TestKey id = new TestKey();
			id.setUserid(userid[i].trim());
			id.setProjectid(this.getProjectid_d());
			pjpginfo.setId(id);
			pjpginfo.setCancelflag("0");
			pjpginfo.setIntimestp(" ");
			pjpginfo.setUptimestp(" ");
			os.savePjpginfo(pjpginfo);
		}
		return SUCCESS;
	}

	
}
