/**
 * 
 */
package com.yds.ws.service.impl;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.junit.After;
import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;
import org.springframework.transaction.annotation.Transactional;

import com.opensymphony.xwork2.ActionContext;
import com.yds.base.test.AbstractSpringTransTest;
import com.yds.base.test.BeanAssert;
import com.yds.common.bean.ComIoData;
import com.yds.common.bean.UserInfo;
import com.yds.common.service.SessionConstants;
import com.yds.gps.service.GpsConstants;
import com.yds.ws.service.IoDataSyncService;

import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;


/**
 * @author zhangdaoqiang
 *
 */
@Transactional(propagation = Propagation.NOT_SUPPORTED,isolation=Isolation.READ_UNCOMMITTED)
public class IoDataSyncServiceImplTest extends AbstractSpringTransTest {
	
	@Resource
	private IoDataSyncService ioDataSyncService;

	/**
	 * @throws java.lang.Exception
	 */
	@Before
	public void setUp() throws Exception {
		initCommonData(IoDataSyncServiceImpl.class);
		
		// 删除表中数据(避免和测试数据冲突)
		deleteFromTables("COM_IODATA", "COM_SERVICE", "GPS_ACCOUNT");
	}

	/**
	 * @throws java.lang.Exception
	 */
	@After
	public void tearDown() throws Exception {
	}

	/**
	 * Test method for {@link com.yds.ws.service.impl.IoDataSyncServiceImpl#saveIoData(java.util.List)}.
	 * @throws Exception 
	 */
	@Test
	public final void testSaveIoData() throws Exception {
		
		// 初始化数据库
		super.initData("", "result1.xls");
		
		// CASE1:保存数据
		
		// 初始化测试方法参数
		List<ComIoData> ioDataList = super.getParamList(ComIoData.class, "param1_COM_IODATA");
		
		// 调用被测试方法
		ioDataSyncService.saveIoData(ioDataList);
		
		//取得插入的数据
		List<ComIoData> actual = super.findListBeanByCondition(ComIoData.class, "param2_COM_IODATA");
		
		//取得期望数据
		List<ComIoData> expect = super.getExpectList(ComIoData.class, "expect1_COM_IODATA");
		
		//断言检索结果和预期是否一致
		BeanAssert.assertListLenientEquals(expect, actual);
		
		//CASE2:测试重复数据
		
		// 初始化测试方法参数
		List<ComIoData> ioDataList2 = super.getParamList(ComIoData.class, "param3_COM_IODATA");
		
		// 调用被测试方法
		ioDataSyncService.saveIoData(ioDataList2);
		
		//取得插入的数据
		List<ComIoData> actual2 = super.findListBeanByCondition(ComIoData.class, "param2_COM_IODATA");
		
		//取得期望数据
		List<ComIoData> expect2 = super.getExpectList(ComIoData.class, "expect2_COM_IODATA");
		
		//断言检索结果和预期是否一致
		BeanAssert.assertListLenientEquals(expect2, actual2);
	}

	/**
	 * Test method for {@link com.yds.ws.service.impl.IoDataSyncServiceImpl#updateIoData(java.util.List)}.
	 * @throws Exception 
	 */
	@Test
	@Ignore	//服务器异常，本地没有错
	public final void testUpdateIoData() throws Exception {
		
		// 初始化数据库
		super.initData("input.xls", "result2.xls");
		
		// 初始化测试方法参数
		List<ComIoData> ioDataList = super.getParamList(ComIoData.class, "param_COM_IODATA");
		
		// 调用被测试方法
		// 设置userid
		Map<String, Object> context = new HashMap<String, Object>();
		ActionContext actionContext = new ActionContext(context);
		ActionContext.setContext(actionContext);
		Map<String, Object> session = new HashMap<String, Object>();
		UserInfo userInfo = new UserInfo();
		userInfo.setUserId(GpsConstants.COFFEE_ACCOUNT);
		session.put(SessionConstants.USERINFO, userInfo);
		actionContext.setSession(session);
		
		ioDataSyncService.updateIoData(ioDataList);
		
		//没有异常即为此方法正确
		
	}

}
