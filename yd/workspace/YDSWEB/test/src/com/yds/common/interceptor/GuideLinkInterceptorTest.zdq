/**
 * 
 */
package com.yds.common.interceptor;

import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.struts2.ServletActionContext;
import org.junit.Assert;
import org.junit.Ignore;
import org.junit.Test;
import org.springframework.mock.web.MockHttpServletRequest;

import com.opensymphony.xwork2.mock.MockActionInvocation;
import com.yds.base.test.AbstractSpringTransTest;
import com.yds.base.test.BeanAssert;
import com.yds.base.test.ExcelUtil;
import com.yds.common.service.AcionXmlElement;
import com.yds.common.service.GuideLinkContext;
import com.yds.common.service.SessionConstants;

/**
 * @author wangduo
 *
 */
public class GuideLinkInterceptorTest extends AbstractSpringTransTest {

	@Resource
	private GuideLinkInterceptor guideLinkInterceptor;

	/**
	 * Test method for {@link com.yds.common.interceptor.GuideLinkInterceptor#intercept(com.opensymphony.xwork2.ActionInvocation)}.
	 * @throws Exception 
	 */
	@SuppressWarnings("unchecked")
	@Test
	@Ignore
	public void testInterceptActionInvocation() throws Exception {
		
		GuideLinkContext.setXmlFilePath(GuideLinkContext.class.getClassLoader().getResource("AcionXmlElement_input.xml").getPath());
		
		Map<String, Object> session = ExcelUtil.getSession();
		
		// 模拟ActionInvocation对象
		MockActionInvocation invocation = new MockActionInvocation();
		
		// 模拟HttpServletRequest对象
		MockHttpServletRequest httpServletRequest = new MockHttpServletRequest();
		
		httpServletRequest.setServletPath("/struts.action");
		
		ServletActionContext.setRequest(httpServletRequest);
		
		guideLinkInterceptor.intercept(invocation);
		
		List<AcionXmlElement> expectList = GuideLinkContext.getGuideList("/struts.action");
		
		List<AcionXmlElement> actualList = (List<AcionXmlElement>) session.get(SessionConstants.GUIDELIST);
		
		// 无参数判断
		BeanAssert.assertListEquals(expectList, actualList);
		
		// 添加参数
		httpServletRequest.setQueryString("mode=2");
		
		guideLinkInterceptor.intercept(invocation);
		
		List<AcionXmlElement> addParamExpectList = GuideLinkContext.getGuideList("/struts.action2");
		
		List<AcionXmlElement> addParamActualList = (List<AcionXmlElement>) session.get(SessionConstants.GUIDELIST);
		
		// 有参数判断
		Assert.assertEquals(addParamExpectList, addParamActualList);
		
		// 添加多个参数
		httpServletRequest.setQueryString("mode=2&arg=1");
		
		guideLinkInterceptor.intercept(invocation);
		
		List<AcionXmlElement> addParamsActualList = (List<AcionXmlElement>) session.get(SessionConstants.GUIDELIST);
		
		// 多个参数判断
		Assert.assertEquals(addParamExpectList, addParamsActualList);
	}

}
