<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K040011Dao">
	<typeAlias alias="k0411SearchInfo" type="com.yds.tt.testing.bean.K040011SearchInfo"/>
	<typeAlias alias="k0411QuestionLibrary" type="com.yds.tt.testing.bean.QuestionLibrary"/>

	<!--检索件数语句-->
	<sql id="selectCount">
			SELECT
			COUNT(*) 
	</sql>
	
	<!--  检索项目语句 --> 
	<sql id="selectItem"> 
		SELECT 
		T1.QUESTION_ID AS questionId,
		T1.QUESTION_VERSION_NO AS questionVersionNo,
		CONCAT(CASE T1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM tt_fenlei
						  WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
								CATEGORY2_ID = 0 AND 
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 1)
				END,
				CASE T1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME 
							FROM tt_fenlei
							WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
								CATEGORY2_ID = t1.CATEGORY2_ID AND
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 2))
				END ,
				CASE T1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME 
							FROM tt_fenlei t4 
							WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
								CATEGORY2_ID = T1.CATEGORY2_ID AND
								CATEGORY3_ID = T1.CATEGORY3_ID AND
								CATEGORY_LEVEL = 3))
				END) AS categoryName,
		T1.KEYWORD AS keyword,
		(SELECT DIFF_NAME  FROM COM_CODE_MST
		  WHERE TYPE_ID = 'R03'
		  AND DIFF_NO = T1.QUESTION_KIND
		)AS questionKindName,
		(SELECT DIFF_NAME  FROM COM_CODE_MST
		  WHERE TYPE_ID = 'E01'
		  AND DIFF_NO = T1.QUESTION_DIFFICULTY
		)AS questionDifficultyName,
		T1.REF_QUESTION_ID AS refQuestionId,
		T1.QUESTION_NUMBER AS questionNumber,
		T1.QUESTION_SCORE AS questionScore,
		T1.QUESTION_TIMES AS questionTimes,
		LEFT(T1.RIGHT_TIMES*100/(T1.RIGHT_TIMES+T1.ERROR_TIMES),5) AS rightPercent,
		(SELECT USER_CNM 
		 FROM V_TT_USER
		 WHERE USER_ID = T1.CREATE_USER_ID
		)AS createUserName,
		(SELECT USER_CNM 
		 FROM V_TT_USER
		 WHERE USER_ID = T1.UPDATE_USER_ID
		)AS updateUserName,
		T1.UPDATE_TIME AS updateTime,
		T1.QUESTION_CONTENT AS questionContent,
		T1.PICTURE_FLG AS pictureFlg,
		T1.MEDIA_FLG AS mediaFlg,
		T1.ATTACH_FLG AS attachFlg,
		T1.CHECK_FLG AS checkFlg,
		(SELECT DIFF_NAME FROM COM_CODE_MST
		  WHERE TYPE_ID = 'R04'
		  AND DIFF_NO = T1.CHECK_FLG
		)AS checkFlagName
	</sql>
	
	<!-- 条件检索 -->
	<sql id="condition">
		FROM TT_TIKU T1
		WHERE    
			T1.NEW_FLG = 2
			<isNotEmpty property="category1Id">
				<isNotEqual prepend="AND" property="category1Id" compareValue="0">
					T1.CATEGORY1_ID = #category1Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty property="category2Id">
				<isNotEqual prepend="AND" property="category2Id" compareValue="0">
					T1.CATEGORY2_ID = #category2Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty property="category3Id">
				<isNotEqual prepend="AND" property="category3Id" compareValue="0">
					T1.CATEGORY3_ID = #category3Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty prepend="AND" open="(" close=")" property="categoryInfolist">
				<iterate conjunction="or" property="categoryInfolist" >
					<isNotEqual property="categoryInfolist[].category1Id" compareValue="0">
						(
						T1.CATEGORY1_ID = #categoryInfolist[].category1Id#
						<isNotEqual prepend="AND" property="categoryInfolist[].category2Id" compareValue="0">
							T1.CATEGORY2_ID = #categoryInfolist[].category2Id#
						</isNotEqual>
						<isNotEqual prepend="AND" property="categoryInfolist[].category3Id" compareValue="0">
							T1.CATEGORY3_ID = #categoryInfolist[].category3Id#
						</isNotEqual>
						)
					</isNotEqual>
				</iterate>
			</isNotEmpty>
			<isNotEqual prepend="AND" property="questionUiModel" compareValue="1">
				T1.CHECK_FLG = 2 
			</isNotEqual>
			<isNotEmpty prepend="AND" property="questionId">
				T1.QUESTION_ID LIKE CONCAT(#questionId#,'%')
			</isNotEmpty>
			<isNotEmpty  prepend="AND" property="questionType">
				T1.QUESTION_TYPE = #questionType#
			</isNotEmpty>
			<isNotEmpty  property="questionKind">
				<isNotEqual prepend="AND" property="questionKind" compareValue="0">
				T1.QUESTION_KIND = #questionKind# 
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty  property="questionDifficulty">
				<isNotEqual prepend="AND" property="questionDifficulty" compareValue="0">
				T1.QUESTION_DIFFICULTY = #questionDifficulty# 
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="refQuestionId">
				T1.REF_QUESTION_ID = #refQuestionId# 
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="createUserId">
				T1.CREATE_USER_ID = CONCAT('YD',#createUserId#) 
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updateUserId">
				T1.UPDATE_USER_ID = CONCAT('YD',#updateUserId#)
			</isNotEmpty>
			<isNotEmpty  property="checkFlg">
				<isNotEqual prepend="AND" property="checkFlg" compareValue="0">
				T1.CHECK_FLG = #checkFlg# 
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty prepend="AND"  property="scoreDown">
				<![CDATA[  T1.QUESTION_SCORE >= #scoreDown# ]]> 
			</isNotEmpty>
			<isNotEmpty prepend="AND"  property="scoreUp">
				<![CDATA[  T1.QUESTION_SCORE <= #scoreUp# ]]> 
			</isNotEmpty>
			<isNotEmpty prepend="AND"  property="qtDown">
				<![CDATA[  T1.QUESTION_TIMES >= #qtDown# ]]> 
			</isNotEmpty>
			<isNotEmpty prepend="AND"  property="qtUp">
				<![CDATA[  T1.QUESTION_TIMES <= #qtUp# ]]> 
			</isNotEmpty>
			<isNotEmpty prepend="AND"  property="updateTimeDown">
				<![CDATA[  T1.UPDATE_TIME  >= #updateTimeDown# ]]> 
			</isNotEmpty>
			<isNotEmpty prepend="AND"  property="updateTimeUp">
				<![CDATA[  T1.UPDATE_TIME  <= #updateTimeUp# ]]> 
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="keywordList">
				<iterate property="keywordList" conjunction="AND">
					T1.KEYWORD  LIKE CONCAT('%', #keywordList[]#, '%')  
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="questionSource">
				T1.QUESTION_SOURCE  LIKE CONCAT('%', #questionSource#, '%')  
			</isNotEmpty>
			ORDER BY 
			T1.QUESTION_ID DESC	
	</sql>
	<!-- 题库信息总数 --> 
	<select  id="getTotalCount"  parameterClass="k0411SearchInfo" resultClass="Long"> 
		<include refid="selectCount"/>
		<include refid="condition"/>
	</select>
	
	<!-- 题库信息 --> 		
	<select id="searchQuestLibr" parameterClass="k0411SearchInfo" resultClass="k0411QuestionLibrary"> 
		<include refid="selectItem"/>
		<include refid="condition"/>
	</select>
	
	<!-- 取得关键字信息 -->
	<select id="getKeywordList" resultClass="String" parameterClass="java.util.HashMap">
		SELECT DISTINCT KEYWORD_NAME
		FROM TT_GUANJIANZI
		<isNotNull property="category1Id">
			<isNotEqual property="category1Id" compareValue="0">
				WHERE CATEGORY_ID = #category1Id#
			</isNotEqual>
		</isNotNull>
	</select>
	
</sqlMap>