<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K050021Dao">
	<typeAlias alias="paperListSearchInfo" type="com.yds.tt.testing.bean.K050021SearchInfo"/>
	<typeAlias alias="paperListResult" type="com.yds.tt.testing.bean.TestPaperInfo"/>
		
	<!-- 试卷一览信息检索 件数检索 --> 		
	<sql id="attributeSelectCount"> 
		SELECT
			COUNT(*) 
	</sql>
	
	<!-- 试卷一览信息检索 试卷选择模式检索项目 --> 		
	<sql id="attributeChooseMode"> 
		SELECT
			T1.PAPER_ID AS paperId,
			T1.PAPER_VERSION_NO AS paperVersionNo,
			T1.PAPER_TITLE AS paperTitle,
			(CASE T1.RANDOM_BIGQUEST_FLG
				WHEN 1 THEN "有"
				ELSE "无" 
				END) AS randomBigquestFlgNM,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE 
				TYPE_ID = 'R02' AND
				DIFF_NO = 1) AS paperTypeName,
				
			CONCAT(CASE T1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM tt_fenlei
						  WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
								CATEGORY2_ID = 0 AND 
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 1)
				END,
				CASE T1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME 
							FROM tt_fenlei
							WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
								CATEGORY2_ID = t1.CATEGORY2_ID AND
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 2))
				END ,
				CASE T1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME 
							FROM tt_fenlei t4 
							WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
								CATEGORY2_ID = T1.CATEGORY2_ID AND
								CATEGORY3_ID = T1.CATEGORY3_ID AND
								CATEGORY_LEVEL = 3))
				END) AS categoryName,
			T1.PAPER_TOTAL_SCORE AS paperTotalScore,
			T1.PAPER_TIME AS paperTime,
			(SELECT
				USER_CNM
			FROM v_tt_user
			WHERE 
				USER_ID = T1.CREATE_USER_ID) AS createUserName,
			(SELECT
				USER_CNM
			FROM v_tt_user
			WHERE 
				USER_ID = T1.UPDATE_USER_ID) AS updateUserName,
			T1.UPDATE_TIME AS updateTime,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE 
				TYPE_ID = 'R10' AND
				DIFF_NO = T1.PAPER_STATUS) AS paperStatusName
	</sql>

	<!-- 试卷一览信息检索 试卷管理模式检索项目 --> 		
	<sql id="attributeManageMode"> 
		SELECT
			T3.PAPER_ID AS paperId,
			T3.PAPER_VERSION_NO AS paperVersionNo,
			T3.PAPER_TITLE AS paperTitle,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE 
				TYPE_ID = 'R02' AND
				DIFF_NO = 1) AS paperTypeName,
				
			CONCAT(CASE T3.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM tt_fenlei
						  WHERE CATEGORY1_ID = T3.CATEGORY1_ID AND
								CATEGORY2_ID = 0 AND 
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 1)
				END,
				CASE T3.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME 
							FROM tt_fenlei
							WHERE CATEGORY1_ID = T3.CATEGORY1_ID AND 
								CATEGORY2_ID = t3.CATEGORY2_ID AND
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 2))
				END ,
				CASE T3.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME 
							FROM tt_fenlei t4 
							WHERE CATEGORY1_ID = T3.CATEGORY1_ID AND 
								CATEGORY2_ID = T3.CATEGORY2_ID AND
								CATEGORY3_ID = T3.CATEGORY3_ID AND
								CATEGORY_LEVEL = 3))
				END) AS categoryName,
			(SELECT
				USER_CNM
			FROM v_tt_user
			WHERE 
				USER_ID = T3.CREATE_USER_ID) AS createUserName,
			(SELECT
				USER_CNM
			FROM v_tt_user
			WHERE 
				USER_ID = T3.UPDATE_USER_ID) AS updateUserName,
			T3.UPDATE_TIME AS updateTime,
			T3.PAPER_STATUS AS paperStatus,
			T3.BELONG_ID AS belongId,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE 
				TYPE_ID = 'R10' AND
				DIFF_NO = T3.PAPER_STATUS) AS paperStatusName,
			SUM(T3.operatingKbn) AS operatingKbn
	</sql>

	<!-- 试卷一览信息检索 内层基本检索项目（试卷管理） --> 		
	<sql id="attributeManageModeUnionBasic"> 
		SELECT
			T1.PAPER_ID,
			T1.PAPER_VERSION_NO,
			T1.PAPER_TITLE,
			T1.PAPER_TYPE,
			T1.CATEGORY1_ID,
			T1.CATEGORY2_ID,
			T1.CATEGORY3_ID,
			T1.CREATE_USER_ID,
			T1.UPDATE_USER_ID,
			T1.UPDATE_TIME,
			T1.APPROVER_USER_ID,
			T1.BELONG_ID,
			T1.PAPER_STATUS
	</sql>

	<!-- 试卷一览信息检索 试卷对象表 --> 		
	<sql id="fromTableShiJuan"> 
		FROM tt_shijuan T1 
	</sql>
	
	<!-- 试卷一览信息检索 权限对象表 --> 		
	<sql id="fromTableQuanxian">
		,tt_quanxian T2
	</sql>

	<!-- 试卷一览信息 基本检索条件 --> 
	<sql id="conditionBisic"> 
		WHERE
			T1.NEW_FLG = 1 AND
			T1.PAPER_TYPE = 1
	</sql>

	<!-- 试卷一览信息 检索条件（动态部分） --> 
	<sql id="conditionDynamicBisic"> 
			<isNotEmpty prepend="AND" property="paperId">
				T1.PAPER_ID like CONCAT(#paperId#,'%')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="paperTitle">
				T1.PAPER_TITLE like CONCAT('%',#paperTitle#,'%')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="paperStatus">
				T1.PAPER_STATUS = #paperStatus#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updateUserId">
				T1.UPDATE_USER_ID = #updateUserId#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="createUserId">
				T1.CREATE_USER_ID = #createUserId#
			</isNotEmpty>	
	</sql>

	<!-- 试卷一览信息 检索条件（动态部分，分类） --> 
	<sql id="conditionDynamicBisicCategory"> 
			<isNotEmpty property="category1Id">
				<isNotEqual prepend="AND" property="category1Id" compareValue="0">
					T1.CATEGORY1_ID = #category1Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty property="category2Id">
				<isNotEqual prepend="AND" property="category2Id" compareValue="0">
					T1.CATEGORY2_ID = #category2Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty property="category3Id">
				<isNotEqual prepend="AND" property="category3Id" compareValue="0">
					T1.CATEGORY3_ID = #category3Id#
				</isNotEqual>
			</isNotEmpty>
	</sql>
	
	<!-- 试卷一览信息 管理员分类检索条件List --> 
	<sql id="conditionDynamicBisicCategoryList">
		<isNotEmpty prepend="AND" open="(" close=")" property="categoryInfos">
			<iterate conjunction="or" property="categoryInfos" >
				<isNotEqual open="(" close=")" property="categoryInfos[].category1Id" compareValue="0">
					T1.CATEGORY1_ID = #categoryInfos[].category1Id#
					<isNotEqual prepend="AND" property="categoryInfos[].category2Id" compareValue="0">
						T1.CATEGORY2_ID = #categoryInfos[].category2Id#
					</isNotEqual>
					<isNotEqual prepend="AND" property="categoryInfos[].category3Id" compareValue="0">
						T1.CATEGORY3_ID = #categoryInfos[].category3Id#
					</isNotEqual>
				</isNotEqual>
			</iterate>
		</isNotEmpty>
	</sql>
	
	<!-- 试卷一览信息检索 考试编辑者检索条件 --> 
	<sql id="conditionTestEditer"> 
		AND T2.USER_ID = #loginUserId# AND
		T2.AUTHORITY_ID = 8 AND
		<![CDATA[ T2.START_TIME <= NOW() ]]> AND
		<![CDATA[ T2.END_TIME >= NOW() ]]> AND
		T1.BELONG_ID = T2.RELATEDOBJECT_ID
	</sql>
	
	<!-- 试卷一览信息检索 试卷编辑者检索条件 --> 
	<sql id="conditionPaperEditer">
		AND T2.USER_ID = #loginUserId# AND
		T2.AUTHORITY_ID = 9 AND
		<![CDATA[ T2.START_TIME <= NOW() ]]> AND
		<![CDATA[ T2.END_TIME >= NOW() ]]> AND
		T1.PAPER_ID = T2.RELATEDOBJECT_ID
	</sql>	
	
	<!-- 试卷一览信息检索 试卷审批者检索条件 --> 
	<sql id="conditionPaperApprover">
		AND T2.USER_ID = #loginUserId# AND
		T2.AUTHORITY_ID = 13 AND
		<![CDATA[ T2.START_TIME <= NOW() ]]> AND
		<![CDATA[ T2.END_TIME >= NOW() ]]> AND
		T1.PAPER_ID = T2.RELATEDOBJECT_ID
	</sql>	
	
	<!-- 试卷一览信息检索 试卷管理模式考试管理者SQL语句 -->
	<sql id="sqlForTestManager"> 
		<include refid="attributeManageModeUnionBasic"/>
		,1 AS operatingKbn	
		<include refid="fromTableShiJuan"/>
		<include refid="conditionBisic"/>
		<include refid="conditionDynamicBisic"/>
		<include refid="conditionDynamicBisicCategoryList"/>
	</sql>
	
	<!-- 试卷一览信息检索 试卷管理模式考试编辑者SQL语句 -->
	<sql id="sqlForTestEditer"> 
		<include refid="attributeManageModeUnionBasic"/>
		,2 AS operatingKbn
		<include refid="fromTableShiJuan"/>
		<include refid="fromTableQuanxian"/>	
		<include refid="conditionBisic"/>
		<include refid="conditionTestEditer"/>
		<include refid="conditionDynamicBisic"/>
		<include refid="conditionDynamicBisicCategory"/>
	</sql>
	
	<!-- 试卷一览信息检索 试卷管理模式试卷编辑者SQL语句 -->
	<sql id="sqlForPaperEditer"> 
		<include refid="attributeManageModeUnionBasic"/>
		,4 AS operatingKbn
		<include refid="fromTableShiJuan"/>
		<include refid="fromTableQuanxian"/>
		<include refid="conditionBisic"/>
		<include refid="conditionPaperEditer"/>
		<include refid="conditionDynamicBisic"/>
		<include refid="conditionDynamicBisicCategory"/>
	</sql>
	
	<!-- 试卷一览信息检索 试卷管理模式试卷审批者SQL语句 -->
	<sql id="sqlForPaperApprover"> 
		<include refid="attributeManageModeUnionBasic"/>
		,8 AS operatingKbn
		<include refid="fromTableShiJuan"/>
		<include refid="fromTableQuanxian"/>
		<include refid="conditionBisic"/>
		<include refid="conditionPaperApprover"/>
		<include refid="conditionDynamicBisic"/>
		<include refid="conditionDynamicBisicCategory"/>
	</sql>

	<!-- 试卷一览信息检索件数（试卷选择模式） --> 		
	<select id="getPaperListInfosCountChooseMode" parameterClass="paperListSearchInfo" resultClass="Long"> 
		<include refid="attributeSelectCount"/>
		<include refid="fromTableShiJuan"/>
		<include refid="conditionBisic"/>
		<include refid="conditionDynamicBisic"/>
		<include refid="conditionDynamicBisicCategory"/>
	</select>
	
	<!-- 试卷一览信息检索（试卷选择模式） --> 		
	<select id="getPaperListInfosChooseMode" parameterClass="paperListSearchInfo" resultClass="paperListResult"> 
		<include refid="attributeChooseMode"/>
		<include refid="fromTableShiJuan"/>
		<include refid="conditionBisic"/>
		<include refid="conditionDynamicBisic"/>
		<include refid="conditionDynamicBisicCategory"/>
		<isEqual property="examineFlg" compareValue="2">
		AND NOT EXISTS 
		(SELECT 
			T2.PAPER_ID 
		FROM tt_sj_datixinxi T2 
		WHERE 
			T2.PAPER_ID = T1.PAPER_ID AND
			T2.PAPER_VERSION_NO = T1.PAPER_VERSION_NO AND
			T2.ATUO_MARK_FLG = 2)
		</isEqual>
		ORDER BY T1.PAPER_ID DESC
	</select>
	
	<!-- 试卷一览信息检索件数（试卷管理模式） --> 		
	<select id="getPaperListInfosCountManageMode" parameterClass="paperListSearchInfo" resultClass="Long"> 
		SELECT 
			COUNT(DISTINCT T3.PAPER_ID)
		FROM (
			<isEqual property="testManager" compareValue="true">
				(
					<include refid="sqlForTestManager"/>
				) Union ALL
			</isEqual>
			( <include refid="sqlForTestEditer"/>
		) Union ALL
			( <include refid="sqlForPaperEditer"/>
		) Union ALL
			( <include refid="sqlForPaperApprover"/>
		)) T3

	</select>
	
	<!-- 试卷一览信息检索（试卷管理模式） --> 		
	<select id="getPaperListInfosManageMode" parameterClass="paperListSearchInfo" resultClass="paperListResult"> 
		<include refid="attributeManageMode"/>
		FROM (
			<isEqual property="testManager" compareValue="true">
				(
					<include refid="sqlForTestManager"/>
				) Union ALL
			</isEqual>
			( <include refid="sqlForTestEditer"/>
		) Union ALL
			( <include refid="sqlForPaperEditer"/>
		) Union ALL
			( <include refid="sqlForPaperApprover"/>
		)) T3
		GROUP BY T3.PAPER_ID
		ORDER BY T3.PAPER_ID DESC
	</select>
	
	<!-- 取得用户考试管理员权限的个数 --> 		
	<select id="getTestManagerAuthorityCount" parameterClass="String" resultClass="Long"> 
		SELECT
			COUNT(AUTHORITY_ID) 
		FROM tt_quanxian
		WHERE 
			USER_ID = #loginUserId# AND
			AUTHORITY_ID = 2 AND
			<![CDATA[ 
					START_TIME <= NOW()
				]]>  AND
			<![CDATA[ 
					END_TIME >= NOW()
				]]>
	</select>
	
	<!-- 指定考试下关联试卷检索 --> 		
	<select id="getExaminePaperRelation" parameterClass="String" resultClass="String"> 
		Select
			PAPER_ID as paperId
		From tt_ks_shijuang
			WHERE EXAMINE_ID = #examineId#
	</select>
	
	<!--添加考试试卷关联-->
	<insert id="insertExaminePaperRelation" parameterClass="java.util.HashMap">
		INSERT INTO tt_ks_shijuang 
		(
			EXAMINE_ID,
			PAPER_ID
		) 
		VALUES 
		(
			#examineId#,
			#paperId#
		)	
	</insert>
</sqlMap>  
