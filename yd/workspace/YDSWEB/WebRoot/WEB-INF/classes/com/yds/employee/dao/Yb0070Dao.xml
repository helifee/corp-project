<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Yb0070Dao">
    <typeAlias alias="yb0070CondA" type="com.yds.employee.bean.Yb0070CondA"/>
	<typeAlias alias="yb0071CondA" type="com.yds.employee.bean.Yb0071CondA"/>

    <!-- 取得员工一览信息 --> 
    <select id="getTeamInfoList" parameterClass="yb0070CondA" resultClass="yb0070CondA"> 
        SELECT
			T1.TEAM_ID as teamId,
			T1.TEAM_NM as teamNm,
			T1.TEAM_SNM as teamSnm,
			T1.TEAM_FLG as teamFlg,
			T1.TEAM_LEADER_ID as teamLeaderId,
			(SELECT EMP_CNM FROM EMP_INFO WHERE EMP_ID = T1.TEAM_LEADER_ID) as teamLeaderNm,
			GROUP_CONCAT(T2.TEAM_USER_ID SEPARATOR ',') as teamUserId,
			GROUP_CONCAT(T3.EMP_CNM SEPARATOR ',') as teamUserNm,
			COUNT(T2.TEAM_USER_ID) as userCnt,
			(SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST 
			WHERE DIFF_NO = T1.TEAM_FLG AND TYPE_ID = 'TEAM_TYPE' AND SUB_SYS = 'EMP') as teamDiffNm,
			T1.JOIN_APPLY_FLG as joinApplyFlg,
			T4.USER_STATE_FLG as userStateFlg
        FROM
	    EMP_TEAM T1
			LEFT OUTER JOIN EMP_TEAM_USER T2
				ON T1.TEAM_ID=T2.TEAM_ID
				<![CDATA[AND T2.USER_STATE_FLG <> '02']]>
			LEFT OUTER JOIN v_emp_list_quit  T3
				ON T2.TEAM_USER_ID=T3.EMP_ID
			LEFT OUTER JOIN EMP_TEAM_USER T4
				ON T1.TEAM_ID=T4.TEAM_ID
				AND T4.TEAM_USER_ID=#loginUserId#
		WHERE 1=1
		<isEqual property="hasPermitFlg" compareValue="false">				
		AND ((T1.TEAM_FLG = '01' AND T1.TEAM_LEADER_ID=#loginUserId#)
		   OR (T1.TEAM_FLG = '02' AND ((T1.TEAM_LEADER_ID=#loginUserId#)
	       OR((SELECT COUNT(T2.TEAM_USER_ID) FROM EMP_TEAM_USER T2 
						 WHERE T1.TEAM_ID = T2.TEAM_ID 
						   AND T2.TEAM_USER_ID = #loginUserId#
						   <![CDATA[AND T2.USER_STATE_FLG <> '02']]>)>0))) 
		   OR (T1.TEAM_FLG = '03'<![CDATA[AND T2.USER_STATE_FLG <> '02']]>))
		 </isEqual>
		 <isNotEmpty prepend="AND" property = "teamId">	
			T1.TEAM_ID = #teamId#
		 </isNotEmpty>
		GROUP BY T1.TEAM_ID
		ORDER BY T1.TEAM_FLG,
				 T1.TEAM_ID

    </select>
	<!-- 取得申请内容一览信息 --> 
    <select id="getApplayInfoList" parameterClass="String" resultClass="yb0071CondA"> 
		SELECT
			T1.TEAM_ID AS teamId,
			T1.TEAM_NM AS teamNm,
			T2.TEAM_USER_ID AS teamUserId,
			(SELECT EMP_CNM FROM EMP_INFO WHERE EMP_ID = T2.TEAM_USER_ID) AS teamUserNm,
			T2.USER_STATE_FLG AS userStateFlg
		FROM
		EMP_TEAM T1
			INNER JOIN EMP_TEAM_USER T2
				ON T1.TEAM_ID = T2.TEAM_ID
		WHERE T1.TEAM_LEADER_ID = #loginUserId#
		<![CDATA[AND T2.USER_STATE_FLG <> '01']]>
		ORDER BY T2.UPDATE_TIME
    </select>
	<!-- 组信息插入 --> 	
    <insert id="insertTeamInfo" parameterClass="yb0070CondA">
        INSERT INTO
        EMP_TEAM (
        	TEAM_ID ,
        	TEAM_LEADER_ID ,
        	TEAM_FLG ,
        	TEAM_NM ,
        	TEAM_SNM ,
        	JOIN_APPLY_FLG ,
        	UPDATE_TIME ,
        	CREATE_USER_ID
        ) VALUES (			    
			#teamId#,
        	#teamLeaderId# ,
        	#teamFlg# ,
        	#teamNm# ,
        	#teamSnm# ,
			<isEqual property="joinApplyFlg" compareValue="1">
        	#joinApplyFlg# ,			
			</isEqual>
			<isNotEqual property="joinApplyFlg" compareValue="1">
				'0' ,
			</isNotEqual>					
        	NOW() ,
        	#loginUserId#
        );
    </insert>
	<!-- 组成员信息插入 --> 	
    <insert id="insertTeamUserInfo" parameterClass="yb0070CondA">
		INSERT INTO
        EMP_TEAM_USER (
        	TEAM_ID ,
        	TEAM_USER_ID ,
        	USER_STATE_FLG ,
        	UPDATE_TIME 
        ) VALUES (			    
			#teamId#,
        	#userId# ,
        	'01'  ,				
        	NOW()
        );
		
	</insert>
	<!-- 组信息更新 --> 	
    <update id="updateTeamInfo" parameterClass="yb0070CondA">
        UPDATE EMP_TEAM SET
	        TEAM_LEADER_ID = #teamLeaderId# ,
	        TEAM_FLG = #teamFlg# ,
	        TEAM_NM = #teamNm# ,
	        TEAM_SNM = #teamSnm# ,
			<isEqual property="joinApplyFlg" compareValue="1">
				JOIN_APPLY_FLG = #joinApplyFlg# ,			
			</isEqual>
			<isNotEqual property="joinApplyFlg"  compareValue="1">
				JOIN_APPLY_FLG = '0' ,			
			</isNotEqual>
	        UPDATE_TIME = NOW() ,
	        CREATE_USER_ID = #loginUserId# 
        WHERE 
	        TEAM_ID = #teamId# 
    </update>
	<!-- 组信息的删除 -->
	<delete id="deleteTeamInfo" parameterClass="String">
		DELETE FROM
			EMP_TEAM
		WHERE
			TEAM_ID = #teamId#			
	</delete>			
	<!-- 组成员信息的删除 -->
	<delete id="deleteTeamUserInfo" parameterClass="java.util.HashMap">
		DELETE FROM
			EMP_TEAM_USER
		WHERE
			TEAM_ID = #teamId#
		<isNotEmpty prepend="AND" property = "loginUserId">	
			TEAM_USER_ID = #loginUserId#
		</isNotEmpty>
		
	</delete>
	<!-- 组成员退出更新 --> 	
	<update id="quitTeamUser" parameterClass="java.util.HashMap">
        UPDATE EMP_TEAM_USER SET
	        USER_STATE_FLG = '03'	         
        WHERE 
	        TEAM_ID = #teamId# 
		AND
			TEAM_USER_ID = #loginUserId#
    </update>
	<!-- 组成员加入插入 --> 	
    <insert id="joinTeamUser" parameterClass="java.util.HashMap">
		INSERT INTO
        EMP_TEAM_USER (
        	TEAM_ID ,
        	TEAM_USER_ID ,
        	USER_STATE_FLG ,
        	UPDATE_TIME 
        ) VALUES (			    
			#teamId#,
        	#loginUserId# ,			
        	'02'  ,			
        	NOW()
        );
		
	</insert>
	<!-- 同意，不同意时，成员状态更新 --> 	
	<update id="agreeTeamUserFlg" parameterClass="java.util.HashMap">
        UPDATE EMP_TEAM_USER SET
	        USER_STATE_FLG = '01'	         
        WHERE 
	        TEAM_ID = #teamId# 
		AND
			TEAM_USER_ID = #loginUserId#
    </update>
		
</sqlMap>  
