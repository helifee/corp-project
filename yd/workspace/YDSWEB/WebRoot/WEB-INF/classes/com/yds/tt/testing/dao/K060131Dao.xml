<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K060131Dao">
<typeAlias alias="k060131ExamInfo" type="com.yds.tt.testing.bean.ExamineInfo"/>
<typeAlias alias="k060131SearchInfo" type="com.yds.tt.testing.bean.K060131SearchInfo"/>
	
	<!-- 一级、二级、三级分类 --> 
	<sql id="CATEGORYID">
		k131tks.CATEGORY1_ID AS category1Id,
		k131tks.CATEGORY2_ID AS category2Id,
		k131tks.CATEGORY3_ID AS category3Id,
	</sql>
	
	<!-- 考试一览信息条件编辑 --> 
	<sql id="edit131Sql">
		FROM  
			tt_ks_xinxi k131tks
		WHERE 
			(k131tks.PARENT_EXAMINE_ID IS NULL OR k131tks.PARENT_EXAMINE_ID = '')
			AND k131tks.EXAMINE_ID != #parenetId#
			AND EXISTS(SELECT EXAMINE_ID FROM tt_ks_xinxi WHERE PARENT_EXAMINE_ID = k131tks.EXAMINE_ID AND EXAMINE_VISIBLE_FLG = '1')
			<isNotEmpty prepend="AND" property="examineId">
				k131tks.EXAMINE_ID LIKE CONCAT(#examineId#, '%')
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="examineName">
				k131tks.EXAMINE_NAME LIKE CONCAT('%' ,#examineName#, '%')
			</isNotEmpty>
			<isNotEmpty  property="category1Id">
				<isNotEqual property="category1Id" compareValue="0" prepend="AND">
					k131tks.CATEGORY1_ID = #category1Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty property="category2Id">
				<isNotEqual property="category2Id" compareValue="0" prepend="AND" >
					k131tks.CATEGORY2_ID = #category2Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty  property="category3Id">
				<isNotEqual property="category3Id" compareValue="0" prepend="AND">
					k131tks.CATEGORY3_ID = #category3Id#
				</isNotEqual>
			</isNotEmpty>
	</sql>
	
	<!-- 考试一览信息列表取得 --> 
	<select id="getSearchInfos" parameterClass="k060131SearchInfo" resultClass="k060131ExamInfo"> 
		SELECT 
			k131tks.EXAMINE_ID AS examineId,
			<include refid="CATEGORYID"/>
			k131tks.EXAMINE_NAME AS examineName,
			k131tks.EXAMINE_COMMENT AS examineComment,
			CONCAT(CASE CATEGORY1_ID 
				WHEN 0 THEN "" ELSE 
				(SELECT CATEGORY_NAME FROM tt_fenlei
					WHERE CATEGORY1_ID = k131tks.CATEGORY1_ID 
					AND CATEGORY_LEVEL = 1)
				END,
			CASE CATEGORY2_ID
				WHEN 0 THEN "" ELSE CONCAT("-",
				(SELECT CATEGORY_NAME FROM tt_fenlei
					WHERE CATEGORY1_ID = k131tks.CATEGORY1_ID 
					AND CATEGORY2_ID = k131tks.CATEGORY2_ID 
					AND CATEGORY_LEVEL = 2))
				END ,
			CASE CATEGORY3_ID
				WHEN 0 THEN "" ELSE CONCAT("-",
				(SELECT CATEGORY_NAME FROM tt_fenlei 
					WHERE CATEGORY1_ID = k131tks.CATEGORY1_ID 
					AND CATEGORY2_ID = k131tks.CATEGORY2_ID 
					AND CATEGORY3_ID = k131tks.CATEGORY3_ID 
					AND CATEGORY_LEVEL = 3))
				END) AS categoryName
		<include refid="edit131Sql"/>
	</select>
	
	<!-- 考试一览信息总数取得 --> 
	<select id="getTotalCount" parameterClass="k060131SearchInfo" resultClass="Long">
		SELECT COUNT(*) 
		<include refid="edit131Sql"/>
	</select>
		
	<!-- 指定考试已有需要通过考试检索 --> 		
	<select id="getHadExamines" parameterClass="String" resultClass="String"> 
		Select
			NECESSARY_EXAMINE_ID as necessaryExamineId
		From tt_xuyaokaoshi
			WHERE EXAMINE_ID = #examineId#
	</select>
	
	<!--添加需要通过考试-->
	<insert id="insertNecessaryExamines" parameterClass="java.util.HashMap">
		INSERT INTO tt_xuyaokaoshi 
		(
			EXAMINE_ID,
			NECESSARY_EXAMINE_ID
		) 
		VALUES 
		(
			#examineId#,
			#necessaryExamineId#
		)	
	</insert>
</sqlMap> 