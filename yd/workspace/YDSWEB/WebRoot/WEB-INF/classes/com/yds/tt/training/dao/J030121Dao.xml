<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="J030121Dao">
	
	<typeAlias alias="j030121BookInfo" type="com.yds.tt.training.bean.BookInfo"/>
	<typeAlias alias="j030121TestPaperInfo" type="com.yds.tt.testing.bean.TestPaperInfo"/>
	
	<!-- 教材状态取得 --> 
	<select id="getBookInfo" parameterClass="j030121BookInfo" resultClass="Integer"> 
		SELECT	BOOK_STATUS 
	 
		FROM 	tt_jiaocai 

		WHERE	BOOK_ID = #bookId#
		AND		EDIT_NO = #editNo#
	</select>
	
	<!-- 教材练习取得 --> 
	<select id="getTestPaperInfos" resultClass="j030121TestPaperInfo"> 
		SELECT	T1.PAPER_ID AS paperId,
				T1.PAPER_VERSION_NO AS paperVersionNo,
				T1.PAPER_TITLE AS paperTitle,
			    <!-- 分类名称：一级分类名-二级分类名-三级分类名 -->
				CONCAT(CASE  T1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM TT_FENLEI 
						   WHERE CATEGORY1_ID =  T1.CATEGORY1_ID AND 
								CATEGORY_LEVEL = 1)
				END,
				CASE  T1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI
							    WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
									 CATEGORY2_ID =  T1.CATEGORY2_ID AND
									 CATEGORY_LEVEL = 2))
				END ,
				CASE  T1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI
							    WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
									 CATEGORY2_ID = T1.CATEGORY2_ID AND
									 CATEGORY3_ID = T1.CATEGORY3_ID AND
									 CATEGORY_LEVEL = 3))
				END) AS categoryName,
				<!-- 员工姓名 -->
				(SELECT  USER_CNM
			    FROM v_tt_user
			    WHERE USER_ID = T1.UPDATE_USER_ID) AS updateUserName,
				T1.UPDATE_TIME AS updateTime
	 
		FROM 	tt_shijuan T1

		WHERE	T1.BELONG_ID = #bookId#
		AND	    T1.NEW_FLG = 1
		
		ORDER BY  T1.UPDATE_TIME  DESC
	</select>

	<!-- 教材分类取得 --> 
	<select id="getBookCategory" parameterClass="j030121BookInfo" resultClass="j030121BookInfo"> 
		SELECT	CATEGORY1_ID AS category1Id,
				CATEGORY2_ID AS category2Id,
				CATEGORY3_ID AS category3Id
	 
		FROM 	tt_jiaocai 

		WHERE	BOOK_ID = #bookId#
		AND		EDIT_NO = #editNo#
	</select>
	
	<!-- 插入试卷表 -->
	<insert id="insertTestPaperInfo" parameterClass="j030121TestPaperInfo">
		INSERT INTO tt_shijuan 
				(PAPER_ID, 
				PAPER_VERSION_NO, 
				PAPER_TITLE, 
				PAPER_TYPE, 
				CATEGORY1_ID, 
				CATEGORY2_ID, 
				CATEGORY3_ID,  
				BELONG_ID,
				CREATE_USER_ID, 
				CREATE_TIME, 
				UPDATE_USER_ID, 
				UPDATE_TIME, 
				NEW_FLG
				)
				VALUES
				(#paperId#, 
				'1', 
				'新建练习', 
				'2', 
				#category1Id# ,
				#category2Id# ,
				#category3Id# ,
				#belongId#,
				#createUserId#, 
				NOW(), 
				#updateUserId#, 
				NOW(), 
				'1'
				);
	</insert>
	
	<!-- 删除试卷表 -->
	<delete id="deleteTest" parameterClass="j030121TestPaperInfo">
		DELETE  FROM   tt_shijuan 

		WHERE 	PAPER_ID = #paperId# 
		AND     PAPER_VERSION_NO = #paperVersionNo#;
	</delete>
	
</sqlMap>