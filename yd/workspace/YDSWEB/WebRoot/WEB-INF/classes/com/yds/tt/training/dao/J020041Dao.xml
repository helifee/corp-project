<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="J020041Dao">
	<typeAlias alias="courseInfo" type="com.yds.tt.training.bean.CourseInfo"/>
	<typeAlias alias="bookInfo" type="com.yds.tt.training.bean.BookInfo"/>
	<typeAlias alias="bookMark" type="com.yds.tt.training.bean.Bookmark"/>	
	<typeAlias alias="courseAttention" type="com.yds.tt.training.bean.CourseAttentionInfo"/>

	<!-- 共通的检索项目 -->
	<sql id="selectSql">
		SELECT  
		  (SELECT DIFF_NAME FROM COM_CODE_MST WHERE DIFF_NO = T1.NECESSARY_FLAG AND TYPE_ID = 'C19') AS necessaryName,
		  T1.NECESSARY_FLAG AS necessaryFlag,
		  T1.COURSE_NAME AS courseName,
		  T1.ABSTRACT AS courseAbstract,
		  (SELECT USER_CNM FROM V_TT_USER WHERE USER_ID = T2.USER_ID) AS publishUserName,
		  
		  <!-- 分类名称：一级分类名-二级分类名-三级分类名 -->
		  CONCAT
				(CASE  T1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM TT_FENLEI 
						   WHERE CATEGORY1_ID =  T1.CATEGORY1_ID AND 
								CATEGORY_LEVEL = 1)
				END,
				CASE  T1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI
							    WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
									 CATEGORY2_ID =  T1.CATEGORY2_ID AND
									 CATEGORY_LEVEL = 2))
				END ,
				CASE  T1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI
							    WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
									 CATEGORY2_ID = T1.CATEGORY2_ID AND
									 CATEGORY3_ID = T1.CATEGORY3_ID AND
									 CATEGORY_LEVEL = 3))
				END) AS categoryName,
		  T1.UPDATE_TIME AS updateTime,
		  T1.COURSE_PUBLISH_STATUS AS coursePublishStatus  
		FROM 
		  TT_KECHENG T1 LEFT JOIN TT_QUANXIAN T2 
		  ON T1.COURSE_ID = T2.RELATEDOBJECT_ID AND T2.AUTHORITY_ID = 10 
	</sql>	
	
	<!-- 删除和管理模式下课程信息一览取得 -->
	<select id="getCourseUserInfo" parameterClass="String" resultClass="courseInfo">
        <include refid="selectSql"/>
		WHERE 
		  T1.COURSE_ID = #courseId# 
	</select>
	
	<!-- 学习和查看模式下课程信息一览取得 -->
	<select id="getStudyViewCourseInfo" parameterClass="String" resultClass="courseInfo">
        <include refid="selectSql"/>
		WHERE 
		  T1.COURSE_ID = #courseId#  AND T1.COURSE_PUBLISH_STATUS = 2 
	</select>
		
	<!-- 编辑人员取得 -->
	<select id="getEditPer" parameterClass="String" resultClass="String">
		SELECT 
		  T2.USER_CNM
		FROM 
		  TT_QUANXIAN T1, V_TT_USER T2
		WHERE 		  
		  T1.RELATEDOBJECT_ID = #courseId# AND T2.USER_ID = T1.USER_ID AND
		  T1.AUTHORITY_ID = 6		
	</select>
	
	<!-- 教材信息一览取得 -->
	<select id="getBookInfoList" parameterClass="String" resultClass="bookInfo">
		SELECT 
		  T3.BOOK_ID AS bookId,
		  T3.BOOK_NAME AS bookName,
		  T3.EDIT_NO AS editNo,
		  (SELECT USER_CNM FROM V_TT_USER WHERE USER_ID = T3.CREATE_USER_ID) AS createUserName,
		  
		  <!-- 分类名称：一级分类名-二级分类名-三级分类名 -->
		  CONCAT
				(CASE  T3.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM TT_FENLEI 
						   WHERE CATEGORY1_ID =  T3.CATEGORY1_ID AND 
								CATEGORY_LEVEL = 1)
				END,
				CASE  T3.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI
							    WHERE CATEGORY1_ID = T3.CATEGORY1_ID AND 
									 CATEGORY2_ID =  T3.CATEGORY2_ID AND
									 CATEGORY_LEVEL = 2))
				END ,
				CASE  T3.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI 
							    WHERE CATEGORY1_ID = T3.CATEGORY1_ID AND 
									 CATEGORY2_ID = T3.CATEGORY2_ID AND
									 CATEGORY3_ID = T3.CATEGORY3_ID AND
									 CATEGORY_LEVEL = 3))
				END) AS categoryName,	 
		  T3.APPROVER_TIME AS approverTime,
		  T3.SOURCE AS source
		FROM 
		  TT_KECHENG_JIAOCAI T2,TT_JIAOCAI T3
		WHERE
		  T3.BOOK_ID = T2.BOOK_ID AND T2.COURSE_ID=#courseId# AND T3.BOOK_STATUS = 3
	</select>
	
	<!-- 删除课程 -->
	<delete id="deleteCourse" parameterClass="String">
		DELETE FROM TT_KECHENG WHERE COURSE_ID = #courseId#
	</delete>
	
	<!-- 删除课程教材关联 -->
	<delete id="deleteCourseBook" parameterClass="String">
		DELETE FROM TT_KECHENG_JIAOCAI WHERE COURSE_ID = #courseId#
	</delete>
	
	<!-- 删除课程员工关联 -->
	<delete id="deleteCourseUser" parameterClass="String">
		DELETE FROM TT_KECHENG_YUANGONG WHERE COURSE_ID = #courseId#
	</delete>
	
	<!-- 取得课程关注度 -->
	<select id="getAttention" parameterClass="courseAttention" resultClass="Object">
		SELECT 
		  T1.ATTENTION_FLAG
		FROM
		  TT_KECHENG_YUANGONG T1
		WHERE 
		  T1.COURSE_ID = #courseId# AND
		  T1.EMPLOYEES_ID = #employeesId#
	</select>
	
	<!-- 删除课程员工关联信息 -->
	<delete id="deleteAttention" parameterClass="courseAttention">
		DELETE 
		FROM 
		  TT_KECHENG_YUANGONG
		WHERE 
		  COURSE_ID = #courseId# AND
		  EMPLOYEES_ID = #employeesId#
	</delete>
	
	<!-- 插入课程关注度 -->
	<insert id="insertAttention" parameterClass="courseAttention">
		INSERT INTO
		  TT_KECHENG_YUANGONG (
			  COURSE_ID,
			  EMPLOYEES_ID,
			  ATTENTION_FLAG
		  ) VALUES (
		 	  #courseId#,
			  #employeesId#,
			  #attentionFlag#
		  )
	</insert>
</sqlMap>