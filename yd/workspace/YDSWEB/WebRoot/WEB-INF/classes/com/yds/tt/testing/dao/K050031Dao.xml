<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K050031Dao">
	<typeAlias alias="paperBigQuestionInfo" type="com.yds.tt.testing.bean.PaperBigQuestionInfo"/>
	<typeAlias alias="paperStableQuestionInfo" type="com.yds.tt.testing.bean.PaperStableQuestionInfo"/>
	<typeAlias alias="paperRandomQuestionInfo" type="com.yds.tt.testing.bean.PaperRandomQuestionInfo"/>
	<typeAlias alias="testPaperInfo" type="com.yds.tt.testing.bean.TestPaperInfo"/>

	<!-- 试卷基本信息检索 --> 		
	<select id="getPaperInfo" parameterClass="testPaperInfo" resultClass="testPaperInfo"> 
		SELECT
			T1.PAPER_ID AS paperId,
			T1.PAPER_VERSION_NO AS paperVersionNo,
			T1.PAPER_TITLE AS paperTitle,
			T1.PAPER_TYPE AS paperType,
			T1.CATEGORY1_ID AS category1Id,
			T1.CATEGORY2_ID AS category2Id,
			T1.CATEGORY3_ID AS category3Id,
			T1.PAPER_COMMENT AS paperComment,
			T1.PAPER_STATUS AS paperStatus,
			T1.REFUSE_REASON AS refuseReason,
			T1.PAPER_TOTAL_SCORE AS paperTotalScore,
			T1.PAPER_DESCRIPTION AS paperDescription,
			T1.PAPER_TIME AS paperTime,
			T1.BIGQUESTION_NUM AS bigquestionNum,
			T1.QUESTION_NUM AS questionNum,
			T1.RANDOM_BIGQUEST_FLG AS randomBigquestFlg,
			T1.BELONG_ID AS belongId,
			T1.UPDATE_TIME AS updateTime,
			T1.NEW_FLG AS newFlg,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE
				TYPE_ID = 'R02' AND
				DIFF_NO = T1.PAPER_TYPE) AS paperTypeName,
				
			CONCAT(CASE CATEGORY1_ID
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME
						   FROM tt_fenlei
						  WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
								CATEGORY2_ID = 0 AND
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 1)
				END,
				CASE CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME
							FROM tt_fenlei
							WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
								CATEGORY2_ID = T1.CATEGORY2_ID AND
								CATEGORY3_ID = 0 AND
								CATEGORY_LEVEL = 2))
				END ,
				CASE CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(
						SELECT CATEGORY_NAME
							FROM tt_fenlei t4
							WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
								CATEGORY2_ID = T1.CATEGORY2_ID AND
								CATEGORY3_ID = T1.CATEGORY3_ID AND
								CATEGORY_LEVEL = 3))
				END) AS categoryName,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE
				TYPE_ID = 'R10' AND
				DIFF_NO = T1.PAPER_STATUS) AS paperStatusName
		FROM tt_shijuan T1
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_TYPE = #paperType# AND
			NEW_FLG = 1
	</select>

	<!-- 检索大题基本信息 --> 
	<select id="getPaperBigQuestionInfos" parameterClass="testPaperInfo" resultClass="paperBigQuestionInfo"> 
		SELECT
			T1.PAPER_ID AS paperId,
			T1.PAPER_VERSION_NO AS paperVersionNo,
			T1.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T1.BIGQUESTION_ORDER AS bigquestionOrder,
			T1.BIGQUESTION_TITLE AS bigquestionTitle,
			T1.BIGQUESTION_DESCRIPTION AS bigquestionDescription,
			T1.QUESTION_KIND AS questionKind,
			T1.BIGQUESTION_TYPE AS bigquestionType,
			T1.ATUO_MARK_FLG AS atuoMarkFlg,
			T1.QUESTION_NUM AS questionNum,
			T1.BIGQUESTION_TOTAL_SCORE AS bigquestionTotalScore,
			T1.BIGQUESTION_TIME AS bigquestionTime,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE
				TYPE_ID = 'R03' AND
				DIFF_NO = T1.QUESTION_KIND) AS questionKindName,
			T1.BIGQUESTION_TYPE AS bigquestionType,
			(SELECT
				DIFF_NAME
			FROM com_code_mst
			WHERE
				TYPE_ID = 'R11' AND
				DIFF_NO = T1.BIGQUESTION_TYPE) AS bigquestionTypeName
		FROM tt_sj_datixinxi T1
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo#
		ORDER BY
			T1.BIGQUESTION_ORDER ASC
	</select>

	<!-- 检索固定大题信息 --> 
	<select id="getPaperStableQuestionInfos" parameterClass="paperBigQuestionInfo" resultClass="paperStableQuestionInfo"> 
		SELECT T1.PAPER_ID AS paperId,
			T1.PAPER_VERSION_NO AS paperVersionNo,
			T1.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T1.QUESTION_ID AS questionId,
			T1.QUESTION_ORDER AS questionOrder,
			T1.QUESTION_SCORE AS questionScore,
			T1.QUESTION_SCORE_DETAILS AS questionScoreDetails,
			CONCAT(CASE T2.CATEGORY1_ID WHEN 0 THEN "" ELSE (SELECT CATEGORY_NAME
				FROM tt_fenlei
				WHERE CATEGORY1_ID = T2.CATEGORY1_ID
				AND CATEGORY2_ID = 0
				AND CATEGORY3_ID = 0
				AND CATEGORY_LEVEL = 1) END, CASE T2.CATEGORY2_ID WHEN 0 THEN "" ELSE
				CONCAT("-", (SELECT CATEGORY_NAME
					FROM tt_fenlei
					WHERE CATEGORY1_ID = T2.CATEGORY1_ID
					AND CATEGORY2_ID = T2.CATEGORY2_ID
					AND CATEGORY3_ID = 0
					AND CATEGORY_LEVEL = 2)) END , CASE T2.CATEGORY3_ID WHEN 0 THEN ""
				ELSE CONCAT("-", (SELECT CATEGORY_NAME
					FROM tt_fenlei t4
					WHERE CATEGORY1_ID = T2.CATEGORY1_ID
					AND CATEGORY2_ID = T2.CATEGORY2_ID
					AND CATEGORY3_ID = T2.CATEGORY3_ID
					AND CATEGORY_LEVEL = 3)) END) AS categoryName,
			T2.KEYWORD AS keyword,
			(SELECT DIFF_NAME
			FROM COM_CODE_MST
			WHERE TYPE_ID = 'E01'
			AND DIFF_NO = T2.QUESTION_DIFFICULTY) AS questionDifficultyName,
			T2.CATEGORY1_ID AS category1,
			T2.CATEGORY2_ID AS category2,
			T2.CATEGORY3_ID AS category3,
			T2.QUESTION_NUMBER AS questionNumber,
			T2.QUESTION_SCORE AS questionScore,
			T2.QUESTION_TIMES AS questionTimes,
			T2.PICTURE_FLG AS pictureFlg,
			T2.MEDIA_FLG AS mediaFlg,
			T2.ATTACH_FLG AS attachFlg,
			LEFT(T2.RIGHT_TIMES * 100 / (T2.RIGHT_TIMES + T2.ERROR_TIMES), 5) AS
			rightPercent,
			T2.UPDATE_TIME AS updateTime,
			T2.QUESTION_CONTENT AS questionContent,
			T2.CREATE_USER_ID AS createUserId
		FROM tt_sj_gudingdati T1,
			tt_tiku T2
		WHERE T1.PAPER_ID = #paperId# AND
			T1.PAPER_VERSION_NO = #paperVersionNo# AND
			T1.BIGQUESTION_SERIAL_NO = #bigquestionSerialNo# AND
			T2.QUESTION_ID = T1.QUESTION_ID AND
			T2.CHECK_FLG = '2' AND
			T2.QUESTION_VERSION_NO = (SELECT MAX(QUESTION_VERSION_NO) FROM TT_TIKU WHERE QUESTION_ID = T2.QUESTION_ID)
		ORDER BY T1.BIGQUESTION_SERIAL_NO ASC,
			T1.QUESTION_ORDER ASC
	</select>

	<!-- 检索随机大题信息 --> 
	<select id="getPaperRandomQuestionInfos" parameterClass="paperBigQuestionInfo" resultClass="paperRandomQuestionInfo"> 
		SELECT
			PAPER_ID AS paperId,
			PAPER_VERSION_NO AS paperVersionNo,
			BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			CONDITION_SERIAL_NO AS conditionSerialNo,
			CATEGORY1_ID AS category1Id,
			CATEGORY2_ID AS category2Id,
			CATEGORY3_ID AS category3Id,
			KEYWORD AS keyword,
			QUESTION_DIFFICULTY AS questionDifficulty,
			QUESTION_NUM AS questionNum,
			QUESTION_SCORE AS questionScore,
			#questionKind# AS questionKind
		FROM
			tt_sj_suijidati
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo# AND
			BIGQUESTION_SERIAL_NO = #bigquestionSerialNo#
		ORDER BY
			BIGQUESTION_SERIAL_NO ASC,
			CONDITION_SERIAL_NO ASC
	</select>

	<!-- 检索试卷审批者 --> 
	<select id="getPaperApproveUserId" parameterClass="String" resultClass="String"> 
		SELECT
			USER_ID AS userId
		FROM
			tt_quanxian
		WHERE
			RELATEDOBJECT_ID = #paperId# AND
			AUTHORITY_ID = '13'
	</select>

	<!-- 更新试卷状态 --> 
	<update id="updatePaperStatus" parameterClass="testPaperInfo">
		UPDATE tt_shijuan
			SET
			PAPER_STATUS = #paperStatus#,
			UPDATE_USER_ID = #updateUserId#,
			UPDATE_TIME = now()
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo# ;
	</update>

	<!-- 更新试卷最新区分 --> 
	<update id="updatePaperNewFlg" parameterClass="testPaperInfo">
		UPDATE tt_shijuan 
			SET
			NEW_FLG = '0',
			UPDATE_USER_ID = #updateUserId#,
			UPDATE_TIME = now()
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo# ;
	</update>

	<!-- 更新试卷信息 --> 
	<update id="updatePaperInfo" parameterClass="testPaperInfo">
		UPDATE tt_shijuan
		SET
			PAPER_TITLE = #paperTitle#,
			PAPER_COMMENT = #paperComment#,
			PAPER_STATUS = #paperStatus#,
			PAPER_TOTAL_SCORE = #paperTotalScore#,
			PAPER_TIME = #paperTime#,
			PAPER_TITLE = #paperTitle#,
			PAPER_DESCRIPTION = #paperDescription#,
			BIGQUESTION_NUM = #bigquestionNum#,
			QUESTION_NUM = #questionNum#,
			RANDOM_BIGQUEST_FLG = #randomBigquestFlg#,
			<isNotEmpty property="applyUserId">
				APPLY_USER_ID = #applyUserId#,
				APPLY_TIME = now(),
			</isNotEmpty>
			UPDATE_USER_ID = #updateUserId#,
			UPDATE_TIME = now()
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo# ;
	</update>

	<!-- 删除试卷大题信息表数据 -->
	<delete id="deletePaperBigQuestionInfo" parameterClass="testPaperInfo">
		DELETE FROM tt_sj_datixinxi
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo# ;
	</delete>

	<!-- 删除试卷固定大题表数据 -->
	<delete id="deletePaperStableQuestionInfo" parameterClass="testPaperInfo">
		DELETE FROM tt_sj_gudingdati
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo# ;
	</delete>

	<!-- 删除试卷随机大题表数据 -->
	<delete id="deletePaperRandomQuestionInfo" parameterClass="testPaperInfo">
		DELETE FROM tt_sj_suijidati
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo# ;
	</delete>

	<!-- 新建新版本试卷 -->
	<insert id="insertPaperInfo" parameterClass="testPaperInfo">
		INSERT INTO tt_shijuan
		(
			PAPER_ID,
			PAPER_VERSION_NO,
			PAPER_TITLE,
			PAPER_TYPE,
			CATEGORY1_ID,
			CATEGORY2_ID,
			CATEGORY3_ID,
			PAPER_COMMENT,
			PAPER_STATUS,
			REFUSE_REASON,
			PAPER_TOTAL_SCORE,
			PAPER_DESCRIPTION,
			PAPER_TIME,
			BIGQUESTION_NUM,
			QUESTION_NUM,
			RANDOM_BIGQUEST_FLG,
			BELONG_ID,
			APPLY_USER_ID,
			APPLY_TIME,
			APPROVER_USER_ID,
			APPROVER_TIME,
			CREATE_USER_ID,
			CREATE_TIME,
			UPDATE_USER_ID,
			UPDATE_TIME,
			NEW_FLG
		)
		VALUES
		   (
		    #paperId#,
			#paperVersionNo#,
			#paperTitle#,
			#paperType#,
			#category1Id#,
			#category2Id#,
			#category3Id#,
			#paperComment#,
			#paperStatus#,
			#refuseReason#,
			#paperTotalScore#,
			#paperDescription#,
			#paperTime#,
			#bigquestionNum#,
			#questionNum#,
			#randomBigquestFlg#,
			#belongId#,
			#applyUserId#,
			#applyTime#,
			#approverUserId#,
			#approverTime#,
			#createUserId#,
			NOW(),
			#updateUserId#,
			NOW(),
			'1'
		   );
	</insert>
	
	<!-- 新建试卷大题信息 -->
	<insert id="insertPaperBigQuestionInfo" parameterClass="paperBigQuestionInfo">
		INSERT INTO tt_sj_datixinxi
		(
			PAPER_ID,
			PAPER_VERSION_NO,
			BIGQUESTION_SERIAL_NO,
			BIGQUESTION_ORDER,
			BIGQUESTION_TITLE,
			BIGQUESTION_DESCRIPTION,
			QUESTION_KIND,
			BIGQUESTION_TYPE,
			ATUO_MARK_FLG,
			QUESTION_NUM,
			BIGQUESTION_TOTAL_SCORE,
			BIGQUESTION_TIME
		) 
		VALUES 
		(
			#paperId#,
			#paperVersionNo#,
			#bigquestionSerialNo#,
			#bigquestionOrder#,
			#bigquestionTitle#,
			#bigquestionDescription#,
			#questionKind#,
			#bigquestionType#,
			#atuoMarkFlg#,
			#questionNum#,
			#bigquestionTotalScore#,
			#bigquestionTime#
		);
	</insert>

	<!-- 新建试卷固定大题信息 -->
	<insert id="insertPaperStableQuestionInfo" parameterClass="paperStableQuestionInfo">
		INSERT INTO tt_sj_gudingdati
		(
			PAPER_ID,
			PAPER_VERSION_NO,
			BIGQUESTION_SERIAL_NO,
			QUESTION_ID,
			QUESTION_ORDER,
			QUESTION_SCORE,
			QUESTION_SCORE_DETAILS
		) 
		VALUES 
		(
			#paperId#,
			#paperVersionNo#,
			#bigquestionSerialNo#,
			#questionId#,
			#questionOrder#,
			#questionScore#,
			#questionScoreDetails#
		);
	</insert>
	
	<!-- 新建试卷随机大题信息 -->
	<insert id="insertPaperRandomQuestionInfo" parameterClass="paperRandomQuestionInfo">
		INSERT INTO tt_sj_suijidati 
		(
			PAPER_ID,
			PAPER_VERSION_NO,
			BIGQUESTION_SERIAL_NO,
			CONDITION_SERIAL_NO,
			CATEGORY1_ID,
			CATEGORY2_ID,
			CATEGORY3_ID,
			KEYWORD,
			QUESTION_DIFFICULTY,
			QUESTION_NUM,
			QUESTION_SCORE
		) 
		VALUES 
		(
			#paperId#,
			#paperVersionNo#,
			#bigquestionSerialNo#,
			#conditionSerialNo#,
			#category1Id#,
			#category2Id#,
			#category3Id#,
			#keyword#,
			#questionDifficulty#,
			#questionNum#,
			#questionScore#
		);
	</insert>

	<!-- 登录提醒消息 -->
	<insert id="insertMessage" parameterClass="com.yds.tt.manager.bean.MessageReminding">
		INSERT INTO TT_TXXIAOXI
		VALUES
		   (
		    #informationId#,
			#userId#,
			#relatedobjectLink#,
			#content#,
			#losetime#,
			#informationFlg#
		   );
	</insert>
	
	<!-- 时间戳检索 --> 
	<select id="getTimeStamp" parameterClass="testPaperInfo" resultClass="Date">
		SELECT 	UPDATE_TIME AS timeStamp
			FROM 
				tt_shijuan
		WHERE
			PAPER_ID = #paperId# AND
			PAPER_VERSION_NO = #paperVersionNo#
		FOR UPDATE;
	</select>
</sqlMap>  
