<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="orgRelationDao">
	
	<typeAlias alias="attEmpOrgInfo" type="com.yds.att.bean.AttEmpOrgInfo"/>
	<typeAlias alias="attUserInfo" type="com.yds.common.bean.UserInfo"/>	

	<select id="getOrgs" parameterClass="java.util.HashMap" resultClass="attEmpOrgInfo">
		<![CDATA[
		SELECT 
			a.ORG_ID as orgId, 
			a.ORG_NM as orgNm, 
			a.ORG_SNM as orgSnm, 
			a.ORG_ST_DATE as orgStDate, 
			a.ORG_END_DATE as orgEndDate, 
			a.ORG_STATE_FLG as orgStateFlg, 
			a.ORG_PRO_ID as orgProId, 
			a.ORG_LEV as orgLev, 
			a.ORG_MNGER as orgMnger, 
			d.EMP_CNM AS orgMngerName,
			a.ORG_DESC as orgDesc, 
			c.PRO1 as orgProType
		FROM emp_org_info a LEFT JOIN v_emp_list_quit d	ON (a.ORG_MNGER = d.EMP_ID), sys_code_mst c 				
		WHERE (SELECT		
				 GROUP_CONCAT(TRIM(TRAILING '00000' FROM b.org_lev) SEPARATOR 'P')		
			   FROM emp_org_info AS b		
			   WHERE b.org_id IN(SELECT		
								   org_id		
								 FROM emp_grp_his		
								 WHERE emp_id = #empId# AND START_TIME <= #date# AND END_TIME >= #date#)		
			)	
			REGEXP 	
			CONCAT('^',TRIM(TRAILING '00000' FROM org_lev),'|P',TRIM(TRAILING '00000' FROM org_lev) )
			AND c.SUB_SYS = 'EMP' AND c.TYPE_ID = 'ORG_TYPE' AND c.DIFF_NO = a.ORG_PRO_ID
		ORDER BY a.org_lev;
		]]>	
	</select>
	
	<select id="getManagedOrg" parameterClass="String" resultClass="attEmpOrgInfo">
		<![CDATA[
			SELECT
				a.ORG_ID AS orgId, 
				a.ORG_NM AS orgNm, 
				a.ORG_SNM AS orgSnm, 
				a.ORG_ST_DATE AS orgStDate, 
				a.ORG_END_DATE AS orgEndDate, 
				a.ORG_STATE_FLG AS orgStateFlg, 
				a.ORG_PRO_ID AS orgProId, 
				a.ORG_LEV AS orgLev, 
				a.ORG_MNGER AS orgMnger, 
				d.EMP_CNM AS orgMngerName,
				a.ORG_DESC AS orgDesc, 
				b.PRO1 AS orgProType				
			FROM emp_org_info a, sys_code_mst b, v_emp_list_quit d		
			WHERE org_lev REGEXP 	
				(SELECT 
				CONCAT( '(^' , GROUP_CONCAT(DISTINCT TRIM(TRAILING '00000' FROM org_lev) SEPARATOR '.*$$)|(^') , '.*$$)' )
				FROM emp_org_info 
				WHERE ORG_MNGER=#empId# 
				)
				AND b.SUB_SYS = 'EMP' AND b.TYPE_ID = 'ORG_TYPE' AND b.DIFF_NO = a.ORG_PRO_ID AND a.ORG_MNGER = d.EMP_ID	
			ORDER BY ORG_PRO_ID,ORG_END_DATE DESC ,org_st_date DESC;
		]]>		
	</select>
	
	<select id="getManagedProject" parameterClass="String" resultClass="attEmpOrgInfo">
		<![CDATA[
			SELECT
				a.ORG_ID AS orgId, 
				a.ORG_NM AS orgNm, 
				a.ORG_SNM AS orgSnm, 
				a.ORG_ST_DATE AS orgStDate, 
				a.ORG_END_DATE AS orgEndDate, 
				a.ORG_STATE_FLG AS orgStateFlg, 
				a.ORG_PRO_ID AS orgProId, 
				a.ORG_LEV AS orgLev, 
				a.ORG_MNGER AS orgMnger, 
				d.EMP_CNM AS orgMngerName,
				a.ORG_DESC AS orgDesc, 
				b.PRO1 AS orgProType				
			FROM emp_org_info a, sys_code_mst b, v_emp_list_quit d		
			WHERE org_lev REGEXP 	
				(SELECT 
				CONCAT( '(^' , GROUP_CONCAT(DISTINCT TRIM(TRAILING '00000' FROM org_lev) SEPARATOR '.*$$)|(^') , '.*$$)' )
				FROM emp_org_info 
				WHERE ORG_MNGER=#empId# 
				)
				AND b.SUB_SYS = 'EMP' AND b.TYPE_ID = 'ORG_TYPE' AND b.DIFF_NO = a.ORG_PRO_ID 
				AND a.ORG_MNGER = d.EMP_ID AND b.PRO1 = 'prjt'	
			ORDER BY ORG_PRO_ID,ORG_END_DATE DESC ,org_st_date DESC;
		]]>		
	</select>
	
	<select id="getOrgLevelBy" parameterClass="String" resultClass="String">
		SELECT ORG_LEV FROM emp_org_info WHERE ORG_ID = #orgId#
	</select>
	
	<select id="getOrgBy" parameterClass="String" resultClass="attEmpOrgInfo">
		SELECT 
			a.ORG_ID AS orgId, 
			a.ORG_NM AS orgNm, 
			a.ORG_SNM AS orgSnm, 
			a.ORG_ST_DATE AS orgStDate, 
			a.ORG_END_DATE AS orgEndDate, 			
			a.ORG_MNGER AS orgMnger, 
			d.EMP_CNM AS orgMngerName,
			b.PRO1 AS orgProType
		FROM emp_org_info a, sys_code_mst b, v_emp_list_quit d
		WHERE a.ORG_LEV = #level# AND b.SUB_SYS = 'EMP' AND b.TYPE_ID = 'ORG_TYPE' AND b.DIFF_NO = a.ORG_PRO_ID	AND a.ORG_MNGER = d.EMP_ID
	</select>
	
	<select id="getOrgInfoById" parameterClass="String" resultClass="attEmpOrgInfo">
		SELECT 
			a.ORG_ID AS orgId, 
			a.ORG_NM AS orgNm, 
			a.ORG_SNM AS orgSnm, 
			a.ORG_ST_DATE AS orgStDate, 
			a.ORG_END_DATE AS orgEndDate, 
			a.ORG_STATE_FLG AS orgStateFlg,
			a.ORG_PRO_ID AS orgProId,
			a.ORG_LEV AS orgLev,
			a.ORG_VIEW_FLG AS orgViewFlg,
			a.ORG_DESC AS orgDesc,
			a.ORG_MNGER AS orgMnger, 
			a.UPDATE_USER AS updateUser,
			a.UPDATE_TIME AS updateTime,
			d.EMP_CNM AS orgMngerName,
			b.PRO1 AS orgProType
		FROM emp_org_info a, sys_code_mst b, v_emp_list_quit d
		WHERE a.ORG_ID = #orgId# AND b.SUB_SYS = 'EMP' AND b.TYPE_ID = 'ORG_TYPE' AND b.DIFF_NO = a.ORG_PRO_ID	AND a.ORG_MNGER = d.EMP_ID
	</select>
	
	<select id="getMembers" parameterClass="java.util.HashMap" resultClass="attUserInfo">
		SELECT 
			a.EMP_ID AS userId, 
			b.EMP_CNM AS userName  
		FROM emp_grp_his a, v_emp_list_quit b 
		WHERE a.EMP_ID = b.EMP_ID AND a.ORG_ID = #orgId#
		<isNotNull prepend="AND" property="date">
			<![CDATA[
				a.START_TIME <= #date# AND a.END_TIME >= #date#
			]]>
		</isNotNull>		
	</select>
	
	<select id="getJoinPrjt" parameterClass="java.util.HashMap" resultClass="attEmpOrgInfo">
		SELECT 
			b.ORG_ID AS orgId, 
			b.ORG_NM AS orgNm, 
			b.ORG_SNM AS orgSnm, 
			b.ORG_ST_DATE AS orgStDate, 
			b.ORG_END_DATE AS orgEndDate, 
			b.ORG_STATE_FLG AS orgStateFlg, 
			b.ORG_PRO_ID AS orgProId, 
			b.ORG_LEV AS orgLev, 
			b.ORG_MNGER AS orgMnger, 
			d.EMP_CNM AS orgMngerName,
			b.ORG_DESC AS orgDesc, 
			c.PRO1 AS orgProType
		FROM emp_grp_his a, 
			 emp_org_info b, 
			 sys_code_mst c, 
			 v_emp_list_quit d
		WHERE a.EMP_ID = #empId# AND a.ORG_ID = b.ORG_ID 
			AND c.SUB_SYS = 'EMP' AND c.TYPE_ID = 'ORG_TYPE' 
			AND c.DIFF_NO = b.ORG_PRO_ID AND c.PRO1 = 'prjt' 
			AND b.ORG_MNGER = d.EMP_ID
			<isEqual prepend="AND" property="type" compareValue="0">
				<![CDATA[
					b.ORG_END_DATE < CURDATE()
				]]>
			</isEqual>
			<isEqual prepend="AND" property="type" compareValue="1"> 
				<![CDATA[
					b.ORG_ST_DATE <= CURDATE() AND b.ORG_END_DATE >= CURDATE()
				]]>
			</isEqual>
			<isEqual prepend="AND" property="type" compareValue="2"> 
				<![CDATA[
					b.ORG_ST_DATE > CURDATE()
				]]>
			</isEqual>
		ORDER BY b.ORG_ST_DATE DESC 
	</select>

</sqlMap> 