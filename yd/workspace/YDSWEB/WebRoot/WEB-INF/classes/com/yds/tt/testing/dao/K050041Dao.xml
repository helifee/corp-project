<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K050041Dao">
	<typeAlias alias="paperRandomQuestionInfo" type="com.yds.tt.testing.bean.PaperRandomQuestionInfo"/>
	<typeAlias alias="paperStableQuestionInfo" type="com.yds.tt.testing.bean.PaperStableQuestionInfo"/>
	<typeAlias alias="answerInfo" type="com.yds.tt.testing.bean.AnswerInfo"/>
	<typeAlias alias="arrayList" type="java.util.ArrayList"/>
	<!--  检索固定大题项目语句 --> 
	<select id="getQuestionInfos" parameterClass="arrayList" resultClass="paperStableQuestionInfo">
	SELECT 
			T1.QUESTION_ID AS questionId,
			 CONCAT(CASE T1.CATEGORY1_ID 
			WHEN 0 THEN ""
			ELSE 
				(SELECT T5.CATEGORY_NAME 
				   FROM TT_FENLEI T5 
				  WHERE T5.CATEGORY1_ID =  T1.CATEGORY1_ID AND 
						T5.CATEGORY_LEVEL = 1)
		END,
		CASE  T1.CATEGORY2_ID
			WHEN 0 THEN ""
			ELSE CONCAT("-",(SELECT T6.CATEGORY_NAME 
						FROM TT_FENLEI T6
					   WHERE T6.CATEGORY1_ID = T1.CATEGORY1_ID AND 
							 T6.CATEGORY2_ID =  T1.CATEGORY2_ID AND
							 T6.CATEGORY_LEVEL = 2))
		END,
		CASE  T1.CATEGORY3_ID
			WHEN 0 THEN ""
			ELSE CONCAT("-",(SELECT T4.CATEGORY_NAME 
						FROM TT_FENLEI T4
					   WHERE T4.CATEGORY1_ID = T1.CATEGORY1_ID AND 
							 T4.CATEGORY2_ID = T1.CATEGORY2_ID AND
							 T4.CATEGORY3_ID = T1.CATEGORY3_ID AND
							 T4.CATEGORY_LEVEL = 3))
		END) AS categoryName,
			T1.KEYWORD AS keyword,
			(SELECT COM_CODE_MST.DIFF_NAME  FROM COM_CODE_MST
			  WHERE COM_CODE_MST.TYPE_ID = 'E01'
			  AND COM_CODE_MST.DIFF_NO = T1.QUESTION_DIFFICULTY
			)AS questionDifficultyName,
			T1.CATEGORY1_ID AS category1,
			T1.CATEGORY2_ID AS category2,
			T1.CATEGORY3_ID AS category3,
			T1.QUESTION_NUMBER AS questionNumber,
			T1.QUESTION_SCORE AS questionScore,
			T1.QUESTION_TIMES AS questionTimes,
			T1.PICTURE_FLG AS pictureFlg,
			T1.MEDIA_FLG AS mediaFlg,
			T1.ATTACH_FLG AS attachFlg,
			LEFT(T1.RIGHT_TIMES*100/(T1.RIGHT_TIMES+T1.ERROR_TIMES),5) AS rightPercent,
			T1.UPDATE_TIME AS updateTime,
			T1.QUESTION_CONTENT AS questionContent,
			T1.CREATE_USER_ID AS createUserId
	FROM TT_TIKU T1
	WHERE 
		(<iterate conjunction="or">
			T1.QUESTION_ID =  #addQuestionId[]#
			AND T1.QUESTION_VERSION_NO = (SELECT MAX(T1.QUESTION_VERSION_NO) 
		FROM TT_TIKU T1 WHERE QUESTION_ID = #gdQuestionIdList[]#)
		</iterate>)
		AND T1.CHECK_FLG = '2'
	</select>

	<!--  检索题库试题数量 --> 
	<select id="getQuestionCount" parameterClass="paperRandomQuestionInfo" resultClass="Long">
	SELECT 
		COUNT(QUESTION_ID)
	FROM TT_TIKU
	WHERE 
		QUESTION_TYPE = '1'
		AND NEW_FLG = '2'
		AND CHECK_FLG = '2'
		AND QUESTION_KIND = #questionKind#
		AND QUESTION_NUMBER = '1'
		<isNotEmpty property="category1Id">
			<isNotEqual prepend="AND" property="category1Id" compareValue="0">
				CATEGORY1_ID = #category1Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category2Id">
			<isNotEqual prepend="AND" property="category2Id" compareValue="0">
				CATEGORY2_ID = #category2Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category3Id">
			<isNotEqual prepend="AND" property="category3Id" compareValue="0">
				CATEGORY3_ID = #category3Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty prepend="AND" open="(" close=")" property="keywordList">
			<iterate conjunction="AND" property="keywordList" >
					KEYWORD LIKE CONCAT('%' , #keywordList[]#, '%')
			</iterate>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="questionDifficulty"> 
			QUESTION_DIFFICULTY = #questionDifficulty#
		</isNotEmpty>
	</select>
	
	<!--  检索答案信息 --> 
	<select id="getAnswerInfo" parameterClass="String" resultClass="answerInfo">
		SELECT 	
			ANSWER_SERIAL_NO AS answerSerialNo, 
			ANSWER_SCORE AS answerScore
		FROM 
			tt_daan 
		WHERE 	QUESTION_ID = #questionId# AND 
			QUESTION_VERSION_NO = (
				SELECT MAX(QUESTION_VERSION_NO) AS questionVersionNo 
				FROM
				tt_daan WHERE QUESTION_ID = #questionId#)
			GROUP BY ANSWER_SERIAL_NO
	</select>
</sqlMap>