<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Yb9010Dao">
    <typeAlias alias="yb9010CondA" type="com.yds.employee.bean.Yb9010CondA"/>
    <typeAlias alias="yb9010CondB" type="com.yds.employee.bean.Yb9010CondB"/>
    <typeAlias alias="empInfoa" type="com.yds.common.bean.EmpInfo"/>

    <!-- 主页面取得员工信息 --> 
    <select id="getEmpInfoList" parameterClass="yb9010CondA" resultClass="empInfoa"> 
        SELECT
			T1.EMP_ID           as empId,
			T1.EMP_CNM          as empCnm,
			(SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST 
			WHERE DIFF_NO = T1.EMP_SEX AND TYPE_ID = 'SEX' AND SUB_SYS = 'EMP') AS empSex,
			<!-- 态别FLG为部门时 --> 
			CASE T5.ORG_STATE_FLG    WHEN '0' THEN T5.ORG_SNM 
			<!-- 态别FLG为项目时 --> 
			ELSE CONCAT(T5.ORG_SNM ,"(",   
			(SELECT EMP_CNM FROM EMP_INFO     WHERE EMP_ID = T5.ORG_MNGER),")" )END AS orgSnmMngerNm 
        FROM
			<isNotEmpty property = "teamId">
				<isNotNull property="teamFlg">
					<isEqual compareValue="01" property="teamFlg">
						EMP_TEAM T9,
					</isEqual>
				</isNotNull>
				EMP_TEAM_USER T8,
			</isNotEmpty>		
            EMP_INFO T1
			LEFT JOIN EMP_STAFF_POS T2
				 ON T1.EMP_ID = T2.EMP_ID
				 <!-- 主要职位表示为1（主要职位） --> 
				 AND T2.MAIN_POS_FLG = '1'
			LEFT JOIN EMP_POS T3
				 ON T2.POS_ID = T3.POS_ID
			LEFT JOIN EMP_STAFF_ORG_RELATION T4
				 ON T1.EMP_ID = T4.EMP_ID
			LEFT JOIN EMP_ORG_INFO T5
				 ON T4.ORG_ID = T5.ORG_ID
				 <!-- 可见FLG为1（可见） --> 
				 AND T5.ORG_VIEW_FLG = '1'
			INNER JOIN SYS_CODE_MST T6
				 ON T5.ORG_PRO_ID = T6.DIFF_NO
				 AND T6.SUB_SYS = 'EMP'
				 AND T6.TYPE_ID = 'ORG_TYPE'
				 AND T6.DEL_FLG = '0',
			SYS_CODE_MST T7 
		<!-- 态别FLG为部门时，公司，子公司排除 --> 
        WHERE ((T5.ORG_STATE_FLG = '0' AND T6.PRO1 = 'dept')
		<!-- 选择项目时，子项目排除 --> 
		OR (T6.PRO1 = 'prjt' AND T6.PRO2 = '1'))
		AND T7.DIFF_NO = T1.EMP_STATE_ID
		AND T7.TYPE_ID = 'STATE'
		AND T7.SUB_SYS = 'EMP' 
		AND T7.PRO2 = '1'
		<isNotEmpty prepend="AND" property = "orgId">	
			T5.ORG_LEV LIKE CONCAT((SELECT TRIM(TRAILING '0' FROM org_lev) 
			FROM EMP_ORG_INFO WHERE ORG_ID = #orgId#),'%') 
		</isNotEmpty>
		<isNotEmpty prepend="AND" property = "posTypeId">	
			T3.POS_TYPE_ID = #posTypeId#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property = "posId">	
			T2.POS_ID = #posId#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property = "startYear">	
			T1.START_DATE LIKE CONCAT(#startYear#,'%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property = "teamId">
			T8.TEAM_USER_ID = T1.EMP_ID AND
			T8.TEAM_ID = #teamId# AND
			(T8.USER_STATE_FLG = '01' OR 
			T8.USER_STATE_FLG = '03')
			<isNotNull property="teamFlg">
				<isEqual prepend="AND" compareValue="01" property="teamFlg">
					T9.TEAM_LEADER_ID = #userId# 
				</isEqual>				
			</isNotNull>
		</isNotEmpty>		
		ORDER BY T1.EMP_ID,
		SUBSTRING(T5.ORG_LEV,16,5) DESC,
		SUBSTRING(T5.ORG_LEV,11,5) DESC,
		SUBSTRING(T5.ORG_LEV,6,5) DESC,
		SUBSTRING(T5.ORG_LEV,1,5) DESC
    </select>
	<!-- 高级查询取得员工信息 --> 
    <select id="getEmpInfoListAdv" parameterClass="yb9010CondB" resultClass="empInfoa"> 
		SELECT
			T1.EMP_ID           as empId,
			T1.EMP_CNM          as empCNm,
			(SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST 
			WHERE DIFF_NO = T1.EMP_SEX AND TYPE_ID = 'SEX' AND SUB_SYS = 'EMP') AS empSex,
			<!-- 态别FLG为部门时 --> 
			CASE T5.ORG_STATE_FLG    WHEN '0' THEN T5.ORG_SNM 
			<!-- 态别FLG为项目时 --> 
			ELSE CONCAT(T5.ORG_SNM ,"(",   
			(SELECT EMP_CNM FROM EMP_INFO     WHERE EMP_ID = T5.ORG_MNGER),")" )END AS orgSnmMngerNm 
        FROM
			<isNotEmpty property = "teamId">
				<isNotNull property="teamFlg">
					<isEqual compareValue="01" property="teamFlg">
						EMP_TEAM T8,
					</isEqual>
				</isNotNull>
				EMP_TEAM_USER T7,
			</isNotEmpty>
            EMP_INFO T1
			LEFT JOIN EMP_STAFF_POS T2
				 ON T1.EMP_ID = T2.EMP_ID
				 <!-- 主要职位表示为1（主要职位） --> 
				 AND T2.MAIN_POS_FLG = '1'
			LEFT JOIN EMP_POS T3
				 ON T2.POS_ID = T3.POS_ID
			LEFT JOIN EMP_STAFF_ORG_RELATION T4
				 ON T1.EMP_ID = T4.EMP_ID
			LEFT JOIN EMP_ORG_INFO T5
				 ON T4.ORG_ID = T5.ORG_ID
				 <!-- 可见FLG为1（可见） --> 
				 AND T5.ORG_VIEW_FLG = '1'
			INNER JOIN SYS_CODE_MST T6
				 ON T5.ORG_PRO_ID = T6.DIFF_NO
				 AND T6.SUB_SYS = 'EMP'
				 AND T6.TYPE_ID = 'ORG_TYPE'
				 AND T6.DEL_FLG = '0'
		<!-- 态别FLG为部门时，公司，子公司排除 --> 
        WHERE ((T5.ORG_STATE_FLG = '0' AND T6.PRO1 = 'dept')
		<!-- 选择项目时，子项目排除 --> 
		OR (T6.PRO1 = 'prjt' AND T6.PRO2 = '1'))
		<isNotEmpty prepend="AND" property = "empId">	
			T1.EMP_ID LIKE CONCAT(#empId#,'%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empNm">
			T1.EMP_CNM LIKE CONCAT(#empNm#,'%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empSex">
			T1.EMP_SEX = #empSex#
		</isNotEmpty>
		<isNotEmpty prepend="AND" open="(" close=")" property="orgIdInfos">
			<iterate conjunction="OR" property="orgIdInfos" >
				T5.ORG_ID = #orgIdInfos[]#
			</iterate>
		</isNotEmpty>
		<isNotEmpty prepend="AND" open="(" close=")" property="posIdInfos">
			<iterate conjunction="OR" property="posIdInfos" >
				T2.POS_ID = #posIdInfos[]#
			</iterate>
		</isNotEmpty>
		<isNotEmpty prepend="AND" open="(" close=")" property="empStatusIdInfos">
			<iterate conjunction="OR" property="empStatusIdInfos" >
				T1.EMP_STATUS_ID = #empStatusIdInfos[]#
			</iterate>
		</isNotEmpty>
		<isNotEmpty prepend="AND" open="(" close=")" property="empStateIdInfos">
			<iterate conjunction="OR" property="empStateIdInfos" >
				T1.EMP_STATE_ID = #empStateIdInfos[]#
			</iterate>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property = "startYearFrom">	
			T1.START_DATE >= CONCAT(#startYearFrom#,'-01-01')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property = "startYearTo">	
		<![CDATA[ T1.START_DATE <= CONCAT(#startYearTo#,'-12-31') ]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property = "teamId">
			T7.TEAM_USER_ID = T1.EMP_ID AND
			T7.TEAM_ID = #teamId# AND
			(T7.USER_STATE_FLG = '01' OR 
			T7.USER_STATE_FLG = '03')
			<isNotNull property="teamFlg">
				<isEqual prepend="AND" compareValue="01" property="teamFlg">
					T8.TEAM_LEADER_ID = #userId# 
				</isEqual>				
			</isNotNull>
		</isNotEmpty>
		
		ORDER BY T1.EMP_ID,
		SUBSTRING(T5.ORG_LEV,16,5) DESC,
		SUBSTRING(T5.ORG_LEV,11,5) DESC,
		SUBSTRING(T5.ORG_LEV,6,5) DESC,
		SUBSTRING(T5.ORG_LEV,1,5) DESC
    </select>
	
	<select id="getTeamFlgAdv" parameterClass="String" resultClass="String">
		SELECT TEAM_FLG 
		  FROM EMP_TEAM 
		 WHERE TEAM_ID = #teamId#
	</select>
</sqlMap>  
