<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="G010021Dao">
	<typeAlias alias="g010021aInfo" type="com.yds.tt.manager.bean.G010021aInfo"/>
	<!-- 维护权限分配查询语句 -->
	<select id="getG010021aInfo" parameterClass="g010021aInfo" resultClass="g010021aInfo">
	SELECT T1.USER_ID AS userIdNum,
	   (SELECT USER_CNM FROM v_tt_user WHERE USER_ID=T1.USER_ID) AS userCnm,
       (CASE  T1.CATEGORY1_ID
           WHEN 0 THEN "正常"
		   ELSE
			   (SELECT DIFF_NAME FROM COM_CODE_MST WHERE TYPE_ID = 'R15' AND DIFF_NO = T2.CATEGORY_STATUS)
		END) AS categoryStatus,
       (SELECT DIFF_NAME FROM COM_CODE_MST WHERE TYPE_ID = 'R07' AND DIFF_NO = T1.AUTHORITY_ID) AS authority,
       CONCAT
		(CASE  T1.CATEGORY1_ID 
			WHEN 0 THEN "全部"
			ELSE 
				(SELECT T5.CATEGORY_NAME 
				   FROM TT_FENLEI T5 
				  WHERE T5.CATEGORY1_ID =  T1.CATEGORY1_ID AND 
						T5.CATEGORY_LEVEL = 1)
		END,
		CASE  T1.CATEGORY2_ID
			WHEN 0 THEN ""
			ELSE CONCAT("-",(SELECT T6.CATEGORY_NAME 
						FROM TT_FENLEI T6
					   WHERE T6.CATEGORY1_ID = T1.CATEGORY1_ID AND 
							 T6.CATEGORY2_ID =  T1.CATEGORY2_ID AND
							 T6.CATEGORY_LEVEL = 2))
		END,
		CASE  T1.CATEGORY3_ID
			WHEN 0 THEN ""
			ELSE CONCAT("-",(SELECT T4.CATEGORY_NAME 
						FROM TT_FENLEI T4
					   WHERE T4.CATEGORY1_ID = T1.CATEGORY1_ID AND 
							 T4.CATEGORY2_ID = T1.CATEGORY2_ID AND
							 T4.CATEGORY3_ID = T1.CATEGORY3_ID AND
							 T4.CATEGORY_LEVEL = 3))
		END) AS categoryName,
			T1.AUTHORITY_ID AS authorityId, 
			T1.CATEGORY1_ID AS sltCategory1, 
			T1.CATEGORY2_ID AS sltCategory2, 
			T1.CATEGORY3_ID AS sltCategory3, 
			T1.START_TIME   AS startTimeNm, 
			T1.END_TIME     AS endTimeNm,
			T1.RELATEDOBJECT_ID AS relatedobjectId
		FROM TT_QUANXIAN T1 LEFT JOIN TT_FENLEI T2 
		ON T1.CATEGORY1_ID = T2.CATEGORY1_ID 
			AND (T1.CATEGORY2_ID = T2.CATEGORY2_ID 
			AND T1.CATEGORY3_ID= T2.CATEGORY3_ID) 
			WHERE (T1.AUTHORITY_ID = '1' 
			OR T1.AUTHORITY_ID = '2'
			OR T1.AUTHORITY_ID = '3') 
		ORDER BY categoryStatus DESC , 
			userIdNum ASC , 
			authorityId ASC, 
			sltCategory1 ASC, 
			sltCategory2 ASC, 
			sltCategory3 ASC, 
			startTimeNm ASC 
	</select>
	<!-- 权限分配信息总数 --> 
	<select id="getTotalCount" resultClass="Long"> 
		SELECT
			COUNT(T1.USER_ID) AS CNT
		FROM TT_QUANXIAN T1 LEFT JOIN TT_FENLEI T2 
		ON T1.CATEGORY1_ID = T2.CATEGORY1_ID 
			AND (T1.CATEGORY2_ID = T2.CATEGORY2_ID 
			AND T1.CATEGORY3_ID= T2.CATEGORY3_ID) 
			WHERE (T1.AUTHORITY_ID = '1' 
			OR T1.AUTHORITY_ID = '2'
			OR T1.AUTHORITY_ID = '3') 
	</select>
	<!-- 权限申请一览查询语句 -->
	<select id="getG010021ApplicationInfo" parameterClass="g010021aInfo" resultClass="g010021aInfo">
	SELECT T1.USER_ID AS userIdNum,
       (SELECT USER_CNM FROM v_tt_user WHERE USER_ID=T1.USER_ID) AS userCnm,
       (SELECT DIFF_NAME FROM COM_CODE_MST WHERE TYPE_ID = 'R07' AND DIFF_NO = T1.AUTHORITY_ID) AS authority,
       T1.AUTHORITY_ID AS authorityId,
       CONCAT
		   (CASE  T1.CATEGORY1 
			   WHEN 0 THEN ""
			   ELSE 
				   (SELECT T5.CATEGORY_NAME 
					  FROM TT_FENLEI T5 
					 WHERE T5.CATEGORY1_ID =  T1.CATEGORY1 AND 
						   T5.CATEGORY_LEVEL = 1)
			   END,
			   CASE  T1.CATEGORY2
				   WHEN 0 THEN ""
				   ELSE CONCAT("-",(SELECT T6.CATEGORY_NAME 
							   FROM TT_FENLEI T6
							  WHERE T6.CATEGORY1_ID = T1.CATEGORY1 AND 
									T6.CATEGORY2_ID =  T1.CATEGORY2 AND
									T6.CATEGORY_LEVEL = 2))
			   END,
			   CASE  T1.CATEGORY3
				   WHEN 0 THEN ""
				   ELSE CONCAT("-",(SELECT T4.CATEGORY_NAME 
							   FROM TT_FENLEI T4
							  WHERE T4.CATEGORY1_ID = T1.CATEGORY1 AND 
									T4.CATEGORY2_ID = T1.CATEGORY2 AND
									T4.CATEGORY3_ID = T1.CATEGORY3 AND
									T4.CATEGORY_LEVEL = 3))
			   END) AS categoryName,
		T1.CATEGORY1 AS sltCategory1, 
		T1.CATEGORY2 AS sltCategory2, 
		T1.CATEGORY3 AS sltCategory3, 
		T1.START_TIME   AS startTimeNm, 
		T1.END_TIME     AS endTimeNm,
		T1.APPLY_TIME   AS applyTime,
		T1.APPLY_REASON AS applyReason
	FROM TT_QXSHENQING T1
	</select>
	<!-- 权限申请一览信息总数 --> 
	<select id="getTotalCountApplication" resultClass="Long"> 
		SELECT
			COUNT(USER_ID) AS CNT
		FROM TT_QXSHENQING 
	</select>
	<!--其他权限分配信息查询语句-->
	<select id="getG010021OtherInfo" parameterClass="g010021aInfo" resultClass="g010021aInfo">
	SELECT T1.USER_ID AS userIdNum,
       (SELECT USER_CNM FROM v_tt_user WHERE USER_ID=T1.USER_ID) AS userCnm,
       (SELECT DIFF_NAME FROM COM_CODE_MST WHERE TYPE_ID = 'R07' AND DIFF_NO = T1.AUTHORITY_ID) AS authority,
		T1.AUTHORITY_ID AS authorityId, 
		T1.CATEGORY1_ID AS sltCategory1, 
		T1.CATEGORY2_ID AS sltCategory2, 
		T1.CATEGORY3_ID AS sltCategory3, 
		T1.START_TIME   AS startTimeNm, 
		T1.END_TIME     AS endTimeNm,
		T1.RELATEDOBJECT_ID AS relatedobjectId
	FROM TT_QUANXIAN T1
	WHERE (T1.AUTHORITY_ID = '4' 
		  OR T1.AUTHORITY_ID = '5')
	ORDER BY userIdNum ASC , 
		 authorityId ASC,
		 startTimeNm ASC 
	</select>
	<!-- 其他权限分配信息总数 --> 
	<select id="getTotalCountOther" resultClass="Long"> 
		SELECT
			COUNT(USER_ID) AS CNT
		FROM TT_QUANXIAN  
		WHERE (AUTHORITY_ID = '4' 
			  OR AUTHORITY_ID = '5')
	</select>
	<!-- 添加维护权限分配信息 --> 
	<insert id="insertAuthority" parameterClass="g010021aInfo">
		INSERT INTO TT_QUANXIAN 
		   (
		    USER_ID,
			AUTHORITY_ID,
			CATEGORY1_ID,
			CATEGORY2_ID,
			CATEGORY3_ID,
			CREATE_USER_ID,
			CREATE_TIME,
			UPDATE_USER_ID,
			UPDATE_TIME ,
			START_TIME
			<isNotEmpty property="endTimeNm">
			,END_TIME
			</isNotEmpty>
		   )
		VALUES
		   (
			#userIdNum#, 
			#authorityId#,
			#sltCategory1#,
			#sltCategory2#,
			#sltCategory3#,
			#userId#,
			NOW(),
			#userId#,
			NOW(),
			#startTimeNm#
			<isNotEmpty property="endTimeNm">
			,#endTimeNm#
			</isNotEmpty>
		   )
	</insert>
	<!-- 用于SQL查询公用抽取语句 -->
	<select id="item" resultClass="g010021aInfo">
		SELECT T1.ITEM_VALUE  AS adminPsw, T2.ITEM_VALUE AS adminId
			FROM TT_PEIZHI AS T1,
				 TT_PEIZHI AS T2
			WHERE T1.ITEM_NAME ='ADMIN_PASSWORD'
				  AND T2.ITEM_NAME ='ADMIN_USER_ID'
	</select>
	<!-- 添加其他权限分配信息 --> 
	<insert id="insertOtherAuthority" parameterClass="g010021aInfo">
		INSERT INTO TT_QUANXIAN 
		   (
		    USER_ID,
			AUTHORITY_ID,
			CREATE_USER_ID,
			CREATE_TIME,
			UPDATE_USER_ID,
			UPDATE_TIME,
			START_TIME
			<isNotEmpty property="endTimeNm">
			,END_TIME
			</isNotEmpty>
		   )
		VALUES
		   (
			#userIdNum#, 
			#authorityId#,
			#userId#,
			NOW(),
			#userId#,
			NOW(),
			#startTimeNm# 
			<isNotEmpty property="endTimeNm">
			,#endTimeNm#
			</isNotEmpty>
		   )
	</insert>
	<!-- 更新维护权限分配信息 --> 
	<update id="updateAuthority" parameterClass="g010021aInfo">
		UPDATE TT_QUANXIAN
			SET START_TIME = #startTimeNm#,
				<isNotEmpty property="endTimeNm">
				END_TIME = #endTimeNm#,
				</isNotEmpty>
				UPDATE_TIME = NOW(),
				UPDATE_USER_ID = #userId#
		WHERE USER_ID = #userIdNum#
		  and AUTHORITY_ID=#authorityId#
		  and CATEGORY1_ID=#sltCategory1#
		  and CATEGORY2_ID=#sltCategory2#
		  and CATEGORY3_ID=#sltCategory3#
		  and RELATEDOBJECT_ID=#relatedobjectId#
		  and START_TIME=#startTime#
	</update>
	<!-- 相同权限检索 --> 
	<select id="getSameAuthority" parameterClass="g010021aInfo" resultClass="Long">
		<![CDATA[
		SELECT COUNT(*)
		FROM TT_QUANXIAN
		WHERE  USER_ID = #userIdNum#
			AND AUTHORITY_ID = #authorityId#
			AND CATEGORY1_ID = #sltCategory1#
			AND CATEGORY2_ID = #sltCategory2#
			AND CATEGORY3_ID = #sltCategory3#
			AND (((START_TIME >= #startTimeNm#)AND 
		]]>
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(END_TIME > #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(START_TIME <= #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= '9999-12-31')
				]]>
			</isEmpty>
			))
	</select>
	<!-- 相同其他权限检索 --> 
	<select id="getSameOtherAuthority" parameterClass="g010021aInfo" resultClass="Long">
		<![CDATA[
		SELECT COUNT(*)
		FROM TT_QUANXIAN
		WHERE  USER_ID = #userIdNum#
			AND AUTHORITY_ID = #authorityId#
			AND ((START_TIME >= #startTimeNm# AND 
			]]> 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(END_TIME > #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(START_TIME <= #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= '9999-12-31')
				]]>
			</isEmpty>
			))
	</select>
	<!-- 更新维护权限分配重复排他信息 --> 
	<select id="getSameUpdateAuthority" parameterClass="g010021aInfo" resultClass="Long">
		<![CDATA[
		SELECT COUNT(*)
		FROM TT_QUANXIAN
		WHERE  USER_ID = #userIdNum#
			AND AUTHORITY_ID = #authorityId#
			AND CATEGORY1_ID = #sltCategory1#
			AND CATEGORY2_ID = #sltCategory2#
			AND CATEGORY3_ID = #sltCategory3#
			AND START_TIME <> #startTime#
			AND (((START_TIME >= #startTimeNm#)AND 
		]]>
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(END_TIME > #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(START_TIME <= #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= '9999-12-31')
				]]>
			</isEmpty>
			))
	</select>
	<!-- 更新维护权限分配重复排他信息 --> 
	<select id="getSameUpdateOtherAuthority" parameterClass="g010021aInfo" resultClass="Long">
		<![CDATA[
		SELECT COUNT(*)
		FROM TT_QUANXIAN
		WHERE  USER_ID = #userIdNum#
			AND AUTHORITY_ID = #authorityId#
			AND START_TIME <> #startTime#
			AND ((START_TIME >= #startTimeNm# AND 
			]]> 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(START_TIME < '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(END_TIME > #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME <= '9999-12-31')
				]]>
			</isEmpty>
			) 
			OR (<![CDATA[(START_TIME <= #startTimeNm#)]]> 
			AND 
			<isNotEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= #endTimeNm#)
				]]>
			</isNotEmpty>
			<isEmpty property="endTimeNm">
				<![CDATA[
				(END_TIME >= '9999-12-31')
				]]>
			</isEmpty>
			))
	</select>
	<!-- 更新其他权限分配信息 --> 
	<update id="updateOtherAuthority" parameterClass="g010021aInfo">
		UPDATE TT_QUANXIAN
			SET START_TIME = #startTimeNm#,
				<isNotEmpty property="endTimeNm">
				END_TIME = #endTimeNm#,
				</isNotEmpty>
				UPDATE_TIME = NOW(),
				UPDATE_USER_ID = #userId#
		WHERE USER_ID = #userIdNum#
		  and AUTHORITY_ID=#authorityId#
		  and START_TIME=#startTime#
	</update>
	<!-- 更新管理员用户名信息 --> 
	<update id="updateName" parameterClass="g010021aInfo">
		UPDATE TT_PEIZHI
			SET ITEM_VALUE = #newAdminId#
		WHERE ITEM_NAME = 'ADMIN_USER_ID'
	</update>
	<!-- 更新管理员密码信息 --> 
	<update id="updatePassword" parameterClass="g010021aInfo">
		UPDATE TT_PEIZHI
			SET ITEM_VALUE = #newAdminPsw#
		WHERE ITEM_NAME = 'ADMIN_PASSWORD'
	</update>
	<!-- 删除维护权限分配信息 -->
	<delete id="deleteAuthority" parameterClass="g010021aInfo">
		DELETE FROM TT_QUANXIAN
		WHERE USER_ID=#userIdNum#
		  and AUTHORITY_ID=#authorityId#
		  and CATEGORY1_ID=#sltCategory1#
		  and CATEGORY2_ID=#sltCategory2#
		  and CATEGORY3_ID=#sltCategory3#
		  and START_TIME=#startTimeNm#;
	</delete>
	<!-- 删除其他权限分配信息 -->
	<delete id="deleteOtherAuthority" parameterClass="g010021aInfo">
		DELETE FROM TT_QUANXIAN
		WHERE USER_ID=#userIdNum#
		  and AUTHORITY_ID=#authorityId#
		  and START_TIME=#startTimeNm#;
	</delete>
	<!-- 删除权限申请一览信息 -->
	<delete id="deleteApplicationAuthority" parameterClass="g010021aInfo">
		DELETE FROM TT_QXSHENQING
		WHERE USER_ID=#userIdNum#
		  and APPLY_TIME=#applyTime#;
	</delete>
	<!-- 排他处理更新登录者 -->
	<select id="getUserId" resultClass="java.lang.String">
		SELECT T1.ITEM_VALUE AS userId
			FROM TT_PEIZHI AS T1
			WHERE T1.ITEM_NAME ='UPDATE_USER_ID'
	</select>
	<!-- 排他处理更新登录时间 -->
	<select id="getLoginTime" resultClass="java.lang.String">
		SELECT T1.ITEM_VALUE  AS loginTime
			FROM TT_PEIZHI AS T1
			WHERE T1.ITEM_NAME ='UPDATE_TIME'
	</select>
</sqlMap>  