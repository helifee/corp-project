<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K060011Dao">
	<typeAlias alias="examineInfo" type="com.yds.tt.testing.bean.ExamineInfo"/>
	<typeAlias alias="k060011UserInfo" type="com.yds.common.bean.UserInfo"/>
	
	<!-- 考试信息取得 --> 
	<select id="getInitInfo" parameterClass="String" resultClass="examineInfo">
		SELECT  t1.EXAMINE_ID          AS examineId,
				t1.EXAMINE_NAME        AS examineName,
				t1.CATEGORY1_ID        AS category1Id,
				t1.CATEGORY2_ID        AS category2Id,
				t1.CATEGORY3_ID        AS category3Id,
				t1.OBJECT_TYPE         AS objectType,
				t1.OBJECT_VALUE        AS objectValue,
				t1.UPDATE_TIME         AS updateTime,
				t2.USER_ID             AS approverUserId,
				(SELECT USER_CNM FROM v_tt_user WHERE USER_ID=t2.USER_ID) AS approverUserName
		  FROM  tt_ks_xinxi     t1,
				tt_quanxian     t2
		 WHERE  t1.EXAMINE_ID          =  #examineId#
		   AND  t2.RELATEDOBJECT_ID    =  t1.EXAMINE_ID
		   AND  t2.AUTHORITY_ID        =  '12'
	</select>
	
	<!-- 考试信息表数据插入处理(新建) -->
	<insert id="insertNewExamineInfo" parameterClass="examineInfo">
		INSERT  INTO  tt_ks_xinxi
		       (EXAMINE_ID,
			    EXAMINE_NAME,
				CATEGORY1_ID,
				CATEGORY2_ID,
				CATEGORY3_ID,
				OBJECT_TYPE ,
				OBJECT_VALUE ,
				EXAMINE_FLG,
				CHECK_ANSWER_FLG,
				AGAIN_EXAMINE_FLG,
				MUST_EXAMINE_FLG,
				CREATE_USER_ID,
				CREATE_TIME,
				UPDATE_USER_ID,
				UPDATE_TIME) 
		VALUES (#examineId#,
				#examineName#,
				#category1Id#,
				#category2Id#,
				#category3Id#,
				#objectType# ,
				<isEqual property="objectType" compareValue="1">
					'',
				</isEqual>
				<isEqual property="objectType" compareValue="2">
					#objectValue# ,		    
				</isEqual>
				<isEqual property="objectType" compareValue="3">
					#objectValue# ,		    
				</isEqual>
				<isEqual property="objectType" compareValue="4">
					'',
				</isEqual>
				#examineFlg#,
				#checkAnswerFlg#,
				#againExamineFlg#,
				#mustExamineFlg#,
				#createUserId#,
				NOW(),
				#updateUserId#,
				NOW())
	</insert>

	<!-- 考试信息表数据更新处理 -->
	<update id="updateExamineInfo" parameterClass="examineInfo">
		UPDATE  tt_ks_xinxi
		   SET  EXAMINE_NAME      =  #examineName#,
				CATEGORY1_ID      =  #category1Id#,
				CATEGORY2_ID      =  #category2Id#,
				CATEGORY3_ID      =  #category3Id#,
				OBJECT_TYPE = #objectType# ,
				<isEqual property="objectType" compareValue="1">
					OBJECT_VALUE = '',
				</isEqual>
				<isEqual property="objectType" compareValue="2">
					OBJECT_VALUE = #objectValue# ,		    
				</isEqual>
				<isEqual property="objectType" compareValue="3">
					OBJECT_VALUE = #objectValue# ,		    
				</isEqual>
				<isEqual property="objectType" compareValue="4">
					OBJECT_VALUE = '',
				</isEqual>
				UPDATE_USER_ID    =  #updateUserId#,
				UPDATE_TIME       =  NOW()
         WHERE  EXAMINE_ID        =  #examineId#
	</update>
	
	<!-- 考试信息表数据插入处理(参照新建) -->
	<insert id="insertReferenceExamineInfo" parameterClass="examineInfo">
		INSERT  INTO  tt_ks_xinxi
		       (EXAMINE_ID,
				EXAMINE_NAME,
				CATEGORY1_ID,
				CATEGORY2_ID,
				CATEGORY3_ID,
				PARENT_EXAMINE_ID,
				EXAMINE_FLG,
				EXAMINE_TIME,
				CHECK_ANSWER_FLG,
				AGAIN_EXAMINE_FLG,
				MUST_EXAMINE_FLG,
				EXAMINE_COMMENT,
				OBJECT_TYPE,
				OBJECT_VALUE,
				APPLY_CONFIRM_FLG,
				RESULTLEVEL_NUM,
				PASSEXAMINE_LEVEL,
				RESULTLEVEL1_ID,
				RESULTLEVEL1_SCORE,
				RESULTLEVEL1_NAME,
				RESULTLEVEL2_ID,
				RESULTLEVEL2_SCORE,
				RESULTLEVEL2_NAME,
				RESULTLEVEL3_ID,
				RESULTLEVEL3_SCORE,
				RESULTLEVEL3_NAME,
				RESULTLEVEL4_ID,
				RESULTLEVEL4_SCORE,
				RESULTLEVEL4_NAME,
				RESULTLEVEL5_ID,
				RESULTLEVEL5_SCORE,
				RESULTLEVEL5_NAME,
				SCORE_VALID_FLG,
				EXAMINE_START_TIME,
				EXAMINE_END_TIME,
				EXAMINE_NOTIFY_DATE,
				EXAMINE_VISIBLE_FLG,
				APPLY_CLOSING_TIME,
				EXAMINE_STATUS,
				MARKMISSION_FLG,
				REFUSE_REASON,
				CREATEPAPER_TIME,
				APPLY_USER_ID,
				APPLY_TIME,
				APPROVER_USER_ID,
				APPROVER_TIME,
				CREATE_USER_ID,
				CREATE_TIME,
				UPDATE_USER_ID,
				UPDATE_TIME,
				TOTAL_SCORE ) 
		SELECT  #examineId#,
				#examineName#,
				#category1Id#,
				#category2Id#,
				#category3Id#,
				PARENT_EXAMINE_ID,
				EXAMINE_FLG,
				EXAMINE_TIME,
				CHECK_ANSWER_FLG,
				AGAIN_EXAMINE_FLG,
				MUST_EXAMINE_FLG,
				EXAMINE_COMMENT,
				#objectType# ,
				<isEqual property="objectType" compareValue="1">
					'',
				</isEqual>
				<isEqual property="objectType" compareValue="2">
					#objectValue# ,		    
				</isEqual>
				<isEqual property="objectType" compareValue="3">
					#objectValue# ,		    
				</isEqual>
				<isEqual property="objectType" compareValue="4">
					'',
				</isEqual>
				APPLY_CONFIRM_FLG,
				RESULTLEVEL_NUM,
				PASSEXAMINE_LEVEL,
				RESULTLEVEL1_ID,
				RESULTLEVEL1_SCORE,
				RESULTLEVEL1_NAME,
				RESULTLEVEL2_ID,
				RESULTLEVEL2_SCORE,
				RESULTLEVEL2_NAME,
				RESULTLEVEL3_ID,
				RESULTLEVEL3_SCORE,
				RESULTLEVEL3_NAME,
				RESULTLEVEL4_ID,
				RESULTLEVEL4_SCORE,
				RESULTLEVEL4_NAME,
				RESULTLEVEL5_ID,
				RESULTLEVEL5_SCORE,
				RESULTLEVEL5_NAME,
				SCORE_VALID_FLG,
				EXAMINE_START_TIME,
				EXAMINE_END_TIME,
				EXAMINE_NOTIFY_DATE,
				EXAMINE_VISIBLE_FLG,
				APPLY_CLOSING_TIME,
				#examineStatus#,
				MARKMISSION_FLG,
				REFUSE_REASON,
				CREATEPAPER_TIME,
				APPLY_USER_ID,
				APPLY_TIME,
				APPROVER_USER_ID,
				APPROVER_TIME,
				#createUserId#,
				NOW(),
				#updateUserId#,
				NOW(),
				TOTAL_SCORE
	      FROM  tt_ks_xinxi
		 WHERE  EXAMINE_ID  =  #referenceExamineId# 
	</insert>
	
	<!-- 考试试卷关联表数据插入处理 -->
	<insert id="insertExaminePaperRelation" parameterClass="examineInfo">
		INSERT  INTO  tt_ks_shijuang 
		       (EXAMINE_ID,
			    PAPER_ID)				
		SELECT  #examineId#,
				PAPER_ID
		  FROM  tt_ks_shijuang
		 WHERE  EXAMINE_ID  =  #referenceExamineId#
	</insert>
	
	<!-- 需要通过考试关联表数据插入处理 -->
	<insert id="insertNecessaryExamine" parameterClass="examineInfo">
		INSERT  INTO  tt_xuyaokaoshi 
		       (EXAMINE_ID,
			    NECESSARY_EXAMINE_ID)				
		SELECT  #examineId#,
				NECESSARY_EXAMINE_ID
		  FROM  tt_xuyaokaoshi
		 WHERE  EXAMINE_ID  =  #referenceExamineId#
	</insert>
	
	<!-- 需要学习课程关联表数据插入处理 -->
	<insert id="insertNecessaryCourse" parameterClass="examineInfo">
		INSERT  INTO  tt_xuyaokecheng 
		       (EXAMINE_ID,
			    NECESSARY_COURSE_ID)				
		SELECT  #examineId#,
				NECESSARY_COURSE_ID
		  FROM  tt_xuyaokecheng
		 WHERE  EXAMINE_ID  =  #referenceExamineId#
	</insert>
	
	<!-- 考试针对对象人员检索 --> 
	<select id="getUserList" parameterClass="String" resultClass="k060011UserInfo">
		SELECT 	t1.EXAMINE_OBJECT_ID AS userId, 
				(SELECT USER_CNM FROM V_TT_USER WHERE USER_ID = t1.EXAMINE_OBJECT_ID)AS userName			
			FROM 
				tt_ks_duixiang t1
		WHERE   t1.EXAMINE_ID = #examineId#;
	</select>
	
	<!-- 删除针对对象人员 --> 
	<delete id="deleteUserList" parameterClass="String">
		DELETE FROM tt_ks_duixiang
		 WHERE EXAMINE_ID=#examineId#;
	</delete>

	<!-- 添加针对对象人员 --> 
	<insert id="insertUserList" parameterClass="java.util.Map">
		INSERT INTO tt_ks_duixiang
		   (
		    EXAMINE_ID, 
			EXAMINE_OBJECT_ID,
			ATTENTION_FLAG
		   )
		VALUES
		   (
		    #examineId#, 
			#employeesId#,
			#attentionFlag#
		   );
	</insert>
	
	<!-- 排他用最新时间取得 --> 
	<select id="getUpdateTime" parameterClass="String" resultClass="java.util.Date"> 
		SELECT 
			UPDATE_TIME AS updateTime
		FROM 
			tt_ks_xinxi
		WHERE
			EXAMINE_ID = #examineId# 
		FOR UPDATE
	</select>
</sqlMap>  
