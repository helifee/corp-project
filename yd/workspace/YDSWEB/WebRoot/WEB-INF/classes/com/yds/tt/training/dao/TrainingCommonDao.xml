<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="TrainingCommonDao">
	<typeAlias alias="editQuestionAttachments" type="com.yds.tt.testing.bean.QuestionAttachments"/>
	<typeAlias alias="editBookAttachments" type="com.yds.tt.training.bean.BookAttachments"/>
	<typeAlias alias="manaUserInfo" type="com.yds.common.bean.UserInfo"/>
	<typeAlias alias="courseAttentionInfo" type="com.yds.tt.training.bean.CourseAttentionInfo"/>
	
	<!-- 教材状态取得 --> 
	<select id="getBookInfo" parameterClass="com.yds.tt.training.bean.BookInfo" resultClass="Integer"> 
		SELECT	BOOK_STATUS 
	 
		FROM 	tt_jiaocai 

		WHERE	BOOK_ID = #bookId#
		AND		EDIT_NO = #editNo#
	</select>
	
	<!-- 教材资料取得 --> 
	<select id="getBookAttachmentsList" parameterClass="editBookAttachments" resultClass="editBookAttachments"> 
		SELECT	T1.DATA_ID AS dataId,
				T1.DATA_NAME AS dataName,
				T1.REMARK AS remark,
				T1.SIZE AS size,
				<!-- 员工姓名 -->
				(SELECT  USER_CNM
			    FROM v_tt_user
			    WHERE USER_ID = T1.CREATE_USER_ID) AS createUserName,
				T1.CREATE_TIME AS createTime
	 
		FROM 	tt_jiaocai_ziliao T1

		WHERE	T1.BOOK_ID = #bookId#
		AND	    T1.TYPE = #type#
		AND	    T1.DELETE_FLAG = 1
	</select>
	
	<!-- 题库资料取得 --> 
	<select id="getQuestionAttachmentsList" parameterClass="editQuestionAttachments" resultClass="editQuestionAttachments"> 
		SELECT	T1.FILE_ID AS fileId,
				T1.FILE_NAME AS fileName,
				T1.COMMENT AS comment,
				T1.FILE_SIZE AS fileSize,
				<!-- 员工姓名 -->
				(SELECT  USER_CNM
			    FROM v_tt_user
			    WHERE USER_ID = T1.CREATE_USER_ID) AS createUserName,
				T1.CREATE_TIME AS createTime
	 
		FROM 	tt_tk_ziliao T1

		WHERE	T1.QUESTION_ID = #questionId#
		AND	    T1.FILE_TYPE =#fileType#
	</select>
	
	<!-- 插入教材资料表 -->
	<insert id="insertBookAttachments" parameterClass="editBookAttachments">
		INSERT INTO tt_jiaocai_ziliao
		   (BOOK_ID, 
			DATA_ID, 
			DATA_NAME, 
			REMARK, 
			SIZE, 
			TYPE, 
			CREATE_USER_ID, 
			CREATE_TIME, 
			DELETE_FLAG
		   ) 
		VALUES
		   (#bookId#, 
			#dataId#,
			#dataName#, 
			#remark#, 
			#size#, 
			#type#,
			#createUserId#, 
			NOW(), 
			#deleteFlag#			
		   );
	</insert>
	
	<!-- 插入题库资料表 -->
	<insert id="insertQuestionAttachments" parameterClass="editQuestionAttachments">
		INSERT INTO tt_tk_ziliao
		   (QUESTION_ID, 
			FILE_ID, 
			FILE_NAME, 
			COMMENT, 
			FILE_TYPE, 
			FILE_SIZE, 
			CREATE_USER_ID, 
			CREATE_TIME
		   ) 
		VALUES
		   (#questionId#, 
			#fileId#,
			#fileName#, 
			#comment#, 			 
			#fileType#,
			#fileSize#,
			#createUserId#, 
			NOW()			
		   );
	</insert>
			
	<!-- 更新教材资料表 -->
	<update id="updateBookAttachments" parameterClass="editBookAttachments">
		UPDATE 	tt_jiaocai_ziliao 

		SET 	DELETE_FLAG = 2

		WHERE 	BOOK_ID = #bookId# 
		AND     DATA_ID = #dataId#;
	</update>
		
	<!-- 删除题库资料表 -->
	<delete id="deleteQuestionAttachments" parameterClass="editQuestionAttachments">
		DELETE  FROM   tt_tk_ziliao 

		WHERE 	QUESTION_ID = #questionId# 
		AND     FILE_ID = #fileId#;
	</delete>
	
	<!-- 课程针对对象人员检索 --> 
	<select id="getUserList" parameterClass="String" resultClass="manaUserInfo">
		SELECT 	t1.EMPLOYEES_ID AS userId, 
				(SELECT t2.USER_CNM FROM v_tt_user t2 WHERE t2.USER_ID = t1.EMPLOYEES_ID)AS userName			
			FROM 
				tt_kecheng_yuangong t1
		WHERE   t1.COURSE_ID = #courseId#;
	</select>
	
	<!-- 删除针对对象人员 --> 
	<delete id="deleteUserList" parameterClass="String">
		DELETE FROM tt_kecheng_yuangong
		 WHERE COURSE_ID=#courseId# ;
	</delete>

	<!-- 添加针对对象人员 --> 
	<insert id="insertUserList" parameterClass="courseAttentionInfo">
		INSERT INTO tt_kecheng_yuangong 
		   (
		    COURSE_ID, 
			EMPLOYEES_ID,
			ATTENTION_FLAG
		   )
		VALUES
		   (
		    #courseId#, 
			#employeesId#,
			#attentionFlag#
		   );
	</insert>
	
	<!-- 查看权限 -->	
	<select id="getViewPermission" parameterClass="courseAttentionInfo" resultClass="Long">
		<![CDATA[
			SELECT 
			(SELECT 
			  COUNT(*) AS COUNT1
			FROM
			  TT_KECHENG
			WHERE
			  COURSE_ID = #courseId# AND
			  OBJECT_TYPE = 1 )
			+		   	   
			(SELECT 
			  COUNT(*) AS COUNT1
			FROM
			  TT_KECHENG T1,V_EMP_ORG_LIST T3
			WHERE
			  T1.COURSE_ID = #courseId# AND
			  T1.OBJECT_TYPE = 2 AND
			  T1.OBJECT_VALUE = T3.ORG_ID AND
			  T3.EMP_ID = #employeesId#)
			+
			(SELECT 
			  COUNT(*) AS COUNT1
			FROM
			  TT_KECHENG T1,V_TT_USER T2
			WHERE
			  T1.COURSE_ID = #courseId# AND
			  T1.OBJECT_TYPE = 3 AND
			  ADDDATE(T2.START_DATE,INTERVAL TRIM(T1.OBJECT_VALUE) YEAR)>= NOW() AND
			  T2.USER_ID = #employeesId#)
			+		   
			(SELECT 
			  COUNT(*) AS COUNT1
			FROM
			  TT_KECHENG T1,TT_KECHENG_YUANGONG T4
			WHERE
			  T1.COURSE_ID = #courseId# AND
			  T1.OBJECT_TYPE = 4  AND
			  T1.COURSE_ID = T4.COURSE_ID AND
			  T4.EMPLOYEES_ID = #employeesId#) AS COUNTCENT		
		]]>
	</select>	
	<!-- 根据教材ID取课程ID --> 
	<select id="getCourseIdByBookId" parameterClass="String" resultClass="String"> 
		SELECT	COURSE_ID AS courseId
		FROM 	tt_kecheng_jiaocai 
		WHERE	BOOK_ID = #bookId#
	</select>
	<!-- 教材书签表章节编号取得 -->
	<select id="getChapterNo" parameterClass="bookMark" resultClass="Object">
		SELECT 
		  T1.CHAPTER_NO AS chapterNo
		FROM 
		  TT_SHUQIAN T1,TT_JIAOCAI_NEIRONG T2
		WHERE
		  T1.BOOK_ID = #bookId# AND
		  T1.CHAPTER_NO = T2.CHAPTER_NO AND
		  T1.BOOK_ID = T2.BOOK_ID AND
		  T2.EDIT_NO = #editNo# AND
		  T1.EMPLOYEES_ID = #employeesId#
	</select>
	
	<!-- 教材内容表章节编号取得 -->
	<select id="getBookChapterNo" parameterClass="bookMark" resultClass="Object">
		SELECT 
		  T1.CHAPTER_NO AS chapterNo
		FROM 
		  TT_JIAOCAI_NEIRONG T1
		WHERE
		  T1.BOOK_ID = #bookId# AND
		  T1.EDIT_NO = #editNo# AND
		  T1.SHOW_ORDER = 1
	</select>
</sqlMap>
