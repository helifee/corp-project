<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="J020021Dao">
	<typeAlias alias="courseInfo" type="com.yds.tt.training.bean.CourseInfo"/>
	<typeAlias alias="j020021SearchInfo" type="com.yds.tt.training.bean.J020021SearchInfo"/>

	<!-- 可编辑课程信息共通抽出项目 --> 
	<sql id="getCourseEditableInfoListSelectCom">
		SELECT 	T1.COURSE_ID AS courseId, 
				T1.COURSE_NAME AS courseName,
				<!-- 分类名称：一级分类名-二级分类名-三级分类名 --> 
				CONCAT
				(CASE t1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM tt_fenlei
						  WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
								CATEGORY_LEVEL = 1)
				END,
				CASE t1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM tt_fenlei
							   WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
									 CATEGORY2_ID = t1.CATEGORY2_ID AND
									 CATEGORY_LEVEL = 2))
				END ,
				CASE t1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM tt_fenlei 
							   WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
									 CATEGORY2_ID = t1.CATEGORY2_ID AND
									 CATEGORY3_ID = t1.CATEGORY3_ID AND
									 CATEGORY_LEVEL = 3))
				END) AS categoryName,
				T1.COURSE_PUBLISH_STATUS AS coursePublishStatus,
				(SELECT USER_CNM 
				   FROM v_tt_user 
                  WHERE v_tt_user.USER_ID = T1.UPDATE_USER_ID
                ) AS updateUserName,
				T1.UPDATE_TIME AS updateTime,
				<!-- 画面风格统一需要，追加取得项目 2010/08/17 sundefu add-->
				(SELECT USER_CNM 
				   FROM v_tt_user 
                  WHERE v_tt_user.USER_ID = T1.CREATE_USER_ID
                ) AS createUserName,
				T1.COURSE_CONFIRM_STATUS as courseConfirmStatus
	</sql>
	<!-- 可编辑课程信息共通检索条件 -->
	<sql id="getCourseEditableInfoListWhereCom">
		<isNotEmpty prepend="AND" property="courseId">
		 COURSE_ID like CONCAT(#courseId#,'%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="courseName">
		 COURSE_NAME like CONCAT('%',#courseName#,'%')
		</isNotEmpty>
		<!-- 画面风格统一需要，删除取得条件 2010/08/17 sundefu comment
		<isNotEmpty prepend="AND" property="updateTimeFrom">
		  <![CDATA[ DATE_FORMAT(T1.UPDATE_TIME,'%Y-%m-%d') >= #updateTimeFrom# ]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="updateTimeTo">
		 <![CDATA[ DATE_FORMAT(T1.UPDATE_TIME,'%Y-%m-%d') <= #updateTimeTo# ]]>
		</isNotEmpty>
		-->
	</sql>
	<!-- 可管理的课程检索 -->
	<sql id="getCourseEditableInfoList1">
		<include refid="getCourseEditableInfoListSelectCom"/>
		,1 AS opFlag
		FROM
			tt_kecheng T1
		<dynamic prepend="WHERE">
			<!-- 课程管理员能操作的教材分类列表 -->
			<isNotEmpty prepend="AND" open="(" close=")" property="categoryInfos">
				<iterate conjunction="or" property="categoryInfos" >
					<isNotEqual property="categoryInfos[].category1Id" compareValue="0">
						(
						T1.CATEGORY1_ID = #categoryInfos[].category1Id#
						<isNotEqual prepend="AND" property="categoryInfos[].category2Id" compareValue="0">
							T1.CATEGORY2_ID = #categoryInfos[].category2Id#
						</isNotEqual>
						<isNotEqual prepend="AND" property="categoryInfos[].category3Id" compareValue="0">
							T1.CATEGORY3_ID = #categoryInfos[].category3Id#
						</isNotEqual>
						)
					</isNotEqual>
				</iterate>
			</isNotEmpty>
			<include refid="getCourseEditableInfoListWhereCom"/>
		</dynamic>
	</sql>
	<!-- 可编辑的课程检索 -->
	<sql id="getCourseEditableInfoList2">
		<include refid="getCourseEditableInfoListSelectCom"/>
		,2 AS opFlag
		FROM 
			tt_kecheng T1,tt_quanxian T2
		WHERE
			T2.USER_ID = #userId#
			AND T2.RELATEDOBJECT_ID = T1.COURSE_ID
			AND T2.AUTHORITY_ID = '6'
			AND <![CDATA[ T2.START_TIME <= now() ]]>
			AND <![CDATA[ T2.END_TIME >= now() ]]>
			<isNotEmpty property="category1Id">
				<isNotEqual prepend="AND" property="category1Id" compareValue="0">
					T1.CATEGORY1_ID = #category1Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty property="category2Id">
				<isNotEqual prepend="AND" property="category2Id" compareValue="0">
					T1.CATEGORY2_ID = #category2Id#
				</isNotEqual>
			</isNotEmpty>
			<isNotEmpty property="category3Id">
				<isNotEqual prepend="AND" property="category3Id" compareValue="0">
					T1.CATEGORY3_ID = #category3Id#
				</isNotEqual>
			</isNotEmpty>
			<include refid="getCourseEditableInfoListWhereCom"/>
	</sql>
	
	<!-- 可审批课程信息一览取得 -->
	<sql id="getCourseConfirmableInfoList">
		SELECT 	T1.COURSE_ID AS courseId, 
				T1.COURSE_NAME AS courseName,
				<!-- 分类名称：一级分类名-二级分类名-三级分类名 --> 
				CONCAT
				(CASE t1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM tt_fenlei
						  WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
								CATEGORY_LEVEL = 1)
				END,
				CASE t1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM tt_fenlei
							   WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
									 CATEGORY2_ID = t1.CATEGORY2_ID AND
									 CATEGORY_LEVEL = 2))
				END ,
				CASE t1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM tt_fenlei 
							   WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
									 CATEGORY2_ID = t1.CATEGORY2_ID AND
									 CATEGORY3_ID = t1.CATEGORY3_ID AND
									 CATEGORY_LEVEL = 3))
				END) AS categoryName,
				T1.COURSE_CONFIRM_STATUS as courseConfirmStatus,
				<!--画面风格统一需要，删除取得项目 2010/08/17 sundefu comment
				(SELECT USER_CNM 
				   FROM v_tt_user
                  WHERE v_tt_user.USER_ID = T1.APPLY_USER_ID
                ) AS applyUserName,
				APPLY_TIME AS applyTime
				-->
				<!-- 画面风格统一需要，追加取得项目 2010/08/17 sundefu add-->
				(SELECT USER_CNM 
				   FROM v_tt_user 
                  WHERE v_tt_user.USER_ID = T1.UPDATE_USER_ID
                ) AS updateUserName,
				T1.UPDATE_TIME AS updateTime,
				(SELECT USER_CNM 
				   FROM v_tt_user 
                  WHERE v_tt_user.USER_ID = T1.CREATE_USER_ID
                ) AS createUserName,
				T1.COURSE_PUBLISH_STATUS AS coursePublishStatus,
				4 AS opFlag
		FROM 
				tt_kecheng T1,tt_quanxian T2
		WHERE   
				T2.USER_ID = #userId#
	            AND T2.RELATEDOBJECT_ID = T1.COURSE_ID
	            AND T2.AUTHORITY_ID = '10'
				<!-- 画面风格统一需要，删除取得条件 2010/08/17 sundefu comment
				AND <![CDATA[ T2.START_TIME <= now() ]]>
				AND <![CDATA[ T2.END_TIME >= now() ]]>
				-->
				<isNotEmpty property="category1Id">
					<isNotEqual prepend="AND" property="category1Id" compareValue="0">
						T1.CATEGORY1_ID = #category1Id#
					</isNotEqual>
				</isNotEmpty>
				<isNotEmpty property="category2Id">
					<isNotEqual prepend="AND" property="category2Id" compareValue="0">
						T1.CATEGORY2_ID = #category2Id#
					</isNotEqual>
				</isNotEmpty>
				<isNotEmpty property="category3Id">
					<isNotEqual prepend="AND" property="category3Id" compareValue="0">
						T1.CATEGORY3_ID = #category3Id#
					</isNotEqual>
				</isNotEmpty>
				<isNotEmpty property="courseId">
	             AND T1.COURSE_ID like CONCAT(#courseId#,'%')
				</isNotEmpty>
				<isNotEmpty property="courseName">
	             AND T1.COURSE_NAME like CONCAT('%',#courseName#,'%')
				</isNotEmpty>
				<isNotEmpty property="courseConfirmStatus">
	             AND T1.COURSE_CONFIRM_STATUS = #courseConfirmStatus#
				</isNotEmpty>
	</sql>
	
	<!-- 取得课程一览信息总件数-->
	<select id="selectCountCourseInfo" parameterClass="j020021SearchInfo" resultClass="Long">
		SELECT COUNT(DISTINCT courseId)
			FROM 
			(
			<isNotEqual property="courseManager" compareValue="false">
				<include refid="getCourseEditableInfoList1"/>
				UNION ALL
			</isNotEqual>
				<include refid="getCourseEditableInfoList2"/>
				UNION ALL
				<include refid="getCourseConfirmableInfoList"/>
			)AS TT
	</select>
	<!-- 可编辑课程信息一览取得 --> 
	<select id="getCourseEditableInfoList" parameterClass="j020021SearchInfo" resultClass="courseInfo"> 
		SELECT 	courseId, 
				courseName,
				categoryName,
				coursePublishStatus,
				(SELECT DIFF_NAME
				   FROM COM_CODE_MST
			      WHERE TYPE_ID = 'R05'
                    AND DIFF_NO = TT.coursePublishStatus
			    ) AS coursePublishStatusNm,
				updateUserName,
				updateTime,
				SUM(opFlag) as opFlag,
				createUserName,
				courseConfirmStatus,
				(SELECT DIFF_NAME
				   FROM COM_CODE_MST
			      WHERE TYPE_ID = 'R06'
                    AND DIFF_NO = TT.courseConfirmStatus
			    ) AS courseConfirmStatusNm
		FROM 
				(
				<isNotEqual property="courseManager" compareValue="false">
					<include refid="getCourseEditableInfoList1"/>
					UNION ALL
				</isNotEqual>
					<include refid="getCourseEditableInfoList2"/>
					UNION ALL
					<include refid="getCourseConfirmableInfoList"/>
				)AS TT 
		GROUP BY courseId
	</select>
	
	<!-- 参与课程信息一览取得 -->
	<select id="getCoursePaticipateInfoList" parameterClass="j020021SearchInfo" resultClass="courseInfo"> 
		SELECT 	DISTINCT(T1.COURSE_ID) AS courseId, 
				T1.COURSE_NAME AS courseName,
				<!-- 分类名称：一级分类名-二级分类名-三级分类名 --> 
				CONCAT
				(CASE t1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM tt_fenlei
						  WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
								CATEGORY_LEVEL = 1)
				END,
				CASE t1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM tt_fenlei
							   WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
									 CATEGORY2_ID = t1.CATEGORY2_ID AND
									 CATEGORY_LEVEL = 2))
				END ,
				CASE t1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM tt_fenlei 
							   WHERE CATEGORY1_ID = t1.CATEGORY1_ID AND 
									 CATEGORY2_ID = t1.CATEGORY2_ID AND
									 CATEGORY3_ID = t1.CATEGORY3_ID AND
									 CATEGORY_LEVEL = 3))
				END) AS categoryName,
				T6.editorsName
		FROM 
				tt_quanxian T2,
				<isNotEmpty property="editorId">
					tt_quanxian T3,
				</isNotEmpty>
				tt_jiaocai T4,tt_kecheng_jiaocai T5,
				tt_kecheng T1 left join
				(SELECT 
					tt_kecheng.COURSE_ID,
					GROUP_CONCAT(USER_CNM ORDER BY v_tt_user.USER_ID) AS editorsName
				FROM 
					tt_quanxian ,v_tt_user,tt_kecheng
				WHERE
					v_tt_user.USER_ID = tt_quanxian.USER_ID
					AND RELATEDOBJECT_ID =tt_kecheng.COURSE_ID
					AND AUTHORITY_ID = '6'
				GROUP BY tt_kecheng.COURSE_ID) AS T6 
				on T6.COURSE_ID = T1.COURSE_ID
		WHERE   
				T2.USER_ID = #userId#
				AND T2.RELATEDOBJECT_ID = T4.BOOK_ID
	            AND T2.AUTHORITY_ID = '7'
				AND <![CDATA[ T2.START_TIME <= NOW() ]]>
				AND <![CDATA[ T2.END_TIME >= NOW() ]]> 
	            AND T4.BELONG_COURSE_ID = t1.COURSE_ID
	            AND T4.BOOK_ID = T5.BOOK_ID
	            AND T1.COURSE_ID = T5.COURSE_ID	            
				<isNotEmpty property="category1Id">
					<isNotEqual prepend="AND" property="category1Id" compareValue="0">
						T1.CATEGORY1_ID = #category1Id#
					</isNotEqual>
				</isNotEmpty>
				<isNotEmpty property="category2Id">
					<isNotEqual prepend="AND" property="category2Id" compareValue="0">
						T1.CATEGORY2_ID = #category2Id#
					</isNotEqual>
				</isNotEmpty>
				<isNotEmpty property="category3Id">
					<isNotEqual prepend="AND" property="category3Id" compareValue="0">
						T1.CATEGORY3_ID = #category3Id#
					</isNotEqual>
				</isNotEmpty>
				<isNotEmpty property="courseId">
					AND T1.COURSE_ID like CONCAT(#courseId#,'%')
				</isNotEmpty>
				<isNotEmpty property="courseName">
					AND T1.COURSE_NAME like CONCAT('%',#courseName#,'%')
				</isNotEmpty>
				<isNotEmpty property="editorId">
					AND T3.USER_ID = CONCAT('YD',#editorId#)
					AND T3.RELATEDOBJECT_ID = T1.COURSE_ID
					AND T3.AUTHORITY_ID = '6'				
				</isNotEmpty>
		GROUP BY T4.BOOK_ID
	</select>
</sqlMap>
