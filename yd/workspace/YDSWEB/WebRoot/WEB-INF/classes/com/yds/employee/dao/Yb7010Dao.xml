<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Yb7010Dao">
    <typeAlias alias="yb7010CondA" type="com.yds.employee.bean.Yb7010CondA"/>
    <typeAlias alias="empStaffOrgRelation" type="com.yds.employee.bean.EmpStaffOrgRelation"/>	
	<typeAlias alias="empOrgInfoEmp" type="com.yds.common.bean.EmpOrgInfo"/>
	<typeAlias alias="empGrpHis" type="com.yds.employee.bean.EmpGrpHis"/>
	<typeAlias alias="empInfo" type="com.yds.common.bean.EmpInfo"/>
	
	
	<!-- 员工-组织信息的删除 -->
	<delete id="deleteStaffOrgRelation">
		DELETE	FROM	
			EMP_STAFF_ORG_RELATION	
		WHERE ORG_ID IN (	
            SELECT  ORG_ID	FROM
				EMP_ORG_INFO	
            WHERE	ORG_STATE_FLG = '1'	
                    ORDER BY ORG_ID	
        );	
	</delete>
	
	<!-- 指定员工-组织信息的删除(empId) -->
	<delete id="deleteStaffOrgByID" parameterClass="String">
		DELETE	FROM	
			EMP_STAFF_ORG_RELATION	
		WHERE  EMP_ID = #empId#
	</delete>
	
	<!-- 指定员工-组织信息的删除(empId orgId) -->
	<delete id="deleteStaffOrgByKey" parameterClass="yb7010CondA">
		DELETE	FROM	
			EMP_STAFF_ORG_RELATION	
		WHERE  EMP_ID = #empId# 
		AND    ORG_ID = #orgId#
	</delete>	
	
	<!-- 退出员工-组织信息的删除 -->
	<delete id="deleteQuitStaffOrgRelation" parameterClass="String">
		DELETE	FROM	
			EMP_STAFF_ORG_RELATION	
		WHERE  EMP_ID = #empId#
		AND    ORG_ID IN
				(SELECT 
				M.ORG_ID
				FROM (SELECT	
			A.EMP_ID	        AS   EMP_ID
			,A.ORG_ID	        AS   ORG_ID
			,B.ORG_STATE_FLG	AS   ORG_STATE_FLG
			,C.CHARGE_ORG_ID	AS   CHARGE_ORG_ID
			,C.QUIT_DATE	    AS   QUIT_DATE
		FROM	
			EMP_STAFF_ORG_RELATION A	
				LEFT JOIN EMP_INFO C	
					ON (A.EMP_ID = C.EMP_ID)	
				LEFT JOIN (	
					SELECT	
							*	
						FROM	
							EMP_ORG_INFO	
						WHERE	
							ORG_END_DATE = '9999-12-31'	
				) AS B	
					ON (A.ORG_ID = B.ORG_ID)	
		UNION	
		SELECT	
			EMP_ID	
			,'' AS ORG_ID	
			,'' AS ORG_STATE_FLG	
			,CHARGE_ORG_ID	
			,QUIT_DATE	
		FROM	
			EMP_INFO	
		WHERE	
			EMP_ID NOT IN (	
				SELECT	
						DISTINCT EMP_ID	
					FROM	
						EMP_STAFF_ORG_RELATION	
			)	
		ORDER BY	
			EMP_ID ) AS M
			WHERE M.EMP_ID = #empId#
			AND M.ORG_STATE_FLG = '0')
	</delete>
			
	<!-- 组织信息的删除 -->
	<delete id="deleteEmpOrgInfo">
		DELETE	FROM	
			EMP_ORG_INFO	
		WHERE	
			ORG_STATE_FLG = '1'	
	</delete>

	<!-- 员工历史组织信息的删除(暂时全部删除不考虑静态组织变更问题) -->
	<delete id="deleteEmpGrpHis">
		DELETE FROM emp_grp_his	
	</delete>
	
	<!-- 员工-组织整合信息的获取 -->
	<select id="getEmpOrgInfoList" resultClass="yb7010CondA">		
		SELECT	
			A.EMP_ID	        as   empId
			,A.ORG_ID	        as   orgId
			,B.ORG_STATE_FLG	as   orgStateFlg
			,C.CHARGE_ORG_ID	as   chargeOrgId
			,C.QUIT_DATE	    as   quitDate
		FROM	
			EMP_STAFF_ORG_RELATION A	
				LEFT JOIN EMP_INFO C	
					ON (A.EMP_ID = C.EMP_ID)	
				LEFT JOIN (	
					SELECT	
							*	
						FROM	
							EMP_ORG_INFO	
						WHERE	
							ORG_END_DATE = '9999-12-31'	
				) AS B	
					ON (A.ORG_ID = B.ORG_ID)	
		UNION	
		SELECT	
			EMP_ID	
			,'' AS ORG_ID	
			,'' AS ORG_STATE_FLG	
			,CHARGE_ORG_ID	
			,QUIT_DATE	
		FROM	
			EMP_INFO	
		WHERE	
			EMP_ID NOT IN (	
				SELECT	
						DISTINCT EMP_ID	
					FROM	
						EMP_STAFF_ORG_RELATION	
			)	
		ORDER BY	
			empId;	
	</select>
	
	<!-- 取得全体员工List -->
	<select id="getAllEmpInfoList" resultClass="empInfo">				
		SELECT 
			EMP_ID AS empId, 
			CHARGE_ORG_ID AS chargeOrgId, 
			START_DATE AS startDate,
			QUIT_DATE AS endDate
		FROM emp_info;
	</select>	

	<!-- 取得组织关系表中相同部门的最大阶层(10,20) -->
	<select id="getEmpOrgSameDepMax1" parameterClass="String" resultClass="Integer">				
		<![CDATA[
		SELECT IF ((SELECT COUNT(*)  FROM   EMP_ORG_INFO F 
			WHERE SUBSTRING(F.ORG_LEV,1,10) LIKE  #departStr#) =0,1,
			(SELECT MAX(MID(P.ORG_LEV,11,5))+1 FROM EMP_ORG_INFO P
				WHERE SUBSTRING(P.ORG_LEV,1,10) LIKE  #departStr#))as 'maxLev';					
		]]>
	</select>
	
	<!-- 取得组织关系表中相同部门的最大阶层(20,22,23) -->
	<select id="getEmpOrgSameDepMax2" parameterClass="String" resultClass="Integer">				
		<![CDATA[
		SELECT IF ((SELECT COUNT(*)  FROM   EMP_ORG_INFO F 
			WHERE SUBSTRING(F.ORG_LEV,1,15) LIKE  #departStr#) =0,1,
			(SELECT MAX(MID(P.ORG_LEV,16,5))+1 FROM EMP_ORG_INFO P
				WHERE SUBSTRING(P.ORG_LEV,1,15) LIKE  #departStr#)) as 'maxLev';				
		]]>
	</select>
		
	<!--插入组织表信息 -->
	<insert id="insertEmpOrgInfo" parameterClass="empOrgInfoEmp" >				
		INSERT INTO `EMP_ORG_INFO`(
		`ORG_ID`,
		`ORG_NM`,
		`ORG_SNM`,
		`ORG_ST_DATE`,
		`ORG_END_DATE`,
		`ORG_STATE_FLG`,
		`ORG_PRO_ID`,
		`ORG_LEV`,
		`ORG_VIEW_FLG`,
		`ORG_MNGER`,
		`ORG_DESC`,
		`UPDATE_USER`,
		`UPDATE_TIME`) VALUES ( 
		#orgId#, 
		#orgNm#,
		#orgSnm#,
		#orgStDate#,
		#orgEndDate#,
		#orgStateFlg#,
		#orgProId#,
		#orgLev#,
		#orgViewFlg#,
		#orgMnger#,
		#orgDesc#,														
		#updateUser#,
		#updateTime#					
		   );
	</insert>	
	
	<!-- 取得组织关系表中相同部门的最大阶层 -->
	<insert id="insertEmpStaffOrgRelationInfo" parameterClass="empStaffOrgRelation" >				
		INSERT INTO `EMP_STAFF_ORG_RELATION`(
		`EMP_ID`,
		`ORG_ID`,
		`MAIN_FLG`) VALUES ( 
		#empId#, 
		#orgId#,
		#mainFlg#				
		   );
	</insert>	

	<!-- 插入员工历史组织表数据 -->
	<insert id="insertEmpGrpHis" parameterClass="empGrpHis" >				
		INSERT INTO emp_grp_his (
			EMP_ID, 
			START_TIME, 
			END_TIME, 
			ORG_ID, 
			UPDATE_USER, 
			UPDATE_TIME
		)VALUES(
			#empId#, 
			#startTime#, 
			#endTime#, 
			#orgId#, 
			#updateUser#, 
			#updateTime#
		);
	</insert>	

	<!-- 取得指定员工的历史组织作息 -->
	<select id="getEmpGrpHisBy" parameterClass="String" resultClass="empGrpHis">				
		SELECT 
			EMP_ID AS empId, 
			START_TIME AS startTime, 
			END_TIME AS endTime, 
			ORG_ID AS orgId, 
			UPDATE_USER AS updateUser, 
			UPDATE_TIME AS updateTime 
		FROM emp_grp_his 
		WHERE EMP_ID = #empId#
		ORDER BY START_TIME, END_TIME
	</select>
	
	<!-- 更新员工历史组织表的开始日期 -->
	<update id="deleteEmpGrpHisByKey" parameterClass="empGrpHis">
		DELETE FROM 
			EMP_GRP_HIS
		WHERE
			EMP_ID = #empId# AND
			START_TIME = #startTime# AND 
			ORG_ID = #orgId#
	</update>
				
</sqlMap>  
