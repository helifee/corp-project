<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="yd0020Dao">
	
	<typeAlias alias="account" type="com.yds.gps.bean.GpsAccount"/>
	<typeAlias alias="yd0020CondA" type="com.yds.gps.bean.Yd0020CondA"/>
    <typeAlias alias="gpsExchangeHis" type="com.yds.gps.bean.GpsExchangeHis"/>
	<typeAlias alias="gpsExchangeSum" type="com.yds.gps.bean.GpsExchangeSum"/>
    <!-- 取得公司账户余额 --> 
	<select id="getComRemain" resultClass="String"> 
		SELECT 
		SUM(ACC_SUM) 
		FROM 
		   GPS_ACCOUNT
     </select>
	 
	<!-- 取得个人账户余额 --> 
	<select id="getPesonRemain" parameterClass="String" resultClass="String"> 
		SELECT 
			ACC_SUM 
		FROM 
		   GPS_ACCOUNT
		WHERE
			ACC_ID=#pesAccId#
     </select>
	 
	 <!-- 取得咖啡账户信息 --> 
	 <select id="getCafeAccount" resultClass="account"> 
		SELECT 
		ACC_SUM AS accSum,
		(SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST WHERE
			 DIFF_NO=T1.ACC_ID AND SUB_SYS='GPS' AND TYPE_ID='COMPTYPE')   as accId
		FROM 
		   GPS_ACCOUNT T1
		WHERE
		   ACC_FLAG='1' AND ACC_ID='YS900001'
     </select>
	 
	 <!-- 取得团购账户信息 --> 
	 <select id="getGpsAccount" resultClass="account"> 
		SELECT 
		ACC_SUM AS accSum,
		(SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST WHERE
			 DIFF_NO=T1.ACC_ID AND SUB_SYS='GPS' AND TYPE_ID='COMPTYPE')   as accId
		FROM 
		    GPS_ACCOUNT T1
		WHERE
		    ACC_FLAG='1' AND ACC_ID='YS999999'
     </select>
	 
	 
    <!-- 取得交易履历一览信息 --> 
    <select id="getExchangeHisList" parameterClass="yd0020CondA" resultClass="gpsExchangeHis"> 
        SELECT
			DATE_FORMAT(EX_TIME,'%Y-%m-%d %H:%i') as exTime,
			EX_MONEY  as exMoney,
		    (SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST WHERE
			 DIFF_NO=T1.EX_TYPE AND SUB_SYS='GPS' AND TYPE_ID='EX_TYPE')   as exType,
			ORDER_ID    as orderId,
			EX_REMARKS  as exRemarks,
			IO_FLAG   as ioFlag,
			(SELECT EMP_CNM FROM EMP_INFO WHERE
			T1.ACC_FLAG='2' AND EMP_ID= T1.ACC_ID
			 UNION
			 SELECT ACC_ID FROM GPS_EXCHANGE_HIS T2 WHERE T1.ACC_FLAG='1' AND T2.ACC_ID= T1.ACC_ID)   as accId,
			ACC_FLAG  as accFlag,
			BALANCE    as balance
		FROM
            GPS_EXCHANGE_HIS T1
        WHERE
			ACC_FLAG = #accFlag# 
			<isNotEmpty prepend="AND" property = "ioFlag">	
				IO_FLAG = #ioFlag#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "accId">	
				ACC_ID=#accId# 
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exType">	
				EX_TYPE = #exType#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exStartTime">	
				EX_TIME >= #exStartTime#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exEndTime">
				<![CDATA[	
					  EX_TIME < DATE_ADD(#exEndTime#, INTERVAL 1 DAY)
				]]>
			</isNotEmpty>
			
			ORDER BY EX_TIME DESC ,EXCHANGE_NO DESC
    </select>
	
	
	<!-- 取得分页信息 --> 
	<select id="getTotalCount" parameterClass="yd0020CondA" resultClass="Long"> 
        SELECT
        COUNT(*)
		FROM
            GPS_EXCHANGE_HIS		
        WHERE 
			ACC_FLAG = #accFlag#
			<isNotEmpty prepend="AND" property = "ioFlag">	
				IO_FLAG = #ioFlag#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "accId">	
				ACC_ID=#accId# 
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exType">	
				EX_TYPE = #exType#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exStartTime">	
				EX_TIME >= #exStartTime#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exEndTime">
				<![CDATA[	
					  EX_TIME < DATE_ADD(#exEndTime#, INTERVAL 1 DAY)
				]]>
			</isNotEmpty>
    </select>
	 <!-- 取得收支总计信息 -->
	<select id="getExchangeHisSum" parameterClass="yd0020CondA" resultClass="gpsExchangeSum"> 
        SELECT 
			COUNT(IO_FLAG) AS ioCnt,
			COUNT(IF(IO_FLAG=1,1,NULL)) AS inCnt,
			COUNT(IF(IO_FLAG=2,1,NULL)) AS outCnt,
			COALESCE(SUM(IF(io_flag=1,ex_money,0)),0)AS inMoneySum ,
			COALESCE(SUM(IF(io_flag=2,ex_money,0)),0)AS outMoneySum 
			FROM GPS_EXCHANGE_HIS 
        WHERE 
		    ACC_FLAG = #accFlag#
			<isNotEmpty prepend="AND" property = "exType">	
				EX_TYPE = #exType#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "accId">	
				ACC_ID=#accId#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "ioFlag">	
				IO_FLAG = #ioFlag#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exStartTime">	
				EX_TIME >= #exStartTime#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property = "exEndTime">
				<![CDATA[	
					  EX_TIME < DATE_ADD(#exEndTime#, INTERVAL 1 DAY)
				]]>
			</isNotEmpty>
    </select>

</sqlMap> 