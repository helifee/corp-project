/*
 * @(#)BatchServiceCtrlImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 批处理系统
 */

package com.yds.batch.service.impl;

import java.io.IOException;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.context.support.ClassPathXmlApplicationContext;

import com.yds.batch.dao.BatchGroupDao;
import com.yds.batch.service.BatchConstants;
import com.yds.batch.service.BatchServiceCtrl;

/**
 * @see BatchServiceCtrl
 */
public class BatchServiceCtrlImpl implements BatchServiceCtrl{
	
	private static final Log LOG = LogFactory.getLog(BatchServiceCtrlImpl.class);
	
	private final String batchGroupDaoName = "batchGroupDao";
	
	/** 配置文件名称. */
	private final String[] acArray = {"applicationContext-*.xml", 
			"batchApplicationContext.xml", "quartzApplicationContext.xml"};
	
	/** spring容器. */
	private ClassPathXmlApplicationContext context = null;
	
	/** 批处理服务启动时绑定端口类. */
	private BatchSocketServer batchSocketServer;
	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public void startup(int servicePort) {
		
		batchSocketServer = new BatchSocketServer(this);

		try {
			// 创建socket服务
			batchSocketServer.startServer(servicePort);
		} catch (IOException e) {
			
			LOG.error("批处理服务绑定端口失败，启动终止。", e);		
			return;
		}
		
		// 初始化spring容器
		context = new ClassPathXmlApplicationContext(acArray);
		
		// 修正任务组执行状态
		BatchGroupDao batchGroupDao = (BatchGroupDao)context.getBean(batchGroupDaoName);
		batchGroupDao.modifyStatus();
		
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean shutdown() {
		
		if (context == null) {
			LOG.info("spring容器没有初始化");
			return false;
		}

		context.destroy();
		
		context = null;
		
		batchSocketServer.stopServer();
		
		LOG.info("批处理服务终止。");
		
		return true;
		
	}

	public static void main(String[] args) {

		// 启动服务
		new BatchServiceCtrlImpl().startup(BatchConstants.SERVER_PORT);
	}
}
