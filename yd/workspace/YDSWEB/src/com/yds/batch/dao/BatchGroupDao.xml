<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BatchGroupDao">

	<typeAlias alias="batchGroup" type="com.yds.batch.bean.BatchGroup"/>
	
	<!-- 获取任务组列表 --> 
	<select id="getBatchGroups" resultClass="batchGroup"> 
		SELECT
			GROUP_ID AS groupId,
			GROUP_NAME AS groupName,
			GROUP_COMMONT AS groupCommont,
			EXEC_DATE AS execDate,
			EXEC_TIME AS execTime,
			EXEC_FREQ AS execFreq,
			EXEC_DAY AS execDay,
			EXEC_INTERVAL AS execInterval,
			LAST_EXEC_DT AS lastExecDt,
			EXEC_CNT AS execCnt,
			EXEC_STATUS AS execStatus,
			PLAN_START_DT AS planStartDt,
			PLAN_END_DT AS planEndDt
		FROM BAT_GROUP
		WHERE
			<!-- 等待执行 --> 
			EXEC_STATUS = '3'
			<!-- 有效 --> 
			AND VALID_FLG = '1'
		ORDER BY PRIORITY_LEVEL;
	</select>

	<!-- 更新任务组执行信息 --> 
	<update id="updateExecInfo" parameterClass="batchGroup">
		UPDATE 
			BAT_GROUP 
		SET 
			EXEC_DATE = #execDate#,
			EXEC_TIME = #execTime#,
			EXEC_STATUS = #execStatus#, 
			LAST_EXEC_DT = #lastExecDt#, 
			EXEC_CNT = #execCnt#
		WHERE 
			GROUP_ID = #groupId#;
	</update>

	<!-- 插入任务组执行历史 --> 
	<insert id="insertExecHis" parameterClass="batchGroup">
		INSERT INTO BAT_GROUP_HIS 
			(
			GROUP_ID,
			EXEC_CNT,
			GROUP_NAME,
			GROUP_COMMONT, 
			EXEC_DT,  
			EXEC_STATUS
			)
		VALUES
			(
			#groupId#,
			#execCnt#,
			#groupName#,
			#groupCommont#, 
			#lastExecDt#, 
			#execStatus#
			);
	</insert>
	
	<!-- 在守护线程启动时修正任务组执行状态 --> 
	<update id="modifyStatus">
		UPDATE 
			BAT_GROUP 
		SET 
			<!-- 等待执行 --> 
			EXEC_STATUS = '3'
		WHERE 
			<!-- 执行中 --> 
			EXEC_STATUS = '4';
	</update>

</sqlMap>
