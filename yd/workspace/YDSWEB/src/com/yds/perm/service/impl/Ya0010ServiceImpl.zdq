/*
 * @(#) Ya0010ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 权限管理
 */
package com.yds.perm.service.impl;

import java.util.ArrayList;
import java.util.List;
import org.springframework.stereotype.Service;
import com.yds.base.service.AbstractBaseService;
import com.yds.common.bean.PositionInfo;
import com.yds.common.service.CommonConstants;
import com.yds.common.service.LogService;
import com.yds.common.service.SessionService;
import com.yds.perm.bean.PositionRoleInfo;
import com.yds.perm.bean.RoleInfo;
import com.yds.perm.dao.Ya0010Dao;
import com.yds.perm.service.Ya0010Service;

/**
 * @see com.yds.perm.service.Ya0010Service
 */
@Service("ya0010Service")
public class Ya0010ServiceImpl extends AbstractBaseService implements Ya0010Service {
	
	private Ya0010Dao ya0010Dao;

	/**
	 * @param ya0010Dao the ya0010Dao to set
	 */
	public void setYa0010Dao(Ya0010Dao ya0010Dao) {
		this.ya0010Dao = ya0010Dao;
	}
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<PositionInfo> getPositionInfos() {

		return ya0010Dao.getPositionInfos();
	}
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<RoleInfo> getRoleInfos() {

		return ya0010Dao.getRoleInfos();
	}
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<PositionRoleInfo> getPosRoleInfos() {
		
		return ya0010Dao.getRolePosInfos();
	}
	
	/**
	 *  日志信息 
	 */
	String logMsg = "";
	
	/**
	 *  日志 service
	 */
	private LogService logService;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean savePosRoleMgr(List<ArrayList<Object>> submitList) {
		
		// 待删除的职位角色数组
		List<PositionRoleInfo> posRoleDelete = new ArrayList<PositionRoleInfo>();
		
		// 待插入的职位角色数组
		List<PositionRoleInfo> posRoleInsert = new ArrayList<PositionRoleInfo>();
		
		// 从Session中获取操作人ID
		String operaterID = SessionService.getLoginUserId();
		
		for(int i = 0; i <submitList.size(); i++) {
			
			// 生成临时职位角色bean
			PositionRoleInfo temp = new PositionRoleInfo();
			
			// 设置职位ID
			temp.setPosId((String)submitList.get(i).get(0));
			// 设置角色ID
			temp.setRoleId((String)submitList.get(i).get(1));
			
			// 设置操作人
			temp.setOperator(operaterID);
			
			// 如果职位角色标记为删除（true：插入，false：删除）
			if(!(Boolean)submitList.get(i).get(3)) {
				// 设置更新时间
				temp.setUpdateTime((String)submitList.get(i).get(2));
				// 追加入待删除的职位角色数组
				posRoleDelete.add(temp);
			} else {
				// 追加入待插入的职位角色数组
				posRoleInsert.add(temp);
			}
			
		}
		// 数据校验标志
		boolean checkFlag = true;
		// 校验待删除的记录是否存在
		for(PositionRoleInfo item:posRoleDelete) {
			// 如果不存在
			if(!posRoleInfoExistCheck(item)) {
				checkFlag = false;
				break;
			}
		}
		// 校验待插入的记录是否存在
		for(PositionRoleInfo item:posRoleInsert) {
			// 如果已存在
			if(posRoleInfoExistCheck(item)) {
				checkFlag = false;
				break;
			}
		}
		// 数据正确
		if(checkFlag) {
			// 更新DB,删除记录
			for(PositionRoleInfo item:posRoleDelete) {
				ya0010Dao.deletePositionRole(item);
				// 日志信息的编辑
				logMsg = "ID为" + item.getPosId() + "的职位删除" + "ID为" + item.getRoleId()+ "的角色成功。";
				// 日志的追加  日志级别未定
				logService.insertLogInfo(CommonConstants.LoglevelEnum.Not_Delete.toString(), CommonConstants.SubIdEnum.Sub_PERM.toString(), SessionService.getLoginUserId(), logMsg, "");
			}
			// 更新DB,插入记录
			for (PositionRoleInfo item:posRoleInsert) {
				ya0010Dao.insertPositionRole(item);
				// 日志信息的编辑
				logMsg = "ID为" + item.getPosId() + "的职位授予 "+ "ID为" + item.getRoleId()+"的角色成功。";
				// 日志的追加  日志级别未定
				logService.insertLogInfo(CommonConstants.LoglevelEnum.Not_Delete.toString(), CommonConstants.SubIdEnum.Sub_PERM.toString(), SessionService.getLoginUserId(), logMsg, "");
			}
			
		// 数据错误 
		} else {

			return false;
		}
		// 提交成功，返回
		return true;
	}
	
	/**
	 * 检查职位角色信息是否已存在
	 * @param posRoleInfo
	 * @return true/false
	 */
	private boolean posRoleInfoExistCheck(PositionRoleInfo posRoleInfo) {
		
		PositionRoleInfo temp = ya0010Dao.getRolePosInfo(posRoleInfo);
		if(null==temp) {
			return false;
		} else if (temp.getUpdateTime().equals(posRoleInfo.getUpdateTime())) {
			return true;
		}
		return false;
	}
	
	/**
	 * @param logService
	 *            the logService to set
	 */
	public void setLogService(LogService logService) {
		this.logService = logService;
	}
}
