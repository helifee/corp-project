<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="UserRoleMgrDao">
	<typeAlias alias="PerUserInfo" type="com.yds.common.bean.EmpInfo"/>
	<typeAlias alias="PerRoleInfo" type="com.yds.perm.bean.PerRoleInfo"/>
	<typeAlias alias="perUserPermitInfo" type="com.yds.perm.bean.PerUserPermitInfo"/>
	
	<!-- 用户基本信息表信息 --> 
	<select id="getUserInfoList" parameterClass="PerUserInfo" resultClass="PerUserInfo">	
	    SELECT
          EMP_ID AS empId,     
          EMP_CPNM AS empCpnm,   
          EMP_CNM AS empCnm,    
          EMP_JRNM AS empJrnm,   
          EMP_JKNM AS empJknm,   
          EMP_JNM AS empJnm,    
          EMP_DMNM AS empDmnm,   
          PASSWORD AS password,   
          CHARGE_ORG_ID AS chargeOrgId,     
          EMP_EMAIL_COMP AS empEmailComp, 
          EMP_EMAIL_PUB AS empEmailPub, 
          START_DATE AS startDate,  
          EMP_STATE_ID AS empStateId,  
          EMP_STATUS_ID AS empStatusId  
	   FROM V_EMP_LIST_QUIT  
	   <dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="empCnm">
				EMP_CNM LIKE CONCAT(#empCnm#, '%')				
			</isNotEmpty>	
			
			<isNotEmpty prepend="AND" property="chargeOrgId">
				CHARGE_ORG_ID = #chargeOrgId#				
			</isNotEmpty>	
			
			<isNotEmpty prepend="AND" property="startYear">
				START_DATE LIKE CONCAT(#startYear#,'%')				
			</isNotEmpty>					
		</dynamic>
	  ORDER BY EMP_ID
	</select>	
	
	<!-- 用户角色表信息 --> 
	<select id="getRoleInfoList" parameterClass="PerRoleInfo" resultClass="PerRoleInfo">
		  SELECT
		  ROLE_ID AS roleId,
          ROLE_NM AS roleName,
          ROLE_DESC AS roleDescription,
		  UPDATETIME AS updateTime
        FROM
          PER_ROLE
		<dynamic>
			<isNotEmpty property="roleId">
			WHERE
               ROLE_ID = #roleId#;				
			</isNotEmpty>
		</dynamic>	  	
	</select>
	
	<!-- 用户授权表信息 --> 
	<select id="getPerUserPermitInfoList" parameterClass="perUserPermitInfo" resultClass="perUserPermitInfo">
	    SELECT 
          USER_ID AS userId,
          POS_ROLE_ID AS posRoleId,
          UPDATE_USER AS operatorId,
          PERMIT_STA_DATE AS permitStaDate,
		  PERMIT_END_DATE AS permitEndDate,		  
          UPDATE_TIME AS updateTime
	     FROM PER_USER_PERMIT 
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="userId">
				USER_ID = #userId#				
			</isNotEmpty>	
			
			<isNotEmpty prepend="AND" property="posRoleId">
				POS_ROLE_ID = #posRoleId#				
			</isNotEmpty>
						
		</dynamic>
	</select>
	
	<!-- 添加用户角色授权信息 --> 
	<insert id="insertUserRole" parameterClass="perUserPermitInfo">
		INSERT INTO
        PER_USER_PERMIT (
        	USER_ID ,
        	POS_ROLE_ID ,
        	PERMIT_STA_DATE ,
			PERMIT_END_DATE,			
        	UPDATE_USER ,
			UPDATE_TIME
        ) VALUES (
        	#userId# ,
        	#posRoleId# ,
			#permitStaDate#,
			#permitEndDate#,
        	#operatorId#,
			NOW()
        )
	</insert>	
	
	<!-- 删除用户角色的授权表信息 --> 
	<delete id="deleteUserRole" parameterClass="perUserPermitInfo">
		DELETE FROM PER_USER_PERMIT
		 WHERE USER_ID = #userId#
		   AND POS_ROLE_ID = #posRoleId#         
	</delete>			
	
	<!-- 更新用户角色的授权时间表信息-->
	<update id="updateUserRoleTime" parameterClass="perUserPermitInfo">
		UPDATE PER_USER_PERMIT 
		   SET PERMIT_STA_DATE = #permitStaDate#,
               PERMIT_END_DATE = #permitEndDate#
		 WHERE USER_ID = #userId#
		   AND POS_ROLE_ID = #posRoleId#;		
	</update>				
	
	
</sqlMap>  
