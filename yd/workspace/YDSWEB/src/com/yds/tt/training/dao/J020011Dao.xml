<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="J020011Dao">
	<typeAlias alias="courseInfo" type="com.yds.tt.training.bean.CourseInfo"/>
	<typeAlias alias="authorityInfo" type="com.yds.tt.manager.bean.AuthorityInfo"/>
	
	<!-- 课程信息 --> 
	<select id="getCourseInfo" parameterClass="String" resultClass="courseInfo"> 
		SELECT
			t1.COURSE_ID AS courseId,
			t1.COURSE_NAME AS courseName,
			t1.COURSE_CONFIRM_STATUS AS courseConfirmStatus,
			t1.COURSE_PUBLISH_STATUS AS coursePublishStatus,
			t1.REFUSE_REASON AS refuseReason,
			t1.CATEGORY1_ID AS category1Id,
			t1.CATEGORY2_ID AS category2Id,
			t1.CATEGORY3_ID AS category3Id,
			t1.OBJECT_TYPE AS objectType,
			t1.OBJECT_VALUE AS objectValue,
			t1.NECESSARY_FLAG AS necessaryFlag,
			t1.CREATE_USER_ID AS createUserId,
			t1.CREATE_TIME AS createTime,
			t1.UPDATE_USER_ID AS updateUserId,
			t1.UPDATE_TIME AS  updateTime,
			t2.USER_ID AS appointedApproverUserId,
			(SELECT USER_CNM FROM v_tt_user WHERE USER_ID=t2.USER_ID) AS appointedApproverUserName,
			(SELECT DIFF_NAME FROM com_code_mst WHERE TYPE_ID='R05' AND DIFF_NO=t1.COURSE_PUBLISH_STATUS) AS coursePublishStatusNm,
			(SELECT DIFF_NAME FROM com_code_mst WHERE TYPE_ID='R06' AND DIFF_NO=t1.COURSE_CONFIRM_STATUS) AS courseConfirmStatusNm
		FROM 
			TT_KECHENG	t1 left join TT_QUANXIAN t2 on 	
			T2.RELATEDOBJECT_ID = t1.COURSE_ID AND T2.AUTHORITY_ID ='10'
		WHERE 
			COURSE_ID = #courseId#;			   		   
	</select>
	
	<!-- 添加课程信息 --> 
	<insert id="insertCourse" parameterClass="courseInfo">
		INSERT INTO
        TT_KECHENG (
        	COURSE_ID ,
        	COURSE_NAME ,
        	COURSE_CONFIRM_STATUS ,
        	COURSE_PUBLISH_STATUS ,
        	CATEGORY1_ID ,
        	CATEGORY2_ID ,
        	CATEGORY3_ID ,
        	OBJECT_TYPE ,
        	OBJECT_VALUE ,
        	NECESSARY_FLAG ,
        	CREATE_USER_ID ,
        	CREATE_TIME ,
        	UPDATE_USER_ID ,
        	UPDATE_TIME 
        ) VALUES (
        	#courseId# ,
        	#courseName# ,
        	'1' ,
        	'1' ,
        	#category1Id# ,
        	#category2Id# ,
        	#category3Id# ,
        	#objectType# ,
			<isEqual property="objectType" compareValue="1">
				'',
		    </isEqual>
			<isEqual property="objectType" compareValue="2">
				#objectValue# ,		    
			</isEqual>
			<isEqual property="objectType" compareValue="3">
				#objectValue# ,		    
			</isEqual>
			<isEqual property="objectType" compareValue="4">
				'',
			</isEqual>
			#necessaryFlag# ,
			#createUserId# ,
			NOW(),
			#updateUserId#,
			NOW()
        )
	</insert>
	
	<!-- 更新课程信息 --> 
	<update id="updateCourse" parameterClass="courseInfo">			
        UPDATE TT_KECHENG SET
	        COURSE_NAME = #courseName# ,
	        CATEGORY1_ID = #category1Id# ,
	        CATEGORY2_ID = #category2Id# ,
	        CATEGORY3_ID = #category3Id# ,
	        OBJECT_TYPE = #objectType# ,
			<isEqual property="objectType" compareValue="1">
				OBJECT_VALUE = '',
		    </isEqual>
			<isEqual property="objectType" compareValue="2">
				OBJECT_VALUE = #objectValue# ,		    
			</isEqual>
			<isEqual property="objectType" compareValue="3">
				OBJECT_VALUE = #objectValue# ,		    
			</isEqual>
			<isEqual property="objectType" compareValue="4">
				OBJECT_VALUE = '',
			</isEqual>
	        NECESSARY_FLAG =#necessaryFlag#,
	        UPDATE_USER_ID =#updateUserId# ,
	        UPDATE_TIME = NOW() 
        WHERE 
	        COURSE_ID = #courseId# 				
	</update>

	<!-- 更新教材分类 --> 
	<update id="updateBookCategory" parameterClass="courseInfo">			
        UPDATE tt_jiaocai SET
	        CATEGORY1_ID = #category1Id# ,
	        CATEGORY2_ID = #category2Id# ,
	        CATEGORY3_ID = #category3Id# ,
	        UPDATE_USER_ID =#updateUserId# ,
	        UPDATE_TIME = NOW() 
        WHERE 
	        BELONG_COURSE_ID = #courseId#
	</update>
		
	<!-- 更新课程发布状态 --> 
	<update id="updateCoursePublishStatus" parameterClass="courseInfo">			
        UPDATE TT_KECHENG SET
	        COURSE_PUBLISH_STATUS = #coursePublishStatus# ,
	        UPDATE_USER_ID =#updateUserId# ,
	        UPDATE_TIME = NOW() 
        WHERE 
	        COURSE_ID = #courseId# 				
	</update>
	
	<!-- 排他用最新时间取得 --> 
	<select id="getUpdateTime" parameterClass="courseInfo" resultClass="java.util.Date"> 
		SELECT 
			UPDATE_TIME AS updateTime
		FROM 
			TT_KECHENG
		WHERE
			Course_ID = #courseId# 
		FOR UPDATE
	</select>
</sqlMap>  
