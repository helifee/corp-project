<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="J030031Dao">
	<typeAlias alias="bookInfo" type="com.yds.tt.training.bean.BookInfo"/>
	<typeAlias alias="bookContent" type="com.yds.tt.training.bean.BookContent"/>
	<typeAlias alias="bookContentPara" type="com.yds.tt.training.bean.BookContent"/>

		<!-- 查看状态编辑号取得 --> 
		<select id="getViewEditNo" parameterClass="bookContentPara" resultClass="bookInfo"> 
			SELECT
				MAX(T1.EDIT_NO)  AS editNo
			FROM
				TT_JIAOCAI T1
			WHERE
				BOOK_ID = #bookId#  AND
				BOOK_STATUS = '3'
		</select>
		
		<!-- 最大编辑号取得 --> 
		<select id="getMaxEditNo" parameterClass="bookContentPara" resultClass="bookInfo"> 
			SELECT
				MAX(T1.EDIT_NO)  AS editNo
			FROM
				TT_JIAOCAI T1
			WHERE
				BOOK_ID = #bookId#
		</select>
		
		<!-- 最小编辑号取得 --> 
		<select id="getMinEditNo" parameterClass="bookContentPara" resultClass="bookInfo"> 
			SELECT
				MIN(T1.EDIT_NO)  AS editNo
			FROM
				TT_JIAOCAI T1
			WHERE
				BOOK_ID = #bookId#
		</select>
		
		<!-- 教材信息取得 --> 
		<select id="getBookBaseInfo" parameterClass="bookContentPara" resultClass="bookInfo"> 
			SELECT
				T1.BOOK_ID          AS bookId, 
				(SELECT CATEGORY_NAME
				   FROM tt_fenlei
				  WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
						CATEGORY_LEVEL = 1) AS category1Name,
				(SELECT CATEGORY_NAME
				   FROM tt_fenlei
				  WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
						CATEGORY2_ID = T1.CATEGORY2_ID AND
						CATEGORY_LEVEL = 2) AS category2Name,
				(SELECT CATEGORY_NAME
				   FROM tt_fenlei
				  WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND
						CATEGORY2_ID = T1.CATEGORY2_ID AND
						CATEGORY3_ID = T1.CATEGORY3_ID AND
						CATEGORY_LEVEL = 3) AS category3Name,
				(SELECT DIFF_NAME
				   FROM com_code_mst
				  WHERE TYPE_ID='R01' AND
						DIFF_NO=T1.BOOK_STATUS) AS bookStatusName,
				(SELECT DIFF_NAME
				   FROM com_code_mst
				  WHERE TYPE_ID='R09' AND
						DIFF_NO=T1.QUOTE_FLAG) AS quoteFlagName,
				T1.EDIT_NO          AS editNo,
				T1.BOOK_STATUS      AS bookStatus,
				T1.VERSION_NO       AS versionNo,
				T1.UPDATE_NO        AS updateNo,
				T1.BOOK_NAME        AS bookName,
				T1.BELONG_COURSE_ID AS belongCourseId,
				T1.KEYWORD          AS keyword,
				T1.CREATE_TIME      AS createTime,
				T1.PRE_KNOWLEDGE    AS preKnowledge,
				T1.APPLYTO          AS applyto,
				T1.SOURCE           AS source,
				T1.ABSTRACT         AS bookAbstract,
				T1.MODIFY_HISTORY   AS modifyHistory,
				T1.REFUSE_REASON    AS refuseReason,
				T1.BOOK_COVER       AS bookCover,
				T1.UPDATE_TIME      AS updateTime,
				CASE WHEN T1.BOOK_STATUS = 3 THEN T1.APPROVER_TIME ELSE '' END	AS approverTime,
				CASE WHEN T1.BOOK_STATUS = 3 THEN (SELECT USER_CNM FROM V_TT_USER WHERE USER_ID = T1.APPROVER_USER_ID) ELSE '' END	AS approverUserName
			FROM
				TT_JIAOCAI T1

			WHERE
				T1.BOOK_ID = #bookId#  AND
				T1.EDIT_NO = #editNo#	
		</select>
		
		<!-- 教材内容取得 --> 
		<select id="getMenuList" parameterClass="bookContentPara" resultClass="bookContent"> 
			SELECT
				T1.BOOK_ID        AS  bookId,
				T1.EDIT_NO        AS  editNo,
				T1.CHAPTER_NO     AS  chapterNo,
				T1.CHAPTER_TITLE  AS  chapterTitle,
				T1.SHOW_LEVEL     AS  showLevel,
				T1.SHOW_ORDER     AS  showOrder
				
			FROM
				TT_JIAOCAI_NEIRONG T1
				
			WHERE
				T1.BOOK_ID = #bookId#  AND
				T1.EDIT_NO = #editNo#
				
			ORDER BY
			    SHOW_ORDER     ASC
		</select>

		<!-- 教材编辑者取得 --> 
		<select id="getUpdateUserList" parameterClass="bookContentPara" resultClass="bookInfo"> 
			SELECT 
				T1.USER_ID,
				(SELECT USER_CNM FROM V_TT_USER WHERE USER_ID = T1.USER_ID) AS updateUserName
			FROM
				TT_QUANXIAN  T1
			WHERE
				T1.RELATEDOBJECT_ID = #bookId#  AND
				T1.AUTHORITY_ID = '7'
		</select>

		<!-- 教材发布者取得 --> 
		<select id="getCreateUserList" parameterClass="bookContentPara" resultClass="bookInfo"> 
			SELECT 
				T1.USER_ID,
				(SELECT USER_CNM FROM V_TT_USER WHERE USER_ID = T1.USER_ID) AS createUserName
			FROM
				TT_QUANXIAN  T1
			WHERE
				T1.RELATEDOBJECT_ID = #bookId#  AND
				T1.AUTHORITY_ID = '11'
		</select>

		<!-- 教材被引用数取得 --> 
		<select id="bookUseCheck" parameterClass="String" resultClass="Integer">
			SELECT
				COUNT(*)
			FROM   
				TT_KECHENG_JIAOCAI  T1
			WHERE 
				T1.BOOK_ID = #bookId# 
		</select>
		
		<!-- 书签表内容删除 --> 
		<delete id="deleteBookMark" parameterClass="String"> 
			DELETE FROM
				TT_SHUQIAN
			WHERE
				BOOK_ID = #bookId#
		</delete>
		
		<!-- 教材内容表内容删除 -->
		<delete id="deleteBookContent" parameterClass="String">
			DELETE FROM
				TT_JIAOCAI_NEIRONG
			WHERE
				BOOK_ID = #bookId#
		</delete>

		<!-- 教材资料表内容删除 -->
		<delete id="deleteBookData" parameterClass="String">
			DELETE FROM
				TT_JIAOCAI_ZILIAO
			WHERE
				BOOK_ID = #bookId# AND
				DELETE_FLAG = '2'
		</delete>

		<!-- 课程教材关联表内容删除 -->
		<delete id="deleteCourseAndBook" parameterClass="String">
			DELETE FROM
				TT_KECHENG_JIAOCAI
			WHERE
				BOOK_ID = #bookId#
		</delete>
		
		<!-- 教材表内容删除 -->
		<delete id="deleteBookInfo" parameterClass="String">
			DELETE FROM
				TT_JIAOCAI
			WHERE
				BOOK_ID = #bookId#
		</delete>
		
		<!-- 教材表内容删除 -->
		<delete id="deleteUserRight" parameterClass="String">
			DELETE FROM
				TT_QUANXIAN
			WHERE 
				(AUTHORITY_ID = '11' OR
				AUTHORITY_ID = '7')AND
				RELATEDOBJECT_ID = #bookId#
		</delete>
				
		<!-- 试卷表内容删除 -->
		<delete id="deleteTestPaper" parameterClass="String">
			DELETE FROM
				TT_SHIJUAN
			WHERE
				BELONG_ID = #bookId#
		</delete>
		
		<!-- 更新时间取得 --> 
		<select id="getUpdateTime" parameterClass="String" resultClass="java.util.Date"> 
			SELECT 
				UPDATE_TIME AS updateTime
			FROM
				TT_JIAOCAI
			WHERE
				BOOK_ID = #bookId# AND
				EDIT_NO = (SELECT MAX(T1.EDIT_NO) FROM TT_JIAOCAI T1 WHERE BOOK_ID = #bookId#)
			FOR UPDATE
		</select>
		
		<!-- 教材版本数取得 --> 
		<select id="searchBookEditNum" parameterClass="String" resultClass="Integer"> 
			SELECT
				COUNT(*)
			FROM   
				TT_JIAOCAI          T1
			WHERE 
				T1.BOOK_ID = #bookId#
		</select>

		<!-- 修改教材信息(版本数为1时)--> 
		<update id="updateSingleVersionBook" parameterClass="BookInfo">
			UPDATE
				TT_JIAOCAI
			SET
				BOOK_STATUS = '3',
				APPROVER_USER_ID = #approverUserId#,
				APPROVER_TIME = NOW(),
				UPDATE_USER_ID = #approverUserId#,
				UPDATE_TIME = NOW(),
				REFUSE_REASON = ''
			WHERE
				BOOK_ID = #bookId# 
		</update>
		
		<!-- 删除旧版本教材内容表内容 --> 
		<delete id="deleteOldBookContent" parameterClass="BookInfo"> 
			DELETE FROM
				TT_JIAOCAI_NEIRONG
			WHERE
				BOOK_ID = #bookId#  AND
				EDIT_NO = #editNo#
		</delete>
		
		<!-- 删除旧版本教材资料表内容 --> 
		<delete id="deleteOldBookData" parameterClass="BookInfo"> 	
			DELETE FROM
				TT_JIAOCAI_ZILIAO
			WHERE
				BOOK_ID = #bookId#  AND
				DELETE_FLAG = '2'
		</delete>
			
		<!-- 删除旧版本教材表内容 --> 
		<delete id="deleteOldBookInfo" parameterClass="BookInfo"> 
			DELETE FROM
				TT_JIAOCAI
			WHERE
				BOOK_ID = #bookId#  AND
				BOOK_STATUS = '3'
		</delete>
		
		<!-- 删除旧版本试卷表内容 --> 
		<delete id="deleteOldTestPaper" parameterClass="BookInfo"> 
			DELETE FROM
				TT_SHIJUAN
			WHERE
				BELONG_ID = #bookId#  AND
				NEW_FLG = '1'
				
		</delete>
		
		<!-- 修改试卷信息 --> 
		<update id="updateTestPaper" parameterClass="BookInfo">
			UPDATE
				TT_SHIJUAN
			SET
				NEW_FLG = '1',
				UPDATE_USER_ID = #approverUserId#,
				UPDATE_TIME = NOW()
			WHERE
				BELONG_ID = #bookId# AND
				NEW_FLG = '0'
		</update>
				
		<!-- 修改教材信息(版本数为2时)--> 
		<update id="updatePluralVersionBook" parameterClass="BookInfo">
			UPDATE
				TT_JIAOCAI
			SET
				BOOK_STATUS = '3',
				APPROVER_USER_ID = #approverUserId#,
				APPROVER_TIME = NOW(),
				UPDATE_USER_ID = #approverUserId#,
				UPDATE_TIME = NOW(),
				REFUSE_REASON = ''
			WHERE
				BOOK_ID = #bookId# AND
				BOOK_STATUS != '3'
		</update>

		<!-- 修改教材状态为“不批准”--> 
		<update id="updateRefuseBook" parameterClass="BookInfo">
			UPDATE
				TT_JIAOCAI
			SET
				BOOK_STATUS = '4',
				REFUSE_REASON = #refuseReason#,
				APPROVER_USER_ID = #approverUserId#,
				APPROVER_TIME = NOW(),
				UPDATE_USER_ID = #approverUserId#,
				UPDATE_TIME = NOW()
			WHERE
				BOOK_ID = #bookId# AND
				EDIT_NO = #editNo#
		</update>
</sqlMap>
