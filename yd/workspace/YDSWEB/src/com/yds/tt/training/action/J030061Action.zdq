/*
 * @(#) J030061Action.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试培训系统
 *    SubSystem: 教育子系统
 */

package com.yds.tt.training.action;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.yds.base.action.AbstractBaseAction;
import com.yds.tt.manager.bean.TtCheckResult;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.manager.service.TtExclusiveException;
import com.yds.tt.manager.service.TtExclusiveExtException;
import com.yds.tt.training.bean.BookContent;
import com.yds.tt.training.service.J030061Service;

/**
 * 章节编辑处理
 * 
 * @author xinzhipeng
 * @version 1.00 2010/03/15
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("j030061Action")
public class J030061Action extends AbstractBaseAction {
	
	private static final long serialVersionUID = 2238795183891621084L;
	private J030061Service j030061Service;
	// 章节信息
	private List<BookContent> chapterInfos;
	// 教材ID
	private String bookId;
	// 编辑号
	private Integer editNo;
	// 章节数
	private Integer chapterSize;
	
	// 教材内容信息
	private BookContent bookContent;

	// 可否保存标志
	private Integer saveFlag = 0;

	private TtCommonService ttCommonService;

	// 错误信息
	private String errorMessage;

	/**
	 * 章节编辑画面初始化
	 * 
	 * @return SUCCESS
	 * @throws Exception 
	 */
	public String initEditChapterInfo() throws Exception {
		
		// 画面启动限制检查
		if (!checkAutority()) {
			return ERROR;
		}

		// 教材是否存在检查
		if(0 == j030061Service.searchBookEditNum(bookId)){
			errorMessage = propMgr.getMessage("yds.tt.error.JYE12","教材");
			return ERROR;
		}

		try {
			// 锁定当前编辑章节内容
			ttCommonService.addLock(bookId);

		} catch (TtExclusiveException e) {
			// 出现单键锁冲突意味着有人在进行章节编辑
			String userName = e.getMessage();
			errorMessage = propMgr.getMessage("yds.tt.error.JYE19",userName);
			return ERROR;

		} catch (TtExclusiveExtException e) {
			// 出现双键锁冲突说明有人在编辑现在要访问的数据
			String userNames = e.getMessage();
			errorMessage = propMgr.getMessage("yds.tt.error.JYE20",userNames);
			return ERROR;
		}
		
		// 参数接收
		BookContent bookContent = new BookContent(); 
		bookContent.setBookId(bookId);		
		bookContent.setEditNo(editNo);
		
		// 章节信息一览取得
		this.chapterInfos = j030061Service.getChapterInfos(bookContent);
		this.chapterSize = chapterInfos.size();
		
		return SUCCESS;
	}

	/**
	 * 保存章节信息（章节数据条数取得）
	 * 
	 * @return SUCCESS
	 * @throws Exception 
	 */
	public String checkChapterInfos() throws Exception {
		
		// 章节数据条数取得
		if(null != chapterInfos ){
			saveFlag = 1;
		}
		return SUCCESS;
	}
	
	/**
	 * 保存章节信息
	 * 
	 * @return SUCCESS
	 * @throws Exception 
	 */
	public String saveEditChapterInfo() throws Exception {
		// 权限检查
		if (!checkAutority()) {
			return ERROR;
		}
		if(null == chapterInfos){
			return SUCCESS;
		}
		
		// 保存章节信息
		j030061Service.updateChapterInfo(chapterInfos);
		
		// 章节信息一览取得		
		BookContent bookContent = new BookContent();
		bookContent.setBookId(bookId);
		bookContent.setEditNo(editNo);
		
		this.chapterInfos = j030061Service.getChapterInfos(bookContent);
		this.chapterSize = chapterInfos.size();
		
		// 显示操作成功消息
		putOpTip(propMgr.getMessage("yds.tt.info.GTT02"));
		
		return SUCCESS;
	}
	
	/**
	 * 退出编辑
	 * 
	 * @return SUCCESS
	 */
	public String quitEdit(){
		
		// 解锁数据
		ttCommonService.removeLock(bookId);
		
		return SUCCESS;
	}

	/**
	 * 更新排他锁
	 * 
	 * @return SUCCESS
	 */
	public String updateLock(){
		
		// 更新锁时间
		ttCommonService.updateLock(bookId);
		return SUCCESS;
	}
	
	/**
	 * 权限校验
	 */
	private boolean checkAutority() {

		List<String> objectId = new ArrayList<String>();
		objectId.add(bookId);
		// 画面Id
		String pageId = TtConstants.PageId.J030061.value();
		
		// Event Id
		String eventId = "J030061";

		// 权限检查
		TtCheckResult checkResult = ttCommonService.checkStartupAuthority(
				pageId, eventId, 0, 0, 0,
				TtConstants.C43.C43_2.value(), objectId);

		if (!checkResult.getRetFlag()) {
			errorMessage = checkResult.getRetMessage();
			return false;
		}
		
		return true;
	}
	
	/**
	 * @return the j030061Service
	 */
	public J030061Service getJ030061Service() {
		return j030061Service;
	}

	/**
	 * @param service the j030061Service to set
	 */
	public void setJ030061Service(J030061Service service) {
		j030061Service = service;
	}

	/**
	 * @return the chapterInfos
	 */
	public List<BookContent> getChapterInfos() {
		return chapterInfos;
	}

	/**
	 * @param chapterInfos the chapterInfos to set
	 */
	public void setChapterInfos(List<BookContent> chapterInfos) {
		this.chapterInfos = chapterInfos;
	}

	/**
	 * @return the bookId
	 */
	public String getBookId() {
		return bookId;
	}

	/**
	 * @param bookId the bookId to set
	 */
	public void setBookId(String bookId) {
		this.bookId = bookId;
	}

	/**
	 * @return the editNo
	 */
	public Integer getEditNo() {
		return editNo;
	}

	/**
	 * @param editNo the editNo to set
	 */
	public void setEditNo(Integer editNo) {
		this.editNo = editNo;
	}

	
	/**
	 * @return the errorMessage
	 */
	public String getErrorMessage() {
		return errorMessage;
	}

	/**
	 * @param errorMessage the errorMessage to set
	 */
	public void setErrorMessage(String errorMessage) {
		this.errorMessage = errorMessage;
	}

	/**
	 * @return the chapterSize
	 */
	public Integer getChapterSize() {
		return chapterSize;
	}

	/**
	 * @param chapterSize the chapterSize to set
	 */
	public void setChapterSize(Integer chapterSize) {
		this.chapterSize = chapterSize;
	}
	
	/**
	 * @return the bookContent
	 */
	public BookContent getBookContent() {
		return bookContent;
	}

	/**
	 * @param bookContent the bookContent to set
	 */
	public void setBookContent(BookContent bookContent) {
		this.bookContent = bookContent;
	}

	/**
	 * @return the saveFlag
	 */
	public Integer getSaveFlag() {
		return saveFlag;
	}

	/**
	 * @param saveFlag the saveFlag to set
	 */
	public void setSaveFlag(Integer saveFlag) {
		this.saveFlag = saveFlag;
	}


	/**
	 * @param ttCommonService the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}
}
