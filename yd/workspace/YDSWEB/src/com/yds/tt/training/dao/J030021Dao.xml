<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="J030021Dao">
	
	<typeAlias alias="j030021Info" type="com.yds.tt.training.bean.J030021Info"/>
	<typeAlias alias="bookInfo" type="com.yds.tt.training.bean.BookInfo"/>
	<typeAlias alias="courseBookRelation" type="com.yds.tt.training.bean.CourseBookRelation"/>

	<!-- 课程管理员权限 --> 		
	<select id="selectCountCourseManager" parameterClass="String" resultClass="Long"> 
		Select
			COUNT(*)
		From tt_quanxian T1
		WHERE T1.USER_ID = #loginUserId#
		<!-- 课程管理员权限 -->
		AND T1.AUTHORITY_ID = '1' 
		AND T1.END_TIME >= now()
		AND now() >= T1.START_TIME
	</select>
		
	<!-- 教材一览检索项目(追加模式项目) --> 		
	<sql id="selectBookInfoAttribute"> 
		SELECT
			T1.BOOk_ID AS bookId,
			T1.EDIT_NO AS editNo,
			T1.BOOk_NAME AS bookName,
			T1.UPDATE_TIME AS updateTime,
			(SELECT USER_CNM 
				FROM v_tt_user 
				WHERE USER_ID = T1.CREATE_USER_ID) AS createUserName,
			(SELECT USER_CNM 
				FROM v_tt_user 
				WHERE USER_ID = T1.UPDATE_USER_ID) AS updateUserName,
			(SELECT CATEGORY_NAME 
				FROM tt_fenlei 
				WHERE CATEGORY1_ID = T1.CATEGORY1_ID
				AND CATEGORY2_ID = '0'
				AND CATEGORY3_ID = '0'
				AND CATEGORY_LEVEL = '1') AS category1Name,
			(SELECT CATEGORY_NAME 
				FROM tt_fenlei 
				WHERE CATEGORY1_ID = T1.CATEGORY1_ID
				AND CATEGORY2_ID = T1.CATEGORY2_ID
				AND CATEGORY3_ID = '0'
				AND CATEGORY_LEVEL = '2') AS category2Name,
			(SELECT CATEGORY_NAME 
				FROM tt_fenlei 
				WHERE CATEGORY1_ID = T1.CATEGORY1_ID
				AND CATEGORY2_ID = T1.CATEGORY2_ID
				AND CATEGORY3_ID = T1.CATEGORY3_ID
				AND CATEGORY_LEVEL = '3') AS category3Name,
			<!-- 教材ID链接显示标识，追加模式下链接都可用 -->
			1 AS bookIdShowFlg
	</sql>
	
	<!-- 教材一览检索项目(一览模式临时项目) --> 		
	<sql id="selectBookInfoShowModePre">
		SELECT
			T1.BOOk_ID,
			T1.EDIT_NO,
			T1.BOOk_NAME,
			T1.UPDATE_TIME,
			T1.BOOK_STATUS,
			T1.CREATE_USER_ID,
			T1.UPDATE_USER_ID,
			T1.CATEGORY1_ID,
			T1.CATEGORY2_ID,
			T1.CATEGORY3_ID
	</sql>
	
	<!-- 教材一览检索项目(一览模式实际检索项目) --> 		
	<sql id="selectBookInfoShowMode">
		SELECT 
			T5.BOOk_ID AS bookId,
			T5.EDIT_NO AS editNo,
			T5.BOOk_NAME AS bookName,
			T5.UPDATE_TIME AS updateTime,
			T5.BOOK_STATUS AS bookStatus,
			(SELECT USER_CNM 
				FROM v_tt_user 
				WHERE USER_ID = T5.CREATE_USER_ID) AS createUserName,
			(SELECT USER_CNM 
				FROM v_tt_user 
				WHERE USER_ID = T5.UPDATE_USER_ID) AS updateUserName,
			(SELECT CATEGORY_NAME 
				FROM tt_fenlei 
				WHERE CATEGORY1_ID = T5.CATEGORY1_ID
				AND CATEGORY2_ID = '0'
				AND CATEGORY3_ID = '0'
				AND CATEGORY_LEVEL = '1') AS category1Name,
			(SELECT CATEGORY_NAME 
				FROM tt_fenlei 
				WHERE CATEGORY1_ID = T5.CATEGORY1_ID
				AND CATEGORY2_ID = T5.CATEGORY2_ID
				AND CATEGORY3_ID = '0'
				AND CATEGORY_LEVEL = '2') AS category2Name,
			(SELECT CATEGORY_NAME 
				FROM tt_fenlei 
				WHERE CATEGORY1_ID = T5.CATEGORY1_ID
				AND CATEGORY2_ID = T5.CATEGORY2_ID
				AND CATEGORY3_ID = T5.CATEGORY3_ID
				AND CATEGORY_LEVEL = '3') AS category3Name,
			(SELECT COUNT(*) 
				FROM tt_jiaocai 
				WHERE BOOk_ID = T5.BOOk_ID ) AS versionNum,
			(Select DIFF_NAME 
				FROM com_code_mst
				WHERE TYPE_ID = 'R01' 
				AND DIFF_NO = T5.BOOK_STATUS) AS statusName,
			<!-- 合计操作者拥有的所有对教材的操作权限 -->
			SUM(T5.operatorFlg) AS operatorFlg		
	</sql>
	
	<!-- 教材一览检索对象表(共通表) --> 		
	<sql id="fromTableBasic">
		From tt_jiaocai T1 
	</sql>	
	
	<!-- 教材一览检索对象表(最新教材表) --> 		
	<sql id="fromTableBookNew">
		,(SELECT T2.BOOk_ID, MAX(T2.EDIT_NO) AS EDIT_NO FROM tt_jiaocai T2 GROUP BY T2.BOOk_ID) AS T3 
	</sql>
	
	<!-- 教材一览检索对象表(权限表) --> 		
	<sql id="fromTablePermit">
		,tt_quanxian T4 
	</sql>		
	
	<!-- 教材一览检索条件(共通条件*课程管理员除外) --> 
	<sql id="bookInfoSearchBasicCondition">
		<isNotEmpty prepend="AND" property="bookId"> 
			T1.BOOk_ID LIKE CONCAT(#bookId#, '%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="bookName"> 
			T1.BOOk_NAME LIKE CONCAT('%' ,#bookName#, '%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="createUserId">
			T1.CREATE_USER_ID = #createUserId# 
		</isNotEmpty>
		<!-- 统一画面风格 2010/08/17 sundefu comment
		<isNotEmpty prepend="AND" property="createTimeFrom"> 
			T1.CREATE_TIME >= #createTimeFrom#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="createTimeTo"> 
			#createTimeTo# >= DATE_FORMAT(T1.CREATE_TIME, '%Y-%m-%d')
		</isNotEmpty>
		-->
		<isNotEmpty property="category1Id"> 
			<isNotEqual prepend="AND" property="category1Id" compareValue="0">
				T1.CATEGORY1_ID = #category1Id# 
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category2Id"> 
			<isNotEqual prepend="AND" property="category2Id" compareValue="0">
				T1.CATEGORY2_ID = #category2Id# 
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category3Id"> 
			<isNotEqual prepend="AND" property="category3Id" compareValue="0">
				T1.CATEGORY3_ID = #category3Id# 
			</isNotEqual>
		</isNotEmpty>
		<!-- 统一画面风格 2010/08/17 sundefu add-->
		<isNotEmpty prepend="AND" property="updateUserId">
			T1.UPDATE_USER_ID = #updateUserId# 
		</isNotEmpty>
	</sql>
	
	<!-- 教材一览检索条件(追加模式独有条件) --> 
	<sql id="bookInfoSearchAddModeCondition"> 
		<!-- 教材状态为'已发布' -->
		WHERE T1.BOOK_STATUS = '3'
		<!-- 教材为'可引用'教材 --> 
		AND	T1.QUOTE_FLAG = '1' 
	</sql>

	<!-- 教材一览检索条件(一览模式针对课程管理员独有条件) --> 
	<sql id="ShowModeForCManagerCondition"> 
		WHERE T3.BOOK_ID = T1.BOOK_ID
		AND	T3.EDIT_NO = T1.EDIT_NO
		<isNotEmpty prepend="AND" property="bookId"> 
			T1.BOOk_ID LIKE CONCAT(#bookId#, '%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="bookName"> 
			T1.BOOk_NAME LIKE CONCAT('%' ,#bookName#, '%')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="createUserId"> 
			T1.CREATE_USER_ID = #createUserId# 
		</isNotEmpty>
		<!-- 统一画面风格 2010/08/17 sundefu comment
		<isNotEmpty prepend="AND" property="createTimeFrom"> 
			T1.CREATE_TIME >= #createTimeFrom#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="createTimeTo"> 
			#createTimeTo# >= DATE_FORMAT(T1.CREATE_TIME, '%Y-%m-%d')
		</isNotEmpty>
		-->
		<!-- 课程管理员能操作的教材分类列表 -->
		<isNotEmpty prepend="AND" open="(" close=")" property="categoryInfos">
			<iterate conjunction="or" property="categoryInfos" >
				<isNotEqual property="categoryInfos[].category1Id" compareValue="0">
					(
					T1.CATEGORY1_ID = #categoryInfos[].category1Id#
					<isNotEqual prepend="AND" property="categoryInfos[].category2Id" compareValue="0">
						T1.CATEGORY2_ID = #categoryInfos[].category2Id#
					</isNotEqual>
					<isNotEqual prepend="AND" property="categoryInfos[].category3Id" compareValue="0">
						T1.CATEGORY3_ID = #categoryInfos[].category3Id#
					</isNotEqual>
					)
				</isNotEqual>
			</iterate>
		</isNotEmpty>
		<!-- 统一画面风格 2010/08/17 sundefu add-->
		<isNotEmpty prepend="AND" property="updateUserId">
			T1.UPDATE_USER_ID = #updateUserId# 
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="bookStatus">
			T1.BOOK_STATUS = #bookStatus# 
		</isNotEmpty>
	</sql>

	<!-- 教材一览检索条件(一览模式针对课程编辑者独有条件) --> 
	<sql id="ShowModeForCEditorCondition"> 
		WHERE T3.BOOK_ID = T1.BOOK_ID
		AND	T3.EDIT_NO = T1.EDIT_NO
		AND T1.BELONG_COURSE_ID = T4.RELATEDOBJECT_ID
		AND	T4.USER_ID = #loginUserId# 
		<!-- 权限区分为'课程编辑' -->
		AND	T4.AUTHORITY_ID = '6'
		AND T4.END_TIME >= now()
		AND now() >= T4.START_TIME
		<!-- 统一画面风格 2010/08/17 sundefu add-->
		<isNotEmpty prepend="AND" property="bookStatus">
			T1.BOOK_STATUS = #bookStatus# 
		</isNotEmpty>
	</sql>

	<!-- 教材一览检索条件(一览模式针对教材编辑者独有条件) --> 
	<sql id="ShowModeForBEditorCondition"> 
		WHERE T3.BOOK_ID = T1.BOOK_ID
		AND	T3.EDIT_NO = T1.EDIT_NO
		AND T1.BOOK_ID = T4.RELATEDOBJECT_ID
		AND	T4.USER_ID = #loginUserId# 
		<!-- 权限区分为教材编辑 -->
		AND	T4.AUTHORITY_ID = '7'
		AND T4.END_TIME >= now()
		AND now() >= T4.START_TIME
		<!-- 统一画面风格 2010/08/17 sundefu add-->
		<isNotEmpty prepend="AND" property="bookStatus">
			T1.BOOK_STATUS = #bookStatus# 
		</isNotEmpty>
	</sql>
	
	<!-- 教材一览检索条件(一览模式针对教材审批者独有条件) --> 
	<sql id="ShowModeForBApproverCondition">
		WHERE T3.BOOK_ID = T1.BOOK_ID
		AND	T3.EDIT_NO = T1.EDIT_NO
		AND T1.BOOK_ID = T4.RELATEDOBJECT_ID
		AND	T4.USER_ID = #loginUserId#
		<!-- 权限区分为教材审批 -->
		AND	T4.AUTHORITY_ID = '11'
		AND T4.END_TIME >= now()
		AND now() >= T4.START_TIME
		<!-- 统一画面风格 2010/08/17 sundefu add-->
		<isNotEmpty prepend="AND" property="bookStatus">
			T1.BOOK_STATUS = #bookStatus# 
		</isNotEmpty>
	</sql>
		
	<!-- 教材一览检索(一览模式课程管理员) -->
	<sql id="getBookListShowModeForCManager">
		<include refid="selectBookInfoShowModePre"/>
		<!-- 课程管理员权限标识 -->
		,1 AS operatorFlg	
		<include refid="fromTableBasic"/>
		<include refid="fromTableBookNew"/>
		<include refid="ShowModeForCManagerCondition"/>
	</sql>

	<!-- 教材一览检索(一览模式课程编辑者) -->
	<sql id="getBookListShowModeForCEditor"> 
		<include refid="selectBookInfoShowModePre"/>
		<!-- 课程编辑者权限标识 -->
		,2 AS operatorFlg
		<include refid="fromTableBasic"/>
		<include refid="fromTableBookNew"/>
		<include refid="fromTablePermit"/>
		<include refid="ShowModeForCEditorCondition"/>
		<include refid="bookInfoSearchBasicCondition"/>
	</sql>
	
	<!-- 教材一览检索(一览模式教材编辑者) --> 		
	<sql id="getBookListShowModeForBEditor"> 
		<include refid="selectBookInfoShowModePre"/>
		<!-- 教材编辑者权限标识 -->
		,4 AS operatorFlg	
		<include refid="fromTableBasic"/>
		<include refid="fromTableBookNew"/>
		<include refid="fromTablePermit"/>
		<include refid="ShowModeForBEditorCondition"/>
		<include refid="bookInfoSearchBasicCondition"/>
	</sql>	
	
	<!-- 教材一览检索(一览模式教材审批者) -->
	<sql id="getBookListShowModeForBApprover"> 
		<include refid="selectBookInfoShowModePre"/>
		<!-- 教材审批者权限标识 -->
		,8 AS operatorFlg
		<include refid="fromTableBasic"/>
		<include refid="fromTableBookNew"/>
		<include refid="fromTablePermit"/>
		<include refid="ShowModeForBApproverCondition"/>
		<include refid="bookInfoSearchBasicCondition"/>
	</sql>	
	
	<!-- 教材一览检索(追加模式最终条件) -->
	<sql id="addModeCondition">
		<include refid="fromTableBasic"/>
		<include refid="bookInfoSearchAddModeCondition"/>		
		<include refid="bookInfoSearchBasicCondition"/>	
	</sql>
		
	<!-- 教材一览检索(一览模式最终条件) -->
	<sql id="showModeCondition">
		FROM (
		<isEqual property="courseManager" compareValue="true">
			(
				<include refid="getBookListShowModeForCManager"/>
			) Union ALL
		</isEqual>
			( <include refid="getBookListShowModeForCEditor"/>
		) Union ALL
			( <include refid="getBookListShowModeForBEditor"/>
		) Union ALL
			( <include refid="getBookListShowModeForBApprover"/>
		)) AS T5
	</sql>
			
	<!-- 教材一览检索件数(追加模式) --> 		
	<select id="selectCountBookInfoListAddMode" parameterClass="j030021Info" resultClass="Long"> 
		Select 
			COUNT(*)
		<include refid="addModeCondition"/>
	</select>
	
	<!-- 教材一览检索(追加模式) --> 		
	<select id="getBookInfoListAddMode" parameterClass="j030021Info" resultClass="bookInfo"> 
		<include refid="selectBookInfoAttribute"/>
		<include refid="addModeCondition"/>
		ORDER BY T1.BOOK_ID DESC
	</select>
	
	<!-- 教材一览检索件数(一览模式) --> 		
	<select id="selectCountBookInfoListShowMode" parameterClass="j030021Info" resultClass="Long"> 
		Select 
			COUNT(DISTINCT T5.BOOK_ID)
		<include refid="showModeCondition"/>
	</select>
		
	<!-- 教材一览检索(一览模式) --> 		
	<select id="getBookInfoListShowMode" parameterClass="j030021Info" resultClass="bookInfo"> 
		<include refid="selectBookInfoShowMode"/>
		<include refid="showModeCondition"/>
		Group BY T5.BOOK_ID, T5.EDIT_NO
		ORDER BY T5.BOOK_ID DESC
	</select>
	
	<!-- 指定课程检索 --> 		
	<select id="selectCountCourse" parameterClass="String" resultClass="Long"> 
		Select
			COUNT(*)
		From tt_kecheng T1
		WHERE T1.COURSE_ID = #courseId#
	</select>
	
	<!-- 指定课程下关联教材检索 --> 		
	<select id="getCourseBookRelation" parameterClass="java.util.HashMap" resultClass="java.util.HashMap"> 
		Select
			T1.COURSE_ID as courseId,
			T1.BOOK_ID as bookId
		From tt_kecheng_jiaocai T1
		<isNotEmpty property="courseId"> 
			WHERE T1.COURSE_ID = #courseId#
		</isNotEmpty>
		<isNotEmpty property="bookId"> 
			WHERE T1.BOOK_ID = #bookId#
		</isNotEmpty>
	</select>
	
	<!--添加课程教材关联-->
	<insert id="insertCourseBookRelation" parameterClass="courseBookRelation">
		INSERT INTO tt_kecheng_jiaocai 
		(
			COURSE_ID,
			BOOK_ID
		) 
		VALUES 
		(
			#courseId#,
			#bookId#
		)	
	</insert>	
</sqlMap>
