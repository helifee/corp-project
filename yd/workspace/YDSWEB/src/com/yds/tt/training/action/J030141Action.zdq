/*
 * @(#) J030141Action.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试培训系统
 *    SubSystem: 教育子系统
 */

package com.yds.tt.training.action;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.opensymphony.xwork2.interceptor.annotations.InputConfig;
import com.yds.base.action.AbstractBaseAction;
import com.yds.common.service.SessionConstants;
import com.yds.tt.manager.bean.TtCheckResult;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.manager.service.TtExclusiveException;
import com.yds.tt.training.bean.BookInfo;
import com.yds.tt.training.service.J030141Service;
import com.yds.util.service.Session;

/**
 * 教材变更履历处理
 * 
 * @author lijinling
 * @version 1.00 2010/03/15
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("j030141Action")
public class J030141Action extends AbstractBaseAction {

	private static final long serialVersionUID = 6790705316510364640L;

	private J030141Service j030141Service;

	private TtCommonService ttCommonService;

	private BookInfo bookInfo; // 教材更新信息

	private String errorMessage; // 错误消息

	private Integer updateNo; // 更新号

	private Integer versionNo; // 版本号

	private Integer option; // 版本变更选项

	/**
	 * 初期化校验
	 */
	public void validateExecute() {

		// 参数检查
		if (null == bookInfo || null == bookInfo.getBookId()
				|| null == bookInfo.getUpdateTime()) {
			errorMessage = propMgr.getMessage("yds.com.warning.0001", "接口参数");
			addFieldError("", "");
		}
	}

	/**
	 * 画面初期表示
	 */
	@Override
	@InputConfig(resultName = "error")
	public String execute() {
		// 权限检查
		if (!checkAutority()) {
			return ERROR;
		}
		
		bookInfo = j030141Service.init(bookInfo);
		if (null == this.bookInfo) {

			// 教材信息不存在
			errorMessage = propMgr.getMessage("yds.tt.error.JYE12", "教材");
			return ERROR;
		}
		
		return SUCCESS;
	}

	/**
	 * 提交审批
	 * 
	 * @return
	 */
	public String submitBookInfo() {
		
		BookInfo bInfo = (BookInfo) Session.get(SessionConstants.TT_J030141_UPDATEBOOKINFO);
		bookInfo.setBookId(bInfo.getBookId());
		// 权限检查
		if (!checkAutority()) {
			return ERROR;
		}
		
		try {
			// 提交审批,更新教材信息
			bookInfo = j030141Service.updateBookInfo(bookInfo, option);
		} catch (TtExclusiveException e) {
			errorMessage = propMgr.getMessage("yds.tt.error.KSE56");

			return ERROR;
		}

		return SUCCESS;
	}

	/**
	 * 权限校验
	 */
	private boolean checkAutority() {

		List<String> objectId = new ArrayList<String>();
		objectId.add(bookInfo.getBookId());

		// 权限检查
		TtCheckResult checkResult = ttCommonService.checkStartupAuthority(
				TtConstants.PageId.J030141.value(), "J030141",
				0, 0, 0, TtConstants.C43.C43_2.value(), objectId);

		if (!checkResult.getRetFlag()) {
			errorMessage = checkResult.getRetMessage();
			return false;
		}
		return true;
	}

	/**
	 * @return the bookInfo
	 */
	public BookInfo getBookInfo() {
		return bookInfo;
	}

	/**
	 * @param bookInfo
	 *            the bookInfo to set
	 */
	public void setBookInfo(BookInfo bookInfo) {
		this.bookInfo = bookInfo;
	}

	/**
	 * @param service
	 *            the j030141Service to set
	 */
	public void setJ030141Service(J030141Service service) {
		j030141Service = service;
	}

	/**
	 * @param ttCommonService
	 *            the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}

	/**
	 * @return the errorMessage
	 */
	public String getErrorMessage() {
		return errorMessage;
	}

	/**
	 * @param errorMessage
	 *            the errorMessage to set
	 */
	public void setErrorMessage(String errorMessage) {
		this.errorMessage = errorMessage;
	}

	/**
	 * @return the updateNo
	 */
	public Integer getUpdateNo() {
		return updateNo;
	}

	/**
	 * @param updateNo
	 *            the updateNo to set
	 */
	public void setUpdateNo(Integer updateNo) {
		this.updateNo = updateNo;
	}

	/**
	 * @return the versionNo
	 */
	public Integer getVersionNo() {
		return versionNo;
	}

	/**
	 * @param versionNo
	 *            the versionNo to set
	 */
	public void setVersionNo(Integer versionNo) {
		this.versionNo = versionNo;
	}

	/**
	 * @return the option
	 */
	public Integer getOption() {
		return option;
	}

	/**
	 * @param option
	 *            the option to set
	 */
	public void setOption(Integer option) {
		this.option = option;
	}

}
