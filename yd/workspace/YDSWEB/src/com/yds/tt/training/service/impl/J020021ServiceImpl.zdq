/*
 * @(#)J020021ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 教育系统
 */

package com.yds.tt.training.service.impl;

import java.util.List;

import org.springframework.stereotype.Service;

import com.yds.base.service.AbstractBaseService;
import com.yds.common.service.SessionConstants;
import com.yds.tt.manager.bean.CategoryInfo;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtCommonUtil;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.training.bean.CourseInfo;
import com.yds.tt.training.bean.J020021SearchInfo;
import com.yds.tt.training.dao.J020021Dao;
import com.yds.tt.training.service.J020021Service;
import com.yds.util.service.Session;

/**
 * 
 * @see com.yds.tt.training.service.J020021Service
 *
 */
@Service("j020021Service")
public class J020021ServiceImpl extends AbstractBaseService implements
		J020021Service {

	// 课程审批者操作标识	
	private static final Integer COURSEAPPROVERFLG = 4;
	// 课程编辑者操作标识	
	private static final Integer COURSEEDITORFLG = 2;
	// 具有权限标识
	private static final Integer OPERATEAUTHORITYFLG = 1;
	
	private J020021Dao j020021Dao;
	private TtCommonService ttCommonService;
	/**
	 * @param dao the j020021Dao to set
	 */
	public void setJ020021Dao(J020021Dao dao) {
		j020021Dao = dao;
	}
	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public long selectCountCourseInfo(J020021SearchInfo courseEditableInfo) {
		
		//检索条件编辑
		if (courseEditableInfo == null){
			courseEditableInfo = new J020021SearchInfo();
			courseEditableInfo.setCategory1Id(0);
			courseEditableInfo.setCategory2Id(0);
			courseEditableInfo.setCategory3Id(0);
		}
		courseEditableInfo.setUserId(TtCommonUtil.getLoginUserId());
		
		// 取得课程管理员可操作分类
		List<CategoryInfo> categoryInfos = ttCommonService.getCategoryCondition(
							TtCommonUtil.getLoginUserId(),
							TtConstants.C24.C24_1.value(),
							courseEditableInfo.getCategory1Id(),
							courseEditableInfo.getCategory2Id(),
							courseEditableInfo.getCategory3Id());
		courseEditableInfo.setCategoryInfos(categoryInfos);
		if (categoryInfos == null || categoryInfos.size() == 0) {
			courseEditableInfo.setCourseManager(false);
			Session.set(SessionConstants.TT_J020021_COURSEMANGER, false);
		}else{
			courseEditableInfo.setCourseManager(true);
			Session.set(SessionConstants.TT_J020021_COURSEMANGER, true);
		}
		
		// 取得课程一览信息
		long bookCount = j020021Dao.selectCountCourseInfo(courseEditableInfo);
		
		return bookCount;
	}
	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<CourseInfo> getCourseEditableInfoList(J020021SearchInfo courseEditableInfo, int offset, int perCounts) {
		
		//检索条件编辑
		if (courseEditableInfo == null){
			courseEditableInfo = new J020021SearchInfo();
			courseEditableInfo.setCategory1Id(0);
			courseEditableInfo.setCategory2Id(0);
			courseEditableInfo.setCategory3Id(0);
		}
		courseEditableInfo.setUserId(TtCommonUtil.getLoginUserId());
		
		// 取得课程管理员可操作分类
		List<CategoryInfo> categoryInfos = ttCommonService.getCategoryCondition(
							TtCommonUtil.getLoginUserId(),
							TtConstants.C24.C24_1.value(),
							courseEditableInfo.getCategory1Id(),
							courseEditableInfo.getCategory2Id(),
							courseEditableInfo.getCategory3Id());
		courseEditableInfo.setCategoryInfos(categoryInfos);
		if (categoryInfos == null || categoryInfos.size() == 0) {
			courseEditableInfo.setCourseManager(false);
			Session.set(SessionConstants.TT_J020021_COURSEMANGER, false);
		}else{
			courseEditableInfo.setCourseManager(true);
			Session.set(SessionConstants.TT_J020021_COURSEMANGER, true);
		}
		
		// 取得课程一览信息
		List<CourseInfo> courseInfos = j020021Dao.getCourseEditableInfoList(courseEditableInfo, offset, perCounts);
		
		// 编辑操作标识
		for (int i = 0; i < courseInfos.size(); i++) {
			int operateFlag = courseInfos.get(i).getOpFlag();
			// 审批标识
			if (operateFlag / COURSEAPPROVERFLG == 1) {
				if (TtConstants.R06.R06_2.value() == courseInfos.get(i)
						.getCourseConfirmStatus()) {
					courseInfos.get(i).setApproveFlag(OPERATEAUTHORITYFLG);
				} else {
					courseInfos.get(i).setApproveFlag(0);
				}
			}
			operateFlag = operateFlag % COURSEAPPROVERFLG;
			// 编辑标识
			if (operateFlag / COURSEEDITORFLG == 1) {
				courseInfos.get(i).setEditFlag(OPERATEAUTHORITYFLG);
			}
			operateFlag = operateFlag % COURSEEDITORFLG;
			// 管理标识
			if (operateFlag == 1) {
				courseInfos.get(i).setEditFlag(OPERATEAUTHORITYFLG);
				courseInfos.get(i).setManageFlag(OPERATEAUTHORITYFLG);
			}
		}
		
		return courseInfos;
	}	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<CourseInfo> getCourseConfirmableInfoList(
			J020021SearchInfo courseConfirmableInfo) {
		//检索条件编辑
		if (courseConfirmableInfo == null){
			courseConfirmableInfo = new J020021SearchInfo();
		}
		courseConfirmableInfo.setUserId(TtCommonUtil.getLoginUserId());
		
		return j020021Dao.getCourseConfirmableInfoList(courseConfirmableInfo);
	}
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<CourseInfo> getCoursePaticipateInfoList(
			J020021SearchInfo coursePaticipateInfo) {
		//检索条件编辑
		if(coursePaticipateInfo == null){
			coursePaticipateInfo = new J020021SearchInfo();
		}
		coursePaticipateInfo.setUserId(TtCommonUtil.getLoginUserId());
		
		return j020021Dao.getCoursePaticipateInfoList(coursePaticipateInfo);
	}
	
	/**
	 * @return the ttCommonService
	 */
	public TtCommonService getTtCommonService() {
		return ttCommonService;
	}
	/**
	 * @param ttCommonService the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}
}
