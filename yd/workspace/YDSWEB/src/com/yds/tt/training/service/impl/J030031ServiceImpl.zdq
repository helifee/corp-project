/*
 * @(#) J030031ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试培训系统
 *    SubSystem: 教育
 */
package com.yds.tt.training.service.impl;

import java.util.Date;
import java.util.List;

import org.springframework.stereotype.Service;

import com.yds.base.service.AbstractBaseService;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.manager.service.TtExclusiveException;
import com.yds.tt.training.bean.BookContent;
import com.yds.tt.training.bean.BookInfo;
import com.yds.tt.training.dao.J030031Dao;
import com.yds.tt.training.service.J030031Service;

/**
 * @see com.yds.tt.training.service.J030031Service
 */
@Service("j030031Service")
public class J030031ServiceImpl extends AbstractBaseService implements
		J030031Service {
	
	private J030031Dao j030031Dao;
	private BookInfo bookInfo;
	private TtCommonService ttCommonService;

	@Override
	// 教材编辑号取得
	public int searchEditNo(BookContent bookContentPara,int mode) {

		BookInfo editNoInfo;
		int editNo = -1;
		
		// 教材编辑号取得
		// 查看模式（用户查看&管理查看）
		if (1 == mode || 2 == mode){
			editNoInfo = j030031Dao.getViewEditNo(bookContentPara);

		// 审批&删除模式
		} else {
			editNoInfo = j030031Dao.getMaxEditNo(bookContentPara);
		}
		
		if (null != editNoInfo.getEditNo()) {
			editNo = editNoInfo.getEditNo();
		}
		
		return editNo;
	}
	
	/**
	 * 检索教材信息
	 */
	@Override
	public BookInfo searchBookBaseInfo(BookContent bookContentPara) {
		bookInfo = j030031Dao.getBookBaseInfo(bookContentPara);

		if (null != bookInfo) {
			//编辑分类名称
			bookInfo.setCategoryName(bookInfo.getCategoryName());//，将3个分类名用"-"连结
			if(null == bookInfo.getBookCover()||bookInfo.getBookCover().isEmpty()){
				bookInfo.setBookCover("defaultCover.jpg");
			}
		}		
		return bookInfo;
	}
	
	/**
	 * 检索教材章节目录
	 */
	@Override
	public List<BookContent> getMenuList(BookContent bookContentPara) {
		
		return j030031Dao.getMenuList(bookContentPara);
		
	}
	
	/**
	 * 检索编辑者
	 */
	@Override
	public List<BookInfo> getUpdateUserList(BookContent bookContentPara) {

		return j030031Dao.getUpdateUserList(bookContentPara);
		
	}
	
	/**
	 * 检索发布者
	 */
	@Override
	public List<BookInfo> getCreateUserList(BookContent bookContentPara) {
	
		return j030031Dao.getCreateUserList(bookContentPara);
		
	}
	
	@Override
	public int bookUseCheck(String bookId) {

		return j030031Dao.bookUseCheck(bookId);
		
	}

	/**
	 * 删除教材及其相关内容
	 */
	@Override
	public boolean deleteBooks(String bookId) {
		
		// 排他检查
		Date updateTime = j030031Dao.getUpdateTime(bookInfo.getBookId());
		if(!ttCommonService.checkTimeStamp(TtConstants.PageId.J030031,  
				updateTime)){
			throw new TtExclusiveException();
		}

		if(!(// 书签表内容删除
			0 <= j030031Dao.deleteBookMark(bookId)&&
			// 教材内容表内容删除
			0 <= j030031Dao.deleteBookContent(bookId)&&
			// 教材资料表内容删除
			0 <= j030031Dao.deleteBookData(bookId)&&
			// 课程教材关联表内容删除
			0 <= j030031Dao.deleteCourseAndBook(bookId)&&
			// 教材表内容删除
			0 <= j030031Dao.deleteBookInfo(bookId)&&
			// 权限表内容删除
			0 <= j030031Dao.deleteUserRight(bookId)&&
			// 试卷表内容删除
			0 <= j030031Dao.deleteTestPaper(bookId))){
			return false;
		}
		return true;
	}

	/**
	 * 检索教材版本数
	 */
	@Override
	public int searchBookEditNum(String bookId) {

		return j030031Dao.searchBookEditNum(bookId);
		
	}

	/**
	 * 教材状态更新（批准）
	 */
	@Override
	public boolean updateRatifyBook(BookInfo bookInfo) {

		
		// 排他检查
		Date updateTime = j030031Dao.getUpdateTime(bookInfo.getBookId());
		if(!ttCommonService.checkTimeStamp(TtConstants.PageId.J030031,  
				updateTime)){
			throw new TtExclusiveException();
		}
		
		// 教材版本数检索
		if(1 == j030031Dao.searchBookEditNum(bookInfo.getBookId())){
			// 单版本教材表内容更新
			if(0 == j030031Dao.updateSingleVersionBook(bookInfo)){
				return false;
			}
		} else {
			// 旧版本教材及相关内容删除
			// 检索编辑号参数BEAN
			BookContent bookContentPara = new BookContent();
			bookContentPara.setBookId(bookInfo.getBookId());
			
			// 取得教材编辑号
			bookInfo.setEditNo((j030031Dao.getMinEditNo(bookContentPara)).getEditNo());
			if(!(// 旧版本教材内容表内容删除
				0 <= j030031Dao.deleteOldBookContent(bookInfo)&&
				// 旧版本教材资料表内容删除
				0 <= j030031Dao.deleteOldBookData(bookInfo)&&
				// 旧版本教材表内容删除
				0 <= j030031Dao.deleteOldBookInfo(bookInfo)&&
				// 旧版本试卷表内容删除
				0 <= j030031Dao.deleteOldTestPaper(bookInfo))){
				return false;
			}
			
			// 试卷表内容更新
			if(!(0 <= j030031Dao.updateTestPaper(bookInfo))){
				return false;
			}
			
			// 多版本教材表内容更新
			if (!(0 <= j030031Dao.updatePluralVersionBook(bookInfo))){
				return false;
			}
		}
		
		return true;
	}
	
	/**
	 * 教材状态更新（不批准）
	 */
	@Override
	public boolean updateRefuseBook(BookInfo bookInfo) {
		
		// 排他检查
		Date updateTime = j030031Dao.getUpdateTime(bookInfo.getBookId());
		if(!ttCommonService.checkTimeStamp(TtConstants.PageId.J030031,  
				updateTime)){
			throw new TtExclusiveException();
		}
		
		// 检索编辑号参数BEAN
		BookContent bookContentPara = new BookContent();
		bookContentPara.setBookId(bookInfo.getBookId());
		
		// 取得教材编辑号
		bookInfo.setEditNo((j030031Dao.getMaxEditNo(bookContentPara)).getEditNo());
		
		// 教材状态更新为不批准
		if(0 == j030031Dao.updateRefuseBook(bookInfo)){
			return false;
		}
		return true;
	}

	/**
	 * @param ttCommonService the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}

	/**
	 * @param dao the j030031Dao to set
	 */
	public void setJ030031Dao(J030031Dao j030031Dao) {
		
		this.j030031Dao = j030031Dao;
		
	}
}
