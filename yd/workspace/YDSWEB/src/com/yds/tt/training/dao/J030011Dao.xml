<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="J030011Dao">
	<typeAlias alias="BookInfo" type="com.yds.tt.training.bean.BookInfo"/>
	<typeAlias alias="AuthorityInfo" type="com.yds.tt.manager.bean.AuthorityInfo"/>
		
	<!-- 教材信息取得 --> 
		<select id="getBookInfo" parameterClass="String" resultClass="BookInfo"> 					
			SELECT
			  T1.BOOK_ID AS bookId,
			  T1.BOOK_NAME AS bookName,
			  T1.CATEGORY1_ID AS category1Id,
			  T1.CATEGORY2_ID AS category2Id,
			  T1.CATEGORY3_ID AS category3Id,
			  T1.EDIT_NO AS editNo,
			  T1.BOOK_STATUS AS bookStatus,
			  
			  (SELECT DIFF_NAME
			   FROM COM_CODE_MST   
			   WHERE TYPE_ID = 'R01'
                           AND DIFF_NO = T1.BOOK_STATUS
			   ) AS bookStatusName,
			   
			  T1.BELONG_COURSE_ID AS belongCourseId,
			  T2.USER_ID AS approverUserId,
			  
			  (SELECT USER_CNM 
			   FROM V_TT_USER
              WHERE USER_ID = T2.USER_ID
		           ) AS approverUserName,
		           
			  T1.QUOTE_FLAG AS quoteFlag,
			  
			  T1.UPDATE_TIME AS updateTime
			
			FROM TT_JIAOCAI T1 LEFT JOIN TT_QUANXIAN T2 
			ON T2.RELATEDOBJECT_ID = T1.BOOK_ID AND T2.AUTHORITY_ID ='11'
			WHERE T1.BOOK_ID = #bookId# 
			ORDER BY editNo desc
			LIMIT 1
		</select>
		
	<!-- 添加教材信息 --> 
		<insert id="insertBook" parameterClass="BookInfo">
			INSERT INTO TT_JIAOCAI
			   (
				BOOK_ID ,
				EDIT_NO ,
				BOOK_STATUS ,
				BOOK_NAME ,
				CATEGORY1_ID ,
				CATEGORY2_ID ,
				CATEGORY3_ID ,
				BELONG_COURSE_ID ,
				QUOTE_FLAG,
				CREATE_USER_ID,
				UPDATE_USER_ID,
				CREATE_TIME,
				UPDATE_TIME
			   )
			VALUES
			   (
				#bookId# ,
				'1' ,
				'1' ,
				#bookName# ,
				#category1Id# ,
				#category2Id# ,
				#category3Id# ,
				<isNull prepend="" property="belongCourseId">
				 '' ,
				</isNull>
				<isNotNull prepend="" property="belongCourseId">
				 #belongCourseId# ,
				</isNotNull>
				#quoteFlag#,
				#createUserId# ,
				#updateUserId#,
				NOW(),
				NOW()
			   );
		</insert>
		
		<!-- 添加课程教材关联信息 --> 
		<insert id="insertCourseBook" parameterClass="BookInfo">
			INSERT INTO TT_KECHENG_JIAOCAI
			   (
				COURSE_ID,
				BOOK_ID
			   )
			VALUES
			   (
				#belongCourseId# ,
				#bookId#
			   );
		</insert>

		<!-- 修改教材信息 --> 
		<update id="updateBook" parameterClass="BookInfo">
			UPDATE TT_JIAOCAI SET
				BOOK_NAME = #bookName# ,
				CATEGORY1_ID = #category1Id# ,
				CATEGORY2_ID = #category2Id# ,
				CATEGORY3_ID = #category3Id# ,
				QUOTE_FLAG = #quoteFlag#,
				UPDATE_USER_ID =#updateUserId#	,
				UPDATE_TIME =NOW()	
        WHERE 
	         BOOK_ID = #bookId# 
		AND  EDIT_NO = #editNo#
		</update>

		<!-- 创建课程所属分类信息取得 --> 
		<select id="getBelongCategory" parameterClass="String" resultClass="BookInfo"> 					
			SELECT
			  T1.CATEGORY1_ID AS category1Id,
			  T1.CATEGORY2_ID AS category2Id,
			  T1.CATEGORY3_ID AS category3Id
			
			FROM TT_KECHENG T1
			  
			WHERE T1.COURSE_ID = #belongCourseId#
		</select>		
		
		<!-- 最新时间取得 --> 
		<select id="getUpdateTime" parameterClass="BookInfo" resultClass="java.util.Date"> 
		SELECT 
			UPDATE_TIME AS updateTime
		FROM 
			TT_JIAOCAI
		WHERE
			BOOK_ID = #bookId# AND
			EDIT_NO = #editNo#
		FOR UPDATE
	</select>
</sqlMap>
