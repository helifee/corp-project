<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="TestingCommonDao">
	
	<typeAlias alias="k060031SearchInfo" type="com.yds.tt.testing.bean.K060031SearchInfo"/>
	<typeAlias alias="examEmployeeInfo" type="com.yds.tt.testing.bean.ExamEmployeeInfo"/>
	<typeAlias alias="testPaperInfo" type="com.yds.tt.testing.bean.TestPaperInfo"/>
	<typeAlias alias="paperBigQuestionInfo" type="com.yds.tt.testing.bean.PaperBigQuestionInfo"/>
	<typeAlias alias="paperRandomQuestionInfo" type="com.yds.tt.testing.bean.PaperRandomQuestionInfo"/>
	<typeAlias alias="k060031ExamQuestionInfo" type="com.yds.tt.testing.bean.K060031ExamQuestionInfo"/>
	<typeAlias alias="k060031SingleQuesInfo" type="com.yds.tt.testing.bean.K060031SingleQuesInfo"/>
	<typeAlias alias="paperStableQuestionInfo" type="com.yds.tt.testing.bean.PaperStableQuestionInfo"/>
	<typeAlias alias="testEmployeeAnswerInfo" type="com.yds.tt.testing.bean.TestEmployeeAnswerInfo"/>
	<typeAlias alias="markTaskAssignInfo" type="com.yds.tt.testing.bean.MarkTaskAssignInfo"/>
	<typeAlias alias="answerPointInfo" type="com.yds.tt.testing.bean.AnswerPointInfo"/>
						
	<!-- 员工考试信息主Key检索 -->
	<select id="getExamEmpInfo" parameterClass="examEmployeeInfo" resultClass="examEmployeeInfo"> 
		Select
			T1.PAPER_ID as paperId,
			T1.PAPER_VERSION_NO as paperVersionNo,
			T1.EMP_EXAM_STATUS as empExamStatus,
			T1.EXAMINE_START_TIME as examineStartTime,
			T1.EXAMINE_END_TIME as examineEndTime
		From tt_ks_yuangong T1
		WHERE T1.EMPLOYEES_ID = #employeesId#
		AND T1.EXAMINE_ID = #examineId#
		AND T1.EXAMINE_JOIN_TIMES = #examineJoinTimes#
	</select>
	
	<!-- 试卷基本信息检索 --> 
	<!-- 1.传试卷版本号（主key检索）；2.传最新标志取新旧版本试卷（练习用） --> 		
	<select id="getPaperBasicInfo" parameterClass="testPaperInfo" resultClass="testPaperInfo">
		Select
			T1.PAPER_ID AS paperId,
			T1.PAPER_VERSION_NO AS paperVersionNo,		
			T1.PAPER_TITLE AS paperTitle,
			T1.PAPER_DESCRIPTION AS paperDescription,
			T1.BIGQUESTION_NUM AS bigquestionNum
		From tt_shijuan T1
		WHERE T1.PAPER_ID = #paperId#
		<isNotEmpty prepend="AND" property="paperVersionNo"> 
			T1.PAPER_VERSION_NO = #paperVersionNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="newFlg"> 
			T1.NEW_FLG = #newFlg#
		</isNotEmpty>
	</select>
	
	<!-- 试卷大题信息List检索 -->
	<select id="getBigQuestionInfos" parameterClass="paperBigQuestionInfo" resultClass="paperBigQuestionInfo"> 
		Select
			T1.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T1.BIGQUESTION_ORDER AS bigquestionOrder,
			T1.BIGQUESTION_TITLE AS bigquestionTitle,
			T1.BIGQUESTION_DESCRIPTION AS bigquestionDescription,
			CONCAT_WS(':', T1.BIGQUESTION_TITLE, 
				T1.BIGQUESTION_DESCRIPTION) AS bigquestionTitleInfo,
			T1.QUESTION_KIND AS questionKind,
			T1.BIGQUESTION_TYPE AS bigquestionType,
			T1.BIGQUESTION_TIME AS bigquestionTime,
			T1.QUESTION_NUM AS questionNum,
			T1.ATUO_MARK_FLG AS atuoMarkFlg
		From tt_sj_datixinxi T1
		WHERE T1.PAPER_ID = #paperId#
		AND T1.PAPER_VERSION_NO = #paperVersionNo#
		ORDER BY T1.BIGQUESTION_ORDER ASC
	</select>
	
	<!-- 固定试题取得 -->
	<select id="getStableQuestions" parameterClass="java.util.HashMap" resultClass="k060031ExamQuestionInfo">
		Select
			T1.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T1.QUESTION_ORDER AS questionOrder,
			T1.QUESTION_ID AS questionId,
			
			<!-- 对应72号障害 -->
			T1.QUESTION_SCORE AS paperQuestionScore,
			
			T2.QUESTION_VERSION_NO AS questionVersionNo,
			T2.QUESTION_NUMBER AS questionNumber,
			T2.QUESTION_CONTENT AS questionContent,
			T1.QUESTION_SCORE_DETAILS AS questionScoreDetails
		From tt_sj_gudingdati T1
		Inner Join tt_tiku T2
		On T1.QUESTION_ID = T2.QUESTION_ID
		And NOW() >= T2.VERSION_START_TIME
		And T2.VERSION_END_TIME > NOW()
		AND T2.CHECK_FLG = '2'
		Where T1.PAPER_ID = #paperId#
		And T1.PAPER_VERSION_NO = #paperVersionNo#
		<isNotEmpty prepend="AND" property="bigquestionSerialNo">
			T1.BIGQUESTION_SERIAL_NO = #bigquestionSerialNo#
		</isNotEmpty>
		Order By T1.BIGQUESTION_SERIAL_NO ASC, T1.QUESTION_ORDER ASC
	</select>
	<!-- 固定试题答案取得 -->
	<select id="getStableAnswerInfos" parameterClass="java.util.HashMap" resultClass="k060031SingleQuesInfo">
		Select
			T1.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T1.QUESTION_ORDER AS questionOrder,
			T1.QUESTION_ID AS questionId,
			T3.ANSWER_SERIAL_NO AS answerSerialNo,
			T3.ANSWER_TYPE AS answerType,
			T3.ANSWER_QUES_NO AS answerQuesNo,
			T3.OPTION_NUMBER AS optionNumber,
			T3.OPTION_TYPE_ID AS optionTypeId,
			(Select DIFF_NAME 
				FROM com_code_mst 
				WHERE TYPE_ID = T3.OPTION_TYPE_ID
				AND DIFF_NO = T3.OPTION_TYPE) AS optionContent,
			T3.BLANK_NUMBER AS blankNumber,
			T3.WORD_LIMITS AS wordLimits
		From tt_sj_gudingdati T1
		Inner Join tt_tiku T2
		On T1.QUESTION_ID = T2.QUESTION_ID
		And NOW() >= T2.VERSION_START_TIME
		And T2.VERSION_END_TIME > NOW()
		AND T2.CHECK_FLG = '2'
		Inner Join tt_daan T3
		On T2.QUESTION_ID = T3.QUESTION_ID
		And T2.QUESTION_VERSION_NO = T3.QUESTION_VERSION_NO
		Where T1.PAPER_ID = #paperId#
		And T1.PAPER_VERSION_NO = #paperVersionNo#
		<isNotEmpty prepend="AND" property="bigquestionSerialNo">
			T1.BIGQUESTION_SERIAL_NO = #bigquestionSerialNo#
		</isNotEmpty>
		Order By T1.BIGQUESTION_SERIAL_NO ASC, T1.QUESTION_ORDER ASC, T3.ANSWER_SERIAL_NO
	</select>
	
	<!-- 试题随机条件取得 -->
	<select id="getRandomConditions" parameterClass="paperRandomQuestionInfo" resultClass="paperRandomQuestionInfo"> 
		Select
			T4.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T4.CONDITION_SERIAL_NO AS conditionSerialNo,
			T4.CATEGORY1_ID AS category1Id,
			T4.CATEGORY2_ID AS category2Id,
			T4.CATEGORY3_ID AS category3Id,
			T4.KEYWORD AS keyword,
			T4.QUESTION_DIFFICULTY AS questionDifficulty,
			T4.QUESTION_NUM AS questionNum,
			T4.QUESTION_SCORE AS questionScore
		From tt_sj_suijidati T4
		WHERE T4.PAPER_ID = #paperId#
		AND T4.PAPER_VERSION_NO = #paperVersionNo#
		AND T4.BIGQUESTION_SERIAL_NO = #bigquestionSerialNo#
		ORDER BY T4.CONDITION_SERIAL_NO
	</select>
	<!-- 随机试题取得 -->
	<select id="getRandomQuestions" parameterClass="paperRandomQuestionInfo" resultClass="k060031ExamQuestionInfo">
		Select
			T5.QUESTION_ID AS questionId,
			T5.QUESTION_VERSION_NO AS questionVersionNo,
			T5.QUESTION_NUMBER AS questionNumber,
			T5.QUESTION_CONTENT AS questionContent,
			T5.KEYWORD AS keyword
		From tt_tiku T5
		WHERE T5.QUESTION_TYPE = '1'
		AND T5.NEW_FLG = '2'
		AND T5.CHECK_FLG = '2'
		AND T5.QUESTION_KIND = #questionKind#
		AND T5.QUESTION_NUMBER = '1'
		<isNotEmpty property="category1Id"> 
			<isNotEqual property="category1Id" compareValue="0" prepend="AND">
				T5.CATEGORY1_ID = #category1Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category2Id"> 
			<isNotEqual property="category2Id" compareValue="0" prepend="AND">
				T5.CATEGORY2_ID = #category2Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category3Id"> 
			<isNotEqual property="category3Id" compareValue="0" prepend="AND">
				T5.CATEGORY3_ID = #category3Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty prepend="AND" open="(" close=")" property="keywordList">
			<iterate conjunction="AND" property="keywordList" >
					T5.KEYWORD LIKE CONCAT('%' , #keywordList[]#, '%')
			</iterate>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="questionDifficulty"> 
			T5.QUESTION_DIFFICULTY = #questionDifficulty#
		</isNotEmpty>
	</select>
	<!-- 随机试题答案取得 -->
	<select id="getRandomQuestionAnswers" parameterClass="paperRandomQuestionInfo" resultClass="k060031SingleQuesInfo">
		Select
			T1.QUESTION_ID AS questionId,
			T2.ANSWER_SERIAL_NO AS answerSerialNo,
			T2.ANSWER_TYPE AS answerType,
			T2.ANSWER_QUES_NO AS answerQuesNo,
			T2.OPTION_NUMBER AS optionNumber,
			T2.OPTION_TYPE_ID AS optionTypeId,
			(Select DIFF_NAME 
				FROM com_code_mst 
				WHERE TYPE_ID = T2.OPTION_TYPE_ID
				AND DIFF_NO = T2.OPTION_TYPE) AS optionContent
		From tt_tiku T1
		Inner Join tt_daan T2
		On T1.QUESTION_ID = T2.QUESTION_ID
		AND T1.QUESTION_VERSION_NO = T2.QUESTION_VERSION_NO
		WHERE T1.QUESTION_TYPE = '1'
		AND T1.NEW_FLG = '2'
		AND T1.CHECK_FLG = '2'
		AND T1.QUESTION_KIND = #questionKind#
		AND T1.QUESTION_NUMBER = '1'
		<isNotEmpty property="category1Id"> 
			<isNotEqual property="category1Id" compareValue="0" prepend="AND">
				T1.CATEGORY1_ID = #category1Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category2Id"> 
			<isNotEqual property="category2Id" compareValue="0" prepend="AND">
				T1.CATEGORY2_ID = #category2Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty property="category3Id"> 
			<isNotEqual property="category3Id" compareValue="0" prepend="AND">
				T1.CATEGORY3_ID = #category3Id#
			</isNotEqual>
		</isNotEmpty>
		<isNotEmpty prepend="AND" open="(" close=")" property="keywordList">
			<iterate conjunction="AND" property="keywordList" >
					T1.KEYWORD LIKE CONCAT('%' , #keywordList[]#, '%')
			</iterate>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="questionDifficulty"> 
			T1.QUESTION_DIFFICULTY = #questionDifficulty#
		</isNotEmpty>
		Order By T1.QUESTION_ID ASC, T2.ANSWER_SERIAL_NO ASC
	</select>
	
	<!-- 考试试题取得 -->
	<select id="getExamQuestions" parameterClass="java.util.HashMap" resultClass="k060031ExamQuestionInfo">
		Select
			T1.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T1.QUESTION_ORDER AS questionOrder,
			T1.QUESTION_ID AS questionId,
			T2.QUESTION_VERSION_NO AS questionVersionNo,
			T2.QUESTION_NUMBER AS questionNumber,
			T2.QUESTION_CONTENT AS questionContent
		From tt_ks_yuangong T3
		Inner Join tt_ks_shijuanshiti T1
		On T3.PAPER_ID = T1.PAPER_ID
		And T3.PAPER_VERSION_NO = T1.PAPER_VERSION_NO
		And T3.PAPER_CREATE_NO = T1.PAPER_CREATE_NO
		Inner Join tt_tiku T2
		On T1.QUESTION_ID = T2.QUESTION_ID
		And T3.PAPER_CREATE_TIME >= T2.VERSION_START_TIME
		And T2.VERSION_END_TIME > T3.PAPER_CREATE_TIME
		WHERE T3.EMPLOYEES_ID = #employeesId#
		AND T3.EXAMINE_ID = #examineId#
		AND T3.EXAMINE_JOIN_TIMES = #examineJoinTimes#
		Order By T1.BIGQUESTION_SERIAL_NO ASC, T1.QUESTION_ORDER ASC
	</select>
	<!-- 考试答案信息取得 -->
	<select id="getTestAnswerInfo" parameterClass="java.util.HashMap" resultClass="k060031SingleQuesInfo">
		Select
			T1.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			T1.QUESTION_ORDER AS questionOrder,
			T1.QUESTION_ID AS questionId,
			T1.QUESTION_SCORE AS paperQuestionScore,
			T1.QUESTION_SCORE_DETAILS AS questionScoreDetails,
			T2.QUESTION_VERSION_NO AS questionVersionNo,
			T2.QUESTION_SCORE AS questionScore,
			T4.ANSWER_SERIAL_NO AS answerSerialNo,
			T4.ANSWER_TYPE AS answerType,
			T4.ANSWER_QUES_NO AS answerQuesNo,
			T4.OPTION_NUMBER AS optionNumber,
			T4.OPTION_TYPE_ID AS optionTypeId,
			T4.ANSWER_CONTENT AS standardAnswer,
			T4.ATTACH_FILE_PATH AS attachFilePath,
			T4.ANSWER_SCORE AS answerScore,
			(Select DIFF_NAME 
				FROM com_code_mst 
				WHERE TYPE_ID = T4.OPTION_TYPE_ID
				AND DIFF_NO = T4.OPTION_TYPE) AS optionContent,
			T4.BLANK_NUMBER AS blankNumber,
			T4.WORD_LIMITS AS wordLimits,
			T5.MARK_FLG AS markFlg,
			T5.QUESTION_POINT AS questionPoint,
			T5.ANSWER_CONTENT AS answerContent
		From tt_ks_yuangong T3
		Inner Join tt_ks_shijuanshiti T1
		On T3.PAPER_ID = T1.PAPER_ID
		And T3.PAPER_VERSION_NO = T1.PAPER_VERSION_NO
		And T3.PAPER_CREATE_NO = T1.PAPER_CREATE_NO
		Inner Join tt_tiku T2
		On T1.QUESTION_ID = T2.QUESTION_ID
		And T3.PAPER_CREATE_TIME >= T2.VERSION_START_TIME
		And T2.VERSION_END_TIME > T3.PAPER_CREATE_TIME
		Inner Join tt_daan T4
		On T2.QUESTION_ID = T4.QUESTION_ID
		And T2.QUESTION_VERSION_NO = T4.QUESTION_VERSION_NO
		Left Join tt_ks_dajuan T5
		On T4.QUESTION_ID = T5.QUESTION_ID
		And T4.QUESTION_VERSION_NO = T5.QUESTION_VERSION_NO
		And T4.ANSWER_SERIAL_NO = T5.ANSWER_SERIAL_NO
		And T3.EXAMINE_ID = T5.EXAMINE_ID
		And T3.EMPLOYEES_ID = T5.EMPLOYEES_ID
		AND T3.EXAMINE_JOIN_TIMES = T5.EXAMINE_JOIN_TIMES
		AND T1.BIGQUESTION_SERIAL_NO = T5.BIGQUESTION_SERIAL_NO
		WHERE T3.EMPLOYEES_ID = #employeesId#
		AND T3.EXAMINE_ID = #examineId#
		AND T3.EXAMINE_JOIN_TIMES = #examineJoinTimes#
		Order By T1.BIGQUESTION_SERIAL_NO ASC, T1.QUESTION_ORDER ASC, T4.ANSWER_SERIAL_NO ASC
	</select>
	
	<!--取得得分点信息-->
	<select id="getAnswerPointInfos" resultClass="answerPointInfo" parameterClass="answerPointInfo">
		SELECT
		      POINT_SERIAL_NO AS pointSerialNo,
			  POINT_CONTENT AS pointContent,
			  POINT_SCORE AS pointScore
		FROM  TT_DEFENDIAN
		WHERE QUESTION_ID = #questionId#
	 	  AND QUESTION_VERSION_NO = #questionVersionNo#
		  AND ANSWER_SERIAL_NO = #answerSerialNo#
		  ORDER BY POINT_SERIAL_NO
	</select>
	
	<!--取得考生考试答案及得分信息-->
	<select id="getTestEmployeeAnswerInfo" parameterClass="testEmployeeAnswerInfo" resultClass="testEmployeeAnswerInfo">
		SELECT 
			EXAMINE_ID AS examineId,
			EMPLOYEES_ID AS employeesId,
			EXAMINE_JOIN_TIMES AS examineJoinTimes,
			BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			QUESTION_ID AS questionId,
			QUESTION_VERSION_NO AS questionVersionNo,
			ANSWER_SERIAL_NO AS answerSerialNo,
			QUESTION_FLG AS questionFlg,
			MARK_FLG AS markFlg,
			QUESTION_POINT AS questionPoint,
			MARKER_ID AS markerId,
			MARK_TIME AS markTime
		FROM TT_KS_DAJUAN
		WHERE EXAMINE_ID = #examineId# 
		  AND EMPLOYEES_ID = #employeesId# 
		  AND EXAMINE_JOIN_TIMES = #examineJoinTimes# 
		  AND BIGQUESTION_SERIAL_NO = #bigquestionSerialNo# 
		  AND QUESTION_ID = #questionId# 
		  AND QUESTION_VERSION_NO = #questionVersionNo# 
		  AND ANSWER_SERIAL_NO = #answerSerialNo# 
	</select>
	
	<!--插入考生考试答案信息-->
	<insert id="insertTestEmployeeAnswerInfo" parameterClass="testEmployeeAnswerInfo">
		INSERT INTO TT_KS_DAJUAN (	
			EXAMINE_ID,
			EMPLOYEES_ID,
			EXAMINE_JOIN_TIMES,
			BIGQUESTION_SERIAL_NO,
			QUESTION_ID,
			QUESTION_VERSION_NO,
			ANSWER_SERIAL_NO,
			QUESTION_FLG,
			MARK_FLG,
			QUESTION_POINT,
			MARKER_ID,
			MARK_TIME
		) VALUES (
			#examineId#,
			#employeesId#,
			#examineJoinTimes#,
			#bigquestionSerialNo#,
			#questionId#,
			#questionVersionNo#,
			#answerSerialNo#,
			#questionFlg#,
			#markFlg#,
			#questionPoint#,
			#markerId#,
			NOW()
		)
	</insert>
	
	<!--更新考试员工答案信息-->
	<update id="updateTestEmployeeAnswerInfo" parameterClass="testEmployeeAnswerInfo">
		UPDATE TT_KS_DAJUAN 
		SET 
			QUESTION_POINT = #questionPoint#,
			MARKER_ID = #markerId#,
			MARK_FLG = #markFlg#,
			MARK_TIME = NOW()
		WHERE EXAMINE_ID = #examineId# 
		  AND EMPLOYEES_ID = #employeesId# 
		  AND EXAMINE_JOIN_TIMES = #examineJoinTimes# 
		  AND BIGQUESTION_SERIAL_NO = #bigquestionSerialNo# 
		  AND QUESTION_ID = #questionId# 
		  AND QUESTION_VERSION_NO = #questionVersionNo# 
		  AND ANSWER_SERIAL_NO = #answerSerialNo#
	</update>
	
	<!--添加考试试卷关联-->
	<insert id="insertExaminePaperRelation" parameterClass="java.util.HashMap">
		INSERT INTO tt_ks_shijuang 
		(
			EXAMINE_ID,
			PAPER_ID
		) 
		VALUES 
		(
			#examineId#,
			#paperId#
		)	
	</insert>
		
	<!-- 取得关键字信息 -->
	<select id="getKeywordList" resultClass="String" parameterClass="java.util.HashMap">
		SELECT DISTINCT KEYWORD_NAME
		FROM TT_GUANJIANZI
		<isNotNull property="category1Id">
			<isNotEqual property="category1Id" compareValue="0">
				WHERE CATEGORY_ID = #category1Id#
			</isNotEqual>
		</isNotNull>
	</select>
</sqlMap>
