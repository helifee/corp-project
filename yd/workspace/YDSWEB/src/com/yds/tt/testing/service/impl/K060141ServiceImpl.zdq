/*
 * @(#) K060141ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试系统
 *    SubSystem: 考试子系统
 */
package com.yds.tt.testing.service.impl;

import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import net.sf.json.JSONObject;

import org.springframework.stereotype.Service;

import com.yds.base.service.AbstractBaseService;
import com.yds.common.service.SessionConstants;
import com.yds.tt.testing.bean.K060141SearchInfo;
import com.yds.tt.testing.dao.K060141Dao;
import com.yds.tt.testing.service.K060141Service;
import com.yds.tt.training.bean.CourseInfo;
import com.yds.util.service.Session;

/**
 * @see com.yds.tt.testing.service.K060141Service
 */
@Service("k060141Service")
public class K060141ServiceImpl extends AbstractBaseService implements
		K060141Service {

	private K060141Dao k060141Dao;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<CourseInfo> getSearchList(K060141SearchInfo searchInfo,
			int offset, int perCounts) {

		List<CourseInfo> searchList = k060141Dao.getSearchList(searchInfo,
				offset, perCounts);
		return searchList;
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public Long getTotalCount(K060141SearchInfo param) {

		return k060141Dao.getTotalCount(param);
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	@SuppressWarnings("unchecked")
	public void addCourse(JSONObject json) {

		// 取得examineId
		String examineId = Session.get(SessionConstants.TT_K060141_EXAMINEID)
				.toString();

		// 考试下已存在试卷检索
		List<String> hadCourses = k060141Dao.getHadCourses(examineId);

		// 需要通过考试设定
		Map<String, String> necessaryCourses = new HashMap<String, String>();

		// 取得画面选中考试
		Set<String> jsonSet = json.keySet();
		Iterator<String> jsonIterator = jsonSet.iterator();
		necessaryCourses.put("examineId", examineId);
		while (jsonIterator.hasNext()) {

			// 画面选中的试卷ID
			String necessaryCourseId = jsonIterator.next().trim();

			// 添加不存在的考试
			if (!hadCourses.contains(necessaryCourseId)) {
				necessaryCourses.put("necessaryCourseId", necessaryCourseId);
				k060141Dao.insertNecessaryCourses(necessaryCourses);
			}
		}
	}

	/**
	 * @param k060141Dao
	 *            the k060141Dao to set
	 */
	public void setK060141Dao(K060141Dao k060141Dao) {
		this.k060141Dao = k060141Dao;
	}

}
