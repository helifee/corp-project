<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K060081Dao">
	<typeAlias alias="k681examineInfo" type="com.yds.tt.testing.bean.ExamineInfo"/>
	<typeAlias alias="k681EnrollInfo" type="com.yds.tt.testing.bean.K060081EnrollInfo"/>
	<typeAlias alias="k681UpdateInfo" type="com.yds.tt.testing.bean.K060081UpdateInfo"/>

	<!-- 考试信息 -->
	<select id="getExamineInfo" resultClass="k681examineInfo" parameterClass="String">
		SELECT 	
			KS.EXAMINE_ID AS examineId ,
			KS.EXAMINE_NAME AS examineName,
			CONCAT(CASE KS.CATEGORY1_ID 
				WHEN 0 THEN ""
				ELSE 
					(SELECT CATEGORY_NAME 
					   FROM tt_fenlei
					  WHERE CATEGORY1_ID = KS.CATEGORY1_ID AND
							CATEGORY2_ID = 0 AND 
							CATEGORY3_ID = 0 AND
							CATEGORY_LEVEL = 1)
			END,
			CASE KS.CATEGORY2_ID
				WHEN 0 THEN ""
				ELSE CONCAT("-",(
					SELECT CATEGORY_NAME 
						FROM tt_fenlei
						WHERE CATEGORY1_ID = KS.CATEGORY1_ID AND 
							CATEGORY2_ID = KS.CATEGORY2_ID AND
							CATEGORY3_ID = 0 AND
							CATEGORY_LEVEL = 2))
			END ,
			CASE KS.CATEGORY3_ID
				WHEN 0 THEN ""
				ELSE CONCAT("-",(
					SELECT CATEGORY_NAME 
						FROM tt_fenlei t4 
						WHERE CATEGORY1_ID = KS.CATEGORY1_ID AND 
							CATEGORY2_ID = KS.CATEGORY2_ID AND
							CATEGORY3_ID = KS.CATEGORY3_ID AND
							CATEGORY_LEVEL = 3))
			END) AS categoryName,
			KS.EXAMINE_TIME AS examineTime,
			KS.EXAMINE_COMMENT AS examineComment, 
			KS.OBJECT_TYPE AS objectType, 
			KS.OBJECT_VALUE  AS objectValue, 
			KS.EXAMINE_START_TIME AS examineStartDate,
			KS.EXAMINE_END_TIME AS examineEndDate,
			KS.EXAMINE_STATUS AS examineStatus,
			KS.PARENT_EXAMINE_ID AS parentExamineId			
		FROM TT_KS_XINXI KS
		WHERE KS.EXAMINE_ID = #examineId#
	</select>
	
	<!-- 针对项目组的检索SQL -->
	<sql id="projectsql">
		SELECT
			ppu.PRO_ID AS userId,
			(SELECT USER_CNM
			 FROM V_TT_USER
			 WHERE USER_ID = ppu.PRO_ID 
			)AS userCnm,
			(SELECT YEAR(START_DATE)
			 FROM V_TT_USER
			 WHERE USER_ID = ppu.PRO_ID
			)AS startDate
	</sql>
	
	<!-- 针对个人的检索SQL -->
	<sql id="personsql">
		SELECT 
			<!-- tkd.EXAMINE_ID AS userId, -->
			tkd.EXAMINE_OBJECT_ID AS userId,
			(SELECT USER_CNM
			 FROM  V_TT_USER
			 WHERE tkd.EXAMINE_OBJECT_ID = USER_ID
			 )AS userCnm,
			(SELECT YEAR(START_DATE)
			FROM V_TT_USER
			WHERE tkd.EXAMINE_OBJECT_ID = USER_ID
			)AS startDate
	</sql>
	
	<!-- 只显示已报名 -->
	<!-- 取得已报名的员工信息 -->
	<select id="getArdEnrollInfo" parameterClass="k681examineInfo" resultClass="k681EnrollInfo">
		SELECT 
			tky.EMPLOYEES_ID AS userId,
			(SELECT USER_CNM
			 FROM  V_TT_USER
			 WHERE tky.EMPLOYEES_ID = USER_ID
			)AS userCnm,
			(SELECT YEAR(START_DATE)
			 FROM V_TT_USER
			 WHERE tky.EMPLOYEES_ID = USER_ID
			)AS startDate,			 
			tky.EMP_EXAM_STATUS AS diffNo,
			(SELECT DIFF_NAME
			 FROM COM_CODE_MST
			 WHERE TYPE_ID = 'R13'
				AND DIFF_NO = tky.EMP_EXAM_STATUS
			)AS diffName
		FROM TT_KS_YUANGONG tky
		WHERE tky.EXAMINE_ID = #examineId#
			AND tky.EXAMINE_JOIN_TIMES = 1
		ORDER BY 
			tky.EMP_EXAM_STATUS,
			tky.EMPLOYEES_ID
	</select>
	
	<!-- 取得员工已经考过的该考试下的试卷数 -->
	<select id="getPaperAmount" resultClass="Integer" parameterClass="k681UpdateInfo">
		SELECT COUNT(DISTINCT tky.PAPER_ID)
		FROM TT_KS_YUANGONG tky, TT_KS_SHIJUANG tks
		WHERE  tky.EXAMINE_ID = #examineId# 
			AND tky.EXAMINE_ID = tks.EXAMINE_ID
			AND tky.EMPLOYEES_ID = #userId#
			AND tky.PAPER_ID = tks.PAPER_ID
	</select>
	
	<!-- 取得该考试下的试卷数 -->
	<select id="getTestPaperAmount" parameterClass="String" resultClass="Integer">
		SELECT COUNT(EXAMINE_ID)
		FROM TT_KS_SHIJUANG
		WHERE EXAMINE_ID = #examineId# 
	</select>
	
	<!-- 添加考试员工信息 -->
	<insert id="insertEmployee" parameterClass="k681UpdateInfo">
		INSERT INTO TT_KS_YUANGONG 
			(EXAMINE_ID, 
			EMPLOYEES_ID, 
			EXAMINE_JOIN_TIMES, 
			EMP_EXAM_STATUS, 
			EXAMINE_START_TIME, 
			EXAMINE_END_TIME 
			)
			VALUES
			(#examineId#, 
			#userId#, 
			1, 
			2, 
			#examineStartDate#, 
			#examineEndDate# 
			);
	</insert>
	
	<!-- 更新考试员工信息 -->
	<update id="updateEmployee" parameterClass="k681UpdateInfo">
		UPDATE TT_KS_YUANGONG 
		SET
			EMP_EXAM_STATUS = #diffNo# 
		WHERE EXAMINE_ID = #examineId# 
			AND EMPLOYEES_ID = #userId#
			AND EXAMINE_JOIN_TIMES =1
	</update>
	
	<!-- 取得考试员工审批状态 -->
	<select id="getEmpexamstatus" resultClass="java.util.HashMap" parameterClass="String">
		SELECT EMP_EXAM_STATUS AS examStatus
		FROM TT_KS_YUANGONG
		WHERE EXAMINE_ID = #examineId#
			AND EXAMINE_JOIN_TIMES = 1
	</select>
	
	<!-- 更新考试信息表 -->
	<update id="updateExamineInfo" parameterClass="java.util.Map" >
		UPDATE TT_KS_XINXI
		SET EXAMINE_STATUS = #examineStatus#
		WHERE EXAMINE_ID = #examineId#
	</update>
	
 </sqlMap>  
