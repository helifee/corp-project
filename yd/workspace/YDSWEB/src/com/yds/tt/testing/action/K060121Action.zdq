/*
 * @(#) K060121Action.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试系统
 *    SubSystem: 考试子系统
 */
package com.yds.tt.testing.action;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.yds.base.action.AbstractBaseAction;
import com.yds.tt.manager.bean.TtCheckResult;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.testing.bean.K060121SearchInfo;
import com.yds.tt.testing.service.K060121Service;

/**
 * 考试评分任务详细
 * 
 * @author sundefu
 * @version 1.00 2010/07/06
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("k060121Action")
public class K060121Action extends AbstractBaseAction{

	private static final long serialVersionUID = 4216511199707607314L;
	private String examineId;							// 考试ID
	private K060121SearchInfo examineInfo;				//考试信息
	private List<K060121SearchInfo> examineInfoList;	//评分任务一览信息
	private String errorMessage;						//错误信息
	private int operatMode;								//评分任务分配方式
	private String missionId;							//评分任务id
	private boolean permission;                         //true:实施者；false：评分者 
	private TtCommonService ttCommonService;
	private K060121Service k060121Service;
	
	/**
	 * 画面的初期显示 考试评分详细信息取得
	 * 
	 * @return SUCCESS
	 */
	@Override
	public String execute() throws Exception{
		
		// 参数.考试ID未设定
		if(this.examineId == null){
			errorMessage = propMgr.getMessage("yds.com.warning.0001","考试ID");
			return ERROR;
		}
		
		// 画面启动限制检查
		TtCheckResult checkRS = checkStartUp();
		if(checkRS.getRetFlag()){
			
			//实施者检索处理
			this.setPermission(true);
			return searchInfo();
		}else {
			//初期检查处理(考试评分者检查)
			if(k060121Service.checkExamineMarker(examineId) == 0){
				//检索结果=0，表示用户不是该考试的评分者
				errorMessage = propMgr.getMessage("yds.tt.error.GTE02");
				return ERROR;
			}
			
			//评分者检索处理
			this.setPermission(false);
			return searchInfo();
		}
	}
	
	/**
	 * 画面启动权限检查
	 * 
	 * @return TtCheckResult 画面启动限制检查结果
	 */
	private TtCheckResult checkStartUp() {
		// 画面ID
		String pageId = TtConstants.PageId.K060121.value();
		// Event ID
		String eventId = "K060121";
		// 分类
		Integer category1Id = 0;
		Integer category2Id = 0;
		Integer category3Id = 0;
		// 检查类型：考试
		Integer typeId = TtConstants.C43.C43_3.value();
		// 检查对象列表：考试Id
		List<String> objectId = new ArrayList<String>();
		objectId.add(this.examineId.substring(0, 6) + "00");

		// 调用共通画面启动限制检查
		return ttCommonService.checkStartupAuthority(pageId, eventId,
				category1Id, category2Id, category3Id, typeId, objectId);
	}
	
	/**
	 * 检索处理
	 * 
	 * @return
	 */
	private String searchInfo(){
		
		//考试详细信息取得
		this.examineInfo = k060121Service.getExamineDetailInfo(examineId,this.permission);
		if(examineInfo == null){
			//检索结果=0,不继续处理
			errorMessage = propMgr.getMessage("yds.com.warning.0004","考试信息");
			return ERROR;
		}
		if(examineInfo.getMarkmissionFlg() == null){
			errorMessage = propMgr.getMessage("yds.com.warning.0004","考试评分方式");
			return ERROR;
		}
		//评分任务分配方式
		this.operatMode = examineInfo.getMarkmissionFlg();
		
		//评分任务信息取得
		this.examineInfoList = 
			k060121Service.getExamineDetailInfoList(examineId, operatMode, this.permission);
		
		return SUCCESS;
	}

	/**
	 * @return the examineId
	 */
	public String getExamineId() {
		return examineId;
	}

	/**
	 * @param examineId the examineId to set
	 */
	public void setExamineId(String examineId) {
		this.examineId = examineId;
	}

	/**
	 * @return the examineInfo
	 */
	public K060121SearchInfo getExamineInfo() {
		return examineInfo;
	}

	/**
	 * @param examineInfo the examineInfo to set
	 */
	public void setExamineInfo(K060121SearchInfo examineInfo) {
		this.examineInfo = examineInfo;
	}

	/**
	 * @return the examineInfoList
	 */
	public List<K060121SearchInfo> getExamineInfoList() {
		return examineInfoList;
	}

	/**
	 * @param examineInfoList the examineInfoList to set
	 */
	public void setExamineInfoList(List<K060121SearchInfo> examineInfoList) {
		this.examineInfoList = examineInfoList;
	}

	/**
	 * @return the errorMessage
	 */
	public String getErrorMessage() {
		return errorMessage;
	}

	/**
	 * @param errorMessage the errorMessage to set
	 */
	public void setErrorMessage(String errorMessage) {
		this.errorMessage = errorMessage;
	}

	/**
	 * @param ttCommonService the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}

	/**
	 * @param service the k060121Service to set
	 */
	public void setK060121Service(K060121Service service) {
		k060121Service = service;
	}

	/**
	 * @return the operatMode
	 */
	public int getOperatMode() {
		return operatMode;
	}

	/**
	 * @param operatMode the operatMode to set
	 */
	public void setOperatMode(int operatMode) {
		this.operatMode = operatMode;
	}

	/**
	 * @return the missionId
	 */
	public String getMissionId() {
		return missionId;
	}

	/**
	 * @param missionId the missionId to set
	 */
	public void setMissionId(String missionId) {
		this.missionId = missionId;
	}

	/**
	 * @return the permission
	 */
	public boolean isPermission() {
		return permission;
	}

	/**
	 * @param permission the permission to set
	 */
	public void setPermission(boolean permission) {
		this.permission = permission;
	}
}
