<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="K040021Dao">
    <typeAlias alias="QuestionInfo" type="com.yds.tt.testing.bean.QuestionInfo"/>
	<typeAlias alias="AnswerInfo" type="com.yds.tt.testing.bean.AnswerInfo"/>
	<typeAlias alias="AnswerPointInfo" type="com.yds.tt.testing.bean.AnswerPointInfo"/>

		<!-- 添加试题信息 --> 
		<insert id="insertQuestionInfo" parameterClass="QuestionInfo">
			INSERT INTO  TT_TIKU
				(
				QUESTION_ID ,
				QUESTION_VERSION_NO ,
				REF_QUESTION_ID ,
				QUESTION_TYPE ,
				QUESTION_NUMBER ,
				ATUO_MARK_FLG ,
				CATEGORY1_ID ,
				CATEGORY2_ID ,
				CATEGORY3_ID ,
				KEYWORD ,
				QUESTION_KIND ,
				QUESTION_DIFFICULTY ,
				QUESTION_SCORE ,
				QUESTION_SOURCE ,
				QUESTION_CONTENT ,
				PICTURE_FLG ,
				MEDIA_FLG ,
				ATTACH_FLG ,
				QUESTION_COMMENT ,
				CREATE_USER_ID ,
				CREATE_TIME ,
				UPDATE_USER_ID ,
				UPDATE_TIME 
			) VALUES (
				#questionId# ,
				#questionVersionNo# ,
				<isEmpty prepend="" property="refQuestionId">
				'' ,
				</isEmpty>
				<isNotEmpty prepend="" property="refQuestionId">
				#refQuestionId# ,
				</isNotEmpty>
				#questionType# ,
				#questionNumber# ,
				#atuoMarkFlg# ,
				#category1Id# ,
				#category2Id# ,
				#category3Id# ,
				#keyword# ,
				#questionKind# ,
				#questionDifficulty# ,
				#questionScore# ,
				#questionSource# ,
				#questionContent# ,
				<isEqual property="pictureFlg" compareValue="1">
				'1',
				</isEqual>
				<isEqual property="pictureFlg" compareValue="2">
				'2',
				</isEqual>
				<isEqual property="mediaFlg" compareValue="1">
				'1',
				</isEqual>
				<isEqual property="mediaFlg" compareValue="2">
				'2',
				</isEqual>
				<isEqual property="attachFlg" compareValue="1">
				'1',
				</isEqual>
				<isEqual property="attachFlg" compareValue="2">
				'2',
				</isEqual>
				#questionComment# ,
				#createUserId# ,
				NOW(),
				#updateUserId# ,
				NOW()
			);
		</insert>
		
		<!-- 添加答案信息 --> 
		<insert id="insertAnswerInfo" parameterClass="AnswerInfo">
			INSERT INTO TT_DAAN
				(
				QUESTION_ID ,
				QUESTION_VERSION_NO ,
				ANSWER_SERIAL_NO ,
				ANSWER_TYPE ,
				ANSWER_SCORE ,
				ANSWER_QUES_NO ,
				OPTION_TYPE_ID ,
				OPTION_TYPE ,
				OPTION_NUMBER ,
				BLANK_NUMBER ,
				ANSWER_CONTENT ,
				WORD_LIMITS ,
				ATTACH_FILE_PATH 
			) VALUES (
				#questionId# ,
				#questionVersionNo# ,
				#answerSerialNo# ,
				#answerType# ,
				#answerScore# ,
				#answerQuesNo# ,	
				<isEqual property="answerType" compareValue="1">
					'E02',
					</isEqual>
					<isEqual property="answerType" compareValue="2">
					'E02',
					</isEqual>
					<isEqual property="answerType" compareValue="3">
					'E03',
					</isEqual>
					<isEqual property="answerType" compareValue="4">
					'' ,
					</isEqual>
					<isEqual property="answerType" compareValue="5">
					'' ,
					</isEqual>
					<isEqual property="answerType" compareValue="6">
					'' ,
					</isEqual>
					<isEqual property="answerType" compareValue="7">
					'' ,
				</isEqual>
				#optionType# ,
				#optionNumber# ,
				#blankNumber# ,
				#answerContent# ,
				#wordLimits# ,
				#attachFilePath# 
			);
		</insert>
		
		<!-- 添加答案得分点信息 --> 
		<insert id="insertAnswerPointInfo" parameterClass="AnswerPointInfo">
			INSERT INTO TT_DEFENDIAN
				(
				QUESTION_ID ,
				QUESTION_VERSION_NO ,
				ANSWER_SERIAL_NO ,
				POINT_SERIAL_NO ,
				POINT_CONTENT ,
				POINT_SCORE 
			) VALUES (
				#questionId# ,
				#questionVersionNo# ,
				#answerSerialNo# ,
				#pointSerialNo# ,
				#pointContent# ,
				#pointScore# 
			);
		</insert>
		
		<!-- 关键字存在检索-->
		<select id="getKeyWordExist" parameterClass="QuestionInfo" resultClass="Integer">
			SELECT COUNT(*)
			FROM TT_GUANJIANZI T1
			WHERE T1.CATEGORY_ID = #category1Id#
			AND   T1.KEYWORD_NAME = #keyword#
		</select>
	
		<!-- 添加关键字 --> 
		<insert id="insertKeyWord" parameterClass="QuestionInfo">
			INSERT INTO TT_GUANJIANZI
			(
        		CATEGORY_ID ,
				KEYWORD_NAME 
			) VALUES (
				#category1Id# ,
				#keyword# 
			 );
		</insert>
		
		<!--试题信息检索 --> 		
		<select id="getQuestionInfo" parameterClass="questionInfo" resultClass="QuestionInfo"> 			
			SELECT 
				QUESTION_ID  AS questionId,
				QUESTION_VERSION_NO  AS  questionVersionNo,
				VERSION_START_TIME  AS  versionStartTime,
				VERSION_END_TIME  AS versionEndTime ,
				REF_QUESTION_ID  AS  refQuestionId,
				NEW_FLG  AS  newFlg,
				QUESTION_TYPE  AS  questionType,
				QUESTION_NUMBER  AS  questionNumber,
				ATUO_MARK_FLG  AS  atuoMarkFlg,
				CATEGORY1_ID  AS category1Id ,
				CATEGORY2_ID  AS  category2Id,
				CATEGORY3_ID  AS  category3Id,
				KEYWORD  AS  keyword,
				QUESTION_KIND  AS  questionKind,
				QUESTION_DIFFICULTY  AS  questionDifficulty,
				CHECK_FLG  AS  checkFlg,
				QUESTION_SCORE  AS  questionScore,
				QUESTION_TIMES  AS  questionTimes,
				ERROR_TIMES  AS errorTimes ,
				RIGHT_TIMES  AS  rightTimes,
				QUESTION_SOURCE  AS  questionSource,
				QUESTION_CONTENT  AS  questionContent,
				PICTURE_FLG  AS  pictureFlg,
				MEDIA_FLG  AS  mediaFlg,
				ATTACH_FLG  AS  attachFlg,
				QUESTION_COMMENT  AS  questionComment,
				CREATE_USER_ID  AS  createUserId,
				CREATE_TIME  AS  createTime,
				UPDATE_USER_ID  AS  updateUserId,
				UPDATE_TIME  AS  updateTime
			FROM  TT_TIKU
			WHERE QUESTION_ID = #questionId#	
			<isEqual property="questionMode" compareValue="7">
			AND QUESTION_VERSION_NO = #questionVersionNo#	
			</isEqual>
			<isNotEqual property="questionMode" compareValue="7">			
			AND NEW_FLG = '2'
			</isNotEqual> 	
		</select>
		
		<!--答案信息检索 --> 		
		<select id="getAnswerInfoList" parameterClass="answerInfo" resultClass="AnswerInfo"> 			
			SELECT 
				QUESTION_ID AS questionId ,
				QUESTION_VERSION_NO AS questionVersionNo ,
				ANSWER_SERIAL_NO AS answerSerialNo ,
				ANSWER_TYPE AS answerType ,
				ANSWER_SCORE AS  answerScore,
				ANSWER_QUES_NO AS answerQuesNo ,
				OPTION_TYPE_ID AS optionTypeId ,
				OPTION_TYPE AS  optionType,
				OPTION_NUMBER AS optionNumber ,
				BLANK_NUMBER AS blankNumber ,
				ANSWER_CONTENT AS  answerContent,
				WORD_LIMITS AS  wordLimits,
				ATTACH_FILE_PATH  AS attachFilePath
			FROM  TT_DAAN
			WHERE QUESTION_ID = #questionId#	
			AND QUESTION_VERSION_NO = #questionVersionNo#		
		</select>
				
		<!--答案得分点信息检索 --> 		
		<select id="getAnswerPointInfoList" parameterClass="answerPointInfo" resultClass="AnswerPointInfo"> 			
			SELECT         
				QUESTION_ID AS questionId ,
				QUESTION_VERSION_NO AS questionVersionNo ,
				ANSWER_SERIAL_NO AS  answerSerialNo,
				POINT_SERIAL_NO AS  pointSerialNo,
				POINT_CONTENT AS pointContent ,
				POINT_SCORE AS  pointScore
			FROM  TT_DEFENDIAN
			WHERE QUESTION_ID = #questionId#	
			  AND ANSWER_SERIAL_NO = #answerSerialNo#
			  AND QUESTION_VERSION_NO = #questionVersionNo#				
		</select>		
		
		<!-- 最新时间取得 --> 
		<select id="getUpdateTime" parameterClass="QuestionInfo" resultClass="java.util.Date"> 
		SELECT 
			UPDATE_TIME AS updateTime
		FROM 
			TT_TIKU
		WHERE
			QUESTION_ID = #questionId#
		AND QUESTION_VERSION_NO = #questionVersionNo#
		FOR UPDATE
		</select>
		
		<!-- 修改试题版本号 --> 
		<update id="updateQuestionVersionNo" parameterClass="QuestionInfo">
			UPDATE TT_TIKU SET
	        VERSION_END_TIME = NOW() ,
	        NEW_FLG = '1' 
        WHERE 
	        QUESTION_ID = #questionId#
	    AND QUESTION_VERSION_NO = #questionVersionNo# 
		</update>
		
		<!-- 修改试题信息 --> 
		<update id="updateQuestionInfo" parameterClass="QuestionInfo">
		 UPDATE tt_tiku SET
		 	<isEmpty prepend="" property="refQuestionId">
			REF_QUESTION_ID = '' ,
			</isEmpty>
			<isNotEmpty prepend="" property="refQuestionId">
			REF_QUESTION_ID = #refQuestionId# ,
			</isNotEmpty>	        
	        QUESTION_TYPE = #questionType# ,
	        QUESTION_NUMBER = #questionNumber# ,
	        ATUO_MARK_FLG = #atuoMarkFlg# ,
	        CATEGORY1_ID = #category1Id# ,
	        CATEGORY2_ID = #category2Id# ,
	        CATEGORY3_ID = #category3Id# ,
	        KEYWORD = #keyword# ,
	        QUESTION_KIND = #questionKind# ,
	        QUESTION_DIFFICULTY = #questionDifficulty# ,
	        CHECK_FLG = #checkFlg# ,
	        QUESTION_SCORE = #questionScore# ,
	        QUESTION_SOURCE = #questionSource# ,
	        QUESTION_CONTENT = #questionContent# ,
			<isEqual property="pictureFlg" compareValue="1">
			PICTURE_FLG = '1',
			</isEqual>
			<isEqual property="pictureFlg" compareValue="2">
			PICTURE_FLG = '2',
			</isEqual>
			<isEqual property="mediaFlg" compareValue="1">
			MEDIA_FLG = '1',
			</isEqual>
			<isEqual property="mediaFlg" compareValue="2">
			MEDIA_FLG = '2',
			</isEqual>
			<isEqual property="attachFlg" compareValue="1">
			ATTACH_FLG = '1',
			</isEqual>
			<isEqual property="attachFlg" compareValue="2">
			ATTACH_FLG = '2',
			</isEqual>
	        QUESTION_COMMENT = #questionComment# ,
	        UPDATE_USER_ID = #updateUserId# ,
	        UPDATE_TIME = NOW()
        WHERE 
	        QUESTION_ID = #questionId#
	    AND QUESTION_VERSION_NO = #questionVersionNo# 
		</update>
		
		<!-- 删除答案信息 -->
		<delete id="deleteAnswerInfo" parameterClass="AnswerInfo">
			DELETE 
			FROM 
				tt_daan
			WHERE 
	        	QUESTION_ID = #questionId#
			AND QUESTION_VERSION_NO = #questionVersionNo#
		</delete>
		
		<!-- 删除答案得分点信息 -->
		<delete id="deleteAnswerPointInfo" parameterClass="AnswerPointInfo">
			DELETE 
			FROM 
				tt_defendian
			WHERE 
	        	QUESTION_ID = #questionId#
			AND QUESTION_VERSION_NO = #questionVersionNo#
		</delete>
		
		<!-- 试卷分类信息取得 --> 
		<select id="getPaperCategory" parameterClass="String" resultClass="QuestionInfo"> 					
			SELECT
			  T1.CATEGORY1_ID AS category1Id,
			  T1.CATEGORY2_ID AS category2Id,
			  T1.CATEGORY3_ID AS category3Id
			
			FROM TT_SHIJUAN T1
			  
			WHERE T1.PAPER_ID = #paperId#
		</select>	
</sqlMap>