/*
 * @(#) K050051ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试培训系统
 *    SubSystem: 考试子系统
 */
package com.yds.tt.testing.service.impl;

import java.util.List;

import org.springframework.stereotype.Service;

import com.yds.base.service.AbstractBaseService;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtCommonUtil;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.manager.service.TtExclusiveException;
import com.yds.tt.testing.bean.PaperBigQuestionInfo;
import com.yds.tt.testing.bean.PaperRandomQuestionInfo;
import com.yds.tt.testing.bean.PaperStableQuestionInfo;
import com.yds.tt.testing.bean.TestPaperInfo;
import com.yds.tt.testing.dao.K050051Dao;
import com.yds.tt.testing.service.K050051Service;

/**
 * @see com.yds.tt.testing.service.K050051Service
 */
@Service("k050051Service")
public class K050051ServiceImpl extends AbstractBaseService implements
		K050051Service {
	private K050051Dao k050051Dao;
	
	// 共通
	private TtCommonService ttCommonService;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public TestPaperInfo getTestPaperInfo(TestPaperInfo testpager) {
		
		TestPaperInfo testPaperInfo = k050051Dao.getTestPaperInfo(testpager);
		
		if (null != testPaperInfo) {
			ttCommonService.setTimestamp(TtConstants.PageId.K050051, testPaperInfo
					.getUpdateTime());
			
		}
		return testPaperInfo;
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<PaperBigQuestionInfo> getPaperBigQuestionInfo(
			TestPaperInfo testpager) {

		// 取得大题信息列表
		List<PaperBigQuestionInfo> paperBigQueInfoList = k050051Dao
				.getPaperBigQuestionInfo(testpager);

		// 将大题信息中设置固定大题和随机大题
		for (PaperBigQuestionInfo paperBigQue : paperBigQueInfoList) {
			
			if (paperBigQue.getBigquestionType() == TtConstants.R11.R11_1.value()) {
				List<PaperStableQuestionInfo> paperBigQueList = k050051Dao
					.getPaperStableQuestionInfoList(paperBigQue);
		
				paperBigQue.setStableQueInfoList(paperBigQueList);
			} else if (paperBigQue.getBigquestionType() == TtConstants.R11.R11_2.value()) {
				List<PaperRandomQuestionInfo> paperRandomQueInfoList = k050051Dao
					.getPaperRandomQuestionInfoList(paperBigQue);
				
				paperBigQue.setRandomQueInfoList(paperRandomQueInfoList);
			}
		}
		
		return paperBigQueInfoList;
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public TestPaperInfo getUpdateTime(TestPaperInfo testPaper) {

		return k050051Dao.getUpdateTime(testPaper);
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void updateApproveTestPaper(TestPaperInfo testPaper,TestPaperInfo checkTime) {

		// 排他检查
		checkTimeStamp(checkTime);
		
		// 取得用户ID
		String applyUserId = TtCommonUtil.getLoginUserId();
		testPaper.setApplyUserId(applyUserId);
		k050051Dao.updateApproveTestPaper(testPaper);
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void updateDisApproveTestPaper(TestPaperInfo testPaper,TestPaperInfo checkTime) {

		// 排他检查
		checkTimeStamp(checkTime);
		
		// 取得用户ID
		String applyUserId = TtCommonUtil.getLoginUserId();

		testPaper.setApplyUserId(applyUserId);
		k050051Dao.updateDisApproveTestPaper(testPaper);
	}
	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public void checkTimeStamp(TestPaperInfo checkTime) {
		if(ttCommonService.checkTimeStamp(TtConstants.PageId.K050051,  
				checkTime.getUpdateTime()) == false){

			throw new TtExclusiveException();
		}
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void deleteTestPaper(TestPaperInfo testPaper,TestPaperInfo checkTime) {
		
		// 排他检查
		checkTimeStamp(checkTime);
		k050051Dao.deleteTestPaper(testPaper);
	}

	/**
	 * @param k050051Dao
	 *            the k050051Dao to set
	 */
	public void setK050051Dao(K050051Dao k050051Dao) {
		this.k050051Dao = k050051Dao;
	}
	
	/**
	 * @param ttCommonService the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}
	
}
