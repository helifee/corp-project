/*
 * @(#) K050041ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 考试系统
 */
package com.yds.tt.testing.service.impl;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import net.sf.json.JSONObject;

import org.springframework.stereotype.Service;

import com.yds.tt.testing.bean.AnswerInfo;
import com.yds.tt.testing.bean.PaperBigQuestionInfo;
import com.yds.tt.testing.bean.PaperRandomQuestionInfo;
import com.yds.tt.testing.bean.PaperStableQuestionInfo;
import com.yds.tt.testing.dao.K050041Dao;
import com.yds.tt.testing.service.K050041Service;

/**
 * @see com.yds.tt.testing.service.K040011Service
 */
@Service("k050041Service")
public class K050041ServiceImpl implements K050041Service {

	private K050041Dao k050041Dao;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void getQuestionCount(List<PaperRandomQuestionInfo> prqInfoList) {
		for (PaperRandomQuestionInfo prqInfo : prqInfoList) {
			prqInfo.setQuestionBaseCount(k050041Dao.getQuestionCount(prqInfo));
		}
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public Long getQuestionCount(PaperRandomQuestionInfo prqInfo) {
		return k050041Dao.getQuestionCount(prqInfo);
	}

	/**
	 * {@inheritDoc}
	 */
	@SuppressWarnings("unchecked")
	@Override
	public void editQuestionInfo(PaperBigQuestionInfo pbqInfo, JSONObject json) {
		// 画面的试卷ID
		List<String> pageQuestionId = new ArrayList<String>();
		// 试题数量
		int maxNum = 0;
		// 试卷ID
		String paperId = pbqInfo.getPaperId();
		// 试卷版本号
		Integer paperVersionNo = pbqInfo.getPaperVersionNo();
		// 大题编号
		Integer bigquestionSerialNo = pbqInfo.getBigquestionSerialNo();
		// 固定大题
		List<PaperStableQuestionInfo> psqInfoList = pbqInfo
				.getStableQueInfoList();
		if (psqInfoList != null) {
			maxNum = psqInfoList.size();
			for (int i = 0; i < psqInfoList.size(); i++) {
				pageQuestionId.add(psqInfoList.get(i).getQuestionId().trim());
			}
		} else {
			psqInfoList = new ArrayList<PaperStableQuestionInfo>();
		}
		Set<String> jsonSet = json.keySet();
		Iterator<String> jsonIterator = jsonSet.iterator();

		// 去除重复之后的试卷ID
		List<String> addQuestionId = new ArrayList<String>();
		// 去除重复之后的试卷信息
		List<PaperStableQuestionInfo> addQuestionInfos;

		while (jsonIterator.hasNext()) {
			String jsonPaperId = jsonIterator.next().trim();
			if (!pageQuestionId.contains(jsonPaperId)) {
				addQuestionId.add(jsonPaperId);
			}
		}

		if (addQuestionId.size() > 0) {
			// 检索试卷信息
			addQuestionInfos = k050041Dao.getQuestionInfos(addQuestionId);

			// 追加到画面试卷一览的最后行
			for (PaperStableQuestionInfo addQuestionInfo : addQuestionInfos) {
				// 设定试卷ID，试卷版本号，大题编号
				addQuestionInfo.setPaperId(paperId);
				addQuestionInfo.setPaperVersionNo(paperVersionNo);
				addQuestionInfo.setBigquestionSerialNo(bigquestionSerialNo);
				addQuestionInfo.setQuestionOrder(maxNum + 1);
				psqInfoList.add(addQuestionInfo);
				maxNum++;
			}
		}
		// 重新计算试题数量，大题分数
		int queNum = 0;
		int queScore = 0;
		for (PaperStableQuestionInfo psqInfo : psqInfoList) {
			// 设定试卷ID，试卷版本号，大题编号
			queNum++;
			queScore = queScore + psqInfo.getQuestionScore();
		}
		pbqInfo.setQuestionNum(queNum);
		pbqInfo.setBigquestionTotalScore(queScore);
		pbqInfo.setStableQueInfoList(psqInfoList);
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<AnswerInfo> getAnswerInfo(String questionId) {
		return k050041Dao.getAnswerInfo(questionId);
	}

	/**
	 * @param dao
	 *            the k050041Dao to set
	 */
	public final void setK050041Dao(K050041Dao dao) {
		k050041Dao = dao;
	}

}
