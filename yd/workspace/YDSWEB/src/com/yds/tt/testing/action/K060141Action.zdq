/*
 * @(#) K060141Action.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试系统
 *    SubSystem: 考试子系统
 */
package com.yds.tt.testing.action;

import java.util.ArrayList;
import java.util.List;

import net.sf.json.JSONObject;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.opensymphony.xwork2.interceptor.annotations.InputConfig;
import com.yds.base.action.BasePagerAction;
import com.yds.common.service.SessionConstants;
import com.yds.tt.manager.bean.TtCheckResult;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.testing.bean.K060141SearchInfo;
import com.yds.tt.testing.service.K060141Service;
import com.yds.tt.training.bean.CourseInfo;
import com.yds.util.service.Session;

/**
 * 课程选择
 * 
 * @author liyanrui
 * @version 1.00 2010/04/16
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("k060141Action")
public class K060141Action extends BasePagerAction {

	private static final long serialVersionUID = 2987247380112344275L;
	private K060141Service k060141Service;
	private TtCommonService ttCommonService;
	// 画面检索条件
	private K060141SearchInfo searchInfo;

	// 参数一级分类ID
	private Integer category1Id;

	// 参数二级分类ID
	private Integer category2Id;

	// 参数三级分类ID
	private Integer category3Id;

	// 考试一览信息列表
	private List<CourseInfo> searchInfoList;

	// 父画面考试ID
	private String parenetId;

	// 选中课程ID
	private String checkBoxIdStatusJson;

	// 错误信息
	private String errorMessage;

	/**
	 * 取得课程一览初始化信息列表
	 * 
	 * @return ERROR
	 * @return SUCCESS
	 */
	@Override
	@InputConfig(resultName = "error")
	public String execute() throws Exception {

		// 画面启动控制检查
		this.checkAuthority();
		// 设置父画面考试ID
		Session.set(SessionConstants.TT_K060141_EXAMINEID, this.parenetId);
		// 画面初期检索
		super.setPagerParamter(k060141Service.getTotalCount(searchInfo),
				"k060141GetCourseList.action");
		searchInfoList = k060141Service.getSearchList(searchInfo, pager
				.getOffset().intValue(), pager.getPerDisplayCount().intValue());

		return SUCCESS;
	}

	/**
	 * 取得课程一览信息列表
	 * 
	 * @return ERROR
	 * @return SUCCESS
	 */
	@InputConfig(resultName = "error")
	public String searchList() throws Exception {

		// 画面启动控制检查
		this.checkAuthority();
		// 开始时间与结束时间入力判断
		if (null != searchInfo.getUpdateTimeStart()
				&& null != searchInfo.getUpdateTimeEnd()) {

			/** 开始时间结束时间大小校验. */
			if (0 < (searchInfo.getUpdateTimeStart().compareTo(searchInfo
					.getUpdateTimeEnd()))) {
				this.addFieldError("searchInfo.updateTimeStart", propMgr
						.getMessage("yds.tt.error.JYE05", searchInfo
								.getCourseName()));
				this.addFieldError("searchInfo.updateTimeEnd", propMgr
						.getMessage("yds.tt.error.JYE05", searchInfo
								.getCourseName()));
			}
		}

		// 设置画面取得的一级分类ID、二级分类ID、三级分类ID
		if (category1Id != null) {
			searchInfo.setCategory1Id(category1Id);
			searchInfo.setCategory2Id(category2Id);
			searchInfo.setCategory3Id(category3Id);
		}

		super.setPagerParamter(k060141Service.getTotalCount(searchInfo),
				"k060141GetCourseList.action");
		searchInfoList = k060141Service.getSearchList(searchInfo, pager
				.getOffset().intValue(), pager.getPerDisplayCount().intValue());

		return SUCCESS;
	}

	/**
	 * 添加需要学习课程
	 * 
	 * @return SUCCESS
	 */
	@InputConfig(resultName = "error")
	public String addCourse() throws Exception {

		// 画面启动检查
		TtCheckResult checkResult = checkAuthority();
		// 无权限
		if (!checkResult.getRetFlag()) {
			errorMessage = checkResult.getRetMessage();
			if ("GTE01".equals(checkResult.getErrLevel())) {
				return LOGIN;
			} else {
				return ERROR;
			}
		}

		// 取得画面教材选中信息
		JSONObject json = JSONObject.fromObject(checkBoxIdStatusJson);

		// 将所选试卷加入考试试卷关联表中
		k060141Service.addCourse(json);

		this.errorMessage = SUCCESS;
		return SUCCESS;
	}

	/**
	 * 校验是否存在参数idName
	 * 
	 */
	public void validateExecute() {

		if (null == parenetId || "".equals(parenetId)) {
			setErrorMessage(propMgr.getMessage("yds.tt.error.JYE07"));
			this.addActionError("error");
		}
	}

	/**
	 * 画面启动控制检查
	 * 
	 * @param mode
	 *            画面启动模式
	 * 
	 */
	private TtCheckResult checkAuthority() {

		List<String> objectId = new ArrayList<String>();

		// 权限检查
		TtCheckResult checkResult = ttCommonService.checkStartupAuthority(
				TtConstants.PageId.K050021.value(), "K060141", 0, objectId);

		return checkResult;
	}

	/**
	 * @param service
	 *            the k060141Service to set
	 */
	public void setK060141Service(K060141Service service) {
		k060141Service = service;
	}

	/**
	 * @param ttCommonService
	 *            the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}

	/**
	 * @return the searchInfo
	 */
	public K060141SearchInfo getSearchInfo() {
		return searchInfo;
	}

	/**
	 * @param searchInfo
	 *            the searchInfo to set
	 */
	public void setSearchInfo(K060141SearchInfo searchInfo) {
		this.searchInfo = searchInfo;
	}

	/**
	 * @return the category1Id
	 */
	public Integer getCategory1Id() {
		return category1Id;
	}

	/**
	 * @param category1Id
	 *            the category1Id to set
	 */
	public void setCategory1Id(Integer category1Id) {
		this.category1Id = category1Id;
	}

	/**
	 * @return the category2Id
	 */
	public Integer getCategory2Id() {
		return category2Id;
	}

	/**
	 * @param category2Id
	 *            the category2Id to set
	 */
	public void setCategory2Id(Integer category2Id) {
		this.category2Id = category2Id;
	}

	/**
	 * @return the category3Id
	 */
	public Integer getCategory3Id() {
		return category3Id;
	}

	/**
	 * @param category3Id
	 *            the category3Id to set
	 */
	public void setCategory3Id(Integer category3Id) {
		this.category3Id = category3Id;
	}

	/**
	 * @return the searchInfoList
	 */
	public List<CourseInfo> getSearchInfoList() {
		return searchInfoList;
	}

	/**
	 * @param searchInfoList
	 *            the searchInfoList to set
	 */
	public void setSearchInfoList(List<CourseInfo> searchInfoList) {
		this.searchInfoList = searchInfoList;
	}

	/**
	 * @return the parenetId
	 */
	public String getParenetId() {
		return parenetId;
	}

	/**
	 * @param parenetId
	 *            the parenetId to set
	 */
	public void setParenetId(String parenetId) {
		this.parenetId = parenetId;
	}

	/**
	 * @return the checkBoxIdStatusJson
	 */
	public String getCheckBoxIdStatusJson() {
		return checkBoxIdStatusJson;
	}

	/**
	 * @param checkBoxIdStatusJson
	 *            the checkBoxIdStatusJson to set
	 */
	public void setCheckBoxIdStatusJson(String checkBoxIdStatusJson) {
		this.checkBoxIdStatusJson = checkBoxIdStatusJson;
	}

	/**
	 * @return the errorMessage
	 */
	public String getErrorMessage() {
		return errorMessage;
	}

	/**
	 * @param errorMessage
	 *            the errorMessage to set
	 */
	public void setErrorMessage(String errorMessage) {
		this.errorMessage = errorMessage;
	}

}
