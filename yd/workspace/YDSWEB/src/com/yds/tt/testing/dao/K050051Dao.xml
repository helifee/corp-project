<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" 
"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="k050051Dao">
	<typeAlias alias="k050051TestPaperInfo" type="com.yds.tt.testing.bean.TestPaperInfo"/>
	<typeAlias alias="k050051PaperBigQuestionInfo" type="com.yds.tt.testing.bean.PaperBigQuestionInfo"/>
	<typeAlias alias="k050051PaperStableQueInfo" type="com.yds.tt.testing.bean.PaperStableQuestionInfo"/>
	<typeAlias alias="k050051questionLibrary" type="com.yds.tt.testing.bean.QuestionLibrary"/>
	<typeAlias alias="k050051RandomQuestionInfo" type="com.yds.tt.testing.bean.PaperRandomQuestionInfo"/>
	
	<!--获取试卷信息-->
	<select id="getK050051TestPaperInfo" parameterClass="k050051TestPaperInfo" resultClass="k050051TestPaperInfo">
		SELECT 
			PAPER_VERSION_NO AS paperVersionNo,
			PAPER_TITLE AS paperTitle,
			PAPER_ID  AS paperId,
			PAPER_TYPE  AS paperType,
			(select 
				DIFF_NAME 
			 from  com_code_mst 
			 where TYPE_ID ='R02' 
				AND DIFF_NO = tt_shijuan.PAPER_TYPE 
			) AS paperTypeName,
			CONCAT(CASE CATEGORY1_ID 
			WHEN 0 THEN "" ELSE 
			(SELECT 
				CATEGORY_NAME 
			 FROM tt_fenlei
				WHERE CATEGORY1_ID = tt_shijuan.CATEGORY1_ID 
					AND CATEGORY_LEVEL = 1
			)END,
			CASE CATEGORY2_ID
			WHEN 0 THEN "" ELSE CONCAT("-",
			(SELECT 
				CATEGORY_NAME 
			 FROM tt_fenlei
				WHERE CATEGORY1_ID = tt_shijuan.CATEGORY1_ID 
					AND CATEGORY2_ID = tt_shijuan.CATEGORY2_ID 
					AND CATEGORY_LEVEL = 2)
			) END ,
			CASE CATEGORY3_ID
			WHEN 0 THEN "" ELSE CONCAT("-",
			(SELECT 
				CATEGORY_NAME 
			 FROM tt_fenlei 
				WHERE CATEGORY1_ID = tt_shijuan.CATEGORY1_ID 
					AND CATEGORY2_ID = tt_shijuan.CATEGORY2_ID 
					AND CATEGORY3_ID = tt_shijuan.CATEGORY3_ID 
					AND CATEGORY_LEVEL = 3)
			)END) AS categoryName,
			PAPER_COMMENT AS paperComment,
			(select 
				DIFF_NAME 
			 from  com_code_mst 
			 where TYPE_ID ='R10' 
				AND DIFF_NO = tt_shijuan.PAPER_STATUS
			) AS paperStatusName,
			PAPER_STATUS AS paperStatus,
			PAPER_TOTAL_SCORE AS paperTotalScore,
			PAPER_TIME AS paperTime,
			BIGQUESTION_NUM AS bigquestionNum,
			REFUSE_REASON AS refuseReason,
			UPDATE_TIME AS updateTime,
			PAPER_DESCRIPTION AS paperDescription
		FROM tt_shijuan
		WHERE PAPER_ID = #paperId# 
			<isEqual compareProperty="mode" compareValue="9" prepend="AND">
				PAPER_VERSION_NO = #paperVersionNo#
				AND PAPER_STATUS = 3
			</isEqual>
			<isEqual compareProperty="mode" compareValue="8" prepend="AND">
				NEW_FLG = 1
				AND PAPER_STATUS = 2
			</isEqual>
			<isNotEqual compareProperty="mode" compareValue="9">
				<isNotEqual compareProperty="mode" compareValue="8">
					AND NEW_FLG = 1
				</isNotEqual>
			</isNotEqual>
	</select>
	
	<!-- 获取大题信息表信息 -->
	<select id="getK050051BigQueList" parameterClass="k050051TestPaperInfo" 
		resultClass="k050051PaperBigQuestionInfo">
		SELECT 
			PAPER_ID AS paperId,
			PAPER_VERSION_NO AS paperVersionNo,
			BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			BIGQUESTION_ORDER AS bigquestionOrder,
			(select 
				DIFF_NAME 
			 from  com_code_mst
			 where TYPE_ID ='R03' 
				AND DIFF_NO = QUESTION_KIND
			) AS questionKindName,
			BIGQUESTION_TITLE AS bigquestionTitle,
			BIGQUESTION_DESCRIPTION AS bigquestionDescription,
			QUESTION_NUM AS questionNum,
			BIGQUESTION_TOTAL_SCORE AS bigquestionTotalScore,
			BIGQUESTION_TYPE AS bigquestionType,
			(select 
				DIFF_NAME 
			 from  com_code_mst
			 where TYPE_ID ='R11' 
				AND DIFF_NO = BIGQUESTION_TYPE
			) AS bigquestionTypeName
			
		FROM tt_sj_datixinxi
		WHERE PAPER_ID = #paperId# 
			AND PAPER_VERSION_NO = #paperVersionNo#
			ORDER BY BIGQUESTION_ORDER ASC
	</select>
	
	<!-- 获取试卷固定大题信息 -->
	<select id="getK050051DudingDatiInfo" parameterClass="k050051PaperBigQuestionInfo" 
		resultClass="k050051PaperStableQueInfo">
		SELECT 
			tsj.PAPER_ID AS paperId,
			tsj.PAPER_VERSION_NO AS paperVersionNo,
			tsj.BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			tsj.QUESTION_ID AS questionId,
			tsj.QUESTION_ORDER,
			tsj.QUESTION_SCORE AS questionScore,
			CONCAT(CASE CATEGORY1_ID 
			WHEN 0 THEN "" ELSE 
			(SELECT 
				CATEGORY_NAME 
			 FROM tt_fenlei
			WHERE CATEGORY1_ID = tk.CATEGORY1_ID 
				AND CATEGORY_LEVEL = 1)
			END,
			CASE CATEGORY2_ID
			WHEN 0 THEN "" ELSE CONCAT("-",
			(SELECT 
				CATEGORY_NAME 
			FROM tt_fenlei
			WHERE CATEGORY1_ID = tk.CATEGORY1_ID 
				AND CATEGORY2_ID = tk.CATEGORY2_ID 
				AND CATEGORY_LEVEL = 2))
			END ,
			CASE CATEGORY3_ID
			WHEN 0 THEN "" ELSE CONCAT("-",
			(SELECT 
				CATEGORY_NAME 
			FROM tt_fenlei 
			WHERE CATEGORY1_ID = tk.CATEGORY1_ID 
				AND CATEGORY2_ID = tk.CATEGORY2_ID 
				AND CATEGORY3_ID = tk.CATEGORY3_ID 
				AND CATEGORY_LEVEL = 3))
			END) AS categoryName,
			tk.KEYWORD AS keyword,
			tk.QUESTION_DIFFICULTY AS questionDifficulty,
			(select 
				DIFF_NAME 
			 from  com_code_mst
			 where TYPE_ID ='E01' 
				AND DIFF_NO = tk.QUESTION_DIFFICULTY
			) AS questionDifficultyName,
			tk.QUESTION_NUMBER AS questionNumber,
			tk.QUESTION_TIMES AS questionTimes,
			tk.RIGHT_TIMES AS rightTimes,	
			tk.QUESTION_CONTENT AS questionContent,
			tk.CREATE_USER_ID AS createUserId,
			tk.UPDATE_TIME AS updateTime,
			tk.PICTURE_FLG AS pictureFlg,
			tk.MEDIA_FLG AS mediaFlg,
			tk.ATTACH_FLG AS attachFlg,
			QUESTION_DIFFICULTY AS questionDifficulty
		FROM tt_sj_gudingdati tsj,tt_tiku tk
		WHERE 
			tsj.PAPER_ID = #paperId# 
			AND tsj.PAPER_VERSION_NO = #paperVersionNo# 
			AND tsj.BIGQUESTION_SERIAL_NO = #bigquestionSerialNo#   
			AND tk.QUESTION_ID = tsj.QUESTION_ID 
			AND tk.CHECK_FLG = 2
			AND tk.QUESTION_VERSION_NO = 
			(SELECT MAX(QUESTION_VERSION_NO) 
			FROM tt_tiku 
			WHERE QUESTION_ID = tk.QUESTION_ID)
		ORDER BY tsj.QUESTION_ORDER ASC
	</select>
	
	<!-- 获取试卷随机大题信息	 -->
	<select id="getK050051SujiDatiInfo" parameterClass="k050051PaperBigQuestionInfo" 
		resultClass="k050051RandomQuestionInfo">
		SELECT 
			KEYWORD AS keyword,
			
			CONCAT(CASE CATEGORY1_ID 
			WHEN 0 THEN "" ELSE 
			(SELECT 
				CATEGORY_NAME 
			 FROM tt_fenlei
				WHERE CATEGORY1_ID = tsj.CATEGORY1_ID 
					AND CATEGORY_LEVEL = 1
			)END,
			CASE CATEGORY2_ID
			WHEN 0 THEN "" ELSE CONCAT("-",
			(SELECT 
				CATEGORY_NAME 
			 FROM tt_fenlei
				WHERE CATEGORY1_ID = tsj.CATEGORY1_ID 
					AND CATEGORY2_ID = tsj.CATEGORY2_ID 
					AND CATEGORY_LEVEL = 2)
			) END ,
			CASE CATEGORY3_ID
			WHEN 0 THEN "" ELSE CONCAT("-",
			(SELECT 
				CATEGORY_NAME 
			 FROM tt_fenlei 
				WHERE CATEGORY1_ID = tsj.CATEGORY1_ID 
					AND CATEGORY2_ID = tsj.CATEGORY2_ID 
					AND CATEGORY3_ID = tsj.CATEGORY3_ID 
					AND CATEGORY_LEVEL = 3)
			)END) AS categoryName,
			QUESTION_DIFFICULTY AS questionDifficulty,
			(select 
				DIFF_NAME 
			 from  com_code_mst
			 where TYPE_ID ='E01' 
				AND DIFF_NO = tsj.QUESTION_DIFFICULTY
			) AS questionDifficultyName,
			QUESTION_NUM AS questionNum,
			QUESTION_SCORE AS questionScore,
			PAPER_ID AS paperId,
			PAPER_VERSION_NO AS paperVersionNo,
			BIGQUESTION_SERIAL_NO AS bigquestionSerialNo,
			CONDITION_SERIAL_NO AS conditionSerialNo
		FROM tt_sj_suijidati  tsj
		WHERE
			PAPER_ID = #paperId#  
			AND PAPER_VERSION_NO = #paperVersionNo# 
			AND BIGQUESTION_SERIAL_NO = #bigquestionSerialNo#  
	</select>
	
	<!-- 排他检查 -->
	<select id="getUpdateTime" parameterClass="k050051TestPaperInfo" 
		resultClass="k050051TestPaperInfo">
		SELECT 
			UPDATE_TIME AS updateTime,
			(SELECT 
				USER_CNM 
			FROM v_tt_user 
			WHERE USER_ID = tt_shijuan.UPDATE_USER_ID
			) AS updateUserName
		FROM tt_shijuan 
		WHERE PAPER_ID = #paperId# 
			AND PAPER_VERSION_NO = #paperVersionNo#
	</select>
	
	<!-- 更新试卷状态为已批准 -->
	<update id="updateApproveTestPaper" parameterClass="k050051TestPaperInfo">
		UPDATE 
			tt_shijuan 
		SET 
			PAPER_STATUS = 3 , 
			UPDATE_TIME = NOW(), 
			APPROVER_TIME = NOW(),
			APPROVER_USER_ID =#applyUserId#
		WHERE PAPER_ID = #paperId# 
			AND PAPER_VERSION_NO = #paperVersionNo#
	</update>
	
	<!-- 更新试卷状态为不批准 -->
	<update id="updateDisApproveTestPaper" parameterClass="k050051TestPaperInfo">
		UPDATE 
			tt_shijuan 
		SET 
			PAPER_STATUS = 4 , 
			REFUSE_REASON = #refuseReason#,
			UPDATE_TIME = NOW(), 
			APPROVER_TIME = NOW(),
			APPROVER_USER_ID =#applyUserId#
		WHERE PAPER_ID = #paperId# 
			AND PAPER_VERSION_NO = #paperVersionNo#
	</update>
	
	<!-- 删除试卷 -->
	<update id="deleteTestPaper" parameterClass="k050051TestPaperInfo">
		UPDATE 
			tt_shijuan 
		SET 
			NEW_FLG = 0 , 
			UPDATE_TIME = NOW() 
		WHERE PAPER_ID = #paperId# 
			AND PAPER_VERSION_NO = #paperVersionNo#
	</update>
</sqlMap>