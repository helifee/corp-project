/*
 * @(#) K060151Action.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 教育考试培训系统
 *    SubSystem: 考试子系统
 */

package com.yds.tt.testing.action;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.opensymphony.xwork2.interceptor.annotations.InputConfig;
import com.yds.base.action.AbstractBaseAction;
import com.yds.tt.manager.bean.TtCheckResult;
import com.yds.tt.manager.service.TtCommonService;
import com.yds.tt.manager.service.TtConstants;
import com.yds.tt.manager.service.TtException;
import com.yds.tt.testing.bean.ExamineInfo;
import com.yds.tt.testing.bean.K060151PaperInfo;
import com.yds.tt.testing.service.K060111Service;
import com.yds.tt.testing.service.K060151Service;

/**
 * 考试试卷生成一览处理
 * 
 * @author shiyanyan
 * @version 1.00 2010/04/01
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("k060151Action")
public class K060151Action extends AbstractBaseAction {

	private static final long serialVersionUID = -5259871007776339321L;
	private K060151Service k060151Service;

	private List<K060151PaperInfo> picPaperInfos; // 画面显示信息列表
	private K060151PaperInfo picPaperInfo; // 画面显示信息
	private String examineId; // 考试ID
	private String paperNo; // 试卷序号标志
	private String errorMessage;// 错误信息
	// 考试信息
	private ExamineInfo examineInfo;
	// 评分任务分配(业务逻辑)
	private K060111Service k060111Service;
	private TtCommonService ttCommonService;

	/**
	 * 画面初期表示 考试试卷生成一览取得
	 * 
	 * @return SUCCESS
	 */
	@Override
	@InputConfig(resultName=ERROR)
	public String execute() throws Exception {
		
		//权限校验
	    if (!checkAutority()){
			this.addActionError(ERROR);
		}
	    	// 考试信息取得
			this.examineInfo = k060111Service.getExamineInfo(examineId);
	    
			// 画面一览信息编辑
			picPaperInfos = k060151Service.getPicPaperInfos(examineId);	
			
			if (picPaperInfos.size() == 0){
				errorMessage = propMgr.getMessage("yds.tt.error.KSE25",examineId);
				return ERROR;
			}
	    
		
		return SUCCESS;
	}
	
	/**
	 * 确定更新数据库
	 * 
	 * @return SUCCESS
	 */
	public String updatePaperDetails() throws Exception {
		
		if (!checkAutority()){
			return ERROR;
		}
		
		try{
			k060151Service.updatePaperDetails(picPaperInfos,examineId);
		}catch (TtException e){
			errorMessage = e.getMessage();
			return ERROR;
		}
		
		return SUCCESS;
	}

	/**
	 * 参数项目校验
	 * 
	 */
	public void validateExecute() {

		// 参数考试ID判断
		if (null == this.getExamineId() || "".equals(this.getExamineId())) {
			errorMessage = propMgr.getMessage("yds.com.error.0001");
			this.addActionError("error");
		}
	}

	/**
	 * 权限校验
	 */
	private boolean checkAutority() {
		// 对象Id
		List<String> objectList = new ArrayList<String>();
		//objectList.add(examineId == null ? picPaperInfo.getExamineId() : examineId);
		objectList.add(examineId.substring(0, 6) + "00");
		TtCheckResult checkResult = ttCommonService
					.checkStartupAuthority(TtConstants.PageId.K060151.value(), "K060151", 0, 0, 0,
					TtConstants.C43.C43_3.value(), objectList);

			
		if (!checkResult.getRetFlag()) {
			errorMessage = checkResult.getRetMessage();
			return false;
		}
		
		return true;
	}


	/**
	 * @return the k060151Service
	 */
	public K060151Service getK060151Service() {
		return k060151Service;
	}

	/**
	 * @param service the k060151Service to set
	 */
	public void setK060151Service(K060151Service service) {
		k060151Service = service;
	}

	/**
	 * @return the picPaperInfos
	 */
	public List<K060151PaperInfo> getPicPaperInfos() {
		return picPaperInfos;
	}

	/**
	 * @param picPaperInfos the picPaperInfos to set
	 */
	public void setPicPaperInfos(List<K060151PaperInfo> picPaperInfos) {
		this.picPaperInfos = picPaperInfos;
	}

	/**
	 * @return the examineId
	 */
	public String getExamineId() {
		return examineId;
	}

	/**
	 * @param examineId the examineId to set
	 */
	public void setExamineId(String examineId) {
		this.examineId = examineId;
	}

	/**
	 * @return the paperNo
	 */
	public String getPaperNo() {
		return paperNo;
	}

	/**
	 * @param paperNo the paperNo to set
	 */
	public void setPaperNo(String paperNo) {
		this.paperNo = paperNo;
	}

	/**
	 * @return the errorMessage
	 */
	public String getErrorMessage() {
		return errorMessage;
	}

	/**
	 * @param errorMessage the errorMessage to set
	 */
	public void setErrorMessage(String errorMessage) {
		this.errorMessage = errorMessage;
	}

	/**
	 * @return the picPaperInfo
	 */
	public K060151PaperInfo getPicPaperInfo() {
		return picPaperInfo;
	}

	/**
	 * @param picPaperInfo the picPaperInfo to set
	 */
	public void setPicPaperInfo(K060151PaperInfo picPaperInfo) {
		this.picPaperInfo = picPaperInfo;
	}

	/**
	 * @param ttCommonService the ttCommonService to set
	 */
	public void setTtCommonService(TtCommonService ttCommonService) {
		this.ttCommonService = ttCommonService;
	}

	public ExamineInfo getExamineInfo() {
		return examineInfo;
	}

	public void setExamineInfo(ExamineInfo examineInfo) {
		this.examineInfo = examineInfo;
	}

	public void setK060111Service(K060111Service service) {
		k060111Service = service;
	}

}
