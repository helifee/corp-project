<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="k040031Dao">
	<typeAlias alias="questionLibrary" type="com.yds.tt.testing.bean.QuestionLibrary"/>
	<typeAlias alias="answerInfo" type="com.yds.tt.testing.bean.AnswerInfo"/>	
	<typeAlias alias="answerPointInfo" type="com.yds.tt.testing.bean.AnswerPointInfo"/>
	
	<!-- 试题信息一览 -->
	<select id="getQuestionLibraryInfoList" parameterClass="java.util.List" resultClass="questionLibrary">
		SELECT 
		  T1.QUESTION_ID AS questionId,
		  T1.QUESTION_VERSION_NO AS questionVersionNo,
		  T1.VERSION_START_TIME AS versionStartTime,
		  T1.VERSION_END_TIME AS versionEndTime,
		  T1.REF_QUESTION_ID AS refQuestionId,
		  T1.NEW_FLG AS newFlg,
		  T1.QUESTION_TYPE AS questionType,
		  (SELECT DIFF_NAME FROM  COM_CODE_MST WHERE TYPE_ID ='R02' AND DIFF_NO = T1.QUESTION_TYPE)
		  AS questionTypeName,
		  T1.QUESTION_NUMBER AS questionNumber,
		  T1.ATUO_MARK_FLG AS atuoMarkFlg,
		  T1.CATEGORY1_ID AS category1Id,
		  T1.CATEGORY2_ID AS category2Id,
		  T1.CATEGORY3_ID AS category3Id,

		  <!-- 分类名称：一级分类名-二级分类名-三级分类名 -->
		  CONCAT
				(CASE  T1.CATEGORY1_ID 
					WHEN 0 THEN ""
					ELSE 
						(SELECT CATEGORY_NAME 
						   FROM TT_FENLEI 
						   WHERE CATEGORY1_ID =  T1.CATEGORY1_ID AND 
								CATEGORY_LEVEL = 1)
				END,
				CASE  T1.CATEGORY2_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI
							    WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
									 CATEGORY2_ID =  T1.CATEGORY2_ID AND
									 CATEGORY_LEVEL = 2))
				END ,
				CASE  T1.CATEGORY3_ID
					WHEN 0 THEN ""
					ELSE CONCAT("-",(SELECT CATEGORY_NAME 
								FROM TT_FENLEI
							    WHERE CATEGORY1_ID = T1.CATEGORY1_ID AND 
									 CATEGORY2_ID = T1.CATEGORY2_ID AND
									 CATEGORY3_ID = T1.CATEGORY3_ID AND
									 CATEGORY_LEVEL = 3))
				END) AS categoryName,		  		  
		  T1.KEYWORD AS keyword,
		  T1.QUESTION_KIND AS questionKind,		  
	      (SELECT DIFF_NAME FROM  COM_CODE_MST WHERE TYPE_ID ='R03' AND DIFF_NO = T1.QUESTION_DIFFICULTY)
	      AS questionKindName,
		  T1.QUESTION_DIFFICULTY AS questionDifficulty,		  
	      (SELECT DIFF_NAME FROM  COM_CODE_MST WHERE TYPE_ID ='E01' AND DIFF_NO = T1.QUESTION_DIFFICULTY)
	      AS questionDifficultyName,
		  T1.CHECK_FLG AS checkFlg,
		  T1.QUESTION_SCORE AS questionScore,
		  T1.QUESTION_TIMES AS questionTimes,
		  T1.ERROR_TIMES AS errorTimes,
		  T1.RIGHT_TIMES AS rightTimes,
		  T1.QUESTION_SOURCE AS questionSource,
		  T1.UPDATE_TIME AS updateTime,
		  T1.QUESTION_CONTENT AS questionContent,
		  T1.PICTURE_FLG AS pictureFlg,
		  T1.MEDIA_FLG AS mediaFlg,
		  T1.ATTACH_FLG AS attachFlg,
		  T1.QUESTION_COMMENT AS questionComment,
		  T1.CREATE_USER_ID AS createUserId,
		  T1.CREATE_TIME AS createTime,
		  T1.UPDATE_USER_ID AS updateUserId,
		  T1.UPDATE_TIME AS updateTime
		FROM TT_TIKU T1
		WHERE
		  <iterate  conjunction="or" open="(" close=")">
			(T1.QUESTION_ID = #questionIdList[]#)
		  </iterate>
		  AND T1.NEW_FLG = 2
		  ORDER BY T1.UPDATE_TIME DESC, T1.QUESTION_ID ASC
	</select>

	<!-- 取得关键字信息 -->
	<select id="getKeyWordInfo" resultClass="String" parameterClass="java.util.HashMap">
		SELECT DISTINCT 
		  KEYWORD_NAME
		FROM TT_GUANJIANZI
		<isNotEmpty property="category1Id">
			<isNotEqual property="category1Id" compareProperty="0">
				WHERE CATEGORY_ID = #category1Id#
			</isNotEqual>
		</isNotEmpty>
	</select>
	
	<!-- 修改最新状态信息 -->
	<update id="updateNewFlag" parameterClass="String">
		UPDATE
		  TT_TIKU T1
		SET  		
		  T1.NEW_FLG = 1,
		  T1.VERSION_END_TIME = NOW()
		WHERE	
	      T1.QUESTION_ID = #questionId#		  
	</update>
		
	<!-- 修改试题信息 -->
	<update id="updateTestQuestions" parameterClass="questionLibrary">
		UPDATE
		  TT_TIKU T1
		SET T1.UPDATE_TIME = NOW(),
		  T1.UPDATE_USER_ID = #updateUserId#
		  <isEqual property="questionKindFlag" compareValue="1" prepend=",">
			T1.QUESTION_TYPE = #questionType#
		  </isEqual>
		  <isEqual property="categoryIdFlag" compareValue="1" prepend=",">
			T1.CATEGORY1_ID = #category1Id#
		  </isEqual>
		  <isEqual property="categoryIdFlag" compareValue="1" prepend=",">
			T1.CATEGORY2_ID = #category2Id#
		  </isEqual>
		  <isEqual property="categoryIdFlag" compareValue="1" prepend=",">
			T1.CATEGORY3_ID = #category3Id#
		  </isEqual>
		  <isEqual property="keywordFlag" compareValue="1" prepend=",">
			T1.KEYWORD = #keyword#
		  </isEqual>
		  <isEqual property="questionDifFlag" compareValue="1" prepend=",">
			T1.QUESTION_DIFFICULTY = #questionDifficulty#
		  </isEqual>
		  <isEqual property="questionSourceFlag" compareValue="1" prepend=",">
			T1.QUESTION_SOURCE = #questionSource#
		  </isEqual>
		  <isEqual property="questionScoreFlag" compareValue="1">
			<isEqual property="questionNumber" compareValue="1" prepend=",">
			  T1.QUESTION_SCORE = #questionScore#
			</isEqual>
		  </isEqual>	  
		WHERE	
	      T1.QUESTION_ID = #questionId# AND
		  T1.NEW_FLG = 2
	</update>
	
	<!-- 插入试题信息 -->
	<insert id="insertTestQuestions" parameterClass="questionLibrary">
		INSERT INTO
		  TT_TIKU (
			QUESTION_ID,
			QUESTION_VERSION_NO,
			VERSION_START_TIME,
			VERSION_END_TIME,
			REF_QUESTION_ID,
			NEW_FLG,
			QUESTION_TYPE,
			QUESTION_NUMBER,
			ATUO_MARK_FLG,
			CATEGORY1_ID,
			CATEGORY2_ID,
			CATEGORY3_ID,
			KEYWORD,
			QUESTION_KIND,
			QUESTION_DIFFICULTY,
			CHECK_FLG,
			QUESTION_SCORE,
			QUESTION_TIMES,
			ERROR_TIMES,
			RIGHT_TIMES,
			QUESTION_SOURCE,
			QUESTION_CONTENT,
			PICTURE_FLG,
			MEDIA_FLG,
			ATTACH_FLG,
			QUESTION_COMMENT,
			CREATE_USER_ID,
			CREATE_TIME,
			UPDATE_USER_ID,
			UPDATE_TIME
		  ) VALUES (
			#questionId#,
			#questionVersionNo#,
			#versionStartTime#,
			#versionEndTime#,
			#refQuestionId#,
			#newFlg#,
			#questionType#,
			#questionNumber#,
			#atuoMarkFlg#,
			#category1Id#,
			#category2Id#,
			#category3Id#,
			#keyword#,
			#questionKind#,
			#questionDifficulty#,
			#checkFlg#,
			#questionScore#,
			#questionTimes#,
			#errorTimes#,
			#rightTimes#,
			#questionSource#,
			#questionContent#,
			#pictureFlg#,
			#mediaFlg#,
			#attachFlg#,
			#questionComment#,
			#createUserId#,
			#createTime#,
			#updateUserId#,
			#updateTime#						
		  )
	</insert>
	
	<!-- 取得最新更新时间 -->
	<select id="getUpdateTime" parameterClass="String" resultClass="java.util.Date">
		SELECT 
		  T1.UPDATE_TIME
		FROM
		  TT_TIKU T1
		WHERE
		  T1.QUESTION_ID = #questionId# AND
		  T1.NEW_FLG = 2
	</select>
	
	<!-- 取得答案信息 -->
	<select id="getAnswerInfo" parameterClass="questionLibrary" resultClass="answerInfo">
		SELECT
		  T1.QUESTION_ID AS questionId,
		  T1.QUESTION_VERSION_NO AS questionVersionNo,
		  T1.ANSWER_SERIAL_NO AS answerSerialNo,
		  T1.ANSWER_TYPE AS answerType,
		  T1.ANSWER_SCORE AS answerScore,
		  T1.ANSWER_QUES_NO AS answerQuesNo,
		  T1.OPTION_TYPE_ID AS optionTypeId,
		  T1.OPTION_TYPE AS optionType,
		  T1.OPTION_NUMBER AS optionNumber,
		  T1.BLANK_NUMBER AS blankNumber,
		  T1.ANSWER_CONTENT AS answerContent,
		  T1.WORD_LIMITS AS wordLimits,
		  T1.ATTACH_FILE_PATH AS attachFilePath
		FROM
		  TT_DAAN T1
		WHERE
		  T1.QUESTION_ID = #questionId# AND
		  T1.QUESTION_VERSION_NO = #questionVersionNo#
	</select>
	
	<!-- 取得答案信息 -->
	<insert id="insertAnswerInfo" parameterClass="answerInfo">
		INSERT INTO
		  TT_DAAN (
		    QUESTION_ID,
		    QUESTION_VERSION_NO,
		    ANSWER_SERIAL_NO,
		    ANSWER_TYPE,
		    ANSWER_SCORE,
		    ANSWER_QUES_NO,
		    OPTION_TYPE_ID,
		    OPTION_TYPE,
		    OPTION_NUMBER,
		    BLANK_NUMBER,
		    ANSWER_CONTENT,
		    WORD_LIMITS,
		    ATTACH_FILE_PATH		    
		  ) VALUES (
		    #questionId#,
			#questionVersionNo#,
			#answerSerialNo#,
			#answerType#,
			#answerScore#,
			#answerQuesNo#,
			#optionTypeId#,
			#optionType#,
			#optionNumber#,
			#blankNumber#,
			#answerContent#,
			#wordLimits#,
			#attachFilePath#
		  )
	</insert>
	
	<!-- 取得答案得分信息 -->
	<select id="getAnswerPointInfo" parameterClass="questionLibrary" resultClass="answerPointInfo">
		SELECT
		  QUESTION_ID AS questionId,
		  QUESTION_VERSION_NO AS questionVersionNo,
		  ANSWER_SERIAL_NO AS answerSerialNo,
		  POINT_SERIAL_NO AS pointSerialNo,
		  POINT_CONTENT AS pointContent,
		  POINT_SCORE AS pointScore
		FROM
		  TT_DEFENDIAN T1
		WHERE 
		  T1.QUESTION_ID = #questionId# AND
		  T1.QUESTION_VERSION_NO = #questionVersionNo#		
	</select>
	
	<!-- 新建答案得分信息 -->
	<insert id="insertAnswerPointInfo" parameterClass="answerPointInfo">
		INSERT INTO
		  TT_DEFENDIAN (
		    QUESTION_ID,
		    QUESTION_VERSION_NO,
		    ANSWER_SERIAL_NO,
		    POINT_SERIAL_NO,
		    POINT_CONTENT,
		    POINT_SCORE		    
		  ) VALUES (
		    #questionId#,
			#questionVersionNo#,
			#answerSerialNo#,
			#pointSerialNo#,
			#pointContent#,
			#pointScore#
		  )
	</insert>
</sqlMap>
