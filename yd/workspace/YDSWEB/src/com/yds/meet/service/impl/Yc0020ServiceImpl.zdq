/*
 * @(#)Yc0020ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东计算机社内网
 *    SubSystem: 会议室管理
 */

package com.yds.meet.service.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.stereotype.Service;
import com.yds.base.service.AbstractBaseService;
import com.yds.common.service.SessionService;
import com.yds.common.service.CommonConstants.TIME_FLG;
import com.yds.meet.bean.MetDaymetInfo;
import com.yds.meet.bean.MetRoomInfo;
import com.yds.meet.common.dao.MetRoomInfoDao;
import com.yds.meet.dao.Yc0020Dao;
import com.yds.meet.service.MeetConstants;
import com.yds.meet.service.Yc0020Service;
import com.yds.util.service.DateUtil;

/**
 * @see com.yds.meet.service.Yc0020Service
 */
@Service("yc0020Service")
public class Yc0020ServiceImpl extends AbstractBaseService implements
		Yc0020Service {
	private MetRoomInfoDao metRoomInfoDao;
	private Yc0020Dao yc0020Dao;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<MetRoomInfo> getMetRoomDaymetInfoList(String metDate) {

		// 会议室每日信息记录
		int index = 0;

		String userId = SessionService.getLoginUserId();

		Map<String,String> condition = new HashMap<String,String>();
		// 会议日期
		condition.put("metDate", metDate);
		// 登录者ID
		condition.put("loginUserId", userId);
		// 会议室信息
		List<MetRoomInfo> metRoomList = metRoomInfoDao.getMetRoomInfoList("");

		// 会议室每日会议信息
		List<MetDaymetInfo> metDaymetList = yc0020Dao
				.getMetDaymetInfoList(condition);

		// 会议室信息及每日信息
		for(MetRoomInfo metRoomInfo : metRoomList){
			List<MetDaymetInfo> dayMetList = new ArrayList<MetDaymetInfo>();
			int metId = metRoomInfo.getMetId();			
			for (int j = index; j < metDaymetList.size(); j++) {
				MetDaymetInfo metDaymetInfo = new MetDaymetInfo();
				if (metId == metDaymetList.get(j).getMetId()) {
					// 会议开始时间
					String startTime = metDaymetList.get(j).getMetStaTime();
					// 会议结束时间
					String endTime = metDaymetList.get(j).getMetEndTime();
					// 预约人ID
					metDaymetInfo.setApplyUserId(metDaymetList.get(j)
							.getApplyUserId());
					// 预约人名
					metDaymetInfo.setApplyUserNm(metDaymetList.get(j)
							.getApplyUserNm());
					// 参加者人数
					metDaymetInfo.setJoinUserCnt(metDaymetList.get(j)
							.getJoinUserCnt());
					// 开始时间小时
					metDaymetInfo.setStartHhTime(DateUtil.getSplitTime(startTime,
							TIME_FLG.HH));
					// 开始时间分钟
					metDaymetInfo.setStartMmTime(DateUtil.getSplitTime(startTime,
							TIME_FLG.MM));
					// 结束时间小时
					metDaymetInfo.setEndHhTime(DateUtil.getSplitTime(endTime,
							TIME_FLG.HH));
					// 结束时间分钟
					metDaymetInfo.setEndMmTime(DateUtil.getSplitTime(endTime,
							TIME_FLG.MM));
					// 是否有人申请Flg
					metDaymetInfo.setApplyFlg(MeetConstants.APPLY_FLG.YES
							.value());
					// 是否是申请人Flg
					if (userId.equals(metDaymetList.get(j).getApplyUserId())) {
						metDaymetInfo
								.setApplyUserFlg(MeetConstants.APPLY_USER_FLG.YES
										.value());
					} else {
						metDaymetInfo
								.setApplyUserFlg(MeetConstants.APPLY_USER_FLG.NO
										.value());
					}
					// 权限flg
					metDaymetInfo.setPermitFlg(metDaymetList.get(j)
							.getPermitFlg());

					dayMetList.add(metDaymetInfo);

				} else {
					index = j;
					break;
				}
			}
			metRoomInfo.setMetDaymetList(dayMetList);
		}
		
		return metRoomList;

	}

	/**
	 * @param metRoomInfoDao
	 *            the metRoomInfoDao to set
	 */
	public void setMetRoomInfoDao(MetRoomInfoDao metRoomInfoDao) {
		this.metRoomInfoDao = metRoomInfoDao;
	}

	/**
	 * @param yc0020Dao
	 *            the yc0020Dao to set
	 */
	public void setYc0020Dao(Yc0020Dao yc0020Dao) {
		this.yc0020Dao = yc0020Dao;
	}
}
