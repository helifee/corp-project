<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Ye0040Dao">

    <typeAlias alias="attRestApp" type="com.yds.att.bean.AttRestApp"/>
	<typeAlias alias="attInfo" type="com.yds.att.bean.AttInfo"/>
	<typeAlias alias="attExamin" type="com.yds.att.bean.AttExamin"/>
	<typeAlias alias="ye0040CondA" type="com.yds.att.bean.Ye0040CondA"/>

	<!-- 用于select查询公用抽取的列 -->
	<sql id="commonColumns">
		  T1.APP_ID AS appId,
		  REST_PER_ID AS restPerId,
		  (SELECT T2.EMP_CNM FROM V_EMP_LIST_QUIT T2 WHERE T2.EMP_ID = REST_PER_ID) AS restPerName,
		  (SELECT T4.ORG_SNM FROM emp_org_info T4 WHERE T4.ORG_ID = REST_ORGANIZATION_ID) AS prjNm,
		  REST_ORGANIZATION_ID AS restOrganizationId,
		  REST_START_DATE AS restStartDate,
		  REST_END_DATE AS restEndDate,
		  REST_TYPE AS restType,
		  REST_REASON AS restReason,
		  APP_STATUS AS appStatus,
		  UPDATE_TIME AS updateTime,
		  UPDATE_USER AS updateUser,
		  ex1.EXA_RESULT AS leadershipSay,
		  ex2.EXA_RESULT AS ministerSay, 
		  ex3.EXA_RESULT AS leaderSay,
		  ex3.EXA_APP_END AS exaAppEnd,
		  getOrgTypeByOrgId(T1.REST_ORGANIZATION_ID) AS orgType

	</sql>

	<!--更新休假请假表-->
    <update id="updateAttRestApp" parameterClass="attRestApp">
        UPDATE att_rest_app SET
	        APP_STATUS = #appStatus# ,
	        UPDATE_TIME = now() ,
	        UPDATE_USER = #updateUser# 
        WHERE 
	        APP_ID = #appId# 
    </update>
	<!--更新考勤信息表-->
	<update id="updateAttInfo" parameterClass="attInfo">
        UPDATE att_info SET
	        APP_STATUS = #appStatus# ,
	        APP_STATUS_ADDI = #appStatusAddi# 
        WHERE 
	        EMP_ID = #empId# AND
			YEAR = #year# AND
			MONTH = #month# AND
			DAY = #day#
    </update>
	<!--更新审批过程表-->
	<update id="updateAttExamin" parameterClass="attExamin">
        UPDATE att_examin SET
	        EXA_ID = #exaId# ,
	        EXA_RESULT = #exaResult# ,
			EXA_SUGGESTION = #exaSuggestion# ,
			EXA_DAY = now()
        WHERE 
	        APP_ID = #appId# AND
			EXA_APP_ORDER = #exaAppOrder#
    </update>
    <!--根据申请ID查询该条请假信息-->
    <select id="getAttRestAppByPk" parameterClass="String" resultClass="attRestApp">
	    SELECT <include refid="commonColumns"/>
	    FROM att_rest_app T1
		  LEFT JOIN att_examin AS ex1		
			ON T1.APP_ID = ex1.APP_ID		
			  AND getOrgTypeByOrgId(ex1.EXA_ORGANIZATION_ID) = 'comp'		
		  LEFT JOIN att_examin AS ex2		
			ON T1.APP_ID = ex2.APP_ID		
			  AND getOrgTypeByOrgId(ex2.EXA_ORGANIZATION_ID) = 'dept'		
		  LEFT JOIN att_examin AS ex3		
			ON T1.APP_ID = ex3.APP_ID		
			  AND getOrgTypeByOrgId(ex3.EXA_ORGANIZATION_ID) = 'prjt'
	      WHERE 
		        T1.APP_ID = #appId# 
    </select>
	<!--共通查询条件-->
	<sql id="dynamicWhere">
	    <dynamic prepend="WHERE">
			1 = 1
			<isNotEmpty property="sdate">
				AND ( REST_START_DATE >= #sdate#
				<isNotEmpty property="edate">
					AND #edate# >= REST_START_DATE
				</isNotEmpty>
			</isNotEmpty>
			<isNotEmpty property="sdate">
				OR REST_END_DATE >= #sdate#
				<isNotEmpty property="edate">
					AND #edate# >= REST_END_DATE
				</isNotEmpty>
			</isNotEmpty>
			<isNotEmpty property="sdate">
				OR REST_END_DATE >= #edate#
				<isNotEmpty property="edate">
					AND #sdate# >= REST_START_DATE
				</isNotEmpty>
				)
			</isNotEmpty>
			<isNotEmpty property="stateFlag">
				<isEqual compareValue="1" property="stateFlag">
					AND APP_STATUS IN('1', '2')
				</isEqual>
				<isEqual compareValue="3" property="stateFlag">
					AND APP_STATUS IN('3', '4', '5')
				</isEqual>
			</isNotEmpty>
			AND (0 = 1
			<isNotEmpty property="attFlag">
				<isEqual compareValue="true" property="attFlag">
					OR 0 = 0
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="gc">
				<isEqual compareValue="true" property="gc">
					OR REST_TYPE LIKE 'G_'
					OR REST_TYPE = 'G'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="hx">
				<isEqual compareValue="true" property="hx">
					OR REST_TYPE LIKE 'H_'
					OR REST_TYPE = 'H'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="cc">
				<isEqual compareValue="true" property="cc">
					OR REST_TYPE = 'C'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="hbj">
				<isEqual compareValue="true" property="hbj">
					OR REST_TYPE LIKE 'B_'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="hsj">
				<isEqual compareValue="true" property="hsj">
					OR REST_TYPE LIKE 'S_'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="bj">
				<isEqual compareValue="true" property="bj">
					OR REST_TYPE = 'B'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="shij">
				<isEqual compareValue="true" property="shij">
					OR REST_TYPE = 'S'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="nx">
				<isEqual compareValue="true" property="nx">
					OR REST_TYPE = 'N'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="tj">
				<isEqual compareValue="true" property="tj">
					OR REST_TYPE = 'T'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="hj">
				<isEqual compareValue="true" property="hj">
					OR REST_TYPE = 'W'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="cj">
				<isEqual compareValue="true" property="cj">
					OR REST_TYPE = 'M'
				</isEqual>
			</isNotEmpty>
			<isNotEmpty property="sj">
				<isEqual compareValue="true" property="sj">
					OR REST_TYPE = 'F'
				</isEqual>
			</isNotEmpty>
			<![CDATA[ )
			AND  (REST_ORGANIZATION_ID IN (SELECT ORG_ID 	
			FROM emp_org_info 	
			WHERE org_lev REGEXP 	
				(SELECT 
				CONCAT( '(^' , GROUP_CONCAT(DISTINCT TRIM(TRAILING '00000' FROM org_lev) SEPARATOR '.*$$)|(^') , '.*$$)' )
				FROM emp_org_info 
				WHERE ORG_MNGER = #updateUser# 
				))
				OR REST_PER_ID = #updateUser# )
			ORDER BY T1.APP_ID DESC
			]]>
	    </dynamic>	
	</sql>
    <!--请假信息一览-->
    <select id="getAttRestAppList" resultClass="attRestApp" parameterClass="ye0040CondA">
    	SELECT <include refid="commonColumns"/>
		FROM att_rest_app T1
		
		  LEFT JOIN att_examin AS ex1		
			ON T1.APP_ID = ex1.APP_ID		
			  AND getOrgTypeByOrgId(ex1.EXA_ORGANIZATION_ID) = 'comp'		
		  LEFT JOIN att_examin AS ex2		
			ON T1.APP_ID = ex2.APP_ID		
			  AND getOrgTypeByOrgId(ex2.EXA_ORGANIZATION_ID) = 'dept'		
		  LEFT JOIN att_examin AS ex3		
			ON T1.APP_ID = ex3.APP_ID		
			  AND getOrgTypeByOrgId(ex3.EXA_ORGANIZATION_ID) = 'prjt'
		<include refid="dynamicWhere"/>
    </select>
	<!--请假审批过程查询-->
    <select id="getAttExamin" parameterClass="HashMap" resultClass="attExamin">
		SELECT
			T1.APP_ID              AS appId,
			T1.EXA_APP_ORDER       AS exaAppOrder,
			T1.EXA_APP_END         AS exaAppEnd,
			T1.EXA_ORGANIZATION_ID AS exaOrganizationId,
			T1.EXA_ID              AS exaId,
			T1.EXA_RESULT          AS exaResult,
			T1.EXA_SUGGESTION      AS exaSuggestion,
			T1.EXA_DAY             AS exaDay
		FROM att_examin T1,
			emp_org_info T2
		WHERE T2.ORG_ID = T1.EXA_ORGANIZATION_ID
			  AND T2.ORG_MNGER = #userId#
			  AND T1.APP_ID = #appId#
		ORDER BY EXA_APP_ORDER DESC
    </select>
</sqlMap>
