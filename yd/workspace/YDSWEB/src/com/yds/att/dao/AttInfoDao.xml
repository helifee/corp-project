<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="attInfoDao">

    <typeAlias alias="attInfo" type="com.yds.att.bean.AttInfo"/>
	<typeAlias alias="attType" type="com.yds.att.bean.AttType"/>
	<typeAlias alias="attExrestInfo" type="com.yds.att.bean.AttExrestInfo"/>
	<!-- 用于select查询公用抽取的列 -->
	<sql id="commonColumns">
	    <![CDATA[
        	EMP_ID as empId ,
        	YEAR as year ,
        	MONTH as month ,
        	DAY as day ,
        	DAY_FLG as dayFlg ,
        	TYPE_FLG as typeFlg ,
        	CLOCK_IN as clockIn ,
        	P_START_TIME as pstartTime ,
        	P_END_TIME as pendTime ,
        	LUNCH_TIME_ST as lunchTimeSt ,
        	LUNCH_TIME_END as lunchTimeEnd ,
        	DINNER_TIME_END as dinnerTimeEnd ,
        	R_START_TIME as rstartTime ,
        	R_END_TIME as rendTime ,
        	FIRST_TIME as firstTime ,
        	LAST_TIME as lastTime ,
        	REST_TYPE as restType ,
        	APP_STATUS as appStatus ,
        	APP_ID as appId ,
        	REST_TYPE_ADDI as restTypeAddi ,
        	APP_STATUS_ADDI as appStatusAddi ,
        	APP_ID_ADDI as appIdAddi ,
        	ATT_STATUS_COR as attStatusCor ,
        	APP_ID_COR as appIdCor ,
        	ATT_STATUS_OT as attStatusOt ,
        	OT_ST_TIME as otStTime ,
        	OT_ED_TIME as otEdTime ,
        	OT_BENEFIT as otBenefit ,
        	ORG_ID as orgId ,
        	UPDATE_USER as updateUser ,
        	UPDATE_TIME as updateTime 
	    ]]>
	</sql>
    <update id="updateAttInfo" parameterClass="attInfo">
    <![CDATA[
        UPDATE att_info SET
	        TYPE_FLG = #typeFlg# ,
	        P_START_TIME = #pstartTime# ,
	        P_END_TIME = #pendTime# ,
	        LUNCH_TIME_ST = #lunchTimeSt# ,
	        LUNCH_TIME_END = #lunchTimeEnd# ,
	        DINNER_TIME_END = #dinnerTimeEnd# ,
	        R_START_TIME = #rstartTime# ,
	        R_END_TIME = #rendTime# ,
	        FIRST_TIME = #firstTime# ,
	        LAST_TIME = #lastTime# ,
	        REST_TYPE = #restType# ,
	        APP_STATUS = #appStatus# ,
	        APP_ID = #appId# ,
	        REST_TYPE_ADDI = #restTypeAddi# ,
	        APP_STATUS_ADDI = #appStatusAddi# ,
	        APP_ID_ADDI = #appIdAddi# ,
	        ATT_STATUS_COR = #attStatusCor# ,
	        APP_ID_COR = #appIdCor# ,
	        ATT_STATUS_OT = #attStatusOt# ,
	        OT_ST_TIME = #otStTime# ,
	        OT_ED_TIME = #otEdTime# ,
	        OT_BENEFIT = #otBenefit# ,
	        ORG_ID = #orgId# ,
	        UPDATE_USER = #updateUser# ,
	        UPDATE_TIME = #updateTime# 
        WHERE 
	        EMP_ID = #empId# and
	        YEAR = #year# and
	        MONTH = #month# and
	        DAY = #day# 
    ]]>
    </update>

    <delete id="deleteAttInfo" parameterClass="attInfo">
    <![CDATA[
        delete from att_info where
        EMP_ID = #empId# and
        YEAR = #year# and
        MONTH = #month# and
        DAY = #day# 
    ]]>
    </delete>
    
    <select id="getAttInfoByPk" parameterClass="attInfo" resultClass="attInfo">
	    select <include refid="commonColumns"/>
	    <![CDATA[
	        from att_info 
	        where 
		        EMP_ID = #empId# and
		        YEAR = #year# and
		        MONTH = #month# and
		        DAY = #day# 
	    ]]>
    </select>

	<sql id="dynamicWhere">
	    <dynamic prepend="WHERE">
	       <isNotEmpty prepend="AND" property="empId">
	             EMP_ID = #empId#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="year">
	             YEAR = #year#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="month">
	             MONTH = #month#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="day">
	             DAY = #day#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="typeFlg">
	             TYPE_FLG = #typeFlg#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="pstartTime">
	             P_START_TIME = #pstartTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="pendTime">
	             P_END_TIME = #pendTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="lunchTimeSt">
	             LUNCH_TIME_ST = #lunchTimeSt#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="lunchTimeEnd">
	             LUNCH_TIME_END = #lunchTimeEnd#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="dinnerTimeEnd">
	             DINNER_TIME_END = #dinnerTimeEnd#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="rstartTime">
	             R_START_TIME = #rstartTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="rendTime">
	             R_END_TIME = #rendTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="firstTime">
	             FIRST_TIME = #firstTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="lastTime">
	             LAST_TIME = #lastTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="restType">
	             REST_TYPE = #restType#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="appStatus">
	             APP_STATUS = #appStatus#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="appId">
	             APP_ID = #appId#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="restTypeAddi">
	             REST_TYPE_ADDI = #restTypeAddi#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="appStatusAddi">
	             APP_STATUS_ADDI = #appStatusAddi#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="appIdAddi">
	             APP_ID_ADDI = #appIdAddi#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="attStatusCor">
	             ATT_STATUS_COR = #attStatusCor#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="appIdCor">
	             APP_ID_COR = #appIdCor#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="attStatusOt">
	             ATT_STATUS_OT = #attStatusOt#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="otStTime">
	             OT_ST_TIME = #otStTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="otEdTime">
	             OT_ED_TIME = #otEdTime#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="otBenefit">
	             OT_BENEFIT = #otBenefit#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="orgId">
	             ORG_ID = #orgId#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="updateUser">
	             UPDATE_USER = #updateUser#
	       </isNotEmpty>
	       <isNotEmpty prepend="AND" property="updateTime">
	             UPDATE_TIME = #updateTime#
	       </isNotEmpty>
	    </dynamic>	
	</sql>
	 
    <select id="getAttInfoCount" resultClass="long">
    <![CDATA[
        select count(*) from att_info
    ]]>
		<include refid="dynamicWhere"/>    
    </select>
    
    <select id="getAttInfoList" resultClass="attInfo">
    	select <include refid="commonColumns"/>
	    <![CDATA[
	        from att_info 
	    ]]>
		<include refid="dynamicWhere"/>
    </select>
	
    <!-- 取得员工班型信息 --> 
	<select id="getAttType" parameterClass="java.util.HashMap" resultClass="attType">
		SELECT 
			  ATT_TYPE_CD as attTypeCd, 
			  CLOCK_IN as clockIn, 
			  ATTEND_TIME as attendTime, 
			  ABSENT_TIME as absentTime, 
			  NEXT_DAY_FLG as nextDayFlg, 
			  LUNCH_TIME_ST as lunchTimeSt, 
			  LUNCH_TIME_END as lunchTimeEnd, 
			  DINNER_TIME_END as dinnerTimeEnd 
		 FROM ATT_EMP_TYPE 
		 WHERE EMP_ID = #empId#
		  AND #attYmd# BETWEEN START_DATE AND END_DATE
	</select>
	<!-- 取得考勤班型信息 --> 
	<select id="getAttLeaveType" parameterClass="String" resultClass="attType">
		SELECT 
			  ATT_TYPE_CD as attTypeCd, 
			  CLOCK_IN as clockIn, 
			  ATTEND_TIME as attendTime, 
			  ABSENT_TIME as absentTime, 
			  NEXT_DAY_FLG as nextDayFlg, 
			  LUNCH_TIME_ST as lunchTimeSt, 
			  LUNCH_TIME_END as lunchTimeEnd, 
			  DINNER_TIME_END as dinnerTimeEnd 
		 FROM ATT_TYPE
		WHERE ATT_TYPE_CD = #attTypeCd#
	</select>

	<!-- 考勤信息檢索 --> 
	
	<select id="getAttInfo" parameterClass="java.util.HashMap" resultClass="attInfo">
	    SELECT <include refid="commonColumns"/>
	    <![CDATA[
		FROM ATT_INFO 
		WHERE
			EMP_ID = #empId# AND
			YEAR = #year# AND
			MONTH = #month# AND
			DAY = #day#
		]]>
	</select>
	
	<!-- 夜間批處理更新考勤信息 --> 
	<update id="updateBatchAttInfo" parameterClass="attInfo">
		UPDATE 
			ATT_INFO 
		SET 
			DAY_FLG         = #dayFlg#,
			TYPE_FLG        = #typeFlg#,
			CLOCK_IN        = #clockIn#, 
			P_START_TIME    = #pstartTime#, 
			P_END_TIME      = #pendTime#, 
			LUNCH_TIME_ST   = #lunchTimeSt#, 
			LUNCH_TIME_END  = #lunchTimeEnd#, 
			DINNER_TIME_END = #dinnerTimeEnd#,
			UPDATE_USER=#updateUser#,
			UPDATE_TIME=NOW()
		WHERE EMP_ID = #empId#
		  AND YEAR   = #year#
		  AND MONTH  = #month#
		  AND DAY    = #day#;
	</update>
	<!-- 夜間批處理插入考勤信息 -->
	<insert id="insertBatchAttInfo" parameterClass="attInfo">
        INSERT INTO ATT_INFO 
			(
			EMP_ID,
			YEAR,
			MONTH,
			DAY, 
			DAY_FLG,  
			TYPE_FLG,  
			CLOCK_IN,  
			P_START_TIME,  
			P_END_TIME,  
			LUNCH_TIME_ST,  
			LUNCH_TIME_END,  
			DINNER_TIME_END,  
			UPDATE_USER,  
			UPDATE_TIME  
			)
		VALUES
			(
			#empId#,
			#year#,
			#month#,
			#day#, 
			#dayFlg#, 
			#typeFlg#, 
			#clockIn#, 
			#pstartTime#, 
			#pendTime#, 
			#lunchTimeSt#, 
			#lunchTimeEnd#, 
			#dinnerTimeEnd#, 
			#updateUser#, 
			NOW()
			)
    </insert>
	
	<!-- 请假申请更新考勤信息（覆盖更新） --> 
	<update id="updateLeaveAttInfo" parameterClass="attInfo">
		UPDATE ATT_INFO
		SET	
		    <isEqual property="typeFlg" compareValue="0">
				DAY_FLG=#dayFlg#,   
				TYPE_FLG=#typeFlg#,   
				CLOCK_IN=#clockIn#,  
				P_START_TIME=#pstartTime#,   
				P_END_TIME=#pendTime#,  
				LUNCH_TIME_ST=#lunchTimeSt#,   
				LUNCH_TIME_END=#lunchTimeEnd#,  
				DINNER_TIME_END=#dinnerTimeEnd#, 	
			</isEqual>
			 REST_TYPE=#restType#,
			 APP_STATUS=#appStatus#,
			 APP_ID=#appId#,
			 UPDATE_USER=#updateUser#,
			 UPDATE_TIME=NOW()
		WHERE
			EMP_ID=#empId# AND YEAR=#year# AND
			MONTH=#month# AND  DAY=#day#
	</update>
	
	<!-- 请假申请更新考勤信息（补充更新） --> 
	<update id="updateLeaveAttInfoAddi" parameterClass="attInfo">
		UPDATE ATT_INFO
		SET	
			<isEqual property="typeFlg" compareValue="0">
					DAY_FLG=#dayFlg#,   
					TYPE_FLG=#typeFlg#,   
					CLOCK_IN=#clockIn#,  
					P_START_TIME=#pstartTime#,   
					P_END_TIME=#pendTime#,  
					LUNCH_TIME_ST=#lunchTimeSt#,   
					LUNCH_TIME_END=#lunchTimeEnd#,  
					DINNER_TIME_END=#dinnerTimeEnd#, 	
			</isEqual>
			 REST_TYPE_ADDI=#restTypeAddi#,
			 APP_STATUS_ADDI=#appStatusAddi#,
			 APP_ID_ADDI=#appIdAddi#,
			 UPDATE_USER=#updateUser#,
			 UPDATE_TIME=NOW()
		WHERE
			EMP_ID=#empId# AND YEAR=#year# AND
			MONTH=#month# AND  DAY=#day#
	</update>
	
	<!-- 请假申请更新考勤信息（插入数据） -->
	<insert id="insertLeaveAttInfo" parameterClass="attInfo">
        INSERT INTO ATT_INFO 
			(
			EMP_ID,
			YEAR,
			MONTH,
			DAY, 
			DAY_FLG,  
			TYPE_FLG,  
			CLOCK_IN,  
			P_START_TIME,  
			P_END_TIME,  
			LUNCH_TIME_ST,  
			LUNCH_TIME_END,  
			DINNER_TIME_END,  
			REST_TYPE,  
			APP_STATUS,  
			APP_ID,  
			UPDATE_USER,  
			UPDATE_TIME  
			)
		VALUES
			(
			#empId#,
			#year#,
			#month#,
			#day#, 
			#dayFlg#, 
			#typeFlg#, 
			#clockIn#, 
			#pstartTime#, 
			#pendTime#, 
			#lunchTimeSt#, 
			#lunchTimeEnd#, 
			#dinnerTimeEnd#, 
			#restType#, 
			#appStatus#, 
			#appId#, 
			#updateUser#, 
			NOW() 
			)
    </insert>
	
	<!-- 加班申请更新考勤信息（更新数据） --> 
	<update id="updateOtAttInfo" parameterClass="attInfo">
		UPDATE ATT_INFO
		SET	
		    <isEqual property="typeFlg" compareValue="0">
				DAY_FLG=#dayFlg#,   
				TYPE_FLG=#typeFlg#,   
				CLOCK_IN=#clockIn#,  
				P_START_TIME=#pstartTime#,   
				P_END_TIME=#pendTime#,  
				LUNCH_TIME_ST=#lunchTimeSt#,   
				LUNCH_TIME_END=#lunchTimeEnd#,  
				DINNER_TIME_END=#dinnerTimeEnd#, 	
			</isEqual> 
			ATT_STATUS_OT=#attStatusOt#,
			OT_ST_TIME = #otStTime# ,
	        OT_ED_TIME = #otEdTime# ,
	        OT_BENEFIT = #otBenefit# ,
			UPDATE_USER=#updateUser#,
			UPDATE_TIME=NOW()
		WHERE
			EMP_ID=#empId# AND YEAR=#year# AND
			MONTH=#month# AND  DAY=#day#
	</update>
	
   <!-- 加班申请更新考勤信息(插入数据) --> 
   <insert id="insertOtAttInfo" parameterClass="attInfo">
        INSERT INTO ATT_INFO 
			(
			EMP_ID,
			YEAR,
			MONTH,
			DAY, 
			DAY_FLG,  
			TYPE_FLG,  
			CLOCK_IN,  
			P_START_TIME,  
			P_END_TIME,  
			LUNCH_TIME_ST,  
			LUNCH_TIME_END,  
			DINNER_TIME_END, 
			ATT_STATUS_OT,
			OT_ST_TIME ,
	        OT_ED_TIME ,
	        OT_BENEFIT ,  
			UPDATE_USER,  
			UPDATE_TIME  
			)
		VALUES
			(
			#empId#,
			#year#,
			#month#,
			#day#, 
			#dayFlg#, 
			#typeFlg#, 
			#clockIn#, 
			#pstartTime#, 
			#pendTime#, 
			#lunchTimeSt#, 
			#lunchTimeEnd#, 
			#dinnerTimeEnd#,
			#attStatusOt#, 
		    #otStTime# ,
	        #otEdTime# ,
	        #otBenefit# ,   
			#updateUser#, 
			NOW()
			)
    </insert>
	<!-- 打卡申请更新考勤信息（更新数据） --> 
	<update id="updateCdAttInfo" parameterClass="attInfo">
		UPDATE ATT_INFO
		SET	
		   <isNotNull property = "firstTime">
					FIRST_TIME=#firstTime#,	
		   </isNotNull>
		   <isNotNull property = "lastTime">
					LAST_TIME=#lastTime#,	
		   </isNotNull>
		   <isNotNull property = "rstartTime">
					R_START_TIME=#rstartTime#,	
		   </isNotNull>
		   <isNotNull property = "rendTime">
					R_END_TIME=#rendTime#,	
		   </isNotNull>
		   <isNotEmpty property="typeFlg">
		    <isEqual property="typeFlg" compareValue="0">
					DAY_FLG=#dayFlg#,   
					TYPE_FLG=#typeFlg#,   
					CLOCK_IN=#clockIn#,  
					P_START_TIME=#pstartTime#,   
					P_END_TIME=#pendTime#,  
					LUNCH_TIME_ST=#lunchTimeSt#,   
					LUNCH_TIME_END=#lunchTimeEnd#,  
					DINNER_TIME_END=#dinnerTimeEnd#, 	
			</isEqual> 
		   </isNotEmpty>
		   UPDATE_USER=#updateUser#,
		   UPDATE_TIME=NOW()
		WHERE
			EMP_ID=#empId# AND YEAR=#year# AND
			MONTH=#month# AND  DAY=#day#
	</update>
	
   <!-- 加班申请更新考勤信息(插入数据) --> 
   <insert id="insertCdAttInfo" parameterClass="attInfo">
        INSERT INTO ATT_INFO 
			(
			EMP_ID,
			YEAR,
			MONTH,
			DAY, 
			DAY_FLG,  
			TYPE_FLG,  
			CLOCK_IN,  
			P_START_TIME,  
			P_END_TIME,  
			LUNCH_TIME_ST,  
			LUNCH_TIME_END,  
			DINNER_TIME_END, 
			R_START_TIME,
	        R_END_TIME,
	        FIRST_TIME,
	        LAST_TIME,  
			UPDATE_USER,  
			UPDATE_TIME  
			)
		VALUES
			(
			#empId#,
			#year#,
			#month#,
			#day#, 
			#dayFlg#, 
			#typeFlg#, 
			#clockIn#, 
			#pstartTime#, 
			#pendTime#, 
			#lunchTimeSt#, 
			#lunchTimeEnd#, 
			#dinnerTimeEnd#,
			#rstartTime#, 
		    #rendTime# ,
	        #firstTime# ,
	        #lastTime# ,   
			#updateUser#, 
			NOW()
			)
    </insert>
	
	<!-- 有效换休检索 --> 
	<select id="getExrestInfoByMonth" parameterClass="java.util.HashMap" resultClass="attExrestInfo">
		<![CDATA[
		SELECT
		      CAL_YEAR AS calYear, CAL_MONTH AS calMonth, 
			  IFNULL(SUM(CASE HAPPEN_REASON WHEN '0' THEN   HAPPEN_TIME WHEN '1' THEN HAPPEN_TIME*(-1) END),0) AS happenTime
		 FROM att_exrest_info
		WHERE
		      EMP_ID = #empId#
		  AND CONCAT(CAL_YEAR, CAL_MONTH) IN (
                                              SELECT CONCAT(A.CAL_YEAR, A.CAL_MONTH) 
                                                FROM att_exrest_info A
                                               WHERE A.USEFUL_DATE >= #validDayDate#
											     AND A.EMP_ID = #empId#)
	     GROUP BY CAL_YEAR, CAL_MONTH
	     ORDER BY CAL_YEAR, CAL_MONTH
		]]>
	</select>

    <!-- 插入换休记录 --> 
    <insert id="insertAttExrestInfo" parameterClass="attExrestInfo">
        INSERT INTO
        att_exrest_info (
        	EMP_ID ,
        	CAL_YEAR ,
        	CAL_MONTH ,
        	HAPPEN_DATE ,
        	HAPPEN_REASON ,
        	HAPPEN_TIME ,
			USEFUL_DATE ,
        	APP_ID 
        ) VALUES (
        	#empId# ,
        	#calYear# ,
        	#calMonth# ,
        	#happenDate# ,
        	#happenReason# ,
        	#happenTime# ,
        	#usefulDate# ,
        	#appId# 
        )
    </insert>
	
	<!-- 删除换休记录 --> 
    <delete id="deleteAttExrestInfoByAppId" parameterClass="String">
    <![CDATA[
        delete from att_exrest_info where
        APP_ID = #appId# 
    ]]>
    </delete>	
</sqlMap>
