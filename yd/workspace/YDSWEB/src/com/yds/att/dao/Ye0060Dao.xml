<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ye0060Dao">
	
	<typeAlias alias="ye0060CondA" type="com.yds.att.bean.Ye0060CondA"/>	
	<typeAlias alias="ye0060Overtime" type="com.yds.att.bean.Ye0060Overtime"/>	
	<typeAlias alias="attOvertime" type="com.yds.att.bean.AttOvertime"/>	
	<typeAlias alias="trueUserInfo" type="com.yds.common.bean.UserInfo"/>	
	<sql id="commonCondition">
		FROM 
			att_overtime T1 INNER JOIN
			(SELECT 
				YEAR,
				MONTH,
				DAY,
				EMP_ID,
				STR_TO_DATE(
					CONCAT_WS(
						'/', YEAR, CONCAT_WS('/', MONTH, DAY)
					), '%Y/%m/%d'
				) AS applyOvertimeDate
			 FROM att_overtime) T3 ON
				T1.EMP_ID = T3.EMP_ID
				AND T1.YEAR = T3.YEAR
				AND T1.MONTH = T3.MONTH
				AND T1.DAY = T3.DAY	LEFT OUTER JOIN
			att_info T2 ON
				T1.EMP_ID = T2.EMP_ID
				AND T1.YEAR = T2.YEAR
				AND T1.MONTH = T2.MONTH
				AND T1.DAY = T2.DAY 
		WHERE
			T1.PRJ_ID = #prjId#
			<isNotEmpty prepend="AND" property="searchStartTime">
				applyOvertimeDate >= #searchStartTime#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="searchEndTime">
				<![CDATA[	
					   applyOvertimeDate <= #searchEndTime#
				]]>
			</isNotEmpty>			
			<!-- 画面所选状态是全部时，无视该条件 -->
			<isNotEqual compareValue="99" prepend="AND" property = "stateFlag">	
				T1.STATE_FLAG = #stateFlag#
			</isNotEqual>
			<isNotEmpty prepend="AND" property="empId">
				T1.EMP_ID = #empId#
			</isNotEmpty>
			<isNotEqual compareValue="99" prepend="AND" property = "benifitFlag">	
				T1.BENEFIT_FLAG = #benifitFlag#
			</isNotEqual>
	</sql>
	<select id="getPrjOvertimeInfoCount" parameterClass="ye0060CondA" resultClass="Long">
		SELECT Count(*) From
			(SELECT 
				T3.applyOvertimeDate AS applyOvertimeDate
			<include refid="commonCondition"/>)	T99	
	</select>
	<select id="getPrjOvertimeInfo" parameterClass="ye0060CondA" resultClass="ye0060Overtime">
		SELECT 
			T3.applyOvertimeDate AS applyOvertimeDate, 
			T1.EMP_ID AS empId, 
			(SELECT EMP_CNM FROM v_emp_list_quit WHERE
				EMP_ID = T1.EMP_ID) AS empName,
			T1.STATE_FLAG AS stateFlag,
			(Select DIFF_NAME 
				FROM sys_code_mst 
				WHERE SUB_SYS='ATT' 
					AND TYPE_ID = 'APP_STATE' 
					AND DIFF_NO =T1.STATE_FLAG) AS stateName,
			T1.APP_START_TIME AS appStartTime,
			T1.APP_END_TIME AS appEndTime,
			T1.OVERTIME_COMMENT AS overtimeComment,
			T1.BENEFIT_FLAG AS benefitFlag,
			(Select DIFF_NAME 
				FROM sys_code_mst 
				WHERE SUB_SYS='ATT' 
					AND TYPE_ID = 'BENEFIT_FLAG' 
					AND DIFF_NO =T1.BENEFIT_FLAG) AS benefitName,
			T2.R_START_TIME AS rstartTime,
			T2.R_END_TIME AS actualEndTime,
			T2.DINNER_TIME_END AS dinnerTimeEnd
		<include refid="commonCondition"/>
		ORDER BY 
			<!-- 统计方式不同，排序方式不同 -->
			<isEqual compareValue="1" property="statisticMode">
				applyOvertimeDate DESC, T1.EMP_ID ASC
			</isEqual>
			<isEqual compareValue="2" property="statisticMode">
				T1.EMP_ID ASC, applyOvertimeDate DESC
			</isEqual>
	</select>
	
	<!-- 取得所有已申请加班的员工 -->
	<select id="getAppliedEmp" parameterClass="attOvertime" resultClass="trueUserInfo">
		SELECT 
			EMP_ID AS userId,
			(SELECT EMP_CNM FROM v_emp_list_quit WHERE
				EMP_ID = T1.EMP_ID) AS userName	
		From 
			att_overtime T1
		WHERE
			T1.YEAR = #year#
			AND T1.MONTH = #month#
			AND T1.DAY = #day#
			<isNotEmpty prepend="AND" property="prjId">
				T1.PRJ_ID = #prjId#
			</isNotEmpty>
	</select>
	<select id="getManageDepts" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT 
			org_id 	
		FROM emp_org_info 
		LEFT JOIN 
			sys_code_mst 
			ON emp_org_info.ORG_PRO_ID = sys_code_mst.diff_no 
			AND sub_sys='EMP' 
			AND type_id='ORG_TYPE'
		WHERE org_lev REGEXP 	
			(SELECT 
				CONCAT( '(^' , GROUP_CONCAT(DISTINCT TRIM(TRAILING '00000' 
					FROM org_lev) SEPARATOR '.*$$)|(^') , '.*$$)' )
			FROM emp_org_info 
			LEFT JOIN sys_code_mst 
				ON emp_org_info.ORG_PRO_ID = sys_code_mst.diff_no 
				AND sub_sys='EMP' 
				AND type_id='ORG_TYPE'
			WHERE  
				pro1 = 'dept'
				AND  ORG_MNGER = #empId#) 
		AND pro1='dept'
		ORDER BY org_lev,ORG_PRO_ID
	</select>
</sqlMap> 