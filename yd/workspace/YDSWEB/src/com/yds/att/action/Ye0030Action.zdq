/*
 * @(#)Ye0030Action.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 共通系统
 */
package com.yds.att.action;

import java.util.List;

import net.sf.json.JSONObject;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.yds.att.bean.AttCorrect;
import com.yds.att.bean.AttInfo;
import com.yds.att.bean.Ye0030AttCorrect;
import com.yds.att.service.Ye0030Service;
import com.yds.att.service.AttConstants.AppStatus;

import com.yds.base.action.AbstractBaseAction;


/**
 * @author 远东) 共通组
 * @version 1.0
 */


@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("ye0030Action")
public class Ye0030Action extends AbstractBaseAction{

	private static final long serialVersionUID = 7438768119848465427L;

	/** 注入Service. */
	private Ye0030Service ye0030Service;

	/** 条件bean/单条明细bean. */
	private Ye0030AttCorrect ye0030AttCorrect;
	private AttCorrect attCorrect;
	private AttInfo attInfo;
	
	/** 一览List. */
	private List<AttCorrect> attCorrectList;
	
	/** 件数. */
	private long count;
	
	/** 登录用户ID. */
	private String loginId;
	
	/** 考勤日期. */
	private String attDate;
	
	/** 考勤信息JSON. */
	private String attTime;
	
	/** 申请编号. */
	private String appId;
	
	/** 错误信息. */
	private String errMsg;
	
	/**
	 * 由检索条件取得一览
	 * @return SUCCESS
	 */
	public String execute() throws Exception{

		//存在考勤日期的情况下
		if (attDate != null || appId != null) {
			ye0030AttCorrect = ye0030Service.getAttCorrectByPk(loginId, attDate, appId);
		} else {
			ye0030AttCorrect = new Ye0030AttCorrect();
			ye0030AttCorrect.setLoginId(loginId);
			ye0030AttCorrect.setLoginName(ye0030Service.getUserNm(loginId));
			ye0030AttCorrect.setFirstTime(" ");
			ye0030AttCorrect.setLastTime(" ");
			ye0030AttCorrect.setBefStarthhmm("");
			ye0030AttCorrect.setBefEndhhmm("");
			ye0030AttCorrect.setAttExamin(ye0030Service.getFlow(loginId, attDate));
			ye0030AttCorrect.setStatusCor("");
		}

		return SUCCESS;
		
	}

	public String getLoginId() {
		return loginId;
	}

	public void setLoginId(String loginId) {
		this.loginId = loginId;
	}
	
	public String getAttDate() {
		return attDate;
	}

	public void setAttDate(String attDate) {
		this.attDate = attDate;
	}
	
	public String getAttTime() {
		return attTime;
	}

	public void setAttTime(String attTime) {
		this.attTime = attTime;
	}

	/**
	 * 取得明细
	 * @return SUCCESS
	 */
	public String findById() throws Exception{

		ye0030AttCorrect = ye0030Service.getAttCorrectByPk(loginId, attDate, appId);

		//取得审批流程
		ye0030AttCorrect.setAttExamin(ye0030Service.getFlow(loginId, attDate));

		JSONObject json = JSONObject.fromObject(ye0030AttCorrect);
		this.setAttTime(json.toString());

		return SUCCESS;
	}
	
	/**
	 * 取得明细
	 * @return SUCCESS
	 */
	public String findAttInfoById(){

		attInfo = ye0030Service.getAttInfoByPk(attInfo);

		return SUCCESS;
	}
	
	/**
	 * 取得明细
	 * @return SUCCESS
	 */
	public String ye0031TestInit(){

		return SUCCESS;
	}
	
	/**
	 * 更新处理
	 * @return SUCCESS
	 */
	public String update(){
		ye0030Service.updateAttCorrect(attCorrect);
		return SUCCESS;
	}
	
	
	/**
	 * 插入处理
	 * @return SUCCESS
	 * @throws Exception 
	 */
	public String insert() throws Exception{
		//考勤申请状态检查处理
		AttInfo attInfo = new AttInfo();
		attInfo.setEmpId(ye0030AttCorrect.getLoginId());
		attInfo.setYear(attDate.substring(0, 4));
		attInfo.setMonth(attDate.substring(5, 7));
		attInfo.setDay(attDate.substring(8, 10));
		
		//考勤信息取得
		attInfo = ye0030Service.getAttInfoByPk(attInfo);
		
		//考勤申请待审批状态下或者审批中状态下
		if (AppStatus.PENDING.value().equals(attInfo.getAttStatusCor()) || AppStatus.APP_ING.value().equals(attInfo.getAttStatusCor())) { 
			this.setErrMsg("考勤申请状态已变更！");
			return ERROR;
		}

		//考勤申请信息登录处理
		ye0030Service.insertAttCorrect(ye0030AttCorrect, attDate, attInfo);
		return SUCCESS;
	}
	
	/**
	 * 删除处理
	 * @return SUCCESS
	 */
	public String delete() throws Exception{
		//考勤申请状态检查处理
		AttInfo attInfo = new AttInfo();
		attInfo.setEmpId(ye0030AttCorrect.getLoginId());
		attInfo.setYear(attDate.substring(0, 4));
		attInfo.setMonth(attDate.substring(5, 7));
		attInfo.setDay(attDate.substring(8, 10));
		
		//考勤信息取得
		attInfo = ye0030Service.getAttInfoByPk(attInfo);
		
		//考勤申请待审批状态下或者审批中状态下
		if (!AppStatus.PENDING.value().equals(attInfo.getAttStatusCor()) && !AppStatus.APP_ING.value().equals(attInfo.getAttStatusCor())) { 
			this.setErrMsg("考勤申请状态已变更！");
			return ERROR;
		}
		
		//考勤申请信息撤销处理
		ye0030Service.deleteAttCorrect(ye0030AttCorrect, attDate, attInfo);
		return SUCCESS;
	}
	
	/**
	 * @param ye0030Service
	 *            the ye0030Service to set
	 */
	public void setYe0030Service(Ye0030Service ye0030Service) {
		this.ye0030Service = ye0030Service;
	}	

	/**
	 * @param attCorrect
	 *            the attCorrect to set
	 */
	public void setAttCorrect(AttCorrect attCorrect) {
		this.attCorrect = attCorrect;
	}	
	
	/**
	 *  @return the attCorrect
	 */
	public AttCorrect getAttCorrect() {
		return attCorrect;
	}	
	
	/**
	 * @param attCorrect
	 *            the attCorrect to set
	 */
	public void setYe0030AttCorrect(Ye0030AttCorrect ye0030AttCorrect) {
		this.ye0030AttCorrect = ye0030AttCorrect;
	}	
	
	/**
	 *  @return the attCorrect
	 */
	public Ye0030AttCorrect getYe0030AttCorrect() {
		return ye0030AttCorrect;
	}
	
	/**
	 *  @return the attCorrectList
	 */
	public List<AttCorrect> getAttCorrectList() {
		return attCorrectList;
	}	
	
	/**
	 *  @return the count
	 */
	public long getCount() {
		return count;
	}	

	public void setAppId(String appId) {
		this.appId = appId;
	}

	public String getAppId() {
		return appId;
	}

	public void setErrMsg(String errMsg) {
		this.errMsg = errMsg;
	}

	public String getErrMsg() {
		return errMsg;
	}
}
