<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="SysLogSearchDao">
	<typeAlias alias="sysLogInfo" type="com.yds.common.bean.SysLogSearchInfo"/>
	<!-- 用于SQL查询公用抽取语句 -->	
	<sql id="sysLogSearch">
		FROM COM_LOG_MST T1
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="logLevel">
				 T1.LOG_LEVEL = #logLevel#
			</isNotEmpty>
		    <isNotEmpty prepend="AND" property="subId">
				 T1.SUB_ID = #subId#
		    </isNotEmpty>
		    <isNotEmpty prepend="AND" property="userId">
				 T1.USER_ID = #userId#
		    </isNotEmpty>
		    <isEqual property="checkFlg" compareValue="false">
				<isNotEmpty prepend="AND" property="logMsg">
					T1.LOG_MSG LIKE CONCAT('%' ,#logMsg#, '%')
				</isNotEmpty>
			</isEqual>
			<isEqual property="checkFlg" compareValue="true">
			   <isNotEmpty prepend="AND" property="logMsg">
					T1.LOG_MSG REGEXP #logMsg#
			   </isNotEmpty>
		    </isEqual>
		    <isNotEmpty prepend="AND" property="opId">
				 T1.OP_ID = #opId#
			</isNotEmpty>
		    <isEqual property="checkFlg" compareValue="false">
				<isNotEmpty prepend="AND" property="logIp">
					T1.LOG_IP LIKE CONCAT('%' ,#logIp#, '%')
				</isNotEmpty>
			</isEqual>
			<isEqual property="checkFlg" compareValue="true">
			   <isNotEmpty prepend="AND" property="logIp">
					T1.LOG_IP REGEXP #logIp#
			   </isNotEmpty>
		    </isEqual>
		    <isNotEmpty prepend="AND" property="fromTime">
				  T1.OP_TIME >= #fromTime#
		    </isNotEmpty>
		    <isNotEmpty prepend="AND" property="toTime">
				  #toTime# > T1.OP_TIME
		    </isNotEmpty>
		</dynamic>	
			ORDER BY T1.OP_TIME DESC
	</sql>
	
	<!-- 日志信息取得 --> 
	<select id="getSysLogInfoList" parameterClass="sysLogInfo" resultClass="sysLogInfo"> 
		SELECT
			T1.LOG_ID AS logId,
			T1.OP_TIME AS opTime,
			T1.OP_ID AS opId,	
			(SELECT T2.EMP_CNM FROM V_EMP_LIST_QUIT T2 WHERE T2.EMP_ID = T1.OP_ID) AS userCnm,
			T1.SUB_ID AS subId,
			(SELECT T3.DIFF_NAME FROM SYS_CODE_MST T3 WHERE T1.SUB_ID=T3.DIFF_NO AND T3.TYPE_ID = 'permgroup') AS diffName, 
			T1.LOG_MSG AS logMsg,		
		    (SELECT T3.TYPE_ID FROM SYS_CODE_MST T3 WHERE T1.SUB_ID=T3.DIFF_NO AND T3.TYPE_ID = 'permgroup') AS typeId, 
			T1.LOG_IP AS logIp
		<include refid="sysLogSearch"/>
	</select>
	<!-- 日志信息总数 --> 
	<select id="getTotalCount" parameterClass="sysLogInfo" resultClass="Long"> 
		SELECT
			COUNT(*)
			<include refid="sysLogSearch"/>
	</select>
</sqlMap>  