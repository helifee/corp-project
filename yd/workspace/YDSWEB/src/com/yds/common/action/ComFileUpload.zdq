package com.yds.common.action;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.Calendar;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.yds.base.action.AbstractBaseAction;
import com.yds.common.service.CommonConstants;
import com.yds.util.service.FileUtil;

@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("comFileUpload")
public class ComFileUpload extends AbstractBaseAction {

	private static final long serialVersionUID = 5451146842438359277L;

	private File upload;
	private String uploadContentType;
	private String uploadFileName;
	private String fileId;

	@Override
	public String execute() throws Exception {

		fileId = "" + Calendar.getInstance().getTimeInMillis() + (int)(10000 + Math.random() * 10000) + FileUtil.getExt(uploadFileName);
		String fullPath = propMgr.getParameter(CommonConstants.FILE_PATH.TEMP_PATH.value()) + "/" + fileId;

		FileInputStream fis = null;
		FileOutputStream fos = null;

		try {
			fis = new FileInputStream(upload);
			fos = new FileOutputStream(fullPath);
			byte[] buffer = new byte[1024];
			int len = 0;
			while ((len = fis.read(buffer)) > 0) {
				fos.write(buffer, 0, len);
			}
		} catch (IOException e) {
			e.printStackTrace();
			addFieldError("upload",propMgr.getMessage("yds.com.error.0001"));
			return INPUT;
		} finally {
			try {
				if (fis != null) {
					fis.close();
				}
			} catch (IOException e2) {
				e2.printStackTrace();
			} finally {
				if (fos != null) {
					fos.close();
				}
			}
		}

		return SUCCESS;
	}

	public File getUpload() {
		return upload;
	}

	public void setUpload(File upload) {
		this.upload = upload;
	}

	public String getUploadContentType() {
		return uploadContentType;
	}

	public void setUploadContentType(String uploadContentType) {
		this.uploadContentType = uploadContentType;
	}

	public String getUploadFileName() {
		return uploadFileName;
	}

	public void setUploadFileName(String uploadFileName) {
		this.uploadFileName = uploadFileName;
	}

	public void setFileId(String fileId) {
		this.fileId = fileId;
	}

	public String getFileId() {
		return fileId;
	}

}
