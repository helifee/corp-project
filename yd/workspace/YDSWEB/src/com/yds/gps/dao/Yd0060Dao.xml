<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Yd0060Dao">
    <typeAlias alias="gpsOrderInfo" type="com.yds.gps.common.bean.GpsOrderInfo"/>
	<typeAlias alias="yd0060OrderInfo" type="com.yds.gps.bean.Yd0060OrderInfo"/>
    <typeAlias alias="gpsOrderDetail" type="com.yds.gps.bean.GpsOrderDetail"/>
    <typeAlias alias="gpsOrderGoods" type="com.yds.gps.bean.GpsOrderGoods"/>

	<!-- 取得订单基本信息 --> 
	<select id="getGpsOrderInfo" parameterClass="String" resultClass="yd0060OrderInfo">
		SELECT 
			T1.order_id AS orderId, 
			T1.order_content AS orderContent,  
			(SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST 
			WHERE DIFF_NO = T1.pay_flag AND TYPE_ID = 'PAYMENT' AND SUB_SYS = 'GPS') AS payFlag,
			T1.SWITCH_FLAG as switchFlag,
			(SELECT DIFF_SHORT_NAME FROM SYS_CODE_MST 
			WHERE DIFF_NO = T1.SWITCH_FLAG AND TYPE_ID = 'ORDER_SWCH' AND SUB_SYS = 'GPS') AS switchName,
			ORDER_CNT as orderCnt,
			BUSS_FLAG as bussFlag,
			GOODS_CATE_ID as goodsCateId,
			T1.order_remarks AS orderRemarks
		FROM 
			gps_order_info T1
		WHERE 
			T1.order_id = #orderId# 
	</select>
	
	<!-- 取得订购一览 --> 
	<select id="getGpsOrderDetail" parameterClass="String" resultClass="gpsOrderDetail">
		SELECT 
			T1.store as store,
			T1.goods_id as goodsId,
			T1.goods_name as goodsName,
			T2.CUSTOMER_ID as customerId,
			(SELECT emp_cnm FROM v_emp_list_quit WHERE EMP_ID = T2.CUSTOMER_ID) as customerNm,
			COALESCE(T2.CLOSE_UNIT_PRICE,T4.GPS_PRICE,0) AS closeUnitPrice,
			COALESCE(T2.order_cnt,0) AS orderCnt,
			COALESCE(T2.CLOSE_UNIT_PRICE,T4.GPS_PRICE,0) * COALESCE(T2.order_cnt,0) AS totalPrice
		FROM gps_goods_info T1
		INNER JOIN gps_order_info T3
			ON T3.GOODS_CATE_ID=T1.GOODS_CATE_ID
		inner JOIN gps_order_goods T4
			ON T4.GOODS_ID=T1.GOODS_ID 
			AND T4.ORDER_ID=T3.ORDER_ID
		LEFT JOIN gps_order_detail T2
			ON T2.GOODS_ID=T1.GOODS_ID 
			AND T2.ORDER_ID=T3.ORDER_ID
		WHERE 
			T3.ORDER_ID=#orderId#
			AND (T1.GOODS_SWITCH=1 OR T2.CUSTOMER_ID IS NOT NULL)
		ORDER BY T1.store,T1.goods_id,T2.CUSTOMER_ID;
	</select>
	
	<!-- 取得订购者一览 -->
	<select id="getOrders" parameterClass="String" resultClass="gpsOrderDetail">
		
		SELECT 	
			gps_order_detail.CUSTOMER_ID AS customerId, 
			gps_order_detail.GOODS_ID AS goodsId, 
			gps_order_detail.CLOSE_UNIT_PRICE * gps_order_detail.ORDER_CNT AS totalPrice,
			gps_goods_cate.CATE_NAME as cateName
		FROM 
			gps_order_detail
		INNER JOIN gps_order_info
			ON gps_order_info.ORDER_ID=gps_order_detail.ORDER_ID
		LEFT OUTER JOIN	gps_goods_cate
			ON gps_goods_cate.GOODS_CATE_ID=gps_order_info.GOODS_CATE_ID
		WHERE 
			gps_order_detail.ORDER_ID=#orderId#
	</select>
	 
	<!-- 删除订单 -->
	<delete id="deleteOrder" parameterClass="String">
		DELETE 
			gps_order_info,
			gps_order_detail,
			gps_order_goods  
		FROM gps_order_info
		LEFT JOIN gps_order_detail 
			ON gps_order_detail.ORDER_ID=gps_order_info.ORDER_ID
		LEFT JOIN gps_order_goods 
			ON gps_order_goods.ORDER_ID=gps_order_info.ORDER_ID
		WHERE gps_order_info.ORDER_ID=#orderId#
	</delete>
	
	<!-- 取得订单信息 -->
	<select id="getOrderInfo" parameterClass="String" resultClass="gpsOrderInfo">
		SELECT
			ORDER_CONTENT AS orderContent,
			ORDER_REMARKS AS orderRemarks,
			UPDATE_USER as updateUser
		FROM 
		    GPS_ORDER_INFO
		WHERE
		    ORDER_ID=#orderId#
	</select>
	
	<!-- 修改订单信息 -->
	<update id="updateOrderInfo" parameterClass="gpsOrderInfo">
		UPDATE GPS_ORDER_INFO
		SET
			ORDER_CONTENT=#orderContent#,
			ORDER_REMARKS=#orderRemarks#
		WHERE
			ORDER_ID=#orderId#
    </update>
	<!-- 更新订购者（不存在追加） -->
	<insert id="insertOrder" parameterClass="gpsOrderDetail">
		INSERT INTO GPS_ORDER_DETAIL
		(
		   ORDER_ID,
		   CUSTOMER_ID,
		   GOODS_ID,
		   CLOSE_UNIT_PRICE,
		   ORDER_CNT,
		   ORDER_TIME
		 )
		 VALUES
		 (
			 #orderId#,
			 #customerId#,
			 #goodsId#,
			 #closeUnitPrice#,
			 #orderCnt#,
			 NOW()
		  )
	</insert>
	
	<!-- 取得订单信息 -->
	<select id="getOrderCnt" parameterClass="gpsOrderDetail" resultClass="String">
		SELECT
			ORDER_CNT AS orderCnt
		FROM 
		    gps_order_goods
		WHERE
		    ORDER_ID=#orderId# AND
			GOODS_ID=#goodsId# 
	</select>
	
	<!-- 取得订单份数 -->
	<select id="getTotalOrderCnt" parameterClass="String" resultClass="String">
		SELECT
			ORDER_CNT AS orderCnt 
		FROM 
		    gps_order_info
		WHERE
		    ORDER_ID=#orderId#
	</select>
	<!-- 取得个人的订购份数-->
	<select id="getDeleteCnt" parameterClass="gpsOrderDetail" resultClass="String">
		SELECT
			ORDER_CNT AS orderCnt
		FROM 
		    gps_order_detail
		WHERE
		    ORDER_ID=#orderId# AND
			GOODS_ID=#goodsId# AND
			CUSTOMER_ID=#customerId#
	</select>
	<!-- 更新gps_order_goods的订购份数 -->
	<update id="updateOrderGoods" parameterClass="gpsOrderDetail">
		UPDATE GPS_ORDER_GOODS
		SET
			ORDER_CNT=#orderCnt#
		WHERE
			ORDER_ID=#orderId# AND
			GOODS_ID=#goodsId# 
    </update>
	
	<!-- 更新gps_order_info的订购份数-->
	<update id="updateGpsOrderInfo" parameterClass="gpsOrderDetail">
		UPDATE gps_order_info
		SET
			ORDER_CNT=#orderCnt#
		WHERE
			ORDER_ID=#orderId#
    </update>
	<!-- 更新订购者（已存在追加） -->
	<update id="updateOrderDetail" parameterClass="gpsOrderDetail">
		UPDATE gps_order_detail
		SET
			ORDER_CNT=#orderCnt#
		WHERE
			ORDER_ID=#orderId# AND
			GOODS_ID=#goodsId# AND
			CUSTOMER_ID=#customerId#
    </update>
	
	<!-- 结束订单 -->
	<update id="updateEndOrder" parameterClass="java.util.HashMap">
		UPDATE GPS_ORDER_INFO
		SET
			UPDATE_TIME=now(),
			UPDATE_USER=#userId#,
			SWITCH_FLAG='0'
		WHERE
			ORDER_ID=#orderId#
    </update>
	
	<!-- 删除订购者 -->
	<delete id="deleteGoodsOrder" parameterClass="gpsOrderDetail">
		DELETE FROM gps_order_detail
		WHERE
			ORDER_ID=#orderId# AND
			GOODS_ID=#goodsId# AND
			CUSTOMER_ID=#customerId#
	</delete>
	
	<!-- 取得个人账户余额 --> 
	<select id="getPesonRemain" parameterClass="String" resultClass="String"> 
		SELECT 
			ACC_SUM 
		FROM 
		   GPS_ACCOUNT
		WHERE
			ACC_ID=#pesAccId#
     </select>
	 <!-- 取得商品分类名称 --> 
	<select id="getgoodsCateName" parameterClass="String" resultClass="String"> 
		SELECT 
			CATE_NAME 
		FROM 
		   GPS_GOODS_CATE
		WHERE
			GOODS_CATE_ID=#goodsCateId#
     </select>
	
	<!-- 取得订单信息 -->
	<select id="getTotalOrderMoney" parameterClass="String" resultClass="Double">
		SELECT
			SUM(CLOSE_UNIT_PRICE*order_cnt) as money
		FROM gps_order_detail 
		WHERE order_id=#orderId#
	</select>
</sqlMap>