/*
 * @(#)Yd0030ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 社内团购系统
 */
package com.yds.gps.service.impl;

import java.util.Iterator;
import java.util.List;

import org.springframework.stereotype.Service;

import com.yds.base.service.AbstractBaseService;
import com.yds.common.service.SessionConstants;
import com.yds.common.service.CommonConstants.MsgTypeEnum;
import com.yds.common.service.CommonConstants.SparkMsgIDEnum;
import com.yds.common.service.CommonConstants.SparkSysIDEnum;
import com.yds.gps.bean.GpsAccount;
import com.yds.gps.bean.GpsGoodsCate;
import com.yds.gps.bean.GpsGoodsInfo;
import com.yds.gps.bean.GpsOrderGoods;
import com.yds.gps.bean.Yd0030CondA;
import com.yds.gps.common.bean.GpsOrderInfo;
import com.yds.gps.common.dao.TansferDao;
import com.yds.gps.dao.Yd0030Dao;
import com.yds.gps.service.GpsConstants;
import com.yds.gps.service.Yd0030Service;
import com.yds.util.bean.SparkMessagerBean;
import com.yds.util.service.SendMessage;
import com.yds.util.service.ServerInfo;

/**
 * @see com.yds.gps.service.Yd0030Service
 *
 */
@Service("yd0030Service")
public class Yd0030ServiceImpl extends AbstractBaseService implements
		Yd0030Service {

	private Yd0030Dao yd0030Dao;
	private TansferDao tansferDao;
	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public GpsOrderInfo getYd0030OrderInfo(String orderId) {
		return yd0030Dao.getYd0030OrderInfo(orderId);
	}

	@Override
	public GpsAccount getGpsAccount(String accId) {
		GpsAccount gpsAccount = tansferDao.getGpsAccount(accId);
		if (null == gpsAccount) {
			gpsAccount = new GpsAccount();
			gpsAccount.setAccId(accId);
			gpsAccount.setAccFlag(GpsConstants.ACC_PERSON);
			gpsAccount.setAccSum(0);
		}

		return gpsAccount;
	}

	@Override
	public List<GpsGoodsCate> getGpsGoodsCateList(GpsAccount account) {

		return yd0030Dao.getGpsGoodsCateList(account);
	}

	@Override
	public List<GpsGoodsInfo> getGpsGoodsInfoList(Yd0030CondA condA) {

		return yd0030Dao.getGpsGoodsInfoList(condA);
	}

	@Override
	public Object insertGpsOrderGoods(GpsOrderGoods orderGoods) {
		
		return yd0030Dao.insertGpsOrderGoods(orderGoods);
	}

	@Override
	public Object insertGpsOrderInfo(GpsOrderInfo orderInfo) {

		return yd0030Dao.insertGpsOrderInfo(orderInfo);
	}


	public void setYd0030Dao(Yd0030Dao yd0030Dao) {
		this.yd0030Dao = yd0030Dao;
	}

	public TansferDao getTansferDao() {
		return tansferDao;
	}

	public void setTansferDao(TansferDao tansferDao) {
		this.tansferDao = tansferDao;
	}

	@Override
	public List<String> getYd0030OrderGoodsList(String orderId) {
		
		return yd0030Dao.getYd0030OrderGoodsList(orderId);
	}

	@Override
	public void insertGpsOrderGoodsInfo(GpsOrderInfo orderInfo,
			List<GpsGoodsInfo> goodsInfoList) {
		
		// 生成订单信息
		yd0030Dao.insertGpsOrderInfo(orderInfo);
		
		// 设置订单商品表
		Iterator<GpsGoodsInfo> gpsgoodsInfo = goodsInfoList.iterator();
		while (gpsgoodsInfo.hasNext()) {
			GpsGoodsInfo goodsInfo = gpsgoodsInfo.next();
			if (!"false".equals(goodsInfo.getGoodsId())) {
				GpsOrderGoods orderGoods = new GpsOrderGoods();
				orderGoods.setOrderId(orderInfo.getOrderId());
				orderGoods.setGoodsId(goodsInfo.getGoodsId());
				orderGoods.setGpsPrice(goodsInfo.getGoodsPrice());
				
				yd0030Dao.insertGpsOrderGoods(orderGoods);
			}
		}
		
		// Spark信息的发送
		SparkMessagerBean sparkMessagerBean = new SparkMessagerBean();
		// 消息的链接
		sparkMessagerBean.setMsg_url(ServerInfo.getURLPath()
				+ GpsConstants.SYSTEM_NAME + "/yd0070Init?orderId="
				+ orderInfo.getOrderId() + "&" + SessionConstants.REQUESTTARGET + "=1");
		// 发送消息的系统ID
		sparkMessagerBean.setSystem_id(SparkSysIDEnum.GP);
		// 发送消息的消息类型ID
		sparkMessagerBean.setMsg_id(SparkMsgIDEnum.GP_GP);
		// 消息内部用ID
		sparkMessagerBean.setSign(orderInfo.getOrderId());
		// spark 消息类型
		sparkMessagerBean.setStatus(MsgTypeEnum.INSERT);
		// 要发送的人员一览
		sparkMessagerBean.setEmpid(new String[]{"0"});
		// 消息的内容
		sparkMessagerBean.setMsg_content(propMgr.getMessage("yds.gps.info.0021", orderInfo.getOrderContent()));
		
		SendMessage.asyncSend(sparkMessagerBean);
		
	}
}
