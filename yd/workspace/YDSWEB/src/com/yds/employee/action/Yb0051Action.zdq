/*
 * @(#) yb0051Action.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 员工管理
 */

package com.yds.employee.action;

import java.util.List;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.opensymphony.xwork2.Preparable;
import com.yds.base.action.AbstractBaseAction;
import com.yds.common.bean.EmpInfo;
import com.yds.common.bean.EmpOrgInfo;
import com.yds.common.service.SessionService;
import com.yds.employee.bean.Yb0051CondA;
import com.yds.employee.service.Yb0051Service;
import com.yds.util.service.StringUtil;

/**
 * 
 *部门信息画面
 * 
 * @author pengchuan
 * @version 1.00 2010/07/22
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("yb0051Action")
public class Yb0051Action extends AbstractBaseAction implements Preparable {

	private static final long serialVersionUID = -1925643056107639542L;

	private Yb0051Service yb0051Service;
	/** 级别列表信息 */
	private List<Yb0051CondA> orgStateList;
	/** 级别信息 */
	private Yb0051CondA orgState;
	/** 级别信息 */
	private Yb0051CondA orgState2;

	/** 下级部门信息 */
	private EmpOrgInfo empOrgInfo;
	/** 得到主管名字Bean */
	private EmpInfo empInfo;
	/** 模式 */
	private Integer mode;
	/** 上级部门 */
	private EmpOrgInfo empOrgInfo2;
	/** 部门姓名 */
	private String orgMngerNm;

	/** 下级部门Id */
	private String orgId;
	/** 下级部门级别序 */
	private String dispSeqDown;

	/** 上级部门Id */
	private String orgId2;
	/** 上级部门级别序 */
	private String dispSeqUp;
	/** 部门级别序 */
	private String dispSeq;
	/** 员工状态一览**/
	private List<EmpInfo> empInfoList;
	
	/** 第一次LoadFlg*/
	private String firstFlg;
	
	@Override
	public void prepare() throws Exception {

		// 取得部门级别一览(下拉菜单内容取得)
		this.orgStateList = yb0051Service.getOrgMngerList("EMP", "ORG_TYPE");
	}

	/**
	 * 画面的初期显示 部门级别和上级部门取得
	 * 
	 * @return SUCCESS
	 */
	public String execute() throws Exception {
       
		
		// 查看和修改模式下的初期画面
		if (mode == 2 || mode == 3) {
			if(!"".equals(orgId2)){
			empOrgInfo = yb0051Service.getOrgInfo(orgId);
			empOrgInfo2 = yb0051Service.getOrgSName(orgId2);
			orgState = yb0051Service.getOrgMnger(empOrgInfo.getOrgProId());
			orgState2 = yb0051Service.getOrgMnger(empOrgInfo2.getOrgProId());
			if (!"".equals(empOrgInfo.getOrgMnger())) {

				empInfo = yb0051Service.getEmpCnm(empOrgInfo.getOrgMnger());
				if (empInfo == null) {
					return SUCCESS;
				}
			} else {
				return SUCCESS;
			}
			if (empInfo.getEmpId() != null) {

				empInfo.setEmpId(StringUtil.leftTrimYd(empInfo.getEmpId()));

			}
			}
			else{
				empOrgInfo = yb0051Service.getOrgInfo(orgId);
				orgState = yb0051Service.getOrgMnger(empOrgInfo.getOrgProId());
				if (!"".equals(empOrgInfo.getOrgMnger())) {

					empInfo = yb0051Service.getEmpCnm(empOrgInfo.getOrgMnger());
					if (empInfo == null) {
						return SUCCESS;
					}
				} else {
					return SUCCESS;
				}
				if (empInfo.getEmpId() != null) {

					empInfo.setEmpId(StringUtil.leftTrimYd(empInfo.getEmpId()));

				}
			}
		}

		// 新规模式下初期画面
		if (mode == 1) {

			empOrgInfo2 = yb0051Service.getOrgSName(orgId2);
			orgState = yb0051Service.getOrgMnger(empOrgInfo2.getOrgProId());

		}

		return SUCCESS;
	}

	/**
	 * 修改部门信息
	 * 
	 * @return String
	 */
	public String modifyOrgInfo() throws Exception {

		EmpOrgInfo bean = new EmpOrgInfo();
		bean.setOrgId(orgId);
		bean.setOrgNm(empOrgInfo.getOrgNm());
		bean.setOrgSnm(empOrgInfo.getOrgSnm());
		if (empInfo.getEmpId() != null) {

			bean.setOrgMnger(StringUtil.leftPadYd(empInfo.getEmpId()));

		}
		bean.setOrgProId(orgState.getDiffNo());
		bean.setOrgDesc(empOrgInfo.getOrgDesc());
		bean.setOrgMngerNm(empInfo.getEmpCnm());

		if (yb0051Service.updateOrgInfo(bean)) {
			return SUCCESS;
		}
		return ERROR;
	}

	/**
	 * 修改部门级别校验
	 */
	public void validateModifyOrgInfo() {

		// String orgProId2= empOrgInfo2.getOrgProId();
		// String diffName2=orgState2.getDiffName();
		// empOrgInfo.setOrgProId(orgState.getDiffNo());
		// orgState=yb0051Service.getOrgMnger(empOrgInfo.getOrgProId());
		// String diffName=orgState.getDiffName();
		// String orgProId=empOrgInfo.getOrgProId();
		// int orgProIdInt2=Integer.parseInt(orgProId2);
		// int orgProIdInt=Integer.parseInt(orgProId);
		//		 
		// if(orgProIdInt<orgProIdInt2){
		//			 
		// this.addFieldError("empOrgInfo.orgDesc",
		// propMgr.getMessage("yds.emp.error.0001",diffName , diffName2));
		// }

		// ======== 2010/08/16 滕长龙对应部门校验 start ==============

		// 取得级别
		String orgProId = orgState.getDiffNo();
		String level = yb0051Service.getDispSeq(orgProId);

		if (0 >= level.compareTo(dispSeqUp)) {
			this.addFieldError("orgState.diffNo", propMgr
					.getMessage("yds.emp.error.0001"));
		}
		if (0 <= level.compareTo(dispSeqDown)) {
			this.addFieldError("orgState.diffNo", propMgr
					.getMessage("yds.emp.error.0011"));
		}
		orgMngerNm=empInfo.getEmpCnm();
			this.setEmpInfoList(yb0051Service.getEmpInfoList());
		
		//员工姓名检查
		if(!yb0051Service.empNameCheck(empInfoList, orgMngerNm)){
			this.addFieldError("empInfo.empCnm", propMgr.getMessage("yds.com.warning.0004","员工姓名"));
		}

		// ======== 2010/08/16 滕长龙对应部门校验 end ===============

	}

	/**
	 * 新建部门信息
	 * 
	 * @return String
	 */
	public String insertOrgInfo() throws Exception {

		if (empInfo.getEmpId() != null) {

			this.empOrgInfo.setOrgMnger(StringUtil
					.leftPadYd(empInfo.getEmpId()));

		}
		// 登录者信息的添加
		this.empOrgInfo.setUpdateUser(SessionService.getLoginUserId());

		if (yb0051Service.insertOrgInfo(empOrgInfo, orgState, orgId2)) {
			return SUCCESS;
		}
		return ERROR;
	}

	/**
	 * 新建部门级别校验
	 */
	public void validateInsertOrgInfo() {

//		String orgProId2 = empOrgInfo2.getOrgProId();
//		String diffName2 = orgState2.getDiffName();
//		EmpOrgInfo bean = new EmpOrgInfo();
//		bean.setOrgProId(orgState.getDiffNo());
//		String orgProId = bean.getOrgProId();
//		orgState = yb0051Service.getOrgMnger(orgProId);
//		String diffName = orgState.getDiffName();
//		int orgProIdInt2 = Integer.parseInt(orgProId2);
//		int orgProIdInt = Integer.parseInt(orgProId);
//		if (orgProIdInt < orgProIdInt2) {
//
//			this.addFieldError("empOrgInfo.orgDesc", propMgr.getMessage(
//					"yds.emp.error.0001", diffName, diffName2));
//		}
		// ======== 2010/08/16 滕长龙对应部门校验 start ==============

		// 取得设定级别
		String orgProId = orgState.getDiffNo();
		String level = yb0051Service.getDispSeq(orgProId);	

		if (0 >= level.compareTo(dispSeq)) {
			this.addFieldError("orgState.diffNo", propMgr
					.getMessage("yds.emp.error.0001"));
		}
		orgMngerNm=empInfo.getEmpCnm();
		this.setEmpInfoList(yb0051Service.getEmpInfoList());
	
	//员工姓名检查
	if(!yb0051Service.empNameCheck(empInfoList, orgMngerNm)){
		this.addFieldError("empInfo.empCnm", propMgr.getMessage("yds.com.warning.0004","员工姓名"));
	}

		// ======== 2010/08/16 滕长龙对应部门校验 end ===============

	}

	public void setYb0051Service(Yb0051Service yb0051Service) {
		this.yb0051Service = yb0051Service;
	}

	public List<Yb0051CondA> getOrgStateList() {
		return orgStateList;
	}

	public void setOrgStateList(List<Yb0051CondA> orgStateList) {
		this.orgStateList = orgStateList;
	}

	public Integer getMode() {
		return mode;
	}

	public void setMode(Integer mode) {
		this.mode = mode;
	}

	public EmpOrgInfo getEmpOrgInfo2() {
		return empOrgInfo2;
	}

	public void setEmpOrgInfo2(EmpOrgInfo empOrgInfo2) {
		this.empOrgInfo2 = empOrgInfo2;
	}

	public EmpOrgInfo getEmpOrgInfo() {
		return empOrgInfo;
	}

	public void setEmpOrgInfo(EmpOrgInfo empOrgInfo) {
		this.empOrgInfo = empOrgInfo;
	}

	public String getOrgId() {
		return orgId;
	}

	public void setOrgId(String orgId) {
		this.orgId = orgId;
	}

	public String getOrgId2() {
		return orgId2;
	}

	public void setOrgId2(String orgId2) {
		this.orgId2 = orgId2;
	}

	public EmpInfo getEmpInfo() {
		return empInfo;
	}

	public void setEmpInfo(EmpInfo empInfo) {
		this.empInfo = empInfo;
	}

	public Yb0051CondA getOrgState() {
		return orgState;
	}

	public void setOrgState(Yb0051CondA orgState) {
		this.orgState = orgState;
	}

	public String getDispSeqMin() {
		return dispSeqDown;
	}

	public void setDispSeqMin(String dispSeqMin) {
		this.dispSeqDown = dispSeqMin;
	}

	public String getDispSeq() {
		return dispSeq;
	}

	public void setDispSeq(String dispSeq) {
		this.dispSeq = dispSeq;
	}

	public String getDispSeqDown() {
		return dispSeqDown;
	}

	public void setDispSeqDown(String dispSeqDown) {
		this.dispSeqDown = dispSeqDown;
	}

	public String getDispSeqUp() {
		return dispSeqUp;
	}

	public void setDispSeqUp(String dispSeqUp) {
		this.dispSeqUp = dispSeqUp;
	}

	public String getOrgMngerNm() {
		return orgMngerNm;
	}

	public void setOrgMngerNm(String orgMngerNm) {
		this.orgMngerNm = orgMngerNm;
	}
	public Yb0051CondA getOrgState2() {
		return orgState2;
	}

	public void setOrgState2(Yb0051CondA orgState2) {
		this.orgState2 = orgState2;
	}

	public List<EmpInfo> getEmpInfoList() {
		return empInfoList;
	}

	public void setEmpInfoList(List<EmpInfo> empInfoList) {
		this.empInfoList = empInfoList;
	}

	public String getFirstFlg() {
		return firstFlg;
	}

	public void setFirstFlg(String firstFlg) {
		this.firstFlg = firstFlg;
	}

}
