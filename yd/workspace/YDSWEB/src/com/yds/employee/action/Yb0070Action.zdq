/*
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 人员管理
 */

package com.yds.employee.action;

import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;
import com.yds.base.action.AbstractBaseAction;
import com.yds.common.bean.ComCodeInfo;
import com.yds.common.service.ComCodeInfoService;
import com.yds.common.service.CommonConstants;
import com.yds.common.service.UserService;
import com.yds.employee.bean.Yb0070CondA;
import com.yds.employee.bean.Yb0071CondA;
import com.yds.employee.service.Yb0070Service;

/**
 * 人员管理组信息管理处理。
 * 
 * @author fangjiayuan
 * @version 1.00 2010/08/05
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("yb0070Action")
public class Yb0070Action extends AbstractBaseAction {
	
	private static final long serialVersionUID = -8748054838934831773L;
	
	private Yb0070Service yb0070Service;
	private ComCodeInfoService comCodeInfoService;
	private UserService userService;
	
	/** 组信息一览 */
	private List<Yb0070CondA> teamInfoList;
	
	/** 申请内容信息一览 */
	private Map<String,String> applayMap;

	/** 组信息件数 */
	private int teamInfosCnt;
	
	/** 属性一览 */
	private List<ComCodeInfo> teamTypeList;
	
	/** 组别Id */
	private String teamId;
	
	/** 组信息 */
	private Yb0070CondA teamInfo;
	
	/** 组成员信息 */
	private Yb0071CondA yb0071CondA;
	
	/** 是否需要申请Flg */
	private String joinApplyFlg;
	
	/** 申请Flg */
	private Boolean applayFlg;
	
	/** 权限判断 */
	private Boolean hasPermitFlg;

	/**
	 * 初始化组信息。
	 * 
	 * @return SUCCESS
	 */
	public String initTeamInfo() throws Exception {

		// 组信息一览与申请内容信息一览取得
		findTeamInfoAndApplyInfo();

		return SUCCESS;

	}
	
	/**
	 * 组信息一览与申请内容信息一览取得。
	 * 
	 */	
	private void findTeamInfoAndApplyInfo(){
		// 权限判断
		hasPermitFlg = hasPermit(CommonConstants.NameSpaceEnum.EMP.value(),"yb0070TeamPermit");
		
		// 取得组信息一览		
		teamInfoList = yb0070Service.getTeamInfoList(hasPermitFlg);
		
		// 组信息件数
		teamInfosCnt= teamInfoList.size();
		
		// 取得申请内容信息一览		
		applayMap = yb0070Service.getApplayInfoList();
		
		// 取得属性信息
		this.teamTypeList = comCodeInfoService.getComCodeInfo("EMP", "TEAM_TYPE");

	}
	
	/**
	 * 组信息。
	 * 
	 * @return SUCCESS
	 */
	public String findTeamInfo() throws Exception {
		
		// 权限判断
		hasPermitFlg = hasPermit(CommonConstants.NameSpaceEnum.EMP.value(),"yb0070TeamPermit");
		
		// 取得属性信息
		this.teamTypeList = comCodeInfoService.getComCodeInfo("EMP", "TEAM_TYPE");

		teamInfo = yb0070Service.getTeamInfo(teamId,hasPermitFlg);
		
		// 需要申请
		if(teamInfo.getJoinApplyFlg().equals(CommonConstants.JoinApplyFlgEnum.YES.value())){
			applayFlg = true;
		// 不需要申请
		}else{
			applayFlg = false;
		}
			
		return SUCCESS;
	}
	
	/**
	 * 组信息新建。
	 * 
	 * @return SUCCESS
	 */
	public String insertTeamInfo() throws Exception {
		
		// 新建组信息登录
		yb0070Service.insertTeamInfo(teamInfo);
		
		// 初始化组信息
		findTeamInfoAndApplyInfo();
		
		return SUCCESS;

	}
	
	/**
	 * 组信息更新。
	 * 
	 * @return SUCCESS
	 */
	public String updateTeamInfo() throws Exception {
		
		// 新建组信息更新
		yb0070Service.updateTeamInfo(teamInfo);
		
		// 初始化组信息
		findTeamInfoAndApplyInfo();
		
		return SUCCESS;

	}
	
	/**
	 * 组信息删除。
	 * 
	 * @return SUCCESS
	 */
	public String deleteTeamInfo() throws Exception {
				
		// 组信息删除
		yb0070Service.deleteTeamInfo(teamId);
		
		// 初始化组信息
		findTeamInfoAndApplyInfo();
		
		return SUCCESS;

	}
	
	/**
	 * 组成员退出。
	 * 
	 * @return SUCCESS
	 */
	public String updateQuitUser() throws Exception {
				
		// 组信息删除
		yb0070Service.deleteTeamUserInfo(teamId, joinApplyFlg);
		
		// 初始化组信息
		findTeamInfoAndApplyInfo();
				
		return SUCCESS;

	}

	/**
	 * 组成员加入。
	 * 
	 * @return SUCCESS
	 */
	public String updateJoinUser() throws Exception {
				
		// 组信息加入
		yb0070Service.insertTeamUserInfo(teamId, joinApplyFlg);
		
		// 初始化组信息
		findTeamInfoAndApplyInfo();
				
		return SUCCESS;

	}
	
	/**
	 * 同意成员状态更新。
	 * 
	 * @return SUCCESS
	 */
	public String updateAgreeTeamUserFlg() throws Exception {
				
		// 同意成员状态更新
		yb0070Service.updateAgreeTeamUserFlg(yb0071CondA);
		
		// 初始化组信息
		findTeamInfoAndApplyInfo();
		
		return SUCCESS;

	}

	/**
	 * 不同意成员状态更新。
	 * 
	 * @return SUCCESS
	 */
	public String updateDisAgreeTeamUserFlg() throws Exception {
				
		// 不同意成员状态更新
		yb0070Service.updateDisAgreeTeamUserFlg(yb0071CondA);
		
		// 初始化组信息
		findTeamInfoAndApplyInfo();
		
		return SUCCESS;

	}
	
	/**
	 * 插入时组长校验
	 */
	public void validateinsertTeamInfo() {
		String userNm = userService.getUserNm(teamInfo.getTeamLeaderId());
		if(null == userNm   || "".equals(userNm)){
			this.addFieldError("teamInfo.teamLeaderNm", propMgr.getMessage("yds.com.warning.0004","员工"));

		}
	}	

	/**
	 * 更新时组长校验
	 */
	public void validateupdateTeamInfo() {
		String userNm = userService.getUserNm(teamInfo.getTeamLeaderId());
		if(null == userNm   || "".equals(userNm)){
			this.addFieldError("teamInfo.teamLeaderNm", propMgr.getMessage("yds.com.warning.0004","员工"));

		}
	}
	
	/**
	 * 同意时申请内容校验
	 */
	public void validateupdateAgreeTeamUserFlg() {

		if(yb0071CondA.getApplayInfosList().size()==0 || null == yb0071CondA.getApplayInfosList()){
			this.addFieldError("yb0071CondA.applayInfosList", propMgr.getMessage("yds.com.warning.0001","申请内容"));

		}
	}	

	/**
	 * 不同意时申请内容校验
	 */
	public void validateupdateDisAgreeTeamUserFlg() {

		if(yb0071CondA.getApplayInfosList().size()==0 || null == yb0071CondA.getApplayInfosList()){
			this.addFieldError("yb0071CondA.applayInfosList", propMgr.getMessage("yds.com.warning.0001","申请内容"));

		}
	}	

	/**
	 * @param yb0070Service the yb0070Service to set
	 */
	public void setYb0070Service(Yb0070Service yb0070Service) {
		this.yb0070Service = yb0070Service;
	}


	/**
	 * @return the teamInfoList
	 */
	public List<Yb0070CondA> getTeamInfoList() {
		return teamInfoList;
	}


	/**
	 * @param teamInfoList the teamInfoList to set
	 */
	public void setTeamInfoList(List<Yb0070CondA> teamInfoList) {
		this.teamInfoList = teamInfoList;
	}


	/**
	 * @return the teamInfosCnt
	 */
	public int getTeamInfosCnt() {
		return teamInfosCnt;
	}


	/**
	 * @param teamInfosCnt the teamInfosCnt to set
	 */
	public void setTeamInfosCnt(int teamInfosCnt) {
		this.teamInfosCnt = teamInfosCnt;
	}

	/**
	 * @return the applayMap
	 */
	public Map<String, String> getApplayMap() {
		return applayMap;
	}

	/**
	 * @param applayMap the applayMap to set
	 */
	public void setApplayMap(Map<String, String> applayMap) {
		this.applayMap = applayMap;
	}

	/**
	 * @return the teamTypeList
	 */
	public List<ComCodeInfo> getTeamTypeList() {
		return teamTypeList;
	}

	/**
	 * @param teamTypeList the teamTypeList to set
	 */
	public void setTeamTypeList(List<ComCodeInfo> teamTypeList) {
		this.teamTypeList = teamTypeList;
	}

	/**
	 * @param comCodeInfoService the comCodeInfoService to set
	 */
	public void setComCodeInfoService(ComCodeInfoService comCodeInfoService) {
		this.comCodeInfoService = comCodeInfoService;
	}
	/**
	 * @return the teamId
	 */
	public String getTeamId() {
		return teamId;
	}
	/**
	 * @param teamId the teamId to set
	 */
	public void setTeamId(String teamId) {
		this.teamId = teamId;
	}
	/**
	 * @return the teamInfo
	 */
	public Yb0070CondA getTeamInfo() {
		return teamInfo;
	}
	/**
	 * @param teamInfo the teamInfo to set
	 */
	public void setTeamInfo(Yb0070CondA teamInfo) {
		this.teamInfo = teamInfo;
	}
	/**
	 * @return the permitFlg
	 */
	public Boolean getHasPermitFlg() {
		return hasPermitFlg;
	}

	/**
	 * @param permitFlg the permitFlg to set
	 */
	public void setHasPermitFlg(Boolean hasPermitFlg) {
		this.hasPermitFlg = hasPermitFlg;
	}

	/**
	 * @return the applayFlg
	 */
	public Boolean getApplayFlg() {
		return applayFlg;
	}
	/**
	 * @param trueflg the applayFlg to set
	 */
	public void setApplayFlg(Boolean applayFlg) {
		this.applayFlg = applayFlg;
	}
	
	/**
	 * @return the joinApplyFlg
	 */
	public String getJoinApplyFlg() {
		return joinApplyFlg;
	}
	/**
	 * @param joinApplyFlg the joinApplyFlg to set
	 */
	public void setJoinApplyFlg(String joinApplyFlg) {
		this.joinApplyFlg = joinApplyFlg;
	}
	/**
	 * @return the yb0071CondA
	 */
	public Yb0071CondA getYb0071CondA() {
		return yb0071CondA;
	}
	/**
	 * @param yb0071CondA the yb0071CondA to set
	 */
	public void setYb0071CondA(Yb0071CondA yb0071CondA) {
		this.yb0071CondA = yb0071CondA;
	}

	/**
	 * @param userService the userService to set
	 */
	public void setUserService(UserService userService) {
		this.userService = userService;
	}


}
