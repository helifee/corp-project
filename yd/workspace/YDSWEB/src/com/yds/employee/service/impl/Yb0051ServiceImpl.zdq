/*
 * @(#)Yb0060ServiceImpl.java
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 员工管理
 */

package com.yds.employee.service.impl;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

import org.springframework.stereotype.Service;

import com.yds.base.service.AbstractBaseService;
import com.yds.common.bean.EmpInfo;
import com.yds.common.bean.EmpOrgInfo;
import com.yds.common.service.ComSequenceService;
import com.yds.common.service.CommonConstants;
import com.yds.common.service.LogService;
import com.yds.common.service.SessionService;
import com.yds.employee.bean.Yb0051CondA;
import com.yds.employee.dao.Yb0051Dao;
import com.yds.employee.service.Yb0051Service;

/**
 * @see com.yds.employee.service.Yb0060Service
 */
@Service("yb0051Service")
public class Yb0051ServiceImpl extends AbstractBaseService implements
		Yb0051Service {
	private Yb0051Dao yb0051Dao;
	private ComSequenceService comSequenceService;
	
	// ======2010/08/06  滕长龙对应系统日志 start ===========
	// 日志信息
	String logMsg = "";
	// 日志 service
	private LogService logService;
	// ======2010/08/06  滕长龙对应系统日志 end ===========

	/**
	 * {@inheritDoc}
	 * 
	 * @throws Exception
	 */
	@Override
	public Yb0051CondA getOrgMnger(String diffNo) {

		Yb0051CondA yb0051CondA = new Yb0051CondA();
		yb0051CondA.setDiffNo(diffNo);
		yb0051CondA = yb0051Dao.getOrgMnger(diffNo);
		return yb0051CondA;
	}

	/**
	 * {@inheritDoc}
	 * 
	 * @throws Exception
	 */
	@Override
	public List<Yb0051CondA> getOrgMngerList(String subSys, String typeId) {

		Yb0051CondA yb0051CondA = new Yb0051CondA();
		yb0051CondA.setSubSys(subSys);
		yb0051CondA.setTypeId(typeId);
		return this.getOrgMngerList(yb0051CondA);
	}

	public EmpOrgInfo getOrgInfo(String orgId) {

		EmpOrgInfo empOrgInfo = new EmpOrgInfo();
		empOrgInfo.setOrgId(orgId);
		empOrgInfo = yb0051Dao.getOrgInfo(orgId);
		return empOrgInfo;
	}

	public EmpOrgInfo getOrgSName(String orgId) {
		EmpOrgInfo empOrgInfo = new EmpOrgInfo();
		empOrgInfo.setOrgId(orgId);
		empOrgInfo = yb0051Dao.getOrgInfo(orgId);
		return empOrgInfo;
	}

	public boolean updateOrgInfo(EmpOrgInfo bean) {

		yb0051Dao.updateOrgInfo(bean);
		// ======2010/08/24 滕长龙对应系统日志 start ===========
		// 日志信息的编辑
		logMsg = "ID为" + bean.getOrgId() + "的组织信息修改成功。";
		// 日志的追加  日志级别未定
		logService.insertLogInfo(CommonConstants.LoglevelEnum.Not_Delete.toString(),CommonConstants.SubIdEnum.Sub_EMP.toString(),SessionService.getLoginUserId(), logMsg, "");
		// ======2010/08/24 滕长龙对应系统日志 end ===========
		return true;
	}

	public boolean insertOrgInfo(EmpOrgInfo empOrgInfo, Yb0051CondA orgState,
			String orgId) throws Exception {

		String orgLev = yb0051Dao.getOrgLev(orgId);
		int length = orgLev.length();
		int length2 = length;
		for (int i = 0; i < length2 + 5; i = i + 5) {

			String orgLev1 = orgLev.substring(i, i + 5);
			int temp = Integer.parseInt(orgLev1);
			if (temp != 0) {
				length2 = i + 5;
			}

		}
		String orgLev1 = orgLev.substring(0, length2);
		List<String> orgLev2 = yb0051Dao.getOrgLevList(orgLev1);
		List<String> orgLev3 = new ArrayList<String>();
		int j = orgLev2.size();
		for (int i = 0; i < j; i++) {

			String wo = orgLev2.get(i).substring(0, length2 + 5);
			orgLev3.add(i, wo);

		}
		String max = orgLev3.get(0);
		for (int i = 1; i < orgLev3.size(); i++) {
			if ((orgLev3.get(i - 1).compareTo(orgLev3.get(i))) > 0) {

				max = orgLev3.get(i - 1);
			} else {
				max = orgLev3.get(i);
			}

		}
		String max2 = max.substring(length2, length2 + 5);
		int maxInt = Integer.parseInt(max2) + 1;
		String maxString = String.valueOf(maxInt);
		for (int i = 0; i < 4; i++) {
			maxString = "0" + maxString;
		}
		maxString = max.substring(0, length2) + maxString;
		StringBuffer buf = new StringBuffer();
		for (int i = 0; i < (length - length2 - 5); i++) {

			buf.append("0");
		}
		maxString = maxString + buf.toString();
		orgLev = maxString;
		empOrgInfo.setOrgLev(orgLev);

		Calendar cd = Calendar.getInstance();
		int year = cd.get(Calendar.YEAR);
		String year2 = String.valueOf(year);

		String oId = comSequenceService.getNextSequence("EMP_ORG_INFO","ORG_ID", 5);
		String orgId2 = year2 + "D" + oId;
		empOrgInfo.setOrgId(orgId2);
		empOrgInfo.setOrgStateFlg("0");
		empOrgInfo.setOrgProId(orgState.getDiffNo());

		empOrgInfo.setOrgViewFlg("1");

		yb0051Dao.insertOrgInfo(empOrgInfo);
		// ======2010/08/24 滕长龙对应系统日志 start ===========
		// 日志信息的编辑
		logMsg = "ID为" + empOrgInfo.getOrgId() + "的组织信息注册成功。";
		// 日志的追加  日志级别未定
		logService.insertLogInfo(CommonConstants.LoglevelEnum.Not_Delete.toString(),CommonConstants.SubIdEnum.Sub_EMP.toString(),SessionService.getLoginUserId(), logMsg, "");
		// ======2010/08/24 滕长龙对应系统日志 end ===========
		return true;
	}

	public EmpInfo getEmpCnm(String empId) {
		EmpInfo empInfo = new EmpInfo();
		empInfo.setEmpId(empId);
		empInfo = yb0051Dao.getEmpCnm(empId);
		return empInfo;
	}

	public String getDispSeq(String diffNo) {

		Yb0051CondA yb0051CondA = new Yb0051CondA();
		yb0051CondA.setDiffNo(diffNo);
		return yb0051Dao.getDispSeq(diffNo);
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<Yb0051CondA> getOrgMngerList(Yb0051CondA yb0051CondA) {

		return yb0051Dao.getOrgMngerList(yb0051CondA);
	}

	public void setYb0051Dao(Yb0051Dao yb0051Dao) {
		this.yb0051Dao = yb0051Dao;
	}

	public void setComSequenceService(ComSequenceService comSequenceService) {
		this.comSequenceService = comSequenceService;
	}
	/**
	 * {@inheritDoc}
	 */
	public boolean empNameCheck(List<EmpInfo> empInfoList,String orgMngerNm) {
		int j=0;
		if(!"".equals(orgMngerNm)){
			for (int i=0;i<empInfoList.size();i++) {
				if (!"".equals(empInfoList.get(i).getEmpCnm())) {
			
				// 不能和输入的员工ID不一致
			      if (empInfoList.get(i).getEndDate()==null && orgMngerNm.equals(empInfoList.get(i).getEmpCnm())) {
			    		  
			    	        j=1;
							break;
				  }
			      else {
			    	  if (empInfoList.get(i).getEndDate()!=null && orgMngerNm.equals(empInfoList.get(i).getEmpCnm())) {
			    		  
			    	        j=0;
							break;
				  }
			    	  j=0;
			      }
			}
		}
	  }
		else{
			j=1;
		}
		if(j==1)
		{
		  return true;
		}
		else{
			return false;
		}
	}
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<EmpInfo> getEmpInfoList() {
		
		List<EmpInfo> empInfoList = yb0051Dao.getEmpInfoList();
		return empInfoList;
	}



	public String getLogMsg() {
		return logMsg;
	}

	public void setLogMsg(String logMsg) {
		this.logMsg = logMsg;
	}

	public void setLogService(LogService logService) {
		this.logService = logService;
	}


}
