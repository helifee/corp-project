<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="TreeTableNewDao">
	<typeAlias alias="treeTableNewAuthor" type="com.yds.sample.bean.TreeTableNewAuthorBean"/>
	<typeAlias alias="treeTableNewBook" type="com.yds.sample.bean.TreeTableNewBookBean"/>
	<typeAlias alias="treeTableNewStore" type="com.yds.sample.bean.TreeTableNewStoreBean"/>
	
	<!-- 获取Author列表 --> 
	<select id="getAuthorList" resultClass="treeTableNewAuthor">
	<![CDATA[
		SELECT
			  A.PRO2_VAR AS 'authorId',
			  A.PRO1_VAR AS 'authorName',
			  CONCAT('共 ', CONVERT(COUNT(B.OB_ID), CHAR),' 本') AS 'authorBooks'
		FROM  MAN_MAJOR_INFO A,
			  MAN_MAJOR_INFO B
		WHERE A.MOD_TYPE = 'treetable'
		  AND A.OB_NAME  = 'author'
		  AND B.MOD_TYPE = 'treetable'
		  AND B.OB_NAME  = 'book'
		  AND B.PRO2_VAR = A.PRO2_VAR
		GROUP BY A.PRO2_VAR
	]]>
	</select>

	<!-- 获取Book列表 --> 
	<select id="getBookList" resultClass="treeTableNewBook" parameterClass="String">
	<![CDATA[
		SELECT
		  A.PRO3_VAR AS 'bookIsbn',
		  A.PRO1_VAR AS 'bookName',
		  A.PRO4_VAR AS 'bookPublisher',
		  CONCAT('￥', CONVERT(CAST(A.PRO1_FLOAT AS DEC(6,2)), CHAR)) AS 'bookPrice',
		  CONCAT('共 ', CONVERT(COUNT(B.OB_ID), CHAR),' 个店铺') AS 'bookStores'
		FROM  MAN_MAJOR_INFO A,
			  MAN_MAJOR_INFO B
		WHERE A.MOD_TYPE = 'treetable'
		  AND A.OB_NAME  = 'book'
		  AND A.PRO2_VAR = #authorId#
		  AND B.MOD_TYPE = 'treetable'
		  AND B.OB_NAME  = 'store'
		  AND B.PRO2_VAR = A.PRO3_VAR
		GROUP BY A.PRO3_VAR
	]]>
	</select>
	
	<!-- 获取Store列表 --> 
	<select id="getStoreList" resultClass="treeTableNewStore" parameterClass="String">
	<![CDATA[
		SELECT
			  A.PRO3_VAR AS 'storeId',
			  A.PRO1_VAR AS 'storeName',
			  CONCAT('剩余 ', CONVERT(A.PRO1_INT, CHAR),' 本') AS 'storeCount'
		FROM  MAN_MAJOR_INFO A
		WHERE A.MOD_TYPE = 'treetable'
		  AND A.OB_NAME  = 'store'
		  AND A.PRO2_VAR = #bookIsbn#
	]]>
	</select>
</sqlMap>  
