/*
 * @(#)EmpGrpHis.java
 * Copyright (c) 2010-2011 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 图书管理
 */

package com.yds.library.service.impl;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.springframework.stereotype.Service;

import com.yds.common.bean.UserInfo;
import com.yds.common.service.LoginService;
import com.yds.library.bean.Bookinfo;
import com.yds.library.bean.Booklendinguserbklimit;
import com.yds.library.bean.Finishheadinfo;
import com.yds.library.bean.Finishinfo;
import com.yds.library.bean.LoaninfoDel;
import com.yds.library.dao.BookreturnDao;
import com.yds.library.service.BookreturnService;
import com.yds.library.util.SessionConstants;
import com.yds.library.util.Sessionadit;
import com.yds.util.service.PropertyManager;
import com.yds.util.service.Session;

/**
 * @see LoginService
 */
@Service("bookreturnService")
public class BookreturnServiceImpl implements BookreturnService {
	
	private BookreturnDao bookreturnDao;
	protected PropertyManager propMgr;
	
	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<Bookinfo> getbookreturnInfo() {
		
		List<Bookinfo> bookreturninfo = new ArrayList<Bookinfo>();

		// 取得用户ID
		UserInfo userInfo = (UserInfo)Session.get(SessionConstants.USERINFO);
		String userId = userInfo.getUserId();
		
		// 取得该用户ID下的借书信息
		bookreturninfo = bookreturnDao.getBookretunInfo(userId);
		for (int i = 0; i < bookreturninfo.size(); i++) {
			if (bookreturninfo.get(i).getBookvolume() != 1) {
				bookreturninfo.get(i).setBookname(bookreturninfo.get(i).getBookname() + "[" +
						bookreturninfo.get(i).getVolumenum() + "/" + 
						bookreturninfo.get(i).getBookvolume() + "]"); 
			}
			
		}	
		
		return bookreturninfo;
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean deleteLoanInfo(List<String> loanlist) {
		
		LoaninfoDel loaninfo = new LoaninfoDel();
		int result = 1;
		
		// 取得用户ID
		UserInfo userInfo = (UserInfo)Session.get(SessionConstants.USERINFO);
		String userId = userInfo.getUserId();
		
		// 取得系统时间
		SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
		Date currentTime = new Date();
		String timeStr = formatter.format(currentTime);

		// 将信息存入loaninfo中
		loaninfo.setUserId(userId);
		loaninfo.setTimeStr(timeStr);
		
		for (int i = 0; i < loanlist.size(); i++) {
			loaninfo.setLoanId(loanlist.get(i));
			
			// 逻辑删除该条借阅信息
			result = this.bookreturnDao.updateLoanInfo(loaninfo);
		}

		// 逻辑删除失败
		if (result <= 0) {
			return false;
		} 
		return true;
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List<Finishinfo> getFilishInfo(List<String> loanlist) {
		
		List<Finishinfo> finishinfoList;
		finishinfoList = new ArrayList<Finishinfo>();
		Finishinfo finishinfo = new Finishinfo();
		
		// 取得刚归还的书籍信息并存放在list中
		for (String loanid: loanlist) {
			finishinfo = this.bookreturnDao.getfilishInfo(loanid);
			
			if (!finishinfo.getBookvolume().equals("1")) {
				finishinfo.setBookname(finishinfo.getBookname() + "[" +
						 finishinfo.getVolumenum() + "/" + 
						 finishinfo.getBookvolume() + "]"); 
			}
			
			finishinfoList.add(finishinfo);
		}
		
		return finishinfoList;
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public Finishheadinfo getbooklimit(Integer returnNum) {

		// 将信息存入session
		Sessionadit.sessionplus(0,returnNum);
		
		// 取得该用户下的借书上限，已借和可借书籍
		Booklendinguserbklimit booklimit = (Booklendinguserbklimit) Session.
												get(SessionConstants.USERLIMIT);
		
		Finishheadinfo finishheadinfo = new Finishheadinfo();
		
		// 借书上限
		Integer loanLimit = booklimit.getBooknumlimit();
		
		// 已借书籍
		Integer loanNow = booklimit.getBooklendednum();
		
		// 可借书籍
		Integer loanStile = booklimit.getBookreadnum();
		
		// 成功提示信息
		String successInfo = propMgr.getMessage("yds.ydb.info.0002",returnNum)
			+ propMgr.getMessage("yds.ydb.info.0006",loanLimit,loanNow,loanStile);
		
		// 将信息存入bean
		finishheadinfo.setBooklendednum(loanNow);
		finishheadinfo.setBooknumlimit(loanLimit);
		finishheadinfo.setBookreadnum(loanStile);
		finishheadinfo.setNeirong(successInfo);
		
		return finishheadinfo;
	}
	public PropertyManager getPropMgr() {
		return propMgr;
	}

	public void setPropMgr(PropertyManager propMgr) {
		this.propMgr = propMgr;
	}

	public void setBookreturnDao(BookreturnDao bookreturnDao) {
		this.bookreturnDao = bookreturnDao;
	}

}