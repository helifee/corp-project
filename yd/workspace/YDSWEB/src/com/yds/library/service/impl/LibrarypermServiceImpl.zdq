/*
 * @(#)LibrarypermServiceImpl.java
 * Copyright (c) 2010-2011 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: 远东公司内部网
 *    SubSystem: 图书管理
 */

package com.yds.library.service.impl;

import java.util.HashMap;
import java.util.List;

import org.springframework.stereotype.Service;

import com.yds.base.service.AbstractBaseService;
import com.yds.library.util.SessionConstants;
import com.yds.library.bean.LibraryPerm;
import com.yds.library.dao.LibrarypermDao;
import com.yds.library.service.LibrarypermService;
import com.yds.library.util.CommonConstants;
import com.yds.util.service.Session;


/**
 * @see UserPermitService
 */
@Service("librarypermService")
public class LibrarypermServiceImpl extends AbstractBaseService implements LibrarypermService {

	private LibrarypermDao libraryPermDao;

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void getLibraryPerm(String userId) {
		
		String permFlg = "0";
		String libnameSpace = "library";
		String libactionName = "booklendingInfo";
		
		// 用户权限取得
		List<LibraryPerm> libraryPermList = libraryPermDao.getLibraryPerm(userId);
		
		HashMap<String, HashMap<String, Boolean>> userPermMap = new HashMap<String, HashMap<String, Boolean>>();

		if (null != libraryPermList) {
			
			// 将取得的每一条用户权限存入HashMap
			for (LibraryPerm libraryPerm : libraryPermList) {
				HashMap<String, Boolean> actionMap;
				
				if (userPermMap.containsKey(libraryPerm.getNameSpace())) {
					actionMap = userPermMap.get(libraryPerm.getNameSpace());
				} else {
					actionMap = new HashMap<String, Boolean>();
				}
				
				// 取得权限对应的actionName
				String actionName = libraryPerm.getActionName();;
				if (actionName.endsWith("." + CommonConstants.ACTIONNAME)) {
					actionMap.put(actionName.substring(0, actionName.indexOf("." + CommonConstants.ACTIONNAME)), true);
				} else {
					actionMap.put(actionName, true);
				}
				
				// 将数据存入HashMap
				userPermMap.put(libraryPerm.getNameSpace(), actionMap);
			}
		}
		
		// HashMap为空时
		if (null == userPermMap) {
			permFlg = "0";
		
		// 权限不存在时
		} else if (!userPermMap.containsKey(libnameSpace)) {
			permFlg = "0";
		
		// 用户权限判断
		} else if (userPermMap.get(libnameSpace).containsKey("*") ||(userPermMap.get(libnameSpace).containsKey(libactionName) && userPermMap.get(libnameSpace).get(libactionName))) {
			permFlg = "1";
		}
		
		// 将用户权限写入session
		Session.set(SessionConstants.LIBRARYPERM, permFlg);
	}

	/**
	 * @param libraryPermDao
	 *            the libraryPermDao to set
	 */
	public void setLibrarypermDao(LibrarypermDao libraryPermDao) {
		this.libraryPermDao = libraryPermDao;
	}
}
