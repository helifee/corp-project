<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BookreturnDao">
	<typeAlias alias="bookinfo2" type="com.yds.library.bean.Bookinfo"/>
	<typeAlias alias="loaninfoDel" type="com.yds.library.bean.LoaninfoDel"/>
	<typeAlias alias="finishinfo" type="com.yds.library.bean.Finishinfo"/>
	<typeAlias alias="finishheadinfo" type="com.yds.library.bean.Finishheadinfo"/>

	<!-- 所借书籍取得 --> 
	<select id="getBookretunInfo" parameterClass="String" resultClass="bookinfo2">  
		SELECT
		  b.LOAN_ID AS loanid,
		  a.ISBN AS isbn,
		  a.BOOK_NAME bookname,
		  a.AUTHOR AS bookauthor,
		  a.PUB AS bookpublisher,
		  a.BOOK_VOLUME AS bookvolume,
		  a.VOLUME_NUM AS volumenum
		FROM YDB_BOOK_INFO a,YDB_LOAN_INFO b
		WHERE b.USER_ID = #userId#
		  AND b.BOOK_ID = a.BOOK_ID
		  AND b.DEL_FLG = "0"
		  AND a.DEL_FLG = "0";
	</select>
	
	<!-- 逻辑删除借阅信息-->
	<update id="deleteLoanInfo" parameterClass="loaninfoDel">
		UPDATE YDB_LOAN_INFO
		   SET UPDATE_USERID=#userId#,
               UPDATE_TIME=#timeStr#,
               DEL_FLG="1"
         WHERE LOAN_ID= #loanId#;		
	</update>
	
	<!-- 所还书籍取得 --> 
	<select id="getFilishInfo" parameterClass="String" resultClass="finishinfo">  
		SELECT
		  b.BOOK_ID AS bookid,
		  a.ISBN AS isbn,
		  a.BOOK_NAME AS bookname,
		  a.BOOK_VOLUME AS bookvolume,
		  a.VOLUME_NUM AS volumenum
		FROM YDB_BOOK_INFO a,YDB_LOAN_INFO b
		WHERE b.LOAN_ID = #loanid#
		  AND b.BOOK_ID = a.BOOK_ID
		  AND b.DEL_FLG = "1";
	</select>
	
	<!-- 借书上限和已借本数取得 --> 
	<select id="getbooklimit" parameterClass="String" resultClass="finishheadinfo">  
		SELECT
		  CONTRIBUTE_BOOK AS booknumlimit,
		  BORROW_BOOK AS booklendednum,
		  CONTRIBUTE_BOOK - BORROW_BOOK AS bookreadnum
		FROM V_YDB_USER_BOOK
		WHERE USER_ID = #userId#
	</select>
</sqlMap>  

