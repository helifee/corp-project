<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BooklendinginfoDao">
<!--检索可借书籍bean-->
    <typeAlias alias="bookresult" type="com.yds.library.bean.Bookinfo"/>
<!--检索书籍secthbean-->
    <typeAlias alias="bookSercth" type="com.yds.library.bean.Bookinfo"/>    
<!--更新书籍bean-->
    <typeAlias alias="bookupdate" type="com.yds.library.bean.Bookinfo"/>  
	<!-- 可借书籍信息查询 --> 
	<select id="getbooklendinginfo" parameterClass="bookSercth" resultClass="bookresult"> 		  
		SELECT a.BOOK_ID bookid,
		b.ISBN isbn,
		a.USER_ID purseid,
		v.USER_CNM pursename,
		b.BOOK_NAME bookname,
		b.BOOK_VOLUME bookvolume,
		b.VOLUME_NUM volumenum,
		datediff(NOW(),a.LOAN_DATE) booklendingdays
		From ydb_loan_info a 
		inner join ydb_book_info b
		on a.BOOK_ID = b.BOOK_ID
		<isNotEmpty prepend="AND" property="isbn">  
                  a.ISBN  like   CONCAT(#isbn#,'%')
        </isNotEmpty>	
        <isNotEmpty prepend="AND" property="bookname">  
                  b.BOOK_NAME  like  CONCAT('%' ,#bookname#,'%')
                  
        </isNotEmpty>	 
        <isNotEmpty prepend="AND" property="purseid">  
                  a.USER_ID = #purseid#   
        </isNotEmpty>	  
        <isNotEmpty prepend="AND" property="bookoverdays">  
          case #bookoverdays#
		      when '0' then 1=1

		      when '1' then datediff(NOW(),a.LOAN_DATE)>#maxoverdays#
		      end  
        </isNotEmpty>	      
		and  a.DEL_FLG='0' AND b.DEL_FLG ='0'
		INNER JOIN v_tt_user v
		ON v.USER_ID=a.USER_ID
		order by booklendingdays, b.ISBN,a.BOOK_ID
	</select> 

	<!-- 更新借阅信息 --> 
    <update id="updatebooklendinginfo" parameterClass="bookupdate">
        UPDATE ydb_loan_info a SET
	        a.DEL_FLG = '1',
	        a.UPDATE_USERID = #purseid#,
	        a.UPDATE_TIME = NOW()
        WHERE 
	        a.BOOK_ID=#bookid#
    </update>
</sqlMap>  
