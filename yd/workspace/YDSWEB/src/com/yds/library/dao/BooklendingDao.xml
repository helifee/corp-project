<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTDSQLMap2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BooklendingDao">
<!--检索可借书籍bean-->
    <typeAlias alias="bookSercth" type="com.yds.library.bean.Bookinfo"/>
<!--重复isbn号bean-->
    <typeAlias alias="bookmanySercth" type="com.yds.library.bean.BooklendingSercthmanybook"/>
<!--返回检索可借书籍beanlist-->
    <typeAlias alias="bookinfoready" type="com.yds.library.bean.Bookinfo"/>
<!--用户bean-->
<!--返回用户可借书上限bean-->
	<typeAlias alias="serbklimit" type="com.yds.library.bean.Booklendinguserbklimit"/>
<!--用户信息登录用bean-->
	<typeAlias alias="bookuserinsert" type="com.yds.library.bean.Bookinfo"/>	
	
	<!--成功页面用户可借书上限bean-->
<typeAlias alias="serbklimitsuccess" type="com.yds.library.bean.Finishheadinfo"/>
  	
	<!-- 可借书籍信息查询 --> 
	<select id="getbookInfo" parameterClass="bookSercth" resultClass="bookinfoready"> 		  
		SELECT MIN(a.BOOK_ID) bookid,
		a.ISBN isbn,
		a.BOOK_NAME bookname,
		a.AUTHOR bookauthor,
		a.PUB bookpublisher,		
		MIN(a.BOOK_VOLUME) bookvolume,
		SUM(0),
		a.VOLUME_NUM volumenum FROM ydb_book_info a
		WHERE a.ISBN=#isbn# and 
		a.DEL_FLG='0' AND 
		a.BOOK_ID NOT IN(SELECT b.BOOK_ID FROM ydb_Loan_info b where b.DEL_FLG='0')AND 
		a.VOLUME_NUM NOT IN(SELECT c.VOLUME_NUM FROM ydb_book_info c INNER JOIN ydb_Loan_info d  ON c.BOOK_ID=d.BOOK_ID AND c.DEL_FLG='0' AND d.DEL_FLG='0' WHERE c.ISBN=#isbn# AND d.USER_ID=#purseid#)
		GROUP BY a.VOLUME_NUM,a.ISBN,a.BOOK_VOLUME
		ORDER BY a.isbn,a.BOOK_ID,a.BOOK_VOLUME
	</select>  
	<!-- 如果借过是否有库存--> 
	<select id="getbookInfokc" parameterClass="bookSercth" resultClass="bookinfoready"> 		  
		SELECT a.BOOK_ID bookid,
		a.ISBN isbn,
		a.BOOK_NAME bookname,
		a.AUTHOR bookauthor,
		a.PUB bookpublisher,		
		a.BOOK_VOLUME bookvolume,
		a.VOLUME_NUM volumenum FROM ydb_book_info a
		WHERE a.ISBN=#isbn# AND 
		a.DEL_FLG='0' AND 
		a.BOOK_ID NOT IN(SELECT b.BOOK_ID FROM ydb_Loan_info b WHERE b.DEL_FLG='0')AND 
		a.VOLUME_NUM  IN(SELECT c.VOLUME_NUM FROM ydb_book_info c INNER JOIN ydb_Loan_info d  ON c.BOOK_ID=d.BOOK_ID AND c.DEL_FLG='0' AND d.DEL_FLG='0' WHERE c.ISBN=#isbn# AND d.USER_ID=#purseid#)
		ORDER BY a.isbn,a.BOOK_ID,a.BOOK_VOLUME
	</select> 	
		<!-- 多本重复选择书籍信息查询 --> 
	<select id="getmanybookInfo" parameterClass="bookmanySercth" resultClass="bookinfoready"> 		  
		SELECT MIN(a.BOOK_ID) bookid,
		a.ISBN isbn,
		a.BOOK_NAME bookname,
		a.AUTHOR bookauthor,
		a.PUB bookpublisher,		
		MIN(a.BOOK_VOLUME) bookvolume,
		SUM(0),
		a.VOLUME_NUM volumenum FROM ydb_book_info a
		WHERE 
		a.DEL_FLG='0' AND 
		a.BOOK_ID NOT IN(SELECT b.BOOK_ID FROM ydb_Loan_info b where b.DEL_FLG='0')AND 
		a.VOLUME_NUM NOT IN(SELECT c.VOLUME_NUM FROM ydb_book_info c INNER JOIN ydb_Loan_info d  ON c.BOOK_ID=d.BOOK_ID AND c.DEL_FLG='0' AND d.DEL_FLG='0' AND d.USER_ID in
		<iterate property="bookuseridlist" open="(" close=")" conjunction=","> 
       
		 #bookuseridlist[]#  
		</iterate>
		)
		and a.BOOK_ID not in
       <iterate property="bookidlist" open="(" close=")" conjunction=","> 
       
		 #bookidlist[]#  
		</iterate>
		and a.ISBN  in
       <iterate property="bookisbnlist" open="(" close=")" conjunction=",">
		 #bookisbnlist[]#  
		</iterate>
		and a.VOLUME_NUM not in
       <iterate property="bookvolumenumlist" open="(" close=")" conjunction=","> 
       
		 #bookvolumenumlist[]#  
		</iterate>

		GROUP BY a.VOLUME_NUM,a.ISBN,a.BOOK_VOLUME
		ORDER BY a.isbn,a.BOOK_ID,a.BOOK_VOLUME
	</select> 
	<!-- 用户借书上限检索 --> 
	<select id="getbooklimit" parameterClass="String" resultClass="serbklimit"> 		  
		SELECT   
         v.contribute_book booknumlimit,
         v.borrow_book booklendednum,
         v.contribute_book - v.borrow_book bookreadnum
  		FROM   v_ydb_user_book v
  		where v.user_id=#userid#
	</select>  
	<!-- 用户借书信息登录检索 --> 
	<insert id="insertbooklendInfo" parameterClass="bookuserinsert"> 
		insert into ydb_loan_info
		 (
			BOOK_ID,  ISBN,USER_ID,LOAN_DATE,CREATE_USERID,CREATE_TIME,UPDATE_USERID,UPDATE_TIME,DEL_FLG
		 ) values (
		 	#bookid#,  #isbn#, #purseid#, now(), #purseid#, now(), #purseid#, now(),'0'
		 )
	</insert>
	<!-- 成功页面用户可借书上限 --> 
	<select id="getbooklimitsuccess" parameterClass="String" resultClass="serbklimitsuccess"> 		  
		SELECT   
         v.contribute_book booknumlimit,
         v.borrow_book booklendednum,
         v.contribute_book - v.borrow_book bookreadnum
  		FROM   v_ydb_user_book v
  		where v.user_id=#userid#
	</select>
	
	
	
			  
</sqlMap>  
