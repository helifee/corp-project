package com.yds.library.action;

import java.util.ArrayList;
import java.util.List;

import net.sf.json.JSONObject;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.yds.base.action.AbstractBaseAction;
import com.yds.common.bean.UserInfo;
import com.yds.library.bean.Bookinfo;
import com.yds.library.common.bean.Commonbooksort;
import com.yds.library.common.service.CommonbooksortService;
import com.yds.library.service.BookmanageService;
import com.yds.library.service.LogonService;
import com.yds.library.util.SessionConstants;
import com.yds.library.util.Utils;
import com.yds.util.service.Session;
import com.yds.util.service.StringUtil;



/**
 * 书籍管理
 * @author zhangchi
 * @version 1.0 2010/11/29
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("bookmanageAction")
public class BookmanageAction  extends AbstractBaseAction{
	
	private static final long serialVersionUID = -1397051695703253298L;
	private BookmanageService bookmanageService;
	private CommonbooksortService commonbooksortService;
	private LogonService logonService;
	
	private List<Bookinfo> bookmanageList; // 图书详细信息
	private Bookinfo bookinfoChg; // isbn检索图书信息
	private String jsonBookInfo; // JSON定义
	private List<Commonbooksort> booksortlist; //图书分类
	private String userpermit; // 用户权限
	private String userhid; // 隐藏用户id
	private String deletenum; // 删除本用户的图书册数
	private String isbn; // isbn号
	private String bookname; // 图书名称
	private String booksort; // 图书分类
	private String bookstate; // 图书状态
	private String idInput; // 联动id
	private String userid; // 用户id
	private String nameInput; // 联动姓名
	private String pursenameChg; // 用户名检索用
	private String purseidParam; // 用户名检索参数
	private String isbnParam; // isbn检索参数
	private int totalCount;  // 检索结果总件数
	private int pageNumber;  // 检索结果当前页
	private int pageCount;  // 检索结果总页数
	private List<Bookinfo> updlist; // 更新数据
	private String updFlg; // 更新判断用
	private String loanNum; // 已借出的图书数量
	private String allbooksNum; // 全部图书数量
	private String passwordParam; // 用户密码
	private String passwordTF; // 用户密码验证用
	
	/**
	 * 图书信息取得
	 * @return
	 * @throws Exception
	 */
	public String mamageInfoIndex() throws Exception {

		userpermit = (String)Session.get(SessionConstants.LIBRARYPERM);
		UserInfo userInfo = (UserInfo) Session.get(SessionConstants.USERINFO);
		
		// 普通用户时给用户ID、用户名赋值
		if (userpermit.equals("0")) {
			idInput = userInfo.getUserId().substring(2, 8);
			nameInput = userInfo.getUserName();
		}
		
		userhid = userInfo.getUserId();
		
		// 取得图书类型LIST
		booksortlist = new ArrayList<Commonbooksort>();
		booksortlist = this.commonbooksortService.getbookclassInfo("");
		Commonbooksort commonbooksort = new Commonbooksort();
		
		// 设置带空行的LIST
		commonbooksort.setClassid("00");
		commonbooksort.setClassname("");
		booksortlist.add(0,commonbooksort);
		
		return SUCCESS;
	}
	
	/**
	 * 图书信息检索
	 * @return
	 * @throws Exception
	 */
	public String getMamageInfo() throws Exception {

		String purseIdYd = StringUtil.leftPadYd(userid);
		Bookinfo bookmanageInfo = new Bookinfo();
		bookmanageInfo.setIsbn(isbn);
		bookmanageInfo.setBookname(bookname);
		bookmanageInfo.setBooksort(booksort);
		bookmanageInfo.setLoanFlg(bookstate);
		bookmanageInfo.setPurseid(purseIdYd);
		
		// 取得图书详细信息LIST
		bookmanageList = bookmanageService.getbookmanageInfo(bookmanageInfo);
		loanNum = bookmanageService.getloanNum(bookmanageList);
		allbooksNum = bookmanageService.getallbooksNum();
		totalCount = bookmanageList.size();
		if (totalCount == 0) {
			pageNumber = 0;
			pageCount = 0;
		} else {
			pageNumber = 1;
			pageCount = (int)(totalCount-1)/12 + 1;
		}
		
		// 取得图书类型LIST
		booksortlist = new ArrayList<Commonbooksort>();
		booksortlist = this.commonbooksortService.getbookclassInfo("");
		Commonbooksort commonbooksort = new Commonbooksort();
		
		// 设置带空行的LIST
		commonbooksort.setClassid("00");
		commonbooksort.setClassname("");
		booksortlist.add(0,commonbooksort);
		return SUCCESS;
	}

	/**
	 * 用户名称检索
	 * @return
	 * @throws Exception
	 */
	public String changeName() throws Exception {
		
		// 将用户ID前加上YD
		String purseIdYd = StringUtil.leftPadYd(purseidParam);
		
		// 取得用户名
		pursenameChg=this.bookmanageService.getpursename(purseIdYd);
		if (pursenameChg == null) {
			pursenameChg = "nameW";
		}
		return SUCCESS;
	}
	
	/**
	 * 通过isbn检索图书信息
	 * @return JASON
	 * @throws Exception
	 */
	public String isbnSelect() throws Exception {

		bookinfoChg = Utils.getBookInfoByIsbn(isbnParam);
		if (bookinfoChg == null) {
			this.setJsonBookInfo("infoNull");
		} else {
			if (bookinfoChg.getBookpublishdate() != null) {
				if (bookinfoChg.getBookpublishdate().length()==7) {
					bookinfoChg.setBookpublishdate(bookinfoChg.getBookpublishdate()+"-01");
				}
			}
			JSONObject jsoBookInfo = JSONObject.fromObject(bookinfoChg);
			this.setJsonBookInfo(jsoBookInfo.toString());
		}
		return SUCCESS;
	}
	
	/**
	 * 用户密码验证
	 * 
	 * @return passwordTF=0密码错误，passwordTF=1密码正确 借书画面
	 */
	public String passwordValidate() throws Exception {
		
		// 取得用户session
		UserInfo userinfo = (UserInfo) Session.get(SessionConstants.USERINFO);
		String userId = userinfo.getUserId();
		
		// passwordTF=0密码错误，passwordTF=1密码正确
		if (this.logonService.loginCheck(userId, passwordParam, false) == null) {
			passwordTF="0";
		} else {
			passwordTF="1";
		}
		return SUCCESS;
	}
	
	/**
	 * 提交更新数据
	 * @return 
	 * @throws Exception
	 */
	public String bookinfoUpdate() throws Exception {
		String srarchTF = ERROR;
		boolean updTF = this.bookmanageService.updatebookInfo(updlist,deletenum);
		if (updTF) {	
			srarchTF = getMamageInfo();
			allbooksNum = bookmanageService.getallbooksNum();
		} 

		return srarchTF;
	}
	
	public String getUserpermit() {
		return userpermit;
	}

	public void setUserpermit(String userpermit) {
		this.userpermit = userpermit;
	}

	public BookmanageService getBookmanageService() {
		return bookmanageService;
	}

	public void setBookmanageService(BookmanageService bookmanageService) {
		this.bookmanageService = bookmanageService;
	}

	public List<Bookinfo> getBookmanageList() {
		return bookmanageList;
	}

	public void setBookmanageList(List<Bookinfo> bookmanageList) {
		this.bookmanageList = bookmanageList;
	}

	public CommonbooksortService getCommonbooksortService() {
		return commonbooksortService;
	}

	public void setCommonbooksortService(CommonbooksortService commonbooksortService) {
		this.commonbooksortService = commonbooksortService;
	}

	public List<Commonbooksort> getBooksortlist() {
		return booksortlist;
	}

	public void setBooksortlist(List<Commonbooksort> booksortlist) {
		this.booksortlist = booksortlist;
	}

	public String getIsbn() {
		return isbn;
	}

	public void setIsbn(String isbn) {
		this.isbn = isbn;
	}

	public String getBookname() {
		return bookname;
	}

	public void setBookname(String bookname) {
		this.bookname = bookname;
	}

	public String getBookstate() {
		return bookstate;
	}

	public void setBookstate(String bookstate) {
		this.bookstate = bookstate;
	}

	public String getBooksort() {
		return booksort;
	}

	public void setBooksort(String booksort) {
		this.booksort = booksort;
	}

	public String getIdInput() {
		return idInput;
	}

	public void setIdInput(String idInput) {
		this.idInput = idInput;
	}

	public String getNameInput() {
		return nameInput;
	}

	public void setNameInput(String nameInput) {
		this.nameInput = nameInput;
	}

	public String getPursenameChg() {
		return pursenameChg;
	}

	public void setPursenameChg(String pursenameChg) {
		this.pursenameChg = pursenameChg;
	}

	public String getPurseidParam() {
		return purseidParam;
	}

	public void setPurseidParam(String purseidParam) {
		this.purseidParam = purseidParam;
	}

	public Bookinfo getBookinfoChg() {
		return bookinfoChg;
	}

	public void setBookinfoChg(Bookinfo bookinfoChg) {
		this.bookinfoChg = bookinfoChg;
	}

	public String getJsonBookInfo() {
		return jsonBookInfo;
	}

	public void setJsonBookInfo(String jsonBookInfo) {
		this.jsonBookInfo = jsonBookInfo;
	}

	public String getIsbnParam() {
		return isbnParam;
	}

	public void setIsbnParam(String isbnParam) {
		this.isbnParam = isbnParam;
	}

	public int getTotalCount() {
		return totalCount;
	}

	public void setTotalCount(int totalCount) {
		this.totalCount = totalCount;
	}

	public int getPageNumber() {
		return pageNumber;
	}

	public void setPageNumber(int pageNumber) {
		this.pageNumber = pageNumber;
	}

	public int getPageCount() {
		return pageCount;
	}

	public void setPageCount(int pageCount) {
		this.pageCount = pageCount;
	}

	public List<Bookinfo> getUpdlist() {
		return updlist;
	}

	public void setUpdlist(List<Bookinfo> updlist) {
		this.updlist = updlist;
	}

	public String getUpdFlg() {
		return updFlg;
	}

	public void setUpdFlg(String updFlg) {
		this.updFlg = updFlg;
	}

	public String getUserid() {
		return userid;
	}

	public void setUserid(String userid) {
		this.userid = userid;
	}

	public String getLoanNum() {
		return loanNum;
	}

	public void setLoanNum(String loanNum) {
		this.loanNum = loanNum;
	}

	public String getAllbooksNum() {
		return allbooksNum;
	}

	public void setAllbooksNum(String allbooksNum) {
		this.allbooksNum = allbooksNum;
	}

	public String getPasswordParam() {
		return passwordParam;
	}

	public void setPasswordParam(String passwordParam) {
		this.passwordParam = passwordParam;
	}

	public String getPasswordTF() {
		return passwordTF;
	}

	public void setPasswordTF(String passwordTF) {
		this.passwordTF = passwordTF;
	}

	public LogonService getLogonService() {
		return logonService;
	}

	public void setLogonService(LogonService logonService) {
		this.logonService = logonService;
	}

	public String getUserhid() {
		return userhid;
	}

	public void setUserhid(String userhid) {
		this.userhid = userhid;
	}

	public String getDeletenum() {
		return deletenum;
	}

	public void setDeletenum(String deletenum) {
		this.deletenum = deletenum;
	}
	
}