/*
 * @(#) BooklendingAction.java
 * Copyright (c) 2010-2011 大连远东计算机系统有限公司
 * All rights reserved.
 * Project: 远东公司内部网
 * SubSystem: 图书管理系统
 */
package com.yds.library.action;

import java.util.ArrayList;
import java.util.List;

import net.sf.json.JSONArray;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import com.yds.base.action.AbstractBaseAction;
import com.yds.common.bean.UserInfo;
import com.yds.common.service.LoginService;
import com.yds.library.bean.BooklendingSercthmanybook;
import com.yds.library.bean.Bookinfo;
import com.yds.library.bean.Booklendinguserbklimit;
import com.yds.library.bean.Finishheadinfo;
import com.yds.library.bean.Finishinfo;
import com.yds.library.service.BooklendingService;
import com.yds.util.service.Session;

/**
 * 书籍借阅信息操作
 * 
 * @author LIYI
 * @version 1.0 2010/11/29
 */
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
@Controller("booklendingAction")
public class BooklendingAction extends AbstractBaseAction {

	private static final long serialVersionUID = -1397051695703253298L;

	private Bookinfo booklendingsercthbean; // 检索书籍明细bean

	private BooklendingSercthmanybook booklendingSercthmanybook; // 检索重复isbn书籍明细bean

	private List<String> bookisbnlist; // 图书ISBN

	private List<String> bookidlist; // 图书Id

	private List<String> bookvolumenumlist; // 图书volumenum
	
	private List<String> bookuseridlist; // 图书userid


	private List<Bookinfo> booklendingbookinfobean; // 返回传给jason list书籍bean

	private String jsonHysInfo; // JSON定义

	private String jsonmanyHysInfo; // JSON定义
	
	private String jsonkcHysInfo; // JSON定义

	private BooklendingService booklendingService; // 检索书籍service端

	private LoginService loginService; // 书籍借阅上限

	private List<Bookinfo> booklendinguserinsert; // 书籍借阅信息用户登陆

	private Finishheadinfo finishheadinfo; // 书籍借阅成功页面头部数据

	private List<Finishinfo> finishinfo; // 书籍借阅成功页面明细数据

	private Booklendinguserbklimit booklendinguserbklimit; // 密码验证service

	private String mimaparam;// 前台密码

	private String mimaTF; // 密码正确与否

	/**
	 * 画面迁移 个人图书上限的取得 初始页面
	 * 
	 * @param：用户ID
	 * @return SUCCESS
	 */

	public String loginjie() throws Exception {
		//session取得上限1229
		// 取得用户session
		//UserInfo loginuser = (UserInfo) Session.get(com.yds.common.service.SessionConstants.USERINFO);
		//String userid = loginuser.getUserId();
		
		//this.booklendinguserbklimit = booklendingService.getbooklimit(userid);
		
		Booklendinguserbklimit userlimit = (Booklendinguserbklimit) Session.get(com.yds.library.util.SessionConstants.USERLIMIT);
		
		Integer booknumlimit = userlimit.getBooknumlimit();
		
		Integer booklendednum = userlimit.getBooklendednum();

		Integer bookreadnum = userlimit.getBookreadnum();
		
		booklendinguserbklimit=new Booklendinguserbklimit();
		
		booklendinguserbklimit.setBooknumlimit(booknumlimit);
		
		booklendinguserbklimit.setBooklendednum(booklendednum);
		
		booklendinguserbklimit.setBookreadnum(bookreadnum);
		return SUCCESS;
	}

	/**
	 * 检索明细书籍（多本情况） 追加按钮操作
	 * 
	 * @param isbn
	 * @return JASON
	 */
	public String bookmanyadd() throws Exception {
		bookuseridlist=new ArrayList<String>();
		// 取得用户session
		UserInfo loginuser = (UserInfo) Session.get(com.yds.common.service.SessionConstants.USERINFO);
		String userid = loginuser.getUserId();
		for(int i=0;i<bookisbnlist.size();i++){
			bookuseridlist.add(userid);
		}
		// 整合数组检索多件isbn条件
		this.booklendingSercthmanybook = booklendingService.getdatabookInfo(
				bookisbnlist, bookidlist, bookvolumenumlist,bookuseridlist);
		// 多件书籍isbn条件
		this.booklendingbookinfobean = booklendingService
				.getmanybookInfo(booklendingSercthmanybook);
		this.booklendingbookinfobean = booklendingService
				.getmanybookchangeInfo(booklendingbookinfobean);
		JSONArray jsobjmany = JSONArray.fromObject(booklendingbookinfobean);
		setJsonmanyHysInfo(jsobjmany.toString());
		return SUCCESS;
	}

	/**
	 * 检索明细书籍书籍 追加按钮操作
	 * 
	 * @param isbn
	 * @return JASON
	 */
	public String bookadd() throws Exception {
		// 取得用户session
		UserInfo loginuser = (UserInfo) Session.get(com.yds.common.service.SessionConstants.USERINFO);
		String userid = loginuser.getUserId();
		booklendingsercthbean.setPurseid(userid);
		this.booklendingbookinfobean = booklendingService
				.getbookInfo(booklendingsercthbean);
		this.booklendingbookinfobean = booklendingService
				.getmanybookchangeInfo(booklendingbookinfobean);
		JSONArray jsobj = JSONArray.fromObject(booklendingbookinfobean);
		setJsonHysInfo(jsobj.toString());
		return SUCCESS;
	}
	
	/**
	 * 检索明细书籍书籍 追加按钮操作是否有库存
	 * 
	 * @param isbn
	 * @return JASON
	 */
	public String bookaddkc() throws Exception {
		// 取得用户session
		UserInfo loginuser = (UserInfo) Session.get(com.yds.common.service.SessionConstants.USERINFO);
		String userid = loginuser.getUserId();
		booklendingsercthbean.setPurseid(userid);
		this.booklendingbookinfobean = booklendingService
				.getbookInfokc(booklendingsercthbean);
		this.booklendingbookinfobean = booklendingService
				.getmanybookchangeInfo(booklendingbookinfobean);
		JSONArray jsokcbj = JSONArray.fromObject(booklendingbookinfobean);
		setJsonkcHysInfo(jsokcbj.toString());
		return SUCCESS;
	}


	/**
	 *用户密码验证
	 * 
	 * @param mima
	 * @return mimaTF=0密码错误，mimaTF=1密码正确 借书画面
	 */
	public String mmvalidate() throws Exception {
		// 取得用户session
		UserInfo loginuser = (UserInfo) Session.get(com.yds.common.service.SessionConstants.USERINFO);
		String userId = loginuser.getUserId();
		if (this.loginService.loginCheck(userId, mimaparam, false) == null) {
			mimaTF = "0";
		} else {
			mimaTF = "1";
		}
		return SUCCESS;
	}

	/**
	 *用户借书信息登录
	 * 
	 * @param booklending_userinsert
	 * @return 成功页面
	 */
	public String booklendinginsert() throws Exception {
		// 数据库书籍登陆
		this.booklendingService.insertbooklendInfo(booklendinguserinsert);
		// 取得用户session 成功页面头部数据绑定
		UserInfo loginuser = (UserInfo) Session.get(com.yds.common.service.SessionConstants.USERINFO);
		String username = loginuser.getUserName();
		String userid = loginuser.getUserId();
		finishheadinfo = new Finishheadinfo();
//		 登陆后成功画面用户上限信息的取得
		this.finishheadinfo = booklendingService.getbooklimitsuccess(userid,
				username, booklendinguserinsert);
		return SUCCESS;
	}


	/**
	 * @return the booklendinguserinsert
	 */
	public List<Bookinfo> getBooklendinguserinsert() {
		return booklendinguserinsert;
	}

	/**
	 * @param booklendinguserinsert the booklendinguserinsert to set
	 */
	public void setBooklendinguserinsert(List<Bookinfo> booklendinguserinsert) {
		this.booklendinguserinsert = booklendinguserinsert;
	}

	/**
	 * @return the booklendinguserbklimit
	 */
	public Booklendinguserbklimit getBooklendinguserbklimit() {
		return booklendinguserbklimit;
	}

	/**
	 * @param booklendinguserbklimit
	 *            the booklendinguserbklimit to set
	 */
	public void setBooklendinguserbklimit(
			Booklendinguserbklimit booklendinguserbklimit) {
		this.booklendinguserbklimit = booklendinguserbklimit;
	}

	/**
	 * @return the booklendingSercthmanybook
	 */
	public BooklendingSercthmanybook getBooklendingSercthmanybook() {
		return booklendingSercthmanybook;
	}

	/**
	 * @param booklendingSercthmanybook
	 *            the booklendingSercthmanybook to set
	 */
	public void setBooklendingSercthmanybook(
			BooklendingSercthmanybook booklendingSercthmanybook) {
		this.booklendingSercthmanybook = booklendingSercthmanybook;
	}

	/**
	 * @return the bookisbnlist
	 */
	public List<String> getBookisbnlist() {
		return bookisbnlist;
	}

	/**
	 * @param bookisbnlist
	 *            the bookisbnlist to set
	 */
	public void setBookisbnlist(List<String> bookisbnlist) {
		this.bookisbnlist = bookisbnlist;
	}

	/**
	 * @return the bookidlist
	 */
	public List<String> getBookidlist() {
		return bookidlist;
	}

	/**
	 * @param bookidlist
	 *            the bookidlist to set
	 */
	public void setBookidlist(List<String> bookidlist) {
		this.bookidlist = bookidlist;
	}

	/**
	 * @return the jsonHysInfo
	 */
	public String getJsonHysInfo() {
		return jsonHysInfo;
	}

	/**
	 * @param jsonHysInfo
	 *            the jsonHysInfo to set
	 */
	public void setJsonHysInfo(String jsonHysInfo) {
		this.jsonHysInfo = jsonHysInfo;
	}

	/**
	 * @return the jsonmanyHysInfo
	 */
	public String getJsonmanyHysInfo() {
		return jsonmanyHysInfo;
	}

	/**
	 * @param jsonmanyHysInfo
	 *            the jsonmanyHysInfo to set
	 */
	public void setJsonmanyHysInfo(String jsonmanyHysInfo) {
		this.jsonmanyHysInfo = jsonmanyHysInfo;
	}

	/**
	 * @return the booklendingService
	 */
	public BooklendingService getBooklendingService() {
		return booklendingService;
	}

	/**
	 * @param booklendingService
	 *            the booklendingService to set
	 */
	public void setBooklendingService(BooklendingService booklendingService) {
		this.booklendingService = booklendingService;
	}

	/**
	 * @return the loginService
	 */
	public LoginService getLoginService() {
		return loginService;
	}

	/**
	 * @param loginService
	 *            the loginService to set
	 */
	public void setLoginService(LoginService loginService) {
		this.loginService = loginService;
	}

	/**
	 * @return the finishheadinfo
	 */
	public Finishheadinfo getFinishheadinfo() {
		return finishheadinfo;
	}

	/**
	 * @param finishheadinfo
	 *            the finishheadinfo to set
	 */
	public void setFinishheadinfo(Finishheadinfo finishheadinfo) {
		this.finishheadinfo = finishheadinfo;
	}

	/**
	 * @return the finishinfo
	 */
	public List<Finishinfo> getFinishinfo() {
		return finishinfo;
	}

	/**
	 * @param finishinfo
	 *            the finishinfo to set
	 */
	public void setFinishinfo(List<Finishinfo> finishinfo) {
		this.finishinfo = finishinfo;
	}

	/**
	 * @return the booklending_userbklimit
	 */
	public Booklendinguserbklimit getBooklending_userbklimit() {
		return booklendinguserbklimit;
	}

	/**
	 * @param booklendingUserbklimit
	 *            the booklending_userbklimit to set
	 */
	public void setBooklending_userbklimit(
			Booklendinguserbklimit booklendingUserbklimit) {
		booklendinguserbklimit = booklendingUserbklimit;
	}

	/**
	 * @return the mimaparam
	 */
	public String getMimaparam() {
		return mimaparam;
	}

	/**
	 * @param mimaparam
	 *            the mimaparam to set
	 */
	public void setMimaparam(String mimaparam) {
		this.mimaparam = mimaparam;
	}

	/**
	 * @return the mimaTF
	 */
	public String getMimaTF() {
		return mimaTF;
	}

	/**
	 * @param mimaTF
	 *            the mimaTF to set
	 */
	public void setMimaTF(String mimaTF) {
		this.mimaTF = mimaTF;
	}

	/**
	 * @return the serialversionuid
	 */
	public static long getSerialversionuid() {
		return serialVersionUID;
	}

	/**
	 * @return the booklendingbookinfobean
	 */
	public List<Bookinfo> getBooklendingbookinfobean() {
		return booklendingbookinfobean;
	}

	/**
	 * @param booklendingbookinfobean
	 *            the booklendingbookinfobean to set
	 */
	public void setBooklendingbookinfobean(
			List<Bookinfo> booklendingbookinfobean) {
		this.booklendingbookinfobean = booklendingbookinfobean;
	}

	/**
	 * @return the bookvolumenumlist
	 */
	public List<String> getBookvolumenumlist() {
		return bookvolumenumlist;
	}

	/**
	 * @param bookvolumenumlist
	 *            the bookvolumenumlist to set
	 */
	public void setBookvolumenumlist(List<String> bookvolumenumlist) {
		this.bookvolumenumlist = bookvolumenumlist;
	}
	/**
	 * @return the booklendingsercthbean
	 */
	public Bookinfo getBooklendingsercthbean() {
		return booklendingsercthbean;
	}

	/**
	 * @param booklendingsercthbean
	 *            the booklendingsercthbean to set
	 */
	public void setBooklendingsercthbean(Bookinfo booklendingsercthbean) {
		this.booklendingsercthbean = booklendingsercthbean;
	}
	
	/**
	 * @return the bookuseridlist
	 */
	public List<String> getBookuseridlist() {
		return bookuseridlist;
	}

	/**
	 * @param bookuseridlist the bookuseridlist to set
	 */
	public void setBookuseridlist(List<String> bookuseridlist) {
		this.bookuseridlist = bookuseridlist;
	}
	/**
	 * @return the jsonkcHysInfo
	 */
	public String getJsonkcHysInfo() {
		return jsonkcHysInfo;
	}

	/**
	 * @param jsonkcHysInfo the jsonkcHysInfo to set
	 */
	public void setJsonkcHysInfo(String jsonkcHysInfo) {
		this.jsonkcHysInfo = jsonkcHysInfo;
	}
}