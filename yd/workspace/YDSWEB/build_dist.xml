<?xml version="1.0" encoding="UTF-8"?>
<!--  ===================================================================
        build.xml YDSWEB Build文件
        add by xieyujun 2010/03/02
      ===================================================================
-->
<project name="YDSWEB" basedir="." default="buildjar">
	<description>
       Notes:YDSWEB ant build 文件，具体说明请参照main/buildreadme.txt。
    </description>
	<!-- 主要的系统环境属性 -->
	<property environment="env" />
	<!-- 取window,unix...的环境变量 -->
	<property name="java.home" value="${env.JAVA_HOME}" />
	<property name="ant.home" value="${env.ANT_HOME}" />
	<property name="tomcat.home" value="D:/javasoft/tomcat" />
	
	<!-- 发布到dc的war文件名 -->
	<property name="webapp.name.test" value="YDSWEB" />

	<!-- 发布jar文件名 -->
	<property name="project.name" value="YDSWEB" />
	
	<!-- src路径 -->
	<property name="src.dir" value="src" />

	<!-- build环境属性 -->
	<property name="build.dir" value="build" />
	<property name="build.war.dir" value="${build.dir}/war" />
	<property name="build.war.classes" value="${build.war.dir}/WEB-INF/classes" />
	<property name="build.war.weblib.dir"
	          value="${build.war.dir}/WEB-INF/lib" />
	<property name="main.dir" value="main" />
	<property name="build.war.js.menu" value="${build.war.dir}/js/menu" />
	
	<!-- dist环境属性 -->
	<property name="dist.dir" value="dist" />
	
	<!-- 事先准备的配置文件，脚本等 -->
	<property name="webcontent.dir" value="WebRoot" />
	<property name="web.config.dir" value="${main.dir}/config/dist_web" />
	
	<!-- menu发布文件 -->
	<property name="lmenu.dir" value="${webcontent.dir}/lmenu" />	
<!-- menu发布文件 -->
	<property name="menu-js.dir" value="${webcontent.dir}/js/menu/" />		
	<!-- classpath -->
	<property name="webcontentlib.dir" value="${webcontent.dir}/WEB-INF/lib" />
	
	<!-- 测试用属性文件名 ，格式[host]-[dbscheme] -->
	<property name="jdbc-default.file" value="jdbc.properties" />
	<property name="jdbc-dc-dist.file" value="jdbc-dc-dist.properties" />
	
	<property name="default-struts-xml.file" value="struts.xml" />
	<property name="dc-struts-xml.file" value="struts.xml" />
	
	<property name="default-log4j-properties.file" value="log4j.properties" />
	<property name="dc-log4j-properties.file" value="log4j.properties" />
	
	<property name="default-com-parameter-properties.file" value="com_parameter.properties" />
	<property name="dc-com-parameter-properties.file" value="com_parameter.properties" />
		
	<property name="login-jsp.file" value="login.jsp" />
	<property name="login-jsp-dist.file" value="login.jsp" />	

	<property name="menu-js.file" value="menu.js" />
	<property name="menu-js-dist.file" value="menu.js" />		
			
	<property name="main-jsp.file" value="main.jsp" />
	<property name="main-jsp-dist.file" value="main.jsp" />				  
	<!-- java doc 输出包 -->
	<property name="webapp.dist" value="${dist.dir}/webapps" />
	
	<!-- project classpath -->
	<path id="project.classpath">
		<fileset dir="${java.home}">
			<include name="lib/*.jar" />
		</fileset>
		<fileset dir="${tomcat.home}">
			<include name="lib/*.jar" />
		</fileset>		
		<fileset dir="${webcontentlib.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>
	
	<!-- 定义不同的日期格式   -->
	<tstamp>
		<format property="touch.time.mm"  pattern="yyyyMMddHHmm"
		        offset="-0"
		        unit="hour" />
	</tstamp>
	<tstamp>
		<format property="touch.time"
		        pattern="yyyy/MM/dd HH:mm:ss.SSS"
		        offset="-0"
		        unit="hour" />
	</tstamp>
	<!--
    ===================================================================
          init 准备目录
    ===================================================================
      -->
	<target name="init" description="Clean output dirs (build, weblib, dist)">
    	<delete dir="${build.dir}" failonerror="false" />
		<mkdir dir="${build.dir}"/>
        <mkdir dir="${build.war.dir}"/>
		<mkdir dir="${build.war.classes}" />
		<mkdir dir="${build.war.weblib.dir}" />
		<tstamp />
		<echo message="${touch.time}">
		</echo>
	</target>
	<!--
    ===================================================================
               编译java源文件,copyjsp等文件到war,便于打包
    ===================================================================
      -->
	<target name="buildjar" depends="init"
	        description="Compile main source tree java files into class files, generate jar,war files">
		<!-- 编译(优化代码，不带debug信息) -->
		<javac destdir="${build.war.classes}"
		       deprecation="off"
		       source="1.5"
		       target="1.5"
		       debug="false"
		       optimize="true"
		       includeAntRuntime="false"
			   failonerror="true"
		       fork="true"
		       memoryMaximumSize="256m"
		       verbose="false">
			<src path="${src.dir}"/>
			<exclude name="**/BeanToCSV.java" />
			<exclude name="**/DBToExcelUtil.java" />
			<exclude name="**/ExcelToSql.java" />
			<exclude name="**/BeanToCSV.java" />
			<exclude name="**/DBToExcelUtil.java" />			
			<!-- 给编译器指定编码，防止出现：警告： 编码 GBK 的不可映射字符 -->
			<compilerarg line="-encoding utf-8" />
			<classpath refid="project.classpath" />
		</javac>
	
	  	<parallel>
			<copy todir="${build.war.dir}" preservelastmodified="true">
				<fileset dir="${webcontent.dir}">
					<exclude name="WEB-INF/classes/**/*.*" />
				</fileset>
			</copy> 
		    <!--*.xml,*.properties,*.vm,*.html,*.sql,*.txt,*.ftl,*.xls -->
			<copy todir="${build.war.classes}" preservelastmodified="true">
				<fileset dir="${src.dir}">
					<exclude name="**/.*" />
					<exclude name="**/*.java" />
				</fileset>
			</copy>
		</parallel>
		
		<antcall target="webconfig-copy" />
	</target>

	<!-- 用真是运行的配置文件代替开发的配置文件 -->
	
	<target name="webconfig-copy">
		<echo message="copy webcofig start "/>
		<!-- 拷贝jdbc-dc-dist.properties替换开发用的jdbc.properties-->
		<copy tofile="${build.war.dir}/WEB-INF/classes/${jdbc-default.file}"
			  preservelastmodified="true"
			  file="${web.config.dir}/${jdbc-dc-dist.file}" overwrite="true">
		</copy>
		
		<!-- 拷贝struts.xml替换开发用的struts.xml-->
		<copy tofile="${build.war.dir}/WEB-INF/classes/${default-struts-xml.file}"
			  preservelastmodified="true"
			  file="${web.config.dir}/${dc-struts-xml.file}" overwrite="true">
		</copy>
		
		<!-- 拷贝log4j.properties替换开发用的log4j.properties-->
		<copy tofile="${build.war.dir}/WEB-INF/classes/${default-log4j-properties.file}"
			  preservelastmodified="true"
			  file="${web.config.dir}/${dc-log4j-properties.file}" overwrite="true">
		</copy>
		
		<!-- 拷贝com_parameter.properties替换开发用的com_parameter.properties-->
		<copy tofile="${build.war.dir}/WEB-INF/classes/${default-com-parameter-properties.file}"
			  preservelastmodified="true"
			  file="${web.config.dir}/${dc-com-parameter-properties.file}" overwrite="true">
		</copy>
		
		<!-- 拷贝login.jsp替换开发用的login.jsp-->
		<copy tofile="${build.war.dir}/${login-jsp.file}"
			  preservelastmodified="true"
			  file="${lmenu.dir}/${login-jsp-dist.file}" overwrite="true">
		</copy>
		
		<!-- 拷贝menu.js替换开发用的menu.js-->
		<!--
		<copy tofile="${build.war.js.menu}/${menu-js.file}"
			  preservelastmodified="true"
			  file="${lmenu.dir}/${menu-js-dist.file}" overwrite="true">
		</copy>		
		-->
		<!-- 拷贝main.jsp替换开发用的main.jsp-->
		<copy tofile="${build.war.dir}/${main-jsp.file}"
			  preservelastmodified="true"
			  file="${lmenu.dir}/${main-jsp-dist.file}" overwrite="true">
		</copy>		
		<echo message="copy webcofig end "/>
	</target>
	


</project>
