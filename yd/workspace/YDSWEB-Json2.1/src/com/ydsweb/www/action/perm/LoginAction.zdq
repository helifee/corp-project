/*
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: YDSWEB
 *    SubSystem: 海景楼盘网
 */

package com.ydsweb.www.action.perm;

import org.springframework.stereotype.Controller;

import com.opensymphony.xwork2.ActionSupport;
import com.ydsweb.www.service.common.CommonConstants;
import com.ydsweb.www.service.common.CommonMessage;
import com.ydsweb.www.service.common.SessionManager;
import com.ydsweb.www.service.common.UserInfo;
import com.ydsweb.www.service.perm.LoginService;

/**
 * 登录/注销处理(Action请求)
 * @author 远东)zhaodong
 * @version 1.00 2009/09/22
 */
@Controller("loginAction")
public class LoginAction extends ActionSupport {

	private static final long serialVersionUID = 205317527105089601L;
	private LoginService loginService;
	private String userID;
	private String userName;
	private String passWord;
	private String errormsg;
	private String destUrl;

	/**
	 * 注销，清空session
	 * @return SUCCESS
	 */
	public String logout() throws Exception {
		setDestUrl("/" + CommonConstants.PAGE_LOGIN);
		SessionManager session = new SessionManager();
		session.destroy();
		return SUCCESS;

	}

	/**
	 * 重定向到重登录页面
	 * @return SUCCESS
	 */
	@Override
	public String execute() throws Exception {

		setDestUrl("/"	+ CommonConstants.PAGE_LOGIN);
		setErrormsg(CommonMessage.RE_LOGIN);
		return SUCCESS;

	}

	/**
	 * 登录处理
	 * @return SUCCESS:登录成功 ERROR:登录不成功(用户名、密码错误或无权限)
	 */
	public String login() throws Exception {
		//初期化
		SessionManager session = new SessionManager();
		String url = (String)session.get(CommonConstants.REQUESTURL);
		session.destroy();
		session = new SessionManager();
		setErrormsg("");
		
		//检查用户名、密码、权限(主处理)
		UserInfo user = this.loginService.login(userID, passWord);
		
		//登录不成功的情况
		if (null == user) {
			setErrormsg(CommonMessage.ERROR_USER_PASSWORD);
			return ERROR;
		}
		
		//临时处理
		setUserID(user.getUserID());
		setUserName(user.getUserName());

		//重定向到登录前请求的URL
		if (url == null) {
			setDestUrl("/"	+ CommonConstants.PAGE_MAIN);
		} else {
			setDestUrl(url);
		}
		return SUCCESS;
	}

	public String getUserID() {
		return userID;
	}

	public void setUserID(String userID) {
		this.userID = userID;
	}

	public String getUserName() {
		return userName;
	}

	public void setUserName(String userName) {
		this.userName = userName;
	}

	public String getPassWord() {
		return passWord;
	}

	public void setPassWord(String passWord) {
		this.passWord = passWord;
	}

	public void setLoginService(LoginService loginService) {
		this.loginService = loginService;
	}

	public String getErrormsg() {
		return errormsg;
	}

	public void setErrormsg(String errormsg) {
		this.errormsg = errormsg;
	}

	public String getDestUrl() {
		return destUrl;
	}

	public void setDestUrl(String destUrl) {
		this.destUrl = destUrl;
	}

}
