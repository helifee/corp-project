/*
 * Copyright (c) 2009-2010 大连远东计算机系统有限公司
 * All rights reserved.
 *      Project: SOOHAI
 *    SubSystem: 海景楼盘网
 */

package com.soohai.www.interceptor;

import java.util.Map;

import org.apache.struts2.ServletActionContext;

import com.opensymphony.xwork2.Action;
import com.opensymphony.xwork2.ActionInvocation;
import com.opensymphony.xwork2.interceptor.AbstractInterceptor;
import com.soohai.www.service.common.CommonConstants;

/**
 * 登录检查拦截器
 * @author 远东)zhaodong
 * @version 1.00 2009/09/22
 */
public class AuthInterceptor extends AbstractInterceptor {

	private static final long serialVersionUID = 791346288370079485L;

	/**
	 * 检查是否登录的拦截器 如果未登录，重定向到登录页面并将当前请求的URL保存到session中
	 * 
	 * @param invocation invocation
	 * @return 未登录的情况返回LOGIN
	 */
	@Override

	public String intercept(ActionInvocation invocation) throws Exception {
		Map<String,Object> session = invocation.getInvocationContext().getSession();

		if (session.get(CommonConstants.USERINFO) == null) {
			String requestUrl = ServletActionContext.getRequest()
					.getServletPath();
			if (!requestUrl.endsWith("." + CommonConstants.ACTIONNAME)) {
				requestUrl = requestUrl + "." + CommonConstants.ACTIONNAME;
			}
			if (ServletActionContext.getRequest().getQueryString() != null) {
				requestUrl = requestUrl + "?"
						+ ServletActionContext.getRequest().getQueryString();
			}
			session.put(CommonConstants.REQUESTURL, requestUrl);
			return Action.LOGIN;
		} else {
			return invocation.invoke();
		}
	}

}
