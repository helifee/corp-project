<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN"   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>    
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>  
<title>Google Maps JavaScript API Example</title> 

<script type="text/javascript" src="http://ditu.google.cn/maps?file=api&amp;v=2&amp;key=ABQIAAAASb3CKY7XaGRz7o9f7WrOchT2yXp_ZAY8_ufC3CFXhHIE1NvwkxTF2rj-ExEaYx787lS-3aiW7ebCOg&sensor=true">
</script>   

<script type="text/javascript">
  var marker;

  function initialize() {
	if (GBrowserIsCompatible()) {        
	  var map = new GMap2(document.getElementById("map"));      
	  map.setCenter(new GLatLng(38.888795,121.660624), 13);

	  //click
	  GEvent.addListener(map, "click", function(overlay, latlng) {
	    if(latlng) {
		  marker = new GMarker(latlng,{draggable:true});
          GEvent.addListener(marker,"click", function() {
            var myHtml = "<form method='post'><table>" +
                         "<tr><td>Name:</td> <td><input type='text' id='name'/> </td> </tr>" +
                         "<tr><td>Address:</td> <td><input type='text' id='address'/></td> </tr>" +
                         "<tr><td>Type:</td> <td><select id='type'>" +
                         "<option value='bar' SELECTED>bar</option>" +
                         "<option value='restaurant'>restaurant</option>" +
                         "</select> </td></tr>" +
                         "<tr><td></td><td><input type='button' value='Save & Close' onclick='saveData()'/></td></tr>" +
						 "</table></form>";
            map.openInfoWindowHtml(latlng, myHtml);
          });
		  map.addOverlay(marker);
		}
	  });
	}
  }

  function saveData() {
      var name = escape(document.getElementById("name").value);
      var address = escape(document.getElementById("address").value);
      var type = document.getElementById("type").value;
      var latlng = marker.getLatLng();
      var lat = latlng.lat();
      var lng = latlng.lng();

      var url = "newbuilding?name=" + name + "&address=" + address +
      			"&type=" + type + "&lat=" + lat + "&lng=" + lng;

	  targetForm = document.forms[0];
	  targetForm.action = url ;
	  targetForm.submit();

//      GDownloadUrl(url, function(data, responseCode) {
//          if (responseCode == 200 && data.length <= 1) {
//              marker.closeInfoWindow();
//             document.getElementById("message").innerHTML = "Location added.";
//          }
//      });

//	  document.forms[0].action = "newbuilding";
//	  document.forms[0].submit();
  }
</script>  

</head>

<body onload="initialize()" onunload="GUnload()">  
  <div id="map" style="width: 500px; height: 300px"></div>
  <div id="message"></div>
</body>

</html>