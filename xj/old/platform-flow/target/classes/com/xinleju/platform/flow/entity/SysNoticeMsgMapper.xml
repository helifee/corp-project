<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xinleju.platform.flow.entity.SysNoticeMsg">
	<!-- 新增 -->
	<insert id="save">
		${value}
	</insert>
	<!-- 修改根据Id -->
	<update id="update">
		${value}
	</update>
	<!-- 伪删除根据Id -->
	<update id="deletePseudoObjectById">
		${value}
	</update>
	<!-- 批量伪删除根据Id -->
	<update id="deletePseudoAllObjectByIds">
		${value}
	</update>
	<!-- 删除根据Id -->
	<delete id="deleteById">
		${value}
	</delete>
	<!-- 批量删除根据Id -->
	<delete id="deleteBatchByIds">
		${value}
	</delete>
	<!-- 获取单个对象，根据Id-->
	<select id="get" resultType="com.xinleju.platform.flow.entity.SysNoticeMsg">
		${value}
	</select>
	<!-- 获取列表根据Map查询 -->
	<select id="queryList" resultType="com.xinleju.platform.flow.entity.SysNoticeMsg">
		${value}
	</select>
	<!-- 获取分页根据Map查询 -->
	<select id="queryPageList" resultType="com.xinleju.platform.flow.entity.SysNoticeMsg">
		${value}
	</select>
	<!-- 获取总记录数 -->
	<select id="queryCount" resultType="java.lang.Integer">
		${value}
	</select>
	
	<select id="queryTwoSumData" resultType="com.xinleju.platform.flow.dto.SysNoticeMsgDto">
		SELECT SUM( CASE op_type  WHEN  'DB'  THEN 1 ELSE 0 END ) toDoSum,
 		SUM( case op_type WHEN 'DY' THEN 1 ELSE 0 END ) toReadSum
  		FROM pt_flow_sys_notice_msg  WHERE delflag = 0  
  		<if test="userId != null and userId != ''">
		    AND user_id = #{userId}  
		</if>
		<if test="msgType != null and msgType != ''">
		    AND msg_type = #{msgType}  
		</if>
	</select>
	
	<select id="queryHaveDoneList" resultType="com.xinleju.platform.flow.dto.SysNoticeMsgDto">
		SELECT id, title , code, send_date sendDate,login_name loginName, user_id userId, is_open isOpen, 
		user_name userName, msg_type msgType, op_type opType,source, app_code appCode, 
		business_id businessId, ip_address ipAddress, extend_info extendInfo, url,  deal_date dealDate, 
		timestampdiff(HOUR, send_date, IFNULL( deal_date, now())) hourSum 
  		FROM pt_flow_sys_notice_msg  WHERE delflag = 0 and op_type in ('YB','YY') 
  		<if test="userId != null and userId != ''">
		    AND user_id = #{userId}  
		</if>
		ORDER BY send_date DESC
	</select>
	
	<select id="queryDBDYList" resultType="com.xinleju.platform.flow.dto.SysNoticeMsgDto">
		SELECT id, title , code, send_date sendDate,login_name loginName, user_id userId, is_open isOpen, 
		user_name userName, msg_type msgType, op_type opType,source, app_code appCode, 
		business_id businessId, ip_address ipAddress, extend_info extendInfo, url,  deal_date dealDate,
		timestampdiff(HOUR, send_date, IFNULL( deal_date, now())) hourSum
  		FROM pt_flow_sys_notice_msg  WHERE delflag = 0 AND deal_date is null AND op_type in ('DB','DY') 
  		<if test="userId != null and userId != ''">
		    AND user_id = #{userId}  
		</if>
		ORDER BY send_date DESC
	</select>
	
	
	
	<update id="completeMessage" parameterType="java.util.HashMap" >
		UPDATE PT_FLOW_SYS_NOTICE_MSG 
		SET op_type = #{opType}, deal_date = #{dealDate}
		WHERE delflag = 0 and id = #{msgId}
	</update>
	
	<update id="setMessageOpened" parameterType="java.lang.String">
		UPDATE PT_FLOW_SYS_NOTICE_MSG 
		SET is_open = 1
		WHERE  delflag = 0 and id = #{messageId}
	</update>
	
	<update id="updateStatusOfNoticeMsg" parameterType="java.util.HashMap" >
		UPDATE PT_FLOW_SYS_NOTICE_MSG 
		SET op_type = #{newStatus}, deal_date = now() 
		WHERE  delflag = 0 and op_type = #{oldStatus} 
		<if test="id != null and id != '' and id != '-1'">
		    AND id = #{id}  
		</if>
		<if test="businessId != null and businessId != '' and businessId != '-1'">
		    AND business_id = #{businessId}  
		</if>
		<if test="extendInfo != null and extendInfo != '' and extendInfo != '-1'">
		    AND extend_info = #{extendInfo}  
		</if>
		<if test="userId != null and userId != '' and userId != '-1'">
			AND user_id in 
			<foreach item="item" index="index" collection="userId" open="(" separator="," close=")">  
	            #{item} 
	        </foreach>
		</if>
	</update>
	
	
	<select id="searchDataByKeyword" resultType="com.xinleju.platform.flow.dto.SysNoticeMsgDto">
		SELECT id, title , code, send_date sendDate,login_name loginName, user_id userId, is_open isOpen, 
		user_name userName, msg_type msgType, op_type opType,source, app_code appCode, now() serverDate,
		business_id businessId, ip_address ipAddress, extend_info extendInfo, url,  deal_date dealDate, 
  		timestampdiff(HOUR, send_date, IFNULL( deal_date, now())) hourSum
  		FROM pt_flow_sys_notice_msg  WHERE delflag =0  
  		<if test="userId != null and userId != ''">
		    AND user_id = #{userId}  
		</if>
		<if test="keyword != null and keyword != ''">
		    AND title LIKE concat('%',#{keyword},'%') 
		</if>
		
		<if test='dataType =="HAVE_DONE" '>
		    AND op_type in ('YB','YY')
		</if>
		
		<if test='dataType =="DB" or dataType =="DY" or dataType =="FQ" '>
		    AND op_type = #{dataType}
		</if>
		
		<if test=' dataType =="DB" or dataType =="DY" '>
		    AND deal_date is null 
		</if>
		
		<if test='timeType=="WEEK"'>  
	    	AND send_date &gt;= date_sub(now(),interval 7 day)
		</if>   
		<if test='timeType=="MONTH"'>  
		    AND send_date &gt;= date_sub(now(),interval 30 day)
		</if> 
		<if test='timeType=="QUARTER"'>  
			AND send_date &gt;= date_sub(now(),interval 90 day)
		</if>
				
		ORDER BY send_date DESC
	</select>
	
		
    <update id="deleteOpTypeDataByParamMap"  parameterType="java.util.HashMap" >
		UPDATE PT_FLOW_SYS_NOTICE_MSG 
		SET delflag = 1, deal_date = now(), update_date=now() 
		WHERE delflag = 0 
		<if test="opType != null and opType != '' and opType != '-1'">
		    AND op_type = #{opType} 
		</if>
		
		<if test="businessId != null and businessId != '' and businessId != '-1'">
		    AND business_id = #{businessId}  
		</if>
		
		<if test="currentUserId != null and currentUserId != '' and currentUserId != '-1'">
		    AND user_id = #{currentUserId}  
		</if>
		
		<if test="composeOpTypes != null and composeOpTypes != '' ">
		    AND op_type in 
			<foreach item="item" index="index" collection="composeOpTypes" open="(" separator="," close=")">  
	            #{item} 
	        </foreach> 
		</if>
		
		<if test="currentUserId != null and currentUserId != '-1'">
			AND user_id = #{currentUserId}
		</if>
		
		<if test="userId != null and userId != '-1'">
			AND user_id in 
			<foreach item="item" index="index" collection="userId" open="(" separator="," close=")">  
	            #{item} 
	        </foreach>
		</if>
		
		<if test="instanceIdText != null and instanceIdText != '' and instanceIdText != '-1'">
			AND url LIKE  concat('%',#{instanceIdText},'%') 
		</if>
	</update>
	
	<select id="pageQueryByParamMap"  resultType="com.xinleju.platform.flow.dto.SysNoticeMsgDto" parameterType="java.util.HashMap">
		SELECT id, title , code, send_date sendDate,login_name loginName, user_id userId, is_open isOpen, 
		user_name userName, msg_type msgType, op_type opType,source, app_code appCode, now() serverDate,
		business_id businessId, ip_address ipAddress, extend_info extendInfo, url,  deal_date dealDate, 
		mobible_url mobibleUrl, mobible_param mobibleParam, is_locked isLocked 
		FROM PT_FLOW_SYS_NOTICE_MSG WHERE delflag = 0 
  		<if test="userId != null and userId != ''">
		    AND user_id = #{userId}  
		</if>
		<if test='dataType =="HAVE_DONE" '>
		    AND op_type in ('YB','YY') AND deal_date is not null
		</if>
		<if test='dataType =="TO_DO" '>
		    AND op_type = 'DB' AND deal_date is null
		</if>
		<if test='dataType =="TO_READ" '>
		    AND op_type = 'DY'  AND deal_date is null
		</if>
		<if test='dataType =="MY_START" '>
		    AND op_type = 'FQ' 
		</if>
		ORDER BY send_date DESC  LIMIT #{start}, #{limit}
	</select>
	
	<select id="pageCountByParamMap" resultType="java.lang.Integer" parameterType="java.util.HashMap">
		SELECT count(id) FROM PT_FLOW_SYS_NOTICE_MSG WHERE delflag = 0 
  		<if test="userId != null and userId != ''">
		    AND user_id = #{userId}  
		</if>
		<if test='dataType =="HAVE_DONE" '>
		    AND op_type in ('YB','YY') AND deal_date is not null
		</if>
		<if test='dataType =="TO_DO" '>
		    AND op_type = 'DB' AND deal_date is null
		</if>
		<if test='dataType =="TO_READ" '>
		    AND op_type = 'DY' AND deal_date is null
		</if>
		<if test='dataType =="MY_START" '>
		    AND op_type = 'FQ' 
		</if>
	</select>
	
	
	<update id="updateStatusOfNoticeMsgByCurrentUser" parameterType="java.util.HashMap" >
		UPDATE PT_FLOW_SYS_NOTICE_MSG 
		SET op_type = #{newStatus}, deal_date = now() 
		WHERE  delflag = 0 and op_type = #{oldStatus} 
		<if test="id != null and id != '' and id != '-1'">
		    AND id = #{id}  
		</if>
		<if test="businessId != null and businessId != '' and businessId != '-1'">
		    AND business_id = #{businessId}  
		</if>
		<if test="extendInfo != null and extendInfo != '' and extendInfo != '-1'">
		    AND extend_info = #{extendInfo}  
		</if>
		
		<if test="userId != null and userId != '-1'">
			AND user_id = #{userId}
		</if>
		
		<if test="instanceIdText != null and instanceIdText != '' and instanceIdText != '-1'">
			AND url LIKE  concat('%',#{instanceIdText},'%') 
		</if>
	</update>
	
	<select id="queryMsgDto24Hours"  resultType="com.xinleju.platform.flow.dto.SysNoticeMsgDto" parameterType="java.util.HashMap">
		select id, title,user_id, now() serverDate, send_date sendDate, timestampdiff(hour, send_date, now()) hourSum
		from pt_flow_sys_notice_msg where delflag=0 and op_type='DB'
		AND timestampdiff(hour, send_date, now())>24
		<if test="userId != null and userId != '' and userId != '-1'">
			AND user_id = #{userId} 
		</if>
		<if test="msgType != null and msgType != ''">
		    AND msg_type = #{msgType}  
		</if>
	</select>
	
	<select id="queryFirstTypeStatData"  resultType="com.xinleju.platform.flow.dto.SysNoticeMsgStatDto" parameterType="java.util.HashMap">
		SELECT SUM( CASE WHEN(first_type='TASKTODO' and op_type in ('DB','DY')) THEN 1 ELSE 0 END ) taskToDoSum,
		SUM( CASE WHEN(first_type='MEETING' and op_type in ('DB','DY')) THEN 1 ELSE 0 END ) meetingSum,
		SUM( CASE WHEN(first_type='SCHEDULE' and op_type ='DY') THEN 1 ELSE 0 END ) scheduleSum,
		SUM( CASE WHEN(first_type='NEWS' and op_type ='DY') THEN 1 ELSE 0 END ) newsSum,
		SUM( CASE WHEN(first_type='DIRECTORS' and op_type ='DY') THEN 1 ELSE 0 END ) directorsSum,
		SUM( CASE WHEN(first_type='CLOCKIN' and op_type ='DY') THEN 1 ELSE 0 END ) clockInSum
		FROM pt_flow_sys_notice_msg WHERE first_type is not null AND delflag=0 
		<if test="userId != null and userId != '' and userId != '-1'">
			AND user_id = #{userId} 
		</if>
	</select>
	
	
	<select id="queryAllUserToDoList"  resultType="com.xinleju.platform.flow.dto.SysNoticeMsgDto" parameterType="java.util.HashMap">
		SELECT msg.user_id userId, u.login_name loginName, u.tend_id tendId, count(msg.id) toDoSum 
		FROM pt_flow_sys_notice_msg msg, pt_sys_org_user u
		WHERE msg.user_id = u.id and msg.delflag=0 AND msg.deal_date is null
		AND u.login_name = 'zhengjiajie' 
		<if test="opType != null and opType != ''">
		    AND msg.op_type = #{opType}  
		</if>
		<if test="msgType != null and msgType != ''">
		    AND msg.msg_type = #{msgType}  
		</if>
		group by msg.user_id, u.login_name, u.tend_id
	</select>
	
</mapper>