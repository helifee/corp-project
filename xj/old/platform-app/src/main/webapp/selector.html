<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="styleSheet" href="/platform-app/common/bootstrap/css/bootstrap.min.css">
    <link rel="styleSheet" href="/platform-app/common/jqGrid/css/ui.jqgrid.css">
    <link rel="styleSheet" href="/platform-app/common/jqGrid/css/css/redmond/jquery-ui-1.8.16.custom.css">
    <link rel="styleSheet" href="/platform-app/common/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="styleSheet" href="/platform-app/common/jqGrid/css/grid.extend.css">
    <link rel="styleSheet" href="/platform-app/common/bootstrap/css/bootstrap.extend.css">
    <link rel="styleSheet" href="/platform-app/common/zTreeStyle/zTreeStyle.css">
    <!--<link rel="styleSheet" href="/platform-app/common/bootstrap/css/bootstrap-datetimepicker.min.css">-->
    <link rel="styleSheet" href="/platform-app/common/easyDialog/easydialog.css">
    <link rel="styleSheet" href="/platform-app/common/custom/css/index.css">
    <!--<link rel="stylesheet" href="/platform-app/common/jquery-file-upload/css/jquery.fileupload.css">
    <link rel="stylesheet" href="/platform-app/common/custom/css/attachment.css">-->
    <script type="text/javascript">
        var hostUrl = '/platform-app/'
    </script>
</head>
<body>
<div class="col-md-12">
    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="orgName1" readonly="readonly" placeholder="选择组织机构">
            <span class="input-group-addon single-selector" data-title="选择组织机构" data-targetname="orgName1">...</span>
        </div>
    </div>

    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="personName" readonly="readonly" placeholder="选择人员">
            <span class="input-group-addon single-selector" data-selectorType="person" data-title="选择人员"
                  data-savecallback="testCallback1" data-targetname="personName" >...</span>
            <!--data-treeparam="{'userStatus':false}" data-treeUrl="/platform-app/sys/org/roleUser/selectUserPostTree"-->
        </div>
    </div>
    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="postName" readonly="readonly" placeholder="选择岗位">
            <span class="input-group-addon single-selector" data-selectorType="post" data-title="选择岗位" data-targetname="postName">...</span>
        </div>
    </div>
    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="roleName" readonly="readonly" placeholder="选择角色">
            <span class="input-group-addon single-selector" data-selectorType="role" data-title="选择角色" data-targetname="roleName">...</span>
        </div>
    </div>
    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="menuName" readonly="readonly" placeholder="选择菜单">
            <span class="input-group-addon single-selector" data-selectorType="menu" data-title="选择菜单" data-targetname="menuName">...</span>
        </div>
    </div>
    <br><br><br>
    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="orgName11" readonly="readonly" placeholder="选择组织机构（多选）">
            <span class="input-group-addon multiple-selector" data-title="选择组织机构" data-targetname="orgName11">...</span>
        </div>
    </div>
    <div class="row">
        <div class="input-group">
            <input type="text" id="userId" value="4c359cdd88c7419eae34b8b93884bcf8">
            <input type="text" class="form-control" id="personName1" readonly="readonly" placeholder="选择人员（多选）" value="芦晋莲">
            <span class="input-group-addon multiple-selector" data-selectorType="person" data-title="选择人员" data-targetid="userId"
                  data-targetname="personName1" data-savecallback="testCallback">...</span>
        </div>
    </div>
    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="postName1" readonly="readonly" placeholder="选择岗位（多选）">
            <span class="input-group-addon multiple-selector" data-selectorType="post" data-title="选择岗位" data-targetname="postName1">...</span>
        </div>
    </div>
    <div class="row">
        <div class="input-group">
            <input type="text" class="form-control" id="roleName1" readonly="readonly" placeholder="选择角色（多选）">
            <span class="input-group-addon multiple-selector" data-selectorType="role" data-title="选择角色" data-targetname="roleName1">...</span>
        </div>
    </div>
    <div class="row">
        <div class="btn-group">
            <button type="button" class="btn btn-default" id="testBtn">测试树</button>
            <button type="button" class="btn btn-default" id="testBtn1">测试树1</button>
        </div>
    </div>


    <div style="height:1000px;"></div>
    <div class="row">
        <div class="input-group">
            <input type="hidden" id="personIdAA" value="2fbe5c1a14324a32a1586863642ce37b">
            <input type="text" class="form-control" id="personNameAA" readonly="readonly" placeholder="选择人员">
            <span class="input-group-addon single-selector" data-selectorType="person" data-title="选择人员" data-targetid="personIdAA"
                  data-savecallback="testCallback1" data-targetname="personNameAA" data-treeparam="{'userStatus':false}" data-treeUrl="/platform-app/sys/org/roleUser/selectUserPostTree">...</span>
        </div>
    </div>

</div>
<script src="/platform-app/common/jquery/jquery-2.2.3.min.js" type="text/javascript"></script>
<script src="/platform-app/common/jquery/jquery-2.2.3.min.js" type="text/javascript"></script>
<script src="/platform-app/common/validate/jquery.validate.min.js" type="text/javascript"></script>
<script src="/platform-app/common/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="/platform-app/common/easyDialog/easydialog.js" type="text/javascript"></script>
<script src="/platform-app/common/jqGrid/js/i18n/grid.locale-cn.js" type="text/javascript"></script>
<script src="/platform-app/common/jqGrid/js/jquery.jqGrid.src.js" type="text/javascript"></script>
<script src="/platform-app/common/zTreeStyle/jquery.ztree.all.js" type="text/javascript"></script>
<script src="/platform-app/common/zTreeStyle/jquery.ztree.exhide.js" type="text/javascript"></script>
<script src="/platform-app/common/scroll/jquery.nicescroll.js" type="text/javascript"></script>
<script src="/platform-app/common/utils/xljUtils.js" type="text/javascript"></script>
<script src="/platform-app/common/utils/xljMultipleSelector.js" type="text/javascript"></script>
<script src="/platform-app/common/utils/xljSingleSelector.js" type="text/javascript"></script>
<script src="/platform-app/common/utils/xljFlowRelationSelector.js" type="text/javascript"></script>
<script type="text/javascript">
    function testCallback(data) {
        console.info(data);
    }
    function testCallback1(data) {
        console.info(data);
    }

    $(function () {
        //单选
        $('#testBtn').on('click',function () {
            $(this).xljSingleSelector({
                selectorType:'org',
                saveCallback:testCallback,
                immediatelyShow:true,
                modalShownEvent:function () {
                    //alert('hello');
                }
            });
        });

        $('#testBtn1').on('click', function () {
            $(this).xljSingleSelector({
                selectorType: 'org',
                saveCallback: testCallback,
                immediatelyShow: true,
                modalShownEvent: function () {
                    //alert('hello');
                }
            });
        });

        //多选
        /*$('#testBtn1').xljFlowRelationSelector({

        });*/

        $(window).on('resize',function () {
           console.info('resize window');
        });

        var prepareParamDataForResData = function (partnerList){
            //debugger;
            var userArray = [];
            var postArray = [];
            var roleArray = [];
            var orgArray = [];
            for(var idx=0; idx<partnerList.length; idx++){
                var item = partnerList[idx];
                var scope = item.participantScope;
                scope = scope+"";
                if(scope == "11"){//指定人员
                    var participantId = item.participantId;
                    if(!participantId || participantId==''||participantId.indexOf('&&')!=-1){
                        participantId = undefined;
                    }
                    var paramValue = item.paramValue;
                    if(!paramValue || paramValue==''||paramValue.indexOf('&&')!=-1){
                        paramValue = undefined;
                    }
                    userArray.push(participantId+"&&"+paramValue);
                    //userArray.push(item.participantId);
                }else if(scope == "21"){//指定岗位
                    postArray.push(item.participantId);
                }else if(scope.indexOf("31")==0 || scope == "51"){//选择了角色
                    roleArray.push(item.participantId);
                }
            }
            var typeArray = ['postUser', 'post', 'role', 'org'];
            var idArray = [userArray, postArray, roleArray, orgArray];
            var paramArray = new Array();
            for(var i=0; i<typeArray.length; i++){
                var idItemArray = idArray[i];
                if(idItemArray.length>0){
                    var obj = new Object();
                    obj.type = typeArray[i];
                    obj.ids = idArray[i];
                    paramArray.push(obj);
                }
            }
            return paramArray;
        };

        var queryResDataList = function (paramData){
            var participantNameDef = new $.Deferred();
            var postdata={ paramData:paramData };
            $.ajax({ //发送更新的ajax请求
                type: "POST",
                url: hostUrl+"sys/org/orgnazation/queryResListByIds?_t="+new Date().getTime(),
                dataType:"json",
                data:  JSON.stringify(postdata),//此处必须JSON.stringify(paramData)
                contentType: 'application/json;charset=utf-8', //设置请求头信息
                success: function(data){
                    var resDataList = data.result;
                    var participantNameMap = {};
                    for(var i in resDataList){
                        var obj = resDataList[i];
                        var id = obj.id;
                        var participantName = obj.prefixName;
                        participantNameMap[id] = participantName;
                    }

                    participantNameDef.resolve(participantNameMap);
                },
                error: function(data){
                    if(data.msg){
                        $.xljUtils.tip('red',data.msg);
                    }else{
                        $.xljUtils.tip('red','查询资源数据的接口异常');
                    }
                    participantNameDef.resolve(null);
                }
            });

            return participantNameDef.promise();
        };

        window.sqlArr = [];
        window.initParticipant = function (startrow) {
            //sqlArr = [];
            var postData = {
                start:startrow*1000,
                limit:1000,
                sidx:'createDate',
                sord:'desc'
            };
            $.ajax({
                type: "POST",
                url: hostUrl + "flow/participant/page?_t="+new Date().getTime(),
                data: JSON.stringify(postData),
                dataType: "json",
                contentType: 'application/json',
                success: function (participantListData) {
                    //debugger;
                    var paramData = prepareParamDataForResData(participantListData.result.list);
                    var participantNameDef = queryResDataList(paramData);
                    $.when(participantNameDef).done(function (data) {
                        console.info(startrow);
                        for(var item in data){
                            var sql = 'update pt_flow_participant p set p.participant_name = \''+ data[item] + '\' where p.participant_id= \''+ item + '\'';
                            sqlArr.push(sql);
                        }


                    });
                }
            });
        };

        window.loopWriteParticipants = function (totalPages) {
            for (var i = 0; i < totalPages; i++) {
                initParticipant(i);

            }

            setTimeout(function () {
                console.info(sqlArr.join(';\n') + ';');
            },60000);
        };

        console.info(window.opener.location);
    });
</script>
</body>
</html>