function mxGraphHandler(A){this.graph=A;this.graph.addMouseListener(this);this.panHandler=mxUtils.bind(this,function(){this.updatePreviewShape();this.updateHint()});this.graph.addListener(mxEvent.PAN,this.panHandler);this.escapeHandler=mxUtils.bind(this,function(B,C){this.reset()});this.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}mxGraphHandler.prototype.graph=null;mxGraphHandler.prototype.maxCells=(mxClient.IS_IE)?20:50;mxGraphHandler.prototype.enabled=true;mxGraphHandler.prototype.highlightEnabled=true;mxGraphHandler.prototype.cloneEnabled=true;mxGraphHandler.prototype.moveEnabled=true;mxGraphHandler.prototype.guidesEnabled=false;mxGraphHandler.prototype.guide=null;mxGraphHandler.prototype.currentDx=null;mxGraphHandler.prototype.currentDy=null;mxGraphHandler.prototype.updateCursor=true;mxGraphHandler.prototype.selectEnabled=true;mxGraphHandler.prototype.removeCellsFromParent=true;mxGraphHandler.prototype.connectOnDrop=false;mxGraphHandler.prototype.scrollOnMove=true;mxGraphHandler.prototype.minimumSize=6;mxGraphHandler.prototype.previewColor="black";mxGraphHandler.prototype.htmlPreview=false;mxGraphHandler.prototype.shape=null;mxGraphHandler.prototype.scaleGrid=false;mxGraphHandler.prototype.rotationEnabled=true;mxGraphHandler.prototype.isEnabled=function(){return this.enabled};mxGraphHandler.prototype.setEnabled=function(A){this.enabled=A};mxGraphHandler.prototype.isCloneEnabled=function(){return this.cloneEnabled};mxGraphHandler.prototype.setCloneEnabled=function(A){this.cloneEnabled=A};mxGraphHandler.prototype.isMoveEnabled=function(){return this.moveEnabled};mxGraphHandler.prototype.setMoveEnabled=function(A){this.moveEnabled=A};mxGraphHandler.prototype.isSelectEnabled=function(){return this.selectEnabled};mxGraphHandler.prototype.setSelectEnabled=function(A){this.selectEnabled=A};mxGraphHandler.prototype.isRemoveCellsFromParent=function(){return this.removeCellsFromParent};mxGraphHandler.prototype.setRemoveCellsFromParent=function(A){this.removeCellsFromParent=A};mxGraphHandler.prototype.getInitialCellForEvent=function(A){return A.getCell()};mxGraphHandler.prototype.isDelayedSelection=function(B,A){return this.graph.isCellSelected(B)};mxGraphHandler.prototype.consumeMouseEvent=function(B,A){A.consume()};mxGraphHandler.prototype.mouseDown=function(A,B){if(!B.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&B.getState()!=null&&!mxEvent.isMultiTouchEvent(B.getEvent())){var C=this.getInitialCellForEvent(B);this.delayedSelection=this.isDelayedSelection(C,B);this.cell=null;if(this.isSelectEnabled()&&!this.delayedSelection){this.graph.selectCellForEvent(C,B.getEvent())}if(this.isMoveEnabled()){var D=this.graph.model;var E=D.getGeometry(C);if(this.graph.isCellMovable(C)&&((!D.isEdge(C)||this.graph.getSelectionCount()>1||(E.points!=null&&E.points.length>0)||D.getTerminal(C,true)==null||D.getTerminal(C,false)==null)||this.graph.allowDanglingEdges||(this.graph.isCloneEvent(B.getEvent())&&this.graph.isCellsCloneable()))){this.start(C,B.getX(),B.getY())}else{if(this.delayedSelection){this.cell=C}}this.cellWasClicked=true;this.consumeMouseEvent(mxEvent.MOUSE_DOWN,B)}}};mxGraphHandler.prototype.getGuideStates=function(){var B=this.graph.getDefaultParent();var C=this.graph.getModel();var A=mxUtils.bind(this,function(D){return this.graph.view.getState(D)!=null&&C.isVertex(D)&&C.getGeometry(D)!=null&&!C.getGeometry(D).relative});return this.graph.view.getCellStates(C.filterDescendants(A,B))};mxGraphHandler.prototype.getCells=function(A){if(!this.delayedSelection&&this.graph.isCellMovable(A)){return[A]}else{return this.graph.getMovableCells(this.graph.getSelectionCells())}};mxGraphHandler.prototype.getPreviewBounds=function(E){var C=this.getBoundingBox(E);if(C!=null){C.width=Math.max(0,C.width-1);C.height=Math.max(0,C.height-1);if(C.width<this.minimumSize){var D=this.minimumSize-C.width;C.x-=D/2;C.width=this.minimumSize}else{C.x=Math.round(C.x);C.width=Math.ceil(C.width)}var F=this.graph.view.translate;var B=this.graph.view.scale;if(C.height<this.minimumSize){var A=this.minimumSize-C.height;C.y-=A/2;C.height=this.minimumSize}else{C.y=Math.round(C.y);C.height=Math.ceil(C.height)}}return C};mxGraphHandler.prototype.getBoundingBox=function(D){var C=null;if(D!=null&&D.length>0){var E=this.graph.getModel();for(var A=0;A<D.length;A++){if(E.isVertex(D[A])||E.isEdge(D[A])){var F=this.graph.view.getState(D[A]);if(F!=null){var B=F;if(E.isVertex(D[A])&&F.shape!=null&&F.shape.boundingBox!=null){B=F.shape.boundingBox}if(C==null){C=mxRectangle.fromRectangle(B)}else{C.add(B)}}}}}return C};mxGraphHandler.prototype.createPreviewShape=function(A){var B=new mxRectangleShape(A,null,this.previewColor);B.isDashed=true;if(this.htmlPreview){B.dialect=mxConstants.DIALECT_STRICTHTML;B.init(this.graph.container)}else{B.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;B.init(this.graph.getView().getOverlayPane());B.pointerEvents=false;if(mxClient.IS_IOS){B.getSvgScreenOffset=function(){return 0}}}return B};mxGraphHandler.prototype.start=function(C,A,B){this.cell=C;this.first=mxUtils.convertPoint(this.graph.container,A,B);this.cells=this.getCells(this.cell);this.bounds=this.graph.getView().getBounds(this.cells);this.pBounds=this.getPreviewBounds(this.cells);if(this.guidesEnabled){this.guide=new mxGuide(this.graph,this.getGuideStates())}};mxGraphHandler.prototype.useGuidesForEvent=function(A){return(this.guide!=null)?this.guide.isEnabledForEvent(A.getEvent()):true};mxGraphHandler.prototype.snap=function(B){var A=(this.scaleGrid)?this.graph.view.scale:1;B.x=this.graph.snap(B.x/A)*A;B.y=this.graph.snap(B.y/A)*A;return B};mxGraphHandler.prototype.getDelta=function(C){var B=mxUtils.convertPoint(this.graph.container,C.getX(),C.getY());var A=this.graph.view.scale;return new mxPoint(this.roundLength((B.x-this.first.x)/A)*A,this.roundLength((B.y-this.first.y)/A)*A)};mxGraphHandler.prototype.updateHint=function(A){};mxGraphHandler.prototype.removeHint=function(){};mxGraphHandler.prototype.roundLength=function(A){return Math.round(A)};mxGraphHandler.prototype.mouseMove=function(Q,G){var S=this.graph;if(!G.isConsumed()&&S.isMouseDown&&this.cell!=null&&this.first!=null&&this.bounds!=null){if(mxEvent.isMultiTouchEvent(G.getEvent())){this.reset();return}var J=this.getDelta(G);var K=J.x;var R=J.y;var U=S.tolerance;if(this.shape!=null||Math.abs(K)>U||Math.abs(R)>U){if(this.highlight==null){this.highlight=new mxCellHighlight(this.graph,mxConstants.DROP_TARGET_COLOR,3)}if(this.shape==null){this.shape=this.createPreviewShape(this.bounds)}var M=S.isGridEnabledEvent(G.getEvent());var E=true;if(this.guide!=null&&this.useGuidesForEvent(G)){J=this.guide.move(this.bounds,new mxPoint(K,R),M);E=false;K=J.x;R=J.y}else{if(M){var C=S.getView().translate;var N=S.getView().scale;var V=this.bounds.x-(S.snap(this.bounds.x/N-C.x)+C.x)*N;var I=this.bounds.y-(S.snap(this.bounds.y/N-C.y)+C.y)*N;var A=this.snap(new mxPoint(K,R));K=A.x-V;R=A.y-I}}if(this.guide!=null&&E){this.guide.hide()}if(S.isConstrainedEvent(G.getEvent())){if(Math.abs(K)>Math.abs(R)){R=0}else{K=0}}this.currentDx=K;this.currentDy=R;this.updatePreviewShape();var T=null;var L=G.getCell();var H=S.isCloneEvent(G.getEvent())&&S.isCellsCloneable()&&this.isCloneEnabled();if(S.isDropEnabled()&&this.highlightEnabled){T=S.getDropTarget(this.cells,G.getEvent(),L,H)}var F=S.getView().getState(T);var P=false;if(F!=null&&(S.model.getParent(this.cell)!=T||H)){if(this.target!=T){this.target=T;this.setHighlightColor(mxConstants.DROP_TARGET_COLOR)}P=true}else{this.target=null;if(this.connectOnDrop&&L!=null&&this.cells.length==1&&S.getModel().isVertex(L)&&S.isCellConnectable(L)){F=S.getView().getState(L);if(F!=null){var O=S.getEdgeValidationError(null,this.cell,L);var B=(O==null)?mxConstants.VALID_COLOR:mxConstants.INVALID_CONNECT_TARGET_COLOR;this.setHighlightColor(B);P=true}}}if(F!=null&&P){this.highlight.highlight(F)}else{this.highlight.hide()}}this.updateHint(G);this.consumeMouseEvent(mxEvent.MOUSE_MOVE,G);mxEvent.consume(G.getEvent())}else{if((this.isMoveEnabled()||this.isCloneEnabled())&&this.updateCursor&&!G.isConsumed()&&G.getState()!=null&&!S.isMouseDown){var D=S.getCursorForMouseEvent(G);if(D==null&&S.isEnabled()&&S.isCellMovable(G.getCell())){if(S.getModel().isEdge(G.getCell())){D=mxConstants.CURSOR_MOVABLE_EDGE}else{D=mxConstants.CURSOR_MOVABLE_VERTEX}}if(G.sourceState!=null){G.sourceState.setCursor(D)}}}};mxGraphHandler.prototype.updatePreviewShape=function(){if(this.shape!=null){this.shape.bounds=new mxRectangle(Math.round(this.pBounds.x+this.currentDx-this.graph.panDx),Math.round(this.pBounds.y+this.currentDy-this.graph.panDy),this.pBounds.width,this.pBounds.height);this.shape.redraw()}};mxGraphHandler.prototype.setHighlightColor=function(A){if(this.highlight!=null){this.highlight.setHighlightColor(A)}};mxGraphHandler.prototype.mouseUp=function(D,H){if(!H.isConsumed()){var B=this.graph;if(this.cell!=null&&this.first!=null&&this.shape!=null&&this.currentDx!=null&&this.currentDy!=null){var I=H.getCell();if(this.connectOnDrop&&this.target==null&&I!=null&&B.getModel().isVertex(I)&&B.isCellConnectable(I)&&B.isEdgeValid(null,this.cell,I)){B.connectionHandler.connect(this.cell,I,H.getEvent())}else{var A=B.isCloneEvent(H.getEvent())&&B.isCellsCloneable()&&this.isCloneEnabled();var C=B.getView().scale;var F=this.roundLength(this.currentDx/C);var G=this.roundLength(this.currentDy/C);var E=this.target;if(B.isSplitEnabled()&&B.isSplitTarget(E,this.cells,H.getEvent())){B.splitEdge(E,this.cells,null,F,G)}else{this.moveCells(this.cells,F,G,A,this.target,H.getEvent())}}}else{if(this.isSelectEnabled()&&this.delayedSelection&&this.cell!=null){this.selectDelayed(H)}}}if(this.cellWasClicked){this.consumeMouseEvent(mxEvent.MOUSE_UP,H)}this.reset()};mxGraphHandler.prototype.selectDelayed=function(A){if(!this.graph.isCellSelected(this.cell)||!this.graph.popupMenuHandler.isPopupTrigger(A)){this.graph.selectCellForEvent(this.cell,A.getEvent())}};mxGraphHandler.prototype.reset=function(){this.destroyShapes();this.removeHint();this.cellWasClicked=false;this.delayedSelection=false;this.currentDx=null;this.currentDy=null;this.guides=null;this.first=null;this.cell=null;this.target=null};mxGraphHandler.prototype.shouldRemoveCellsFromParent=function(I,H,B){if(this.graph.getModel().isVertex(I)){var C=this.graph.getView().getState(I);if(C!=null){var A=mxUtils.convertPoint(this.graph.container,mxEvent.getClientX(B),mxEvent.getClientY(B));var F=mxUtils.toRadians(mxUtils.getValue(C.style,mxConstants.STYLE_ROTATION)||0);if(F!=0){var G=Math.cos(-F);var E=Math.sin(-F);var D=new mxPoint(C.getCenterX(),C.getCenterY());A=mxUtils.getRotatedPoint(A,G,E,D)}return !mxUtils.contains(C,A.x,A.y)}}return false};mxGraphHandler.prototype.moveCells=function(E,D,B,C,F,A){if(C){E=this.graph.getCloneableCells(E)}if(F==null&&this.isRemoveCellsFromParent()&&this.shouldRemoveCellsFromParent(this.graph.getModel().getParent(this.cell),E,A)){F=this.graph.getDefaultParent()}E=this.graph.moveCells(E,D-this.graph.panDx/this.graph.view.scale,B-this.graph.panDy/this.graph.view.scale,C,F,A);if(this.isSelectEnabled()&&this.scrollOnMove){this.graph.scrollCellToVisible(E[0])}if(C){this.graph.setSelectionCells(E)}};mxGraphHandler.prototype.destroyShapes=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.guide!=null){this.guide.destroy();this.guide=null}if(this.highlight!=null){this.highlight.destroy();this.highlight=null}};mxGraphHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.panHandler);if(this.escapeHandler!=null){this.graph.removeListener(this.escapeHandler);this.escapeHandler=null}this.destroyShapes();this.removeHint()};function mxPanningHandler(A){if(A!=null){this.graph=A;this.graph.addMouseListener(this);this.forcePanningHandler=mxUtils.bind(this,function(B,C){var E=C.getProperty("eventName");var D=C.getProperty("event");if(E==mxEvent.MOUSE_DOWN&&this.isForcePanningEvent(D)){this.start(D);this.active=true;this.fireEvent(new mxEventObject(mxEvent.PAN_START,"event",D));D.consume()}});this.graph.addListener(mxEvent.FIRE_MOUSE_EVENT,this.forcePanningHandler);this.gestureHandler=mxUtils.bind(this,function(B,E){if(this.isPinchEnabled()){var C=E.getProperty("event");if(!mxEvent.isConsumed(C)&&C.type=="gesturestart"){this.initialScale=this.graph.view.scale;if(!this.active&&this.mouseDownEvent!=null){this.start(this.mouseDownEvent);this.mouseDownEvent=null}}else{if(C.type=="gestureend"&&this.initialScale==null){this.initialScale=null}}if(this.initialScale!=null){var D=Math.round(this.initialScale*C.scale*100)/100;if(this.minScale!=null){D=Math.max(this.minScale,D)}if(this.maxScale!=null){D=Math.min(this.maxScale,D)}if(this.graph.view.scale!=D){this.graph.zoomTo(D);mxEvent.consume(C)}}}});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler)}}mxPanningHandler.prototype=new mxEventSource();mxPanningHandler.prototype.constructor=mxPanningHandler;mxPanningHandler.prototype.graph=null;mxPanningHandler.prototype.useLeftButtonForPanning=false;mxPanningHandler.prototype.usePopupTrigger=true;mxPanningHandler.prototype.ignoreCell=false;mxPanningHandler.prototype.previewEnabled=true;mxPanningHandler.prototype.useGrid=false;mxPanningHandler.prototype.panningEnabled=true;mxPanningHandler.prototype.pinchEnabled=true;mxPanningHandler.prototype.maxScale=8;mxPanningHandler.prototype.minScale=0.01;mxPanningHandler.prototype.dx=null;mxPanningHandler.prototype.dy=null;mxPanningHandler.prototype.startX=0;mxPanningHandler.prototype.startY=0;mxPanningHandler.prototype.isActive=function(){return this.active||this.initialScale!=null};mxPanningHandler.prototype.isPanningEnabled=function(){return this.panningEnabled};mxPanningHandler.prototype.setPanningEnabled=function(A){this.panningEnabled=A};mxPanningHandler.prototype.isPinchEnabled=function(){return this.pinchEnabled};mxPanningHandler.prototype.setPinchEnabled=function(A){this.pinchEnabled=A};mxPanningHandler.prototype.isPanningTrigger=function(B){var A=B.getEvent();return(this.useLeftButtonForPanning&&B.getState()==null&&mxEvent.isLeftMouseButton(A))||(mxEvent.isControlDown(A)&&mxEvent.isShiftDown(A))||(this.usePopupTrigger&&mxEvent.isPopupTrigger(A))};mxPanningHandler.prototype.isForcePanningEvent=function(A){return this.ignoreCell||mxEvent.isMultiTouchEvent(A.getEvent())};mxPanningHandler.prototype.mouseDown=function(A,B){this.mouseDownEvent=B;if(!B.isConsumed()&&this.isPanningEnabled()&&!this.active&&this.isPanningTrigger(B)){this.start(B);this.consumePanningTrigger(B)}};mxPanningHandler.prototype.start=function(A){this.dx0=-this.graph.container.scrollLeft;this.dy0=-this.graph.container.scrollTop;this.startX=A.getX();this.startY=A.getY();this.dx=null;this.dy=null;this.panningTrigger=true};mxPanningHandler.prototype.consumePanningTrigger=function(A){A.consume()};mxPanningHandler.prototype.mouseMove=function(B,C){this.dx=C.getX()-this.startX;this.dy=C.getY()-this.startY;if(this.active){if(this.previewEnabled){if(this.useGrid){this.dx=this.graph.snap(this.dx);this.dy=this.graph.snap(this.dy)}this.graph.panGraph(this.dx+this.dx0,this.dy+this.dy0)}this.fireEvent(new mxEventObject(mxEvent.PAN,"event",C))}else{if(this.panningTrigger){var A=this.active;this.active=Math.abs(this.dx)>this.graph.tolerance||Math.abs(this.dy)>this.graph.tolerance;if(!A&&this.active){this.fireEvent(new mxEventObject(mxEvent.PAN_START,"event",C))}}}if(this.active||this.panningTrigger){C.consume()}};mxPanningHandler.prototype.mouseUp=function(A,B){if(this.active){if(this.dx!=null&&this.dy!=null){if(!this.graph.useScrollbarsForPanning||!mxUtils.hasScrollbars(this.graph.container)){var D=this.graph.getView().scale;var C=this.graph.getView().translate;this.graph.panGraph(0,0);this.panGraph(C.x+this.dx/D,C.y+this.dy/D)}B.consume()}this.fireEvent(new mxEventObject(mxEvent.PAN_END,"event",B))}this.panningTrigger=false;this.mouseDownEvent=null;this.active=false;this.dx=null;this.dy=null};mxPanningHandler.prototype.panGraph=function(A,B){this.graph.getView().setTranslate(A,B)};mxPanningHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.forcePanningHandler);this.graph.removeListener(this.gestureHandler)};function mxPopupMenuHandler(A,B){if(A!=null){this.graph=A;this.factoryMethod=B;this.graph.addMouseListener(this);this.gestureHandler=mxUtils.bind(this,function(C,D){this.inTolerance=false});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler);this.init()}}mxPopupMenuHandler.prototype=new mxPopupMenu();mxPopupMenuHandler.prototype.constructor=mxPopupMenuHandler;mxPopupMenuHandler.prototype.graph=null;mxPopupMenuHandler.prototype.selectOnPopup=true;mxPopupMenuHandler.prototype.clearSelectionOnBackground=true;mxPopupMenuHandler.prototype.triggerX=null;mxPopupMenuHandler.prototype.triggerY=null;mxPopupMenuHandler.prototype.screenX=null;mxPopupMenuHandler.prototype.screenY=null;mxPopupMenuHandler.prototype.init=function(){mxPopupMenu.prototype.init.apply(this);mxEvent.addGestureListeners(this.div,mxUtils.bind(this,function(A){this.graph.tooltipHandler.hide()}))};mxPopupMenuHandler.prototype.isSelectOnPopup=function(A){return this.selectOnPopup};mxPopupMenuHandler.prototype.mouseDown=function(A,B){if(this.isEnabled()&&!mxEvent.isMultiTouchEvent(B.getEvent())){this.hideMenu();this.triggerX=B.getGraphX();this.triggerY=B.getGraphY();this.screenX=mxEvent.getMainEvent(B.getEvent()).screenX;this.screenY=mxEvent.getMainEvent(B.getEvent()).screenY;this.popupTrigger=this.isPopupTrigger(B);this.inTolerance=true}};mxPopupMenuHandler.prototype.mouseMove=function(A,B){if(this.inTolerance&&this.screenX!=null&&this.screenY!=null){if(Math.abs(mxEvent.getMainEvent(B.getEvent()).screenX-this.screenX)>this.graph.tolerance||Math.abs(mxEvent.getMainEvent(B.getEvent()).screenY-this.screenY)>this.graph.tolerance){this.inTolerance=false}}};mxPopupMenuHandler.prototype.mouseUp=function(B,C){if(this.popupTrigger&&this.inTolerance&&this.triggerX!=null&&this.triggerY!=null){var D=this.getCellForPopupEvent(C);if(this.graph.isEnabled()&&this.isSelectOnPopup(C)&&D!=null&&!this.graph.isCellSelected(D)){this.graph.setSelectionCell(D)}else{if(this.clearSelectionOnBackground&&D==null){this.graph.clearSelection()}}this.graph.tooltipHandler.hide();var A=mxUtils.getScrollOrigin();this.popup(C.getX()+A.x+1,C.getY()+A.y+1,D,C.getEvent());C.consume()}this.popupTrigger=false;this.inTolerance=false};mxPopupMenuHandler.prototype.getCellForPopupEvent=function(A){return A.getCell()};mxPopupMenuHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.gestureHandler);mxPopupMenu.prototype.destroy.apply(this)};function mxCellMarker(B,D,C,A){mxEventSource.call(this);if(B!=null){this.graph=B;this.validColor=(D!=null)?D:mxConstants.DEFAULT_VALID_COLOR;this.invalidColor=(D!=null)?C:mxConstants.DEFAULT_INVALID_COLOR;this.hotspot=(A!=null)?A:mxConstants.DEFAULT_HOTSPOT;this.highlight=new mxCellHighlight(B)}}mxUtils.extend(mxCellMarker,mxEventSource);mxCellMarker.prototype.graph=null;mxCellMarker.prototype.enabled=true;mxCellMarker.prototype.hotspot=mxConstants.DEFAULT_HOTSPOT;mxCellMarker.prototype.hotspotEnabled=false;mxCellMarker.prototype.validColor=null;mxCellMarker.prototype.invalidColor=null;mxCellMarker.prototype.currentColor=null;mxCellMarker.prototype.validState=null;mxCellMarker.prototype.markedState=null;mxCellMarker.prototype.setEnabled=function(A){this.enabled=A};mxCellMarker.prototype.isEnabled=function(){return this.enabled};mxCellMarker.prototype.setHotspot=function(A){this.hotspot=A};mxCellMarker.prototype.getHotspot=function(){return this.hotspot};mxCellMarker.prototype.setHotspotEnabled=function(A){this.hotspotEnabled=A};mxCellMarker.prototype.isHotspotEnabled=function(){return this.hotspotEnabled};mxCellMarker.prototype.hasValidState=function(){return this.validState!=null};mxCellMarker.prototype.getValidState=function(){return this.validState};mxCellMarker.prototype.getMarkedState=function(){return this.markedState};mxCellMarker.prototype.reset=function(){this.validState=null;if(this.markedState!=null){this.markedState=null;this.unmark()}};mxCellMarker.prototype.process=function(A){var B=null;if(this.isEnabled()){B=this.getState(A);this.setCurrentState(B,A)}return B};mxCellMarker.prototype.setCurrentState=function(D,B,C){var A=(D!=null)?this.isValidState(D):false;C=(C!=null)?C:this.getMarkerColor(B.getEvent(),D,A);if(A){this.validState=D}else{this.validState=null}if(D!=this.markedState||C!=this.currentColor){this.currentColor=C;if(D!=null&&this.currentColor!=null){this.markedState=D;this.mark()}else{if(this.markedState!=null){this.markedState=null;this.unmark()}}}};mxCellMarker.prototype.markCell=function(A,B){var C=this.graph.getView().getState(A);if(C!=null){this.currentColor=(B!=null)?B:this.validColor;this.markedState=C;this.mark()}};mxCellMarker.prototype.mark=function(){this.highlight.setHighlightColor(this.currentColor);this.highlight.highlight(this.markedState);this.fireEvent(new mxEventObject(mxEvent.MARK,"state",this.markedState))};mxCellMarker.prototype.unmark=function(){this.mark()};mxCellMarker.prototype.isValidState=function(A){return true};mxCellMarker.prototype.getMarkerColor=function(A,C,B){return(B)?this.validColor:this.invalidColor};mxCellMarker.prototype.getState=function(A){var B=this.graph.getView();cell=this.getCell(A);var C=this.getStateToMark(B.getState(cell));return(C!=null&&this.intersects(C,A))?C:null};mxCellMarker.prototype.getCell=function(A){return A.getCell()};mxCellMarker.prototype.getStateToMark=function(A){return A};mxCellMarker.prototype.intersects=function(B,A){if(this.hotspotEnabled){return mxUtils.intersectsHotspot(B,A.getGraphX(),A.getGraphY(),this.hotspot,mxConstants.MIN_HOTSPOT_SIZE,mxConstants.MAX_HOTSPOT_SIZE)}return true};mxCellMarker.prototype.destroy=function(){this.graph.getView().removeListener(this.resetHandler);this.graph.getModel().removeListener(this.resetHandler);this.highlight.destroy()};function mxSelectionCellsHandler(A){mxEventSource.call(this);this.graph=A;this.handlers=new mxDictionary();this.graph.addMouseListener(this);this.refreshHandler=mxUtils.bind(this,function(B,C){if(this.isEnabled()){this.refresh()}});this.graph.getSelectionModel().addListener(mxEvent.CHANGE,this.refreshHandler);this.graph.getModel().addListener(mxEvent.CHANGE,this.refreshHandler);this.graph.getView().addListener(mxEvent.SCALE,this.refreshHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.refreshHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.refreshHandler);this.graph.getView().addListener(mxEvent.DOWN,this.refreshHandler);this.graph.getView().addListener(mxEvent.UP,this.refreshHandler)}mxUtils.extend(mxSelectionCellsHandler,mxEventSource);mxSelectionCellsHandler.prototype.graph=null;mxSelectionCellsHandler.prototype.enabled=true;mxSelectionCellsHandler.prototype.refreshHandler=null;mxSelectionCellsHandler.prototype.maxHandlers=100;mxSelectionCellsHandler.prototype.handlers=null;mxSelectionCellsHandler.prototype.isEnabled=function(){return this.enabled};mxSelectionCellsHandler.prototype.setEnabled=function(A){this.enabled=A};mxSelectionCellsHandler.prototype.getHandler=function(A){return this.handlers.get(A)};mxSelectionCellsHandler.prototype.reset=function(){this.handlers.visit(function(A,B){B.reset.apply(B)})};mxSelectionCellsHandler.prototype.refresh=function(){var E=this.handlers;this.handlers=new mxDictionary();var A=this.graph.getSelectionCells();for(var B=0;B<A.length;B++){var D=this.graph.view.getState(A[B]);if(D!=null){var C=E.remove(A[B]);if(C!=null){if(C.state!=D){C.destroy();C=null}else{if(C.refresh!=null){C.refresh()}C.redraw()}}if(C==null){C=this.graph.createHandler(D);this.fireEvent(new mxEventObject(mxEvent.ADD,"state",D))}if(C!=null){this.handlers.put(A[B],C)}}}E.visit(mxUtils.bind(this,function(F,G){this.fireEvent(new mxEventObject(mxEvent.REMOVE,"state",G.state));G.destroy()}))};mxSelectionCellsHandler.prototype.updateHandler=function(B){var A=this.handlers.remove(B.cell);if(A!=null){A.destroy();A=this.graph.createHandler(B);if(A!=null){this.handlers.put(B.cell,A)}}};mxSelectionCellsHandler.prototype.mouseDown=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseDown.apply(E,C)})}};mxSelectionCellsHandler.prototype.mouseMove=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseMove.apply(E,C)})}};mxSelectionCellsHandler.prototype.mouseUp=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseUp.apply(E,C)})}};mxSelectionCellsHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);if(this.refreshHandler!=null){this.graph.getSelectionModel().removeListener(this.refreshHandler);this.graph.getModel().removeListener(this.refreshHandler);this.graph.getView().removeListener(this.refreshHandler);this.refreshHandler=null}};function mxConnectionHandler(A,B){mxEventSource.call(this);if(A!=null){this.graph=A;this.factoryMethod=B;this.init();this.escapeHandler=mxUtils.bind(this,function(C,D){this.reset()});this.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxUtils.extend(mxConnectionHandler,mxEventSource);mxConnectionHandler.prototype.graph=null;mxConnectionHandler.prototype.factoryMethod=true;mxConnectionHandler.prototype.moveIconFront=false;mxConnectionHandler.prototype.moveIconBack=false;mxConnectionHandler.prototype.connectImage=null;mxConnectionHandler.prototype.targetConnectImage=false;mxConnectionHandler.prototype.enabled=true;mxConnectionHandler.prototype.select=true;mxConnectionHandler.prototype.createTarget=false;mxConnectionHandler.prototype.marker=null;mxConnectionHandler.prototype.constraintHandler=null;mxConnectionHandler.prototype.error=null;mxConnectionHandler.prototype.waypointsEnabled=false;mxConnectionHandler.prototype.ignoreMouseDown=false;mxConnectionHandler.prototype.first=null;mxConnectionHandler.prototype.connectIconOffset=new mxPoint(0,mxConstants.TOOLTIP_VERTICAL_OFFSET);mxConnectionHandler.prototype.edgeState=null;mxConnectionHandler.prototype.changeHandler=null;mxConnectionHandler.prototype.drillHandler=null;mxConnectionHandler.prototype.mouseDownCounter=0;mxConnectionHandler.prototype.movePreviewAway=mxClient.IS_VML;mxConnectionHandler.prototype.outlineConnect=false;mxConnectionHandler.prototype.livePreview=false;mxConnectionHandler.prototype.cursor=null;mxConnectionHandler.prototype.insertBeforeSource=false;mxConnectionHandler.prototype.isEnabled=function(){return this.enabled};mxConnectionHandler.prototype.setEnabled=function(A){this.enabled=A};mxConnectionHandler.prototype.isInsertBefore=function(C,B,E,A,D){return this.insertBeforeSource&&B!=E};mxConnectionHandler.prototype.isCreateTarget=function(A){return this.createTarget};mxConnectionHandler.prototype.setCreateTarget=function(A){this.createTarget=A};mxConnectionHandler.prototype.createShape=function(){var A=(this.livePreview&&this.edgeState!=null)?this.graph.cellRenderer.createShape(this.edgeState):new mxPolyline([],mxConstants.INVALID_COLOR);A.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;A.scale=this.graph.view.scale;A.pointerEvents=false;A.isDashed=true;A.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(A.node,this.graph,null);return A};mxConnectionHandler.prototype.init=function(){this.graph.addMouseListener(this);this.marker=this.createMarker();this.constraintHandler=new mxConstraintHandler(this.graph);this.changeHandler=mxUtils.bind(this,function(A){if(this.iconState!=null){this.iconState=this.graph.getView().getState(this.iconState.cell)}if(this.iconState!=null){this.redrawIcons(this.icons,this.iconState);this.constraintHandler.reset()}else{if(this.previous!=null&&this.graph.view.getState(this.previous.cell)==null){this.reset()}}});this.graph.getModel().addListener(mxEvent.CHANGE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE,this.changeHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.changeHandler);this.drillHandler=mxUtils.bind(this,function(A){this.reset()});this.graph.addListener(mxEvent.START_EDITING,this.drillHandler);this.graph.getView().addListener(mxEvent.DOWN,this.drillHandler);this.graph.getView().addListener(mxEvent.UP,this.drillHandler)};mxConnectionHandler.prototype.isConnectableCell=function(A){return true};mxConnectionHandler.prototype.createMarker=function(){var A=new mxCellMarker(this.graph);A.hotspotEnabled=true;A.getCell=mxUtils.bind(this,function(B){var C=mxCellMarker.prototype.getCell.apply(A,arguments);this.error=null;if(C==null&&this.currentPoint!=null){C=this.graph.getCellAt(this.currentPoint.x,this.currentPoint.y)}if(C!=null&&!this.graph.isCellConnectable(C)){var D=this.graph.getModel().getParent(C);if(this.graph.getModel().isVertex(D)&&this.graph.isCellConnectable(D)){C=D}}if((this.graph.isSwimlane(C)&&this.currentPoint!=null&&this.graph.hitsSwimlaneContent(C,this.currentPoint.x,this.currentPoint.y))||!this.isConnectableCell(C)){C=null}if(C!=null){if(this.isConnecting()){if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,C);if(this.error!=null&&this.error.length==0){C=null;if(this.isCreateTarget(B.getEvent())){this.error=null}}}}else{if(!this.isValidSource(C,B)){C=null}}}else{if(this.isConnecting()&&!this.isCreateTarget(B.getEvent())&&!this.graph.allowDanglingEdges){this.error=""}}return C});A.isValidState=mxUtils.bind(this,function(B){if(this.isConnecting()){return this.error==null}else{return mxCellMarker.prototype.isValidState.apply(A,arguments)}});A.getMarkerColor=mxUtils.bind(this,function(B,D,C){return(this.connectImage==null||this.isConnecting())?mxCellMarker.prototype.getMarkerColor.apply(A,arguments):null});A.intersects=mxUtils.bind(this,function(C,B){if(this.connectImage!=null||this.isConnecting()){return true}return mxCellMarker.prototype.intersects.apply(A,arguments)});return A};mxConnectionHandler.prototype.start=function(D,A,B,C){this.previous=D;this.first=new mxPoint(A,B);this.edgeState=(C!=null)?C:this.createEdgeState(null);this.marker.currentColor=this.marker.validColor;this.marker.markedState=D;this.marker.mark();this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous))};mxConnectionHandler.prototype.isConnecting=function(){return this.first!=null&&this.shape!=null};mxConnectionHandler.prototype.isValidSource=function(B,A){return this.graph.isValidSource(B)};mxConnectionHandler.prototype.isValidTarget=function(A){return true};mxConnectionHandler.prototype.validateConnection=function(A,B){if(!this.isValidTarget(B)){return""}return this.graph.getEdgeValidationError(null,A,B)};mxConnectionHandler.prototype.getConnectImage=function(A){return this.connectImage};mxConnectionHandler.prototype.isMoveIconToFrontForState=function(A){if(A.text!=null&&A.text.node.parentNode==this.graph.container){return true}return this.moveIconFront};mxConnectionHandler.prototype.createIcons=function(G){var C=this.getConnectImage(G);if(C!=null&&G!=null){this.iconState=G;var A=[];var B=new mxRectangle(0,0,C.width,C.height);var E=new mxImageShape(B,C.src,null,null,0);E.preserveImageAspect=false;if(this.isMoveIconToFrontForState(G)){E.dialect=mxConstants.DIALECT_STRICTHTML;E.init(this.graph.container)}else{E.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;E.init(this.graph.getView().getOverlayPane());if(this.moveIconBack&&E.node.previousSibling!=null){E.node.parentNode.insertBefore(E.node,E.node.parentNode.firstChild)}}E.node.style.cursor=mxConstants.CURSOR_CONNECT;var F=mxUtils.bind(this,function(){return(this.currentState!=null)?this.currentState:G});var D=mxUtils.bind(this,function(H){if(!mxEvent.isConsumed(H)){this.icon=E;this.graph.fireMouseEvent(mxEvent.MOUSE_DOWN,new mxMouseEvent(H,F()))}});mxEvent.redirectMouseEvents(E.node,this.graph,F,D);A.push(E);this.redrawIcons(A,this.iconState);return A}return null};mxConnectionHandler.prototype.redrawIcons=function(A,C){if(A!=null&&A[0]!=null&&C!=null){var B=this.getIconPosition(A[0],C);A[0].bounds.x=B.x;A[0].bounds.y=B.y;A[0].redraw()}};mxConnectionHandler.prototype.getIconPosition=function(J,I){var C=this.graph.getView().scale;var F=I.getCenterX();var G=I.getCenterY();if(this.graph.isSwimlane(I.cell)){var B=this.graph.getStartSize(I.cell);F=(B.width!=0)?I.x+B.width*C/2:F;G=(B.height!=0)?I.y+B.height*C/2:G;var H=mxUtils.toRadians(mxUtils.getValue(I.style,mxConstants.STYLE_ROTATION)||0);if(H!=0){var E=Math.cos(H);var D=Math.sin(H);var K=new mxPoint(I.getCenterX(),I.getCenterY());var A=mxUtils.getRotatedPoint(new mxPoint(F,G),E,D,K);F=A.x;G=A.y}}return new mxPoint(F-J.bounds.width/2,G-J.bounds.height/2)};mxConnectionHandler.prototype.destroyIcons=function(){if(this.icons!=null){for(var A=0;A<this.icons.length;A++){this.icons[A].destroy()}this.icons=null;this.icon=null;this.selectedIcon=null;this.iconState=null}};mxConnectionHandler.prototype.isStartEvent=function(A){return((this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null)||(this.previous!=null&&this.error==null&&(this.icons==null||(this.icons!=null&&this.icon!=null))))};mxConnectionHandler.prototype.mouseDown=function(A,C){this.mouseDownCounter++;if(this.isEnabled()&&this.graph.isEnabled()&&!C.isConsumed()&&!this.isConnecting()&&this.isStartEvent(C)){if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){this.sourceConstraint=this.constraintHandler.currentConstraint;this.previous=this.constraintHandler.currentFocus;this.first=this.constraintHandler.currentPoint.clone()}else{this.first=new mxPoint(C.getGraphX(),C.getGraphY())}this.edgeState=this.createEdgeState(C);this.mouseDownCounter=1;if(this.waypointsEnabled&&this.shape==null){this.waypoints=null;this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}}if(this.previous==null&&this.edgeState!=null){var B=this.graph.getPointForEvent(C.getEvent());this.edgeState.cell.geometry.setTerminalPoint(B,true)}this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous));C.consume()}this.selectedIcon=this.icon;this.icon=null};mxConnectionHandler.prototype.isImmediateConnectSource=function(A){return !this.graph.isCellMovable(A.cell)};mxConnectionHandler.prototype.createEdgeState=function(A){return null};mxConnectionHandler.prototype.isOutlineConnectEvent=function(H){var B=mxUtils.getOffset(this.graph.container);var A=H.getEvent();var E=mxEvent.getClientX(A);var F=mxEvent.getClientY(A);var G=document.documentElement;var D=(window.pageXOffset||G.scrollLeft)-(G.clientLeft||0);var C=(window.pageYOffset||G.scrollTop)-(G.clientTop||0);var I=this.currentPoint.x-this.graph.container.scrollLeft+B.x-D;var J=this.currentPoint.y-this.graph.container.scrollTop+B.y-C;return this.outlineConnect&&!mxEvent.isShiftDown(H.getEvent())&&(H.isSource(this.marker.highlight.shape)||(mxEvent.isAltDown(H.getEvent())&&H.getState()!=null)||this.marker.highlight.isHighlightAt(E,F)||((I!=E||J!=F)&&H.getState()==null&&this.marker.highlight.isHighlightAt(I,J)))};mxConnectionHandler.prototype.updateCurrentState=function(C,B){this.constraintHandler.update(C,this.first==null,false,(this.first==null||C.isSource(this.marker.highlight.shape))?null:B);if(this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null){if(this.marker.highlight!=null&&this.marker.highlight.state!=null&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell){if(this.marker.highlight.shape.stroke!="transparent"){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint()}}else{this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent")}if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,this.constraintHandler.currentFocus.cell);if(this.error==null){this.currentState=this.constraintHandler.currentFocus}else{this.constraintHandler.reset()}}}else{if(this.graph.isIgnoreTerminalEvent(C.getEvent())){this.marker.reset();this.currentState=null}else{this.marker.process(C);this.currentState=this.marker.getValidState()}var D=this.isOutlineConnectEvent(C);if(this.currentState!=null&&D){if(C.isSource(this.marker.highlight.shape)){B=new mxPoint(C.getGraphX(),C.getGraphY())}var E=this.graph.getOutlineConstraint(B,this.currentState,C);this.constraintHandler.setFocus(C,this.currentState,false);this.constraintHandler.currentConstraint=E;this.constraintHandler.currentPoint=B}if(this.outlineConnect){if(this.marker.highlight!=null&&this.marker.highlight.shape!=null){var A=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){this.marker.highlight.shape.stroke=mxConstants.OUTLINE_HIGHLIGHT_COLOR;this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/A/A;this.marker.highlight.repaint()}else{if(this.marker.hasValidState()){if(this.marker.getValidState()!=C.getState()){this.marker.highlight.shape.stroke="transparent";this.currentState=null}else{this.marker.highlight.shape.stroke=mxConstants.DEFAULT_VALID_COLOR}this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/A/A;this.marker.highlight.repaint()}}}}}};mxConnectionHandler.prototype.convertWaypoint=function(A){var C=this.graph.getView().getScale();var B=this.graph.getView().getTranslate();A.x=A.x/C-B.x;A.y=A.y/C-B.y};mxConnectionHandler.prototype.snapToPreview=function(C,B){if(!mxEvent.isAltDown(C.getEvent())&&this.previous!=null){var D=this.graph.gridSize*this.graph.view.scale/2;var A=(this.sourceConstraint!=null)?this.first:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());if(Math.abs(A.x-C.getGraphX())<D){B.x=A.x}if(Math.abs(A.y-C.getGraphY())<D){B.y=A.y}}};mxConnectionHandler.prototype.mouseMove=function(Q,H){if(!H.isConsumed()&&(this.ignoreMouseDown||this.first!=null||!this.graph.isMouseDown)){if(!this.isEnabled()&&this.currentState!=null){this.destroyIcons();this.currentState=null}var J=this.graph.getView();var N=J.scale;var P=J.translate;var C=new mxPoint(H.getGraphX(),H.getGraphY());this.error=null;if(this.graph.isGridEnabledEvent(H.getEvent())){C=new mxPoint((this.graph.snap(C.x/N-P.x)+P.x)*N,(this.graph.snap(C.y/N-P.y)+P.y)*N)}this.snapToPreview(H,C);this.currentPoint=C;if(this.first!=null||(this.isEnabled()&&this.graph.isEnabled())){this.updateCurrentState(H,C)}if(this.first!=null){var L=null;var I=C;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){L=this.constraintHandler.currentConstraint;I=this.constraintHandler.currentPoint.clone()}else{if(this.previous!=null&&!this.graph.isIgnoreTerminalEvent(H.getEvent())&&mxEvent.isShiftDown(H.getEvent())){if(Math.abs(this.previous.getCenterX()-C.x)<Math.abs(this.previous.getCenterY()-C.y)){C.x=this.previous.getCenterX()}else{C.y=this.previous.getCenterY()}}}var M=this.first;if(this.selectedIcon!=null){var W=this.selectedIcon.bounds.width;var F=this.selectedIcon.bounds.height;if(this.currentState!=null&&this.targetConnectImage){var V=this.getIconPosition(this.selectedIcon,this.currentState);this.selectedIcon.bounds.x=V.x;this.selectedIcon.bounds.y=V.y}else{var E=new mxRectangle(H.getGraphX()+this.connectIconOffset.x,H.getGraphY()+this.connectIconOffset.y,W,F);this.selectedIcon.bounds=E}this.selectedIcon.redraw()}if(this.edgeState!=null){this.updateEdgeState(I,L);I=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-1];M=this.edgeState.absolutePoints[0]}else{if(this.currentState!=null){if(this.constraintHandler.currentConstraint==null){var D=this.getTargetPerimeterPoint(this.currentState,H);if(D!=null){I=D}}}if(this.sourceConstraint==null&&this.previous!=null){var O=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[0]:I;var D=this.getSourcePerimeterPoint(this.previous,O,H);if(D!=null){M=D}}}if(this.currentState==null&&this.movePreviewAway){var D=M;if(this.edgeState!=null&&this.edgeState.absolutePoints.length>=2){var R=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-2];if(R!=null){D=R}}var K=I.x-D.x;var S=I.y-D.y;var B=Math.sqrt(K*K+S*S);if(B==0){return}this.originalPoint=I.clone();I.x-=K*4/B;I.y-=S*4/B}else{this.originalPoint=null}if(this.shape==null){var K=Math.abs(C.x-this.first.x);var S=Math.abs(C.y-this.first.y);if(K>this.graph.tolerance||S>this.graph.tolerance){this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}this.updateCurrentState(H,C)}}if(this.shape!=null){if(this.edgeState!=null){this.shape.points=this.edgeState.absolutePoints}else{var A=[M];if(this.waypoints!=null){A=A.concat(this.waypoints)}A.push(I);this.shape.points=A}this.drawPreview()}if(this.cursor!=null){this.graph.container.style.cursor=this.cursor}mxEvent.consume(H.getEvent());H.consume()}else{if(!this.isEnabled()||!this.graph.isEnabled()){this.constraintHandler.reset()}else{if(this.previous!=this.currentState&&this.edgeState==null){this.destroyIcons();if(this.currentState!=null&&this.error==null&&this.constraintHandler.currentConstraint==null){this.icons=this.createIcons(this.currentState);if(this.icons==null){this.currentState.setCursor(mxConstants.CURSOR_CONNECT);H.consume()}}this.previous=this.currentState}else{if(this.previous==this.currentState&&this.currentState!=null&&this.icons==null&&!this.graph.isMouseDown){H.consume()}}}}if(!this.graph.isMouseDown&&this.currentState!=null&&this.icons!=null){var U=false;var T=H.getSource();for(var G=0;G<this.icons.length&&!U;G++){U=T==this.icons[G].node||T.parentNode==this.icons[G].node}if(!U){this.updateIcons(this.currentState,this.icons,H)}}}else{this.constraintHandler.reset()}};mxConnectionHandler.prototype.updateEdgeState=function(C,D){if(this.sourceConstraint!=null&&this.sourceConstraint.point!=null){this.edgeState.style[mxConstants.STYLE_EXIT_X]=this.sourceConstraint.point.x;this.edgeState.style[mxConstants.STYLE_EXIT_Y]=this.sourceConstraint.point.y}if(D!=null&&D.point!=null){this.edgeState.style[mxConstants.STYLE_ENTRY_X]=D.point.x;this.edgeState.style[mxConstants.STYLE_ENTRY_Y]=D.point.y}else{delete this.edgeState.style[mxConstants.STYLE_ENTRY_X];delete this.edgeState.style[mxConstants.STYLE_ENTRY_Y]}this.edgeState.absolutePoints=[null,(this.currentState!=null)?null:C];this.graph.view.updateFixedTerminalPoint(this.edgeState,this.previous,true,this.sourceConstraint);if(this.currentState!=null){if(D==null){D=this.graph.getConnectionConstraint(this.edgeState,this.previous,false)}this.edgeState.setAbsoluteTerminalPoint(null,false);this.graph.view.updateFixedTerminalPoint(this.edgeState,this.currentState,false,D)}var E=null;if(this.waypoints!=null){E=[];for(var A=0;A<this.waypoints.length;A++){var B=this.waypoints[A].clone();this.convertWaypoint(B);E[A]=B}}this.graph.view.updatePoints(this.edgeState,E,this.previous,this.currentState);this.graph.view.updateFloatingTerminalPoints(this.edgeState,this.previous,this.currentState)};mxConnectionHandler.prototype.getTargetPerimeterPoint=function(G,D){var B=null;var F=G.view;var E=F.getPerimeterFunction(G);if(E!=null){var C=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[this.waypoints.length-1]:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());var A=E(F.getPerimeterBounds(G),this.edgeState,C,false);if(A!=null){B=A}}else{B=new mxPoint(G.getCenterX(),G.getCenterY())}return B};mxConnectionHandler.prototype.getSourcePerimeterPoint=function(G,J,H){var B=null;var A=G.view;var F=A.getPerimeterFunction(G);var I=new mxPoint(G.getCenterX(),G.getCenterY());if(F!=null){var E=mxUtils.getValue(G.style,mxConstants.STYLE_ROTATION,0);var D=-E*(Math.PI/180);if(E!=0){J=mxUtils.getRotatedPoint(new mxPoint(J.x,J.y),Math.cos(D),Math.sin(D),I)}var C=F(A.getPerimeterBounds(G),G,J,false);if(C!=null){if(E!=0){C=mxUtils.getRotatedPoint(new mxPoint(C.x,C.y),Math.cos(-D),Math.sin(-D),I)}B=C}}else{B=I}return B};mxConnectionHandler.prototype.updateIcons=function(C,A,B){};mxConnectionHandler.prototype.isStopEvent=function(A){return A.getState()!=null};mxConnectionHandler.prototype.addWaypointForEvent=function(C){var A=mxUtils.convertPoint(this.graph.container,C.getX(),C.getY());var B=Math.abs(A.x-this.first.x);var D=Math.abs(A.y-this.first.y);var E=this.waypoints!=null||(this.mouseDownCounter>1&&(B>this.graph.tolerance||D>this.graph.tolerance));if(E){if(this.waypoints==null){this.waypoints=[]}var F=this.graph.view.scale;var A=new mxPoint(this.graph.snap(C.getGraphX()/F)*F,this.graph.snap(C.getGraphY()/F)*F);this.waypoints.push(A)}};mxConnectionHandler.prototype.mouseUp=function(A,C){if(!C.isConsumed()&&this.isConnecting()){if(this.waypointsEnabled&&!this.isStopEvent(C)){this.addWaypointForEvent(C);C.consume();return}if(this.error==null){var B=(this.previous!=null)?this.previous.cell:null;var D=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){D=this.constraintHandler.currentFocus.cell}if(D==null&&this.currentState!=null){D=this.currentState.cell}this.connect(B,D,C.getEvent(),C.getCell())}else{if(this.previous!=null&&this.marker.validState!=null&&this.previous.cell==this.marker.validState.cell){this.graph.selectCellForEvent(this.marker.source,evt)}if(this.error.length>0){this.graph.validationAlert(this.error)}}this.destroyIcons();C.consume()}if(this.first!=null){this.reset()}};mxConnectionHandler.prototype.reset=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.cursor!=null&&this.graph.container!=null){this.graph.container.style.cursor=""}this.destroyIcons();this.marker.reset();this.constraintHandler.reset();this.originalPoint=null;this.currentPoint=null;this.edgeState=null;this.previous=null;this.error=null;this.sourceConstraint=null;this.mouseDownCounter=0;this.first=null;this.fireEvent(new mxEventObject(mxEvent.RESET))};mxConnectionHandler.prototype.drawPreview=function(){this.updatePreview(this.error==null);this.shape.redraw()};mxConnectionHandler.prototype.updatePreview=function(A){this.shape.strokewidth=this.getEdgeWidth(A);this.shape.stroke=this.getEdgeColor(A)};mxConnectionHandler.prototype.getEdgeColor=function(A){return(A)?mxConstants.VALID_COLOR:mxConstants.INVALID_COLOR};mxConnectionHandler.prototype.getEdgeWidth=function(A){return(A)?3:1};mxConnectionHandler.prototype.connect=function(L,R,I,J){if(R!=null||this.isCreateTarget(I)||this.graph.allowDanglingEdges){var F=this.graph.getModel();var H=false;var A=null;F.beginUpdate();try{if(L!=null&&R==null&&!this.graph.isIgnoreTerminalEvent(I)&&this.isCreateTarget(I)){R=this.createTargetVertex(I,L);if(R!=null){J=this.graph.getDropTarget([R],I,J);H=true;if(J==null||!this.graph.getModel().isEdge(J)){var P=this.graph.getView().getState(J);if(P!=null){var C=F.getGeometry(R);C.x-=P.origin.x;C.y-=P.origin.y}}else{J=this.graph.getDefaultParent()}this.graph.addCell(R,J)}}var O=this.graph.getDefaultParent();if(L!=null&&R!=null&&F.getParent(L)==F.getParent(R)&&F.getParent(F.getParent(L))!=F.getRoot()){O=F.getParent(L);if((L.geometry!=null&&L.geometry.relative)&&(R.geometry!=null&&R.geometry.relative)){O=F.getParent(O)}}var S=null;var T=null;if(this.edgeState!=null){S=this.edgeState.cell.value;T=this.edgeState.cell.style}A=this.insertEdge(O,null,S,L,R,T);if(A!=null){this.graph.setConnectionConstraint(A,L,true,this.sourceConstraint);this.graph.setConnectionConstraint(A,R,false,this.constraintHandler.currentConstraint);if(this.edgeState!=null){F.setGeometry(A,this.edgeState.cell.geometry)}var O=F.getParent(L);if(this.isInsertBefore(A,L,R,I,J)){var E=null;var C=L;while(C.parent!=null&&C.geometry!=null&&C.geometry.relative&&C.parent!=A.parent){C=this.graph.model.getParent(C)}if(C!=null&&C.parent!=null&&C.parent==A.parent){var E=C.parent.getIndex(C);C.parent.insert(A,E)}}var M=F.getGeometry(A);if(M==null){M=new mxGeometry();M.relative=true;F.setGeometry(A,M)}if(this.waypoints!=null&&this.waypoints.length>0){var B=this.graph.view.scale;var N=this.graph.view.translate;M.points=[];for(var G=0;G<this.waypoints.length;G++){var Q=this.waypoints[G];M.points.push(new mxPoint(Q.x/B-N.x,Q.y/B-N.y))}}if(R==null){var D=this.graph.view.translate;var B=this.graph.view.scale;var Q=(this.originalPoint!=null)?new mxPoint(this.originalPoint.x/B-D.x,this.originalPoint.y/B-D.y):new mxPoint(this.currentPoint.x/B-D.x,this.currentPoint.y/B-D.y);Q.x-=this.graph.panDx/this.graph.view.scale;Q.y-=this.graph.panDy/this.graph.view.scale;M.setTerminalPoint(Q,false)}this.fireEvent(new mxEventObject(mxEvent.CONNECT,"cell",A,"terminal",R,"event",I,"target",J,"terminalInserted",H))}}catch(K){mxLog.show();mxLog.debug(K.message)}finally{F.endUpdate()}if(this.select){this.selectCells(A,(H)?R:null)}}};mxConnectionHandler.prototype.selectCells=function(A,B){this.graph.setSelectionCell(A)};mxConnectionHandler.prototype.insertEdge=function(F,G,E,A,D,C){if(this.factoryMethod==null){return this.graph.insertEdge(F,G,E,A,D,C)}else{var B=this.createEdge(E,A,D,C);B=this.graph.addEdge(B,F,A,D);return B}};mxConnectionHandler.prototype.createTargetVertex=function(B,G){var K=this.graph.getCellGeometry(G);while(K!=null&&K.relative){G=this.graph.getModel().getParent(G);K=this.graph.getCellGeometry(G)}var C=this.graph.cloneCells([G])[0];var K=this.graph.getModel().getGeometry(C);if(K!=null){var E=this.graph.view.translate;var A=this.graph.view.scale;var J=new mxPoint(this.currentPoint.x/A-E.x,this.currentPoint.y/A-E.y);K.x=Math.round(J.x-K.width/2-this.graph.panDx/A);K.y=Math.round(J.y-K.height/2-this.graph.panDy/A);var D=this.getAlignmentTolerance();if(D>0){var F=this.graph.view.getState(G);if(F!=null){var H=F.x/A-E.x;var I=F.y/A-E.y;if(Math.abs(H-K.x)<=D){K.x=Math.round(H)}if(Math.abs(I-K.y)<=D){K.y=Math.round(I)}}}}return C};mxConnectionHandler.prototype.getAlignmentTolerance=function(A){return(this.graph.isGridEnabled())?this.graph.gridSize/2:this.graph.tolerance};mxConnectionHandler.prototype.createEdge=function(D,A,E,C){var B=null;if(this.factoryMethod!=null){B=this.factoryMethod(A,E,C)}if(B==null){B=new mxCell(D||"");B.setEdge(true);B.setStyle(C);var F=new mxGeometry();F.relative=true;B.setGeometry(F)}return B};mxConnectionHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.marker!=null){this.marker.destroy();this.marker=null}if(this.constraintHandler!=null){this.constraintHandler.destroy();this.constraintHandler=null}if(this.changeHandler!=null){this.graph.getModel().removeListener(this.changeHandler);this.graph.getView().removeListener(this.changeHandler);this.changeHandler=null}if(this.drillHandler!=null){this.graph.removeListener(this.drillHandler);this.graph.getView().removeListener(this.drillHandler);this.drillHandler=null}if(this.escapeHandler!=null){this.graph.removeListener(this.escapeHandler);this.escapeHandler=null}};function mxConstraintHandler(A){this.graph=A;this.resetHandler=mxUtils.bind(this,function(B,C){if(this.currentFocus!=null&&this.graph.view.getState(this.currentFocus.cell)==null){this.reset()}else{this.redraw()}});this.graph.model.addListener(mxEvent.CHANGE,this.resetHandler);this.graph.view.addListener(mxEvent.SCALE,this.resetHandler);this.graph.addListener(mxEvent.ROOT,this.resetHandler)}mxConstraintHandler.prototype.pointImage=new mxImage(mxClient.imageBasePath+"/point.gif",5,5);mxConstraintHandler.prototype.graph=null;mxConstraintHandler.prototype.enabled=true;mxConstraintHandler.prototype.highlightColor=mxConstants.DEFAULT_VALID_COLOR;mxConstraintHandler.prototype.isEnabled=function(){return this.enabled};mxConstraintHandler.prototype.setEnabled=function(A){this.enabled=A};mxConstraintHandler.prototype.reset=function(){if(this.focusIcons!=null){for(var A=0;A<this.focusIcons.length;A++){this.focusIcons[A].destroy()}this.focusIcons=null}if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}this.currentConstraint=null;this.currentFocusArea=null;this.currentPoint=null;this.currentFocus=null;this.focusPoints=null};mxConstraintHandler.prototype.getTolerance=function(A){return this.graph.getTolerance()};mxConstraintHandler.prototype.getImageForConstraint=function(C,B,A){return this.pointImage};mxConstraintHandler.prototype.isEventIgnored=function(B,A){return false};mxConstraintHandler.prototype.isStateIgnored=function(B,A){return false};mxConstraintHandler.prototype.destroyIcons=function(){if(this.focusIcons!=null){for(var A=0;A<this.focusIcons.length;A++){this.focusIcons[A].destroy()}this.focusIcons=null;this.focusPoints=null}};mxConstraintHandler.prototype.destroyFocusHighlight=function(){if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}};mxConstraintHandler.prototype.isKeepFocusEvent=function(A){return mxEvent.isShiftDown(A.getEvent())};mxConstraintHandler.prototype.getCellForEvent=function(B,A){var C=B.getCell();if(C==null&&A!=null&&(B.getGraphX()!=A.x||B.getGraphY()!=A.y)){C=this.graph.getCellAt(A.x,A.y)}if(C!=null&&!this.graph.isCellConnectable(C)){var D=this.graph.getModel().getParent(C);if(this.graph.getModel().isVertex(D)&&this.graph.isCellConnectable(D)){C=D}}return C};mxConstraintHandler.prototype.update=function(I,K,E,C){if(this.isEnabled()&&!this.isEventIgnored(I)){if(this.mouseleaveHandler==null&&this.graph.container!=null){this.mouseleaveHandler=mxUtils.bind(this,function(){this.reset()});mxEvent.addListener(this.graph.container,"mouseleave",this.resetHandler)}var Q=this.getTolerance(I);var O=(C!=null)?C.x:I.getGraphX();var P=(C!=null)?C.y:I.getGraphY();var B=new mxRectangle(O-Q,P-Q,2*Q,2*Q);var A=new mxRectangle(I.getGraphX()-Q,I.getGraphY()-Q,2*Q,2*Q);var H=this.graph.view.getState(this.getCellForEvent(I,C));if(!this.isKeepFocusEvent(I)&&(this.currentFocusArea==null||this.currentFocus==null||(H!=null)||!this.graph.getModel().isVertex(this.currentFocus.cell)||!mxUtils.intersects(this.currentFocusArea,A))&&(H!=this.currentFocus)){this.currentFocusArea=null;this.currentFocus=null;this.setFocus(I,H,K)}this.currentConstraint=null;this.currentPoint=null;var S=null;if(this.focusIcons!=null&&this.constraints!=null&&(H==null||this.currentFocus==H)){var F=A.getCenterX();var M=A.getCenterY();for(var G=0;G<this.focusIcons.length;G++){var J=F-this.focusIcons[G].bounds.getCenterX();var N=M-this.focusIcons[G].bounds.getCenterY();var D=J*J+N*N;if((this.intersects(this.focusIcons[G],A,K,E)||(C!=null&&this.intersects(this.focusIcons[G],B,K,E)))&&(S==null||D<S)){this.currentConstraint=this.constraints[G];this.currentPoint=this.focusPoints[G];S=D;var D=this.focusIcons[G].bounds.clone();D.grow(mxConstants.HIGHLIGHT_SIZE);if(mxClient.IS_IE){D.grow(1);D.width-=1;D.height-=1}if(this.focusHighlight==null){var L=this.createHighlightShape();L.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;L.pointerEvents=false;L.init(this.graph.getView().getOverlayPane());this.focusHighlight=L;var R=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:H});mxEvent.redirectMouseEvents(L.node,this.graph,R)}this.focusHighlight.bounds=D;this.focusHighlight.redraw()}}}if(this.currentConstraint==null){this.destroyFocusHighlight()}}else{this.currentConstraint=null;this.currentFocus=null;this.currentPoint=null}};mxConstraintHandler.prototype.redraw=function(){if(this.currentFocus!=null&&this.constraints!=null&&this.focusIcons!=null){var E=this.graph.view.getState(this.currentFocus.cell);this.currentFocus=E;this.currentFocusArea=new mxRectangle(E.x,E.y,E.width,E.height);for(var A=0;A<this.constraints.length;A++){var C=this.graph.getConnectionPoint(E,this.constraints[A]);var D=this.getImageForConstraint(E,this.constraints[A],C);var B=new mxRectangle(Math.round(C.x-D.width/2),Math.round(C.y-D.height/2),D.width,D.height);this.focusIcons[A].bounds=B;this.focusIcons[A].redraw();this.currentFocusArea.add(this.focusIcons[A].bounds);this.focusPoints[A]=C}}};mxConstraintHandler.prototype.setFocus=function(G,C,F){this.constraints=(C!=null&&!this.isStateIgnored(C,F)&&this.graph.isCellConnectable(C.cell))?((this.isEnabled())?(this.graph.getAllConnectionConstraints(C,F)||[]):[]):null;if(this.constraints!=null){this.currentFocus=C;this.currentFocusArea=new mxRectangle(C.x,C.y,C.width,C.height);if(this.focusIcons!=null){for(var E=0;E<this.focusIcons.length;E++){this.focusIcons[E].destroy()}this.focusIcons=null;this.focusPoints=null}this.focusPoints=[];this.focusIcons=[];for(var E=0;E<this.constraints.length;E++){var J=this.graph.getConnectionPoint(C,this.constraints[E]);var A=this.getImageForConstraint(C,this.constraints[E],J);var I=A.src;var B=new mxRectangle(Math.round(J.x-A.width/2),Math.round(J.y-A.height/2),A.width,A.height);var D=new mxImageShape(B,I);D.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;D.preserveImageAspect=false;D.init(this.graph.getView().getDecoratorPane());if(mxClient.IS_QUIRKS||document.documentMode==8){mxEvent.addListener(D.node,"dragstart",function(K){mxEvent.consume(K);return false})}if(D.node.previousSibling!=null){D.node.parentNode.insertBefore(D.node,D.node.parentNode.firstChild)}var H=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:C});D.redraw();mxEvent.redirectMouseEvents(D.node,this.graph,H);this.currentFocusArea.add(D.bounds);this.focusIcons.push(D);this.focusPoints.push(J)}this.currentFocusArea.grow(this.getTolerance(G))}else{this.destroyIcons();this.destroyFocusHighlight()}};mxConstraintHandler.prototype.createHighlightShape=function(){var A=new mxRectangleShape(null,this.highlightColor,this.highlightColor,mxConstants.HIGHLIGHT_STROKEWIDTH);A.opacity=mxConstants.HIGHLIGHT_OPACITY;return A};mxConstraintHandler.prototype.intersects=function(C,D,B,A){return mxUtils.intersects(C.bounds,D)};mxConstraintHandler.prototype.destroy=function(){this.reset();if(this.resetHandler!=null){this.graph.model.removeListener(this.resetHandler);this.graph.view.removeListener(this.resetHandler);this.graph.removeListener(this.resetHandler);this.resetHandler=null}if(this.mouseleaveHandler!=null&&this.graph.container!=null){mxEvent.removeListener(this.graph.container,"mouseleave",this.mouseleaveHandler);this.mouseleaveHandler=null}};function mxRubberband(A){if(A!=null){this.graph=A;this.graph.addMouseListener(this);this.forceRubberbandHandler=mxUtils.bind(this,function(C,D){var F=D.getProperty("eventName");var E=D.getProperty("event");if(F==mxEvent.MOUSE_DOWN&&this.isForceRubberbandEvent(E)){var B=mxUtils.getOffset(this.graph.container);var G=mxUtils.getScrollOrigin(this.graph.container);G.x-=B.x;G.y-=B.y;this.start(E.getX()+G.x,E.getY()+G.y);E.consume(false)}});this.graph.addListener(mxEvent.FIRE_MOUSE_EVENT,this.forceRubberbandHandler);this.panHandler=mxUtils.bind(this,function(){this.repaint()});this.graph.addListener(mxEvent.PAN,this.panHandler);this.gestureHandler=mxUtils.bind(this,function(B,C){if(this.first!=null){this.reset()}});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler);if(mxClient.IS_IE){mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()}))}}}mxRubberband.prototype.defaultOpacity=20;mxRubberband.prototype.enabled=true;mxRubberband.prototype.div=null;mxRubberband.prototype.sharedDiv=null;mxRubberband.prototype.currentX=0;mxRubberband.prototype.currentY=0;mxRubberband.prototype.isEnabled=function(){return this.enabled};mxRubberband.prototype.setEnabled=function(A){this.enabled=A};mxRubberband.prototype.isForceRubberbandEvent=function(A){return mxEvent.isAltDown(A.getEvent())};mxRubberband.prototype.mouseDown=function(B,C){if(!C.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&C.getState()==null&&!mxEvent.isMultiTouchEvent(C.getEvent())){var A=mxUtils.getOffset(this.graph.container);var D=mxUtils.getScrollOrigin(this.graph.container);D.x-=A.x;D.y-=A.y;this.start(C.getX()+D.x,C.getY()+D.y);C.consume(false)}};mxRubberband.prototype.start=function(C,D){this.first=new mxPoint(C,D);var B=this.graph.container;function A(F){var G=new mxMouseEvent(F);var E=mxUtils.convertPoint(B,G.getX(),G.getY());G.graphX=E.x;G.graphY=E.y;return G}this.dragHandler=mxUtils.bind(this,function(E){this.mouseMove(this.graph,A(E))});this.dropHandler=mxUtils.bind(this,function(E){this.mouseUp(this.graph,A(E))});if(mxClient.IS_FF){mxEvent.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}};mxRubberband.prototype.mouseMove=function(I,F){if(!F.isConsumed()&&this.first!=null){var C=mxUtils.getScrollOrigin(this.graph.container);var A=mxUtils.getOffset(this.graph.container);C.x-=A.x;C.y-=A.y;var G=F.getX()+C.x;var H=F.getY()+C.y;var D=this.first.x-G;var E=this.first.y-H;var B=this.graph.tolerance;if(this.div!=null||Math.abs(D)>B||Math.abs(E)>B){if(this.div==null){this.div=this.createShape()}mxUtils.clearSelection();this.update(G,H);F.consume()}}};mxRubberband.prototype.createShape=function(){if(this.sharedDiv==null){this.sharedDiv=document.createElement("div");this.sharedDiv.className="mxRubberband";mxUtils.setOpacity(this.sharedDiv,this.defaultOpacity)}this.graph.container.appendChild(this.sharedDiv);return this.sharedDiv};mxRubberband.prototype.isActive=function(A,B){return this.div!=null&&this.div.style.display!="none"};mxRubberband.prototype.mouseUp=function(A,C){var B=this.isActive();this.reset();if(B){this.execute(C.getEvent());C.consume()}};mxRubberband.prototype.execute=function(A){var B=new mxRectangle(this.x,this.y,this.width,this.height);this.graph.selectRegion(B,A)};mxRubberband.prototype.reset=function(){if(this.div!=null){this.div.parentNode.removeChild(this.div)}mxEvent.removeGestureListeners(document,null,this.dragHandler,this.dropHandler);this.dragHandler=null;this.dropHandler=null;this.currentX=0;this.currentY=0;this.first=null;this.div=null};mxRubberband.prototype.update=function(A,B){this.currentX=A;this.currentY=B;this.repaint()};mxRubberband.prototype.repaint=function(){if(this.div!=null){var C=this.currentX-this.graph.panDx;var D=this.currentY-this.graph.panDy;this.x=Math.min(this.first.x,C);this.y=Math.min(this.first.y,D);this.width=Math.max(this.first.x,C)-this.x;this.height=Math.max(this.first.y,D)-this.y;var B=(mxClient.IS_VML)?this.graph.panDx:0;var A=(mxClient.IS_VML)?this.graph.panDy:0;this.div.style.left=(this.x+B)+"px";this.div.style.top=(this.y+A)+"px";this.div.style.width=Math.max(1,this.width)+"px";this.div.style.height=Math.max(1,this.height)+"px"}};mxRubberband.prototype.destroy=function(){if(!this.destroyed){this.destroyed=true;this.graph.removeMouseListener(this);this.graph.removeListener(this.forceRubberbandHandler);this.graph.removeListener(this.panHandler);this.reset();if(this.sharedDiv!=null){this.sharedDiv=null}}};function mxHandle(C,A,B){this.graph=C.view.graph;this.state=C;this.cursor=(A!=null)?A:this.cursor;this.image=(B!=null)?B:this.image;this.init()}mxHandle.prototype.cursor="default";mxHandle.prototype.image=null;mxHandle.prototype.ignoreGrid=false;mxHandle.prototype.getPosition=function(A){};mxHandle.prototype.setPosition=function(A,B,C){};mxHandle.prototype.execute=function(){};mxHandle.prototype.copyStyle=function(A){this.graph.setCellStyles(A,this.state.style[A],[this.state.cell])};mxHandle.prototype.processEvent=function(D){var F=this.graph.view.scale;var C=this.graph.view.translate;var B=new mxPoint(D.getGraphX()/F-C.x,D.getGraphY()/F-C.y);if(this.shape!=null&&this.shape.bounds!=null){B.x-=this.shape.bounds.width/F/4;B.y-=this.shape.bounds.height/F/4}var A=-mxUtils.toRadians(this.getRotation());var E=-mxUtils.toRadians(this.getTotalRotation())-A;B=this.flipPoint(this.rotatePoint(this.snapPoint(this.rotatePoint(B,A),this.ignoreGrid||!this.graph.isGridEnabledEvent(D.getEvent())),E));this.setPosition(this.state.getPaintBounds(),B,D);this.positionChanged();this.redraw()};mxHandle.prototype.positionChanged=function(){if(this.state.text!=null){this.state.text.apply(this.state)}if(this.state.shape!=null){this.state.shape.apply(this.state)}this.graph.cellRenderer.redraw(this.state,true)};mxHandle.prototype.getRotation=function(){if(this.state.shape!=null){return this.state.shape.getRotation()}return 0};mxHandle.prototype.getTotalRotation=function(){if(this.state.shape!=null){return this.state.shape.getShapeRotation()}return 0};mxHandle.prototype.init=function(){var A=this.isHtmlRequired();if(this.image!=null){this.shape=new mxImageShape(new mxRectangle(0,0,this.image.width,this.image.height),this.image.src);this.shape.preserveImageAspect=false}else{this.shape=this.createShape(A)}this.initShape(A)};mxHandle.prototype.createShape=function(A){var B=new mxRectangle(0,0,mxConstants.HANDLE_SIZE,mxConstants.HANDLE_SIZE);return new mxRectangleShape(B,mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)};mxHandle.prototype.initShape=function(A){if(A&&this.shape.isHtmlAllowed()){this.shape.dialect=mxConstants.DIALECT_STRICTHTML;this.shape.init(this.graph.container)}else{this.shape.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;if(this.cursor!=null){this.shape.init(this.graph.getView().getOverlayPane())}}mxEvent.redirectMouseEvents(this.shape.node,this.graph,this.state);this.shape.node.style.cursor=this.cursor};mxHandle.prototype.redraw=function(){if(this.shape!=null&&this.state.shape!=null){var B=this.getPosition(this.state.getPaintBounds());if(B!=null){var D=mxUtils.toRadians(this.getTotalRotation());B=this.rotatePoint(this.flipPoint(B),D);var A=this.graph.view.scale;var C=this.graph.view.translate;this.shape.bounds.x=Math.floor((B.x+C.x)*A-this.shape.bounds.width/2);this.shape.bounds.y=Math.floor((B.y+C.y)*A-this.shape.bounds.height/2);this.state.unscaledWidth=null;this.shape.redraw()}}};mxHandle.prototype.isHtmlRequired=function(){return this.state.text!=null&&this.state.text.node.parentNode==this.graph.container};mxHandle.prototype.rotatePoint=function(C,D){var F=this.state.getCellBounds();var E=new mxPoint(F.getCenterX(),F.getCenterY());var B=Math.cos(D);var A=Math.sin(D);return mxUtils.getRotatedPoint(C,B,A,E)};mxHandle.prototype.flipPoint=function(A){if(this.state.shape!=null){var B=this.state.getCellBounds();if(this.state.shape.flipH){A.x=2*B.x+B.width-A.x}if(this.state.shape.flipV){A.y=2*B.y+B.height-A.y}}return A};mxHandle.prototype.snapPoint=function(A,B){if(!B){A.x=this.graph.snap(A.x);A.y=this.graph.snap(A.y)}return A};mxHandle.prototype.setVisible=function(A){if(this.shape!=null&&this.shape.node!=null){this.shape.node.style.display=(A)?"":"none"}};mxHandle.prototype.reset=function(){this.setVisible(true);this.state.style=this.graph.getCellStyle(this.state.cell);this.positionChanged()};mxHandle.prototype.destroy=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}};function mxVertexHandler(A){if(A!=null){this.state=A;this.init();this.escapeHandler=mxUtils.bind(this,function(B,C){if(this.livePreview&&this.index!=null){this.state.view.graph.cellRenderer.redraw(this.state,true);this.state.view.invalidate(this.state.cell);this.state.invalid=false;this.state.view.validate()}this.reset()});this.state.view.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxVertexHandler.prototype.graph=null;mxVertexHandler.prototype.state=null;mxVertexHandler.prototype.singleSizer=false;mxVertexHandler.prototype.index=null;mxVertexHandler.prototype.allowHandleBoundsCheck=true;mxVertexHandler.prototype.handleImage=null;mxVertexHandler.prototype.tolerance=0;mxVertexHandler.prototype.rotationEnabled=false;mxVertexHandler.prototype.parentHighlightEnabled=false;mxVertexHandler.prototype.rotationRaster=true;mxVertexHandler.prototype.rotationCursor="crosshair";mxVertexHandler.prototype.livePreview=false;mxVertexHandler.prototype.manageSizers=false;mxVertexHandler.prototype.constrainGroupByChildren=false;mxVertexHandler.prototype.rotationHandleVSpacing=-16;mxVertexHandler.prototype.horizontalOffset=0;mxVertexHandler.prototype.verticalOffset=0;mxVertexHandler.prototype.init=function(){this.graph=this.state.view.graph;this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.selectionBorder=this.createSelectionShape(this.bounds);this.selectionBorder.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.selectionBorder.pointerEvents=false;this.selectionBorder.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0");this.selectionBorder.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(this.selectionBorder.node,this.graph,this.state);if(this.graph.isCellMovable(this.state.cell)){this.selectionBorder.setCursor(mxConstants.CURSOR_MOVABLE_VERTEX)}if(mxGraphHandler.prototype.maxCells<=0||this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells){var A=this.graph.isCellResizable(this.state.cell);this.sizers=[];if(A||(this.graph.isLabelMovable(this.state.cell)&&this.state.width>=2&&this.state.height>=2)){var B=0;if(A){if(!this.singleSizer){this.sizers.push(this.createSizer("nw-resize",B++));this.sizers.push(this.createSizer("n-resize",B++));this.sizers.push(this.createSizer("ne-resize",B++));this.sizers.push(this.createSizer("w-resize",B++));this.sizers.push(this.createSizer("e-resize",B++));this.sizers.push(this.createSizer("sw-resize",B++));this.sizers.push(this.createSizer("s-resize",B++))}this.sizers.push(this.createSizer("se-resize",B++))}var C=this.graph.model.getGeometry(this.state.cell);if(C!=null&&!C.relative&&!this.graph.isSwimlane(this.state.cell)&&this.graph.isLabelMovable(this.state.cell)){this.labelShape=this.createSizer(mxConstants.CURSOR_LABEL_HANDLE,mxEvent.LABEL_HANDLE,mxConstants.LABEL_HANDLE_SIZE,mxConstants.LABEL_HANDLE_FILLCOLOR);this.sizers.push(this.labelShape)}}else{if(this.graph.isCellMovable(this.state.cell)&&!this.graph.isCellResizable(this.state.cell)&&this.state.width<2&&this.state.height<2){this.labelShape=this.createSizer(mxConstants.CURSOR_MOVABLE_VERTEX,mxEvent.LABEL_HANDLE,null,mxConstants.LABEL_HANDLE_FILLCOLOR);this.sizers.push(this.labelShape)}}}if(this.isRotationHandleVisible()){this.rotationShape=this.createSizer(this.rotationCursor,mxEvent.ROTATION_HANDLE,mxConstants.HANDLE_SIZE+3,mxConstants.HANDLE_FILLCOLOR);this.sizers.push(this.rotationShape)}this.customHandles=this.createCustomHandles();this.redraw();if(this.constrainGroupByChildren){this.updateMinBounds()}};mxVertexHandler.prototype.isRotationHandleVisible=function(){return this.graph.isEnabled()&&this.rotationEnabled&&this.graph.isCellRotatable(this.state.cell)&&(mxGraphHandler.prototype.maxCells<=0||this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells)&&this.state.width>=2&&this.state.height>=2};mxVertexHandler.prototype.isConstrainedEvent=function(A){return mxEvent.isShiftDown(A.getEvent())||this.state.style[mxConstants.STYLE_ASPECT]=="fixed"};mxVertexHandler.prototype.isCenteredEvent=function(B,A){return false};mxVertexHandler.prototype.createCustomHandles=function(){return null};mxVertexHandler.prototype.updateMinBounds=function(){var C=this.graph.getChildCells(this.state.cell);if(C.length>0){this.minBounds=this.graph.view.getBounds(C);if(this.minBounds!=null){var A=this.state.view.scale;var B=this.state.view.translate;this.minBounds.x-=this.state.x;this.minBounds.y-=this.state.y;this.minBounds.x/=A;this.minBounds.y/=A;this.minBounds.width/=A;this.minBounds.height/=A;this.x0=this.state.x/A-B.x;this.y0=this.state.y/A-B.y}}};mxVertexHandler.prototype.getSelectionBounds=function(A){return new mxRectangle(Math.round(A.x),Math.round(A.y),Math.round(A.width),Math.round(A.height))};mxVertexHandler.prototype.createParentHighlightShape=function(A){return this.createSelectionShape(A)};mxVertexHandler.prototype.createSelectionShape=function(A){var B=new mxRectangleShape(A,null,this.getSelectionColor());B.strokewidth=this.getSelectionStrokeWidth();B.isDashed=this.isSelectionDashed();return B};mxVertexHandler.prototype.getSelectionColor=function(){return mxConstants.VERTEX_SELECTION_COLOR};mxVertexHandler.prototype.getSelectionStrokeWidth=function(){return mxConstants.VERTEX_SELECTION_STROKEWIDTH};mxVertexHandler.prototype.isSelectionDashed=function(){return mxConstants.VERTEX_SELECTION_DASHED};mxVertexHandler.prototype.createSizer=function(A,D,C,E){C=C||mxConstants.HANDLE_SIZE;var F=new mxRectangle(0,0,C,C);var B=this.createSizerShape(F,D,E);if(B.isHtmlAllowed()&&this.state.text!=null&&this.state.text.node.parentNode==this.graph.container){B.bounds.height-=1;B.bounds.width-=1;B.dialect=mxConstants.DIALECT_STRICTHTML;B.init(this.graph.container)}else{B.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;B.init(this.graph.getView().getOverlayPane())}mxEvent.redirectMouseEvents(B.node,this.graph,this.state);if(this.graph.isEnabled()){B.setCursor(A)}if(!this.isSizerVisible(D)){B.visible=false}return B};mxVertexHandler.prototype.isSizerVisible=function(A){return true};mxVertexHandler.prototype.createSizerShape=function(A,B,C){if(this.handleImage!=null){A=new mxRectangle(A.x,A.y,this.handleImage.width,this.handleImage.height);var D=new mxImageShape(A,this.handleImage.src);D.preserveImageAspect=false;return D}else{if(B==mxEvent.ROTATION_HANDLE){return new mxEllipse(A,C||mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}else{return new mxRectangleShape(A,C||mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}}};mxVertexHandler.prototype.moveSizerTo=function(C,A,B){if(C!=null){C.bounds.x=Math.floor(A-C.bounds.width/2);C.bounds.y=Math.floor(B-C.bounds.height/2);if(C.node!=null&&C.node.style.display!="none"){C.redraw()}}};mxVertexHandler.prototype.getHandleForEvent=function(C){var E=(!mxEvent.isMouseEvent(C.getEvent()))?this.tolerance:1;var D=(this.allowHandleBoundsCheck&&(mxClient.IS_IE||E>0))?new mxRectangle(C.getGraphX()-E,C.getGraphY()-E,2*E,2*E):null;function B(F){return F!=null&&(C.isSource(F)||(D!=null&&mxUtils.intersects(F.bounds,D)&&F.node.style.display!="none"&&F.node.style.visibility!="hidden"))}if(this.customHandles!=null&&this.isCustomHandleEvent(C)){for(var A=this.customHandles.length-1;A>=0;A--){if(B(this.customHandles[A].shape)){return mxEvent.CUSTOM_HANDLE-A}}}if(B(this.rotationShape)){return mxEvent.ROTATION_HANDLE}else{if(B(this.labelShape)){return mxEvent.LABEL_HANDLE}}if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(B(this.sizers[A])){return A}}}return null};mxVertexHandler.prototype.isCustomHandleEvent=function(A){return true};mxVertexHandler.prototype.mouseDown=function(B,C){var D=(!mxEvent.isMouseEvent(C.getEvent()))?this.tolerance:0;if(!C.isConsumed()&&this.graph.isEnabled()&&(D>0||C.getState()==this.state)){var A=this.getHandleForEvent(C);if(A!=null){this.start(C.getGraphX(),C.getGraphY(),A);C.consume()}}};mxVertexHandler.prototype.isLivePreviewBorder=function(){return this.state.shape!=null&&this.state.shape.fill==null&&this.state.shape.stroke==null};mxVertexHandler.prototype.start=function(E,F,B){this.inTolerance=true;this.childOffsetX=0;this.childOffsetY=0;this.index=B;this.startX=E;this.startY=F;var H=this.state.view.graph.model;var G=H.getParent(this.state.cell);if(this.state.view.currentRoot!=G&&(H.isVertex(G)||H.isEdge(G))){this.parentState=this.state.view.graph.view.getState(G)}this.selectionBorder.node.style.display=(B==mxEvent.ROTATION_HANDLE)?"inline":"none";if(!this.livePreview||this.isLivePreviewBorder()){this.preview=this.createSelectionShape(this.bounds);if(!(mxClient.IS_SVG&&Number(this.state.style[mxConstants.STYLE_ROTATION]||"0")!=0)&&this.state.text!=null&&this.state.text.node.parentNode==this.graph.container){this.preview.dialect=mxConstants.DIALECT_STRICTHTML;this.preview.init(this.graph.container)}else{this.preview.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.preview.init(this.graph.view.getOverlayPane())}}if(this.livePreview){this.hideSizers();if(B==mxEvent.ROTATION_HANDLE){this.rotationShape.node.style.display=""}else{if(B==mxEvent.LABEL_HANDLE){this.labelShape.node.style.display=""}else{if(this.sizers!=null&&this.sizers[B]!=null){this.sizers[B].node.style.display=""}else{if(B<=mxEvent.CUSTOM_HANDLE&&this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-B].setVisible(true)}}}}var A=this.graph.getEdges(this.state.cell);this.edgeHandlers=[];for(var D=0;D<A.length;D++){var C=this.graph.selectionCellsHandler.getHandler(A[D]);if(C!=null){this.edgeHandlers.push(C)}}}};mxVertexHandler.prototype.setHandlesVisible=function(B){if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){this.sizers[A].node.style.display=(B)?"":"none"}}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].setVisible(B)}}};mxVertexHandler.prototype.hideSizers=function(){this.setHandlesVisible(false)};mxVertexHandler.prototype.checkTolerance=function(A){if(this.inTolerance&&this.startX!=null&&this.startY!=null){if(mxEvent.isMouseEvent(A.getEvent())||Math.abs(A.getGraphX()-this.startX)>this.graph.tolerance||Math.abs(A.getGraphY()-this.startY)>this.graph.tolerance){this.inTolerance=false}}};mxVertexHandler.prototype.updateHint=function(A){};mxVertexHandler.prototype.removeHint=function(){};mxVertexHandler.prototype.roundAngle=function(A){return Math.round(A*10)/10};mxVertexHandler.prototype.roundLength=function(A){return Math.round(A)};mxVertexHandler.prototype.mouseMove=function(A,B){if(!B.isConsumed()&&this.index!=null){this.checkTolerance(B);if(!this.inTolerance){if(this.index<=mxEvent.CUSTOM_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].processEvent(B)}}else{if(this.index==mxEvent.LABEL_HANDLE){this.moveLabel(B)}else{if(this.index==mxEvent.ROTATION_HANDLE){this.rotateVertex(B)}else{this.resizeVertex(B)}}}this.updateHint(B)}B.consume()}else{if(!this.graph.isMouseDown&&this.getHandleForEvent(B)!=null){B.consume(false)}}};mxVertexHandler.prototype.moveLabel=function(C){var A=new mxPoint(C.getGraphX(),C.getGraphY());var B=this.graph.view.translate;var E=this.graph.view.scale;if(this.graph.isGridEnabledEvent(C.getEvent())){A.x=(this.graph.snap(A.x/E-B.x)+B.x)*E;A.y=(this.graph.snap(A.y/E-B.y)+B.y)*E}var D=(this.rotationShape!=null)?this.sizers.length-2:this.sizers.length-1;this.moveSizerTo(this.sizers[D],A.x,A.y)};mxVertexHandler.prototype.rotateVertex=function(D){var B=new mxPoint(D.getGraphX(),D.getGraphY());var C=this.state.x+this.state.width/2-B.x;var E=this.state.y+this.state.height/2-B.y;this.currentAlpha=(C!=0)?Math.atan(E/C)*180/Math.PI+90:((E<0)?180:0);if(C>0){this.currentAlpha-=180}if(this.rotationRaster&&this.graph.isGridEnabledEvent(D.getEvent())){var C=B.x-this.state.getCenterX();var E=B.y-this.state.getCenterY();var A=Math.abs(Math.sqrt(C*C+E*E)-20)*3;var F=Math.max(1,5*Math.min(3,Math.max(0,Math.round(80/Math.abs(A)))));this.currentAlpha=Math.round(this.currentAlpha/F)*F}else{this.currentAlpha=this.roundAngle(this.currentAlpha)}this.selectionBorder.rotation=this.currentAlpha;this.selectionBorder.redraw();if(this.livePreview){this.redrawHandles()}};mxVertexHandler.prototype.resizeVertex=function(A){var D=new mxPoint(this.state.getCenterX(),this.state.getCenterY());var O=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var B=new mxPoint(A.getGraphX(),A.getGraphY());var Q=this.graph.view.translate;var N=this.graph.view.scale;var R=Math.cos(-O);var V=Math.sin(-O);var I=B.x-this.startX;var T=B.y-this.startY;var X=R*I-V*T;var L=V*I+R*T;I=X;T=L;var P=this.graph.getCellGeometry(this.state.cell);this.unscaledBounds=this.union(P,I/N,T/N,this.index,this.graph.isGridEnabledEvent(A.getEvent()),1,new mxPoint(0,0),this.isConstrainedEvent(A),this.isCenteredEvent(this.state,A));if(!P.relative){var W=this.graph.getMaximumGraphBounds();if(W!=null&&this.parentState!=null){W=mxRectangle.fromRectangle(W);W.x-=(this.parentState.x-Q.x*N)/N;W.y-=(this.parentState.y-Q.y*N)/N}if(this.graph.isConstrainChild(this.state.cell)){var C=this.graph.getCellContainmentArea(this.state.cell);if(C!=null){var K=this.graph.getOverlap(this.state.cell);if(K>0){C=mxRectangle.fromRectangle(C);C.x-=C.width*K;C.y-=C.height*K;C.width+=2*C.width*K;C.height+=2*C.height*K}if(W==null){W=C}else{W=mxRectangle.fromRectangle(W);W.intersect(C)}}}if(W!=null){if(this.unscaledBounds.x<W.x){this.unscaledBounds.width-=W.x-this.unscaledBounds.x;this.unscaledBounds.x=W.x}if(this.unscaledBounds.y<W.y){this.unscaledBounds.height-=W.y-this.unscaledBounds.y;this.unscaledBounds.y=W.y}if(this.unscaledBounds.x+this.unscaledBounds.width>W.x+W.width){this.unscaledBounds.width-=this.unscaledBounds.x+this.unscaledBounds.width-W.x-W.width}if(this.unscaledBounds.y+this.unscaledBounds.height>W.y+W.height){this.unscaledBounds.height-=this.unscaledBounds.y+this.unscaledBounds.height-W.y-W.height}}}this.bounds=new mxRectangle(((this.parentState!=null)?this.parentState.x:Q.x*N)+(this.unscaledBounds.x)*N,((this.parentState!=null)?this.parentState.y:Q.y*N)+(this.unscaledBounds.y)*N,this.unscaledBounds.width*N,this.unscaledBounds.height*N);if(P.relative&&this.parentState!=null){this.bounds.x+=this.state.x-this.parentState.x;this.bounds.y+=this.state.y-this.parentState.y}R=Math.cos(O);V=Math.sin(O);var M=new mxPoint(this.bounds.getCenterX(),this.bounds.getCenterY());var I=M.x-D.x;var T=M.y-D.y;var J=R*I-V*T;var G=V*I+R*T;var U=J-I;var H=G-T;var Y=this.bounds.x-this.state.x;var E=this.bounds.y-this.state.y;var S=R*Y-V*E;var F=V*Y+R*E;this.bounds.x+=U;this.bounds.y+=H;this.unscaledBounds.x=this.roundLength(this.unscaledBounds.x+U/N);this.unscaledBounds.y=this.roundLength(this.unscaledBounds.y+H/N);this.unscaledBounds.width=this.roundLength(this.unscaledBounds.width);this.unscaledBounds.height=this.roundLength(this.unscaledBounds.height);if(!this.graph.isCellCollapsed(this.state.cell)&&(U!=0||H!=0)){this.childOffsetX=this.state.x-this.bounds.x+S;this.childOffsetY=this.state.y-this.bounds.y+F}else{this.childOffsetX=0;this.childOffsetY=0}if(this.livePreview){this.updateLivePreview(A)}if(this.preview!=null){this.drawPreview()}};mxVertexHandler.prototype.updateLivePreview=function(D){var F=this.graph.view.scale;var C=this.graph.view.translate;var G=this.state.clone();this.state.x=this.bounds.x;this.state.y=this.bounds.y;this.state.origin=new mxPoint(this.state.x/F-C.x,this.state.y/F-C.y);this.state.width=this.bounds.width;this.state.height=this.bounds.height;this.state.unscaledWidth=null;var A=this.state.absoluteOffset;A=new mxPoint(A.x,A.y);this.state.absoluteOffset.x=0;this.state.absoluteOffset.y=0;var B=this.graph.getCellGeometry(this.state.cell);if(B!=null){var E=B.offset||this.EMPTY_POINT;if(E!=null&&!B.relative){this.state.absoluteOffset.x=this.state.view.scale*E.x;this.state.absoluteOffset.y=this.state.view.scale*E.y}this.state.view.updateVertexLabelOffset(this.state)}this.state.view.graph.cellRenderer.redraw(this.state,true);this.state.view.invalidate(this.state.cell);this.state.invalid=false;this.state.view.validate();this.redrawHandles();this.state.setState(G)};mxVertexHandler.prototype.mouseUp=function(N,J){if(this.index!=null&&this.state!=null){var L=new mxPoint(J.getGraphX(),J.getGraphY());this.graph.getModel().beginUpdate();try{if(this.index<=mxEvent.CUSTOM_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].execute()}}else{if(this.index==mxEvent.ROTATION_HANDLE){if(this.currentAlpha!=null){var K=this.currentAlpha-(this.state.style[mxConstants.STYLE_ROTATION]||0);if(K!=0){this.rotateCell(this.state.cell,K)}}else{this.rotateClick()}}else{var D=this.graph.isGridEnabledEvent(J.getEvent());var F=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(-F);var E=Math.sin(-F);var H=L.x-this.startX;var I=L.y-this.startY;var A=G*H-E*I;var M=E*H+G*I;H=A;I=M;var B=this.graph.view.scale;var C=this.isRecursiveResize(this.state,J);this.resizeCell(this.state.cell,this.roundLength(H/B),this.roundLength(I/B),this.index,D,this.isConstrainedEvent(J),C)}}}finally{this.graph.getModel().endUpdate()}J.consume();this.reset()}};mxVertexHandler.prototype.isRecursiveResize=function(B,A){return this.graph.isRecursiveResize(this.state)};mxVertexHandler.prototype.rotateClick=function(){};mxVertexHandler.prototype.rotateCell=function(K,F,I){if(F!=0){var J=this.graph.getModel();if(J.isVertex(K)||J.isEdge(K)){if(!J.isEdge(K)){var C=this.graph.view.getState(K);var D=(C!=null)?C.style:this.graph.getCellStyle(K);if(D!=null){var E=(D[mxConstants.STYLE_ROTATION]||0)+F;this.graph.setCellStyles(mxConstants.STYLE_ROTATION,E,[K])}}var B=this.graph.getCellGeometry(K);if(B!=null){var H=this.graph.getCellGeometry(I);if(H!=null&&!J.isEdge(I)){B=B.clone();B.rotate(F,new mxPoint(H.width/2,H.height/2));J.setGeometry(K,B)}if((J.isVertex(K)&&!B.relative)||J.isEdge(K)){var A=J.getChildCount(K);for(var G=0;G<A;G++){this.rotateCell(J.getChildAt(K,G),F,K)}}}}}};mxVertexHandler.prototype.reset=function(){if(this.sizers!=null&&this.index!=null&&this.sizers[this.index]!=null&&this.sizers[this.index].node.style.display=="none"){this.sizers[this.index].node.style.display=""}this.currentAlpha=null;this.inTolerance=null;this.index=null;if(this.preview!=null){this.preview.destroy();this.preview=null}if(this.livePreview&&this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(this.sizers[A]!=null){this.sizers[A].node.style.display=""}}}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].reset()}}if(this.selectionBorder!=null){this.selectionBorder.node.style.display="inline";this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.drawPreview()}this.removeHint();this.redrawHandles();this.edgeHandlers=null;this.unscaledBounds=null};mxVertexHandler.prototype.resizeCell=function(I,G,E,B,C,F,D){var H=this.graph.model.getGeometry(I);if(H!=null){if(B==mxEvent.LABEL_HANDLE){var A=this.graph.view.scale;G=Math.round((this.labelShape.bounds.getCenterX()-this.startX)/A);E=Math.round((this.labelShape.bounds.getCenterY()-this.startY)/A);H=H.clone();if(H.offset==null){H.offset=new mxPoint(G,E)}else{H.offset.x+=G;H.offset.y+=E}this.graph.model.setGeometry(I,H)}else{if(this.unscaledBounds!=null){var A=this.graph.view.scale;if(this.childOffsetX!=0||this.childOffsetY!=0){this.moveChildren(I,Math.round(this.childOffsetX/A),Math.round(this.childOffsetY/A))}this.graph.resizeCell(I,this.unscaledBounds,D)}}}};mxVertexHandler.prototype.moveChildren=function(H,E,D){var G=this.graph.getModel();var A=G.getChildCount(H);for(var C=0;C<A;C++){var B=G.getChildAt(H,C);var F=this.graph.getCellGeometry(B);if(F!=null){F=F.clone();F.translate(E,D);G.setGeometry(B,F)}}};mxVertexHandler.prototype.union=function(T,H,V,D,M,O,Q,A,L){if(this.singleSizer){var Y=T.x+T.width+H;var Z=T.y+T.height+V;if(M){Y=this.graph.snap(Y/O)*O;Z=this.graph.snap(Z/O)*O}var K=new mxRectangle(T.x,T.y,0,0);K.add(new mxRectangle(Y,Z,0,0));return K}else{var N=T.width;var R=T.height;var W=T.x-Q.x*O;var G=W+N;var U=T.y-Q.y*O;var S=U+R;var E=W+N/2;var F=U+R/2;if(D>4){S=S+V;if(M){S=this.graph.snap(S/O)*O}}else{if(D<3){U=U+V;if(M){U=this.graph.snap(U/O)*O}}}if(D==0||D==3||D==5){W+=H;if(M){W=this.graph.snap(W/O)*O}}else{if(D==2||D==4||D==7){G+=H;if(M){G=this.graph.snap(G/O)*O}}}var P=G-W;var a=S-U;if(A){var J=this.graph.getCellGeometry(this.state.cell);if(J!=null){var X=J.width/J.height;if(D==1||D==2||D==7||D==6){P=a*X}else{a=P/X}if(D==0){W=G-P;U=S-a}}}if(L){P+=(P-N);a+=(a-R);var C=E-(W+P/2);var B=F-(U+a/2);W+=C;U+=B;G+=C;S+=B}if(P<0){W+=P;P=Math.abs(P)}if(a<0){U+=a;a=Math.abs(a)}var I=new mxRectangle(W+Q.x*O,U+Q.y*O,P,a);if(this.minBounds!=null){I.width=Math.max(I.width,this.minBounds.x*O+this.minBounds.width*O+Math.max(0,this.x0*O-I.x));I.height=Math.max(I.height,this.minBounds.y*O+this.minBounds.height*O+Math.max(0,this.y0*O-I.y))}return I}};mxVertexHandler.prototype.redraw=function(){this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.redrawHandles();this.drawPreview()};mxVertexHandler.prototype.getHandlePadding=function(){var A=new mxPoint(0,0);var B=this.tolerance;if(this.sizers!=null&&this.sizers.length>0&&this.sizers[0]!=null&&(this.bounds.width<2*this.sizers[0].bounds.width+2*B||this.bounds.height<2*this.sizers[0].bounds.height+2*B)){B/=2;A.x=this.sizers[0].bounds.width+B;A.y=this.sizers[0].bounds.height+B}return A};mxVertexHandler.prototype.redrawHandles=function(){var E=this.tolerance;this.horizontalOffset=0;this.verticalOffset=0;var B=this.bounds;if(this.sizers!=null&&this.sizers.length>0&&this.sizers[0]!=null){if(this.index==null&&this.manageSizers&&this.sizers.length>=8){var D=this.getHandlePadding();this.horizontalOffset=D.x;this.verticalOffset=D.y;if(this.horizontalOffset!=0||this.verticalOffset!=0){B=new mxRectangle(B.x,B.y,B.width,B.height);B.x-=this.horizontalOffset/2;B.width+=this.horizontalOffset;B.y-=this.verticalOffset/2;B.height+=this.verticalOffset}if(this.sizers.length>=8){if((B.width<2*this.sizers[0].bounds.width+2*E)||(B.height<2*this.sizers[0].bounds.height+2*E)){this.sizers[0].node.style.display="none";this.sizers[2].node.style.display="none";this.sizers[5].node.style.display="none";this.sizers[7].node.style.display="none"}else{this.sizers[0].node.style.display="";this.sizers[2].node.style.display="";this.sizers[5].node.style.display="";this.sizers[7].node.style.display=""}}}var A=B.x+B.width;var N=B.y+B.height;if(this.singleSizer){this.moveSizerTo(this.sizers[0],A,N)}else{var K=B.x+B.width/2;var H=B.y+B.height/2;if(this.sizers.length>=8){var I=["nw-resize","n-resize","ne-resize","e-resize","se-resize","s-resize","sw-resize","w-resize"];var J=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(J);var F=Math.sin(J);var C=Math.round(J*4/Math.PI);var O=new mxPoint(B.getCenterX(),B.getCenterY());var M=mxUtils.getRotatedPoint(new mxPoint(B.x,B.y),G,F,O);this.moveSizerTo(this.sizers[0],M.x,M.y);this.sizers[0].setCursor(I[mxUtils.mod(0+C,I.length)]);M.x=K;M.y=B.y;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[1],M.x,M.y);this.sizers[1].setCursor(I[mxUtils.mod(1+C,I.length)]);M.x=A;M.y=B.y;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[2],M.x,M.y);this.sizers[2].setCursor(I[mxUtils.mod(2+C,I.length)]);M.x=B.x;M.y=H;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[3],M.x,M.y);this.sizers[3].setCursor(I[mxUtils.mod(7+C,I.length)]);M.x=A;M.y=H;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[4],M.x,M.y);this.sizers[4].setCursor(I[mxUtils.mod(3+C,I.length)]);M.x=B.x;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[5],M.x,M.y);this.sizers[5].setCursor(I[mxUtils.mod(6+C,I.length)]);M.x=K;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[6],M.x,M.y);this.sizers[6].setCursor(I[mxUtils.mod(5+C,I.length)]);M.x=A;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[7],M.x,M.y);this.sizers[7].setCursor(I[mxUtils.mod(4+C,I.length)]);this.moveSizerTo(this.sizers[8],K+this.state.absoluteOffset.x,H+this.state.absoluteOffset.y)}else{if(this.state.width>=2&&this.state.height>=2){this.moveSizerTo(this.sizers[0],K+this.state.absoluteOffset.x,H+this.state.absoluteOffset.y)}else{this.moveSizerTo(this.sizers[0],this.state.x,this.state.y)}}}}if(this.rotationShape!=null){var J=mxUtils.toRadians((this.currentAlpha!=null)?this.currentAlpha:this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(J);var F=Math.sin(J);var O=new mxPoint(this.state.getCenterX(),this.state.getCenterY());var M=mxUtils.getRotatedPoint(new mxPoint(B.x+B.width/2,B.y+this.rotationHandleVSpacing),G,F,O);if(this.rotationShape.node!=null){this.moveSizerTo(this.rotationShape,M.x,M.y)}}if(this.selectionBorder!=null){this.selectionBorder.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0")}if(this.edgeHandlers!=null){for(var L=0;L<this.edgeHandlers.length;L++){this.edgeHandlers[L].redraw()}}if(this.customHandles!=null){for(var L=0;L<this.customHandles.length;L++){this.customHandles[L].redraw()}}this.updateParentHighlight()};mxVertexHandler.prototype.updateParentHighlight=function(){if(this.selectionBorder!=null){if(this.parentHighlight!=null){var B=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(B)){var C=this.graph.view.getState(B);var A=this.parentHighlight.bounds;if(C!=null&&(A.x!=C.x||A.y!=C.y||A.width!=C.width||A.height!=C.height)){this.parentHighlight.bounds=C;this.parentHighlight.redraw()}}else{this.parentHighlight.destroy();this.parentHighlight=null}}else{if(this.parentHighlightEnabled){var B=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(B)){var C=this.graph.view.getState(B);if(C!=null){this.parentHighlight=this.createParentHighlightShape(C);this.parentHighlight.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.parentHighlight.pointerEvents=false;this.parentHighlight.rotation=Number(C.style[mxConstants.STYLE_ROTATION]||"0");this.parentHighlight.init(this.graph.getView().getOverlayPane())}}}}}};mxVertexHandler.prototype.drawPreview=function(){if(this.preview!=null){this.preview.bounds=this.bounds;if(this.preview.node.parentNode==this.graph.container){this.preview.bounds.width=Math.max(0,this.preview.bounds.width-1);this.preview.bounds.height=Math.max(0,this.preview.bounds.height-1)}this.preview.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0");this.preview.redraw()}this.selectionBorder.bounds=this.bounds;this.selectionBorder.redraw();if(this.parentHighlight!=null){this.parentHighlight.redraw()}};mxVertexHandler.prototype.destroy=function(){if(this.escapeHandler!=null){this.state.view.graph.removeListener(this.escapeHandler);this.escapeHandler=null}if(this.preview!=null){this.preview.destroy();this.preview=null}if(this.parentHighlight!=null){this.parentHighlight.destroy();this.parentHighlight=null}if(this.selectionBorder!=null){this.selectionBorder.destroy();this.selectionBorder=null}this.labelShape=null;this.removeHint();if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){this.sizers[A].destroy()}this.sizers=null}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].destroy()}this.customHandles=null}};function mxPanningHandler(A){if(A!=null){this.graph=A;this.graph.addMouseListener(this);this.forcePanningHandler=mxUtils.bind(this,function(B,C){var E=C.getProperty("eventName");var D=C.getProperty("event");if(E==mxEvent.MOUSE_DOWN&&this.isForcePanningEvent(D)){this.start(D);this.active=true;this.fireEvent(new mxEventObject(mxEvent.PAN_START,"event",D));D.consume()}});this.graph.addListener(mxEvent.FIRE_MOUSE_EVENT,this.forcePanningHandler);this.gestureHandler=mxUtils.bind(this,function(B,E){if(this.isPinchEnabled()){var C=E.getProperty("event");if(!mxEvent.isConsumed(C)&&C.type=="gesturestart"){this.initialScale=this.graph.view.scale;if(!this.active&&this.mouseDownEvent!=null){this.start(this.mouseDownEvent);this.mouseDownEvent=null}}else{if(C.type=="gestureend"&&this.initialScale==null){this.initialScale=null}}if(this.initialScale!=null){var D=Math.round(this.initialScale*C.scale*100)/100;if(this.minScale!=null){D=Math.max(this.minScale,D)}if(this.maxScale!=null){D=Math.min(this.maxScale,D)}if(this.graph.view.scale!=D){this.graph.zoomTo(D);mxEvent.consume(C)}}}});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler)}}mxPanningHandler.prototype=new mxEventSource();mxPanningHandler.prototype.constructor=mxPanningHandler;mxPanningHandler.prototype.graph=null;mxPanningHandler.prototype.useLeftButtonForPanning=false;mxPanningHandler.prototype.usePopupTrigger=true;mxPanningHandler.prototype.ignoreCell=false;mxPanningHandler.prototype.previewEnabled=true;mxPanningHandler.prototype.useGrid=false;mxPanningHandler.prototype.panningEnabled=true;mxPanningHandler.prototype.pinchEnabled=true;mxPanningHandler.prototype.maxScale=8;mxPanningHandler.prototype.minScale=0.01;mxPanningHandler.prototype.dx=null;mxPanningHandler.prototype.dy=null;mxPanningHandler.prototype.startX=0;mxPanningHandler.prototype.startY=0;mxPanningHandler.prototype.isActive=function(){return this.active||this.initialScale!=null};mxPanningHandler.prototype.isPanningEnabled=function(){return this.panningEnabled};mxPanningHandler.prototype.setPanningEnabled=function(A){this.panningEnabled=A};mxPanningHandler.prototype.isPinchEnabled=function(){return this.pinchEnabled};mxPanningHandler.prototype.setPinchEnabled=function(A){this.pinchEnabled=A};mxPanningHandler.prototype.isPanningTrigger=function(B){var A=B.getEvent();return(this.useLeftButtonForPanning&&B.getState()==null&&mxEvent.isLeftMouseButton(A))||(mxEvent.isControlDown(A)&&mxEvent.isShiftDown(A))||(this.usePopupTrigger&&mxEvent.isPopupTrigger(A))};mxPanningHandler.prototype.isForcePanningEvent=function(A){return this.ignoreCell||mxEvent.isMultiTouchEvent(A.getEvent())};mxPanningHandler.prototype.mouseDown=function(A,B){this.mouseDownEvent=B;if(!B.isConsumed()&&this.isPanningEnabled()&&!this.active&&this.isPanningTrigger(B)){this.start(B);this.consumePanningTrigger(B)}};mxPanningHandler.prototype.start=function(A){this.dx0=-this.graph.container.scrollLeft;this.dy0=-this.graph.container.scrollTop;this.startX=A.getX();this.startY=A.getY();this.dx=null;this.dy=null;this.panningTrigger=true};mxPanningHandler.prototype.consumePanningTrigger=function(A){A.consume()};mxPanningHandler.prototype.mouseMove=function(B,C){this.dx=C.getX()-this.startX;this.dy=C.getY()-this.startY;if(this.active){if(this.previewEnabled){if(this.useGrid){this.dx=this.graph.snap(this.dx);this.dy=this.graph.snap(this.dy)}this.graph.panGraph(this.dx+this.dx0,this.dy+this.dy0)}this.fireEvent(new mxEventObject(mxEvent.PAN,"event",C))}else{if(this.panningTrigger){var A=this.active;this.active=Math.abs(this.dx)>this.graph.tolerance||Math.abs(this.dy)>this.graph.tolerance;if(!A&&this.active){this.fireEvent(new mxEventObject(mxEvent.PAN_START,"event",C))}}}if(this.active||this.panningTrigger){C.consume()}};mxPanningHandler.prototype.mouseUp=function(A,B){if(this.active){if(this.dx!=null&&this.dy!=null){if(!this.graph.useScrollbarsForPanning||!mxUtils.hasScrollbars(this.graph.container)){var D=this.graph.getView().scale;var C=this.graph.getView().translate;this.graph.panGraph(0,0);this.panGraph(C.x+this.dx/D,C.y+this.dy/D)}B.consume()}this.fireEvent(new mxEventObject(mxEvent.PAN_END,"event",B))}this.panningTrigger=false;this.mouseDownEvent=null;this.active=false;this.dx=null;this.dy=null};mxPanningHandler.prototype.panGraph=function(A,B){this.graph.getView().setTranslate(A,B)};mxPanningHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.forcePanningHandler);this.graph.removeListener(this.gestureHandler)};function mxPopupMenuHandler(A,B){if(A!=null){this.graph=A;this.factoryMethod=B;this.graph.addMouseListener(this);this.gestureHandler=mxUtils.bind(this,function(C,D){this.inTolerance=false});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler);this.init()}}mxPopupMenuHandler.prototype=new mxPopupMenu();mxPopupMenuHandler.prototype.constructor=mxPopupMenuHandler;mxPopupMenuHandler.prototype.graph=null;mxPopupMenuHandler.prototype.selectOnPopup=true;mxPopupMenuHandler.prototype.clearSelectionOnBackground=true;mxPopupMenuHandler.prototype.triggerX=null;mxPopupMenuHandler.prototype.triggerY=null;mxPopupMenuHandler.prototype.screenX=null;mxPopupMenuHandler.prototype.screenY=null;mxPopupMenuHandler.prototype.init=function(){mxPopupMenu.prototype.init.apply(this);mxEvent.addGestureListeners(this.div,mxUtils.bind(this,function(A){this.graph.tooltipHandler.hide()}))};mxPopupMenuHandler.prototype.isSelectOnPopup=function(A){return this.selectOnPopup};mxPopupMenuHandler.prototype.mouseDown=function(A,B){if(this.isEnabled()&&!mxEvent.isMultiTouchEvent(B.getEvent())){this.hideMenu();this.triggerX=B.getGraphX();this.triggerY=B.getGraphY();this.screenX=mxEvent.getMainEvent(B.getEvent()).screenX;this.screenY=mxEvent.getMainEvent(B.getEvent()).screenY;this.popupTrigger=this.isPopupTrigger(B);this.inTolerance=true}};mxPopupMenuHandler.prototype.mouseMove=function(A,B){if(this.inTolerance&&this.screenX!=null&&this.screenY!=null){if(Math.abs(mxEvent.getMainEvent(B.getEvent()).screenX-this.screenX)>this.graph.tolerance||Math.abs(mxEvent.getMainEvent(B.getEvent()).screenY-this.screenY)>this.graph.tolerance){this.inTolerance=false}}};mxPopupMenuHandler.prototype.mouseUp=function(B,C){if(this.popupTrigger&&this.inTolerance&&this.triggerX!=null&&this.triggerY!=null){var D=this.getCellForPopupEvent(C);if(this.graph.isEnabled()&&this.isSelectOnPopup(C)&&D!=null&&!this.graph.isCellSelected(D)){this.graph.setSelectionCell(D)}else{if(this.clearSelectionOnBackground&&D==null){this.graph.clearSelection()}}this.graph.tooltipHandler.hide();var A=mxUtils.getScrollOrigin();this.popup(C.getX()+A.x+1,C.getY()+A.y+1,D,C.getEvent());C.consume()}this.popupTrigger=false;this.inTolerance=false};mxPopupMenuHandler.prototype.getCellForPopupEvent=function(A){return A.getCell()};mxPopupMenuHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.gestureHandler);mxPopupMenu.prototype.destroy.apply(this)};function mxCellMarker(B,D,C,A){mxEventSource.call(this);if(B!=null){this.graph=B;this.validColor=(D!=null)?D:mxConstants.DEFAULT_VALID_COLOR;this.invalidColor=(D!=null)?C:mxConstants.DEFAULT_INVALID_COLOR;this.hotspot=(A!=null)?A:mxConstants.DEFAULT_HOTSPOT;this.highlight=new mxCellHighlight(B)}}mxUtils.extend(mxCellMarker,mxEventSource);mxCellMarker.prototype.graph=null;mxCellMarker.prototype.enabled=true;mxCellMarker.prototype.hotspot=mxConstants.DEFAULT_HOTSPOT;mxCellMarker.prototype.hotspotEnabled=false;mxCellMarker.prototype.validColor=null;mxCellMarker.prototype.invalidColor=null;mxCellMarker.prototype.currentColor=null;mxCellMarker.prototype.validState=null;mxCellMarker.prototype.markedState=null;mxCellMarker.prototype.setEnabled=function(A){this.enabled=A};mxCellMarker.prototype.isEnabled=function(){return this.enabled};mxCellMarker.prototype.setHotspot=function(A){this.hotspot=A};mxCellMarker.prototype.getHotspot=function(){return this.hotspot};mxCellMarker.prototype.setHotspotEnabled=function(A){this.hotspotEnabled=A};mxCellMarker.prototype.isHotspotEnabled=function(){return this.hotspotEnabled};mxCellMarker.prototype.hasValidState=function(){return this.validState!=null};mxCellMarker.prototype.getValidState=function(){return this.validState};mxCellMarker.prototype.getMarkedState=function(){return this.markedState};mxCellMarker.prototype.reset=function(){this.validState=null;if(this.markedState!=null){this.markedState=null;this.unmark()}};mxCellMarker.prototype.process=function(A){var B=null;if(this.isEnabled()){B=this.getState(A);this.setCurrentState(B,A)}return B};mxCellMarker.prototype.setCurrentState=function(D,B,C){var A=(D!=null)?this.isValidState(D):false;C=(C!=null)?C:this.getMarkerColor(B.getEvent(),D,A);if(A){this.validState=D}else{this.validState=null}if(D!=this.markedState||C!=this.currentColor){this.currentColor=C;if(D!=null&&this.currentColor!=null){this.markedState=D;this.mark()}else{if(this.markedState!=null){this.markedState=null;this.unmark()}}}};mxCellMarker.prototype.markCell=function(A,B){var C=this.graph.getView().getState(A);if(C!=null){this.currentColor=(B!=null)?B:this.validColor;this.markedState=C;this.mark()}};mxCellMarker.prototype.mark=function(){this.highlight.setHighlightColor(this.currentColor);this.highlight.highlight(this.markedState);this.fireEvent(new mxEventObject(mxEvent.MARK,"state",this.markedState))};mxCellMarker.prototype.unmark=function(){this.mark()};mxCellMarker.prototype.isValidState=function(A){return true};mxCellMarker.prototype.getMarkerColor=function(A,C,B){return(B)?this.validColor:this.invalidColor};mxCellMarker.prototype.getState=function(A){var B=this.graph.getView();cell=this.getCell(A);var C=this.getStateToMark(B.getState(cell));return(C!=null&&this.intersects(C,A))?C:null};mxCellMarker.prototype.getCell=function(A){return A.getCell()};mxCellMarker.prototype.getStateToMark=function(A){return A};mxCellMarker.prototype.intersects=function(B,A){if(this.hotspotEnabled){return mxUtils.intersectsHotspot(B,A.getGraphX(),A.getGraphY(),this.hotspot,mxConstants.MIN_HOTSPOT_SIZE,mxConstants.MAX_HOTSPOT_SIZE)}return true};mxCellMarker.prototype.destroy=function(){this.graph.getView().removeListener(this.resetHandler);this.graph.getModel().removeListener(this.resetHandler);this.highlight.destroy()};function mxSelectionCellsHandler(A){mxEventSource.call(this);this.graph=A;this.handlers=new mxDictionary();this.graph.addMouseListener(this);this.refreshHandler=mxUtils.bind(this,function(B,C){if(this.isEnabled()){this.refresh()}});this.graph.getSelectionModel().addListener(mxEvent.CHANGE,this.refreshHandler);this.graph.getModel().addListener(mxEvent.CHANGE,this.refreshHandler);this.graph.getView().addListener(mxEvent.SCALE,this.refreshHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.refreshHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.refreshHandler);this.graph.getView().addListener(mxEvent.DOWN,this.refreshHandler);this.graph.getView().addListener(mxEvent.UP,this.refreshHandler)}mxUtils.extend(mxSelectionCellsHandler,mxEventSource);mxSelectionCellsHandler.prototype.graph=null;mxSelectionCellsHandler.prototype.enabled=true;mxSelectionCellsHandler.prototype.refreshHandler=null;mxSelectionCellsHandler.prototype.maxHandlers=100;mxSelectionCellsHandler.prototype.handlers=null;mxSelectionCellsHandler.prototype.isEnabled=function(){return this.enabled};mxSelectionCellsHandler.prototype.setEnabled=function(A){this.enabled=A};mxSelectionCellsHandler.prototype.getHandler=function(A){return this.handlers.get(A)};mxSelectionCellsHandler.prototype.reset=function(){this.handlers.visit(function(A,B){B.reset.apply(B)})};mxSelectionCellsHandler.prototype.refresh=function(){var E=this.handlers;this.handlers=new mxDictionary();var A=this.graph.getSelectionCells();for(var B=0;B<A.length;B++){var D=this.graph.view.getState(A[B]);if(D!=null){var C=E.remove(A[B]);if(C!=null){if(C.state!=D){C.destroy();C=null}else{if(C.refresh!=null){C.refresh()}C.redraw()}}if(C==null){C=this.graph.createHandler(D);this.fireEvent(new mxEventObject(mxEvent.ADD,"state",D))}if(C!=null){this.handlers.put(A[B],C)}}}E.visit(mxUtils.bind(this,function(F,G){this.fireEvent(new mxEventObject(mxEvent.REMOVE,"state",G.state));G.destroy()}))};mxSelectionCellsHandler.prototype.updateHandler=function(B){var A=this.handlers.remove(B.cell);if(A!=null){A.destroy();A=this.graph.createHandler(B);if(A!=null){this.handlers.put(B.cell,A)}}};mxSelectionCellsHandler.prototype.mouseDown=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseDown.apply(E,C)})}};mxSelectionCellsHandler.prototype.mouseMove=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseMove.apply(E,C)})}};mxSelectionCellsHandler.prototype.mouseUp=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseUp.apply(E,C)})}};mxSelectionCellsHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);if(this.refreshHandler!=null){this.graph.getSelectionModel().removeListener(this.refreshHandler);this.graph.getModel().removeListener(this.refreshHandler);this.graph.getView().removeListener(this.refreshHandler);this.refreshHandler=null}};function mxConnectionHandler(A,B){mxEventSource.call(this);if(A!=null){this.graph=A;this.factoryMethod=B;this.init();this.escapeHandler=mxUtils.bind(this,function(C,D){this.reset()});this.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxUtils.extend(mxConnectionHandler,mxEventSource);mxConnectionHandler.prototype.graph=null;mxConnectionHandler.prototype.factoryMethod=true;mxConnectionHandler.prototype.moveIconFront=false;mxConnectionHandler.prototype.moveIconBack=false;mxConnectionHandler.prototype.connectImage=null;mxConnectionHandler.prototype.targetConnectImage=false;mxConnectionHandler.prototype.enabled=true;mxConnectionHandler.prototype.select=true;mxConnectionHandler.prototype.createTarget=false;mxConnectionHandler.prototype.marker=null;mxConnectionHandler.prototype.constraintHandler=null;mxConnectionHandler.prototype.error=null;mxConnectionHandler.prototype.waypointsEnabled=false;mxConnectionHandler.prototype.ignoreMouseDown=false;mxConnectionHandler.prototype.first=null;mxConnectionHandler.prototype.connectIconOffset=new mxPoint(0,mxConstants.TOOLTIP_VERTICAL_OFFSET);mxConnectionHandler.prototype.edgeState=null;mxConnectionHandler.prototype.changeHandler=null;mxConnectionHandler.prototype.drillHandler=null;mxConnectionHandler.prototype.mouseDownCounter=0;mxConnectionHandler.prototype.movePreviewAway=mxClient.IS_VML;mxConnectionHandler.prototype.outlineConnect=false;mxConnectionHandler.prototype.livePreview=false;mxConnectionHandler.prototype.cursor=null;mxConnectionHandler.prototype.insertBeforeSource=false;mxConnectionHandler.prototype.isEnabled=function(){return this.enabled};mxConnectionHandler.prototype.setEnabled=function(A){this.enabled=A};mxConnectionHandler.prototype.isInsertBefore=function(C,B,E,A,D){return this.insertBeforeSource&&B!=E};mxConnectionHandler.prototype.isCreateTarget=function(A){return this.createTarget};mxConnectionHandler.prototype.setCreateTarget=function(A){this.createTarget=A};mxConnectionHandler.prototype.createShape=function(){var A=(this.livePreview&&this.edgeState!=null)?this.graph.cellRenderer.createShape(this.edgeState):new mxPolyline([],mxConstants.INVALID_COLOR);A.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;A.scale=this.graph.view.scale;A.pointerEvents=false;A.isDashed=true;A.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(A.node,this.graph,null);return A};mxConnectionHandler.prototype.init=function(){this.graph.addMouseListener(this);this.marker=this.createMarker();this.constraintHandler=new mxConstraintHandler(this.graph);this.changeHandler=mxUtils.bind(this,function(A){if(this.iconState!=null){this.iconState=this.graph.getView().getState(this.iconState.cell)}if(this.iconState!=null){this.redrawIcons(this.icons,this.iconState);this.constraintHandler.reset()}else{if(this.previous!=null&&this.graph.view.getState(this.previous.cell)==null){this.reset()}}});this.graph.getModel().addListener(mxEvent.CHANGE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE,this.changeHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.changeHandler);this.drillHandler=mxUtils.bind(this,function(A){this.reset()});this.graph.addListener(mxEvent.START_EDITING,this.drillHandler);this.graph.getView().addListener(mxEvent.DOWN,this.drillHandler);this.graph.getView().addListener(mxEvent.UP,this.drillHandler)};mxConnectionHandler.prototype.isConnectableCell=function(A){return true};mxConnectionHandler.prototype.createMarker=function(){var A=new mxCellMarker(this.graph);A.hotspotEnabled=true;A.getCell=mxUtils.bind(this,function(B){var C=mxCellMarker.prototype.getCell.apply(A,arguments);this.error=null;if(C==null&&this.currentPoint!=null){C=this.graph.getCellAt(this.currentPoint.x,this.currentPoint.y)}if(C!=null&&!this.graph.isCellConnectable(C)){var D=this.graph.getModel().getParent(C);if(this.graph.getModel().isVertex(D)&&this.graph.isCellConnectable(D)){C=D}}if((this.graph.isSwimlane(C)&&this.currentPoint!=null&&this.graph.hitsSwimlaneContent(C,this.currentPoint.x,this.currentPoint.y))||!this.isConnectableCell(C)){C=null}if(C!=null){if(this.isConnecting()){if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,C);if(this.error!=null&&this.error.length==0){C=null;if(this.isCreateTarget(B.getEvent())){this.error=null}}}}else{if(!this.isValidSource(C,B)){C=null}}}else{if(this.isConnecting()&&!this.isCreateTarget(B.getEvent())&&!this.graph.allowDanglingEdges){this.error=""}}return C});A.isValidState=mxUtils.bind(this,function(B){if(this.isConnecting()){return this.error==null}else{return mxCellMarker.prototype.isValidState.apply(A,arguments)}});A.getMarkerColor=mxUtils.bind(this,function(B,D,C){return(this.connectImage==null||this.isConnecting())?mxCellMarker.prototype.getMarkerColor.apply(A,arguments):null});A.intersects=mxUtils.bind(this,function(C,B){if(this.connectImage!=null||this.isConnecting()){return true}return mxCellMarker.prototype.intersects.apply(A,arguments)});return A};mxConnectionHandler.prototype.start=function(D,A,B,C){this.previous=D;this.first=new mxPoint(A,B);this.edgeState=(C!=null)?C:this.createEdgeState(null);this.marker.currentColor=this.marker.validColor;this.marker.markedState=D;this.marker.mark();this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous))};mxConnectionHandler.prototype.isConnecting=function(){return this.first!=null&&this.shape!=null};mxConnectionHandler.prototype.isValidSource=function(B,A){return this.graph.isValidSource(B)};mxConnectionHandler.prototype.isValidTarget=function(A){return true};mxConnectionHandler.prototype.validateConnection=function(A,B){if(!this.isValidTarget(B)){return""}return this.graph.getEdgeValidationError(null,A,B)};mxConnectionHandler.prototype.getConnectImage=function(A){return this.connectImage};mxConnectionHandler.prototype.isMoveIconToFrontForState=function(A){if(A.text!=null&&A.text.node.parentNode==this.graph.container){return true}return this.moveIconFront};mxConnectionHandler.prototype.createIcons=function(G){var C=this.getConnectImage(G);if(C!=null&&G!=null){this.iconState=G;var A=[];var B=new mxRectangle(0,0,C.width,C.height);var E=new mxImageShape(B,C.src,null,null,0);E.preserveImageAspect=false;if(this.isMoveIconToFrontForState(G)){E.dialect=mxConstants.DIALECT_STRICTHTML;E.init(this.graph.container)}else{E.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;E.init(this.graph.getView().getOverlayPane());if(this.moveIconBack&&E.node.previousSibling!=null){E.node.parentNode.insertBefore(E.node,E.node.parentNode.firstChild)}}E.node.style.cursor=mxConstants.CURSOR_CONNECT;var F=mxUtils.bind(this,function(){return(this.currentState!=null)?this.currentState:G});var D=mxUtils.bind(this,function(H){if(!mxEvent.isConsumed(H)){this.icon=E;this.graph.fireMouseEvent(mxEvent.MOUSE_DOWN,new mxMouseEvent(H,F()))}});mxEvent.redirectMouseEvents(E.node,this.graph,F,D);A.push(E);this.redrawIcons(A,this.iconState);return A}return null};mxConnectionHandler.prototype.redrawIcons=function(A,C){if(A!=null&&A[0]!=null&&C!=null){var B=this.getIconPosition(A[0],C);A[0].bounds.x=B.x;A[0].bounds.y=B.y;A[0].redraw()}};mxConnectionHandler.prototype.getIconPosition=function(J,I){var C=this.graph.getView().scale;var F=I.getCenterX();var G=I.getCenterY();if(this.graph.isSwimlane(I.cell)){var B=this.graph.getStartSize(I.cell);F=(B.width!=0)?I.x+B.width*C/2:F;G=(B.height!=0)?I.y+B.height*C/2:G;var H=mxUtils.toRadians(mxUtils.getValue(I.style,mxConstants.STYLE_ROTATION)||0);if(H!=0){var E=Math.cos(H);var D=Math.sin(H);var K=new mxPoint(I.getCenterX(),I.getCenterY());var A=mxUtils.getRotatedPoint(new mxPoint(F,G),E,D,K);F=A.x;G=A.y}}return new mxPoint(F-J.bounds.width/2,G-J.bounds.height/2)};mxConnectionHandler.prototype.destroyIcons=function(){if(this.icons!=null){for(var A=0;A<this.icons.length;A++){this.icons[A].destroy()}this.icons=null;this.icon=null;this.selectedIcon=null;this.iconState=null}};mxConnectionHandler.prototype.isStartEvent=function(A){return((this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null)||(this.previous!=null&&this.error==null&&(this.icons==null||(this.icons!=null&&this.icon!=null))))};mxConnectionHandler.prototype.mouseDown=function(A,C){this.mouseDownCounter++;if(this.isEnabled()&&this.graph.isEnabled()&&!C.isConsumed()&&!this.isConnecting()&&this.isStartEvent(C)){if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){this.sourceConstraint=this.constraintHandler.currentConstraint;this.previous=this.constraintHandler.currentFocus;this.first=this.constraintHandler.currentPoint.clone()}else{this.first=new mxPoint(C.getGraphX(),C.getGraphY())}this.edgeState=this.createEdgeState(C);this.mouseDownCounter=1;if(this.waypointsEnabled&&this.shape==null){this.waypoints=null;this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}}if(this.previous==null&&this.edgeState!=null){var B=this.graph.getPointForEvent(C.getEvent());this.edgeState.cell.geometry.setTerminalPoint(B,true)}this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous));C.consume()}this.selectedIcon=this.icon;this.icon=null};mxConnectionHandler.prototype.isImmediateConnectSource=function(A){return !this.graph.isCellMovable(A.cell)};mxConnectionHandler.prototype.createEdgeState=function(A){return null};mxConnectionHandler.prototype.isOutlineConnectEvent=function(H){var B=mxUtils.getOffset(this.graph.container);var A=H.getEvent();var E=mxEvent.getClientX(A);var F=mxEvent.getClientY(A);var G=document.documentElement;var D=(window.pageXOffset||G.scrollLeft)-(G.clientLeft||0);var C=(window.pageYOffset||G.scrollTop)-(G.clientTop||0);var I=this.currentPoint.x-this.graph.container.scrollLeft+B.x-D;var J=this.currentPoint.y-this.graph.container.scrollTop+B.y-C;return this.outlineConnect&&!mxEvent.isShiftDown(H.getEvent())&&(H.isSource(this.marker.highlight.shape)||(mxEvent.isAltDown(H.getEvent())&&H.getState()!=null)||this.marker.highlight.isHighlightAt(E,F)||((I!=E||J!=F)&&H.getState()==null&&this.marker.highlight.isHighlightAt(I,J)))};mxConnectionHandler.prototype.updateCurrentState=function(C,B){this.constraintHandler.update(C,this.first==null,false,(this.first==null||C.isSource(this.marker.highlight.shape))?null:B);if(this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null){if(this.marker.highlight!=null&&this.marker.highlight.state!=null&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell){if(this.marker.highlight.shape.stroke!="transparent"){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint()}}else{this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent")}if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,this.constraintHandler.currentFocus.cell);if(this.error==null){this.currentState=this.constraintHandler.currentFocus}else{this.constraintHandler.reset()}}}else{if(this.graph.isIgnoreTerminalEvent(C.getEvent())){this.marker.reset();this.currentState=null}else{this.marker.process(C);this.currentState=this.marker.getValidState()}var D=this.isOutlineConnectEvent(C);if(this.currentState!=null&&D){if(C.isSource(this.marker.highlight.shape)){B=new mxPoint(C.getGraphX(),C.getGraphY())}var E=this.graph.getOutlineConstraint(B,this.currentState,C);this.constraintHandler.setFocus(C,this.currentState,false);this.constraintHandler.currentConstraint=E;this.constraintHandler.currentPoint=B}if(this.outlineConnect){if(this.marker.highlight!=null&&this.marker.highlight.shape!=null){var A=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){this.marker.highlight.shape.stroke=mxConstants.OUTLINE_HIGHLIGHT_COLOR;this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/A/A;this.marker.highlight.repaint()}else{if(this.marker.hasValidState()){if(this.marker.getValidState()!=C.getState()){this.marker.highlight.shape.stroke="transparent";this.currentState=null}else{this.marker.highlight.shape.stroke=mxConstants.DEFAULT_VALID_COLOR}this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/A/A;this.marker.highlight.repaint()}}}}}};mxConnectionHandler.prototype.convertWaypoint=function(A){var C=this.graph.getView().getScale();var B=this.graph.getView().getTranslate();A.x=A.x/C-B.x;A.y=A.y/C-B.y};mxConnectionHandler.prototype.snapToPreview=function(C,B){if(!mxEvent.isAltDown(C.getEvent())&&this.previous!=null){var D=this.graph.gridSize*this.graph.view.scale/2;var A=(this.sourceConstraint!=null)?this.first:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());if(Math.abs(A.x-C.getGraphX())<D){B.x=A.x}if(Math.abs(A.y-C.getGraphY())<D){B.y=A.y}}};mxConnectionHandler.prototype.mouseMove=function(Q,H){if(!H.isConsumed()&&(this.ignoreMouseDown||this.first!=null||!this.graph.isMouseDown)){if(!this.isEnabled()&&this.currentState!=null){this.destroyIcons();this.currentState=null}var J=this.graph.getView();var N=J.scale;var P=J.translate;var C=new mxPoint(H.getGraphX(),H.getGraphY());this.error=null;if(this.graph.isGridEnabledEvent(H.getEvent())){C=new mxPoint((this.graph.snap(C.x/N-P.x)+P.x)*N,(this.graph.snap(C.y/N-P.y)+P.y)*N)}this.snapToPreview(H,C);this.currentPoint=C;if(this.first!=null||(this.isEnabled()&&this.graph.isEnabled())){this.updateCurrentState(H,C)}if(this.first!=null){var L=null;var I=C;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){L=this.constraintHandler.currentConstraint;I=this.constraintHandler.currentPoint.clone()}else{if(this.previous!=null&&!this.graph.isIgnoreTerminalEvent(H.getEvent())&&mxEvent.isShiftDown(H.getEvent())){if(Math.abs(this.previous.getCenterX()-C.x)<Math.abs(this.previous.getCenterY()-C.y)){C.x=this.previous.getCenterX()}else{C.y=this.previous.getCenterY()}}}var M=this.first;if(this.selectedIcon!=null){var W=this.selectedIcon.bounds.width;var F=this.selectedIcon.bounds.height;if(this.currentState!=null&&this.targetConnectImage){var V=this.getIconPosition(this.selectedIcon,this.currentState);this.selectedIcon.bounds.x=V.x;this.selectedIcon.bounds.y=V.y}else{var E=new mxRectangle(H.getGraphX()+this.connectIconOffset.x,H.getGraphY()+this.connectIconOffset.y,W,F);this.selectedIcon.bounds=E}this.selectedIcon.redraw()}if(this.edgeState!=null){this.updateEdgeState(I,L);I=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-1];M=this.edgeState.absolutePoints[0]}else{if(this.currentState!=null){if(this.constraintHandler.currentConstraint==null){var D=this.getTargetPerimeterPoint(this.currentState,H);if(D!=null){I=D}}}if(this.sourceConstraint==null&&this.previous!=null){var O=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[0]:I;var D=this.getSourcePerimeterPoint(this.previous,O,H);if(D!=null){M=D}}}if(this.currentState==null&&this.movePreviewAway){var D=M;if(this.edgeState!=null&&this.edgeState.absolutePoints.length>=2){var R=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-2];if(R!=null){D=R}}var K=I.x-D.x;var S=I.y-D.y;var B=Math.sqrt(K*K+S*S);if(B==0){return}this.originalPoint=I.clone();I.x-=K*4/B;I.y-=S*4/B}else{this.originalPoint=null}if(this.shape==null){var K=Math.abs(C.x-this.first.x);var S=Math.abs(C.y-this.first.y);if(K>this.graph.tolerance||S>this.graph.tolerance){this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}this.updateCurrentState(H,C)}}if(this.shape!=null){if(this.edgeState!=null){this.shape.points=this.edgeState.absolutePoints}else{var A=[M];if(this.waypoints!=null){A=A.concat(this.waypoints)}A.push(I);this.shape.points=A}this.drawPreview()}if(this.cursor!=null){this.graph.container.style.cursor=this.cursor}mxEvent.consume(H.getEvent());H.consume()}else{if(!this.isEnabled()||!this.graph.isEnabled()){this.constraintHandler.reset()}else{if(this.previous!=this.currentState&&this.edgeState==null){this.destroyIcons();if(this.currentState!=null&&this.error==null&&this.constraintHandler.currentConstraint==null){this.icons=this.createIcons(this.currentState);if(this.icons==null){this.currentState.setCursor(mxConstants.CURSOR_CONNECT);H.consume()}}this.previous=this.currentState}else{if(this.previous==this.currentState&&this.currentState!=null&&this.icons==null&&!this.graph.isMouseDown){H.consume()}}}}if(!this.graph.isMouseDown&&this.currentState!=null&&this.icons!=null){var U=false;var T=H.getSource();for(var G=0;G<this.icons.length&&!U;G++){U=T==this.icons[G].node||T.parentNode==this.icons[G].node}if(!U){this.updateIcons(this.currentState,this.icons,H)}}}else{this.constraintHandler.reset()}};mxConnectionHandler.prototype.updateEdgeState=function(C,D){if(this.sourceConstraint!=null&&this.sourceConstraint.point!=null){this.edgeState.style[mxConstants.STYLE_EXIT_X]=this.sourceConstraint.point.x;this.edgeState.style[mxConstants.STYLE_EXIT_Y]=this.sourceConstraint.point.y}if(D!=null&&D.point!=null){this.edgeState.style[mxConstants.STYLE_ENTRY_X]=D.point.x;this.edgeState.style[mxConstants.STYLE_ENTRY_Y]=D.point.y}else{delete this.edgeState.style[mxConstants.STYLE_ENTRY_X];delete this.edgeState.style[mxConstants.STYLE_ENTRY_Y]}this.edgeState.absolutePoints=[null,(this.currentState!=null)?null:C];this.graph.view.updateFixedTerminalPoint(this.edgeState,this.previous,true,this.sourceConstraint);if(this.currentState!=null){if(D==null){D=this.graph.getConnectionConstraint(this.edgeState,this.previous,false)}this.edgeState.setAbsoluteTerminalPoint(null,false);this.graph.view.updateFixedTerminalPoint(this.edgeState,this.currentState,false,D)}var E=null;if(this.waypoints!=null){E=[];for(var A=0;A<this.waypoints.length;A++){var B=this.waypoints[A].clone();this.convertWaypoint(B);E[A]=B}}this.graph.view.updatePoints(this.edgeState,E,this.previous,this.currentState);this.graph.view.updateFloatingTerminalPoints(this.edgeState,this.previous,this.currentState)};mxConnectionHandler.prototype.getTargetPerimeterPoint=function(G,D){var B=null;var F=G.view;var E=F.getPerimeterFunction(G);if(E!=null){var C=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[this.waypoints.length-1]:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());var A=E(F.getPerimeterBounds(G),this.edgeState,C,false);if(A!=null){B=A}}else{B=new mxPoint(G.getCenterX(),G.getCenterY())}return B};mxConnectionHandler.prototype.getSourcePerimeterPoint=function(G,J,H){var B=null;var A=G.view;var F=A.getPerimeterFunction(G);var I=new mxPoint(G.getCenterX(),G.getCenterY());if(F!=null){var E=mxUtils.getValue(G.style,mxConstants.STYLE_ROTATION,0);var D=-E*(Math.PI/180);if(E!=0){J=mxUtils.getRotatedPoint(new mxPoint(J.x,J.y),Math.cos(D),Math.sin(D),I)}var C=F(A.getPerimeterBounds(G),G,J,false);if(C!=null){if(E!=0){C=mxUtils.getRotatedPoint(new mxPoint(C.x,C.y),Math.cos(-D),Math.sin(-D),I)}B=C}}else{B=I}return B};mxConnectionHandler.prototype.updateIcons=function(C,A,B){};mxConnectionHandler.prototype.isStopEvent=function(A){return A.getState()!=null};mxConnectionHandler.prototype.addWaypointForEvent=function(C){var A=mxUtils.convertPoint(this.graph.container,C.getX(),C.getY());var B=Math.abs(A.x-this.first.x);var D=Math.abs(A.y-this.first.y);var E=this.waypoints!=null||(this.mouseDownCounter>1&&(B>this.graph.tolerance||D>this.graph.tolerance));if(E){if(this.waypoints==null){this.waypoints=[]}var F=this.graph.view.scale;var A=new mxPoint(this.graph.snap(C.getGraphX()/F)*F,this.graph.snap(C.getGraphY()/F)*F);this.waypoints.push(A)}};mxConnectionHandler.prototype.mouseUp=function(A,C){if(!C.isConsumed()&&this.isConnecting()){if(this.waypointsEnabled&&!this.isStopEvent(C)){this.addWaypointForEvent(C);C.consume();return}if(this.error==null){var B=(this.previous!=null)?this.previous.cell:null;var D=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){D=this.constraintHandler.currentFocus.cell}if(D==null&&this.currentState!=null){D=this.currentState.cell}this.connect(B,D,C.getEvent(),C.getCell())}else{if(this.previous!=null&&this.marker.validState!=null&&this.previous.cell==this.marker.validState.cell){this.graph.selectCellForEvent(this.marker.source,evt)}if(this.error.length>0){this.graph.validationAlert(this.error)}}this.destroyIcons();C.consume()}if(this.first!=null){this.reset()}};mxConnectionHandler.prototype.reset=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.cursor!=null&&this.graph.container!=null){this.graph.container.style.cursor=""}this.destroyIcons();this.marker.reset();this.constraintHandler.reset();this.originalPoint=null;this.currentPoint=null;this.edgeState=null;this.previous=null;this.error=null;this.sourceConstraint=null;this.mouseDownCounter=0;this.first=null;this.fireEvent(new mxEventObject(mxEvent.RESET))};mxConnectionHandler.prototype.drawPreview=function(){this.updatePreview(this.error==null);this.shape.redraw()};mxConnectionHandler.prototype.updatePreview=function(A){this.shape.strokewidth=this.getEdgeWidth(A);this.shape.stroke=this.getEdgeColor(A)};mxConnectionHandler.prototype.getEdgeColor=function(A){return(A)?mxConstants.VALID_COLOR:mxConstants.INVALID_COLOR};mxConnectionHandler.prototype.getEdgeWidth=function(A){return(A)?3:1};mxConnectionHandler.prototype.connect=function(L,R,I,J){if(R!=null||this.isCreateTarget(I)||this.graph.allowDanglingEdges){var F=this.graph.getModel();var H=false;var A=null;F.beginUpdate();try{if(L!=null&&R==null&&!this.graph.isIgnoreTerminalEvent(I)&&this.isCreateTarget(I)){R=this.createTargetVertex(I,L);if(R!=null){J=this.graph.getDropTarget([R],I,J);H=true;if(J==null||!this.graph.getModel().isEdge(J)){var P=this.graph.getView().getState(J);if(P!=null){var C=F.getGeometry(R);C.x-=P.origin.x;C.y-=P.origin.y}}else{J=this.graph.getDefaultParent()}this.graph.addCell(R,J)}}var O=this.graph.getDefaultParent();if(L!=null&&R!=null&&F.getParent(L)==F.getParent(R)&&F.getParent(F.getParent(L))!=F.getRoot()){O=F.getParent(L);if((L.geometry!=null&&L.geometry.relative)&&(R.geometry!=null&&R.geometry.relative)){O=F.getParent(O)}}var S=null;var T=null;if(this.edgeState!=null){S=this.edgeState.cell.value;T=this.edgeState.cell.style}A=this.insertEdge(O,null,S,L,R,T);if(A!=null){this.graph.setConnectionConstraint(A,L,true,this.sourceConstraint);this.graph.setConnectionConstraint(A,R,false,this.constraintHandler.currentConstraint);if(this.edgeState!=null){F.setGeometry(A,this.edgeState.cell.geometry)}var O=F.getParent(L);if(this.isInsertBefore(A,L,R,I,J)){var E=null;var C=L;while(C.parent!=null&&C.geometry!=null&&C.geometry.relative&&C.parent!=A.parent){C=this.graph.model.getParent(C)}if(C!=null&&C.parent!=null&&C.parent==A.parent){var E=C.parent.getIndex(C);C.parent.insert(A,E)}}var M=F.getGeometry(A);if(M==null){M=new mxGeometry();M.relative=true;F.setGeometry(A,M)}if(this.waypoints!=null&&this.waypoints.length>0){var B=this.graph.view.scale;var N=this.graph.view.translate;M.points=[];for(var G=0;G<this.waypoints.length;G++){var Q=this.waypoints[G];M.points.push(new mxPoint(Q.x/B-N.x,Q.y/B-N.y))}}if(R==null){var D=this.graph.view.translate;var B=this.graph.view.scale;var Q=(this.originalPoint!=null)?new mxPoint(this.originalPoint.x/B-D.x,this.originalPoint.y/B-D.y):new mxPoint(this.currentPoint.x/B-D.x,this.currentPoint.y/B-D.y);Q.x-=this.graph.panDx/this.graph.view.scale;Q.y-=this.graph.panDy/this.graph.view.scale;M.setTerminalPoint(Q,false)}this.fireEvent(new mxEventObject(mxEvent.CONNECT,"cell",A,"terminal",R,"event",I,"target",J,"terminalInserted",H))}}catch(K){mxLog.show();mxLog.debug(K.message)}finally{F.endUpdate()}if(this.select){this.selectCells(A,(H)?R:null)}}};mxConnectionHandler.prototype.selectCells=function(A,B){this.graph.setSelectionCell(A)};mxConnectionHandler.prototype.insertEdge=function(F,G,E,A,D,C){if(this.factoryMethod==null){return this.graph.insertEdge(F,G,E,A,D,C)}else{var B=this.createEdge(E,A,D,C);B=this.graph.addEdge(B,F,A,D);return B}};mxConnectionHandler.prototype.createTargetVertex=function(B,G){var K=this.graph.getCellGeometry(G);while(K!=null&&K.relative){G=this.graph.getModel().getParent(G);K=this.graph.getCellGeometry(G)}var C=this.graph.cloneCells([G])[0];var K=this.graph.getModel().getGeometry(C);if(K!=null){var E=this.graph.view.translate;var A=this.graph.view.scale;var J=new mxPoint(this.currentPoint.x/A-E.x,this.currentPoint.y/A-E.y);K.x=Math.round(J.x-K.width/2-this.graph.panDx/A);K.y=Math.round(J.y-K.height/2-this.graph.panDy/A);var D=this.getAlignmentTolerance();if(D>0){var F=this.graph.view.getState(G);if(F!=null){var H=F.x/A-E.x;var I=F.y/A-E.y;if(Math.abs(H-K.x)<=D){K.x=Math.round(H)}if(Math.abs(I-K.y)<=D){K.y=Math.round(I)}}}}return C};mxConnectionHandler.prototype.getAlignmentTolerance=function(A){return(this.graph.isGridEnabled())?this.graph.gridSize/2:this.graph.tolerance};mxConnectionHandler.prototype.createEdge=function(D,A,E,C){var B=null;if(this.factoryMethod!=null){B=this.factoryMethod(A,E,C)}if(B==null){B=new mxCell(D||"");B.setEdge(true);B.setStyle(C);var F=new mxGeometry();F.relative=true;B.setGeometry(F)}return B};mxConnectionHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.marker!=null){this.marker.destroy();this.marker=null}if(this.constraintHandler!=null){this.constraintHandler.destroy();this.constraintHandler=null}if(this.changeHandler!=null){this.graph.getModel().removeListener(this.changeHandler);this.graph.getView().removeListener(this.changeHandler);this.changeHandler=null}if(this.drillHandler!=null){this.graph.removeListener(this.drillHandler);this.graph.getView().removeListener(this.drillHandler);this.drillHandler=null}if(this.escapeHandler!=null){this.graph.removeListener(this.escapeHandler);this.escapeHandler=null}};function mxConstraintHandler(A){this.graph=A;this.resetHandler=mxUtils.bind(this,function(B,C){if(this.currentFocus!=null&&this.graph.view.getState(this.currentFocus.cell)==null){this.reset()}else{this.redraw()}});this.graph.model.addListener(mxEvent.CHANGE,this.resetHandler);this.graph.view.addListener(mxEvent.SCALE,this.resetHandler);this.graph.addListener(mxEvent.ROOT,this.resetHandler)}mxConstraintHandler.prototype.pointImage=new mxImage(mxClient.imageBasePath+"/point.gif",5,5);mxConstraintHandler.prototype.graph=null;mxConstraintHandler.prototype.enabled=true;mxConstraintHandler.prototype.highlightColor=mxConstants.DEFAULT_VALID_COLOR;mxConstraintHandler.prototype.isEnabled=function(){return this.enabled};mxConstraintHandler.prototype.setEnabled=function(A){this.enabled=A};mxConstraintHandler.prototype.reset=function(){if(this.focusIcons!=null){for(var A=0;A<this.focusIcons.length;A++){this.focusIcons[A].destroy()}this.focusIcons=null}if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}this.currentConstraint=null;this.currentFocusArea=null;this.currentPoint=null;this.currentFocus=null;this.focusPoints=null};mxConstraintHandler.prototype.getTolerance=function(A){return this.graph.getTolerance()};mxConstraintHandler.prototype.getImageForConstraint=function(C,B,A){return this.pointImage};mxConstraintHandler.prototype.isEventIgnored=function(B,A){return false};mxConstraintHandler.prototype.isStateIgnored=function(B,A){return false};mxConstraintHandler.prototype.destroyIcons=function(){if(this.focusIcons!=null){for(var A=0;A<this.focusIcons.length;A++){this.focusIcons[A].destroy()}this.focusIcons=null;this.focusPoints=null}};mxConstraintHandler.prototype.destroyFocusHighlight=function(){if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}};mxConstraintHandler.prototype.isKeepFocusEvent=function(A){return mxEvent.isShiftDown(A.getEvent())};mxConstraintHandler.prototype.getCellForEvent=function(B,A){var C=B.getCell();if(C==null&&A!=null&&(B.getGraphX()!=A.x||B.getGraphY()!=A.y)){C=this.graph.getCellAt(A.x,A.y)}if(C!=null&&!this.graph.isCellConnectable(C)){var D=this.graph.getModel().getParent(C);if(this.graph.getModel().isVertex(D)&&this.graph.isCellConnectable(D)){C=D}}return C};mxConstraintHandler.prototype.update=function(I,K,E,C){if(this.isEnabled()&&!this.isEventIgnored(I)){if(this.mouseleaveHandler==null&&this.graph.container!=null){this.mouseleaveHandler=mxUtils.bind(this,function(){this.reset()});mxEvent.addListener(this.graph.container,"mouseleave",this.resetHandler)}var Q=this.getTolerance(I);var O=(C!=null)?C.x:I.getGraphX();var P=(C!=null)?C.y:I.getGraphY();var B=new mxRectangle(O-Q,P-Q,2*Q,2*Q);var A=new mxRectangle(I.getGraphX()-Q,I.getGraphY()-Q,2*Q,2*Q);var H=this.graph.view.getState(this.getCellForEvent(I,C));if(!this.isKeepFocusEvent(I)&&(this.currentFocusArea==null||this.currentFocus==null||(H!=null)||!this.graph.getModel().isVertex(this.currentFocus.cell)||!mxUtils.intersects(this.currentFocusArea,A))&&(H!=this.currentFocus)){this.currentFocusArea=null;this.currentFocus=null;this.setFocus(I,H,K)}this.currentConstraint=null;this.currentPoint=null;var S=null;if(this.focusIcons!=null&&this.constraints!=null&&(H==null||this.currentFocus==H)){var F=A.getCenterX();var M=A.getCenterY();for(var G=0;G<this.focusIcons.length;G++){var J=F-this.focusIcons[G].bounds.getCenterX();var N=M-this.focusIcons[G].bounds.getCenterY();var D=J*J+N*N;if((this.intersects(this.focusIcons[G],A,K,E)||(C!=null&&this.intersects(this.focusIcons[G],B,K,E)))&&(S==null||D<S)){this.currentConstraint=this.constraints[G];this.currentPoint=this.focusPoints[G];S=D;var D=this.focusIcons[G].bounds.clone();D.grow(mxConstants.HIGHLIGHT_SIZE);if(mxClient.IS_IE){D.grow(1);D.width-=1;D.height-=1}if(this.focusHighlight==null){var L=this.createHighlightShape();L.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;L.pointerEvents=false;L.init(this.graph.getView().getOverlayPane());this.focusHighlight=L;var R=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:H});mxEvent.redirectMouseEvents(L.node,this.graph,R)}this.focusHighlight.bounds=D;this.focusHighlight.redraw()}}}if(this.currentConstraint==null){this.destroyFocusHighlight()}}else{this.currentConstraint=null;this.currentFocus=null;this.currentPoint=null}};mxConstraintHandler.prototype.redraw=function(){if(this.currentFocus!=null&&this.constraints!=null&&this.focusIcons!=null){var E=this.graph.view.getState(this.currentFocus.cell);this.currentFocus=E;this.currentFocusArea=new mxRectangle(E.x,E.y,E.width,E.height);for(var A=0;A<this.constraints.length;A++){var C=this.graph.getConnectionPoint(E,this.constraints[A]);var D=this.getImageForConstraint(E,this.constraints[A],C);var B=new mxRectangle(Math.round(C.x-D.width/2),Math.round(C.y-D.height/2),D.width,D.height);this.focusIcons[A].bounds=B;this.focusIcons[A].redraw();this.currentFocusArea.add(this.focusIcons[A].bounds);this.focusPoints[A]=C}}};mxConstraintHandler.prototype.setFocus=function(G,C,F){this.constraints=(C!=null&&!this.isStateIgnored(C,F)&&this.graph.isCellConnectable(C.cell))?((this.isEnabled())?(this.graph.getAllConnectionConstraints(C,F)||[]):[]):null;if(this.constraints!=null){this.currentFocus=C;this.currentFocusArea=new mxRectangle(C.x,C.y,C.width,C.height);if(this.focusIcons!=null){for(var E=0;E<this.focusIcons.length;E++){this.focusIcons[E].destroy()}this.focusIcons=null;this.focusPoints=null}this.focusPoints=[];this.focusIcons=[];for(var E=0;E<this.constraints.length;E++){var J=this.graph.getConnectionPoint(C,this.constraints[E]);var A=this.getImageForConstraint(C,this.constraints[E],J);var I=A.src;var B=new mxRectangle(Math.round(J.x-A.width/2),Math.round(J.y-A.height/2),A.width,A.height);var D=new mxImageShape(B,I);D.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;D.preserveImageAspect=false;D.init(this.graph.getView().getDecoratorPane());if(mxClient.IS_QUIRKS||document.documentMode==8){mxEvent.addListener(D.node,"dragstart",function(K){mxEvent.consume(K);return false})}if(D.node.previousSibling!=null){D.node.parentNode.insertBefore(D.node,D.node.parentNode.firstChild)}var H=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:C});D.redraw();mxEvent.redirectMouseEvents(D.node,this.graph,H);this.currentFocusArea.add(D.bounds);this.focusIcons.push(D);this.focusPoints.push(J)}this.currentFocusArea.grow(this.getTolerance(G))}else{this.destroyIcons();this.destroyFocusHighlight()}};mxConstraintHandler.prototype.createHighlightShape=function(){var A=new mxRectangleShape(null,this.highlightColor,this.highlightColor,mxConstants.HIGHLIGHT_STROKEWIDTH);A.opacity=mxConstants.HIGHLIGHT_OPACITY;return A};mxConstraintHandler.prototype.intersects=function(C,D,B,A){return mxUtils.intersects(C.bounds,D)};mxConstraintHandler.prototype.destroy=function(){this.reset();if(this.resetHandler!=null){this.graph.model.removeListener(this.resetHandler);this.graph.view.removeListener(this.resetHandler);this.graph.removeListener(this.resetHandler);this.resetHandler=null}if(this.mouseleaveHandler!=null&&this.graph.container!=null){mxEvent.removeListener(this.graph.container,"mouseleave",this.mouseleaveHandler);this.mouseleaveHandler=null}};function mxRubberband(A){if(A!=null){this.graph=A;this.graph.addMouseListener(this);this.forceRubberbandHandler=mxUtils.bind(this,function(C,D){var F=D.getProperty("eventName");var E=D.getProperty("event");if(F==mxEvent.MOUSE_DOWN&&this.isForceRubberbandEvent(E)){var B=mxUtils.getOffset(this.graph.container);var G=mxUtils.getScrollOrigin(this.graph.container);G.x-=B.x;G.y-=B.y;this.start(E.getX()+G.x,E.getY()+G.y);E.consume(false)}});this.graph.addListener(mxEvent.FIRE_MOUSE_EVENT,this.forceRubberbandHandler);this.panHandler=mxUtils.bind(this,function(){this.repaint()});this.graph.addListener(mxEvent.PAN,this.panHandler);this.gestureHandler=mxUtils.bind(this,function(B,C){if(this.first!=null){this.reset()}});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler);if(mxClient.IS_IE){mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()}))}}}mxRubberband.prototype.defaultOpacity=20;mxRubberband.prototype.enabled=true;mxRubberband.prototype.div=null;mxRubberband.prototype.sharedDiv=null;mxRubberband.prototype.currentX=0;mxRubberband.prototype.currentY=0;mxRubberband.prototype.isEnabled=function(){return this.enabled};mxRubberband.prototype.setEnabled=function(A){this.enabled=A};mxRubberband.prototype.isForceRubberbandEvent=function(A){return mxEvent.isAltDown(A.getEvent())};mxRubberband.prototype.mouseDown=function(B,C){if(!C.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&C.getState()==null&&!mxEvent.isMultiTouchEvent(C.getEvent())){var A=mxUtils.getOffset(this.graph.container);var D=mxUtils.getScrollOrigin(this.graph.container);D.x-=A.x;D.y-=A.y;this.start(C.getX()+D.x,C.getY()+D.y);C.consume(false)}};mxRubberband.prototype.start=function(C,D){this.first=new mxPoint(C,D);var B=this.graph.container;function A(F){var G=new mxMouseEvent(F);var E=mxUtils.convertPoint(B,G.getX(),G.getY());G.graphX=E.x;G.graphY=E.y;return G}this.dragHandler=mxUtils.bind(this,function(E){this.mouseMove(this.graph,A(E))});this.dropHandler=mxUtils.bind(this,function(E){this.mouseUp(this.graph,A(E))});if(mxClient.IS_FF){mxEvent.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}};mxRubberband.prototype.mouseMove=function(I,F){if(!F.isConsumed()&&this.first!=null){var C=mxUtils.getScrollOrigin(this.graph.container);var A=mxUtils.getOffset(this.graph.container);C.x-=A.x;C.y-=A.y;var G=F.getX()+C.x;var H=F.getY()+C.y;var D=this.first.x-G;var E=this.first.y-H;var B=this.graph.tolerance;if(this.div!=null||Math.abs(D)>B||Math.abs(E)>B){if(this.div==null){this.div=this.createShape()}mxUtils.clearSelection();this.update(G,H);F.consume()}}};mxRubberband.prototype.createShape=function(){if(this.sharedDiv==null){this.sharedDiv=document.createElement("div");this.sharedDiv.className="mxRubberband";mxUtils.setOpacity(this.sharedDiv,this.defaultOpacity)}this.graph.container.appendChild(this.sharedDiv);return this.sharedDiv};mxRubberband.prototype.isActive=function(A,B){return this.div!=null&&this.div.style.display!="none"};mxRubberband.prototype.mouseUp=function(A,C){var B=this.isActive();this.reset();if(B){this.execute(C.getEvent());C.consume()}};mxRubberband.prototype.execute=function(A){var B=new mxRectangle(this.x,this.y,this.width,this.height);this.graph.selectRegion(B,A)};mxRubberband.prototype.reset=function(){if(this.div!=null){this.div.parentNode.removeChild(this.div)}mxEvent.removeGestureListeners(document,null,this.dragHandler,this.dropHandler);this.dragHandler=null;this.dropHandler=null;this.currentX=0;this.currentY=0;this.first=null;this.div=null};mxRubberband.prototype.update=function(A,B){this.currentX=A;this.currentY=B;this.repaint()};mxRubberband.prototype.repaint=function(){if(this.div!=null){var C=this.currentX-this.graph.panDx;var D=this.currentY-this.graph.panDy;this.x=Math.min(this.first.x,C);this.y=Math.min(this.first.y,D);this.width=Math.max(this.first.x,C)-this.x;this.height=Math.max(this.first.y,D)-this.y;var B=(mxClient.IS_VML)?this.graph.panDx:0;var A=(mxClient.IS_VML)?this.graph.panDy:0;this.div.style.left=(this.x+B)+"px";this.div.style.top=(this.y+A)+"px";this.div.style.width=Math.max(1,this.width)+"px";this.div.style.height=Math.max(1,this.height)+"px"}};mxRubberband.prototype.destroy=function(){if(!this.destroyed){this.destroyed=true;this.graph.removeMouseListener(this);this.graph.removeListener(this.forceRubberbandHandler);this.graph.removeListener(this.panHandler);this.reset();if(this.sharedDiv!=null){this.sharedDiv=null}}};function mxHandle(C,A,B){this.graph=C.view.graph;this.state=C;this.cursor=(A!=null)?A:this.cursor;this.image=(B!=null)?B:this.image;this.init()}mxHandle.prototype.cursor="default";mxHandle.prototype.image=null;mxHandle.prototype.ignoreGrid=false;mxHandle.prototype.getPosition=function(A){};mxHandle.prototype.setPosition=function(A,B,C){};mxHandle.prototype.execute=function(){};mxHandle.prototype.copyStyle=function(A){this.graph.setCellStyles(A,this.state.style[A],[this.state.cell])};mxHandle.prototype.processEvent=function(D){var F=this.graph.view.scale;var C=this.graph.view.translate;var B=new mxPoint(D.getGraphX()/F-C.x,D.getGraphY()/F-C.y);if(this.shape!=null&&this.shape.bounds!=null){B.x-=this.shape.bounds.width/F/4;B.y-=this.shape.bounds.height/F/4}var A=-mxUtils.toRadians(this.getRotation());var E=-mxUtils.toRadians(this.getTotalRotation())-A;B=this.flipPoint(this.rotatePoint(this.snapPoint(this.rotatePoint(B,A),this.ignoreGrid||!this.graph.isGridEnabledEvent(D.getEvent())),E));this.setPosition(this.state.getPaintBounds(),B,D);this.positionChanged();this.redraw()};mxHandle.prototype.positionChanged=function(){if(this.state.text!=null){this.state.text.apply(this.state)}if(this.state.shape!=null){this.state.shape.apply(this.state)}this.graph.cellRenderer.redraw(this.state,true)};mxHandle.prototype.getRotation=function(){if(this.state.shape!=null){return this.state.shape.getRotation()}return 0};mxHandle.prototype.getTotalRotation=function(){if(this.state.shape!=null){return this.state.shape.getShapeRotation()}return 0};mxHandle.prototype.init=function(){var A=this.isHtmlRequired();if(this.image!=null){this.shape=new mxImageShape(new mxRectangle(0,0,this.image.width,this.image.height),this.image.src);this.shape.preserveImageAspect=false}else{this.shape=this.createShape(A)}this.initShape(A)};mxHandle.prototype.createShape=function(A){var B=new mxRectangle(0,0,mxConstants.HANDLE_SIZE,mxConstants.HANDLE_SIZE);return new mxRectangleShape(B,mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)};mxHandle.prototype.initShape=function(A){if(A&&this.shape.isHtmlAllowed()){this.shape.dialect=mxConstants.DIALECT_STRICTHTML;this.shape.init(this.graph.container)}else{this.shape.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;if(this.cursor!=null){this.shape.init(this.graph.getView().getOverlayPane())}}mxEvent.redirectMouseEvents(this.shape.node,this.graph,this.state);this.shape.node.style.cursor=this.cursor};mxHandle.prototype.redraw=function(){if(this.shape!=null&&this.state.shape!=null){var B=this.getPosition(this.state.getPaintBounds());if(B!=null){var D=mxUtils.toRadians(this.getTotalRotation());B=this.rotatePoint(this.flipPoint(B),D);var A=this.graph.view.scale;var C=this.graph.view.translate;this.shape.bounds.x=Math.floor((B.x+C.x)*A-this.shape.bounds.width/2);this.shape.bounds.y=Math.floor((B.y+C.y)*A-this.shape.bounds.height/2);this.state.unscaledWidth=null;this.shape.redraw()}}};mxHandle.prototype.isHtmlRequired=function(){return this.state.text!=null&&this.state.text.node.parentNode==this.graph.container};mxHandle.prototype.rotatePoint=function(C,D){var F=this.state.getCellBounds();var E=new mxPoint(F.getCenterX(),F.getCenterY());var B=Math.cos(D);var A=Math.sin(D);return mxUtils.getRotatedPoint(C,B,A,E)};mxHandle.prototype.flipPoint=function(A){if(this.state.shape!=null){var B=this.state.getCellBounds();if(this.state.shape.flipH){A.x=2*B.x+B.width-A.x}if(this.state.shape.flipV){A.y=2*B.y+B.height-A.y}}return A};mxHandle.prototype.snapPoint=function(A,B){if(!B){A.x=this.graph.snap(A.x);A.y=this.graph.snap(A.y)}return A};mxHandle.prototype.setVisible=function(A){if(this.shape!=null&&this.shape.node!=null){this.shape.node.style.display=(A)?"":"none"}};mxHandle.prototype.reset=function(){this.setVisible(true);this.state.style=this.graph.getCellStyle(this.state.cell);this.positionChanged()};mxHandle.prototype.destroy=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}};function mxVertexHandler(A){if(A!=null){this.state=A;this.init();this.escapeHandler=mxUtils.bind(this,function(B,C){if(this.livePreview&&this.index!=null){this.state.view.graph.cellRenderer.redraw(this.state,true);this.state.view.invalidate(this.state.cell);this.state.invalid=false;this.state.view.validate()}this.reset()});this.state.view.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxVertexHandler.prototype.graph=null;mxVertexHandler.prototype.state=null;mxVertexHandler.prototype.singleSizer=false;mxVertexHandler.prototype.index=null;mxVertexHandler.prototype.allowHandleBoundsCheck=true;mxVertexHandler.prototype.handleImage=null;mxVertexHandler.prototype.tolerance=0;mxVertexHandler.prototype.rotationEnabled=false;mxVertexHandler.prototype.parentHighlightEnabled=false;mxVertexHandler.prototype.rotationRaster=true;mxVertexHandler.prototype.rotationCursor="crosshair";mxVertexHandler.prototype.livePreview=false;mxVertexHandler.prototype.manageSizers=false;mxVertexHandler.prototype.constrainGroupByChildren=false;mxVertexHandler.prototype.rotationHandleVSpacing=-16;mxVertexHandler.prototype.horizontalOffset=0;mxVertexHandler.prototype.verticalOffset=0;mxVertexHandler.prototype.init=function(){this.graph=this.state.view.graph;this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.selectionBorder=this.createSelectionShape(this.bounds);this.selectionBorder.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.selectionBorder.pointerEvents=false;this.selectionBorder.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0");this.selectionBorder.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(this.selectionBorder.node,this.graph,this.state);if(this.graph.isCellMovable(this.state.cell)){this.selectionBorder.setCursor(mxConstants.CURSOR_MOVABLE_VERTEX)}if(mxGraphHandler.prototype.maxCells<=0||this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells){var A=this.graph.isCellResizable(this.state.cell);this.sizers=[];if(A||(this.graph.isLabelMovable(this.state.cell)&&this.state.width>=2&&this.state.height>=2)){var B=0;if(A){if(!this.singleSizer){this.sizers.push(this.createSizer("nw-resize",B++));this.sizers.push(this.createSizer("n-resize",B++));this.sizers.push(this.createSizer("ne-resize",B++));this.sizers.push(this.createSizer("w-resize",B++));this.sizers.push(this.createSizer("e-resize",B++));this.sizers.push(this.createSizer("sw-resize",B++));this.sizers.push(this.createSizer("s-resize",B++))}this.sizers.push(this.createSizer("se-resize",B++))}var C=this.graph.model.getGeometry(this.state.cell);if(C!=null&&!C.relative&&!this.graph.isSwimlane(this.state.cell)&&this.graph.isLabelMovable(this.state.cell)){this.labelShape=this.createSizer(mxConstants.CURSOR_LABEL_HANDLE,mxEvent.LABEL_HANDLE,mxConstants.LABEL_HANDLE_SIZE,mxConstants.LABEL_HANDLE_FILLCOLOR);this.sizers.push(this.labelShape)}}else{if(this.graph.isCellMovable(this.state.cell)&&!this.graph.isCellResizable(this.state.cell)&&this.state.width<2&&this.state.height<2){this.labelShape=this.createSizer(mxConstants.CURSOR_MOVABLE_VERTEX,mxEvent.LABEL_HANDLE,null,mxConstants.LABEL_HANDLE_FILLCOLOR);this.sizers.push(this.labelShape)}}}if(this.isRotationHandleVisible()){this.rotationShape=this.createSizer(this.rotationCursor,mxEvent.ROTATION_HANDLE,mxConstants.HANDLE_SIZE+3,mxConstants.HANDLE_FILLCOLOR);this.sizers.push(this.rotationShape)}this.customHandles=this.createCustomHandles();this.redraw();if(this.constrainGroupByChildren){this.updateMinBounds()}};mxVertexHandler.prototype.isRotationHandleVisible=function(){return this.graph.isEnabled()&&this.rotationEnabled&&this.graph.isCellRotatable(this.state.cell)&&(mxGraphHandler.prototype.maxCells<=0||this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells)&&this.state.width>=2&&this.state.height>=2};mxVertexHandler.prototype.isConstrainedEvent=function(A){return mxEvent.isShiftDown(A.getEvent())||this.state.style[mxConstants.STYLE_ASPECT]=="fixed"};mxVertexHandler.prototype.isCenteredEvent=function(B,A){return false};mxVertexHandler.prototype.createCustomHandles=function(){return null};mxVertexHandler.prototype.updateMinBounds=function(){var C=this.graph.getChildCells(this.state.cell);if(C.length>0){this.minBounds=this.graph.view.getBounds(C);if(this.minBounds!=null){var A=this.state.view.scale;var B=this.state.view.translate;this.minBounds.x-=this.state.x;this.minBounds.y-=this.state.y;this.minBounds.x/=A;this.minBounds.y/=A;this.minBounds.width/=A;this.minBounds.height/=A;this.x0=this.state.x/A-B.x;this.y0=this.state.y/A-B.y}}};mxVertexHandler.prototype.getSelectionBounds=function(A){return new mxRectangle(Math.round(A.x),Math.round(A.y),Math.round(A.width),Math.round(A.height))};mxVertexHandler.prototype.createParentHighlightShape=function(A){return this.createSelectionShape(A)};mxVertexHandler.prototype.createSelectionShape=function(A){var B=new mxRectangleShape(A,null,this.getSelectionColor());B.strokewidth=this.getSelectionStrokeWidth();B.isDashed=this.isSelectionDashed();return B};mxVertexHandler.prototype.getSelectionColor=function(){return mxConstants.VERTEX_SELECTION_COLOR};mxVertexHandler.prototype.getSelectionStrokeWidth=function(){return mxConstants.VERTEX_SELECTION_STROKEWIDTH};mxVertexHandler.prototype.isSelectionDashed=function(){return mxConstants.VERTEX_SELECTION_DASHED};mxVertexHandler.prototype.createSizer=function(A,D,C,E){C=C||mxConstants.HANDLE_SIZE;var F=new mxRectangle(0,0,C,C);var B=this.createSizerShape(F,D,E);if(B.isHtmlAllowed()&&this.state.text!=null&&this.state.text.node.parentNode==this.graph.container){B.bounds.height-=1;B.bounds.width-=1;B.dialect=mxConstants.DIALECT_STRICTHTML;B.init(this.graph.container)}else{B.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;B.init(this.graph.getView().getOverlayPane())}mxEvent.redirectMouseEvents(B.node,this.graph,this.state);if(this.graph.isEnabled()){B.setCursor(A)}if(!this.isSizerVisible(D)){B.visible=false}return B};mxVertexHandler.prototype.isSizerVisible=function(A){return true};mxVertexHandler.prototype.createSizerShape=function(A,B,C){if(this.handleImage!=null){A=new mxRectangle(A.x,A.y,this.handleImage.width,this.handleImage.height);var D=new mxImageShape(A,this.handleImage.src);D.preserveImageAspect=false;return D}else{if(B==mxEvent.ROTATION_HANDLE){return new mxEllipse(A,C||mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}else{return new mxRectangleShape(A,C||mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}}};mxVertexHandler.prototype.moveSizerTo=function(C,A,B){if(C!=null){C.bounds.x=Math.floor(A-C.bounds.width/2);C.bounds.y=Math.floor(B-C.bounds.height/2);if(C.node!=null&&C.node.style.display!="none"){C.redraw()}}};mxVertexHandler.prototype.getHandleForEvent=function(C){var E=(!mxEvent.isMouseEvent(C.getEvent()))?this.tolerance:1;var D=(this.allowHandleBoundsCheck&&(mxClient.IS_IE||E>0))?new mxRectangle(C.getGraphX()-E,C.getGraphY()-E,2*E,2*E):null;function B(F){return F!=null&&(C.isSource(F)||(D!=null&&mxUtils.intersects(F.bounds,D)&&F.node.style.display!="none"&&F.node.style.visibility!="hidden"))}if(this.customHandles!=null&&this.isCustomHandleEvent(C)){for(var A=this.customHandles.length-1;A>=0;A--){if(B(this.customHandles[A].shape)){return mxEvent.CUSTOM_HANDLE-A}}}if(B(this.rotationShape)){return mxEvent.ROTATION_HANDLE}else{if(B(this.labelShape)){return mxEvent.LABEL_HANDLE}}if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(B(this.sizers[A])){return A}}}return null};mxVertexHandler.prototype.isCustomHandleEvent=function(A){return true};mxVertexHandler.prototype.mouseDown=function(B,C){var D=(!mxEvent.isMouseEvent(C.getEvent()))?this.tolerance:0;if(!C.isConsumed()&&this.graph.isEnabled()&&(D>0||C.getState()==this.state)){var A=this.getHandleForEvent(C);if(A!=null){this.start(C.getGraphX(),C.getGraphY(),A);C.consume()}}};mxVertexHandler.prototype.isLivePreviewBorder=function(){return this.state.shape!=null&&this.state.shape.fill==null&&this.state.shape.stroke==null};mxVertexHandler.prototype.start=function(E,F,B){this.inTolerance=true;this.childOffsetX=0;this.childOffsetY=0;this.index=B;this.startX=E;this.startY=F;var H=this.state.view.graph.model;var G=H.getParent(this.state.cell);if(this.state.view.currentRoot!=G&&(H.isVertex(G)||H.isEdge(G))){this.parentState=this.state.view.graph.view.getState(G)}this.selectionBorder.node.style.display=(B==mxEvent.ROTATION_HANDLE)?"inline":"none";if(!this.livePreview||this.isLivePreviewBorder()){this.preview=this.createSelectionShape(this.bounds);if(!(mxClient.IS_SVG&&Number(this.state.style[mxConstants.STYLE_ROTATION]||"0")!=0)&&this.state.text!=null&&this.state.text.node.parentNode==this.graph.container){this.preview.dialect=mxConstants.DIALECT_STRICTHTML;this.preview.init(this.graph.container)}else{this.preview.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.preview.init(this.graph.view.getOverlayPane())}}if(this.livePreview){this.hideSizers();if(B==mxEvent.ROTATION_HANDLE){this.rotationShape.node.style.display=""}else{if(B==mxEvent.LABEL_HANDLE){this.labelShape.node.style.display=""}else{if(this.sizers!=null&&this.sizers[B]!=null){this.sizers[B].node.style.display=""}else{if(B<=mxEvent.CUSTOM_HANDLE&&this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-B].setVisible(true)}}}}var A=this.graph.getEdges(this.state.cell);this.edgeHandlers=[];for(var D=0;D<A.length;D++){var C=this.graph.selectionCellsHandler.getHandler(A[D]);if(C!=null){this.edgeHandlers.push(C)}}}};mxVertexHandler.prototype.setHandlesVisible=function(B){if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){this.sizers[A].node.style.display=(B)?"":"none"}}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].setVisible(B)}}};mxVertexHandler.prototype.hideSizers=function(){this.setHandlesVisible(false)};mxVertexHandler.prototype.checkTolerance=function(A){if(this.inTolerance&&this.startX!=null&&this.startY!=null){if(mxEvent.isMouseEvent(A.getEvent())||Math.abs(A.getGraphX()-this.startX)>this.graph.tolerance||Math.abs(A.getGraphY()-this.startY)>this.graph.tolerance){this.inTolerance=false}}};mxVertexHandler.prototype.updateHint=function(A){};mxVertexHandler.prototype.removeHint=function(){};mxVertexHandler.prototype.roundAngle=function(A){return Math.round(A*10)/10};mxVertexHandler.prototype.roundLength=function(A){return Math.round(A)};mxVertexHandler.prototype.mouseMove=function(A,B){if(!B.isConsumed()&&this.index!=null){this.checkTolerance(B);if(!this.inTolerance){if(this.index<=mxEvent.CUSTOM_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].processEvent(B)}}else{if(this.index==mxEvent.LABEL_HANDLE){this.moveLabel(B)}else{if(this.index==mxEvent.ROTATION_HANDLE){this.rotateVertex(B)}else{this.resizeVertex(B)}}}this.updateHint(B)}B.consume()}else{if(!this.graph.isMouseDown&&this.getHandleForEvent(B)!=null){B.consume(false)}}};mxVertexHandler.prototype.moveLabel=function(C){var A=new mxPoint(C.getGraphX(),C.getGraphY());var B=this.graph.view.translate;var E=this.graph.view.scale;if(this.graph.isGridEnabledEvent(C.getEvent())){A.x=(this.graph.snap(A.x/E-B.x)+B.x)*E;A.y=(this.graph.snap(A.y/E-B.y)+B.y)*E}var D=(this.rotationShape!=null)?this.sizers.length-2:this.sizers.length-1;this.moveSizerTo(this.sizers[D],A.x,A.y)};mxVertexHandler.prototype.rotateVertex=function(D){var B=new mxPoint(D.getGraphX(),D.getGraphY());var C=this.state.x+this.state.width/2-B.x;var E=this.state.y+this.state.height/2-B.y;this.currentAlpha=(C!=0)?Math.atan(E/C)*180/Math.PI+90:((E<0)?180:0);if(C>0){this.currentAlpha-=180}if(this.rotationRaster&&this.graph.isGridEnabledEvent(D.getEvent())){var C=B.x-this.state.getCenterX();var E=B.y-this.state.getCenterY();var A=Math.abs(Math.sqrt(C*C+E*E)-20)*3;var F=Math.max(1,5*Math.min(3,Math.max(0,Math.round(80/Math.abs(A)))));this.currentAlpha=Math.round(this.currentAlpha/F)*F}else{this.currentAlpha=this.roundAngle(this.currentAlpha)}this.selectionBorder.rotation=this.currentAlpha;this.selectionBorder.redraw();if(this.livePreview){this.redrawHandles()}};mxVertexHandler.prototype.resizeVertex=function(A){var D=new mxPoint(this.state.getCenterX(),this.state.getCenterY());var O=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var B=new mxPoint(A.getGraphX(),A.getGraphY());var Q=this.graph.view.translate;var N=this.graph.view.scale;var R=Math.cos(-O);var V=Math.sin(-O);var I=B.x-this.startX;var T=B.y-this.startY;var X=R*I-V*T;var L=V*I+R*T;I=X;T=L;var P=this.graph.getCellGeometry(this.state.cell);this.unscaledBounds=this.union(P,I/N,T/N,this.index,this.graph.isGridEnabledEvent(A.getEvent()),1,new mxPoint(0,0),this.isConstrainedEvent(A),this.isCenteredEvent(this.state,A));if(!P.relative){var W=this.graph.getMaximumGraphBounds();if(W!=null&&this.parentState!=null){W=mxRectangle.fromRectangle(W);W.x-=(this.parentState.x-Q.x*N)/N;W.y-=(this.parentState.y-Q.y*N)/N}if(this.graph.isConstrainChild(this.state.cell)){var C=this.graph.getCellContainmentArea(this.state.cell);if(C!=null){var K=this.graph.getOverlap(this.state.cell);if(K>0){C=mxRectangle.fromRectangle(C);C.x-=C.width*K;C.y-=C.height*K;C.width+=2*C.width*K;C.height+=2*C.height*K}if(W==null){W=C}else{W=mxRectangle.fromRectangle(W);W.intersect(C)}}}if(W!=null){if(this.unscaledBounds.x<W.x){this.unscaledBounds.width-=W.x-this.unscaledBounds.x;this.unscaledBounds.x=W.x}if(this.unscaledBounds.y<W.y){this.unscaledBounds.height-=W.y-this.unscaledBounds.y;this.unscaledBounds.y=W.y}if(this.unscaledBounds.x+this.unscaledBounds.width>W.x+W.width){this.unscaledBounds.width-=this.unscaledBounds.x+this.unscaledBounds.width-W.x-W.width}if(this.unscaledBounds.y+this.unscaledBounds.height>W.y+W.height){this.unscaledBounds.height-=this.unscaledBounds.y+this.unscaledBounds.height-W.y-W.height}}}this.bounds=new mxRectangle(((this.parentState!=null)?this.parentState.x:Q.x*N)+(this.unscaledBounds.x)*N,((this.parentState!=null)?this.parentState.y:Q.y*N)+(this.unscaledBounds.y)*N,this.unscaledBounds.width*N,this.unscaledBounds.height*N);if(P.relative&&this.parentState!=null){this.bounds.x+=this.state.x-this.parentState.x;this.bounds.y+=this.state.y-this.parentState.y}R=Math.cos(O);V=Math.sin(O);var M=new mxPoint(this.bounds.getCenterX(),this.bounds.getCenterY());var I=M.x-D.x;var T=M.y-D.y;var J=R*I-V*T;var G=V*I+R*T;var U=J-I;var H=G-T;var Y=this.bounds.x-this.state.x;var E=this.bounds.y-this.state.y;var S=R*Y-V*E;var F=V*Y+R*E;this.bounds.x+=U;this.bounds.y+=H;this.unscaledBounds.x=this.roundLength(this.unscaledBounds.x+U/N);this.unscaledBounds.y=this.roundLength(this.unscaledBounds.y+H/N);this.unscaledBounds.width=this.roundLength(this.unscaledBounds.width);this.unscaledBounds.height=this.roundLength(this.unscaledBounds.height);if(!this.graph.isCellCollapsed(this.state.cell)&&(U!=0||H!=0)){this.childOffsetX=this.state.x-this.bounds.x+S;this.childOffsetY=this.state.y-this.bounds.y+F}else{this.childOffsetX=0;this.childOffsetY=0}if(this.livePreview){this.updateLivePreview(A)}if(this.preview!=null){this.drawPreview()}};mxVertexHandler.prototype.updateLivePreview=function(D){var F=this.graph.view.scale;var C=this.graph.view.translate;var G=this.state.clone();this.state.x=this.bounds.x;this.state.y=this.bounds.y;this.state.origin=new mxPoint(this.state.x/F-C.x,this.state.y/F-C.y);this.state.width=this.bounds.width;this.state.height=this.bounds.height;this.state.unscaledWidth=null;var A=this.state.absoluteOffset;A=new mxPoint(A.x,A.y);this.state.absoluteOffset.x=0;this.state.absoluteOffset.y=0;var B=this.graph.getCellGeometry(this.state.cell);if(B!=null){var E=B.offset||this.EMPTY_POINT;if(E!=null&&!B.relative){this.state.absoluteOffset.x=this.state.view.scale*E.x;this.state.absoluteOffset.y=this.state.view.scale*E.y}this.state.view.updateVertexLabelOffset(this.state)}this.state.view.graph.cellRenderer.redraw(this.state,true);this.state.view.invalidate(this.state.cell);this.state.invalid=false;this.state.view.validate();this.redrawHandles();this.state.setState(G)};mxVertexHandler.prototype.mouseUp=function(N,J){if(this.index!=null&&this.state!=null){var L=new mxPoint(J.getGraphX(),J.getGraphY());this.graph.getModel().beginUpdate();try{if(this.index<=mxEvent.CUSTOM_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].execute()}}else{if(this.index==mxEvent.ROTATION_HANDLE){if(this.currentAlpha!=null){var K=this.currentAlpha-(this.state.style[mxConstants.STYLE_ROTATION]||0);if(K!=0){this.rotateCell(this.state.cell,K)}}else{this.rotateClick()}}else{var D=this.graph.isGridEnabledEvent(J.getEvent());var F=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(-F);var E=Math.sin(-F);var H=L.x-this.startX;var I=L.y-this.startY;var A=G*H-E*I;var M=E*H+G*I;H=A;I=M;var B=this.graph.view.scale;var C=this.isRecursiveResize(this.state,J);this.resizeCell(this.state.cell,this.roundLength(H/B),this.roundLength(I/B),this.index,D,this.isConstrainedEvent(J),C)}}}finally{this.graph.getModel().endUpdate()}J.consume();this.reset()}};mxVertexHandler.prototype.isRecursiveResize=function(B,A){return this.graph.isRecursiveResize(this.state)};mxVertexHandler.prototype.rotateClick=function(){};mxVertexHandler.prototype.rotateCell=function(K,F,I){if(F!=0){var J=this.graph.getModel();if(J.isVertex(K)||J.isEdge(K)){if(!J.isEdge(K)){var C=this.graph.view.getState(K);var D=(C!=null)?C.style:this.graph.getCellStyle(K);if(D!=null){var E=(D[mxConstants.STYLE_ROTATION]||0)+F;this.graph.setCellStyles(mxConstants.STYLE_ROTATION,E,[K])}}var B=this.graph.getCellGeometry(K);if(B!=null){var H=this.graph.getCellGeometry(I);if(H!=null&&!J.isEdge(I)){B=B.clone();B.rotate(F,new mxPoint(H.width/2,H.height/2));J.setGeometry(K,B)}if((J.isVertex(K)&&!B.relative)||J.isEdge(K)){var A=J.getChildCount(K);for(var G=0;G<A;G++){this.rotateCell(J.getChildAt(K,G),F,K)}}}}}};mxVertexHandler.prototype.reset=function(){if(this.sizers!=null&&this.index!=null&&this.sizers[this.index]!=null&&this.sizers[this.index].node.style.display=="none"){this.sizers[this.index].node.style.display=""}this.currentAlpha=null;this.inTolerance=null;this.index=null;if(this.preview!=null){this.preview.destroy();this.preview=null}if(this.livePreview&&this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(this.sizers[A]!=null){this.sizers[A].node.style.display=""}}}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].reset()}}if(this.selectionBorder!=null){this.selectionBorder.node.style.display="inline";this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.drawPreview()}this.removeHint();this.redrawHandles();this.edgeHandlers=null;this.unscaledBounds=null};mxVertexHandler.prototype.resizeCell=function(I,G,E,B,C,F,D){var H=this.graph.model.getGeometry(I);if(H!=null){if(B==mxEvent.LABEL_HANDLE){var A=this.graph.view.scale;G=Math.round((this.labelShape.bounds.getCenterX()-this.startX)/A);E=Math.round((this.labelShape.bounds.getCenterY()-this.startY)/A);H=H.clone();if(H.offset==null){H.offset=new mxPoint(G,E)}else{H.offset.x+=G;H.offset.y+=E}this.graph.model.setGeometry(I,H)}else{if(this.unscaledBounds!=null){var A=this.graph.view.scale;if(this.childOffsetX!=0||this.childOffsetY!=0){this.moveChildren(I,Math.round(this.childOffsetX/A),Math.round(this.childOffsetY/A))}this.graph.resizeCell(I,this.unscaledBounds,D)}}}};mxVertexHandler.prototype.moveChildren=function(H,E,D){var G=this.graph.getModel();var A=G.getChildCount(H);for(var C=0;C<A;C++){var B=G.getChildAt(H,C);var F=this.graph.getCellGeometry(B);if(F!=null){F=F.clone();F.translate(E,D);G.setGeometry(B,F)}}};mxVertexHandler.prototype.union=function(T,H,V,D,M,O,Q,A,L){if(this.singleSizer){var Y=T.x+T.width+H;var Z=T.y+T.height+V;if(M){Y=this.graph.snap(Y/O)*O;Z=this.graph.snap(Z/O)*O}var K=new mxRectangle(T.x,T.y,0,0);K.add(new mxRectangle(Y,Z,0,0));return K}else{var N=T.width;var R=T.height;var W=T.x-Q.x*O;var G=W+N;var U=T.y-Q.y*O;var S=U+R;var E=W+N/2;var F=U+R/2;if(D>4){S=S+V;if(M){S=this.graph.snap(S/O)*O}}else{if(D<3){U=U+V;if(M){U=this.graph.snap(U/O)*O}}}if(D==0||D==3||D==5){W+=H;if(M){W=this.graph.snap(W/O)*O}}else{if(D==2||D==4||D==7){G+=H;if(M){G=this.graph.snap(G/O)*O}}}var P=G-W;var a=S-U;if(A){var J=this.graph.getCellGeometry(this.state.cell);if(J!=null){var X=J.width/J.height;if(D==1||D==2||D==7||D==6){P=a*X}else{a=P/X}if(D==0){W=G-P;U=S-a}}}if(L){P+=(P-N);a+=(a-R);var C=E-(W+P/2);var B=F-(U+a/2);W+=C;U+=B;G+=C;S+=B}if(P<0){W+=P;P=Math.abs(P)}if(a<0){U+=a;a=Math.abs(a)}var I=new mxRectangle(W+Q.x*O,U+Q.y*O,P,a);if(this.minBounds!=null){I.width=Math.max(I.width,this.minBounds.x*O+this.minBounds.width*O+Math.max(0,this.x0*O-I.x));I.height=Math.max(I.height,this.minBounds.y*O+this.minBounds.height*O+Math.max(0,this.y0*O-I.y))}return I}};mxVertexHandler.prototype.redraw=function(){this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.redrawHandles();this.drawPreview()};mxVertexHandler.prototype.getHandlePadding=function(){var A=new mxPoint(0,0);var B=this.tolerance;if(this.sizers!=null&&this.sizers.length>0&&this.sizers[0]!=null&&(this.bounds.width<2*this.sizers[0].bounds.width+2*B||this.bounds.height<2*this.sizers[0].bounds.height+2*B)){B/=2;A.x=this.sizers[0].bounds.width+B;A.y=this.sizers[0].bounds.height+B}return A};mxVertexHandler.prototype.redrawHandles=function(){var E=this.tolerance;this.horizontalOffset=0;this.verticalOffset=0;var B=this.bounds;if(this.sizers!=null&&this.sizers.length>0&&this.sizers[0]!=null){if(this.index==null&&this.manageSizers&&this.sizers.length>=8){var D=this.getHandlePadding();this.horizontalOffset=D.x;this.verticalOffset=D.y;if(this.horizontalOffset!=0||this.verticalOffset!=0){B=new mxRectangle(B.x,B.y,B.width,B.height);B.x-=this.horizontalOffset/2;B.width+=this.horizontalOffset;B.y-=this.verticalOffset/2;B.height+=this.verticalOffset}if(this.sizers.length>=8){if((B.width<2*this.sizers[0].bounds.width+2*E)||(B.height<2*this.sizers[0].bounds.height+2*E)){this.sizers[0].node.style.display="none";this.sizers[2].node.style.display="none";this.sizers[5].node.style.display="none";this.sizers[7].node.style.display="none"}else{this.sizers[0].node.style.display="";this.sizers[2].node.style.display="";this.sizers[5].node.style.display="";this.sizers[7].node.style.display=""}}}var A=B.x+B.width;var N=B.y+B.height;if(this.singleSizer){this.moveSizerTo(this.sizers[0],A,N)}else{var K=B.x+B.width/2;var H=B.y+B.height/2;if(this.sizers.length>=8){var I=["nw-resize","n-resize","ne-resize","e-resize","se-resize","s-resize","sw-resize","w-resize"];var J=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(J);var F=Math.sin(J);var C=Math.round(J*4/Math.PI);var O=new mxPoint(B.getCenterX(),B.getCenterY());var M=mxUtils.getRotatedPoint(new mxPoint(B.x,B.y),G,F,O);this.moveSizerTo(this.sizers[0],M.x,M.y);this.sizers[0].setCursor(I[mxUtils.mod(0+C,I.length)]);M.x=K;M.y=B.y;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[1],M.x,M.y);this.sizers[1].setCursor(I[mxUtils.mod(1+C,I.length)]);M.x=A;M.y=B.y;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[2],M.x,M.y);this.sizers[2].setCursor(I[mxUtils.mod(2+C,I.length)]);M.x=B.x;M.y=H;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[3],M.x,M.y);this.sizers[3].setCursor(I[mxUtils.mod(7+C,I.length)]);M.x=A;M.y=H;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[4],M.x,M.y);this.sizers[4].setCursor(I[mxUtils.mod(3+C,I.length)]);M.x=B.x;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[5],M.x,M.y);this.sizers[5].setCursor(I[mxUtils.mod(6+C,I.length)]);M.x=K;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[6],M.x,M.y);this.sizers[6].setCursor(I[mxUtils.mod(5+C,I.length)]);M.x=A;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[7],M.x,M.y);this.sizers[7].setCursor(I[mxUtils.mod(4+C,I.length)]);this.moveSizerTo(this.sizers[8],K+this.state.absoluteOffset.x,H+this.state.absoluteOffset.y)}else{if(this.state.width>=2&&this.state.height>=2){this.moveSizerTo(this.sizers[0],K+this.state.absoluteOffset.x,H+this.state.absoluteOffset.y)}else{this.moveSizerTo(this.sizers[0],this.state.x,this.state.y)}}}}if(this.rotationShape!=null){var J=mxUtils.toRadians((this.currentAlpha!=null)?this.currentAlpha:this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(J);var F=Math.sin(J);var O=new mxPoint(this.state.getCenterX(),this.state.getCenterY());var M=mxUtils.getRotatedPoint(new mxPoint(B.x+B.width/2,B.y+this.rotationHandleVSpacing),G,F,O);if(this.rotationShape.node!=null){this.moveSizerTo(this.rotationShape,M.x,M.y)}}if(this.selectionBorder!=null){this.selectionBorder.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0")}if(this.edgeHandlers!=null){for(var L=0;L<this.edgeHandlers.length;L++){this.edgeHandlers[L].redraw()}}if(this.customHandles!=null){for(var L=0;L<this.customHandles.length;L++){this.customHandles[L].redraw()}}this.updateParentHighlight()};mxVertexHandler.prototype.updateParentHighlight=function(){if(this.selectionBorder!=null){if(this.parentHighlight!=null){var B=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(B)){var C=this.graph.view.getState(B);var A=this.parentHighlight.bounds;if(C!=null&&(A.x!=C.x||A.y!=C.y||A.width!=C.width||A.height!=C.height)){this.parentHighlight.bounds=C;this.parentHighlight.redraw()}}else{this.parentHighlight.destroy();this.parentHighlight=null}}else{if(this.parentHighlightEnabled){var B=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(B)){var C=this.graph.view.getState(B);if(C!=null){this.parentHighlight=this.createParentHighlightShape(C);this.parentHighlight.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.parentHighlight.pointerEvents=false;this.parentHighlight.rotation=Number(C.style[mxConstants.STYLE_ROTATION]||"0");this.parentHighlight.init(this.graph.getView().getOverlayPane())}}}}}};mxVertexHandler.prototype.drawPreview=function(){if(this.preview!=null){this.preview.bounds=this.bounds;if(this.preview.node.parentNode==this.graph.container){this.preview.bounds.width=Math.max(0,this.preview.bounds.width-1);this.preview.bounds.height=Math.max(0,this.preview.bounds.height-1)}this.preview.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0");this.preview.redraw()}this.selectionBorder.bounds=this.bounds;this.selectionBorder.redraw();if(this.parentHighlight!=null){this.parentHighlight.redraw()}};mxVertexHandler.prototype.destroy=function(){if(this.escapeHandler!=null){this.state.view.graph.removeListener(this.escapeHandler);this.escapeHandler=null}if(this.preview!=null){this.preview.destroy();this.preview=null}if(this.parentHighlight!=null){this.parentHighlight.destroy();this.parentHighlight=null}if(this.selectionBorder!=null){this.selectionBorder.destroy();this.selectionBorder=null}this.labelShape=null;this.removeHint();if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){this.sizers[A].destroy()}this.sizers=null}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].destroy()}this.customHandles=null}};function mxEdgeHandler(A){if(A!=null){this.state=A;this.init();this.escapeHandler=mxUtils.bind(this,function(B,C){this.reset()});this.state.view.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxEdgeHandler.prototype.graph=null;mxEdgeHandler.prototype.state=null;mxEdgeHandler.prototype.marker=null;mxEdgeHandler.prototype.constraintHandler=null;mxEdgeHandler.prototype.error=null;mxEdgeHandler.prototype.shape=null;mxEdgeHandler.prototype.bends=null;mxEdgeHandler.prototype.labelShape=null;mxEdgeHandler.prototype.cloneEnabled=true;mxEdgeHandler.prototype.addEnabled=false;mxEdgeHandler.prototype.removeEnabled=false;mxEdgeHandler.prototype.dblClickRemoveEnabled=false;mxEdgeHandler.prototype.mergeRemoveEnabled=false;mxEdgeHandler.prototype.straightRemoveEnabled=false;mxEdgeHandler.prototype.virtualBendsEnabled=false;mxEdgeHandler.prototype.virtualBendOpacity=20;mxEdgeHandler.prototype.parentHighlightEnabled=false;mxEdgeHandler.prototype.preferHtml=false;mxEdgeHandler.prototype.allowHandleBoundsCheck=true;mxEdgeHandler.prototype.snapToTerminals=false;mxEdgeHandler.prototype.handleImage=null;mxEdgeHandler.prototype.tolerance=0;mxEdgeHandler.prototype.outlineConnect=false;mxEdgeHandler.prototype.manageLabelHandle=false;mxEdgeHandler.prototype.init=function(){this.graph=this.state.view.graph;this.marker=this.createMarker();this.constraintHandler=new mxConstraintHandler(this.graph);this.points=[];this.abspoints=this.getSelectionPoints(this.state);this.shape=this.createSelectionShape(this.abspoints);this.shape.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;this.shape.init(this.graph.getView().getOverlayPane());this.shape.pointerEvents=false;this.shape.setCursor(mxConstants.CURSOR_MOVABLE_EDGE);mxEvent.redirectMouseEvents(this.shape.node,this.graph,this.state);this.preferHtml=this.state.text!=null&&this.state.text.node.parentNode==this.graph.container;if(!this.preferHtml){var A=this.state.getVisibleTerminalState(true);if(A!=null){this.preferHtml=A.text!=null&&A.text.node.parentNode==this.graph.container}if(!this.preferHtml){var B=this.state.getVisibleTerminalState(false);if(B!=null){this.preferHtml=B.text!=null&&B.text.node.parentNode==this.graph.container}}}if(this.parentHighlightEnabled){var C=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(C)){var D=this.graph.view.getState(C);if(D!=null){this.parentHighlight=this.createParentHighlightShape(D);this.parentHighlight.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.parentHighlight.pointerEvents=false;this.parentHighlight.rotation=Number(D.style[mxConstants.STYLE_ROTATION]||"0");this.parentHighlight.init(this.graph.getView().getOverlayPane())}}}if(this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells||mxGraphHandler.prototype.maxCells<=0){this.bends=this.createBends();if(this.isVirtualBendsEnabled()){this.virtualBends=this.createVirtualBends()}}this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y);this.labelShape=this.createLabelHandleShape();this.initBend(this.labelShape);this.labelShape.setCursor(mxConstants.CURSOR_LABEL_HANDLE);this.customHandles=this.createCustomHandles();this.redraw()};mxEdgeHandler.prototype.createCustomHandles=function(){return null};mxEdgeHandler.prototype.isVirtualBendsEnabled=function(A){return this.virtualBendsEnabled&&(this.state.style[mxConstants.STYLE_EDGE]==null||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.NONE||this.state.style[mxConstants.STYLE_NOEDGESTYLE]==1)&&mxUtils.getValue(this.state.style,mxConstants.STYLE_SHAPE,null)!="arrow"};mxEdgeHandler.prototype.isAddPointEvent=function(A){return mxEvent.isShiftDown(A)};mxEdgeHandler.prototype.isRemovePointEvent=function(A){return mxEvent.isShiftDown(A)};mxEdgeHandler.prototype.getSelectionPoints=function(A){return A.absolutePoints};mxEdgeHandler.prototype.createParentHighlightShape=function(A){var B=new mxRectangleShape(A,null,this.getSelectionColor());B.strokewidth=this.getSelectionStrokeWidth();B.isDashed=this.isSelectionDashed();return B};mxEdgeHandler.prototype.createSelectionShape=function(A){var B=new this.state.shape.constructor();B.outline=true;B.apply(this.state);B.isDashed=this.isSelectionDashed();B.stroke=this.getSelectionColor();B.isShadow=false;return B};mxEdgeHandler.prototype.getSelectionColor=function(){return mxConstants.EDGE_SELECTION_COLOR};mxEdgeHandler.prototype.getSelectionStrokeWidth=function(){return mxConstants.EDGE_SELECTION_STROKEWIDTH};mxEdgeHandler.prototype.isSelectionDashed=function(){return mxConstants.EDGE_SELECTION_DASHED};mxEdgeHandler.prototype.isConnectableCell=function(A){return true};mxEdgeHandler.prototype.getCellAt=function(A,B){return(!this.outlineConnect)?this.graph.getCellAt(A,B):null};mxEdgeHandler.prototype.createMarker=function(){var B=new mxCellMarker(this.graph);var A=this;B.getCell=function(C){var D=mxCellMarker.prototype.getCell.apply(this,arguments);if((D==A.state.cell||D==null)&&A.currentPoint!=null){D=A.graph.getCellAt(A.currentPoint.x,A.currentPoint.y)}if(D!=null&&!this.graph.isCellConnectable(D)){var F=this.graph.getModel().getParent(D);if(this.graph.getModel().isVertex(F)&&this.graph.isCellConnectable(F)){D=F}}var E=A.graph.getModel();if((this.graph.isSwimlane(D)&&A.currentPoint!=null&&this.graph.hitsSwimlaneContent(D,A.currentPoint.x,A.currentPoint.y))||(!A.isConnectableCell(D))||(D==A.state.cell||(D!=null&&!A.graph.connectableEdges&&E.isEdge(D)))||E.isAncestor(A.state.cell,D)){D=null}if(!this.graph.isCellConnectable(D)){D=null}return D};B.isValidState=function(H){var G=A.graph.getModel();var F=A.graph.view.getTerminalPort(H,A.graph.view.getState(G.getTerminal(A.state.cell,!A.isSource)),!A.isSource);var D=(F!=null)?F.cell:null;var C=(A.isSource)?H.cell:D;var E=(A.isSource)?D:H.cell;A.error=A.validateConnection(C,E);return A.error==null};return B};mxEdgeHandler.prototype.validateConnection=function(A,B){return this.graph.getEdgeValidationError(this.state.cell,A,B)};mxEdgeHandler.prototype.createBends=function(){var E=this.state.cell;var A=[];for(var B=0;B<this.abspoints.length;B++){if(this.isHandleVisible(B)){var C=B==0;var D=B==this.abspoints.length-1;var F=C||D;if(F||this.graph.isCellBendable(E)){(mxUtils.bind(this,function(H){var G=this.createHandleShape(H);this.initBend(G,mxUtils.bind(this,mxUtils.bind(this,function(){if(this.dblClickRemoveEnabled){this.removePoint(this.state,H)}})));if(this.isHandleEnabled(B)){G.setCursor((F)?mxConstants.CURSOR_TERMINAL_HANDLE:mxConstants.CURSOR_BEND_HANDLE)}A.push(G);if(!F){this.points.push(new mxPoint(0,0));G.node.style.visibility="hidden"}}))(B)}}}return A};mxEdgeHandler.prototype.createVirtualBends=function(){var D=this.state.cell;var C=this.abspoints[0];var A=[];if(this.graph.isCellBendable(D)){for(var B=1;B<this.abspoints.length;B++){(mxUtils.bind(this,function(E){this.initBend(E);E.setCursor(mxConstants.CURSOR_VIRTUAL_BEND_HANDLE);A.push(E)}))(this.createHandleShape())}}return A};mxEdgeHandler.prototype.isHandleEnabled=function(A){return true};mxEdgeHandler.prototype.isHandleVisible=function(C){var A=this.state.getVisibleTerminalState(true);var D=this.state.getVisibleTerminalState(false);var E=this.graph.getCellGeometry(this.state.cell);var B=(E!=null)?this.graph.view.getEdgeStyle(this.state,E.points,A,D):null;return B!=mxEdgeStyle.EntityRelation||C==0||C==this.abspoints.length-1};mxEdgeHandler.prototype.createHandleShape=function(B){if(this.handleImage!=null){var C=new mxImageShape(new mxRectangle(0,0,this.handleImage.width,this.handleImage.height),this.handleImage.src);C.preserveImageAspect=false;return C}else{var A=mxConstants.HANDLE_SIZE;if(this.preferHtml){A-=1}return new mxRectangleShape(new mxRectangle(0,0,A,A),mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}};mxEdgeHandler.prototype.createLabelHandleShape=function(){if(this.labelHandleImage!=null){var B=new mxImageShape(new mxRectangle(0,0,this.labelHandleImage.width,this.labelHandleImage.height),this.labelHandleImage.src);B.preserveImageAspect=false;return B}else{var A=mxConstants.LABEL_HANDLE_SIZE;return new mxRectangleShape(new mxRectangle(0,0,A,A),mxConstants.LABEL_HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}};mxEdgeHandler.prototype.initBend=function(A,B){if(this.preferHtml){A.dialect=mxConstants.DIALECT_STRICTHTML;A.init(this.graph.container)}else{A.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;A.init(this.graph.getView().getOverlayPane())}mxEvent.redirectMouseEvents(A.node,this.graph,this.state,null,null,null,B);if(mxClient.IS_QUIRKS||document.documentMode==8){mxEvent.addListener(A.node,"dragstart",function(C){mxEvent.consume(C);return false})}if(mxClient.IS_TOUCH){A.node.setAttribute("pointer-events","none")}};mxEdgeHandler.prototype.getHandleForEvent=function(D){var G=(!mxEvent.isMouseEvent(D.getEvent()))?this.tolerance:1;var E=(this.allowHandleBoundsCheck&&(mxClient.IS_IE||G>0))?new mxRectangle(D.getGraphX()-G,D.getGraphY()-G,2*G,2*G):null;var F=null;var C=null;function B(K){if(K!=null&&K.node.style.display!="none"&&K.node.style.visibility!="hidden"&&(D.isSource(K)||(E!=null&&mxUtils.intersects(K.bounds,E)))){var I=D.getGraphX()-K.bounds.getCenterX();var J=D.getGraphY()-K.bounds.getCenterY();var H=I*I+J*J;if(F==null||H<=F){F=H;return true}}return false}if(this.customHandles!=null&&this.isCustomHandleEvent(D)){for(var A=this.customHandles.length-1;A>=0;A--){if(B(this.customHandles[A].shape)){return mxEvent.CUSTOM_HANDLE-A}}}if(D.isSource(this.state.text)||B(this.labelShape)){C=mxEvent.LABEL_HANDLE}if(this.bends!=null){for(var A=0;A<this.bends.length;A++){if(B(this.bends[A])){C=A}}}if(this.virtualBends!=null&&this.isAddVirtualBendEvent(D)){for(var A=0;A<this.virtualBends.length;A++){if(B(this.virtualBends[A])){C=mxEvent.VIRTUAL_HANDLE-A}}}return C};mxEdgeHandler.prototype.isAddVirtualBendEvent=function(A){return true};mxEdgeHandler.prototype.isCustomHandleEvent=function(A){return true};mxEdgeHandler.prototype.mouseDown=function(B,C){var A=this.getHandleForEvent(C);if(this.bends!=null&&this.bends[A]!=null){var D=this.bends[A].bounds;this.snapPoint=new mxPoint(D.getCenterX(),D.getCenterY())}if(this.addEnabled&&A==null&&this.isAddPointEvent(C.getEvent())){this.addPoint(this.state,C.getEvent());C.consume()}else{if(A!=null&&!C.isConsumed()&&this.graph.isEnabled()){if(this.removeEnabled&&this.isRemovePointEvent(C.getEvent())){this.removePoint(this.state,A)}else{if(A!=mxEvent.LABEL_HANDLE||this.graph.isLabelMovable(C.getCell())){if(A<=mxEvent.VIRTUAL_HANDLE){mxUtils.setOpacity(this.virtualBends[mxEvent.VIRTUAL_HANDLE-A].node,100)}this.start(C.getX(),C.getY(),A)}}C.consume()}}};mxEdgeHandler.prototype.start=function(C,D,B){this.startX=C;this.startY=D;this.isSource=(this.bends==null)?false:B==0;this.isTarget=(this.bends==null)?false:B==this.bends.length-1;this.isLabel=B==mxEvent.LABEL_HANDLE;if(this.isSource||this.isTarget){var E=this.state.cell;var F=this.graph.model.getTerminal(E,this.isSource);if((F==null&&this.graph.isTerminalPointMovable(E,this.isSource))||(F!=null&&this.graph.isCellDisconnectable(E,F,this.isSource))){this.index=B}}else{this.index=B}if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){if(A!=mxEvent.CUSTOM_HANDLE-this.index){this.customHandles[A].setVisible(false)}}}}};mxEdgeHandler.prototype.clonePreviewState=function(A,B){return this.state.clone()};mxEdgeHandler.prototype.getSnapToTerminalTolerance=function(){return this.graph.gridSize*this.graph.view.scale/2};mxEdgeHandler.prototype.updateHint=function(B,A){};mxEdgeHandler.prototype.removeHint=function(){};mxEdgeHandler.prototype.roundLength=function(A){return Math.round(A)};mxEdgeHandler.prototype.isSnapToTerminalsEvent=function(A){return this.snapToTerminals&&!mxEvent.isAltDown(A.getEvent())};mxEdgeHandler.prototype.getPointForEvent=function(E){var A=this.graph.getView();var B=A.scale;var K=new mxPoint(this.roundLength(E.getGraphX()/B)*B,this.roundLength(E.getGraphY()/B)*B);var C=this.getSnapToTerminalTolerance();var I=false;var J=false;if(C>0&&this.isSnapToTerminalsEvent(E)){function G(L){if(L!=null){var M=L.x;if(Math.abs(K.x-M)<C){K.x=M;I=true}var N=L.y;if(Math.abs(K.y-N)<C){K.y=N;J=true}}}function F(L){if(L!=null){G.call(this,new mxPoint(A.getRoutingCenterX(L),A.getRoutingCenterY(L)))}}F.call(this,this.state.getVisibleTerminalState(true));F.call(this,this.state.getVisibleTerminalState(false));if(this.state.absolutePoints!=null){for(var H=0;H<this.state.absolutePoints.length;H++){G.call(this,this.state.absolutePoints[H])}}}if(this.graph.isGridEnabledEvent(E.getEvent())){var D=A.translate;if(!I){K.x=(this.graph.snap(K.x/B-D.x)+D.x)*B}if(!J){K.y=(this.graph.snap(K.y/B-D.y)+D.y)*B}}return K};mxEdgeHandler.prototype.getPreviewTerminalState=function(B){this.constraintHandler.update(B,this.isSource,true,B.isSource(this.marker.highlight.shape)?null:this.currentPoint);if(this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null){if(this.marker.highlight!=null&&this.marker.highlight.state!=null&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell){if(this.marker.highlight.shape.stroke!="transparent"){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint()}}else{this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent")}var F=this.graph.getModel();var G=this.graph.view.getTerminalPort(this.state,this.graph.view.getState(F.getTerminal(this.state.cell,!this.isSource)),!this.isSource);var C=(G!=null)?G.cell:null;var A=(this.isSource)?this.constraintHandler.currentFocus.cell:C;var E=(this.isSource)?C:this.constraintHandler.currentFocus.cell;this.error=this.validateConnection(A,E);var D=null;if(this.error==null){D=this.constraintHandler.currentFocus}else{this.constraintHandler.reset()}return D}else{if(!this.graph.isIgnoreTerminalEvent(B.getEvent())){this.marker.process(B);return this.marker.getValidState()}else{this.marker.reset();return null}}};mxEdgeHandler.prototype.getPreviewPoints=function(B,J){var G=this.graph.getCellGeometry(this.state.cell);var K=(G.points!=null)?G.points.slice():null;var L=new mxPoint(B.x,B.y);var C=null;if(!this.isSource&&!this.isTarget){this.convertPoint(L,false);if(K==null){K=[L]}else{if(this.index<=mxEvent.VIRTUAL_HANDLE){K.splice(mxEvent.VIRTUAL_HANDLE-this.index,0,L)}if(!this.isSource&&!this.isTarget){for(var H=0;H<this.bends.length;H++){if(H!=this.index){var M=this.bends[H];if(M!=null&&mxUtils.contains(M.bounds,B.x,B.y)){if(this.index<=mxEvent.VIRTUAL_HANDLE){K.splice(mxEvent.VIRTUAL_HANDLE-this.index,1)}else{K.splice(this.index-1,1)}C=K}}}if(C==null&&this.straightRemoveEnabled&&(J==null||!mxEvent.isAltDown(J.getEvent()))){var E=this.graph.tolerance*this.graph.tolerance;var I=this.state.absolutePoints.slice();I[this.index]=B;var D=this.state.getVisibleTerminalState(true);if(D!=null){var N=this.graph.getConnectionConstraint(this.state,D,true);if(N==null||this.graph.getConnectionPoint(D,N)==null){I[0]=new mxPoint(D.view.getRoutingCenterX(D),D.view.getRoutingCenterY(D))}}var F=this.state.getVisibleTerminalState(false);if(F!=null){var N=this.graph.getConnectionConstraint(this.state,F,false);if(N==null||this.graph.getConnectionPoint(F,N)==null){I[I.length-1]=new mxPoint(F.view.getRoutingCenterX(F),F.view.getRoutingCenterY(F))}}function A(P,O){if(P>0&&P<I.length-1&&mxUtils.ptSegDistSq(I[P-1].x,I[P-1].y,I[P+1].x,I[P+1].y,O.x,O.y)<E){K.splice(P-1,1);C=K}}A(this.index,B)}}if(C==null&&this.index>mxEvent.VIRTUAL_HANDLE){K[this.index-1]=L}}}else{if(this.graph.resetEdgesOnConnect){K=null}}return(C!=null)?C:K};mxEdgeHandler.prototype.isOutlineConnectEvent=function(H){var B=mxUtils.getOffset(this.graph.container);var A=H.getEvent();var E=mxEvent.getClientX(A);var F=mxEvent.getClientY(A);var G=document.documentElement;var D=(window.pageXOffset||G.scrollLeft)-(G.clientLeft||0);var C=(window.pageYOffset||G.scrollTop)-(G.clientTop||0);var I=this.currentPoint.x-this.graph.container.scrollLeft+B.x-D;var J=this.currentPoint.y-this.graph.container.scrollTop+B.y-C;return this.outlineConnect&&!mxEvent.isShiftDown(H.getEvent())&&(H.isSource(this.marker.highlight.shape)||(mxEvent.isAltDown(H.getEvent())&&H.getState()!=null)||this.marker.highlight.isHighlightAt(E,F)||((I!=E||J!=F)&&H.getState()==null&&this.marker.highlight.isHighlightAt(I,J)))};mxEdgeHandler.prototype.updatePreviewState=function(F,K,J,H,G){var D=(this.isSource)?J:this.state.getVisibleTerminalState(true);var E=(this.isTarget)?J:this.state.getVisibleTerminalState(false);var A=this.graph.getConnectionConstraint(F,D,true);var C=this.graph.getConnectionConstraint(F,E,false);var I=this.constraintHandler.currentConstraint;if(I==null&&G){if(J!=null){if(H.isSource(this.marker.highlight.shape)){K=new mxPoint(H.getGraphX(),H.getGraphY())}I=this.graph.getOutlineConstraint(K,J,H);this.constraintHandler.setFocus(H,J,this.isSource);this.constraintHandler.currentConstraint=I;this.constraintHandler.currentPoint=K}else{I=new mxConnectionConstraint()}}if(this.outlineConnect&&this.marker.highlight!=null&&this.marker.highlight.shape!=null){var B=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){this.marker.highlight.shape.stroke=(G)?mxConstants.OUTLINE_HIGHLIGHT_COLOR:"transparent";this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/B/B;this.marker.highlight.repaint()}else{if(this.marker.hasValidState()){this.marker.highlight.shape.stroke=(this.marker.getValidState()==H.getState())?mxConstants.DEFAULT_VALID_COLOR:"transparent";this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/B/B;this.marker.highlight.repaint()}}}if(this.isSource){A=I}else{if(this.isTarget){C=I}}if(this.isSource||this.isTarget){if(I!=null&&I.point!=null){F.style[(this.isSource)?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X]=I.point.x;F.style[(this.isSource)?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y]=I.point.y}else{delete F.style[(this.isSource)?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X];delete F.style[(this.isSource)?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y]}}F.setVisibleTerminalState(D,true);F.setVisibleTerminalState(E,false);if(!this.isSource||D!=null){F.view.updateFixedTerminalPoint(F,D,true,A)}if(!this.isTarget||E!=null){F.view.updateFixedTerminalPoint(F,E,false,C)}if((this.isSource||this.isTarget)&&J==null){F.setAbsoluteTerminalPoint(K,this.isSource);if(this.marker.getMarkedState()==null){this.error=(this.graph.allowDanglingEdges)?null:""}}F.view.updatePoints(F,this.points,D,E);F.view.updateFloatingTerminalPoints(F,D,E)};mxEdgeHandler.prototype.mouseMove=function(A,D){if(this.index!=null&&this.marker!=null){this.currentPoint=this.getPointForEvent(D);this.error=null;if(!this.graph.isIgnoreTerminalEvent(D.getEvent())&&mxEvent.isShiftDown(D.getEvent())&&this.snapPoint!=null){if(Math.abs(this.snapPoint.x-this.currentPoint.x)<Math.abs(this.snapPoint.y-this.currentPoint.y)){this.currentPoint.x=this.snapPoint.x}else{this.currentPoint.y=this.snapPoint.y}}if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].processEvent(D)}}else{if(this.isLabel){this.label.x=this.currentPoint.x;this.label.y=this.currentPoint.y}else{this.points=this.getPreviewPoints(this.currentPoint,D);var F=(this.isSource||this.isTarget)?this.getPreviewTerminalState(D):null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){this.currentPoint=this.constraintHandler.currentPoint.clone()}else{if(this.outlineConnect){var E=(this.isSource||this.isTarget)?this.isOutlineConnectEvent(D):false;if(E){F=this.marker.highlight.state}else{if(F!=null&&F!=D.getState()&&this.marker.highlight.shape!=null){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint();F=null}}}}var B=this.clonePreviewState(this.currentPoint,(F!=null)?F.cell:null);this.updatePreviewState(B,this.currentPoint,F,D,E);var C=(this.error==null)?this.marker.validColor:this.marker.invalidColor;this.setPreviewColor(C);this.abspoints=B.absolutePoints;this.active=true}}this.updateHint(D,this.currentPoint);this.drawPreview();mxEvent.consume(D.getEvent());D.consume()}else{if(mxClient.IS_IE&&this.getHandleForEvent(D)!=null){D.consume(false)}}};mxEdgeHandler.prototype.mouseUp=function(H,F){if(this.index!=null&&this.marker!=null){var E=this.state.cell;if(F.getX()!=this.startX||F.getY()!=this.startY){var B=!this.graph.isIgnoreTerminalEvent(F.getEvent())&&this.graph.isCloneEvent(F.getEvent())&&this.cloneEnabled&&this.graph.isCellsCloneable();if(this.error!=null){if(this.error.length>0){this.graph.validationAlert(this.error)}}else{if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){var G=this.graph.getModel();G.beginUpdate();try{this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].execute()}finally{G.endUpdate()}}}else{if(this.isLabel){this.moveLabel(this.state,this.label.x,this.label.y)}else{if(this.isSource||this.isTarget){var D=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){D=this.constraintHandler.currentFocus.cell}if(D==null&&this.marker.hasValidState()&&this.marker.highlight!=null&&this.marker.highlight.shape!=null&&this.marker.highlight.shape.stroke!="transparent"&&this.marker.highlight.shape.stroke!="white"){D=this.marker.validState.cell}if(D!=null){E=this.connect(E,D,this.isSource,B,F)}else{if(this.graph.isAllowDanglingEdges()){var A=this.abspoints[(this.isSource)?0:this.abspoints.length-1];A.x=this.roundLength(A.x/this.graph.view.scale-this.graph.view.translate.x);A.y=this.roundLength(A.y/this.graph.view.scale-this.graph.view.translate.y);var C=this.graph.getView().getState(this.graph.getModel().getParent(E));if(C!=null){A.x-=C.origin.x;A.y-=C.origin.y}A.x-=this.graph.panDx/this.graph.view.scale;A.y-=this.graph.panDy/this.graph.view.scale;E=this.changeTerminalPoint(E,A,this.isSource,B)}}}else{if(this.active){E=this.changePoints(E,this.points,B)}else{this.graph.getView().invalidate(this.state.cell);this.graph.getView().validate(this.state.cell)}}}}}}if(this.marker!=null){this.reset();if(E!=this.state.cell){this.graph.setSelectionCell(E)}}F.consume()}};mxEdgeHandler.prototype.reset=function(){this.error=null;this.index=null;this.label=null;this.points=null;this.snapPoint=null;this.active=false;this.isLabel=false;this.isSource=false;this.isTarget=false;if(this.livePreview&&this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(this.sizers[A]!=null){this.sizers[A].node.style.display=""}}}if(this.marker!=null){this.marker.reset()}if(this.constraintHandler!=null){this.constraintHandler.reset()}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].reset()}}this.setPreviewColor(mxConstants.EDGE_SELECTION_COLOR);this.removeHint();this.redraw()};mxEdgeHandler.prototype.setPreviewColor=function(A){if(this.shape!=null){this.shape.stroke=A}};mxEdgeHandler.prototype.convertPoint=function(B,A){var D=this.graph.getView().getScale();var C=this.graph.getView().getTranslate();if(A){B.x=this.graph.snap(B.x);B.y=this.graph.snap(B.y)}B.x=Math.round(B.x/D-C.x);B.y=Math.round(B.y/D-C.y);var E=this.graph.getView().getState(this.graph.getModel().getParent(this.state.cell));if(E!=null){B.x-=E.origin.x;B.y-=E.origin.y}return B};mxEdgeHandler.prototype.moveLabel=function(K,J,A){var L=this.graph.getModel();var G=L.getGeometry(K.cell);if(G!=null){var D=this.graph.getView().scale;G=G.clone();if(G.relative){var E=this.graph.getView().getRelativePoint(K,J,A);G.x=Math.round(E.x*10000)/10000;G.y=Math.round(E.y);G.offset=new mxPoint(0,0);var E=this.graph.view.getPoint(K,G);G.offset=new mxPoint(Math.round((J-E.x)/D),Math.round((A-E.y)/D))}else{var C=K.absolutePoints;var I=C[0];var B=C[C.length-1];if(I!=null&&B!=null){var H=I.x+(B.x-I.x)/2;var F=I.y+(B.y-I.y)/2;G.offset=new mxPoint(Math.round((J-H)/D),Math.round((A-F)/D));G.x=0;G.y=0}}L.setGeometry(K.cell,G)}};mxEdgeHandler.prototype.connect=function(E,D,G,A,F){var J=this.graph.getModel();var I=J.getParent(E);J.beginUpdate();try{if(A){var B=this.graph.cloneCells([E])[0];J.add(I,B,J.getChildCount(I));var C=J.getTerminal(E,!G);this.graph.connectCell(B,C,!G);E=B}var H=this.constraintHandler.currentConstraint;if(H==null){H=new mxConnectionConstraint()}this.graph.connectCell(E,D,G,H)}finally{J.endUpdate()}return E};mxEdgeHandler.prototype.changeTerminalPoint=function(D,F,E,A){var H=this.graph.getModel();H.beginUpdate();try{if(A){var G=H.getParent(D);var C=H.getTerminal(D,!E);D=this.graph.cloneCells([D])[0];H.add(G,D,H.getChildCount(G));H.setTerminal(D,C,!E)}var B=H.getGeometry(D);if(B!=null){B=B.clone();B.setTerminalPoint(F,E);H.setGeometry(D,B);this.graph.connectCell(D,null,E,new mxConnectionConstraint())}}finally{H.endUpdate()}return D};mxEdgeHandler.prototype.changePoints=function(C,F,A){var H=this.graph.getModel();H.beginUpdate();try{if(A){var G=H.getParent(C);var D=H.getTerminal(C,true);var E=H.getTerminal(C,false);C=this.graph.cloneCells([C])[0];H.add(G,C,H.getChildCount(G));H.setTerminal(C,D,true);H.setTerminal(C,E,false)}var B=H.getGeometry(C);if(B!=null){B=B.clone();B.points=F;H.setGeometry(C,B)}}finally{H.endUpdate()}return C};mxEdgeHandler.prototype.addPoint=function(D,C){var B=mxUtils.convertPoint(this.graph.container,mxEvent.getClientX(C),mxEvent.getClientY(C));var A=this.graph.isGridEnabledEvent(C);this.convertPoint(B,A);this.addPointAt(D,B.x,B.y);mxEvent.consume(C)};mxEdgeHandler.prototype.addPointAt=function(G,I,J){var K=this.graph.getCellGeometry(G.cell);var B=new mxPoint(I,J);if(K!=null){K=K.clone();var E=this.graph.view.translate;var D=this.graph.view.scale;var C=new mxPoint(E.x*D,E.y*D);var H=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(H)){var A=this.graph.view.getState(H);C=new mxPoint(A.x,A.y)}var F=mxUtils.findNearestSegment(G,B.x*D+C.x,B.y*D+C.y);if(K.points==null){K.points=[B]}else{K.points.splice(F,0,B)}this.graph.getModel().setGeometry(G.cell,K);this.refresh();this.redraw()}};mxEdgeHandler.prototype.removePoint=function(C,B){if(B>0&&B<this.abspoints.length-1){var A=this.graph.getCellGeometry(this.state.cell);if(A!=null&&A.points!=null){A=A.clone();A.points.splice(B-1,1);this.graph.getModel().setGeometry(C.cell,A);this.refresh();this.redraw()}}};mxEdgeHandler.prototype.getHandleFillColor=function(B){var A=B==0;var C=this.state.cell;var E=this.graph.getModel().getTerminal(C,A);var D=mxConstants.HANDLE_FILLCOLOR;if((E!=null&&!this.graph.isCellDisconnectable(C,E,A))||(E==null&&!this.graph.isTerminalPointMovable(C,A))){D=mxConstants.LOCKED_HANDLE_FILLCOLOR}else{if(E!=null&&this.graph.isCellDisconnectable(C,E,A)){D=mxConstants.CONNECT_HANDLE_FILLCOLOR}}return D};mxEdgeHandler.prototype.redraw=function(){this.abspoints=this.state.absolutePoints.slice();this.redrawHandles();var A=this.graph.getModel().getGeometry(this.state.cell);var C=A.points;if(this.bends!=null&&this.bends.length>0){if(C!=null){if(this.points==null){this.points=[]}for(var B=1;B<this.bends.length-1;B++){if(this.bends[B]!=null&&this.abspoints[B]!=null){this.points[B-1]=C[B-1]}}}}this.drawPreview()};mxEdgeHandler.prototype.redrawHandles=function(){var P=this.state.cell;var K=this.labelShape.bounds;this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y);this.labelShape.bounds=new mxRectangle(Math.round(this.label.x-K.width/2),Math.round(this.label.y-K.height/2),K.width,K.height);var N=this.graph.getLabel(P);this.labelShape.visible=(N!=null&&N.length>0&&this.graph.isLabelMovable(P));if(this.bends!=null&&this.bends.length>0){var H=this.abspoints.length-1;var J=this.abspoints[0];var C=J.x;var D=J.y;K=this.bends[0].bounds;this.bends[0].bounds=new mxRectangle(Math.floor(C-K.width/2),Math.floor(D-K.height/2),K.width,K.height);this.bends[0].fill=this.getHandleFillColor(0);this.bends[0].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[0].bounds)}var B=this.abspoints[H];var F=B.x;var G=B.y;var E=this.bends.length-1;K=this.bends[E].bounds;this.bends[E].bounds=new mxRectangle(Math.floor(F-K.width/2),Math.floor(G-K.height/2),K.width,K.height);this.bends[E].fill=this.getHandleFillColor(E);this.bends[E].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[E].bounds)}this.redrawInnerBends(J,B)}if(this.abspoints!=null&&this.virtualBends!=null&&this.virtualBends.length>0){var M=this.abspoints[0];for(var I=0;I<this.virtualBends.length;I++){if(this.virtualBends[I]!=null&&this.abspoints[I+1]!=null){var A=this.abspoints[I+1];var K=this.virtualBends[I];var L=M.x+(A.x-M.x)/2;var O=M.y+(A.y-M.y)/2;K.bounds=new mxRectangle(Math.floor(L-K.bounds.width/2),Math.floor(O-K.bounds.height/2),K.bounds.width,K.bounds.height);K.redraw();mxUtils.setOpacity(K.node,this.virtualBendOpacity);M=A;if(this.manageLabelHandle){this.checkLabelHandle(K.bounds)}}}}if(this.labelShape!=null){this.labelShape.redraw()}if(this.customHandles!=null){for(var I=0;I<this.customHandles.length;I++){this.customHandles[I].redraw()}}};mxEdgeHandler.prototype.setHandlesVisible=function(B){if(this.bends!=null){for(var A=0;A<this.bends.length;A++){this.bends[A].node.style.display=(B)?"":"none"}}if(this.virtualBends!=null){for(var A=0;A<this.virtualBends.length;A++){this.virtualBends[A].node.style.display=(B)?"":"none"}}if(this.labelShape!=null){this.labelShape.node.style.display=(B)?"":"none"}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].setVisible(B)}}};mxEdgeHandler.prototype.redrawInnerBends=function(B,F){for(var A=1;A<this.bends.length-1;A++){if(this.bends[A]!=null){if(this.abspoints[A]!=null){var C=this.abspoints[A].x;var D=this.abspoints[A].y;var E=this.bends[A].bounds;this.bends[A].node.style.visibility="visible";this.bends[A].bounds=new mxRectangle(Math.round(C-E.width/2),Math.round(D-E.height/2),E.width,E.height);if(this.manageLabelHandle){this.checkLabelHandle(this.bends[A].bounds)}else{if(this.handleImage==null&&this.labelShape.visible&&mxUtils.intersects(this.bends[A].bounds,this.labelShape.bounds)){w=mxConstants.HANDLE_SIZE+3;h=mxConstants.HANDLE_SIZE+3;this.bends[A].bounds=new mxRectangle(Math.round(C-w/2),Math.round(D-h/2),w,h)}}this.bends[A].redraw()}else{this.bends[A].destroy();this.bends[A]=null}}}};mxEdgeHandler.prototype.checkLabelHandle=function(B){if(this.labelShape!=null){var A=this.labelShape.bounds;if(mxUtils.intersects(B,A)){if(B.getCenterY()<A.getCenterY()){A.y=B.y+B.height}else{A.y=B.y-A.height}}}};mxEdgeHandler.prototype.drawPreview=function(){if(this.isLabel){var B=this.labelShape.bounds;var A=new mxRectangle(Math.round(this.label.x-B.width/2),Math.round(this.label.y-B.height/2),B.width,B.height);this.labelShape.bounds=A;this.labelShape.redraw()}else{if(this.shape!=null){this.shape.apply(this.state);this.shape.points=this.abspoints;this.shape.scale=this.state.view.scale;this.shape.isDashed=this.isSelectionDashed();this.shape.stroke=this.getSelectionColor();this.shape.strokewidth=this.getSelectionStrokeWidth()/this.shape.scale/this.shape.scale;this.shape.arrowStrokewidth=this.getSelectionStrokeWidth();this.shape.isShadow=false;this.shape.redraw()}}if(this.parentHighlight!=null){this.parentHighlight.redraw()}};mxEdgeHandler.prototype.refresh=function(){this.abspoints=this.getSelectionPoints(this.state);this.points=[];if(this.shape!=null){this.shape.points=this.abspoints}if(this.bends!=null){this.destroyBends(this.bends);this.bends=this.createBends()}if(this.virtualBends!=null){this.destroyBends(this.virtualBends);this.virtualBends=this.createVirtualBends()}if(this.customHandles!=null){this.destroyBends(this.customHandles);this.customHandles=this.createCustomHandles()}if(this.labelShape!=null&&this.labelShape.node!=null&&this.labelShape.node.parentNode!=null){this.labelShape.node.parentNode.appendChild(this.labelShape.node)}};mxEdgeHandler.prototype.destroyBends=function(A){if(A!=null){for(var B=0;B<A.length;B++){if(A[B]!=null){A[B].destroy()}}}};mxEdgeHandler.prototype.destroy=function(){if(this.escapeHandler!=null){this.state.view.graph.removeListener(this.escapeHandler);this.escapeHandler=null}if(this.marker!=null){this.marker.destroy();this.marker=null}if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.parentHighlight!=null){this.parentHighlight.destroy();this.parentHighlight=null}if(this.labelShape!=null){this.labelShape.destroy();this.labelShape=null}if(this.constraintHandler!=null){this.constraintHandler.destroy();this.constraintHandler=null}this.destroyBends(this.virtualBends);this.virtualBends=null;this.destroyBends(this.customHandles);this.customHandles=null;this.destroyBends(this.bends);this.bends=null;this.removeHint()};function mxElbowEdgeHandler(A){mxEdgeHandler.call(this,A)}mxUtils.extend(mxElbowEdgeHandler,mxEdgeHandler);mxElbowEdgeHandler.prototype.flipEnabled=true;mxElbowEdgeHandler.prototype.doubleClickOrientationResource=(mxClient.language!="none")?"doubleClickOrientation":"";mxElbowEdgeHandler.prototype.createBends=function(){var A=[];var B=this.createHandleShape(0);this.initBend(B);B.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(B);A.push(this.createVirtualBend(mxUtils.bind(this,function(C){if(!mxEvent.isConsumed(C)&&this.flipEnabled){this.graph.flipEdge(this.state.cell,C);mxEvent.consume(C)}})));this.points.push(new mxPoint(0,0));B=this.createHandleShape(2);this.initBend(B);B.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(B);return A};mxElbowEdgeHandler.prototype.createVirtualBend=function(B){var A=this.createHandleShape();this.initBend(A,B);A.setCursor(this.getCursorForBend());if(!this.graph.isCellBendable(this.state.cell)){A.node.style.display="none"}return A};mxElbowEdgeHandler.prototype.getCursorForBend=function(){return(this.state.style[mxConstants.STYLE_EDGE]==mxEdgeStyle.TopToBottom||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.EDGESTYLE_TOPTOBOTTOM||((this.state.style[mxConstants.STYLE_EDGE]==mxEdgeStyle.ElbowConnector||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.EDGESTYLE_ELBOW)&&this.state.style[mxConstants.STYLE_ELBOW]==mxConstants.ELBOW_VERTICAL))?"row-resize":"col-resize"};mxElbowEdgeHandler.prototype.getTooltipForNode=function(B){var A=null;if(this.bends!=null&&this.bends[1]!=null&&(B==this.bends[1].node||B.parentNode==this.bends[1].node)){A=this.doubleClickOrientationResource;A=mxResources.get(A)||A}return A};mxElbowEdgeHandler.prototype.convertPoint=function(B,A){var E=this.graph.getView().getScale();var C=this.graph.getView().getTranslate();var D=this.state.origin;if(A){B.x=this.graph.snap(B.x);B.y=this.graph.snap(B.y)}B.x=Math.round(B.x/E-C.x-D.x);B.y=Math.round(B.y/E-C.y-D.y);return B};mxElbowEdgeHandler.prototype.redrawInnerBends=function(G,C){var I=this.graph.getModel().getGeometry(this.state.cell);var A=this.state.absolutePoints;var B=null;if(A.length>1){G=A[1];C=A[A.length-2]}else{if(I.points!=null&&I.points.length>0){B=A[0]}}if(B==null){B=new mxPoint(G.x+(C.x-G.x)/2,G.y+(C.y-G.y)/2)}else{B=new mxPoint(this.graph.getView().scale*(B.x+this.graph.getView().translate.x+this.state.origin.x),this.graph.getView().scale*(B.y+this.graph.getView().translate.y+this.state.origin.y))}var H=this.bends[1].bounds;var E=H.width;var F=H.height;var D=new mxRectangle(Math.round(B.x-E/2),Math.round(B.y-F/2),E,F);if(this.manageLabelHandle){this.checkLabelHandle(D)}else{if(this.handleImage==null&&this.labelShape.visible&&mxUtils.intersects(D,this.labelShape.bounds)){E=mxConstants.HANDLE_SIZE+3;F=mxConstants.HANDLE_SIZE+3;D=new mxRectangle(Math.floor(B.x-E/2),Math.floor(B.y-F/2),E,F)}}this.bends[1].bounds=D;this.bends[1].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[1].bounds)}};function mxEdgeSegmentHandler(A){mxEdgeHandler.call(this,A)}mxUtils.extend(mxEdgeSegmentHandler,mxElbowEdgeHandler);mxEdgeSegmentHandler.prototype.getCurrentPoints=function(){var B=this.state.absolutePoints;if(B!=null){if(B.length==2||(B.length==3&&(B[0].x==B[1].x&&B[1].x==B[2].x||B[0].y==B[1].y&&B[1].y==B[2].y))){var C=B[0].x+(B[B.length-1].x-B[0].x)/2;var A=B[0].y+(B[B.length-1].y-B[0].y)/2;B=[B[0],new mxPoint(C,A),new mxPoint(C,A),B[B.length-1]]}}return B};mxEdgeSegmentHandler.prototype.getPreviewPoints=function(K){if(this.isSource||this.isTarget){return mxElbowEdgeHandler.prototype.getPreviewPoints.apply(this,arguments)}else{var A=this.getCurrentPoints();var F=this.convertPoint(A[0].clone(),false);K=this.convertPoint(K.clone(),false);var C=[];for(var E=1;E<A.length;E++){var B=this.convertPoint(A[E].clone(),false);if(E==this.index){if(Math.round(F.x-B.x)==0){F.x=K.x;B.x=K.x}if(Math.round(F.y-B.y)==0){F.y=K.y;B.y=K.y}}if(E<A.length-1){C.push(B)}F=B}if(C.length==1){var G=this.state.getVisibleTerminalState(true);var H=this.state.getVisibleTerminalState(false);var D=this.state.view.getScale();var I=this.state.view.getTranslate();var L=C[0].x*D+I.x;var J=C[0].y*D+I.y;if((G!=null&&mxUtils.contains(G,L,J))||(H!=null&&mxUtils.contains(H,L,J))){C=[K,K]}}return C}};mxEdgeSegmentHandler.prototype.updatePreviewState=function(A,B,C,I){mxEdgeHandler.prototype.updatePreviewState.apply(this,arguments);if(!this.isSource&&!this.isTarget){B=this.convertPoint(B.clone(),false);var D=A.absolutePoints;var K=D[0];var L=D[1];var E=[];for(var H=2;H<D.length;H++){var J=D[H];if((Math.round(K.x-L.x)!=0||Math.round(L.x-J.x)!=0)&&(Math.round(K.y-L.y)!=0||Math.round(L.y-J.y)!=0)){E.push(this.convertPoint(L.clone(),false))}K=L;L=J}var M=this.state.getVisibleTerminalState(true);var S=this.state.getVisibleTerminalState(false);var R=this.state.absolutePoints;if(E.length==0&&(Math.round(D[0].x-D[D.length-1].x)==0||Math.round(D[0].y-D[D.length-1].y)==0)){E=[B,B]}else{if(D.length==5&&E.length==2&&M!=null&&S!=null&&R!=null&&Math.round(R[0].x-R[R.length-1].x)==0){var Q=this.graph.getView();var O=Q.getScale();var P=Q.getTranslate();var G=Q.getRoutingCenterY(M)/O-P.y;var U=this.graph.getConnectionConstraint(A,M,true);if(U!=null){var N=this.graph.getConnectionPoint(M,U);if(N!=null){this.convertPoint(N,false);G=N.y}}var T=Q.getRoutingCenterY(S)/O-P.y;var F=this.graph.getConnectionConstraint(A,S,false);if(F){var N=this.graph.getConnectionPoint(S,F);if(N!=null){this.convertPoint(N,false);T=N.y}}E=[new mxPoint(B.x,G),new mxPoint(B.x,T)]}}this.points=E;A.view.updateFixedTerminalPoints(A,M,S);A.view.updatePoints(A,this.points,M,S);A.view.updateFloatingTerminalPoints(A,M,S)}};mxEdgeSegmentHandler.prototype.connect=function(I,F,K,B,J){var A=this.abspoints;var D=A[0];var E=A[1];var H=[];for(var G=2;G<A.length;G++){var C=A[G];if((Math.round(D.x-E.x)!=0||Math.round(E.x-C.x)!=0)&&(Math.round(D.y-E.y)!=0||Math.round(E.y-C.y)!=0)){H.push(this.convertPoint(E.clone(),false))}D=E;E=C}var M=this.graph.getModel();M.beginUpdate();try{var L=M.getGeometry(I);if(L!=null){L=L.clone();L.points=H;M.setGeometry(I,L)}I=mxEdgeHandler.prototype.connect.apply(this,arguments)}finally{M.endUpdate()}return I};mxEdgeSegmentHandler.prototype.getTooltipForNode=function(A){return null};mxEdgeSegmentHandler.prototype.start=function(B,C,A){mxEdgeHandler.prototype.start.apply(this,arguments);if(this.bends[A]!=null&&!this.isSource&&!this.isTarget){mxUtils.setOpacity(this.bends[A].node,100)}};mxEdgeSegmentHandler.prototype.createBends=function(){var A=[];var C=this.createHandleShape(0);this.initBend(C);C.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(C);var E=this.getCurrentPoints();if(this.graph.isCellBendable(this.state.cell)){if(this.points==null){this.points=[]}for(var B=0;B<E.length-1;B++){C=this.createVirtualBend();A.push(C);var D=Math.round(E[B].x-E[B+1].x)==0;if(Math.round(E[B].y-E[B+1].y)==0&&B<E.length-2){D=Math.round(E[B].x-E[B+2].x)==0}C.setCursor((D)?"col-resize":"row-resize");this.points.push(new mxPoint(0,0))}}var C=this.createHandleShape(E.length);this.initBend(C);C.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(C);return A};mxEdgeSegmentHandler.prototype.redraw=function(){this.refresh();mxEdgeHandler.prototype.redraw.apply(this,arguments)};mxEdgeSegmentHandler.prototype.redrawInnerBends=function(H,C){if(this.graph.isCellBendable(this.state.cell)){var A=this.getCurrentPoints();if(A!=null&&A.length>1){var D=false;if(A.length==4&&Math.round(A[1].x-A[2].x)==0&&Math.round(A[1].y-A[2].y)==0){D=true;if(Math.round(A[0].y-A[A.length-1].y)==0){var F=A[0].x+(A[A.length-1].x-A[0].x)/2;A[1]=new mxPoint(F,A[1].y);A[2]=new mxPoint(F,A[2].y)}else{var E=A[0].y+(A[A.length-1].y-A[0].y)/2;A[1]=new mxPoint(A[1].x,E);A[2]=new mxPoint(A[2].x,E)}}for(var G=0;G<A.length-1;G++){if(this.bends[G+1]!=null){var H=A[G];var C=A[G+1];var B=new mxPoint(H.x+(C.x-H.x)/2,H.y+(C.y-H.y)/2);var I=this.bends[G+1].bounds;this.bends[G+1].bounds=new mxRectangle(Math.floor(B.x-I.width/2),Math.floor(B.y-I.height/2),I.width,I.height);this.bends[G+1].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[G+1].bounds)}}}if(D){mxUtils.setOpacity(this.bends[1].node,this.virtualBendOpacity);mxUtils.setOpacity(this.bends[3].node,this.virtualBendOpacity)}}}};function mxKeyHandler(A,B){if(A!=null){this.graph=A;this.target=B||document.documentElement;this.normalKeys=[];this.shiftKeys=[];this.controlKeys=[];this.controlShiftKeys=[];this.keydownHandler=mxUtils.bind(this,function(C){this.keyDown(C)});mxEvent.addListener(this.target,"keydown",this.keydownHandler);if(mxClient.IS_IE){mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()}))}}}mxKeyHandler.prototype.graph=null;mxKeyHandler.prototype.target=null;mxKeyHandler.prototype.normalKeys=null;mxKeyHandler.prototype.shiftKeys=null;mxKeyHandler.prototype.controlKeys=null;mxKeyHandler.prototype.controlShiftKeys=null;mxKeyHandler.prototype.enabled=true;mxKeyHandler.prototype.isEnabled=function(){return this.enabled};mxKeyHandler.prototype.setEnabled=function(A){this.enabled=A};mxKeyHandler.prototype.bindKey=function(A,B){this.normalKeys[A]=B};mxKeyHandler.prototype.bindShiftKey=function(A,B){this.shiftKeys[A]=B};mxKeyHandler.prototype.bindControlKey=function(A,B){this.controlKeys[A]=B};mxKeyHandler.prototype.bindControlShiftKey=function(A,B){this.controlShiftKeys[A]=B};mxKeyHandler.prototype.isControlDown=function(A){return mxEvent.isControlDown(A)};mxKeyHandler.prototype.getFunction=function(A){if(A!=null&&!mxEvent.isAltDown(A)){if(this.isControlDown(A)){if(mxEvent.isShiftDown(A)){return this.controlShiftKeys[A.keyCode]}else{return this.controlKeys[A.keyCode]}}else{if(mxEvent.isShiftDown(A)){return this.shiftKeys[A.keyCode]}else{return this.normalKeys[A.keyCode]}}}return null};mxKeyHandler.prototype.isGraphEvent=function(B){var A=mxEvent.getSource(B);if((A==this.target||A.parentNode==this.target)||(this.graph.cellEditor!=null&&this.graph.cellEditor.isEventSource(B))){return true}return mxUtils.isAncestorNode(this.graph.container,A)};mxKeyHandler.prototype.keyDown=function(A){if(this.isEnabledForEvent(A)){if(A.keyCode==27){this.escape(A)}else{if(!this.isEventIgnored(A)){var B=this.getFunction(A);if(B!=null){B(A);mxEvent.consume(A)}}}}};mxKeyHandler.prototype.isEnabledForEvent=function(A){return(this.graph.isEnabled()&&!mxEvent.isConsumed(A)&&this.isGraphEvent(A)&&this.isEnabled())};mxKeyHandler.prototype.isEventIgnored=function(A){return this.graph.isEditing()};mxKeyHandler.prototype.escape=function(A){if(this.graph.isEscapeEnabled()){this.graph.escape(A)}};mxKeyHandler.prototype.destroy=function(){if(this.target!=null&&this.keydownHandler!=null){mxEvent.removeListener(this.target,"keydown",this.keydownHandler);this.keydownHandler=null}this.target=null};function mxTooltipHandler(A,B){if(A!=null){this.graph=A;this.delay=B||500;this.graph.addMouseListener(this)}}mxTooltipHandler.prototype.zIndex=10005;mxTooltipHandler.prototype.graph=null;mxTooltipHandler.prototype.delay=null;mxTooltipHandler.prototype.ignoreTouchEvents=true;mxTooltipHandler.prototype.hideOnHover=false;mxTooltipHandler.prototype.destroyed=false;mxTooltipHandler.prototype.enabled=true;mxTooltipHandler.prototype.isEnabled=function(){return this.enabled};mxTooltipHandler.prototype.setEnabled=function(A){this.enabled=A};mxTooltipHandler.prototype.isHideOnHover=function(){return this.hideOnHover};mxTooltipHandler.prototype.setHideOnHover=function(A){this.hideOnHover=A};mxTooltipHandler.prototype.init=function(){if(document.body!=null){this.div=document.createElement("div");this.div.className="mxTooltip";this.div.style.visibility="hidden";document.body.appendChild(this.div);mxEvent.addGestureListeners(this.div,mxUtils.bind(this,function(A){this.hideTooltip()}))}};mxTooltipHandler.prototype.mouseDown=function(A,B){this.reset(B,false);this.hideTooltip()};mxTooltipHandler.prototype.mouseMove=function(A,B){if(B.getX()!=this.lastX||B.getY()!=this.lastY){this.reset(B,true);if(this.isHideOnHover()||B.getState()!=this.state||(B.getSource()!=this.node&&(!this.stateSource||(B.getState()!=null&&this.stateSource==(B.isSource(B.getState().shape)||!B.isSource(B.getState().text)))))){this.hideTooltip()}}this.lastX=B.getX();this.lastY=B.getY()};mxTooltipHandler.prototype.mouseUp=function(A,B){this.reset(B,true);this.hideTooltip()};mxTooltipHandler.prototype.resetTimer=function(){if(this.thread!=null){window.clearTimeout(this.thread);this.thread=null}};mxTooltipHandler.prototype.reset=function(C,D){if(!this.ignoreTouchEvents||mxEvent.isMouseEvent(C.getEvent())){this.resetTimer();if(D&&this.isEnabled()&&C.getState()!=null&&(this.div==null||this.div.style.visibility=="hidden")){var G=C.getState();var B=C.getSource();var E=C.getX();var F=C.getY();var A=C.isSource(G.shape)||C.isSource(G.text);this.thread=window.setTimeout(mxUtils.bind(this,function(){if(!this.graph.isEditing()&&!this.graph.popupMenuHandler.isMenuShowing()&&!this.graph.isMouseDown){var H=this.graph.getTooltip(G,B,E,F);this.show(H,E,F);this.state=G;this.node=B;this.stateSource=A}}),this.delay)}}};mxTooltipHandler.prototype.hide=function(){this.resetTimer();this.hideTooltip()};mxTooltipHandler.prototype.hideTooltip=function(){if(this.div!=null){this.div.style.visibility="hidden"}};mxTooltipHandler.prototype.show=function(A,B,C){if(!this.destroyed&&A!=null&&A.length>0){if(this.div==null){this.init()}var D=mxUtils.getScrollOrigin();this.div.style.zIndex=this.zIndex;this.div.style.left=(B+D.x)+"px";this.div.style.top=(C+mxConstants.TOOLTIP_VERTICAL_OFFSET+D.y)+"px";if(!mxUtils.isNode(A)){this.div.innerHTML=A.replace(/\n/g,"<br>")}else{this.div.innerHTML="";this.div.appendChild(A)}this.div.style.visibility="";mxUtils.fit(this.div)}};mxTooltipHandler.prototype.destroy=function(){if(!this.destroyed){this.graph.removeMouseListener(this);mxEvent.release(this.div);if(this.div!=null&&this.div.parentNode!=null){this.div.parentNode.removeChild(this.div)}this.destroyed=true;this.div=null}};function mxCellTracker(A,C,B){mxCellMarker.call(this,A,C);this.graph.addMouseListener(this);if(B!=null){this.getCell=B}if(mxClient.IS_IE){mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()}))}}mxUtils.extend(mxCellTracker,mxCellMarker);mxCellTracker.prototype.mouseDown=function(A,B){};mxCellTracker.prototype.mouseMove=function(A,B){if(this.isEnabled()){this.process(B)}};mxCellTracker.prototype.mouseUp=function(A,B){};mxCellTracker.prototype.destroy=function(){if(!this.destroyed){this.destroyed=true;this.graph.removeMouseListener(this);mxCellMarker.prototype.destroy.apply(this)}};function mxCellHighlight(D,B,C,A){if(D!=null){this.graph=D;this.highlightColor=(B!=null)?B:mxConstants.DEFAULT_VALID_COLOR;this.strokeWidth=(C!=null)?C:mxConstants.HIGHLIGHT_STROKEWIDTH;this.dashed=(A!=null)?A:false;this.opacity=mxConstants.HIGHLIGHT_OPACITY;this.repaintHandler=mxUtils.bind(this,function(){if(this.state!=null){var E=this.graph.view.getState(this.state.cell);if(E==null){this.hide()}else{this.state=E;this.repaint()}}});this.graph.getView().addListener(mxEvent.SCALE,this.repaintHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.repaintHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.repaintHandler);this.graph.getModel().addListener(mxEvent.CHANGE,this.repaintHandler);this.resetHandler=mxUtils.bind(this,function(){this.hide()});this.graph.getView().addListener(mxEvent.DOWN,this.resetHandler);this.graph.getView().addListener(mxEvent.UP,this.resetHandler)}}mxCellHighlight.prototype.keepOnTop=false;mxCellHighlight.prototype.graph=true;mxCellHighlight.prototype.state=null;mxCellHighlight.prototype.spacing=2;mxCellHighlight.prototype.resetHandler=null;mxCellHighlight.prototype.setHighlightColor=function(A){this.highlightColor=A;if(this.shape!=null){this.shape.stroke=A}};mxCellHighlight.prototype.drawHighlight=function(){this.shape=this.createShape();this.repaint();if(!this.keepOnTop&&this.shape.node.parentNode.firstChild!=this.shape.node){this.shape.node.parentNode.insertBefore(this.shape.node,this.shape.node.parentNode.firstChild)}};mxCellHighlight.prototype.createShape=function(){var A=this.graph.cellRenderer.createShape(this.state);A.svgStrokeTolerance=this.graph.tolerance;A.scale=this.state.view.scale;A.outline=true;A.points=this.state.absolutePoints;A.apply(this.state);A.strokewidth=this.strokeWidth/this.state.view.scale/this.state.view.scale;A.arrowStrokewidth=this.strokeWidth;A.stroke=this.highlightColor;A.opacity=this.opacity;A.isDashed=this.dashed;A.isShadow=false;A.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;A.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(A.node,this.graph,this.state);if(this.graph.dialect!=mxConstants.DIALECT_SVG){A.pointerEvents=false}else{A.svgPointerEvents="stroke"}return A};mxCellHighlight.prototype.repaint=function(){if(this.state!=null&&this.shape!=null){if(this.graph.model.isEdge(this.state.cell)){this.shape.points=this.state.absolutePoints}else{this.shape.bounds=new mxRectangle(this.state.x-this.spacing,this.state.y-this.spacing,this.state.width+2*this.spacing,this.state.height+2*this.spacing);this.shape.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0")}if(this.state.shape!=null){this.shape.setCursor(this.state.shape.getCursor())}if(mxClient.IS_QUIRKS||document.documentMode==8){if(this.shape.stroke=="transparent"){this.shape.stroke="white";this.shape.opacity=1}else{this.shape.opacity=this.opacity}}this.shape.redraw()}};mxCellHighlight.prototype.hide=function(){this.highlight(null)};mxCellHighlight.prototype.highlight=function(A){if(this.state!=A){if(this.shape!=null){this.shape.destroy();this.shape=null}this.state=A;if(this.state!=null){this.drawHighlight()}}};mxCellHighlight.prototype.isHighlightAt=function(B,C){var A=false;if(this.shape!=null&&document.elementFromPoint!=null&&!mxClient.IS_QUIRKS){var D=document.elementFromPoint(B,C);while(D!=null){if(D==this.shape.node){A=true;break}D=D.parentNode}}return A};mxCellHighlight.prototype.destroy=function(){this.graph.getView().removeListener(this.resetHandler);this.graph.getView().removeListener(this.repaintHandler);this.graph.getModel().removeListener(this.repaintHandler);if(this.shape!=null){this.shape.destroy();this.shape=null}};function mxCellMarker(B,D,C,A){mxEventSource.call(this);if(B!=null){this.graph=B;this.validColor=(D!=null)?D:mxConstants.DEFAULT_VALID_COLOR;this.invalidColor=(D!=null)?C:mxConstants.DEFAULT_INVALID_COLOR;this.hotspot=(A!=null)?A:mxConstants.DEFAULT_HOTSPOT;this.highlight=new mxCellHighlight(B)}}mxUtils.extend(mxCellMarker,mxEventSource);mxCellMarker.prototype.graph=null;mxCellMarker.prototype.enabled=true;mxCellMarker.prototype.hotspot=mxConstants.DEFAULT_HOTSPOT;mxCellMarker.prototype.hotspotEnabled=false;mxCellMarker.prototype.validColor=null;mxCellMarker.prototype.invalidColor=null;mxCellMarker.prototype.currentColor=null;mxCellMarker.prototype.validState=null;mxCellMarker.prototype.markedState=null;mxCellMarker.prototype.setEnabled=function(A){this.enabled=A};mxCellMarker.prototype.isEnabled=function(){return this.enabled};mxCellMarker.prototype.setHotspot=function(A){this.hotspot=A};mxCellMarker.prototype.getHotspot=function(){return this.hotspot};mxCellMarker.prototype.setHotspotEnabled=function(A){this.hotspotEnabled=A};mxCellMarker.prototype.isHotspotEnabled=function(){return this.hotspotEnabled};mxCellMarker.prototype.hasValidState=function(){return this.validState!=null};mxCellMarker.prototype.getValidState=function(){return this.validState};mxCellMarker.prototype.getMarkedState=function(){return this.markedState};mxCellMarker.prototype.reset=function(){this.validState=null;if(this.markedState!=null){this.markedState=null;this.unmark()}};mxCellMarker.prototype.process=function(A){var B=null;if(this.isEnabled()){B=this.getState(A);this.setCurrentState(B,A)}return B};mxCellMarker.prototype.setCurrentState=function(D,B,C){var A=(D!=null)?this.isValidState(D):false;C=(C!=null)?C:this.getMarkerColor(B.getEvent(),D,A);if(A){this.validState=D}else{this.validState=null}if(D!=this.markedState||C!=this.currentColor){this.currentColor=C;if(D!=null&&this.currentColor!=null){this.markedState=D;this.mark()}else{if(this.markedState!=null){this.markedState=null;this.unmark()}}}};mxCellMarker.prototype.markCell=function(A,B){var C=this.graph.getView().getState(A);if(C!=null){this.currentColor=(B!=null)?B:this.validColor;this.markedState=C;this.mark()}};mxCellMarker.prototype.mark=function(){this.highlight.setHighlightColor(this.currentColor);this.highlight.highlight(this.markedState);this.fireEvent(new mxEventObject(mxEvent.MARK,"state",this.markedState))};mxCellMarker.prototype.unmark=function(){this.mark()};mxCellMarker.prototype.isValidState=function(A){return true};mxCellMarker.prototype.getMarkerColor=function(A,C,B){return(B)?this.validColor:this.invalidColor};mxCellMarker.prototype.getState=function(A){var B=this.graph.getView();cell=this.getCell(A);var C=this.getStateToMark(B.getState(cell));return(C!=null&&this.intersects(C,A))?C:null};mxCellMarker.prototype.getCell=function(A){return A.getCell()};mxCellMarker.prototype.getStateToMark=function(A){return A};mxCellMarker.prototype.intersects=function(B,A){if(this.hotspotEnabled){return mxUtils.intersectsHotspot(B,A.getGraphX(),A.getGraphY(),this.hotspot,mxConstants.MIN_HOTSPOT_SIZE,mxConstants.MAX_HOTSPOT_SIZE)}return true};mxCellMarker.prototype.destroy=function(){this.graph.getView().removeListener(this.resetHandler);this.graph.getModel().removeListener(this.resetHandler);this.highlight.destroy()};function mxCellTracker(A,C,B){mxCellMarker.call(this,A,C);this.graph.addMouseListener(this);if(B!=null){this.getCell=B}if(mxClient.IS_IE){mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()}))}}mxUtils.extend(mxCellTracker,mxCellMarker);mxCellTracker.prototype.mouseDown=function(A,B){};mxCellTracker.prototype.mouseMove=function(A,B){if(this.isEnabled()){this.process(B)}};mxCellTracker.prototype.mouseUp=function(A,B){};mxCellTracker.prototype.destroy=function(){if(!this.destroyed){this.destroyed=true;this.graph.removeMouseListener(this);mxCellMarker.prototype.destroy.apply(this)}};function mxConnectionHandler(A,B){mxEventSource.call(this);if(A!=null){this.graph=A;this.factoryMethod=B;this.init();this.escapeHandler=mxUtils.bind(this,function(C,D){this.reset()});this.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxUtils.extend(mxConnectionHandler,mxEventSource);mxConnectionHandler.prototype.graph=null;mxConnectionHandler.prototype.factoryMethod=true;mxConnectionHandler.prototype.moveIconFront=false;mxConnectionHandler.prototype.moveIconBack=false;mxConnectionHandler.prototype.connectImage=null;mxConnectionHandler.prototype.targetConnectImage=false;mxConnectionHandler.prototype.enabled=true;mxConnectionHandler.prototype.select=true;mxConnectionHandler.prototype.createTarget=false;mxConnectionHandler.prototype.marker=null;mxConnectionHandler.prototype.constraintHandler=null;mxConnectionHandler.prototype.error=null;mxConnectionHandler.prototype.waypointsEnabled=false;mxConnectionHandler.prototype.ignoreMouseDown=false;mxConnectionHandler.prototype.first=null;mxConnectionHandler.prototype.connectIconOffset=new mxPoint(0,mxConstants.TOOLTIP_VERTICAL_OFFSET);mxConnectionHandler.prototype.edgeState=null;mxConnectionHandler.prototype.changeHandler=null;mxConnectionHandler.prototype.drillHandler=null;mxConnectionHandler.prototype.mouseDownCounter=0;mxConnectionHandler.prototype.movePreviewAway=mxClient.IS_VML;mxConnectionHandler.prototype.outlineConnect=false;mxConnectionHandler.prototype.livePreview=false;mxConnectionHandler.prototype.cursor=null;mxConnectionHandler.prototype.insertBeforeSource=false;mxConnectionHandler.prototype.isEnabled=function(){return this.enabled};mxConnectionHandler.prototype.setEnabled=function(A){this.enabled=A};mxConnectionHandler.prototype.isInsertBefore=function(C,B,E,A,D){return this.insertBeforeSource&&B!=E};mxConnectionHandler.prototype.isCreateTarget=function(A){return this.createTarget};mxConnectionHandler.prototype.setCreateTarget=function(A){this.createTarget=A};mxConnectionHandler.prototype.createShape=function(){var A=(this.livePreview&&this.edgeState!=null)?this.graph.cellRenderer.createShape(this.edgeState):new mxPolyline([],mxConstants.INVALID_COLOR);A.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;A.scale=this.graph.view.scale;A.pointerEvents=false;A.isDashed=true;A.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(A.node,this.graph,null);return A};mxConnectionHandler.prototype.init=function(){this.graph.addMouseListener(this);this.marker=this.createMarker();this.constraintHandler=new mxConstraintHandler(this.graph);this.changeHandler=mxUtils.bind(this,function(A){if(this.iconState!=null){this.iconState=this.graph.getView().getState(this.iconState.cell)}if(this.iconState!=null){this.redrawIcons(this.icons,this.iconState);this.constraintHandler.reset()}else{if(this.previous!=null&&this.graph.view.getState(this.previous.cell)==null){this.reset()}}});this.graph.getModel().addListener(mxEvent.CHANGE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE,this.changeHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.changeHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.changeHandler);this.drillHandler=mxUtils.bind(this,function(A){this.reset()});this.graph.addListener(mxEvent.START_EDITING,this.drillHandler);this.graph.getView().addListener(mxEvent.DOWN,this.drillHandler);this.graph.getView().addListener(mxEvent.UP,this.drillHandler)};mxConnectionHandler.prototype.isConnectableCell=function(A){return true};mxConnectionHandler.prototype.createMarker=function(){var A=new mxCellMarker(this.graph);A.hotspotEnabled=true;A.getCell=mxUtils.bind(this,function(B){var C=mxCellMarker.prototype.getCell.apply(A,arguments);this.error=null;if(C==null&&this.currentPoint!=null){C=this.graph.getCellAt(this.currentPoint.x,this.currentPoint.y)}if(C!=null&&!this.graph.isCellConnectable(C)){var D=this.graph.getModel().getParent(C);if(this.graph.getModel().isVertex(D)&&this.graph.isCellConnectable(D)){C=D}}if((this.graph.isSwimlane(C)&&this.currentPoint!=null&&this.graph.hitsSwimlaneContent(C,this.currentPoint.x,this.currentPoint.y))||!this.isConnectableCell(C)){C=null}if(C!=null){if(this.isConnecting()){if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,C);if(this.error!=null&&this.error.length==0){C=null;if(this.isCreateTarget(B.getEvent())){this.error=null}}}}else{if(!this.isValidSource(C,B)){C=null}}}else{if(this.isConnecting()&&!this.isCreateTarget(B.getEvent())&&!this.graph.allowDanglingEdges){this.error=""}}return C});A.isValidState=mxUtils.bind(this,function(B){if(this.isConnecting()){return this.error==null}else{return mxCellMarker.prototype.isValidState.apply(A,arguments)}});A.getMarkerColor=mxUtils.bind(this,function(B,D,C){return(this.connectImage==null||this.isConnecting())?mxCellMarker.prototype.getMarkerColor.apply(A,arguments):null});A.intersects=mxUtils.bind(this,function(C,B){if(this.connectImage!=null||this.isConnecting()){return true}return mxCellMarker.prototype.intersects.apply(A,arguments)});return A};mxConnectionHandler.prototype.start=function(D,A,B,C){this.previous=D;this.first=new mxPoint(A,B);this.edgeState=(C!=null)?C:this.createEdgeState(null);this.marker.currentColor=this.marker.validColor;this.marker.markedState=D;this.marker.mark();this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous))};mxConnectionHandler.prototype.isConnecting=function(){return this.first!=null&&this.shape!=null};mxConnectionHandler.prototype.isValidSource=function(B,A){return this.graph.isValidSource(B)};mxConnectionHandler.prototype.isValidTarget=function(A){return true};mxConnectionHandler.prototype.validateConnection=function(A,B){if(!this.isValidTarget(B)){return""}return this.graph.getEdgeValidationError(null,A,B)};mxConnectionHandler.prototype.getConnectImage=function(A){return this.connectImage};mxConnectionHandler.prototype.isMoveIconToFrontForState=function(A){if(A.text!=null&&A.text.node.parentNode==this.graph.container){return true}return this.moveIconFront};mxConnectionHandler.prototype.createIcons=function(G){var C=this.getConnectImage(G);if(C!=null&&G!=null){this.iconState=G;var A=[];var B=new mxRectangle(0,0,C.width,C.height);var E=new mxImageShape(B,C.src,null,null,0);E.preserveImageAspect=false;if(this.isMoveIconToFrontForState(G)){E.dialect=mxConstants.DIALECT_STRICTHTML;E.init(this.graph.container)}else{E.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;E.init(this.graph.getView().getOverlayPane());if(this.moveIconBack&&E.node.previousSibling!=null){E.node.parentNode.insertBefore(E.node,E.node.parentNode.firstChild)}}E.node.style.cursor=mxConstants.CURSOR_CONNECT;var F=mxUtils.bind(this,function(){return(this.currentState!=null)?this.currentState:G});var D=mxUtils.bind(this,function(H){if(!mxEvent.isConsumed(H)){this.icon=E;this.graph.fireMouseEvent(mxEvent.MOUSE_DOWN,new mxMouseEvent(H,F()))}});mxEvent.redirectMouseEvents(E.node,this.graph,F,D);A.push(E);this.redrawIcons(A,this.iconState);return A}return null};mxConnectionHandler.prototype.redrawIcons=function(A,C){if(A!=null&&A[0]!=null&&C!=null){var B=this.getIconPosition(A[0],C);A[0].bounds.x=B.x;A[0].bounds.y=B.y;A[0].redraw()}};mxConnectionHandler.prototype.getIconPosition=function(J,I){var C=this.graph.getView().scale;var F=I.getCenterX();var G=I.getCenterY();if(this.graph.isSwimlane(I.cell)){var B=this.graph.getStartSize(I.cell);F=(B.width!=0)?I.x+B.width*C/2:F;G=(B.height!=0)?I.y+B.height*C/2:G;var H=mxUtils.toRadians(mxUtils.getValue(I.style,mxConstants.STYLE_ROTATION)||0);if(H!=0){var E=Math.cos(H);var D=Math.sin(H);var K=new mxPoint(I.getCenterX(),I.getCenterY());var A=mxUtils.getRotatedPoint(new mxPoint(F,G),E,D,K);F=A.x;G=A.y}}return new mxPoint(F-J.bounds.width/2,G-J.bounds.height/2)};mxConnectionHandler.prototype.destroyIcons=function(){if(this.icons!=null){for(var A=0;A<this.icons.length;A++){this.icons[A].destroy()}this.icons=null;this.icon=null;this.selectedIcon=null;this.iconState=null}};mxConnectionHandler.prototype.isStartEvent=function(A){return((this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null)||(this.previous!=null&&this.error==null&&(this.icons==null||(this.icons!=null&&this.icon!=null))))};mxConnectionHandler.prototype.mouseDown=function(A,C){this.mouseDownCounter++;if(this.isEnabled()&&this.graph.isEnabled()&&!C.isConsumed()&&!this.isConnecting()&&this.isStartEvent(C)){if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){this.sourceConstraint=this.constraintHandler.currentConstraint;this.previous=this.constraintHandler.currentFocus;this.first=this.constraintHandler.currentPoint.clone()}else{this.first=new mxPoint(C.getGraphX(),C.getGraphY())}this.edgeState=this.createEdgeState(C);this.mouseDownCounter=1;if(this.waypointsEnabled&&this.shape==null){this.waypoints=null;this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}}if(this.previous==null&&this.edgeState!=null){var B=this.graph.getPointForEvent(C.getEvent());this.edgeState.cell.geometry.setTerminalPoint(B,true)}this.fireEvent(new mxEventObject(mxEvent.START,"state",this.previous));C.consume()}this.selectedIcon=this.icon;this.icon=null};mxConnectionHandler.prototype.isImmediateConnectSource=function(A){return !this.graph.isCellMovable(A.cell)};mxConnectionHandler.prototype.createEdgeState=function(A){return null};mxConnectionHandler.prototype.isOutlineConnectEvent=function(H){var B=mxUtils.getOffset(this.graph.container);var A=H.getEvent();var E=mxEvent.getClientX(A);var F=mxEvent.getClientY(A);var G=document.documentElement;var D=(window.pageXOffset||G.scrollLeft)-(G.clientLeft||0);var C=(window.pageYOffset||G.scrollTop)-(G.clientTop||0);var I=this.currentPoint.x-this.graph.container.scrollLeft+B.x-D;var J=this.currentPoint.y-this.graph.container.scrollTop+B.y-C;return this.outlineConnect&&!mxEvent.isShiftDown(H.getEvent())&&(H.isSource(this.marker.highlight.shape)||(mxEvent.isAltDown(H.getEvent())&&H.getState()!=null)||this.marker.highlight.isHighlightAt(E,F)||((I!=E||J!=F)&&H.getState()==null&&this.marker.highlight.isHighlightAt(I,J)))};mxConnectionHandler.prototype.updateCurrentState=function(C,B){this.constraintHandler.update(C,this.first==null,false,(this.first==null||C.isSource(this.marker.highlight.shape))?null:B);if(this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null){if(this.marker.highlight!=null&&this.marker.highlight.state!=null&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell){if(this.marker.highlight.shape.stroke!="transparent"){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint()}}else{this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent")}if(this.previous!=null){this.error=this.validateConnection(this.previous.cell,this.constraintHandler.currentFocus.cell);if(this.error==null){this.currentState=this.constraintHandler.currentFocus}else{this.constraintHandler.reset()}}}else{if(this.graph.isIgnoreTerminalEvent(C.getEvent())){this.marker.reset();this.currentState=null}else{this.marker.process(C);this.currentState=this.marker.getValidState()}var D=this.isOutlineConnectEvent(C);if(this.currentState!=null&&D){if(C.isSource(this.marker.highlight.shape)){B=new mxPoint(C.getGraphX(),C.getGraphY())}var E=this.graph.getOutlineConstraint(B,this.currentState,C);this.constraintHandler.setFocus(C,this.currentState,false);this.constraintHandler.currentConstraint=E;this.constraintHandler.currentPoint=B}if(this.outlineConnect){if(this.marker.highlight!=null&&this.marker.highlight.shape!=null){var A=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){this.marker.highlight.shape.stroke=mxConstants.OUTLINE_HIGHLIGHT_COLOR;this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/A/A;this.marker.highlight.repaint()}else{if(this.marker.hasValidState()){if(this.marker.getValidState()!=C.getState()){this.marker.highlight.shape.stroke="transparent";this.currentState=null}else{this.marker.highlight.shape.stroke=mxConstants.DEFAULT_VALID_COLOR}this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/A/A;this.marker.highlight.repaint()}}}}}};mxConnectionHandler.prototype.convertWaypoint=function(A){var C=this.graph.getView().getScale();var B=this.graph.getView().getTranslate();A.x=A.x/C-B.x;A.y=A.y/C-B.y};mxConnectionHandler.prototype.snapToPreview=function(C,B){if(!mxEvent.isAltDown(C.getEvent())&&this.previous!=null){var D=this.graph.gridSize*this.graph.view.scale/2;var A=(this.sourceConstraint!=null)?this.first:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());if(Math.abs(A.x-C.getGraphX())<D){B.x=A.x}if(Math.abs(A.y-C.getGraphY())<D){B.y=A.y}}};mxConnectionHandler.prototype.mouseMove=function(Q,H){if(!H.isConsumed()&&(this.ignoreMouseDown||this.first!=null||!this.graph.isMouseDown)){if(!this.isEnabled()&&this.currentState!=null){this.destroyIcons();this.currentState=null}var J=this.graph.getView();var N=J.scale;var P=J.translate;var C=new mxPoint(H.getGraphX(),H.getGraphY());this.error=null;if(this.graph.isGridEnabledEvent(H.getEvent())){C=new mxPoint((this.graph.snap(C.x/N-P.x)+P.x)*N,(this.graph.snap(C.y/N-P.y)+P.y)*N)}this.snapToPreview(H,C);this.currentPoint=C;if(this.first!=null||(this.isEnabled()&&this.graph.isEnabled())){this.updateCurrentState(H,C)}if(this.first!=null){var L=null;var I=C;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){L=this.constraintHandler.currentConstraint;I=this.constraintHandler.currentPoint.clone()}else{if(this.previous!=null&&!this.graph.isIgnoreTerminalEvent(H.getEvent())&&mxEvent.isShiftDown(H.getEvent())){if(Math.abs(this.previous.getCenterX()-C.x)<Math.abs(this.previous.getCenterY()-C.y)){C.x=this.previous.getCenterX()}else{C.y=this.previous.getCenterY()}}}var M=this.first;if(this.selectedIcon!=null){var W=this.selectedIcon.bounds.width;var F=this.selectedIcon.bounds.height;if(this.currentState!=null&&this.targetConnectImage){var V=this.getIconPosition(this.selectedIcon,this.currentState);this.selectedIcon.bounds.x=V.x;this.selectedIcon.bounds.y=V.y}else{var E=new mxRectangle(H.getGraphX()+this.connectIconOffset.x,H.getGraphY()+this.connectIconOffset.y,W,F);this.selectedIcon.bounds=E}this.selectedIcon.redraw()}if(this.edgeState!=null){this.updateEdgeState(I,L);I=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-1];M=this.edgeState.absolutePoints[0]}else{if(this.currentState!=null){if(this.constraintHandler.currentConstraint==null){var D=this.getTargetPerimeterPoint(this.currentState,H);if(D!=null){I=D}}}if(this.sourceConstraint==null&&this.previous!=null){var O=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[0]:I;var D=this.getSourcePerimeterPoint(this.previous,O,H);if(D!=null){M=D}}}if(this.currentState==null&&this.movePreviewAway){var D=M;if(this.edgeState!=null&&this.edgeState.absolutePoints.length>=2){var R=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-2];if(R!=null){D=R}}var K=I.x-D.x;var S=I.y-D.y;var B=Math.sqrt(K*K+S*S);if(B==0){return}this.originalPoint=I.clone();I.x-=K*4/B;I.y-=S*4/B}else{this.originalPoint=null}if(this.shape==null){var K=Math.abs(C.x-this.first.x);var S=Math.abs(C.y-this.first.y);if(K>this.graph.tolerance||S>this.graph.tolerance){this.shape=this.createShape();if(this.edgeState!=null){this.shape.apply(this.edgeState)}this.updateCurrentState(H,C)}}if(this.shape!=null){if(this.edgeState!=null){this.shape.points=this.edgeState.absolutePoints}else{var A=[M];if(this.waypoints!=null){A=A.concat(this.waypoints)}A.push(I);this.shape.points=A}this.drawPreview()}if(this.cursor!=null){this.graph.container.style.cursor=this.cursor}mxEvent.consume(H.getEvent());H.consume()}else{if(!this.isEnabled()||!this.graph.isEnabled()){this.constraintHandler.reset()}else{if(this.previous!=this.currentState&&this.edgeState==null){this.destroyIcons();if(this.currentState!=null&&this.error==null&&this.constraintHandler.currentConstraint==null){this.icons=this.createIcons(this.currentState);if(this.icons==null){this.currentState.setCursor(mxConstants.CURSOR_CONNECT);H.consume()}}this.previous=this.currentState}else{if(this.previous==this.currentState&&this.currentState!=null&&this.icons==null&&!this.graph.isMouseDown){H.consume()}}}}if(!this.graph.isMouseDown&&this.currentState!=null&&this.icons!=null){var U=false;var T=H.getSource();for(var G=0;G<this.icons.length&&!U;G++){U=T==this.icons[G].node||T.parentNode==this.icons[G].node}if(!U){this.updateIcons(this.currentState,this.icons,H)}}}else{this.constraintHandler.reset()}};mxConnectionHandler.prototype.updateEdgeState=function(C,D){if(this.sourceConstraint!=null&&this.sourceConstraint.point!=null){this.edgeState.style[mxConstants.STYLE_EXIT_X]=this.sourceConstraint.point.x;this.edgeState.style[mxConstants.STYLE_EXIT_Y]=this.sourceConstraint.point.y}if(D!=null&&D.point!=null){this.edgeState.style[mxConstants.STYLE_ENTRY_X]=D.point.x;this.edgeState.style[mxConstants.STYLE_ENTRY_Y]=D.point.y}else{delete this.edgeState.style[mxConstants.STYLE_ENTRY_X];delete this.edgeState.style[mxConstants.STYLE_ENTRY_Y]}this.edgeState.absolutePoints=[null,(this.currentState!=null)?null:C];this.graph.view.updateFixedTerminalPoint(this.edgeState,this.previous,true,this.sourceConstraint);if(this.currentState!=null){if(D==null){D=this.graph.getConnectionConstraint(this.edgeState,this.previous,false)}this.edgeState.setAbsoluteTerminalPoint(null,false);this.graph.view.updateFixedTerminalPoint(this.edgeState,this.currentState,false,D)}var E=null;if(this.waypoints!=null){E=[];for(var A=0;A<this.waypoints.length;A++){var B=this.waypoints[A].clone();this.convertWaypoint(B);E[A]=B}}this.graph.view.updatePoints(this.edgeState,E,this.previous,this.currentState);this.graph.view.updateFloatingTerminalPoints(this.edgeState,this.previous,this.currentState)};mxConnectionHandler.prototype.getTargetPerimeterPoint=function(G,D){var B=null;var F=G.view;var E=F.getPerimeterFunction(G);if(E!=null){var C=(this.waypoints!=null&&this.waypoints.length>0)?this.waypoints[this.waypoints.length-1]:new mxPoint(this.previous.getCenterX(),this.previous.getCenterY());var A=E(F.getPerimeterBounds(G),this.edgeState,C,false);if(A!=null){B=A}}else{B=new mxPoint(G.getCenterX(),G.getCenterY())}return B};mxConnectionHandler.prototype.getSourcePerimeterPoint=function(G,J,H){var B=null;var A=G.view;var F=A.getPerimeterFunction(G);var I=new mxPoint(G.getCenterX(),G.getCenterY());if(F!=null){var E=mxUtils.getValue(G.style,mxConstants.STYLE_ROTATION,0);var D=-E*(Math.PI/180);if(E!=0){J=mxUtils.getRotatedPoint(new mxPoint(J.x,J.y),Math.cos(D),Math.sin(D),I)}var C=F(A.getPerimeterBounds(G),G,J,false);if(C!=null){if(E!=0){C=mxUtils.getRotatedPoint(new mxPoint(C.x,C.y),Math.cos(-D),Math.sin(-D),I)}B=C}}else{B=I}return B};mxConnectionHandler.prototype.updateIcons=function(C,A,B){};mxConnectionHandler.prototype.isStopEvent=function(A){return A.getState()!=null};mxConnectionHandler.prototype.addWaypointForEvent=function(C){var A=mxUtils.convertPoint(this.graph.container,C.getX(),C.getY());var B=Math.abs(A.x-this.first.x);var D=Math.abs(A.y-this.first.y);var E=this.waypoints!=null||(this.mouseDownCounter>1&&(B>this.graph.tolerance||D>this.graph.tolerance));if(E){if(this.waypoints==null){this.waypoints=[]}var F=this.graph.view.scale;var A=new mxPoint(this.graph.snap(C.getGraphX()/F)*F,this.graph.snap(C.getGraphY()/F)*F);this.waypoints.push(A)}};mxConnectionHandler.prototype.mouseUp=function(A,C){if(!C.isConsumed()&&this.isConnecting()){if(this.waypointsEnabled&&!this.isStopEvent(C)){this.addWaypointForEvent(C);C.consume();return}if(this.error==null){var B=(this.previous!=null)?this.previous.cell:null;var D=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){D=this.constraintHandler.currentFocus.cell}if(D==null&&this.currentState!=null){D=this.currentState.cell}this.connect(B,D,C.getEvent(),C.getCell())}else{if(this.previous!=null&&this.marker.validState!=null&&this.previous.cell==this.marker.validState.cell){this.graph.selectCellForEvent(this.marker.source,evt)}if(this.error.length>0){this.graph.validationAlert(this.error)}}this.destroyIcons();C.consume()}if(this.first!=null){this.reset()}};mxConnectionHandler.prototype.reset=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.cursor!=null&&this.graph.container!=null){this.graph.container.style.cursor=""}this.destroyIcons();this.marker.reset();this.constraintHandler.reset();this.originalPoint=null;this.currentPoint=null;this.edgeState=null;this.previous=null;this.error=null;this.sourceConstraint=null;this.mouseDownCounter=0;this.first=null;this.fireEvent(new mxEventObject(mxEvent.RESET))};mxConnectionHandler.prototype.drawPreview=function(){this.updatePreview(this.error==null);this.shape.redraw()};mxConnectionHandler.prototype.updatePreview=function(A){this.shape.strokewidth=this.getEdgeWidth(A);this.shape.stroke=this.getEdgeColor(A)};mxConnectionHandler.prototype.getEdgeColor=function(A){return(A)?mxConstants.VALID_COLOR:mxConstants.INVALID_COLOR};mxConnectionHandler.prototype.getEdgeWidth=function(A){return(A)?3:1};mxConnectionHandler.prototype.connect=function(L,R,I,J){if(R!=null||this.isCreateTarget(I)||this.graph.allowDanglingEdges){var F=this.graph.getModel();var H=false;var A=null;F.beginUpdate();try{if(L!=null&&R==null&&!this.graph.isIgnoreTerminalEvent(I)&&this.isCreateTarget(I)){R=this.createTargetVertex(I,L);if(R!=null){J=this.graph.getDropTarget([R],I,J);H=true;if(J==null||!this.graph.getModel().isEdge(J)){var P=this.graph.getView().getState(J);if(P!=null){var C=F.getGeometry(R);C.x-=P.origin.x;C.y-=P.origin.y}}else{J=this.graph.getDefaultParent()}this.graph.addCell(R,J)}}var O=this.graph.getDefaultParent();if(L!=null&&R!=null&&F.getParent(L)==F.getParent(R)&&F.getParent(F.getParent(L))!=F.getRoot()){O=F.getParent(L);if((L.geometry!=null&&L.geometry.relative)&&(R.geometry!=null&&R.geometry.relative)){O=F.getParent(O)}}var S=null;var T=null;if(this.edgeState!=null){S=this.edgeState.cell.value;T=this.edgeState.cell.style}A=this.insertEdge(O,null,S,L,R,T);if(A!=null){this.graph.setConnectionConstraint(A,L,true,this.sourceConstraint);this.graph.setConnectionConstraint(A,R,false,this.constraintHandler.currentConstraint);if(this.edgeState!=null){F.setGeometry(A,this.edgeState.cell.geometry)}var O=F.getParent(L);if(this.isInsertBefore(A,L,R,I,J)){var E=null;var C=L;while(C.parent!=null&&C.geometry!=null&&C.geometry.relative&&C.parent!=A.parent){C=this.graph.model.getParent(C)}if(C!=null&&C.parent!=null&&C.parent==A.parent){var E=C.parent.getIndex(C);C.parent.insert(A,E)}}var M=F.getGeometry(A);if(M==null){M=new mxGeometry();M.relative=true;F.setGeometry(A,M)}if(this.waypoints!=null&&this.waypoints.length>0){var B=this.graph.view.scale;var N=this.graph.view.translate;M.points=[];for(var G=0;G<this.waypoints.length;G++){var Q=this.waypoints[G];M.points.push(new mxPoint(Q.x/B-N.x,Q.y/B-N.y))}}if(R==null){var D=this.graph.view.translate;var B=this.graph.view.scale;var Q=(this.originalPoint!=null)?new mxPoint(this.originalPoint.x/B-D.x,this.originalPoint.y/B-D.y):new mxPoint(this.currentPoint.x/B-D.x,this.currentPoint.y/B-D.y);Q.x-=this.graph.panDx/this.graph.view.scale;Q.y-=this.graph.panDy/this.graph.view.scale;M.setTerminalPoint(Q,false)}this.fireEvent(new mxEventObject(mxEvent.CONNECT,"cell",A,"terminal",R,"event",I,"target",J,"terminalInserted",H))}}catch(K){mxLog.show();mxLog.debug(K.message)}finally{F.endUpdate()}if(this.select){this.selectCells(A,(H)?R:null)}}};mxConnectionHandler.prototype.selectCells=function(A,B){this.graph.setSelectionCell(A)};mxConnectionHandler.prototype.insertEdge=function(F,G,E,A,D,C){if(this.factoryMethod==null){return this.graph.insertEdge(F,G,E,A,D,C)}else{var B=this.createEdge(E,A,D,C);B=this.graph.addEdge(B,F,A,D);return B}};mxConnectionHandler.prototype.createTargetVertex=function(B,G){var K=this.graph.getCellGeometry(G);while(K!=null&&K.relative){G=this.graph.getModel().getParent(G);K=this.graph.getCellGeometry(G)}var C=this.graph.cloneCells([G])[0];var K=this.graph.getModel().getGeometry(C);if(K!=null){var E=this.graph.view.translate;var A=this.graph.view.scale;var J=new mxPoint(this.currentPoint.x/A-E.x,this.currentPoint.y/A-E.y);K.x=Math.round(J.x-K.width/2-this.graph.panDx/A);K.y=Math.round(J.y-K.height/2-this.graph.panDy/A);var D=this.getAlignmentTolerance();if(D>0){var F=this.graph.view.getState(G);if(F!=null){var H=F.x/A-E.x;var I=F.y/A-E.y;if(Math.abs(H-K.x)<=D){K.x=Math.round(H)}if(Math.abs(I-K.y)<=D){K.y=Math.round(I)}}}}return C};mxConnectionHandler.prototype.getAlignmentTolerance=function(A){return(this.graph.isGridEnabled())?this.graph.gridSize/2:this.graph.tolerance};mxConnectionHandler.prototype.createEdge=function(D,A,E,C){var B=null;if(this.factoryMethod!=null){B=this.factoryMethod(A,E,C)}if(B==null){B=new mxCell(D||"");B.setEdge(true);B.setStyle(C);var F=new mxGeometry();F.relative=true;B.setGeometry(F)}return B};mxConnectionHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.marker!=null){this.marker.destroy();this.marker=null}if(this.constraintHandler!=null){this.constraintHandler.destroy();this.constraintHandler=null}if(this.changeHandler!=null){this.graph.getModel().removeListener(this.changeHandler);this.graph.getView().removeListener(this.changeHandler);this.changeHandler=null}if(this.drillHandler!=null){this.graph.removeListener(this.drillHandler);this.graph.getView().removeListener(this.drillHandler);this.drillHandler=null}if(this.escapeHandler!=null){this.graph.removeListener(this.escapeHandler);this.escapeHandler=null}};function mxConstraintHandler(A){this.graph=A;this.resetHandler=mxUtils.bind(this,function(B,C){if(this.currentFocus!=null&&this.graph.view.getState(this.currentFocus.cell)==null){this.reset()}else{this.redraw()}});this.graph.model.addListener(mxEvent.CHANGE,this.resetHandler);this.graph.view.addListener(mxEvent.SCALE,this.resetHandler);this.graph.addListener(mxEvent.ROOT,this.resetHandler)}mxConstraintHandler.prototype.pointImage=new mxImage(mxClient.imageBasePath+"/point.gif",5,5);mxConstraintHandler.prototype.graph=null;mxConstraintHandler.prototype.enabled=true;mxConstraintHandler.prototype.highlightColor=mxConstants.DEFAULT_VALID_COLOR;mxConstraintHandler.prototype.isEnabled=function(){return this.enabled};mxConstraintHandler.prototype.setEnabled=function(A){this.enabled=A};mxConstraintHandler.prototype.reset=function(){if(this.focusIcons!=null){for(var A=0;A<this.focusIcons.length;A++){this.focusIcons[A].destroy()}this.focusIcons=null}if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}this.currentConstraint=null;this.currentFocusArea=null;this.currentPoint=null;this.currentFocus=null;this.focusPoints=null};mxConstraintHandler.prototype.getTolerance=function(A){return this.graph.getTolerance()};mxConstraintHandler.prototype.getImageForConstraint=function(C,B,A){return this.pointImage};mxConstraintHandler.prototype.isEventIgnored=function(B,A){return false};mxConstraintHandler.prototype.isStateIgnored=function(B,A){return false};mxConstraintHandler.prototype.destroyIcons=function(){if(this.focusIcons!=null){for(var A=0;A<this.focusIcons.length;A++){this.focusIcons[A].destroy()}this.focusIcons=null;this.focusPoints=null}};mxConstraintHandler.prototype.destroyFocusHighlight=function(){if(this.focusHighlight!=null){this.focusHighlight.destroy();this.focusHighlight=null}};mxConstraintHandler.prototype.isKeepFocusEvent=function(A){return mxEvent.isShiftDown(A.getEvent())};mxConstraintHandler.prototype.getCellForEvent=function(B,A){var C=B.getCell();if(C==null&&A!=null&&(B.getGraphX()!=A.x||B.getGraphY()!=A.y)){C=this.graph.getCellAt(A.x,A.y)}if(C!=null&&!this.graph.isCellConnectable(C)){var D=this.graph.getModel().getParent(C);if(this.graph.getModel().isVertex(D)&&this.graph.isCellConnectable(D)){C=D}}return C};mxConstraintHandler.prototype.update=function(I,K,E,C){if(this.isEnabled()&&!this.isEventIgnored(I)){if(this.mouseleaveHandler==null&&this.graph.container!=null){this.mouseleaveHandler=mxUtils.bind(this,function(){this.reset()});mxEvent.addListener(this.graph.container,"mouseleave",this.resetHandler)}var Q=this.getTolerance(I);var O=(C!=null)?C.x:I.getGraphX();var P=(C!=null)?C.y:I.getGraphY();var B=new mxRectangle(O-Q,P-Q,2*Q,2*Q);var A=new mxRectangle(I.getGraphX()-Q,I.getGraphY()-Q,2*Q,2*Q);var H=this.graph.view.getState(this.getCellForEvent(I,C));if(!this.isKeepFocusEvent(I)&&(this.currentFocusArea==null||this.currentFocus==null||(H!=null)||!this.graph.getModel().isVertex(this.currentFocus.cell)||!mxUtils.intersects(this.currentFocusArea,A))&&(H!=this.currentFocus)){this.currentFocusArea=null;this.currentFocus=null;this.setFocus(I,H,K)}this.currentConstraint=null;this.currentPoint=null;var S=null;if(this.focusIcons!=null&&this.constraints!=null&&(H==null||this.currentFocus==H)){var F=A.getCenterX();var M=A.getCenterY();for(var G=0;G<this.focusIcons.length;G++){var J=F-this.focusIcons[G].bounds.getCenterX();var N=M-this.focusIcons[G].bounds.getCenterY();var D=J*J+N*N;if((this.intersects(this.focusIcons[G],A,K,E)||(C!=null&&this.intersects(this.focusIcons[G],B,K,E)))&&(S==null||D<S)){this.currentConstraint=this.constraints[G];this.currentPoint=this.focusPoints[G];S=D;var D=this.focusIcons[G].bounds.clone();D.grow(mxConstants.HIGHLIGHT_SIZE);if(mxClient.IS_IE){D.grow(1);D.width-=1;D.height-=1}if(this.focusHighlight==null){var L=this.createHighlightShape();L.dialect=(this.graph.dialect==mxConstants.DIALECT_SVG)?mxConstants.DIALECT_SVG:mxConstants.DIALECT_VML;L.pointerEvents=false;L.init(this.graph.getView().getOverlayPane());this.focusHighlight=L;var R=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:H});mxEvent.redirectMouseEvents(L.node,this.graph,R)}this.focusHighlight.bounds=D;this.focusHighlight.redraw()}}}if(this.currentConstraint==null){this.destroyFocusHighlight()}}else{this.currentConstraint=null;this.currentFocus=null;this.currentPoint=null}};mxConstraintHandler.prototype.redraw=function(){if(this.currentFocus!=null&&this.constraints!=null&&this.focusIcons!=null){var E=this.graph.view.getState(this.currentFocus.cell);this.currentFocus=E;this.currentFocusArea=new mxRectangle(E.x,E.y,E.width,E.height);for(var A=0;A<this.constraints.length;A++){var C=this.graph.getConnectionPoint(E,this.constraints[A]);var D=this.getImageForConstraint(E,this.constraints[A],C);var B=new mxRectangle(Math.round(C.x-D.width/2),Math.round(C.y-D.height/2),D.width,D.height);this.focusIcons[A].bounds=B;this.focusIcons[A].redraw();this.currentFocusArea.add(this.focusIcons[A].bounds);this.focusPoints[A]=C}}};mxConstraintHandler.prototype.setFocus=function(G,C,F){this.constraints=(C!=null&&!this.isStateIgnored(C,F)&&this.graph.isCellConnectable(C.cell))?((this.isEnabled())?(this.graph.getAllConnectionConstraints(C,F)||[]):[]):null;if(this.constraints!=null){this.currentFocus=C;this.currentFocusArea=new mxRectangle(C.x,C.y,C.width,C.height);if(this.focusIcons!=null){for(var E=0;E<this.focusIcons.length;E++){this.focusIcons[E].destroy()}this.focusIcons=null;this.focusPoints=null}this.focusPoints=[];this.focusIcons=[];for(var E=0;E<this.constraints.length;E++){var J=this.graph.getConnectionPoint(C,this.constraints[E]);var A=this.getImageForConstraint(C,this.constraints[E],J);var I=A.src;var B=new mxRectangle(Math.round(J.x-A.width/2),Math.round(J.y-A.height/2),A.width,A.height);var D=new mxImageShape(B,I);D.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;D.preserveImageAspect=false;D.init(this.graph.getView().getDecoratorPane());if(mxClient.IS_QUIRKS||document.documentMode==8){mxEvent.addListener(D.node,"dragstart",function(K){mxEvent.consume(K);return false})}if(D.node.previousSibling!=null){D.node.parentNode.insertBefore(D.node,D.node.parentNode.firstChild)}var H=mxUtils.bind(this,function(){return(this.currentFocus!=null)?this.currentFocus:C});D.redraw();mxEvent.redirectMouseEvents(D.node,this.graph,H);this.currentFocusArea.add(D.bounds);this.focusIcons.push(D);this.focusPoints.push(J)}this.currentFocusArea.grow(this.getTolerance(G))}else{this.destroyIcons();this.destroyFocusHighlight()}};mxConstraintHandler.prototype.createHighlightShape=function(){var A=new mxRectangleShape(null,this.highlightColor,this.highlightColor,mxConstants.HIGHLIGHT_STROKEWIDTH);A.opacity=mxConstants.HIGHLIGHT_OPACITY;return A};mxConstraintHandler.prototype.intersects=function(C,D,B,A){return mxUtils.intersects(C.bounds,D)};mxConstraintHandler.prototype.destroy=function(){this.reset();if(this.resetHandler!=null){this.graph.model.removeListener(this.resetHandler);this.graph.view.removeListener(this.resetHandler);this.graph.removeListener(this.resetHandler);this.resetHandler=null}if(this.mouseleaveHandler!=null&&this.graph.container!=null){mxEvent.removeListener(this.graph.container,"mouseleave",this.mouseleaveHandler);this.mouseleaveHandler=null}};function mxEdgeHandler(A){if(A!=null){this.state=A;this.init();this.escapeHandler=mxUtils.bind(this,function(B,C){this.reset()});this.state.view.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxEdgeHandler.prototype.graph=null;mxEdgeHandler.prototype.state=null;mxEdgeHandler.prototype.marker=null;mxEdgeHandler.prototype.constraintHandler=null;mxEdgeHandler.prototype.error=null;mxEdgeHandler.prototype.shape=null;mxEdgeHandler.prototype.bends=null;mxEdgeHandler.prototype.labelShape=null;mxEdgeHandler.prototype.cloneEnabled=true;mxEdgeHandler.prototype.addEnabled=false;mxEdgeHandler.prototype.removeEnabled=false;mxEdgeHandler.prototype.dblClickRemoveEnabled=false;mxEdgeHandler.prototype.mergeRemoveEnabled=false;mxEdgeHandler.prototype.straightRemoveEnabled=false;mxEdgeHandler.prototype.virtualBendsEnabled=false;mxEdgeHandler.prototype.virtualBendOpacity=20;mxEdgeHandler.prototype.parentHighlightEnabled=false;mxEdgeHandler.prototype.preferHtml=false;mxEdgeHandler.prototype.allowHandleBoundsCheck=true;mxEdgeHandler.prototype.snapToTerminals=false;mxEdgeHandler.prototype.handleImage=null;mxEdgeHandler.prototype.tolerance=0;mxEdgeHandler.prototype.outlineConnect=false;mxEdgeHandler.prototype.manageLabelHandle=false;mxEdgeHandler.prototype.init=function(){this.graph=this.state.view.graph;this.marker=this.createMarker();this.constraintHandler=new mxConstraintHandler(this.graph);this.points=[];this.abspoints=this.getSelectionPoints(this.state);this.shape=this.createSelectionShape(this.abspoints);this.shape.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;this.shape.init(this.graph.getView().getOverlayPane());this.shape.pointerEvents=false;this.shape.setCursor(mxConstants.CURSOR_MOVABLE_EDGE);mxEvent.redirectMouseEvents(this.shape.node,this.graph,this.state);this.preferHtml=this.state.text!=null&&this.state.text.node.parentNode==this.graph.container;if(!this.preferHtml){var A=this.state.getVisibleTerminalState(true);if(A!=null){this.preferHtml=A.text!=null&&A.text.node.parentNode==this.graph.container}if(!this.preferHtml){var B=this.state.getVisibleTerminalState(false);if(B!=null){this.preferHtml=B.text!=null&&B.text.node.parentNode==this.graph.container}}}if(this.parentHighlightEnabled){var C=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(C)){var D=this.graph.view.getState(C);if(D!=null){this.parentHighlight=this.createParentHighlightShape(D);this.parentHighlight.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.parentHighlight.pointerEvents=false;this.parentHighlight.rotation=Number(D.style[mxConstants.STYLE_ROTATION]||"0");this.parentHighlight.init(this.graph.getView().getOverlayPane())}}}if(this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells||mxGraphHandler.prototype.maxCells<=0){this.bends=this.createBends();if(this.isVirtualBendsEnabled()){this.virtualBends=this.createVirtualBends()}}this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y);this.labelShape=this.createLabelHandleShape();this.initBend(this.labelShape);this.labelShape.setCursor(mxConstants.CURSOR_LABEL_HANDLE);this.customHandles=this.createCustomHandles();this.redraw()};mxEdgeHandler.prototype.createCustomHandles=function(){return null};mxEdgeHandler.prototype.isVirtualBendsEnabled=function(A){return this.virtualBendsEnabled&&(this.state.style[mxConstants.STYLE_EDGE]==null||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.NONE||this.state.style[mxConstants.STYLE_NOEDGESTYLE]==1)&&mxUtils.getValue(this.state.style,mxConstants.STYLE_SHAPE,null)!="arrow"};mxEdgeHandler.prototype.isAddPointEvent=function(A){return mxEvent.isShiftDown(A)};mxEdgeHandler.prototype.isRemovePointEvent=function(A){return mxEvent.isShiftDown(A)};mxEdgeHandler.prototype.getSelectionPoints=function(A){return A.absolutePoints};mxEdgeHandler.prototype.createParentHighlightShape=function(A){var B=new mxRectangleShape(A,null,this.getSelectionColor());B.strokewidth=this.getSelectionStrokeWidth();B.isDashed=this.isSelectionDashed();return B};mxEdgeHandler.prototype.createSelectionShape=function(A){var B=new this.state.shape.constructor();B.outline=true;B.apply(this.state);B.isDashed=this.isSelectionDashed();B.stroke=this.getSelectionColor();B.isShadow=false;return B};mxEdgeHandler.prototype.getSelectionColor=function(){return mxConstants.EDGE_SELECTION_COLOR};mxEdgeHandler.prototype.getSelectionStrokeWidth=function(){return mxConstants.EDGE_SELECTION_STROKEWIDTH};mxEdgeHandler.prototype.isSelectionDashed=function(){return mxConstants.EDGE_SELECTION_DASHED};mxEdgeHandler.prototype.isConnectableCell=function(A){return true};mxEdgeHandler.prototype.getCellAt=function(A,B){return(!this.outlineConnect)?this.graph.getCellAt(A,B):null};mxEdgeHandler.prototype.createMarker=function(){var B=new mxCellMarker(this.graph);var A=this;B.getCell=function(C){var D=mxCellMarker.prototype.getCell.apply(this,arguments);if((D==A.state.cell||D==null)&&A.currentPoint!=null){D=A.graph.getCellAt(A.currentPoint.x,A.currentPoint.y)}if(D!=null&&!this.graph.isCellConnectable(D)){var F=this.graph.getModel().getParent(D);if(this.graph.getModel().isVertex(F)&&this.graph.isCellConnectable(F)){D=F}}var E=A.graph.getModel();if((this.graph.isSwimlane(D)&&A.currentPoint!=null&&this.graph.hitsSwimlaneContent(D,A.currentPoint.x,A.currentPoint.y))||(!A.isConnectableCell(D))||(D==A.state.cell||(D!=null&&!A.graph.connectableEdges&&E.isEdge(D)))||E.isAncestor(A.state.cell,D)){D=null}if(!this.graph.isCellConnectable(D)){D=null}return D};B.isValidState=function(H){var G=A.graph.getModel();var F=A.graph.view.getTerminalPort(H,A.graph.view.getState(G.getTerminal(A.state.cell,!A.isSource)),!A.isSource);var D=(F!=null)?F.cell:null;var C=(A.isSource)?H.cell:D;var E=(A.isSource)?D:H.cell;A.error=A.validateConnection(C,E);return A.error==null};return B};mxEdgeHandler.prototype.validateConnection=function(A,B){return this.graph.getEdgeValidationError(this.state.cell,A,B)};mxEdgeHandler.prototype.createBends=function(){var E=this.state.cell;var A=[];for(var B=0;B<this.abspoints.length;B++){if(this.isHandleVisible(B)){var C=B==0;var D=B==this.abspoints.length-1;var F=C||D;if(F||this.graph.isCellBendable(E)){(mxUtils.bind(this,function(H){var G=this.createHandleShape(H);this.initBend(G,mxUtils.bind(this,mxUtils.bind(this,function(){if(this.dblClickRemoveEnabled){this.removePoint(this.state,H)}})));if(this.isHandleEnabled(B)){G.setCursor((F)?mxConstants.CURSOR_TERMINAL_HANDLE:mxConstants.CURSOR_BEND_HANDLE)}A.push(G);if(!F){this.points.push(new mxPoint(0,0));G.node.style.visibility="hidden"}}))(B)}}}return A};mxEdgeHandler.prototype.createVirtualBends=function(){var D=this.state.cell;var C=this.abspoints[0];var A=[];if(this.graph.isCellBendable(D)){for(var B=1;B<this.abspoints.length;B++){(mxUtils.bind(this,function(E){this.initBend(E);E.setCursor(mxConstants.CURSOR_VIRTUAL_BEND_HANDLE);A.push(E)}))(this.createHandleShape())}}return A};mxEdgeHandler.prototype.isHandleEnabled=function(A){return true};mxEdgeHandler.prototype.isHandleVisible=function(C){var A=this.state.getVisibleTerminalState(true);var D=this.state.getVisibleTerminalState(false);var E=this.graph.getCellGeometry(this.state.cell);var B=(E!=null)?this.graph.view.getEdgeStyle(this.state,E.points,A,D):null;return B!=mxEdgeStyle.EntityRelation||C==0||C==this.abspoints.length-1};mxEdgeHandler.prototype.createHandleShape=function(B){if(this.handleImage!=null){var C=new mxImageShape(new mxRectangle(0,0,this.handleImage.width,this.handleImage.height),this.handleImage.src);C.preserveImageAspect=false;return C}else{var A=mxConstants.HANDLE_SIZE;if(this.preferHtml){A-=1}return new mxRectangleShape(new mxRectangle(0,0,A,A),mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}};mxEdgeHandler.prototype.createLabelHandleShape=function(){if(this.labelHandleImage!=null){var B=new mxImageShape(new mxRectangle(0,0,this.labelHandleImage.width,this.labelHandleImage.height),this.labelHandleImage.src);B.preserveImageAspect=false;return B}else{var A=mxConstants.LABEL_HANDLE_SIZE;return new mxRectangleShape(new mxRectangle(0,0,A,A),mxConstants.LABEL_HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}};mxEdgeHandler.prototype.initBend=function(A,B){if(this.preferHtml){A.dialect=mxConstants.DIALECT_STRICTHTML;A.init(this.graph.container)}else{A.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;A.init(this.graph.getView().getOverlayPane())}mxEvent.redirectMouseEvents(A.node,this.graph,this.state,null,null,null,B);if(mxClient.IS_QUIRKS||document.documentMode==8){mxEvent.addListener(A.node,"dragstart",function(C){mxEvent.consume(C);return false})}if(mxClient.IS_TOUCH){A.node.setAttribute("pointer-events","none")}};mxEdgeHandler.prototype.getHandleForEvent=function(D){var G=(!mxEvent.isMouseEvent(D.getEvent()))?this.tolerance:1;var E=(this.allowHandleBoundsCheck&&(mxClient.IS_IE||G>0))?new mxRectangle(D.getGraphX()-G,D.getGraphY()-G,2*G,2*G):null;var F=null;var C=null;function B(K){if(K!=null&&K.node.style.display!="none"&&K.node.style.visibility!="hidden"&&(D.isSource(K)||(E!=null&&mxUtils.intersects(K.bounds,E)))){var I=D.getGraphX()-K.bounds.getCenterX();var J=D.getGraphY()-K.bounds.getCenterY();var H=I*I+J*J;if(F==null||H<=F){F=H;return true}}return false}if(this.customHandles!=null&&this.isCustomHandleEvent(D)){for(var A=this.customHandles.length-1;A>=0;A--){if(B(this.customHandles[A].shape)){return mxEvent.CUSTOM_HANDLE-A}}}if(D.isSource(this.state.text)||B(this.labelShape)){C=mxEvent.LABEL_HANDLE}if(this.bends!=null){for(var A=0;A<this.bends.length;A++){if(B(this.bends[A])){C=A}}}if(this.virtualBends!=null&&this.isAddVirtualBendEvent(D)){for(var A=0;A<this.virtualBends.length;A++){if(B(this.virtualBends[A])){C=mxEvent.VIRTUAL_HANDLE-A}}}return C};mxEdgeHandler.prototype.isAddVirtualBendEvent=function(A){return true};mxEdgeHandler.prototype.isCustomHandleEvent=function(A){return true};mxEdgeHandler.prototype.mouseDown=function(B,C){var A=this.getHandleForEvent(C);if(this.bends!=null&&this.bends[A]!=null){var D=this.bends[A].bounds;this.snapPoint=new mxPoint(D.getCenterX(),D.getCenterY())}if(this.addEnabled&&A==null&&this.isAddPointEvent(C.getEvent())){this.addPoint(this.state,C.getEvent());C.consume()}else{if(A!=null&&!C.isConsumed()&&this.graph.isEnabled()){if(this.removeEnabled&&this.isRemovePointEvent(C.getEvent())){this.removePoint(this.state,A)}else{if(A!=mxEvent.LABEL_HANDLE||this.graph.isLabelMovable(C.getCell())){if(A<=mxEvent.VIRTUAL_HANDLE){mxUtils.setOpacity(this.virtualBends[mxEvent.VIRTUAL_HANDLE-A].node,100)}this.start(C.getX(),C.getY(),A)}}C.consume()}}};mxEdgeHandler.prototype.start=function(C,D,B){this.startX=C;this.startY=D;this.isSource=(this.bends==null)?false:B==0;this.isTarget=(this.bends==null)?false:B==this.bends.length-1;this.isLabel=B==mxEvent.LABEL_HANDLE;if(this.isSource||this.isTarget){var E=this.state.cell;var F=this.graph.model.getTerminal(E,this.isSource);if((F==null&&this.graph.isTerminalPointMovable(E,this.isSource))||(F!=null&&this.graph.isCellDisconnectable(E,F,this.isSource))){this.index=B}}else{this.index=B}if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){if(A!=mxEvent.CUSTOM_HANDLE-this.index){this.customHandles[A].setVisible(false)}}}}};mxEdgeHandler.prototype.clonePreviewState=function(A,B){return this.state.clone()};mxEdgeHandler.prototype.getSnapToTerminalTolerance=function(){return this.graph.gridSize*this.graph.view.scale/2};mxEdgeHandler.prototype.updateHint=function(B,A){};mxEdgeHandler.prototype.removeHint=function(){};mxEdgeHandler.prototype.roundLength=function(A){return Math.round(A)};mxEdgeHandler.prototype.isSnapToTerminalsEvent=function(A){return this.snapToTerminals&&!mxEvent.isAltDown(A.getEvent())};mxEdgeHandler.prototype.getPointForEvent=function(E){var A=this.graph.getView();var B=A.scale;var K=new mxPoint(this.roundLength(E.getGraphX()/B)*B,this.roundLength(E.getGraphY()/B)*B);var C=this.getSnapToTerminalTolerance();var I=false;var J=false;if(C>0&&this.isSnapToTerminalsEvent(E)){function G(L){if(L!=null){var M=L.x;if(Math.abs(K.x-M)<C){K.x=M;I=true}var N=L.y;if(Math.abs(K.y-N)<C){K.y=N;J=true}}}function F(L){if(L!=null){G.call(this,new mxPoint(A.getRoutingCenterX(L),A.getRoutingCenterY(L)))}}F.call(this,this.state.getVisibleTerminalState(true));F.call(this,this.state.getVisibleTerminalState(false));if(this.state.absolutePoints!=null){for(var H=0;H<this.state.absolutePoints.length;H++){G.call(this,this.state.absolutePoints[H])}}}if(this.graph.isGridEnabledEvent(E.getEvent())){var D=A.translate;if(!I){K.x=(this.graph.snap(K.x/B-D.x)+D.x)*B}if(!J){K.y=(this.graph.snap(K.y/B-D.y)+D.y)*B}}return K};mxEdgeHandler.prototype.getPreviewTerminalState=function(B){this.constraintHandler.update(B,this.isSource,true,B.isSource(this.marker.highlight.shape)?null:this.currentPoint);if(this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null){if(this.marker.highlight!=null&&this.marker.highlight.state!=null&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell){if(this.marker.highlight.shape.stroke!="transparent"){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint()}}else{this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent")}var F=this.graph.getModel();var G=this.graph.view.getTerminalPort(this.state,this.graph.view.getState(F.getTerminal(this.state.cell,!this.isSource)),!this.isSource);var C=(G!=null)?G.cell:null;var A=(this.isSource)?this.constraintHandler.currentFocus.cell:C;var E=(this.isSource)?C:this.constraintHandler.currentFocus.cell;this.error=this.validateConnection(A,E);var D=null;if(this.error==null){D=this.constraintHandler.currentFocus}else{this.constraintHandler.reset()}return D}else{if(!this.graph.isIgnoreTerminalEvent(B.getEvent())){this.marker.process(B);return this.marker.getValidState()}else{this.marker.reset();return null}}};mxEdgeHandler.prototype.getPreviewPoints=function(B,J){var G=this.graph.getCellGeometry(this.state.cell);var K=(G.points!=null)?G.points.slice():null;var L=new mxPoint(B.x,B.y);var C=null;if(!this.isSource&&!this.isTarget){this.convertPoint(L,false);if(K==null){K=[L]}else{if(this.index<=mxEvent.VIRTUAL_HANDLE){K.splice(mxEvent.VIRTUAL_HANDLE-this.index,0,L)}if(!this.isSource&&!this.isTarget){for(var H=0;H<this.bends.length;H++){if(H!=this.index){var M=this.bends[H];if(M!=null&&mxUtils.contains(M.bounds,B.x,B.y)){if(this.index<=mxEvent.VIRTUAL_HANDLE){K.splice(mxEvent.VIRTUAL_HANDLE-this.index,1)}else{K.splice(this.index-1,1)}C=K}}}if(C==null&&this.straightRemoveEnabled&&(J==null||!mxEvent.isAltDown(J.getEvent()))){var E=this.graph.tolerance*this.graph.tolerance;var I=this.state.absolutePoints.slice();I[this.index]=B;var D=this.state.getVisibleTerminalState(true);if(D!=null){var N=this.graph.getConnectionConstraint(this.state,D,true);if(N==null||this.graph.getConnectionPoint(D,N)==null){I[0]=new mxPoint(D.view.getRoutingCenterX(D),D.view.getRoutingCenterY(D))}}var F=this.state.getVisibleTerminalState(false);if(F!=null){var N=this.graph.getConnectionConstraint(this.state,F,false);if(N==null||this.graph.getConnectionPoint(F,N)==null){I[I.length-1]=new mxPoint(F.view.getRoutingCenterX(F),F.view.getRoutingCenterY(F))}}function A(P,O){if(P>0&&P<I.length-1&&mxUtils.ptSegDistSq(I[P-1].x,I[P-1].y,I[P+1].x,I[P+1].y,O.x,O.y)<E){K.splice(P-1,1);C=K}}A(this.index,B)}}if(C==null&&this.index>mxEvent.VIRTUAL_HANDLE){K[this.index-1]=L}}}else{if(this.graph.resetEdgesOnConnect){K=null}}return(C!=null)?C:K};mxEdgeHandler.prototype.isOutlineConnectEvent=function(H){var B=mxUtils.getOffset(this.graph.container);var A=H.getEvent();var E=mxEvent.getClientX(A);var F=mxEvent.getClientY(A);var G=document.documentElement;var D=(window.pageXOffset||G.scrollLeft)-(G.clientLeft||0);var C=(window.pageYOffset||G.scrollTop)-(G.clientTop||0);var I=this.currentPoint.x-this.graph.container.scrollLeft+B.x-D;var J=this.currentPoint.y-this.graph.container.scrollTop+B.y-C;return this.outlineConnect&&!mxEvent.isShiftDown(H.getEvent())&&(H.isSource(this.marker.highlight.shape)||(mxEvent.isAltDown(H.getEvent())&&H.getState()!=null)||this.marker.highlight.isHighlightAt(E,F)||((I!=E||J!=F)&&H.getState()==null&&this.marker.highlight.isHighlightAt(I,J)))};mxEdgeHandler.prototype.updatePreviewState=function(F,K,J,H,G){var D=(this.isSource)?J:this.state.getVisibleTerminalState(true);var E=(this.isTarget)?J:this.state.getVisibleTerminalState(false);var A=this.graph.getConnectionConstraint(F,D,true);var C=this.graph.getConnectionConstraint(F,E,false);var I=this.constraintHandler.currentConstraint;if(I==null&&G){if(J!=null){if(H.isSource(this.marker.highlight.shape)){K=new mxPoint(H.getGraphX(),H.getGraphY())}I=this.graph.getOutlineConstraint(K,J,H);this.constraintHandler.setFocus(H,J,this.isSource);this.constraintHandler.currentConstraint=I;this.constraintHandler.currentPoint=K}else{I=new mxConnectionConstraint()}}if(this.outlineConnect&&this.marker.highlight!=null&&this.marker.highlight.shape!=null){var B=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){this.marker.highlight.shape.stroke=(G)?mxConstants.OUTLINE_HIGHLIGHT_COLOR:"transparent";this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/B/B;this.marker.highlight.repaint()}else{if(this.marker.hasValidState()){this.marker.highlight.shape.stroke=(this.marker.getValidState()==H.getState())?mxConstants.DEFAULT_VALID_COLOR:"transparent";this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/B/B;this.marker.highlight.repaint()}}}if(this.isSource){A=I}else{if(this.isTarget){C=I}}if(this.isSource||this.isTarget){if(I!=null&&I.point!=null){F.style[(this.isSource)?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X]=I.point.x;F.style[(this.isSource)?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y]=I.point.y}else{delete F.style[(this.isSource)?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X];delete F.style[(this.isSource)?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y]}}F.setVisibleTerminalState(D,true);F.setVisibleTerminalState(E,false);if(!this.isSource||D!=null){F.view.updateFixedTerminalPoint(F,D,true,A)}if(!this.isTarget||E!=null){F.view.updateFixedTerminalPoint(F,E,false,C)}if((this.isSource||this.isTarget)&&J==null){F.setAbsoluteTerminalPoint(K,this.isSource);if(this.marker.getMarkedState()==null){this.error=(this.graph.allowDanglingEdges)?null:""}}F.view.updatePoints(F,this.points,D,E);F.view.updateFloatingTerminalPoints(F,D,E)};mxEdgeHandler.prototype.mouseMove=function(A,D){if(this.index!=null&&this.marker!=null){this.currentPoint=this.getPointForEvent(D);this.error=null;if(!this.graph.isIgnoreTerminalEvent(D.getEvent())&&mxEvent.isShiftDown(D.getEvent())&&this.snapPoint!=null){if(Math.abs(this.snapPoint.x-this.currentPoint.x)<Math.abs(this.snapPoint.y-this.currentPoint.y)){this.currentPoint.x=this.snapPoint.x}else{this.currentPoint.y=this.snapPoint.y}}if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].processEvent(D)}}else{if(this.isLabel){this.label.x=this.currentPoint.x;this.label.y=this.currentPoint.y}else{this.points=this.getPreviewPoints(this.currentPoint,D);var F=(this.isSource||this.isTarget)?this.getPreviewTerminalState(D):null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null){this.currentPoint=this.constraintHandler.currentPoint.clone()}else{if(this.outlineConnect){var E=(this.isSource||this.isTarget)?this.isOutlineConnectEvent(D):false;if(E){F=this.marker.highlight.state}else{if(F!=null&&F!=D.getState()&&this.marker.highlight.shape!=null){this.marker.highlight.shape.stroke="transparent";this.marker.highlight.repaint();F=null}}}}var B=this.clonePreviewState(this.currentPoint,(F!=null)?F.cell:null);this.updatePreviewState(B,this.currentPoint,F,D,E);var C=(this.error==null)?this.marker.validColor:this.marker.invalidColor;this.setPreviewColor(C);this.abspoints=B.absolutePoints;this.active=true}}this.updateHint(D,this.currentPoint);this.drawPreview();mxEvent.consume(D.getEvent());D.consume()}else{if(mxClient.IS_IE&&this.getHandleForEvent(D)!=null){D.consume(false)}}};mxEdgeHandler.prototype.mouseUp=function(H,F){if(this.index!=null&&this.marker!=null){var E=this.state.cell;if(F.getX()!=this.startX||F.getY()!=this.startY){var B=!this.graph.isIgnoreTerminalEvent(F.getEvent())&&this.graph.isCloneEvent(F.getEvent())&&this.cloneEnabled&&this.graph.isCellsCloneable();if(this.error!=null){if(this.error.length>0){this.graph.validationAlert(this.error)}}else{if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){var G=this.graph.getModel();G.beginUpdate();try{this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].execute()}finally{G.endUpdate()}}}else{if(this.isLabel){this.moveLabel(this.state,this.label.x,this.label.y)}else{if(this.isSource||this.isTarget){var D=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null){D=this.constraintHandler.currentFocus.cell}if(D==null&&this.marker.hasValidState()&&this.marker.highlight!=null&&this.marker.highlight.shape!=null&&this.marker.highlight.shape.stroke!="transparent"&&this.marker.highlight.shape.stroke!="white"){D=this.marker.validState.cell}if(D!=null){E=this.connect(E,D,this.isSource,B,F)}else{if(this.graph.isAllowDanglingEdges()){var A=this.abspoints[(this.isSource)?0:this.abspoints.length-1];A.x=this.roundLength(A.x/this.graph.view.scale-this.graph.view.translate.x);A.y=this.roundLength(A.y/this.graph.view.scale-this.graph.view.translate.y);var C=this.graph.getView().getState(this.graph.getModel().getParent(E));if(C!=null){A.x-=C.origin.x;A.y-=C.origin.y}A.x-=this.graph.panDx/this.graph.view.scale;A.y-=this.graph.panDy/this.graph.view.scale;E=this.changeTerminalPoint(E,A,this.isSource,B)}}}else{if(this.active){E=this.changePoints(E,this.points,B)}else{this.graph.getView().invalidate(this.state.cell);this.graph.getView().validate(this.state.cell)}}}}}}if(this.marker!=null){this.reset();if(E!=this.state.cell){this.graph.setSelectionCell(E)}}F.consume()}};mxEdgeHandler.prototype.reset=function(){this.error=null;this.index=null;this.label=null;this.points=null;this.snapPoint=null;this.active=false;this.isLabel=false;this.isSource=false;this.isTarget=false;if(this.livePreview&&this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(this.sizers[A]!=null){this.sizers[A].node.style.display=""}}}if(this.marker!=null){this.marker.reset()}if(this.constraintHandler!=null){this.constraintHandler.reset()}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].reset()}}this.setPreviewColor(mxConstants.EDGE_SELECTION_COLOR);this.removeHint();this.redraw()};mxEdgeHandler.prototype.setPreviewColor=function(A){if(this.shape!=null){this.shape.stroke=A}};mxEdgeHandler.prototype.convertPoint=function(B,A){var D=this.graph.getView().getScale();var C=this.graph.getView().getTranslate();if(A){B.x=this.graph.snap(B.x);B.y=this.graph.snap(B.y)}B.x=Math.round(B.x/D-C.x);B.y=Math.round(B.y/D-C.y);var E=this.graph.getView().getState(this.graph.getModel().getParent(this.state.cell));if(E!=null){B.x-=E.origin.x;B.y-=E.origin.y}return B};mxEdgeHandler.prototype.moveLabel=function(K,J,A){var L=this.graph.getModel();var G=L.getGeometry(K.cell);if(G!=null){var D=this.graph.getView().scale;G=G.clone();if(G.relative){var E=this.graph.getView().getRelativePoint(K,J,A);G.x=Math.round(E.x*10000)/10000;G.y=Math.round(E.y);G.offset=new mxPoint(0,0);var E=this.graph.view.getPoint(K,G);G.offset=new mxPoint(Math.round((J-E.x)/D),Math.round((A-E.y)/D))}else{var C=K.absolutePoints;var I=C[0];var B=C[C.length-1];if(I!=null&&B!=null){var H=I.x+(B.x-I.x)/2;var F=I.y+(B.y-I.y)/2;G.offset=new mxPoint(Math.round((J-H)/D),Math.round((A-F)/D));G.x=0;G.y=0}}L.setGeometry(K.cell,G)}};mxEdgeHandler.prototype.connect=function(E,D,G,A,F){var J=this.graph.getModel();var I=J.getParent(E);J.beginUpdate();try{if(A){var B=this.graph.cloneCells([E])[0];J.add(I,B,J.getChildCount(I));var C=J.getTerminal(E,!G);this.graph.connectCell(B,C,!G);E=B}var H=this.constraintHandler.currentConstraint;if(H==null){H=new mxConnectionConstraint()}this.graph.connectCell(E,D,G,H)}finally{J.endUpdate()}return E};mxEdgeHandler.prototype.changeTerminalPoint=function(D,F,E,A){var H=this.graph.getModel();H.beginUpdate();try{if(A){var G=H.getParent(D);var C=H.getTerminal(D,!E);D=this.graph.cloneCells([D])[0];H.add(G,D,H.getChildCount(G));H.setTerminal(D,C,!E)}var B=H.getGeometry(D);if(B!=null){B=B.clone();B.setTerminalPoint(F,E);H.setGeometry(D,B);this.graph.connectCell(D,null,E,new mxConnectionConstraint())}}finally{H.endUpdate()}return D};mxEdgeHandler.prototype.changePoints=function(C,F,A){var H=this.graph.getModel();H.beginUpdate();try{if(A){var G=H.getParent(C);var D=H.getTerminal(C,true);var E=H.getTerminal(C,false);C=this.graph.cloneCells([C])[0];H.add(G,C,H.getChildCount(G));H.setTerminal(C,D,true);H.setTerminal(C,E,false)}var B=H.getGeometry(C);if(B!=null){B=B.clone();B.points=F;H.setGeometry(C,B)}}finally{H.endUpdate()}return C};mxEdgeHandler.prototype.addPoint=function(D,C){var B=mxUtils.convertPoint(this.graph.container,mxEvent.getClientX(C),mxEvent.getClientY(C));var A=this.graph.isGridEnabledEvent(C);this.convertPoint(B,A);this.addPointAt(D,B.x,B.y);mxEvent.consume(C)};mxEdgeHandler.prototype.addPointAt=function(G,I,J){var K=this.graph.getCellGeometry(G.cell);var B=new mxPoint(I,J);if(K!=null){K=K.clone();var E=this.graph.view.translate;var D=this.graph.view.scale;var C=new mxPoint(E.x*D,E.y*D);var H=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(H)){var A=this.graph.view.getState(H);C=new mxPoint(A.x,A.y)}var F=mxUtils.findNearestSegment(G,B.x*D+C.x,B.y*D+C.y);if(K.points==null){K.points=[B]}else{K.points.splice(F,0,B)}this.graph.getModel().setGeometry(G.cell,K);this.refresh();this.redraw()}};mxEdgeHandler.prototype.removePoint=function(C,B){if(B>0&&B<this.abspoints.length-1){var A=this.graph.getCellGeometry(this.state.cell);if(A!=null&&A.points!=null){A=A.clone();A.points.splice(B-1,1);this.graph.getModel().setGeometry(C.cell,A);this.refresh();this.redraw()}}};mxEdgeHandler.prototype.getHandleFillColor=function(B){var A=B==0;var C=this.state.cell;var E=this.graph.getModel().getTerminal(C,A);var D=mxConstants.HANDLE_FILLCOLOR;if((E!=null&&!this.graph.isCellDisconnectable(C,E,A))||(E==null&&!this.graph.isTerminalPointMovable(C,A))){D=mxConstants.LOCKED_HANDLE_FILLCOLOR}else{if(E!=null&&this.graph.isCellDisconnectable(C,E,A)){D=mxConstants.CONNECT_HANDLE_FILLCOLOR}}return D};mxEdgeHandler.prototype.redraw=function(){this.abspoints=this.state.absolutePoints.slice();this.redrawHandles();var A=this.graph.getModel().getGeometry(this.state.cell);var C=A.points;if(this.bends!=null&&this.bends.length>0){if(C!=null){if(this.points==null){this.points=[]}for(var B=1;B<this.bends.length-1;B++){if(this.bends[B]!=null&&this.abspoints[B]!=null){this.points[B-1]=C[B-1]}}}}this.drawPreview()};mxEdgeHandler.prototype.redrawHandles=function(){var P=this.state.cell;var K=this.labelShape.bounds;this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y);this.labelShape.bounds=new mxRectangle(Math.round(this.label.x-K.width/2),Math.round(this.label.y-K.height/2),K.width,K.height);var N=this.graph.getLabel(P);this.labelShape.visible=(N!=null&&N.length>0&&this.graph.isLabelMovable(P));if(this.bends!=null&&this.bends.length>0){var H=this.abspoints.length-1;var J=this.abspoints[0];var C=J.x;var D=J.y;K=this.bends[0].bounds;this.bends[0].bounds=new mxRectangle(Math.floor(C-K.width/2),Math.floor(D-K.height/2),K.width,K.height);this.bends[0].fill=this.getHandleFillColor(0);this.bends[0].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[0].bounds)}var B=this.abspoints[H];var F=B.x;var G=B.y;var E=this.bends.length-1;K=this.bends[E].bounds;this.bends[E].bounds=new mxRectangle(Math.floor(F-K.width/2),Math.floor(G-K.height/2),K.width,K.height);this.bends[E].fill=this.getHandleFillColor(E);this.bends[E].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[E].bounds)}this.redrawInnerBends(J,B)}if(this.abspoints!=null&&this.virtualBends!=null&&this.virtualBends.length>0){var M=this.abspoints[0];for(var I=0;I<this.virtualBends.length;I++){if(this.virtualBends[I]!=null&&this.abspoints[I+1]!=null){var A=this.abspoints[I+1];var K=this.virtualBends[I];var L=M.x+(A.x-M.x)/2;var O=M.y+(A.y-M.y)/2;K.bounds=new mxRectangle(Math.floor(L-K.bounds.width/2),Math.floor(O-K.bounds.height/2),K.bounds.width,K.bounds.height);K.redraw();mxUtils.setOpacity(K.node,this.virtualBendOpacity);M=A;if(this.manageLabelHandle){this.checkLabelHandle(K.bounds)}}}}if(this.labelShape!=null){this.labelShape.redraw()}if(this.customHandles!=null){for(var I=0;I<this.customHandles.length;I++){this.customHandles[I].redraw()}}};mxEdgeHandler.prototype.setHandlesVisible=function(B){if(this.bends!=null){for(var A=0;A<this.bends.length;A++){this.bends[A].node.style.display=(B)?"":"none"}}if(this.virtualBends!=null){for(var A=0;A<this.virtualBends.length;A++){this.virtualBends[A].node.style.display=(B)?"":"none"}}if(this.labelShape!=null){this.labelShape.node.style.display=(B)?"":"none"}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].setVisible(B)}}};mxEdgeHandler.prototype.redrawInnerBends=function(B,F){for(var A=1;A<this.bends.length-1;A++){if(this.bends[A]!=null){if(this.abspoints[A]!=null){var C=this.abspoints[A].x;var D=this.abspoints[A].y;var E=this.bends[A].bounds;this.bends[A].node.style.visibility="visible";this.bends[A].bounds=new mxRectangle(Math.round(C-E.width/2),Math.round(D-E.height/2),E.width,E.height);if(this.manageLabelHandle){this.checkLabelHandle(this.bends[A].bounds)}else{if(this.handleImage==null&&this.labelShape.visible&&mxUtils.intersects(this.bends[A].bounds,this.labelShape.bounds)){w=mxConstants.HANDLE_SIZE+3;h=mxConstants.HANDLE_SIZE+3;this.bends[A].bounds=new mxRectangle(Math.round(C-w/2),Math.round(D-h/2),w,h)}}this.bends[A].redraw()}else{this.bends[A].destroy();this.bends[A]=null}}}};mxEdgeHandler.prototype.checkLabelHandle=function(B){if(this.labelShape!=null){var A=this.labelShape.bounds;if(mxUtils.intersects(B,A)){if(B.getCenterY()<A.getCenterY()){A.y=B.y+B.height}else{A.y=B.y-A.height}}}};mxEdgeHandler.prototype.drawPreview=function(){if(this.isLabel){var B=this.labelShape.bounds;var A=new mxRectangle(Math.round(this.label.x-B.width/2),Math.round(this.label.y-B.height/2),B.width,B.height);this.labelShape.bounds=A;this.labelShape.redraw()}else{if(this.shape!=null){this.shape.apply(this.state);this.shape.points=this.abspoints;this.shape.scale=this.state.view.scale;this.shape.isDashed=this.isSelectionDashed();this.shape.stroke=this.getSelectionColor();this.shape.strokewidth=this.getSelectionStrokeWidth()/this.shape.scale/this.shape.scale;this.shape.arrowStrokewidth=this.getSelectionStrokeWidth();this.shape.isShadow=false;this.shape.redraw()}}if(this.parentHighlight!=null){this.parentHighlight.redraw()}};mxEdgeHandler.prototype.refresh=function(){this.abspoints=this.getSelectionPoints(this.state);this.points=[];if(this.shape!=null){this.shape.points=this.abspoints}if(this.bends!=null){this.destroyBends(this.bends);this.bends=this.createBends()}if(this.virtualBends!=null){this.destroyBends(this.virtualBends);this.virtualBends=this.createVirtualBends()}if(this.customHandles!=null){this.destroyBends(this.customHandles);this.customHandles=this.createCustomHandles()}if(this.labelShape!=null&&this.labelShape.node!=null&&this.labelShape.node.parentNode!=null){this.labelShape.node.parentNode.appendChild(this.labelShape.node)}};mxEdgeHandler.prototype.destroyBends=function(A){if(A!=null){for(var B=0;B<A.length;B++){if(A[B]!=null){A[B].destroy()}}}};mxEdgeHandler.prototype.destroy=function(){if(this.escapeHandler!=null){this.state.view.graph.removeListener(this.escapeHandler);this.escapeHandler=null}if(this.marker!=null){this.marker.destroy();this.marker=null}if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.parentHighlight!=null){this.parentHighlight.destroy();this.parentHighlight=null}if(this.labelShape!=null){this.labelShape.destroy();this.labelShape=null}if(this.constraintHandler!=null){this.constraintHandler.destroy();this.constraintHandler=null}this.destroyBends(this.virtualBends);this.virtualBends=null;this.destroyBends(this.customHandles);this.customHandles=null;this.destroyBends(this.bends);this.bends=null;this.removeHint()};function mxEdgeSegmentHandler(A){mxEdgeHandler.call(this,A)}mxUtils.extend(mxEdgeSegmentHandler,mxElbowEdgeHandler);mxEdgeSegmentHandler.prototype.getCurrentPoints=function(){var B=this.state.absolutePoints;if(B!=null){if(B.length==2||(B.length==3&&(B[0].x==B[1].x&&B[1].x==B[2].x||B[0].y==B[1].y&&B[1].y==B[2].y))){var C=B[0].x+(B[B.length-1].x-B[0].x)/2;var A=B[0].y+(B[B.length-1].y-B[0].y)/2;B=[B[0],new mxPoint(C,A),new mxPoint(C,A),B[B.length-1]]}}return B};mxEdgeSegmentHandler.prototype.getPreviewPoints=function(K){if(this.isSource||this.isTarget){return mxElbowEdgeHandler.prototype.getPreviewPoints.apply(this,arguments)}else{var A=this.getCurrentPoints();var F=this.convertPoint(A[0].clone(),false);K=this.convertPoint(K.clone(),false);var C=[];for(var E=1;E<A.length;E++){var B=this.convertPoint(A[E].clone(),false);if(E==this.index){if(Math.round(F.x-B.x)==0){F.x=K.x;B.x=K.x}if(Math.round(F.y-B.y)==0){F.y=K.y;B.y=K.y}}if(E<A.length-1){C.push(B)}F=B}if(C.length==1){var G=this.state.getVisibleTerminalState(true);var H=this.state.getVisibleTerminalState(false);var D=this.state.view.getScale();var I=this.state.view.getTranslate();var L=C[0].x*D+I.x;var J=C[0].y*D+I.y;if((G!=null&&mxUtils.contains(G,L,J))||(H!=null&&mxUtils.contains(H,L,J))){C=[K,K]}}return C}};mxEdgeSegmentHandler.prototype.updatePreviewState=function(A,B,C,I){mxEdgeHandler.prototype.updatePreviewState.apply(this,arguments);if(!this.isSource&&!this.isTarget){B=this.convertPoint(B.clone(),false);var D=A.absolutePoints;var K=D[0];var L=D[1];var E=[];for(var H=2;H<D.length;H++){var J=D[H];if((Math.round(K.x-L.x)!=0||Math.round(L.x-J.x)!=0)&&(Math.round(K.y-L.y)!=0||Math.round(L.y-J.y)!=0)){E.push(this.convertPoint(L.clone(),false))}K=L;L=J}var M=this.state.getVisibleTerminalState(true);var S=this.state.getVisibleTerminalState(false);var R=this.state.absolutePoints;if(E.length==0&&(Math.round(D[0].x-D[D.length-1].x)==0||Math.round(D[0].y-D[D.length-1].y)==0)){E=[B,B]}else{if(D.length==5&&E.length==2&&M!=null&&S!=null&&R!=null&&Math.round(R[0].x-R[R.length-1].x)==0){var Q=this.graph.getView();var O=Q.getScale();var P=Q.getTranslate();var G=Q.getRoutingCenterY(M)/O-P.y;var U=this.graph.getConnectionConstraint(A,M,true);if(U!=null){var N=this.graph.getConnectionPoint(M,U);if(N!=null){this.convertPoint(N,false);G=N.y}}var T=Q.getRoutingCenterY(S)/O-P.y;var F=this.graph.getConnectionConstraint(A,S,false);if(F){var N=this.graph.getConnectionPoint(S,F);if(N!=null){this.convertPoint(N,false);T=N.y}}E=[new mxPoint(B.x,G),new mxPoint(B.x,T)]}}this.points=E;A.view.updateFixedTerminalPoints(A,M,S);A.view.updatePoints(A,this.points,M,S);A.view.updateFloatingTerminalPoints(A,M,S)}};mxEdgeSegmentHandler.prototype.connect=function(I,F,K,B,J){var A=this.abspoints;var D=A[0];var E=A[1];var H=[];for(var G=2;G<A.length;G++){var C=A[G];if((Math.round(D.x-E.x)!=0||Math.round(E.x-C.x)!=0)&&(Math.round(D.y-E.y)!=0||Math.round(E.y-C.y)!=0)){H.push(this.convertPoint(E.clone(),false))}D=E;E=C}var M=this.graph.getModel();M.beginUpdate();try{var L=M.getGeometry(I);if(L!=null){L=L.clone();L.points=H;M.setGeometry(I,L)}I=mxEdgeHandler.prototype.connect.apply(this,arguments)}finally{M.endUpdate()}return I};mxEdgeSegmentHandler.prototype.getTooltipForNode=function(A){return null};mxEdgeSegmentHandler.prototype.start=function(B,C,A){mxEdgeHandler.prototype.start.apply(this,arguments);if(this.bends[A]!=null&&!this.isSource&&!this.isTarget){mxUtils.setOpacity(this.bends[A].node,100)}};mxEdgeSegmentHandler.prototype.createBends=function(){var A=[];var C=this.createHandleShape(0);this.initBend(C);C.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(C);var E=this.getCurrentPoints();if(this.graph.isCellBendable(this.state.cell)){if(this.points==null){this.points=[]}for(var B=0;B<E.length-1;B++){C=this.createVirtualBend();A.push(C);var D=Math.round(E[B].x-E[B+1].x)==0;if(Math.round(E[B].y-E[B+1].y)==0&&B<E.length-2){D=Math.round(E[B].x-E[B+2].x)==0}C.setCursor((D)?"col-resize":"row-resize");this.points.push(new mxPoint(0,0))}}var C=this.createHandleShape(E.length);this.initBend(C);C.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(C);return A};mxEdgeSegmentHandler.prototype.redraw=function(){this.refresh();mxEdgeHandler.prototype.redraw.apply(this,arguments)};mxEdgeSegmentHandler.prototype.redrawInnerBends=function(H,C){if(this.graph.isCellBendable(this.state.cell)){var A=this.getCurrentPoints();if(A!=null&&A.length>1){var D=false;if(A.length==4&&Math.round(A[1].x-A[2].x)==0&&Math.round(A[1].y-A[2].y)==0){D=true;if(Math.round(A[0].y-A[A.length-1].y)==0){var F=A[0].x+(A[A.length-1].x-A[0].x)/2;A[1]=new mxPoint(F,A[1].y);A[2]=new mxPoint(F,A[2].y)}else{var E=A[0].y+(A[A.length-1].y-A[0].y)/2;A[1]=new mxPoint(A[1].x,E);A[2]=new mxPoint(A[2].x,E)}}for(var G=0;G<A.length-1;G++){if(this.bends[G+1]!=null){var H=A[G];var C=A[G+1];var B=new mxPoint(H.x+(C.x-H.x)/2,H.y+(C.y-H.y)/2);var I=this.bends[G+1].bounds;this.bends[G+1].bounds=new mxRectangle(Math.floor(B.x-I.width/2),Math.floor(B.y-I.height/2),I.width,I.height);this.bends[G+1].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[G+1].bounds)}}}if(D){mxUtils.setOpacity(this.bends[1].node,this.virtualBendOpacity);mxUtils.setOpacity(this.bends[3].node,this.virtualBendOpacity)}}}};function mxElbowEdgeHandler(A){mxEdgeHandler.call(this,A)}mxUtils.extend(mxElbowEdgeHandler,mxEdgeHandler);mxElbowEdgeHandler.prototype.flipEnabled=true;mxElbowEdgeHandler.prototype.doubleClickOrientationResource=(mxClient.language!="none")?"doubleClickOrientation":"";mxElbowEdgeHandler.prototype.createBends=function(){var A=[];var B=this.createHandleShape(0);this.initBend(B);B.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(B);A.push(this.createVirtualBend(mxUtils.bind(this,function(C){if(!mxEvent.isConsumed(C)&&this.flipEnabled){this.graph.flipEdge(this.state.cell,C);mxEvent.consume(C)}})));this.points.push(new mxPoint(0,0));B=this.createHandleShape(2);this.initBend(B);B.setCursor(mxConstants.CURSOR_TERMINAL_HANDLE);A.push(B);return A};mxElbowEdgeHandler.prototype.createVirtualBend=function(B){var A=this.createHandleShape();this.initBend(A,B);A.setCursor(this.getCursorForBend());if(!this.graph.isCellBendable(this.state.cell)){A.node.style.display="none"}return A};mxElbowEdgeHandler.prototype.getCursorForBend=function(){return(this.state.style[mxConstants.STYLE_EDGE]==mxEdgeStyle.TopToBottom||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.EDGESTYLE_TOPTOBOTTOM||((this.state.style[mxConstants.STYLE_EDGE]==mxEdgeStyle.ElbowConnector||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.EDGESTYLE_ELBOW)&&this.state.style[mxConstants.STYLE_ELBOW]==mxConstants.ELBOW_VERTICAL))?"row-resize":"col-resize"};mxElbowEdgeHandler.prototype.getTooltipForNode=function(B){var A=null;if(this.bends!=null&&this.bends[1]!=null&&(B==this.bends[1].node||B.parentNode==this.bends[1].node)){A=this.doubleClickOrientationResource;A=mxResources.get(A)||A}return A};mxElbowEdgeHandler.prototype.convertPoint=function(B,A){var E=this.graph.getView().getScale();var C=this.graph.getView().getTranslate();var D=this.state.origin;if(A){B.x=this.graph.snap(B.x);B.y=this.graph.snap(B.y)}B.x=Math.round(B.x/E-C.x-D.x);B.y=Math.round(B.y/E-C.y-D.y);return B};mxElbowEdgeHandler.prototype.redrawInnerBends=function(G,C){var I=this.graph.getModel().getGeometry(this.state.cell);var A=this.state.absolutePoints;var B=null;if(A.length>1){G=A[1];C=A[A.length-2]}else{if(I.points!=null&&I.points.length>0){B=A[0]}}if(B==null){B=new mxPoint(G.x+(C.x-G.x)/2,G.y+(C.y-G.y)/2)}else{B=new mxPoint(this.graph.getView().scale*(B.x+this.graph.getView().translate.x+this.state.origin.x),this.graph.getView().scale*(B.y+this.graph.getView().translate.y+this.state.origin.y))}var H=this.bends[1].bounds;var E=H.width;var F=H.height;var D=new mxRectangle(Math.round(B.x-E/2),Math.round(B.y-F/2),E,F);if(this.manageLabelHandle){this.checkLabelHandle(D)}else{if(this.handleImage==null&&this.labelShape.visible&&mxUtils.intersects(D,this.labelShape.bounds)){E=mxConstants.HANDLE_SIZE+3;F=mxConstants.HANDLE_SIZE+3;D=new mxRectangle(Math.floor(B.x-E/2),Math.floor(B.y-F/2),E,F)}}this.bends[1].bounds=D;this.bends[1].redraw();if(this.manageLabelHandle){this.checkLabelHandle(this.bends[1].bounds)}};function mxGraphHandler(A){this.graph=A;this.graph.addMouseListener(this);this.panHandler=mxUtils.bind(this,function(){this.updatePreviewShape();this.updateHint()});this.graph.addListener(mxEvent.PAN,this.panHandler);this.escapeHandler=mxUtils.bind(this,function(B,C){this.reset()});this.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}mxGraphHandler.prototype.graph=null;mxGraphHandler.prototype.maxCells=(mxClient.IS_IE)?20:50;mxGraphHandler.prototype.enabled=true;mxGraphHandler.prototype.highlightEnabled=true;mxGraphHandler.prototype.cloneEnabled=true;mxGraphHandler.prototype.moveEnabled=true;mxGraphHandler.prototype.guidesEnabled=false;mxGraphHandler.prototype.guide=null;mxGraphHandler.prototype.currentDx=null;mxGraphHandler.prototype.currentDy=null;mxGraphHandler.prototype.updateCursor=true;mxGraphHandler.prototype.selectEnabled=true;mxGraphHandler.prototype.removeCellsFromParent=true;mxGraphHandler.prototype.connectOnDrop=false;mxGraphHandler.prototype.scrollOnMove=true;mxGraphHandler.prototype.minimumSize=6;mxGraphHandler.prototype.previewColor="black";mxGraphHandler.prototype.htmlPreview=false;mxGraphHandler.prototype.shape=null;mxGraphHandler.prototype.scaleGrid=false;mxGraphHandler.prototype.rotationEnabled=true;mxGraphHandler.prototype.isEnabled=function(){return this.enabled};mxGraphHandler.prototype.setEnabled=function(A){this.enabled=A};mxGraphHandler.prototype.isCloneEnabled=function(){return this.cloneEnabled};mxGraphHandler.prototype.setCloneEnabled=function(A){this.cloneEnabled=A};mxGraphHandler.prototype.isMoveEnabled=function(){return this.moveEnabled};mxGraphHandler.prototype.setMoveEnabled=function(A){this.moveEnabled=A};mxGraphHandler.prototype.isSelectEnabled=function(){return this.selectEnabled};mxGraphHandler.prototype.setSelectEnabled=function(A){this.selectEnabled=A};mxGraphHandler.prototype.isRemoveCellsFromParent=function(){return this.removeCellsFromParent};mxGraphHandler.prototype.setRemoveCellsFromParent=function(A){this.removeCellsFromParent=A};mxGraphHandler.prototype.getInitialCellForEvent=function(A){return A.getCell()};mxGraphHandler.prototype.isDelayedSelection=function(B,A){return this.graph.isCellSelected(B)};mxGraphHandler.prototype.consumeMouseEvent=function(B,A){A.consume()};mxGraphHandler.prototype.mouseDown=function(A,B){if(!B.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&B.getState()!=null&&!mxEvent.isMultiTouchEvent(B.getEvent())){var C=this.getInitialCellForEvent(B);this.delayedSelection=this.isDelayedSelection(C,B);this.cell=null;if(this.isSelectEnabled()&&!this.delayedSelection){this.graph.selectCellForEvent(C,B.getEvent())}if(this.isMoveEnabled()){var D=this.graph.model;var E=D.getGeometry(C);if(this.graph.isCellMovable(C)&&((!D.isEdge(C)||this.graph.getSelectionCount()>1||(E.points!=null&&E.points.length>0)||D.getTerminal(C,true)==null||D.getTerminal(C,false)==null)||this.graph.allowDanglingEdges||(this.graph.isCloneEvent(B.getEvent())&&this.graph.isCellsCloneable()))){this.start(C,B.getX(),B.getY())}else{if(this.delayedSelection){this.cell=C}}this.cellWasClicked=true;this.consumeMouseEvent(mxEvent.MOUSE_DOWN,B)}}};mxGraphHandler.prototype.getGuideStates=function(){var B=this.graph.getDefaultParent();var C=this.graph.getModel();var A=mxUtils.bind(this,function(D){return this.graph.view.getState(D)!=null&&C.isVertex(D)&&C.getGeometry(D)!=null&&!C.getGeometry(D).relative});return this.graph.view.getCellStates(C.filterDescendants(A,B))};mxGraphHandler.prototype.getCells=function(A){if(!this.delayedSelection&&this.graph.isCellMovable(A)){return[A]}else{return this.graph.getMovableCells(this.graph.getSelectionCells())}};mxGraphHandler.prototype.getPreviewBounds=function(E){var C=this.getBoundingBox(E);if(C!=null){C.width=Math.max(0,C.width-1);C.height=Math.max(0,C.height-1);if(C.width<this.minimumSize){var D=this.minimumSize-C.width;C.x-=D/2;C.width=this.minimumSize}else{C.x=Math.round(C.x);C.width=Math.ceil(C.width)}var F=this.graph.view.translate;var B=this.graph.view.scale;if(C.height<this.minimumSize){var A=this.minimumSize-C.height;C.y-=A/2;C.height=this.minimumSize}else{C.y=Math.round(C.y);C.height=Math.ceil(C.height)}}return C};mxGraphHandler.prototype.getBoundingBox=function(D){var C=null;if(D!=null&&D.length>0){var E=this.graph.getModel();for(var A=0;A<D.length;A++){if(E.isVertex(D[A])||E.isEdge(D[A])){var F=this.graph.view.getState(D[A]);if(F!=null){var B=F;if(E.isVertex(D[A])&&F.shape!=null&&F.shape.boundingBox!=null){B=F.shape.boundingBox}if(C==null){C=mxRectangle.fromRectangle(B)}else{C.add(B)}}}}}return C};mxGraphHandler.prototype.createPreviewShape=function(A){var B=new mxRectangleShape(A,null,this.previewColor);B.isDashed=true;if(this.htmlPreview){B.dialect=mxConstants.DIALECT_STRICTHTML;B.init(this.graph.container)}else{B.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;B.init(this.graph.getView().getOverlayPane());B.pointerEvents=false;if(mxClient.IS_IOS){B.getSvgScreenOffset=function(){return 0}}}return B};mxGraphHandler.prototype.start=function(C,A,B){this.cell=C;this.first=mxUtils.convertPoint(this.graph.container,A,B);this.cells=this.getCells(this.cell);this.bounds=this.graph.getView().getBounds(this.cells);this.pBounds=this.getPreviewBounds(this.cells);if(this.guidesEnabled){this.guide=new mxGuide(this.graph,this.getGuideStates())}};mxGraphHandler.prototype.useGuidesForEvent=function(A){return(this.guide!=null)?this.guide.isEnabledForEvent(A.getEvent()):true};mxGraphHandler.prototype.snap=function(B){var A=(this.scaleGrid)?this.graph.view.scale:1;B.x=this.graph.snap(B.x/A)*A;B.y=this.graph.snap(B.y/A)*A;return B};mxGraphHandler.prototype.getDelta=function(C){var B=mxUtils.convertPoint(this.graph.container,C.getX(),C.getY());var A=this.graph.view.scale;return new mxPoint(this.roundLength((B.x-this.first.x)/A)*A,this.roundLength((B.y-this.first.y)/A)*A)};mxGraphHandler.prototype.updateHint=function(A){};mxGraphHandler.prototype.removeHint=function(){};mxGraphHandler.prototype.roundLength=function(A){return Math.round(A)};mxGraphHandler.prototype.mouseMove=function(Q,G){var S=this.graph;if(!G.isConsumed()&&S.isMouseDown&&this.cell!=null&&this.first!=null&&this.bounds!=null){if(mxEvent.isMultiTouchEvent(G.getEvent())){this.reset();return}var J=this.getDelta(G);var K=J.x;var R=J.y;var U=S.tolerance;if(this.shape!=null||Math.abs(K)>U||Math.abs(R)>U){if(this.highlight==null){this.highlight=new mxCellHighlight(this.graph,mxConstants.DROP_TARGET_COLOR,3)}if(this.shape==null){this.shape=this.createPreviewShape(this.bounds)}var M=S.isGridEnabledEvent(G.getEvent());var E=true;if(this.guide!=null&&this.useGuidesForEvent(G)){J=this.guide.move(this.bounds,new mxPoint(K,R),M);E=false;K=J.x;R=J.y}else{if(M){var C=S.getView().translate;var N=S.getView().scale;var V=this.bounds.x-(S.snap(this.bounds.x/N-C.x)+C.x)*N;var I=this.bounds.y-(S.snap(this.bounds.y/N-C.y)+C.y)*N;var A=this.snap(new mxPoint(K,R));K=A.x-V;R=A.y-I}}if(this.guide!=null&&E){this.guide.hide()}if(S.isConstrainedEvent(G.getEvent())){if(Math.abs(K)>Math.abs(R)){R=0}else{K=0}}this.currentDx=K;this.currentDy=R;this.updatePreviewShape();var T=null;var L=G.getCell();var H=S.isCloneEvent(G.getEvent())&&S.isCellsCloneable()&&this.isCloneEnabled();if(S.isDropEnabled()&&this.highlightEnabled){T=S.getDropTarget(this.cells,G.getEvent(),L,H)}var F=S.getView().getState(T);var P=false;if(F!=null&&(S.model.getParent(this.cell)!=T||H)){if(this.target!=T){this.target=T;this.setHighlightColor(mxConstants.DROP_TARGET_COLOR)}P=true}else{this.target=null;if(this.connectOnDrop&&L!=null&&this.cells.length==1&&S.getModel().isVertex(L)&&S.isCellConnectable(L)){F=S.getView().getState(L);if(F!=null){var O=S.getEdgeValidationError(null,this.cell,L);var B=(O==null)?mxConstants.VALID_COLOR:mxConstants.INVALID_CONNECT_TARGET_COLOR;this.setHighlightColor(B);P=true}}}if(F!=null&&P){this.highlight.highlight(F)}else{this.highlight.hide()}}this.updateHint(G);this.consumeMouseEvent(mxEvent.MOUSE_MOVE,G);mxEvent.consume(G.getEvent())}else{if((this.isMoveEnabled()||this.isCloneEnabled())&&this.updateCursor&&!G.isConsumed()&&G.getState()!=null&&!S.isMouseDown){var D=S.getCursorForMouseEvent(G);if(D==null&&S.isEnabled()&&S.isCellMovable(G.getCell())){if(S.getModel().isEdge(G.getCell())){D=mxConstants.CURSOR_MOVABLE_EDGE}else{D=mxConstants.CURSOR_MOVABLE_VERTEX}}if(G.sourceState!=null){G.sourceState.setCursor(D)}}}};mxGraphHandler.prototype.updatePreviewShape=function(){if(this.shape!=null){this.shape.bounds=new mxRectangle(Math.round(this.pBounds.x+this.currentDx-this.graph.panDx),Math.round(this.pBounds.y+this.currentDy-this.graph.panDy),this.pBounds.width,this.pBounds.height);this.shape.redraw()}};mxGraphHandler.prototype.setHighlightColor=function(A){if(this.highlight!=null){this.highlight.setHighlightColor(A)}};mxGraphHandler.prototype.mouseUp=function(D,H){if(!H.isConsumed()){var B=this.graph;if(this.cell!=null&&this.first!=null&&this.shape!=null&&this.currentDx!=null&&this.currentDy!=null){var I=H.getCell();if(this.connectOnDrop&&this.target==null&&I!=null&&B.getModel().isVertex(I)&&B.isCellConnectable(I)&&B.isEdgeValid(null,this.cell,I)){B.connectionHandler.connect(this.cell,I,H.getEvent())}else{var A=B.isCloneEvent(H.getEvent())&&B.isCellsCloneable()&&this.isCloneEnabled();var C=B.getView().scale;var F=this.roundLength(this.currentDx/C);var G=this.roundLength(this.currentDy/C);var E=this.target;if(B.isSplitEnabled()&&B.isSplitTarget(E,this.cells,H.getEvent())){B.splitEdge(E,this.cells,null,F,G)}else{this.moveCells(this.cells,F,G,A,this.target,H.getEvent())}}}else{if(this.isSelectEnabled()&&this.delayedSelection&&this.cell!=null){this.selectDelayed(H)}}}if(this.cellWasClicked){this.consumeMouseEvent(mxEvent.MOUSE_UP,H)}this.reset()};mxGraphHandler.prototype.selectDelayed=function(A){if(!this.graph.isCellSelected(this.cell)||!this.graph.popupMenuHandler.isPopupTrigger(A)){this.graph.selectCellForEvent(this.cell,A.getEvent())}};mxGraphHandler.prototype.reset=function(){this.destroyShapes();this.removeHint();this.cellWasClicked=false;this.delayedSelection=false;this.currentDx=null;this.currentDy=null;this.guides=null;this.first=null;this.cell=null;this.target=null};mxGraphHandler.prototype.shouldRemoveCellsFromParent=function(I,H,B){if(this.graph.getModel().isVertex(I)){var C=this.graph.getView().getState(I);if(C!=null){var A=mxUtils.convertPoint(this.graph.container,mxEvent.getClientX(B),mxEvent.getClientY(B));var F=mxUtils.toRadians(mxUtils.getValue(C.style,mxConstants.STYLE_ROTATION)||0);if(F!=0){var G=Math.cos(-F);var E=Math.sin(-F);var D=new mxPoint(C.getCenterX(),C.getCenterY());A=mxUtils.getRotatedPoint(A,G,E,D)}return !mxUtils.contains(C,A.x,A.y)}}return false};mxGraphHandler.prototype.moveCells=function(E,D,B,C,F,A){if(C){E=this.graph.getCloneableCells(E)}if(F==null&&this.isRemoveCellsFromParent()&&this.shouldRemoveCellsFromParent(this.graph.getModel().getParent(this.cell),E,A)){F=this.graph.getDefaultParent()}E=this.graph.moveCells(E,D-this.graph.panDx/this.graph.view.scale,B-this.graph.panDy/this.graph.view.scale,C,F,A);if(this.isSelectEnabled()&&this.scrollOnMove){this.graph.scrollCellToVisible(E[0])}if(C){this.graph.setSelectionCells(E)}};mxGraphHandler.prototype.destroyShapes=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}if(this.guide!=null){this.guide.destroy();this.guide=null}if(this.highlight!=null){this.highlight.destroy();this.highlight=null}};mxGraphHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.panHandler);if(this.escapeHandler!=null){this.graph.removeListener(this.escapeHandler);this.escapeHandler=null}this.destroyShapes();this.removeHint()};function mxHandle(C,A,B){this.graph=C.view.graph;this.state=C;this.cursor=(A!=null)?A:this.cursor;this.image=(B!=null)?B:this.image;this.init()}mxHandle.prototype.cursor="default";mxHandle.prototype.image=null;mxHandle.prototype.ignoreGrid=false;mxHandle.prototype.getPosition=function(A){};mxHandle.prototype.setPosition=function(A,B,C){};mxHandle.prototype.execute=function(){};mxHandle.prototype.copyStyle=function(A){this.graph.setCellStyles(A,this.state.style[A],[this.state.cell])};mxHandle.prototype.processEvent=function(D){var F=this.graph.view.scale;var C=this.graph.view.translate;var B=new mxPoint(D.getGraphX()/F-C.x,D.getGraphY()/F-C.y);if(this.shape!=null&&this.shape.bounds!=null){B.x-=this.shape.bounds.width/F/4;B.y-=this.shape.bounds.height/F/4}var A=-mxUtils.toRadians(this.getRotation());var E=-mxUtils.toRadians(this.getTotalRotation())-A;B=this.flipPoint(this.rotatePoint(this.snapPoint(this.rotatePoint(B,A),this.ignoreGrid||!this.graph.isGridEnabledEvent(D.getEvent())),E));this.setPosition(this.state.getPaintBounds(),B,D);this.positionChanged();this.redraw()};mxHandle.prototype.positionChanged=function(){if(this.state.text!=null){this.state.text.apply(this.state)}if(this.state.shape!=null){this.state.shape.apply(this.state)}this.graph.cellRenderer.redraw(this.state,true)};mxHandle.prototype.getRotation=function(){if(this.state.shape!=null){return this.state.shape.getRotation()}return 0};mxHandle.prototype.getTotalRotation=function(){if(this.state.shape!=null){return this.state.shape.getShapeRotation()}return 0};mxHandle.prototype.init=function(){var A=this.isHtmlRequired();if(this.image!=null){this.shape=new mxImageShape(new mxRectangle(0,0,this.image.width,this.image.height),this.image.src);this.shape.preserveImageAspect=false}else{this.shape=this.createShape(A)}this.initShape(A)};mxHandle.prototype.createShape=function(A){var B=new mxRectangle(0,0,mxConstants.HANDLE_SIZE,mxConstants.HANDLE_SIZE);return new mxRectangleShape(B,mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)};mxHandle.prototype.initShape=function(A){if(A&&this.shape.isHtmlAllowed()){this.shape.dialect=mxConstants.DIALECT_STRICTHTML;this.shape.init(this.graph.container)}else{this.shape.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;if(this.cursor!=null){this.shape.init(this.graph.getView().getOverlayPane())}}mxEvent.redirectMouseEvents(this.shape.node,this.graph,this.state);this.shape.node.style.cursor=this.cursor};mxHandle.prototype.redraw=function(){if(this.shape!=null&&this.state.shape!=null){var B=this.getPosition(this.state.getPaintBounds());if(B!=null){var D=mxUtils.toRadians(this.getTotalRotation());B=this.rotatePoint(this.flipPoint(B),D);var A=this.graph.view.scale;var C=this.graph.view.translate;this.shape.bounds.x=Math.floor((B.x+C.x)*A-this.shape.bounds.width/2);this.shape.bounds.y=Math.floor((B.y+C.y)*A-this.shape.bounds.height/2);this.state.unscaledWidth=null;this.shape.redraw()}}};mxHandle.prototype.isHtmlRequired=function(){return this.state.text!=null&&this.state.text.node.parentNode==this.graph.container};mxHandle.prototype.rotatePoint=function(C,D){var F=this.state.getCellBounds();var E=new mxPoint(F.getCenterX(),F.getCenterY());var B=Math.cos(D);var A=Math.sin(D);return mxUtils.getRotatedPoint(C,B,A,E)};mxHandle.prototype.flipPoint=function(A){if(this.state.shape!=null){var B=this.state.getCellBounds();if(this.state.shape.flipH){A.x=2*B.x+B.width-A.x}if(this.state.shape.flipV){A.y=2*B.y+B.height-A.y}}return A};mxHandle.prototype.snapPoint=function(A,B){if(!B){A.x=this.graph.snap(A.x);A.y=this.graph.snap(A.y)}return A};mxHandle.prototype.setVisible=function(A){if(this.shape!=null&&this.shape.node!=null){this.shape.node.style.display=(A)?"":"none"}};mxHandle.prototype.reset=function(){this.setVisible(true);this.state.style=this.graph.getCellStyle(this.state.cell);this.positionChanged()};mxHandle.prototype.destroy=function(){if(this.shape!=null){this.shape.destroy();this.shape=null}};function mxKeyHandler(A,B){if(A!=null){this.graph=A;this.target=B||document.documentElement;this.normalKeys=[];this.shiftKeys=[];this.controlKeys=[];this.controlShiftKeys=[];this.keydownHandler=mxUtils.bind(this,function(C){this.keyDown(C)});mxEvent.addListener(this.target,"keydown",this.keydownHandler);if(mxClient.IS_IE){mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()}))}}}mxKeyHandler.prototype.graph=null;mxKeyHandler.prototype.target=null;mxKeyHandler.prototype.normalKeys=null;mxKeyHandler.prototype.shiftKeys=null;mxKeyHandler.prototype.controlKeys=null;mxKeyHandler.prototype.controlShiftKeys=null;mxKeyHandler.prototype.enabled=true;mxKeyHandler.prototype.isEnabled=function(){return this.enabled};mxKeyHandler.prototype.setEnabled=function(A){this.enabled=A};mxKeyHandler.prototype.bindKey=function(A,B){this.normalKeys[A]=B};mxKeyHandler.prototype.bindShiftKey=function(A,B){this.shiftKeys[A]=B};mxKeyHandler.prototype.bindControlKey=function(A,B){this.controlKeys[A]=B};mxKeyHandler.prototype.bindControlShiftKey=function(A,B){this.controlShiftKeys[A]=B};mxKeyHandler.prototype.isControlDown=function(A){return mxEvent.isControlDown(A)};mxKeyHandler.prototype.getFunction=function(A){if(A!=null&&!mxEvent.isAltDown(A)){if(this.isControlDown(A)){if(mxEvent.isShiftDown(A)){return this.controlShiftKeys[A.keyCode]}else{return this.controlKeys[A.keyCode]}}else{if(mxEvent.isShiftDown(A)){return this.shiftKeys[A.keyCode]}else{return this.normalKeys[A.keyCode]}}}return null};mxKeyHandler.prototype.isGraphEvent=function(B){var A=mxEvent.getSource(B);if((A==this.target||A.parentNode==this.target)||(this.graph.cellEditor!=null&&this.graph.cellEditor.isEventSource(B))){return true}return mxUtils.isAncestorNode(this.graph.container,A)};mxKeyHandler.prototype.keyDown=function(A){if(this.isEnabledForEvent(A)){if(A.keyCode==27){this.escape(A)}else{if(!this.isEventIgnored(A)){var B=this.getFunction(A);if(B!=null){B(A);mxEvent.consume(A)}}}}};mxKeyHandler.prototype.isEnabledForEvent=function(A){return(this.graph.isEnabled()&&!mxEvent.isConsumed(A)&&this.isGraphEvent(A)&&this.isEnabled())};mxKeyHandler.prototype.isEventIgnored=function(A){return this.graph.isEditing()};mxKeyHandler.prototype.escape=function(A){if(this.graph.isEscapeEnabled()){this.graph.escape(A)}};mxKeyHandler.prototype.destroy=function(){if(this.target!=null&&this.keydownHandler!=null){mxEvent.removeListener(this.target,"keydown",this.keydownHandler);this.keydownHandler=null}this.target=null};function mxPanningHandler(A){if(A!=null){this.graph=A;this.graph.addMouseListener(this);this.forcePanningHandler=mxUtils.bind(this,function(B,C){var E=C.getProperty("eventName");var D=C.getProperty("event");if(E==mxEvent.MOUSE_DOWN&&this.isForcePanningEvent(D)){this.start(D);this.active=true;this.fireEvent(new mxEventObject(mxEvent.PAN_START,"event",D));D.consume()}});this.graph.addListener(mxEvent.FIRE_MOUSE_EVENT,this.forcePanningHandler);this.gestureHandler=mxUtils.bind(this,function(B,E){if(this.isPinchEnabled()){var C=E.getProperty("event");if(!mxEvent.isConsumed(C)&&C.type=="gesturestart"){this.initialScale=this.graph.view.scale;if(!this.active&&this.mouseDownEvent!=null){this.start(this.mouseDownEvent);this.mouseDownEvent=null}}else{if(C.type=="gestureend"&&this.initialScale==null){this.initialScale=null}}if(this.initialScale!=null){var D=Math.round(this.initialScale*C.scale*100)/100;if(this.minScale!=null){D=Math.max(this.minScale,D)}if(this.maxScale!=null){D=Math.min(this.maxScale,D)}if(this.graph.view.scale!=D){this.graph.zoomTo(D);mxEvent.consume(C)}}}});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler)}}mxPanningHandler.prototype=new mxEventSource();mxPanningHandler.prototype.constructor=mxPanningHandler;mxPanningHandler.prototype.graph=null;mxPanningHandler.prototype.useLeftButtonForPanning=false;mxPanningHandler.prototype.usePopupTrigger=true;mxPanningHandler.prototype.ignoreCell=false;mxPanningHandler.prototype.previewEnabled=true;mxPanningHandler.prototype.useGrid=false;mxPanningHandler.prototype.panningEnabled=true;mxPanningHandler.prototype.pinchEnabled=true;mxPanningHandler.prototype.maxScale=8;mxPanningHandler.prototype.minScale=0.01;mxPanningHandler.prototype.dx=null;mxPanningHandler.prototype.dy=null;mxPanningHandler.prototype.startX=0;mxPanningHandler.prototype.startY=0;mxPanningHandler.prototype.isActive=function(){return this.active||this.initialScale!=null};mxPanningHandler.prototype.isPanningEnabled=function(){return this.panningEnabled};mxPanningHandler.prototype.setPanningEnabled=function(A){this.panningEnabled=A};mxPanningHandler.prototype.isPinchEnabled=function(){return this.pinchEnabled};mxPanningHandler.prototype.setPinchEnabled=function(A){this.pinchEnabled=A};mxPanningHandler.prototype.isPanningTrigger=function(B){var A=B.getEvent();return(this.useLeftButtonForPanning&&B.getState()==null&&mxEvent.isLeftMouseButton(A))||(mxEvent.isControlDown(A)&&mxEvent.isShiftDown(A))||(this.usePopupTrigger&&mxEvent.isPopupTrigger(A))};mxPanningHandler.prototype.isForcePanningEvent=function(A){return this.ignoreCell||mxEvent.isMultiTouchEvent(A.getEvent())};mxPanningHandler.prototype.mouseDown=function(A,B){this.mouseDownEvent=B;if(!B.isConsumed()&&this.isPanningEnabled()&&!this.active&&this.isPanningTrigger(B)){this.start(B);this.consumePanningTrigger(B)}};mxPanningHandler.prototype.start=function(A){this.dx0=-this.graph.container.scrollLeft;this.dy0=-this.graph.container.scrollTop;this.startX=A.getX();this.startY=A.getY();this.dx=null;this.dy=null;this.panningTrigger=true};mxPanningHandler.prototype.consumePanningTrigger=function(A){A.consume()};mxPanningHandler.prototype.mouseMove=function(B,C){this.dx=C.getX()-this.startX;this.dy=C.getY()-this.startY;if(this.active){if(this.previewEnabled){if(this.useGrid){this.dx=this.graph.snap(this.dx);this.dy=this.graph.snap(this.dy)}this.graph.panGraph(this.dx+this.dx0,this.dy+this.dy0)}this.fireEvent(new mxEventObject(mxEvent.PAN,"event",C))}else{if(this.panningTrigger){var A=this.active;this.active=Math.abs(this.dx)>this.graph.tolerance||Math.abs(this.dy)>this.graph.tolerance;if(!A&&this.active){this.fireEvent(new mxEventObject(mxEvent.PAN_START,"event",C))}}}if(this.active||this.panningTrigger){C.consume()}};mxPanningHandler.prototype.mouseUp=function(A,B){if(this.active){if(this.dx!=null&&this.dy!=null){if(!this.graph.useScrollbarsForPanning||!mxUtils.hasScrollbars(this.graph.container)){var D=this.graph.getView().scale;var C=this.graph.getView().translate;this.graph.panGraph(0,0);this.panGraph(C.x+this.dx/D,C.y+this.dy/D)}B.consume()}this.fireEvent(new mxEventObject(mxEvent.PAN_END,"event",B))}this.panningTrigger=false;this.mouseDownEvent=null;this.active=false;this.dx=null;this.dy=null};mxPanningHandler.prototype.panGraph=function(A,B){this.graph.getView().setTranslate(A,B)};mxPanningHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.forcePanningHandler);this.graph.removeListener(this.gestureHandler)};function mxPopupMenuHandler(A,B){if(A!=null){this.graph=A;this.factoryMethod=B;this.graph.addMouseListener(this);this.gestureHandler=mxUtils.bind(this,function(C,D){this.inTolerance=false});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler);this.init()}}mxPopupMenuHandler.prototype=new mxPopupMenu();mxPopupMenuHandler.prototype.constructor=mxPopupMenuHandler;mxPopupMenuHandler.prototype.graph=null;mxPopupMenuHandler.prototype.selectOnPopup=true;mxPopupMenuHandler.prototype.clearSelectionOnBackground=true;mxPopupMenuHandler.prototype.triggerX=null;mxPopupMenuHandler.prototype.triggerY=null;mxPopupMenuHandler.prototype.screenX=null;mxPopupMenuHandler.prototype.screenY=null;mxPopupMenuHandler.prototype.init=function(){mxPopupMenu.prototype.init.apply(this);mxEvent.addGestureListeners(this.div,mxUtils.bind(this,function(A){this.graph.tooltipHandler.hide()}))};mxPopupMenuHandler.prototype.isSelectOnPopup=function(A){return this.selectOnPopup};mxPopupMenuHandler.prototype.mouseDown=function(A,B){if(this.isEnabled()&&!mxEvent.isMultiTouchEvent(B.getEvent())){this.hideMenu();this.triggerX=B.getGraphX();this.triggerY=B.getGraphY();this.screenX=mxEvent.getMainEvent(B.getEvent()).screenX;this.screenY=mxEvent.getMainEvent(B.getEvent()).screenY;this.popupTrigger=this.isPopupTrigger(B);this.inTolerance=true}};mxPopupMenuHandler.prototype.mouseMove=function(A,B){if(this.inTolerance&&this.screenX!=null&&this.screenY!=null){if(Math.abs(mxEvent.getMainEvent(B.getEvent()).screenX-this.screenX)>this.graph.tolerance||Math.abs(mxEvent.getMainEvent(B.getEvent()).screenY-this.screenY)>this.graph.tolerance){this.inTolerance=false}}};mxPopupMenuHandler.prototype.mouseUp=function(B,C){if(this.popupTrigger&&this.inTolerance&&this.triggerX!=null&&this.triggerY!=null){var D=this.getCellForPopupEvent(C);if(this.graph.isEnabled()&&this.isSelectOnPopup(C)&&D!=null&&!this.graph.isCellSelected(D)){this.graph.setSelectionCell(D)}else{if(this.clearSelectionOnBackground&&D==null){this.graph.clearSelection()}}this.graph.tooltipHandler.hide();var A=mxUtils.getScrollOrigin();this.popup(C.getX()+A.x+1,C.getY()+A.y+1,D,C.getEvent());C.consume()}this.popupTrigger=false;this.inTolerance=false};mxPopupMenuHandler.prototype.getCellForPopupEvent=function(A){return A.getCell()};mxPopupMenuHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);this.graph.removeListener(this.gestureHandler);mxPopupMenu.prototype.destroy.apply(this)};function mxRubberband(A){if(A!=null){this.graph=A;this.graph.addMouseListener(this);this.forceRubberbandHandler=mxUtils.bind(this,function(C,D){var F=D.getProperty("eventName");var E=D.getProperty("event");if(F==mxEvent.MOUSE_DOWN&&this.isForceRubberbandEvent(E)){var B=mxUtils.getOffset(this.graph.container);var G=mxUtils.getScrollOrigin(this.graph.container);G.x-=B.x;G.y-=B.y;this.start(E.getX()+G.x,E.getY()+G.y);E.consume(false)}});this.graph.addListener(mxEvent.FIRE_MOUSE_EVENT,this.forceRubberbandHandler);this.panHandler=mxUtils.bind(this,function(){this.repaint()});this.graph.addListener(mxEvent.PAN,this.panHandler);this.gestureHandler=mxUtils.bind(this,function(B,C){if(this.first!=null){this.reset()}});this.graph.addListener(mxEvent.GESTURE,this.gestureHandler);if(mxClient.IS_IE){mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()}))}}}mxRubberband.prototype.defaultOpacity=20;mxRubberband.prototype.enabled=true;mxRubberband.prototype.div=null;mxRubberband.prototype.sharedDiv=null;mxRubberband.prototype.currentX=0;mxRubberband.prototype.currentY=0;mxRubberband.prototype.isEnabled=function(){return this.enabled};mxRubberband.prototype.setEnabled=function(A){this.enabled=A};mxRubberband.prototype.isForceRubberbandEvent=function(A){return mxEvent.isAltDown(A.getEvent())};mxRubberband.prototype.mouseDown=function(B,C){if(!C.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&C.getState()==null&&!mxEvent.isMultiTouchEvent(C.getEvent())){var A=mxUtils.getOffset(this.graph.container);var D=mxUtils.getScrollOrigin(this.graph.container);D.x-=A.x;D.y-=A.y;this.start(C.getX()+D.x,C.getY()+D.y);C.consume(false)}};mxRubberband.prototype.start=function(C,D){this.first=new mxPoint(C,D);var B=this.graph.container;function A(F){var G=new mxMouseEvent(F);var E=mxUtils.convertPoint(B,G.getX(),G.getY());G.graphX=E.x;G.graphY=E.y;return G}this.dragHandler=mxUtils.bind(this,function(E){this.mouseMove(this.graph,A(E))});this.dropHandler=mxUtils.bind(this,function(E){this.mouseUp(this.graph,A(E))});if(mxClient.IS_FF){mxEvent.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}};mxRubberband.prototype.mouseMove=function(I,F){if(!F.isConsumed()&&this.first!=null){var C=mxUtils.getScrollOrigin(this.graph.container);var A=mxUtils.getOffset(this.graph.container);C.x-=A.x;C.y-=A.y;var G=F.getX()+C.x;var H=F.getY()+C.y;var D=this.first.x-G;var E=this.first.y-H;var B=this.graph.tolerance;if(this.div!=null||Math.abs(D)>B||Math.abs(E)>B){if(this.div==null){this.div=this.createShape()}mxUtils.clearSelection();this.update(G,H);F.consume()}}};mxRubberband.prototype.createShape=function(){if(this.sharedDiv==null){this.sharedDiv=document.createElement("div");this.sharedDiv.className="mxRubberband";mxUtils.setOpacity(this.sharedDiv,this.defaultOpacity)}this.graph.container.appendChild(this.sharedDiv);return this.sharedDiv};mxRubberband.prototype.isActive=function(A,B){return this.div!=null&&this.div.style.display!="none"};mxRubberband.prototype.mouseUp=function(A,C){var B=this.isActive();this.reset();if(B){this.execute(C.getEvent());C.consume()}};mxRubberband.prototype.execute=function(A){var B=new mxRectangle(this.x,this.y,this.width,this.height);this.graph.selectRegion(B,A)};mxRubberband.prototype.reset=function(){if(this.div!=null){this.div.parentNode.removeChild(this.div)}mxEvent.removeGestureListeners(document,null,this.dragHandler,this.dropHandler);this.dragHandler=null;this.dropHandler=null;this.currentX=0;this.currentY=0;this.first=null;this.div=null};mxRubberband.prototype.update=function(A,B){this.currentX=A;this.currentY=B;this.repaint()};mxRubberband.prototype.repaint=function(){if(this.div!=null){var C=this.currentX-this.graph.panDx;var D=this.currentY-this.graph.panDy;this.x=Math.min(this.first.x,C);this.y=Math.min(this.first.y,D);this.width=Math.max(this.first.x,C)-this.x;this.height=Math.max(this.first.y,D)-this.y;var B=(mxClient.IS_VML)?this.graph.panDx:0;var A=(mxClient.IS_VML)?this.graph.panDy:0;this.div.style.left=(this.x+B)+"px";this.div.style.top=(this.y+A)+"px";this.div.style.width=Math.max(1,this.width)+"px";this.div.style.height=Math.max(1,this.height)+"px"}};mxRubberband.prototype.destroy=function(){if(!this.destroyed){this.destroyed=true;this.graph.removeMouseListener(this);this.graph.removeListener(this.forceRubberbandHandler);this.graph.removeListener(this.panHandler);this.reset();if(this.sharedDiv!=null){this.sharedDiv=null}}};function mxSelectionCellsHandler(A){mxEventSource.call(this);this.graph=A;this.handlers=new mxDictionary();this.graph.addMouseListener(this);this.refreshHandler=mxUtils.bind(this,function(B,C){if(this.isEnabled()){this.refresh()}});this.graph.getSelectionModel().addListener(mxEvent.CHANGE,this.refreshHandler);this.graph.getModel().addListener(mxEvent.CHANGE,this.refreshHandler);this.graph.getView().addListener(mxEvent.SCALE,this.refreshHandler);this.graph.getView().addListener(mxEvent.TRANSLATE,this.refreshHandler);this.graph.getView().addListener(mxEvent.SCALE_AND_TRANSLATE,this.refreshHandler);this.graph.getView().addListener(mxEvent.DOWN,this.refreshHandler);this.graph.getView().addListener(mxEvent.UP,this.refreshHandler)}mxUtils.extend(mxSelectionCellsHandler,mxEventSource);mxSelectionCellsHandler.prototype.graph=null;mxSelectionCellsHandler.prototype.enabled=true;mxSelectionCellsHandler.prototype.refreshHandler=null;mxSelectionCellsHandler.prototype.maxHandlers=100;mxSelectionCellsHandler.prototype.handlers=null;mxSelectionCellsHandler.prototype.isEnabled=function(){return this.enabled};mxSelectionCellsHandler.prototype.setEnabled=function(A){this.enabled=A};mxSelectionCellsHandler.prototype.getHandler=function(A){return this.handlers.get(A)};mxSelectionCellsHandler.prototype.reset=function(){this.handlers.visit(function(A,B){B.reset.apply(B)})};mxSelectionCellsHandler.prototype.refresh=function(){var E=this.handlers;this.handlers=new mxDictionary();var A=this.graph.getSelectionCells();for(var B=0;B<A.length;B++){var D=this.graph.view.getState(A[B]);if(D!=null){var C=E.remove(A[B]);if(C!=null){if(C.state!=D){C.destroy();C=null}else{if(C.refresh!=null){C.refresh()}C.redraw()}}if(C==null){C=this.graph.createHandler(D);this.fireEvent(new mxEventObject(mxEvent.ADD,"state",D))}if(C!=null){this.handlers.put(A[B],C)}}}E.visit(mxUtils.bind(this,function(F,G){this.fireEvent(new mxEventObject(mxEvent.REMOVE,"state",G.state));G.destroy()}))};mxSelectionCellsHandler.prototype.updateHandler=function(B){var A=this.handlers.remove(B.cell);if(A!=null){A.destroy();A=this.graph.createHandler(B);if(A!=null){this.handlers.put(B.cell,A)}}};mxSelectionCellsHandler.prototype.mouseDown=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseDown.apply(E,C)})}};mxSelectionCellsHandler.prototype.mouseMove=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseMove.apply(E,C)})}};mxSelectionCellsHandler.prototype.mouseUp=function(A,B){if(this.graph.isEnabled()&&this.isEnabled()){var C=[A,B];this.handlers.visit(function(D,E){E.mouseUp.apply(E,C)})}};mxSelectionCellsHandler.prototype.destroy=function(){this.graph.removeMouseListener(this);if(this.refreshHandler!=null){this.graph.getSelectionModel().removeListener(this.refreshHandler);this.graph.getModel().removeListener(this.refreshHandler);this.graph.getView().removeListener(this.refreshHandler);this.refreshHandler=null}};function mxTooltipHandler(A,B){if(A!=null){this.graph=A;this.delay=B||500;this.graph.addMouseListener(this)}}mxTooltipHandler.prototype.zIndex=10005;mxTooltipHandler.prototype.graph=null;mxTooltipHandler.prototype.delay=null;mxTooltipHandler.prototype.ignoreTouchEvents=true;mxTooltipHandler.prototype.hideOnHover=false;mxTooltipHandler.prototype.destroyed=false;mxTooltipHandler.prototype.enabled=true;mxTooltipHandler.prototype.isEnabled=function(){return this.enabled};mxTooltipHandler.prototype.setEnabled=function(A){this.enabled=A};mxTooltipHandler.prototype.isHideOnHover=function(){return this.hideOnHover};mxTooltipHandler.prototype.setHideOnHover=function(A){this.hideOnHover=A};mxTooltipHandler.prototype.init=function(){if(document.body!=null){this.div=document.createElement("div");this.div.className="mxTooltip";this.div.style.visibility="hidden";document.body.appendChild(this.div);mxEvent.addGestureListeners(this.div,mxUtils.bind(this,function(A){this.hideTooltip()}))}};mxTooltipHandler.prototype.mouseDown=function(A,B){this.reset(B,false);this.hideTooltip()};mxTooltipHandler.prototype.mouseMove=function(A,B){if(B.getX()!=this.lastX||B.getY()!=this.lastY){this.reset(B,true);if(this.isHideOnHover()||B.getState()!=this.state||(B.getSource()!=this.node&&(!this.stateSource||(B.getState()!=null&&this.stateSource==(B.isSource(B.getState().shape)||!B.isSource(B.getState().text)))))){this.hideTooltip()}}this.lastX=B.getX();this.lastY=B.getY()};mxTooltipHandler.prototype.mouseUp=function(A,B){this.reset(B,true);this.hideTooltip()};mxTooltipHandler.prototype.resetTimer=function(){if(this.thread!=null){window.clearTimeout(this.thread);this.thread=null}};mxTooltipHandler.prototype.reset=function(C,D){if(!this.ignoreTouchEvents||mxEvent.isMouseEvent(C.getEvent())){this.resetTimer();if(D&&this.isEnabled()&&C.getState()!=null&&(this.div==null||this.div.style.visibility=="hidden")){var G=C.getState();var B=C.getSource();var E=C.getX();var F=C.getY();var A=C.isSource(G.shape)||C.isSource(G.text);this.thread=window.setTimeout(mxUtils.bind(this,function(){if(!this.graph.isEditing()&&!this.graph.popupMenuHandler.isMenuShowing()&&!this.graph.isMouseDown){var H=this.graph.getTooltip(G,B,E,F);this.show(H,E,F);this.state=G;this.node=B;this.stateSource=A}}),this.delay)}}};mxTooltipHandler.prototype.hide=function(){this.resetTimer();this.hideTooltip()};mxTooltipHandler.prototype.hideTooltip=function(){if(this.div!=null){this.div.style.visibility="hidden"}};mxTooltipHandler.prototype.show=function(A,B,C){if(!this.destroyed&&A!=null&&A.length>0){if(this.div==null){this.init()}var D=mxUtils.getScrollOrigin();this.div.style.zIndex=this.zIndex;this.div.style.left=(B+D.x)+"px";this.div.style.top=(C+mxConstants.TOOLTIP_VERTICAL_OFFSET+D.y)+"px";if(!mxUtils.isNode(A)){this.div.innerHTML=A.replace(/\n/g,"<br>")}else{this.div.innerHTML="";this.div.appendChild(A)}this.div.style.visibility="";mxUtils.fit(this.div)}};mxTooltipHandler.prototype.destroy=function(){if(!this.destroyed){this.graph.removeMouseListener(this);mxEvent.release(this.div);if(this.div!=null&&this.div.parentNode!=null){this.div.parentNode.removeChild(this.div)}this.destroyed=true;this.div=null}};function mxVertexHandler(A){if(A!=null){this.state=A;this.init();this.escapeHandler=mxUtils.bind(this,function(B,C){if(this.livePreview&&this.index!=null){this.state.view.graph.cellRenderer.redraw(this.state,true);this.state.view.invalidate(this.state.cell);this.state.invalid=false;this.state.view.validate()}this.reset()});this.state.view.graph.addListener(mxEvent.ESCAPE,this.escapeHandler)}}mxVertexHandler.prototype.graph=null;mxVertexHandler.prototype.state=null;mxVertexHandler.prototype.singleSizer=false;mxVertexHandler.prototype.index=null;mxVertexHandler.prototype.allowHandleBoundsCheck=true;mxVertexHandler.prototype.handleImage=null;mxVertexHandler.prototype.tolerance=0;mxVertexHandler.prototype.rotationEnabled=false;mxVertexHandler.prototype.parentHighlightEnabled=false;mxVertexHandler.prototype.rotationRaster=true;mxVertexHandler.prototype.rotationCursor="crosshair";mxVertexHandler.prototype.livePreview=false;mxVertexHandler.prototype.manageSizers=false;mxVertexHandler.prototype.constrainGroupByChildren=false;mxVertexHandler.prototype.rotationHandleVSpacing=-16;mxVertexHandler.prototype.horizontalOffset=0;mxVertexHandler.prototype.verticalOffset=0;mxVertexHandler.prototype.init=function(){this.graph=this.state.view.graph;this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.selectionBorder=this.createSelectionShape(this.bounds);this.selectionBorder.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.selectionBorder.pointerEvents=false;this.selectionBorder.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0");this.selectionBorder.init(this.graph.getView().getOverlayPane());mxEvent.redirectMouseEvents(this.selectionBorder.node,this.graph,this.state);if(this.graph.isCellMovable(this.state.cell)){this.selectionBorder.setCursor(mxConstants.CURSOR_MOVABLE_VERTEX)}if(mxGraphHandler.prototype.maxCells<=0||this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells){var A=this.graph.isCellResizable(this.state.cell);this.sizers=[];if(A||(this.graph.isLabelMovable(this.state.cell)&&this.state.width>=2&&this.state.height>=2)){var B=0;if(A){if(!this.singleSizer){this.sizers.push(this.createSizer("nw-resize",B++));this.sizers.push(this.createSizer("n-resize",B++));this.sizers.push(this.createSizer("ne-resize",B++));this.sizers.push(this.createSizer("w-resize",B++));this.sizers.push(this.createSizer("e-resize",B++));this.sizers.push(this.createSizer("sw-resize",B++));this.sizers.push(this.createSizer("s-resize",B++))}this.sizers.push(this.createSizer("se-resize",B++))}var C=this.graph.model.getGeometry(this.state.cell);if(C!=null&&!C.relative&&!this.graph.isSwimlane(this.state.cell)&&this.graph.isLabelMovable(this.state.cell)){this.labelShape=this.createSizer(mxConstants.CURSOR_LABEL_HANDLE,mxEvent.LABEL_HANDLE,mxConstants.LABEL_HANDLE_SIZE,mxConstants.LABEL_HANDLE_FILLCOLOR);this.sizers.push(this.labelShape)}}else{if(this.graph.isCellMovable(this.state.cell)&&!this.graph.isCellResizable(this.state.cell)&&this.state.width<2&&this.state.height<2){this.labelShape=this.createSizer(mxConstants.CURSOR_MOVABLE_VERTEX,mxEvent.LABEL_HANDLE,null,mxConstants.LABEL_HANDLE_FILLCOLOR);this.sizers.push(this.labelShape)}}}if(this.isRotationHandleVisible()){this.rotationShape=this.createSizer(this.rotationCursor,mxEvent.ROTATION_HANDLE,mxConstants.HANDLE_SIZE+3,mxConstants.HANDLE_FILLCOLOR);this.sizers.push(this.rotationShape)}this.customHandles=this.createCustomHandles();this.redraw();if(this.constrainGroupByChildren){this.updateMinBounds()}};mxVertexHandler.prototype.isRotationHandleVisible=function(){return this.graph.isEnabled()&&this.rotationEnabled&&this.graph.isCellRotatable(this.state.cell)&&(mxGraphHandler.prototype.maxCells<=0||this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells)&&this.state.width>=2&&this.state.height>=2};mxVertexHandler.prototype.isConstrainedEvent=function(A){return mxEvent.isShiftDown(A.getEvent())||this.state.style[mxConstants.STYLE_ASPECT]=="fixed"};mxVertexHandler.prototype.isCenteredEvent=function(B,A){return false};mxVertexHandler.prototype.createCustomHandles=function(){return null};mxVertexHandler.prototype.updateMinBounds=function(){var C=this.graph.getChildCells(this.state.cell);if(C.length>0){this.minBounds=this.graph.view.getBounds(C);if(this.minBounds!=null){var A=this.state.view.scale;var B=this.state.view.translate;this.minBounds.x-=this.state.x;this.minBounds.y-=this.state.y;this.minBounds.x/=A;this.minBounds.y/=A;this.minBounds.width/=A;this.minBounds.height/=A;this.x0=this.state.x/A-B.x;this.y0=this.state.y/A-B.y}}};mxVertexHandler.prototype.getSelectionBounds=function(A){return new mxRectangle(Math.round(A.x),Math.round(A.y),Math.round(A.width),Math.round(A.height))};mxVertexHandler.prototype.createParentHighlightShape=function(A){return this.createSelectionShape(A)};mxVertexHandler.prototype.createSelectionShape=function(A){var B=new mxRectangleShape(A,null,this.getSelectionColor());B.strokewidth=this.getSelectionStrokeWidth();B.isDashed=this.isSelectionDashed();return B};mxVertexHandler.prototype.getSelectionColor=function(){return mxConstants.VERTEX_SELECTION_COLOR};mxVertexHandler.prototype.getSelectionStrokeWidth=function(){return mxConstants.VERTEX_SELECTION_STROKEWIDTH};mxVertexHandler.prototype.isSelectionDashed=function(){return mxConstants.VERTEX_SELECTION_DASHED};mxVertexHandler.prototype.createSizer=function(A,D,C,E){C=C||mxConstants.HANDLE_SIZE;var F=new mxRectangle(0,0,C,C);var B=this.createSizerShape(F,D,E);if(B.isHtmlAllowed()&&this.state.text!=null&&this.state.text.node.parentNode==this.graph.container){B.bounds.height-=1;B.bounds.width-=1;B.dialect=mxConstants.DIALECT_STRICTHTML;B.init(this.graph.container)}else{B.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG;B.init(this.graph.getView().getOverlayPane())}mxEvent.redirectMouseEvents(B.node,this.graph,this.state);if(this.graph.isEnabled()){B.setCursor(A)}if(!this.isSizerVisible(D)){B.visible=false}return B};mxVertexHandler.prototype.isSizerVisible=function(A){return true};mxVertexHandler.prototype.createSizerShape=function(A,B,C){if(this.handleImage!=null){A=new mxRectangle(A.x,A.y,this.handleImage.width,this.handleImage.height);var D=new mxImageShape(A,this.handleImage.src);D.preserveImageAspect=false;return D}else{if(B==mxEvent.ROTATION_HANDLE){return new mxEllipse(A,C||mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}else{return new mxRectangleShape(A,C||mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)}}};mxVertexHandler.prototype.moveSizerTo=function(C,A,B){if(C!=null){C.bounds.x=Math.floor(A-C.bounds.width/2);C.bounds.y=Math.floor(B-C.bounds.height/2);if(C.node!=null&&C.node.style.display!="none"){C.redraw()}}};mxVertexHandler.prototype.getHandleForEvent=function(C){var E=(!mxEvent.isMouseEvent(C.getEvent()))?this.tolerance:1;var D=(this.allowHandleBoundsCheck&&(mxClient.IS_IE||E>0))?new mxRectangle(C.getGraphX()-E,C.getGraphY()-E,2*E,2*E):null;function B(F){return F!=null&&(C.isSource(F)||(D!=null&&mxUtils.intersects(F.bounds,D)&&F.node.style.display!="none"&&F.node.style.visibility!="hidden"))}if(this.customHandles!=null&&this.isCustomHandleEvent(C)){for(var A=this.customHandles.length-1;A>=0;A--){if(B(this.customHandles[A].shape)){return mxEvent.CUSTOM_HANDLE-A}}}if(B(this.rotationShape)){return mxEvent.ROTATION_HANDLE}else{if(B(this.labelShape)){return mxEvent.LABEL_HANDLE}}if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(B(this.sizers[A])){return A}}}return null};mxVertexHandler.prototype.isCustomHandleEvent=function(A){return true};mxVertexHandler.prototype.mouseDown=function(B,C){var D=(!mxEvent.isMouseEvent(C.getEvent()))?this.tolerance:0;if(!C.isConsumed()&&this.graph.isEnabled()&&(D>0||C.getState()==this.state)){var A=this.getHandleForEvent(C);if(A!=null){this.start(C.getGraphX(),C.getGraphY(),A);C.consume()}}};mxVertexHandler.prototype.isLivePreviewBorder=function(){return this.state.shape!=null&&this.state.shape.fill==null&&this.state.shape.stroke==null};mxVertexHandler.prototype.start=function(E,F,B){this.inTolerance=true;this.childOffsetX=0;this.childOffsetY=0;this.index=B;this.startX=E;this.startY=F;var H=this.state.view.graph.model;var G=H.getParent(this.state.cell);if(this.state.view.currentRoot!=G&&(H.isVertex(G)||H.isEdge(G))){this.parentState=this.state.view.graph.view.getState(G)}this.selectionBorder.node.style.display=(B==mxEvent.ROTATION_HANDLE)?"inline":"none";if(!this.livePreview||this.isLivePreviewBorder()){this.preview=this.createSelectionShape(this.bounds);if(!(mxClient.IS_SVG&&Number(this.state.style[mxConstants.STYLE_ROTATION]||"0")!=0)&&this.state.text!=null&&this.state.text.node.parentNode==this.graph.container){this.preview.dialect=mxConstants.DIALECT_STRICTHTML;this.preview.init(this.graph.container)}else{this.preview.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.preview.init(this.graph.view.getOverlayPane())}}if(this.livePreview){this.hideSizers();if(B==mxEvent.ROTATION_HANDLE){this.rotationShape.node.style.display=""}else{if(B==mxEvent.LABEL_HANDLE){this.labelShape.node.style.display=""}else{if(this.sizers!=null&&this.sizers[B]!=null){this.sizers[B].node.style.display=""}else{if(B<=mxEvent.CUSTOM_HANDLE&&this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-B].setVisible(true)}}}}var A=this.graph.getEdges(this.state.cell);this.edgeHandlers=[];for(var D=0;D<A.length;D++){var C=this.graph.selectionCellsHandler.getHandler(A[D]);if(C!=null){this.edgeHandlers.push(C)}}}};mxVertexHandler.prototype.setHandlesVisible=function(B){if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){this.sizers[A].node.style.display=(B)?"":"none"}}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].setVisible(B)}}};mxVertexHandler.prototype.hideSizers=function(){this.setHandlesVisible(false)};mxVertexHandler.prototype.checkTolerance=function(A){if(this.inTolerance&&this.startX!=null&&this.startY!=null){if(mxEvent.isMouseEvent(A.getEvent())||Math.abs(A.getGraphX()-this.startX)>this.graph.tolerance||Math.abs(A.getGraphY()-this.startY)>this.graph.tolerance){this.inTolerance=false}}};mxVertexHandler.prototype.updateHint=function(A){};mxVertexHandler.prototype.removeHint=function(){};mxVertexHandler.prototype.roundAngle=function(A){return Math.round(A*10)/10};mxVertexHandler.prototype.roundLength=function(A){return Math.round(A)};mxVertexHandler.prototype.mouseMove=function(A,B){if(!B.isConsumed()&&this.index!=null){this.checkTolerance(B);if(!this.inTolerance){if(this.index<=mxEvent.CUSTOM_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].processEvent(B)}}else{if(this.index==mxEvent.LABEL_HANDLE){this.moveLabel(B)}else{if(this.index==mxEvent.ROTATION_HANDLE){this.rotateVertex(B)}else{this.resizeVertex(B)}}}this.updateHint(B)}B.consume()}else{if(!this.graph.isMouseDown&&this.getHandleForEvent(B)!=null){B.consume(false)}}};mxVertexHandler.prototype.moveLabel=function(C){var A=new mxPoint(C.getGraphX(),C.getGraphY());var B=this.graph.view.translate;var E=this.graph.view.scale;if(this.graph.isGridEnabledEvent(C.getEvent())){A.x=(this.graph.snap(A.x/E-B.x)+B.x)*E;A.y=(this.graph.snap(A.y/E-B.y)+B.y)*E}var D=(this.rotationShape!=null)?this.sizers.length-2:this.sizers.length-1;this.moveSizerTo(this.sizers[D],A.x,A.y)};mxVertexHandler.prototype.rotateVertex=function(D){var B=new mxPoint(D.getGraphX(),D.getGraphY());var C=this.state.x+this.state.width/2-B.x;var E=this.state.y+this.state.height/2-B.y;this.currentAlpha=(C!=0)?Math.atan(E/C)*180/Math.PI+90:((E<0)?180:0);if(C>0){this.currentAlpha-=180}if(this.rotationRaster&&this.graph.isGridEnabledEvent(D.getEvent())){var C=B.x-this.state.getCenterX();var E=B.y-this.state.getCenterY();var A=Math.abs(Math.sqrt(C*C+E*E)-20)*3;var F=Math.max(1,5*Math.min(3,Math.max(0,Math.round(80/Math.abs(A)))));this.currentAlpha=Math.round(this.currentAlpha/F)*F}else{this.currentAlpha=this.roundAngle(this.currentAlpha)}this.selectionBorder.rotation=this.currentAlpha;this.selectionBorder.redraw();if(this.livePreview){this.redrawHandles()}};mxVertexHandler.prototype.resizeVertex=function(A){var D=new mxPoint(this.state.getCenterX(),this.state.getCenterY());var O=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var B=new mxPoint(A.getGraphX(),A.getGraphY());var Q=this.graph.view.translate;var N=this.graph.view.scale;var R=Math.cos(-O);var V=Math.sin(-O);var I=B.x-this.startX;var T=B.y-this.startY;var X=R*I-V*T;var L=V*I+R*T;I=X;T=L;var P=this.graph.getCellGeometry(this.state.cell);this.unscaledBounds=this.union(P,I/N,T/N,this.index,this.graph.isGridEnabledEvent(A.getEvent()),1,new mxPoint(0,0),this.isConstrainedEvent(A),this.isCenteredEvent(this.state,A));if(!P.relative){var W=this.graph.getMaximumGraphBounds();if(W!=null&&this.parentState!=null){W=mxRectangle.fromRectangle(W);W.x-=(this.parentState.x-Q.x*N)/N;W.y-=(this.parentState.y-Q.y*N)/N}if(this.graph.isConstrainChild(this.state.cell)){var C=this.graph.getCellContainmentArea(this.state.cell);if(C!=null){var K=this.graph.getOverlap(this.state.cell);if(K>0){C=mxRectangle.fromRectangle(C);C.x-=C.width*K;C.y-=C.height*K;C.width+=2*C.width*K;C.height+=2*C.height*K}if(W==null){W=C}else{W=mxRectangle.fromRectangle(W);W.intersect(C)}}}if(W!=null){if(this.unscaledBounds.x<W.x){this.unscaledBounds.width-=W.x-this.unscaledBounds.x;this.unscaledBounds.x=W.x}if(this.unscaledBounds.y<W.y){this.unscaledBounds.height-=W.y-this.unscaledBounds.y;this.unscaledBounds.y=W.y}if(this.unscaledBounds.x+this.unscaledBounds.width>W.x+W.width){this.unscaledBounds.width-=this.unscaledBounds.x+this.unscaledBounds.width-W.x-W.width}if(this.unscaledBounds.y+this.unscaledBounds.height>W.y+W.height){this.unscaledBounds.height-=this.unscaledBounds.y+this.unscaledBounds.height-W.y-W.height}}}this.bounds=new mxRectangle(((this.parentState!=null)?this.parentState.x:Q.x*N)+(this.unscaledBounds.x)*N,((this.parentState!=null)?this.parentState.y:Q.y*N)+(this.unscaledBounds.y)*N,this.unscaledBounds.width*N,this.unscaledBounds.height*N);if(P.relative&&this.parentState!=null){this.bounds.x+=this.state.x-this.parentState.x;this.bounds.y+=this.state.y-this.parentState.y}R=Math.cos(O);V=Math.sin(O);var M=new mxPoint(this.bounds.getCenterX(),this.bounds.getCenterY());var I=M.x-D.x;var T=M.y-D.y;var J=R*I-V*T;var G=V*I+R*T;var U=J-I;var H=G-T;var Y=this.bounds.x-this.state.x;var E=this.bounds.y-this.state.y;var S=R*Y-V*E;var F=V*Y+R*E;this.bounds.x+=U;this.bounds.y+=H;this.unscaledBounds.x=this.roundLength(this.unscaledBounds.x+U/N);this.unscaledBounds.y=this.roundLength(this.unscaledBounds.y+H/N);this.unscaledBounds.width=this.roundLength(this.unscaledBounds.width);this.unscaledBounds.height=this.roundLength(this.unscaledBounds.height);if(!this.graph.isCellCollapsed(this.state.cell)&&(U!=0||H!=0)){this.childOffsetX=this.state.x-this.bounds.x+S;this.childOffsetY=this.state.y-this.bounds.y+F}else{this.childOffsetX=0;this.childOffsetY=0}if(this.livePreview){this.updateLivePreview(A)}if(this.preview!=null){this.drawPreview()}};mxVertexHandler.prototype.updateLivePreview=function(D){var F=this.graph.view.scale;var C=this.graph.view.translate;var G=this.state.clone();this.state.x=this.bounds.x;this.state.y=this.bounds.y;this.state.origin=new mxPoint(this.state.x/F-C.x,this.state.y/F-C.y);this.state.width=this.bounds.width;this.state.height=this.bounds.height;this.state.unscaledWidth=null;var A=this.state.absoluteOffset;A=new mxPoint(A.x,A.y);this.state.absoluteOffset.x=0;this.state.absoluteOffset.y=0;var B=this.graph.getCellGeometry(this.state.cell);if(B!=null){var E=B.offset||this.EMPTY_POINT;if(E!=null&&!B.relative){this.state.absoluteOffset.x=this.state.view.scale*E.x;this.state.absoluteOffset.y=this.state.view.scale*E.y}this.state.view.updateVertexLabelOffset(this.state)}this.state.view.graph.cellRenderer.redraw(this.state,true);this.state.view.invalidate(this.state.cell);this.state.invalid=false;this.state.view.validate();this.redrawHandles();this.state.setState(G)};mxVertexHandler.prototype.mouseUp=function(N,J){if(this.index!=null&&this.state!=null){var L=new mxPoint(J.getGraphX(),J.getGraphY());this.graph.getModel().beginUpdate();try{if(this.index<=mxEvent.CUSTOM_HANDLE){if(this.customHandles!=null){this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].execute()}}else{if(this.index==mxEvent.ROTATION_HANDLE){if(this.currentAlpha!=null){var K=this.currentAlpha-(this.state.style[mxConstants.STYLE_ROTATION]||0);if(K!=0){this.rotateCell(this.state.cell,K)}}else{this.rotateClick()}}else{var D=this.graph.isGridEnabledEvent(J.getEvent());var F=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(-F);var E=Math.sin(-F);var H=L.x-this.startX;var I=L.y-this.startY;var A=G*H-E*I;var M=E*H+G*I;H=A;I=M;var B=this.graph.view.scale;var C=this.isRecursiveResize(this.state,J);this.resizeCell(this.state.cell,this.roundLength(H/B),this.roundLength(I/B),this.index,D,this.isConstrainedEvent(J),C)}}}finally{this.graph.getModel().endUpdate()}J.consume();this.reset()}};mxVertexHandler.prototype.isRecursiveResize=function(B,A){return this.graph.isRecursiveResize(this.state)};mxVertexHandler.prototype.rotateClick=function(){};mxVertexHandler.prototype.rotateCell=function(K,F,I){if(F!=0){var J=this.graph.getModel();if(J.isVertex(K)||J.isEdge(K)){if(!J.isEdge(K)){var C=this.graph.view.getState(K);var D=(C!=null)?C.style:this.graph.getCellStyle(K);if(D!=null){var E=(D[mxConstants.STYLE_ROTATION]||0)+F;this.graph.setCellStyles(mxConstants.STYLE_ROTATION,E,[K])}}var B=this.graph.getCellGeometry(K);if(B!=null){var H=this.graph.getCellGeometry(I);if(H!=null&&!J.isEdge(I)){B=B.clone();B.rotate(F,new mxPoint(H.width/2,H.height/2));J.setGeometry(K,B)}if((J.isVertex(K)&&!B.relative)||J.isEdge(K)){var A=J.getChildCount(K);for(var G=0;G<A;G++){this.rotateCell(J.getChildAt(K,G),F,K)}}}}}};mxVertexHandler.prototype.reset=function(){if(this.sizers!=null&&this.index!=null&&this.sizers[this.index]!=null&&this.sizers[this.index].node.style.display=="none"){this.sizers[this.index].node.style.display=""}this.currentAlpha=null;this.inTolerance=null;this.index=null;if(this.preview!=null){this.preview.destroy();this.preview=null}if(this.livePreview&&this.sizers!=null){for(var A=0;A<this.sizers.length;A++){if(this.sizers[A]!=null){this.sizers[A].node.style.display=""}}}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].reset()}}if(this.selectionBorder!=null){this.selectionBorder.node.style.display="inline";this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.drawPreview()}this.removeHint();this.redrawHandles();this.edgeHandlers=null;this.unscaledBounds=null};mxVertexHandler.prototype.resizeCell=function(I,G,E,B,C,F,D){var H=this.graph.model.getGeometry(I);if(H!=null){if(B==mxEvent.LABEL_HANDLE){var A=this.graph.view.scale;G=Math.round((this.labelShape.bounds.getCenterX()-this.startX)/A);E=Math.round((this.labelShape.bounds.getCenterY()-this.startY)/A);H=H.clone();if(H.offset==null){H.offset=new mxPoint(G,E)}else{H.offset.x+=G;H.offset.y+=E}this.graph.model.setGeometry(I,H)}else{if(this.unscaledBounds!=null){var A=this.graph.view.scale;if(this.childOffsetX!=0||this.childOffsetY!=0){this.moveChildren(I,Math.round(this.childOffsetX/A),Math.round(this.childOffsetY/A))}this.graph.resizeCell(I,this.unscaledBounds,D)}}}};mxVertexHandler.prototype.moveChildren=function(H,E,D){var G=this.graph.getModel();var A=G.getChildCount(H);for(var C=0;C<A;C++){var B=G.getChildAt(H,C);var F=this.graph.getCellGeometry(B);if(F!=null){F=F.clone();F.translate(E,D);G.setGeometry(B,F)}}};mxVertexHandler.prototype.union=function(T,H,V,D,M,O,Q,A,L){if(this.singleSizer){var Y=T.x+T.width+H;var Z=T.y+T.height+V;if(M){Y=this.graph.snap(Y/O)*O;Z=this.graph.snap(Z/O)*O}var K=new mxRectangle(T.x,T.y,0,0);K.add(new mxRectangle(Y,Z,0,0));return K}else{var N=T.width;var R=T.height;var W=T.x-Q.x*O;var G=W+N;var U=T.y-Q.y*O;var S=U+R;var E=W+N/2;var F=U+R/2;if(D>4){S=S+V;if(M){S=this.graph.snap(S/O)*O}}else{if(D<3){U=U+V;if(M){U=this.graph.snap(U/O)*O}}}if(D==0||D==3||D==5){W+=H;if(M){W=this.graph.snap(W/O)*O}}else{if(D==2||D==4||D==7){G+=H;if(M){G=this.graph.snap(G/O)*O}}}var P=G-W;var a=S-U;if(A){var J=this.graph.getCellGeometry(this.state.cell);if(J!=null){var X=J.width/J.height;if(D==1||D==2||D==7||D==6){P=a*X}else{a=P/X}if(D==0){W=G-P;U=S-a}}}if(L){P+=(P-N);a+=(a-R);var C=E-(W+P/2);var B=F-(U+a/2);W+=C;U+=B;G+=C;S+=B}if(P<0){W+=P;P=Math.abs(P)}if(a<0){U+=a;a=Math.abs(a)}var I=new mxRectangle(W+Q.x*O,U+Q.y*O,P,a);if(this.minBounds!=null){I.width=Math.max(I.width,this.minBounds.x*O+this.minBounds.width*O+Math.max(0,this.x0*O-I.x));I.height=Math.max(I.height,this.minBounds.y*O+this.minBounds.height*O+Math.max(0,this.y0*O-I.y))}return I}};mxVertexHandler.prototype.redraw=function(){this.selectionBounds=this.getSelectionBounds(this.state);this.bounds=new mxRectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height);this.redrawHandles();this.drawPreview()};mxVertexHandler.prototype.getHandlePadding=function(){var A=new mxPoint(0,0);var B=this.tolerance;if(this.sizers!=null&&this.sizers.length>0&&this.sizers[0]!=null&&(this.bounds.width<2*this.sizers[0].bounds.width+2*B||this.bounds.height<2*this.sizers[0].bounds.height+2*B)){B/=2;A.x=this.sizers[0].bounds.width+B;A.y=this.sizers[0].bounds.height+B}return A};mxVertexHandler.prototype.redrawHandles=function(){var E=this.tolerance;this.horizontalOffset=0;this.verticalOffset=0;var B=this.bounds;if(this.sizers!=null&&this.sizers.length>0&&this.sizers[0]!=null){if(this.index==null&&this.manageSizers&&this.sizers.length>=8){var D=this.getHandlePadding();this.horizontalOffset=D.x;this.verticalOffset=D.y;if(this.horizontalOffset!=0||this.verticalOffset!=0){B=new mxRectangle(B.x,B.y,B.width,B.height);B.x-=this.horizontalOffset/2;B.width+=this.horizontalOffset;B.y-=this.verticalOffset/2;B.height+=this.verticalOffset}if(this.sizers.length>=8){if((B.width<2*this.sizers[0].bounds.width+2*E)||(B.height<2*this.sizers[0].bounds.height+2*E)){this.sizers[0].node.style.display="none";this.sizers[2].node.style.display="none";this.sizers[5].node.style.display="none";this.sizers[7].node.style.display="none"}else{this.sizers[0].node.style.display="";this.sizers[2].node.style.display="";this.sizers[5].node.style.display="";this.sizers[7].node.style.display=""}}}var A=B.x+B.width;var N=B.y+B.height;if(this.singleSizer){this.moveSizerTo(this.sizers[0],A,N)}else{var K=B.x+B.width/2;var H=B.y+B.height/2;if(this.sizers.length>=8){var I=["nw-resize","n-resize","ne-resize","e-resize","se-resize","s-resize","sw-resize","w-resize"];var J=mxUtils.toRadians(this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(J);var F=Math.sin(J);var C=Math.round(J*4/Math.PI);var O=new mxPoint(B.getCenterX(),B.getCenterY());var M=mxUtils.getRotatedPoint(new mxPoint(B.x,B.y),G,F,O);this.moveSizerTo(this.sizers[0],M.x,M.y);this.sizers[0].setCursor(I[mxUtils.mod(0+C,I.length)]);M.x=K;M.y=B.y;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[1],M.x,M.y);this.sizers[1].setCursor(I[mxUtils.mod(1+C,I.length)]);M.x=A;M.y=B.y;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[2],M.x,M.y);this.sizers[2].setCursor(I[mxUtils.mod(2+C,I.length)]);M.x=B.x;M.y=H;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[3],M.x,M.y);this.sizers[3].setCursor(I[mxUtils.mod(7+C,I.length)]);M.x=A;M.y=H;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[4],M.x,M.y);this.sizers[4].setCursor(I[mxUtils.mod(3+C,I.length)]);M.x=B.x;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[5],M.x,M.y);this.sizers[5].setCursor(I[mxUtils.mod(6+C,I.length)]);M.x=K;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[6],M.x,M.y);this.sizers[6].setCursor(I[mxUtils.mod(5+C,I.length)]);M.x=A;M.y=N;M=mxUtils.getRotatedPoint(M,G,F,O);this.moveSizerTo(this.sizers[7],M.x,M.y);this.sizers[7].setCursor(I[mxUtils.mod(4+C,I.length)]);this.moveSizerTo(this.sizers[8],K+this.state.absoluteOffset.x,H+this.state.absoluteOffset.y)}else{if(this.state.width>=2&&this.state.height>=2){this.moveSizerTo(this.sizers[0],K+this.state.absoluteOffset.x,H+this.state.absoluteOffset.y)}else{this.moveSizerTo(this.sizers[0],this.state.x,this.state.y)}}}}if(this.rotationShape!=null){var J=mxUtils.toRadians((this.currentAlpha!=null)?this.currentAlpha:this.state.style[mxConstants.STYLE_ROTATION]||"0");var G=Math.cos(J);var F=Math.sin(J);var O=new mxPoint(this.state.getCenterX(),this.state.getCenterY());var M=mxUtils.getRotatedPoint(new mxPoint(B.x+B.width/2,B.y+this.rotationHandleVSpacing),G,F,O);if(this.rotationShape.node!=null){this.moveSizerTo(this.rotationShape,M.x,M.y)}}if(this.selectionBorder!=null){this.selectionBorder.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0")}if(this.edgeHandlers!=null){for(var L=0;L<this.edgeHandlers.length;L++){this.edgeHandlers[L].redraw()}}if(this.customHandles!=null){for(var L=0;L<this.customHandles.length;L++){this.customHandles[L].redraw()}}this.updateParentHighlight()};mxVertexHandler.prototype.updateParentHighlight=function(){if(this.selectionBorder!=null){if(this.parentHighlight!=null){var B=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(B)){var C=this.graph.view.getState(B);var A=this.parentHighlight.bounds;if(C!=null&&(A.x!=C.x||A.y!=C.y||A.width!=C.width||A.height!=C.height)){this.parentHighlight.bounds=C;this.parentHighlight.redraw()}}else{this.parentHighlight.destroy();this.parentHighlight=null}}else{if(this.parentHighlightEnabled){var B=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(B)){var C=this.graph.view.getState(B);if(C!=null){this.parentHighlight=this.createParentHighlightShape(C);this.parentHighlight.dialect=(this.graph.dialect!=mxConstants.DIALECT_SVG)?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG;this.parentHighlight.pointerEvents=false;this.parentHighlight.rotation=Number(C.style[mxConstants.STYLE_ROTATION]||"0");this.parentHighlight.init(this.graph.getView().getOverlayPane())}}}}}};mxVertexHandler.prototype.drawPreview=function(){if(this.preview!=null){this.preview.bounds=this.bounds;if(this.preview.node.parentNode==this.graph.container){this.preview.bounds.width=Math.max(0,this.preview.bounds.width-1);this.preview.bounds.height=Math.max(0,this.preview.bounds.height-1)}this.preview.rotation=Number(this.state.style[mxConstants.STYLE_ROTATION]||"0");this.preview.redraw()}this.selectionBorder.bounds=this.bounds;this.selectionBorder.redraw();if(this.parentHighlight!=null){this.parentHighlight.redraw()}};mxVertexHandler.prototype.destroy=function(){if(this.escapeHandler!=null){this.state.view.graph.removeListener(this.escapeHandler);this.escapeHandler=null}if(this.preview!=null){this.preview.destroy();this.preview=null}if(this.parentHighlight!=null){this.parentHighlight.destroy();this.parentHighlight=null}if(this.selectionBorder!=null){this.selectionBorder.destroy();this.selectionBorder=null}this.labelShape=null;this.removeHint();if(this.sizers!=null){for(var A=0;A<this.sizers.length;A++){this.sizers[A].destroy()}this.sizers=null}if(this.customHandles!=null){for(var A=0;A<this.customHandles.length;A++){this.customHandles[A].destroy()}this.customHandles=null}};