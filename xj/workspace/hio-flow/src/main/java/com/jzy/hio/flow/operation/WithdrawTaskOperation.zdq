package com.jzy.hio.flow.operation;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;

import com.jzy.hio.base.utils.LoginUtils;
import com.jzy.hio.flow.dto.tobedeleted.ApprovalSubmitDto;
import com.jzy.hio.flow.dto.tobedeleted.InstanceTaskDto;
import com.jzy.hio.flow.enums.ACStatus;
import com.jzy.hio.flow.enums.FlAcType;
import com.jzy.hio.flow.enums.InstanceOperateType;
import com.jzy.hio.flow.enums.PostStatus;
import com.jzy.hio.flow.enums.TaskStatus;
import com.jzy.hio.flow.exception.FlowException;
import com.jzy.hio.flow.rt.model.ACUnit;
import com.jzy.hio.flow.rt.model.ApproverUnit;
import com.jzy.hio.flow.rt.model.InstanceUnit;
import com.jzy.hio.flow.rt.model.PostUnit;
import com.jzy.hio.flow.rt.model.TaskUnit;
import com.jzy.hio.base.utils.LoginUtils;


/**
 * 审批人撤回任务操作
 * 
 * @author daoqi
 *
 */
public class WithdrawTaskOperation extends DefaultOperation implements Operation{
	
	private static Logger log = Logger.getLogger("flowLogger");

	public WithdrawTaskOperation() {
		super(OperationType.WITHDRAW_TASK);
	}

	/**
	 * 已检查过能否撤回
	 */
	@Override
	public String action(InstanceUnit instanceUnit, ApprovalSubmitDto approvalDto) throws Exception {
		List<InstanceTaskDto> toWithdrawTasks = null;
		if(StringUtils.isEmpty(approvalDto.getTaskId())) {
			toWithdrawTasks = setCurrentLocationForWithdrawTask(instanceUnit, approvalDto);
			log.info("查询待撤回任务：" + toWithdrawTasks);
			
		} else {
			//检查是否可撤回,返回可撤回时应该撤回的任务列表
			log.info("检查是否可撤回,返回可撤回时应该撤回的任务列表");
			toWithdrawTasks = service.getInstanceTaskService().checkWithdrawTask(instanceUnit.getId(),
					approvalDto.getTaskId());
			if(toWithdrawTasks == null) {
				log.info("当前流程已被下一审批人打开或审批过！");
				throw new FlowException("当前流程已被下一审批人打开或审批过！");
			}
			
			//查找当前撤回人的操作结果
			super.setCurrentLocation(instanceUnit, approvalDto);
		}
		
		//记录流转日志
		super.saveTransition(currentApprover, approvalDto.getOperationName());
		
		if(OperationType.RETURN.getCode().equals(currentApprover.getTask().getTaskResult())) {
			delateACFromReturn(instanceUnit.getAcList());
		} else {
			
			//1、查询的运行中的任务回退，并撤回对应消息
			log.info("1、查询的运行中的任务回退，并撤回对应消息");
			withdrawTaskAndMsg(instanceUnit, toWithdrawTasks);
		}
		
		//2、撤回操作本人任务变成运行中，并重发待办消息
		turnOn(currentApprover);
		
		//3、恢复跳过的审批人的任务
		//竞争时跳过的审批人，在撤回任务时不给审批的资格，还由撤回任务人（原审批人审批）!!!
		
		//4、重新计算流程当前审批人
		super.setCurrentApprovers(instanceUnit);
		
		super.save(instanceUnit);
		
		sendMessages(instanceUnit.getMessages());
//		completeMessage(instanceUnit, approvalDto.getMsgId());	//不再需要完成本人
		withDrawMessage(instanceUnit);
		
		//5、记录撤回任务操作日志
		try {
			service.getInstanceLogService().saveLogData(instanceUnit.getId(), currentAc.getAcId(), 
					currentApprover.getId(), currentApprover.getTask().getTaskId(), 
					InstanceOperateType.DRAW_BACK_TASK.getValue(), currentApprover.getApproverId(), null, null);
		} catch (Exception e) {
			throw new FlowException("记录流程日志异常：", e);
		}
		
		return "success";
	}
	
	/**
	 * 根据任务ID，设置当前审批人、当前岗位、当前节点
	 * 
	 * @param instanceUnit
	 * @param approvalDto
	 */
	public List<InstanceTaskDto> setCurrentLocationForWithdrawTask(InstanceUnit instanceUnit, ApprovalSubmitDto approvalDto){
		List<ApproverUnit> returners = new ArrayList<ApproverUnit>();
		//自动通过用
		this.setInstanceUnit(instanceUnit);
		this.setApprovalDto(approvalDto);
		
		String currentUserId = LoginUtils.getSecurityUserBeanInfo().getSecurityUserDto().getId();
		
		for(ACUnit acUnit : instanceUnit.getAcList()) {
			List<PostUnit> posts = acUnit.getPosts();
			if(CollectionUtils.isEmpty(posts)) {
				continue;
			}
			for(PostUnit postUnit : posts) {
				List<ApproverUnit> approvers = postUnit.getApprovers();
				if(CollectionUtils.isEmpty(approvers)) {
					continue;
				}
				for(ApproverUnit approver : approvers) {
					TaskUnit task = approver.getTask();
					if(task == null) {
						continue;
					}
					
					//以点亮行审批人ID确认当前审批人（默认一个人同时只有一个点亮行）
					if(TaskStatus.FINISHED.getValue().equals(task.getTaskStatus())) {
						if(approver.getApproverId().equals(currentUserId)) {
							returners.add(approver);
						}
					}
				}
			}
		}
		Iterator<ApproverUnit> iter = returners.iterator();
		List<InstanceTaskDto> toWithdrawTasks = null;
		while(iter.hasNext()) {
			//检查是否可撤回,返回可撤回时应该撤回的任务列表
			ApproverUnit approver = iter.next();
			String taskId = approver.getTask().getTaskId();
			List<InstanceTaskDto> tasks = service.getInstanceTaskService()
					.checkWithdrawTask(instanceUnit.getId(), taskId);
			if(tasks == null) {
				iter.remove();
			} else {
				toWithdrawTasks = tasks;
			}
			
		}
		if(returners.size() == 0) {
			log.info("当前流程已被下一审批人打开或审批过！");
			throw new FlowException("当前流程已被下一审批人打开或审批过！");
			
		} else if(returners.size() > 1) {
			log.info("撤回任务时找到两个撤回人：" + instanceUnit.getId());
			throw new FlowException("撤回任务时找到两个撤回人：" + instanceUnit.getId());
			
		} else {
			ApproverUnit withdrawer = returners.get(0);
			currentApprover = withdrawer;
			currentPost = withdrawer.getOwner();
			currentAc = withdrawer.getOwner().getOwner();
			
			//当从非待办打开的flow.html时,taskId, msgId为空，此时审批无法消除待办
			if(StringUtils.isEmpty(approvalDto.getTaskId())) {
				approvalDto.setTaskId(currentApprover.getTask().getTaskId());
			}
			if(StringUtils.isEmpty(approvalDto.getMsgId())) {
				approvalDto.setMsgId(currentApprover.getTask().getMsgId());
			}
		}
		return toWithdrawTasks;
	}

	private void delateACFromReturn(List<ACUnit> acList) {
		for(ACUnit acUnit :acList) {
			if("1".equals(acUnit.getFromReturn())) {
				acUnit.setDbAction(2);
				log.info("删除打回产生的节：acId=" + acUnit.getAcId());
			}
		}
	}

	/**
	 * 1、匹配待还原的任务并撤回消息
	 * 2、同时还原岗位及环节的状态
	 * 
	 * @param instanceUnit
	 * @param toWithdrawTasks
	 */
	private void withdrawTaskAndMsg(InstanceUnit instanceUnit, List<InstanceTaskDto> toWithdrawTasks) {
		List<String> toWithdrawTaskIds = new ArrayList<String>();
		for(InstanceTaskDto task : toWithdrawTasks) {
			toWithdrawTaskIds.add(task.getId());
		}
		
		for(ACUnit acUnit : instanceUnit.getAcList()) {
			List<PostUnit> posts = acUnit.getPosts();
			if(CollectionUtils.isEmpty(posts)) {
				continue;
			}
			
			int notRunPostCount = 0;
			for(PostUnit post : posts) {
				int delApproverCount = 0;
				List<ApproverUnit> approvers = post.getApprovers();
				if(CollectionUtils.isEmpty(approvers)) {
					if(PostStatus.FINISHED.getValue().equals(post.getPostStatus())
							&& acUnit.getAcPx() > currentAc.getAcPx()) {
						post.setPostStatus(PostStatus.NOT_RUNNING.getValue());
						if(ACStatus.FINISHED.getValue().equals(acUnit.getAcStatus())) {
							acUnit.setLeftPost(acUnit.getLeftPost() + 1);
						}
						notRunPostCount++;
					}
					continue;
				}
				for(ApproverUnit approver : approvers) {
					TaskUnit task = approver.getTask();
					if(task == null) {
						continue;
					}

					if(toWithdrawTaskIds.contains(task.getTaskId())) {
						
						//处理转办、协办、沟通发起人产生的后续人员撤回（作删除处理）
						if(StringUtils.isNotEmpty(task.getFromId())) {
							task.setDbAction(2);
							approver.setDbAction(2);
							
							//处理正常的审批人撤回(置为未运行)
						} else {
							task.setDbAction(2);	//删除任务内部会同时删除消息
							if(PostStatus.FINISHED.getValue().equals(post.getPostStatus())) {
								post.setLeftPerson(post.getLeftPerson() + 1);
							}
							delApproverCount++;
						}
					}
					
					//处理自动跳过的人
					if(ACStatus.RUNNING.getValue().equals(acUnit.getAcStatus()) 
							|| ACStatus.FINISHED.getValue().equals(acUnit.getAcStatus())) {
						boolean realAutoPass = false;
						String currentApproverTypeId = approver.getOwner().getOwner().getApprovalTypeId();
						if(("SP".equals(currentApproverTypeId) 
								|| "SH".equals(currentApproverTypeId))	
								&& approver.getAutoPass() == 1
								&& !approver.getOwner().getOwner().isAddLabel()) {
							realAutoPass = true;
						}
						if(realAutoPass && acUnit.getAcPx() > currentAc.getAcPx()) {
							task.setDbAction(2);	//删除任务内部会同时删除消息
							if(PostStatus.FINISHED.getValue().equals(post.getPostStatus())) {
								post.setLeftPerson(post.getLeftPerson() + 1);
							}
							if(ACStatus.RUNNING.getValue().equals(acUnit.getAcStatus())) {
								acUnit.setLeftPost(acUnit.getLeftPost() + 1);
							}
							delApproverCount++;
						}
					}
				}
				if(delApproverCount == approvers.size()) {
					post.setPostStatus(PostStatus.NOT_RUNNING.getValue());
					if(ACStatus.FINISHED.getValue().equals(acUnit.getAcStatus())) {
						acUnit.setLeftPost(acUnit.getLeftPost() + 1);
					}
					notRunPostCount++;
				}
			}
			
			if(notRunPostCount == posts.size()) {
				acUnit.setAcStatus(ACStatus.NOT_RUNNING.getValue());
				
//				joinLeftPostCal(acUnit);
			}
		}
	}
	
	protected void joinLeftPostCal(ACUnit acUnit) {
		List<ACUnit> nextList = acUnit.getNextAcs();
		if(CollectionUtils.isNotEmpty(nextList)) {
			for(ACUnit ac : nextList) {
				if(FlAcType.JOIN.getAcType().equals(ac.getAcType())) {
					ac.setLeftPost(ac.getLeftPost() + 1);
					joinLeftPostCal(ac);
				}
			}
		}
	}

	@Override
	protected void turnOn(ApproverUnit approver) throws Exception {
		TaskUnit task = approver.getTask();
		task.setTaskStatus(TaskStatus.RUNNING.getValue());
		task.setEndTime(null);
		task.setTaskResult(null);
		task.setTaskResultName(null);
		task.setTaskComments(null);
		
		currentPost.setLeftPerson(currentPost.getLeftPerson() + 1);
		if(PostStatus.FINISHED.getValue().equals(currentPost.getPostStatus())) {
			currentPost.setPostStatus(PostStatus.RUNNING.getValue());
			currentAc.setLeftPost(currentAc.getLeftPost() + 1);
		} else {
			
		}
		
		if(ACStatus.FINISHED.getValue().equals(currentAc.getAcStatus())) {
			currentAc.setAcStatus(ACStatus.RUNNING.getValue());
			
			//下一环节是聚合环节，其到达数+1
			List<ACUnit> nextList = currentAc.getNextAcs();
			if(CollectionUtils.isNotEmpty(nextList) && nextList.size() == 1) {
				ACUnit next = nextList.get(0);
				if(FlAcType.JOIN.getAcType().equals(next.getAcType())) {
					
					next.setLeftPost(next.getLeftPost() + 1);
				}
			}
		}
		
		//已办变待办
		service.getMsgService().completeMessage(task.getMsgId(), "DB");
	}
}
