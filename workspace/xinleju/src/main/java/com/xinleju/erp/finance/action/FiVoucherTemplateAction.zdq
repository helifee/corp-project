package com.xinleju.erp.finance.action;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;

import com.opensymphony.xwork2.ModelDriven;
import com.xinleju.erp.base.app.action.BaseAction;
import com.xinleju.erp.base.utils.JsonUtils;
import com.xinleju.erp.finance.models.FiVoucherEntry;
import com.xinleju.erp.finance.models.FiVoucherTempType;
import com.xinleju.erp.finance.models.FiVoucherTemplate;
import com.xinleju.erp.finance.service.FiVoucherTemplateService;
import com.xinleju.erp.flow.utils.LoginInfoUtils;

public class FiVoucherTemplateAction extends BaseAction implements ModelDriven<FiVoucherTemplate> {
	@Autowired
	private FiVoucherTemplateService fiVoucherTemplateService;
	private FiVoucherTemplate fiVoucherTemplate = new FiVoucherTemplate();

	public FiVoucherTemplate getModel() {
		return fiVoucherTemplate;
	}


	/**
	 * 保存凭证类型
	 */
	public void saveOrUpdate() {
		Map<String, Object> result = new HashMap<String, Object>();
		if (fiVoucherTemplate.getId() != null) {
			fiVoucherTemplate.setEditDate(new Date());
			fiVoucherTemplate.setEditUserId(LoginInfoUtils.getLoginInfoUserDtoId(request));
		} else {
			fiVoucherTemplate.setCreateDate(new Date());
			fiVoucherTemplate.setStatus(1);
			fiVoucherTemplate.setCreateUserId(LoginInfoUtils.getLoginInfoUserDtoId(request));
		}
		try {
			fiVoucherTemplateService.saveOrUpdate(fiVoucherTemplate);
			fiVoucherTemplateService.deleteEntryByTempId(fiVoucherTemplate.getId());
			if (fiVoucherTemplate.getFiVoucherEntryList().size() > 0) {
				for (FiVoucherEntry entry : fiVoucherTemplate.getFiVoucherEntryList()) {
					entry.setVoucherTemplateId(fiVoucherTemplate.getId());
				}
				fiVoucherTemplateService.saveEntry(fiVoucherTemplate.getFiVoucherEntryList());
			}
			result.put("success", true);
			result.put("msg", "操作成功");
			renderHtml(JsonUtils.toJSONString(result));
		} catch (Exception e) {
			result.put("success", false);
			result.put("msg", "操作失败");
			renderHtml(JsonUtils.toJSONString(result));
		}
	}

	/**
	 * 加载模板和分录，如果没有返回
	 */
	public void load() {
		Long typeId = this.getParameterLong("typeId");// 凭证模板类别id
		// FiVoucherTemplate t =
		// fiVoucherTemplateService.getDao().getById(FiVoucherTemplate.class,
		// fiVoucherTemplate.getId());
		FiVoucherTemplate temp = this.fiVoucherTemplateService.getFiVoucherTemplateByTypeId(typeId);
		FiVoucherTempType ft=fiVoucherTemplateService.getFiVoucherTempTypeById(typeId);
		Map<String, Object> result = new HashMap<String, Object>();
		if (temp != null) {
			temp.setBizTypeName(ft.getName());
			List<FiVoucherEntry> list = fiVoucherTemplateService.getVoucherEntryByTempId(temp.getId());
			temp.setFiVoucherEntryList(list);
			result.put("success", true);
			result.put("temp", temp);
//			renderHtml(JsonUtils.toJSONString(result));
			this.renderJson(result);
		} else {
			//放入空数据据防止缓存上次页面数据
			FiVoucherTemplate temp1=new FiVoucherTemplate();
			temp1.setTypeId(typeId);
			temp1.setBizTypeName(ft.getName());
			List<FiVoucherEntry> list =new ArrayList<FiVoucherEntry>();
			temp1.setFiVoucherEntryList(list);
			result.put("success", true);
			result.put("temp", temp1);
//			renderHtml(JsonUtils.toJSONString(result));
			this.renderJson(result);
		}
	}
}
