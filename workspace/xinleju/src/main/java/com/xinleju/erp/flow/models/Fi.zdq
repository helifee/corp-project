package com.xinleju.erp.flow.models;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.Index;
import javax.persistence.JoinColumn;
import javax.persistence.Lob;
import javax.persistence.ManyToOne;
import javax.persistence.Table;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;
import javax.persistence.Transient;

import org.apache.commons.lang3.StringUtils;
import org.springframework.jdbc.core.JdbcTemplate;

import com.xinleju.erp.base.app.config.App;
import com.xinleju.erp.base.app.models.IdEntity;
import com.xinleju.erp.base.app.service.ICommonService;
import com.xinleju.erp.base.utils.CollectionUtils;
import com.xinleju.erp.flow.utils.IdNameUtils;
import com.xinleju.erp.frame.models.Company;
import com.xinleju.erp.frame.models.ServiceObjectDefine;

/**
 * 
 * 
 * <p>
 * </p>
 * <p>
 * </p>
 * 
 * @author 孙朝辉
 * @version $Id: Fi.java 2204 2014-12-26 02:09:17Z sunchaohui $
 * @since
 * 
 */

@Entity
@Table(name = "tf_fi",indexes={@Index( columnList="related_fi_ids",unique=false), @Index( columnList="history_wi_user_ids",unique=false)})
public class Fi extends IdEntity {


    /**
     * 标记该流程是一个退回重启产生的新流程
     */
    private Integer isBackedFi;
    @Column(length=2000)
    private String goodNodeIds;

    private String flowProjectId;

    private String flowDeptId;
    
    private String flowCompanyId;
    
    /**
     * 流程阅读人员
     * 
     */
    @Column(length=2000)
    private String readUsers;
    
    /**
     * 流程抄送人
     * 
     */
    @Column(length=2000)
    private String csUsers;
    
    private Long startRoleId;
    /**
     * 序列化
     */
    private static final long serialVersionUID = -419700552988376536L;

    /**
     * 创建
     */
    public static final int STATUS_CREATED = 0;

    /**
     * 运行
     */
    public static final int STATUS_RUNNING = 1;

    /**
     * 结束
     */
    public static final int STATUS_COMPLETE = 2;

    /**
     * 覆盖Fl,是否启用时限
     */
    private Integer isLimit;

    /**
     * 覆盖Fl,时限
     */
    private BigDecimal timeLimit;

    /**
     * 覆盖Fl,时限单位
     */
    private Integer timeUnit;

    /**
     * 流程名
     */
    @Column
    private String fiName;
    
    /**
     * 流程编号-编号
     */
    @Column
    private String fiCode;
    
    /**
     * 流程编号-流水号
     */
    private String fiCodeNum;

    /**
     * 是否禁用
     */
    private Integer isDisabled;

    /**
     * 状态
     */
    private Integer status;

    /**
     * 是否删除
     */
    private int isDeleted;

    /**
     * 是否被挂起
     */
    private Integer isSuspend;

    /**
     * 挂起编码
     */
    private String suspendCode;

    /**
     * 挂起时间
     */
    @Temporal(TemporalType.TIMESTAMP)
    private Date suspendTime;

    /**
     * 挂起人姓名
     */
    private String suspendUserName;

    /**
     * 挂起人ID
     */
    private String suspendUserId;

    /**
     * 挂起人登录名
     */
    private String suspendUserLoginName;

    /**
     * 创建人ID
     */
    private Long createUserId;

    /**
     * 创建人登录名
     */
    private String createUserLoginName;

    /**
     * 创建人姓名
     */
    private String createUserName;

    /**
     * 创建时间
     */
    @Temporal(TemporalType.TIMESTAMP)
    private Date createTime;

    /**
     * 启动人ID
     */
    private Long startUserId;

    /**
     * 启动人登录名
     */
    private String startUserLoginName;

    /**
     * 启动人姓名
     */
    private String startUserName;

    
    /**
     * 归属人ID
     */
    private Long ownerUserId;

    /**
     * 归属人登录名
     */
    private String ownerUserLoginName;

    /**
     * 归属人姓名
     */
    private String ownerUserName;
    
    /**
     * 启动时间
     */
    @Temporal(TemporalType.TIMESTAMP)
    private Date startTime;

    /**
     * 结束人ID
     */
    private Long completeUserId;

    /**
     * 结束人姓名
     */
    private String completeUserName;

    /**
     * 结束人登录名
     */
    private String completeUserLoginName;

    /**
     * 结束时间
     */
    @Temporal(TemporalType.TIMESTAMP)
    private Date completeTime;

    /**
     * 是否终止
     */
    private Integer isTerminate;

    /**
     * 终止编码
     */
    private String terminateCode;

    /**
     * 终止用户ID
     */
    private Long terminateUserId;

    /**
     * 终止用户姓名
     */
    private String terminateUserName;

    /**
     * 终止用户登录名
     */
    private String terminateUserLoginName;

    /**
     * 终止日期
     */
    @Temporal(TemporalType.TIMESTAMP)
    private Date terminateTime;

    /**
     * 终止说明
     */
    @Lob
    private String terminateNote;

    /**
     * 外键:Fl,流程定义
     */
    private Long flId;

    /**
     * 级联对象:流程定义
     */
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(updatable = false, insertable = false)
    private Fl fl;

    /**
     * 所属业务对象id
     */
    @Column(name = "service_object_define_id")
    private Long serviceObjectDefineId;
    /**
     * 所属业务对象
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "service_object_define_id", updatable = false, insertable = false)
    private ServiceObjectDefine serviceObjectDefine;
    
    /**
     * 业务对象对应业务表单的id
     */
    @Column(name = "biz_id")
    private String bizId;
    /**业务对象对应业务表单的版本**/
    @Column(name = "biz_version")
    private String bizVersion;
    public String getBizVersion() {
		return bizVersion;
	}

	public void setBizVersion(String bizVersion) {
		this.bizVersion = bizVersion;
	}

	/**
     * 历史流程(用于退回操作，记录之前历史。以","隔开)
     */
    @Column(name = "related_fi_ids")
    private String relatedFiIds;
    
    /**
     * 公司id
     */
    @Column(name = "company_id")
    private Long companyId;
    
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(updatable = false, insertable = false)
    private Company company;
    
    /**
     * 可阅人员:只显示名称
     */
    @Transient
    private String readUsersName;
    
//    @Formula("(select group_"DbType.getType()+"concat(distinct w.participant_user_name) from tf_wi w where w.fi_id = id and w.status = 1 and w.wi_type in('ZC','CS','CY','CB'))")
    private String runningWiParticipantUserNames;

    
    /**
     * 历史流程(用于退回操作，记录之前历史。以","隔开)
     */
    @Column(name = "history_wi_user_ids")
    private String historyWiUserIds;
    
    public Integer getIsSuspend() {
        return isSuspend;
    }

    public void setIsSuspend(Integer isSuspend) {
        this.isSuspend = isSuspend;
    }

    public String getSuspendCode() {
        return suspendCode;
    }

    public void setSuspendCode(String suspendCode) {
        this.suspendCode = suspendCode;
    }

    public Date getSuspendTime() {
        return suspendTime;
    }

    public void setSuspendTime(Date suspendTime) {
        this.suspendTime = suspendTime;
    }

    public String getSuspendUserId() {
        return suspendUserId;
    }

    public void setSuspendUserId(String suspendUserId) {
        this.suspendUserId = suspendUserId;
    }

    public String getSuspendUserLoginName() {
        return suspendUserLoginName;
    }

    public void setSuspendUserLoginName(String suspendUserLoginName) {
        this.suspendUserLoginName = suspendUserLoginName;
    }

    public String getSuspendUserName() {
        return suspendUserName;
    }

    public void setSuspendUserName(String suspendUserName) {
        this.suspendUserName = suspendUserName;
    }

    public int getIsDeleted() {
        return isDeleted;
    }

    public void setIsDeleted(int isDeleted) {
        this.isDeleted = isDeleted;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public Long getCreateUserId() {
        return createUserId;
    }

    public void setCreateUserId(Long createUserId) {
        this.createUserId = createUserId;
    }

    public String getCreateUserLoginName() {
        return createUserLoginName;
    }

    public void setCreateUserLoginName(String createUserLoginName) {
        this.createUserLoginName = createUserLoginName;
    }

    public String getCreateUserName() {
        return createUserName;
    }

    public void setCreateUserName(String createUserName) {
        this.createUserName = createUserName;
    }

    public Fl getFl() {
        return fl;
    }

    public void setFl(Fl fl) {
        this.fl = fl;
    }

    public Long getFlId() {
        return flId;
    }

    public void setFlId(Long flId) {
        this.flId = flId;
    }

    public Date getStartTime() {
        return startTime;
    }

    public void setStartTime(Date startTime) {
        this.startTime = startTime;
    }

    public String getStartUserLoginName() {
        return startUserLoginName;
    }

    public void setStartUserLoginName(String startUserLoginName) {
        this.startUserLoginName = startUserLoginName;
    }

    public String getStartUserName() {
        return startUserName;
    }

    public void setStartUserName(String startUserName) {
        this.startUserName = startUserName;
    }

    public String getTerminateNote() {
        return terminateNote;
    }

    public void setTerminateNote(String terminateNote) {
        this.terminateNote = terminateNote;
    }

    public Date getTerminateTime() {
        return terminateTime;
    }

    public void setTerminateTime(Date terminateTime) {
        this.terminateTime = terminateTime;
    }

    public String getTerminateUserLoginName() {
        return terminateUserLoginName;
    }

    public void setTerminateUserLoginName(String terminateUserLoginName) {
        this.terminateUserLoginName = terminateUserLoginName;
    }

    public String getTerminateUserName() {
        return terminateUserName;
    }

    public void setTerminateUserName(String terminateUserName) {
        this.terminateUserName = terminateUserName;
    }



    public Date getCompleteTime() {
        return completeTime;
    }

    public void setCompleteTime(Date completeTime) {
        this.completeTime = completeTime;
    }

    public Long getCompleteUserId() {
        return completeUserId;
    }

    public void setCompleteUserId(Long completeUserId) {
        this.completeUserId = completeUserId;
    }

    public Long getStartUserId() {
        return startUserId;
    }

    public void setStartUserId(Long startUserId) {
        this.startUserId = startUserId;
    }

    public Long getTerminateUserId() {
        return terminateUserId;
    }

    public void setTerminateUserId(Long terminateUserId) {
        this.terminateUserId = terminateUserId;
    }

    public String getCompleteUserName() {
        return completeUserName;
    }

    public void setCompleteUserName(String completeUserName) {
        this.completeUserName = completeUserName;
    }

    public Integer getStatus() {
        return status;
    }

    public void setStatus(Integer status) {
        this.status = status;
    }

    public Integer getIsTerminate() {
        return isTerminate;
    
    }
    
    

    public void setIsTerminate(Integer isTerminate) {
        this.isTerminate = isTerminate;
    }

   
    public String getCompleteUserLoginName() {
        return completeUserLoginName;
    }

    public void setCompleteUserLoginName(String completeUserLoginName) {
        this.completeUserLoginName = completeUserLoginName;
    }

    public String getFiName() {
        return fiName;
    }

    public void setFiName(String fiName) {
        this.fiName = fiName;
    }

    public Integer getIsDisabled() {
        return isDisabled;
    }

    public void setIsDisabled(Integer isDisabled) {
        this.isDisabled = isDisabled;
    }

    public Integer getIsLimit() {
        return isLimit;
    }

    public void setIsLimit(Integer isLimit) {
        this.isLimit = isLimit;
    }

    public void setTimeLimit(BigDecimal timeLimit) {
        this.timeLimit = timeLimit;
    }

    public void setTimeUnit(Integer timeUnit) {
        this.timeUnit = timeUnit;
    }

    public BigDecimal getTimeLimit() {
        return timeLimit;
    }

    public Integer getTimeUnit() {
        return timeUnit;
    }

    public List<Wi> getHistorys() {
        return App.getBean(ICommonService.class).findAll(Wi.class, "fiId = ? and status = ?", new Object[] { getId(), Wi.STATUS_COMPLETE },
                new String[] { "ai", "ai.ac" });
    }
    public List<Wi> getHist() {
    	return App.getBean(ICommonService.class).findAll(Wi.class, "fiId = ? and status = ?", new Object[] { getId(), Wi.STATUS_COMPLETE },
    			new String[] { "ai", "ai.ac" });
    }

    public List<Wi> getRunnings() {
        return App.getBean(ICommonService.class).findAll(Wi.class, "fiId = ? and status = ?", new Object[] { getId(), Wi.STATUS_RUNNING },
                new String[] { "ai", "ai.ac" });
    }

    public void setTerminateCode(String terminateCode) {
        this.terminateCode = terminateCode;
    }

    public String getTerminateCode() {
        return terminateCode;
    }

    public Long getOwnerUserId() {
        return ownerUserId;
    }

    public void setOwnerUserId(Long ownerUserId) {
        this.ownerUserId = ownerUserId;
    }

    public String getOwnerUserLoginName() {
        return ownerUserLoginName;
    }

    public void setOwnerUserLoginName(String ownerUserLoginName) {
        this.ownerUserLoginName = ownerUserLoginName;
    }

    public String getOwnerUserName() {
        return ownerUserName;
    }

    public void setOwnerUserName(String ownerUserName) {
        this.ownerUserName = ownerUserName;
    }

    public Long getStartRoleId() {
        return startRoleId;
    }

    public void setStartRoleId(Long startRoleId) {
        this.startRoleId = startRoleId;
    }

    public String getReadUsers() {
        return readUsers;
    }

    public void setReadUsers(String readUsers) {
        this.readUsers = readUsers;
    }

    public String getCsUsers() {
        return csUsers;
    }

    public void setCsUsers(String csUsers) {
        this.csUsers = csUsers;
    }


    public Integer getIsBackedFi() {
        return isBackedFi;
    }

    public void setIsBackedFi(Integer isBackedFi) {
        this.isBackedFi = isBackedFi;
    }

    public String getGoodNodeIds() {
        return goodNodeIds;
    }

    public void setGoodNodeIds(String goodNodeIds) {
        this.goodNodeIds = goodNodeIds;
    }

    public Long getServiceObjectDefineId() {
        return serviceObjectDefineId;
    }

    public void setServiceObjectDefineId(Long serviceObjectDefineId) {
        this.serviceObjectDefineId = serviceObjectDefineId;
    }

    public ServiceObjectDefine getServiceObjectDefine() {
        return serviceObjectDefine;
    }

    public void setServiceObjectDefine(ServiceObjectDefine serviceObjectDefine) {
        this.serviceObjectDefine = serviceObjectDefine;
    }

    public String getBizId() {
        return bizId;
    }

    public void setBizId(String bizId) {
        this.bizId = bizId;
    }

    public String getRelatedFiIds() {
        return relatedFiIds;
    }

    public void setRelatedFiIds(String relatedFiIds) {
        this.relatedFiIds = relatedFiIds;
    }

    public String getReadUsersName() {
        if (StringUtils.isNotBlank(this.getReadUsers())){
            readUsersName = CollectionUtils.collectAsString(IdNameUtils.decode(this.getReadUsers()), "name", ",");
        }
        return readUsersName;
    }

    public void setReadUsersName(String readUsersName) {
        this.readUsersName = readUsersName;
    }

    public String getRunningWiParticipantUserNames() {
    	  List<String> strList = App.getBean(JdbcTemplate.class).queryForList("select distinct w.participant_user_name from tf_wi w where w.fi_id = ? and w.status = 1 and w.wi_type in('ZC','CS','CY','CB')", new Object[]{getId()}, String.class);
    	  StringBuffer stringBuffer=new StringBuffer();
    	  if(!strList.isEmpty()){
    		  for (String str : strList) {
				stringBuffer.append(str+",");
			}
    	  }
  		if(!StringUtils.isEmpty(stringBuffer)){
			stringBuffer=stringBuffer.deleteCharAt(stringBuffer.length()-1);
		}
  		runningWiParticipantUserNames=stringBuffer.toString();
        return runningWiParticipantUserNames;
    }

    public void setRunningWiParticipantUserNames(String runningWiParticipantUserNames) {
        this.runningWiParticipantUserNames = runningWiParticipantUserNames;
    }

    public Long getCompanyId() {
        return companyId;
    }

    public void setCompanyId(Long companyId) {
        this.companyId = companyId;
    }

    public Company getCompany() {
        return company;
    }

    public void setCompany(Company company) {
        this.company = company;
    }

    public String getFiCode() {
        return fiCode;
    }

    public void setFiCode(String fiCode) {
        this.fiCode = fiCode;
    }

	public String getFiCodeNum() {
		return fiCodeNum;
	}

	public void setFiCodeNum(String fiCodeNum) {
		this.fiCodeNum = fiCodeNum;
	}

    public String getHistoryWiUserIds() {
        return historyWiUserIds;
    }

    public void setHistoryWiUserIds(String historyWiUserIds) {
        this.historyWiUserIds = historyWiUserIds;
    }

	public String getFlowProjectId() {
		return flowProjectId;
	}

	public void setFlowProjectId(String flowProjectId) {
		this.flowProjectId = flowProjectId;
	}

	public String getFlowDeptId() {
		return flowDeptId;
	}

	public void setFlowDeptId(String flowDeptId) {
		this.flowDeptId = flowDeptId;
	}

	public String getFlowCompanyId() {
		return flowCompanyId;
	}

	public void setFlowCompanyId(String flowCompanyId) {
		this.flowCompanyId = flowCompanyId;
	}

	
	
    

}
