package com.xinleju.erp.frame.listener;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.net.URL;
import java.util.Enumeration;
import java.util.Properties;

import javax.servlet.ServletContext;
import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

import org.springframework.util.Assert;
import org.springframework.util.ResourceUtils;
import org.springframework.util.SystemPropertyUtils;
import org.springframework.web.util.ServletContextPropertyUtils;
import org.springframework.web.util.WebUtils;

public class InitPropertiesVariableListener implements ServletContextListener {
	
	public static final String WEB_APP_ROOT_PARAM = "appConfigLocation";
	@Override
	public void contextInitialized(ServletContextEvent event) {
		// TODO Auto-generated method stub
		ServletContext  servletContext=event.getServletContext();
		if (!existsWebAppRoot(servletContext)) {
			Assert.notNull(servletContext, "ServletContext must not be null");
			String root = servletContext.getRealPath("/");
			if (root == null) {
				throw new IllegalStateException(
					"Cannot set web app root system property when WAR file is not expanded");
			}
			String location = servletContext.getInitParameter(WEB_APP_ROOT_PARAM);
			if(location!=null){
				try {
					Properties props = new Properties();
					URL url = ResourceUtils.getURL(location);
					InputStream in = new FileInputStream(url.getPath());
			        props.load(in);
			        Enumeration en = props.propertyNames();
	                while (en.hasMoreElements()) {
	                     String key = (String) en.nextElement();
	                     if(key!=null && key.startsWith("cas")){
	                    	 String value = props.getProperty (key);
		                 	 System.setProperty(key, value);
	                     }
	                 }
	                System.out.println(System.getProperties());
				} catch (FileNotFoundException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}
			
		}
	}

	@Override
	public void contextDestroyed(ServletContextEvent event) {
		// TODO Auto-generated method stub
		
	}

	
	private static boolean existsWebAppRoot(ServletContext servletContext) {
		String webAppRootParam = servletContext.getInitParameter(WEB_APP_ROOT_PARAM);
		return (webAppRootParam == null || Boolean.valueOf(webAppRootParam));
	}
}
