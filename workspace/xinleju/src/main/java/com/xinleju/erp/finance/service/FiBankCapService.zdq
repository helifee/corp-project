package com.xinleju.erp.finance.service;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import com.xinleju.erp.base.app.service.impl.BaseService;
import com.xinleju.erp.finance.dao.FiBankCapDao;
import com.xinleju.erp.finance.dto.FiBankCapDTO;
import com.xinleju.erp.finance.models.FiAccountCaption;
import com.xinleju.erp.finance.models.FiBankCap;
import com.xinleju.erp.finance.utils.ExcelHandlerUtil;
import com.xinleju.erp.finance.utils.IExcelHandler;
import com.xinleju.erp.form.utils.DbType;

@Service
public class FiBankCapService extends BaseService implements IExcelHandler{
	
	@Autowired
	private FiBankCapDao fiBankCapDao;
	@Autowired
	private JdbcTemplate jt;
	@Autowired
	private FiAccountCaptionService fiAccountCaptionService;
	/**
	 * 根据预算编码获取一条记录
	 * @param code
	 * @param status
	 * @return
	 */
	public FiBankCap getFiBankCapByCode(String code,String status,Long companyId,Long accountSetId){
		String hql="from FiBankCap where accountCapCode='"+code+"' and status='"+status+"' ";
		if(companyId != null){
			hql += "and companyId="+companyId;
		}
		if(accountSetId!=null){
			hql += "and accountSetId="+accountSetId;
		}
		FiBankCap fbc = getDao().findFirstByHQL(FiBankCap.class, hql);
		return fbc;
	}
	
	/**
	 * 根据财务编码获取一条记录
	 * @param code
	 * @param status
	 * @return
	 */
	public FiBankCap getFiBankCapByAccCode(String accountCode,String status,Long sysId,Long accountSetId){
		String hql="from FiBankCap where accountCapCode='"+accountCode+"' and status='"+status+"' and sysId="+sysId +" and accountSetId="+accountSetId;
		FiBankCap fbc = getDao().findFirstByHQL(FiBankCap.class, hql);
		return fbc;
	}
	
	/**
	 * 根据ID获取FiBankCap
	 * @param code
	 * @return
	 */
	public FiBankCap getFiBankCapById(Long id){
		return getDao().getById(FiBankCap.class, id);
	}
	
	/**
	 * 根据账套id获得预算科目
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiBankCap> getFiBankCapList(Long accountSetId, String status,Long sysId,Long companyId) {
		return fiBankCapDao.getFiBankCapList(accountSetId, status,sysId,companyId);
	}
	/**
	 * 根据财务编码、银行编码、账套id，公司id，所属系统获得款项类型
	 * 
	 * @param accountCapCode
	 * @param bankCode
	 * @param accountSetId
	 * @param companyId
	 * @param sysId
	 * @return
	 */
	public List<FiBankCap> getFiBankCapListByCapAndBankCode(String accountCapCode,String bankCode,Long accountSetId,Long companyId,Long sysId){
		return fiBankCapDao.getFiBankCapListByCapAndBankCode(accountCapCode, bankCode, accountSetId, companyId, sysId);
	}
	
	/**
	 * 根据银行id获得收款科目
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiBankCap> getFiBankCapListByBankId(Long accountSetId,String bid,Long companyId,Long sysId) {
		return fiBankCapDao.getFiBankCapListByBankId(accountSetId,bid,companyId,sysId);
	}
	
	/**
	 * 根据银行名称获得收款科目
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiBankCap> getFiBankCapListByBankIdCo(Long accountSetId,String bankName,Long companyId,Long sysId) {
		return fiBankCapDao.getFiBankCapListByBankIdCo(accountSetId,bankName,companyId,sysId);
	}

	/**
	 * 根据账套id获得预算科目的dto
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiBankCapDTO> getFiBankCapDTOList(Long accountSetId, String status,Long sysId,Long companyId) {
		List<FiBankCapDTO> list = fiBankCapDao.getFiBankCapDTOList(accountSetId, status,sysId,companyId);
		return list;
	}

	
	public void saveOrUpdate(FiBankCap fiBankCap) {
		getDao().saveOrUpdate(fiBankCap);
	}

	/**
	 * 删除预算科目
	 * 
	 * @param fiAccountCaption
	 */
	public void delete(FiBankCap fiBankCap) {
		getDao().delete(fiBankCap);
	}

	/**
	 * excel页签名
	 * @return
	 */
	@Override
	public String getSheetName() {
		// TODO Auto-generated method stub
		return "银行科目对照";
	}
	/**
	 * 导出的excel字段名称
	 * @return
	 */
	@Override
	public String[] getHeadItemsNameAry() {
		// TODO Auto-generated method stub
		//id,accountCapCode,accountCapName,bankCode,bankName,bid,parentId,sysId,accountSetId,companyId
		String[] str = {"id","会计科目编码","会计科目名称","银行编码","银行名称","银行id","会计科目id","所属系统","账套id","公司id"};
		return str;
	}

	/**
	 * 导出的excel字段属性名，class中必须存在此属性
	 * @return
	 */
	@Override
	public String[] getHeadItemsCodeAry() {
		// TODO Auto-generated method stub
		String[] str = {"id","accountCapCode","accountCapName","bankCode","bankName","bid","accountCapId","sysId","accountSetId","companyId"};
		return str;
	}

	/**
	 * 导出的excel字段在表格中占的宽度，与code一一对应，默认100，如不想显示比如ID字段，可设置为0。
	 * @return
	 */
	@Override
	public Integer[] getHeadItemsLength() {
		// TODO Auto-generated method stub
		Integer[] lengths = { 100, 100, 100, 100, 100,100, 100, 100, 100, 100};
		return lengths;
	}

	/**
	 * 导出字段在excel中是否红色显示 <br/> true:是（字段值不导出），false：否，null：红色、且字段值导出
	 * @return
	 */
	@Override
	public Boolean[] getHeadItemsColor() {
		// TODO Auto-generated method stub
		Boolean[] bool = { false, false, false, false, false,false, false, false, false, false};
		return bool;
	}

	/**
	 * 导出的excel实体类名
	 * @return
	 */
	@Override
	public Class<?> getEntityClass() {
		// TODO Auto-generated method stub
		return FiBankCap.class;
	}

	/**
	 * 导出到excel的具体数据
	 * @return
	 */
	@Override
	public List<?> getEntityList(IExcelHandler handler,String accountSetCode,long sysId,Long accountSetId,Long companyId) {
		// TODO Auto-generated method stub
		try{
			FiBankCapService fiBankCapService = (FiBankCapService)handler;
			List<FiBankCap> fiBankCapDTOs = null;
			if (StringUtils.isNotBlank(accountSetCode))
				//System.out.println();
				fiBankCapDTOs = fiBankCapService.getFiBankCapList(accountSetId, "1",sysId,companyId);
			
			return fiBankCapDTOs;
		}catch(Exception e){
			e.printStackTrace();
		}
		return null;
	}

	/**
	 * 表格最上方的提示列表，为String集合，多条提示逐行显示
	 * @return
	 */
	@Override
	public List<String> getTipsList() {
		// TODO Auto-generated method stub
		List<String> tips = new ArrayList<String>();
		tips.add("说明：数据导出模板对格式有严格要求，请直接录入相关值，禁止增加或删除列，禁止删除此行及标题行，否则将导入失败！");
		return tips;
	}

	@Override
	public Map<String, Integer[]> getCellJoinMap() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public Class<?> getImpClass() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public String[] getImportColumns() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public String[] getImportHeadItemsName() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public Class<?>[] getImportColumnsType() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public Boolean[] getColsIsImp() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public int importPr(String accountSetCode,String sysId,String companyCode,String accountSetId,HSSFSheet sheet,Long companyId){
		int rowNum = sheet.getLastRowNum();// 行  
    	try{
    		String oldAccountSetId = "";
    		String oldSysId = "";
    		String oldCompanyId = "";
			for(int k=2;k<=rowNum;k++){
	    		HSSFRow hssfRow = sheet.getRow(k);
	    		if (hssfRow == null) {
					continue;
				}
	    		oldAccountSetId = hssfRow.getCell(8)+"";
	    		oldCompanyId = hssfRow.getCell(9)+"";
	    		oldSysId = hssfRow.getCell(7)+"";
	    		
	    		Long bid = null;
	    		if(StringUtils.isNotBlank(hssfRow.getCell(5)+"")){
	    			bid = Long.valueOf(ExcelHandlerUtil.cutIdLength(ExcelHandlerUtil.getValue(hssfRow.getCell(5))+""));
	    		}
	    		//id,accountCapCode,accountCapName,bankCode,bankName,bid,accountCapId,sysId,accountSetId,companyId
	    		List<FiBankCap> list = getFiBankCapListByCapAndBankCode(ExcelHandlerUtil.getValue(hssfRow.getCell(1))+"",ExcelHandlerUtil.getValue(hssfRow.getCell(3))+"",Long.valueOf(accountSetId),companyId,Long.valueOf(sysId));
	    		if(list != null && list.size()>0){
	    			continue;
	    		}
	    		FiAccountCaption fc = new FiAccountCaption();
	    		if(!oldAccountSetId.equals(accountSetId)){
	    			fc = fiAccountCaptionService.getFiAccountCaptionByCode(ExcelHandlerUtil.getValue(hssfRow.getCell(1))+"",Long.valueOf(accountSetId));
	    		}else{
	    			fc.setId(Long.valueOf(ExcelHandlerUtil.getValue(hssfRow.getCell(6))+""));
	    		}
	    		String sql = "insert into fi_bank_cap(account_Cap_Code,account_Cap_Name,account_Cap_Id,bank_Code,bank_Name,bid,sys_id,account_set_id,company_Id,create_date,status,account_set_code) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)";
    			getDao().executeSQL(sql, ExcelHandlerUtil.getValue(hssfRow.getCell(1))+"",ExcelHandlerUtil.getValue(hssfRow.getCell(2))+"",
	    				fc.getId(),ExcelHandlerUtil.getValue(hssfRow.getCell(3))+"",ExcelHandlerUtil.getValue(hssfRow.getCell(4))+"",
	    				bid,sysId,accountSetId,companyId,
	    				new Date(),1,accountSetCode);
	    	}
//			setParent(oldAccountSetId,accountSetId,oldSysId,sysId,oldCompanyId,companyId);
			return 2;
    	}catch(Exception e){
    		e.printStackTrace();
    		return 3;
    	}
	}
	
	/**
	 * 修改预算科目父id
	 * chc add 2016.6.29
	 */
	public void setParent(String oldAccountSetId,String accountSetId,String oldSysId,String sysId,String oldcompanyId,Long companyId){
		String hql="from FiBankCap where accountSetId='"+oldAccountSetId+"' and sysId = "+oldSysId+" and companyId="+oldcompanyId;
		String hql2="from FiBankCap where accountSetId='"+accountSetId+"' and sysId = "+sysId+" and companyId="+companyId;
		List<FiBankCap> list = getDao().findByHQL(FiBankCap.class, hql);
		List<FiBankCap> list2 = getDao().findByHQL(FiBankCap.class, hql2);
		for(FiBankCap fc:list){
			Long pid = fc.getParentId();
			String code = fc.getAccountCapCode();
			for(FiBankCap fc2:list2){
				String code2 = fc2.getAccountCapCode();
				if(StringUtils.isNotBlank(code) && code.equals(code2)){
					if(pid != null){
						FiBankCap c = this.getFiBankCapById(pid);
						if(c != null){
							String pcode = c.getAccountCapCode();
							String hql_="from FiBankCap where accountSetId='"+accountSetId+"' and accountCapCode ='"+pcode+"' and sysId="+sysId+" and companyId="+companyId + " order by createDate desc";
							FiBankCap fbc = getDao().findFirstByHQL(FiBankCap.class, hql_);
							if(fbc != null){
								Long pid_ = fbc.getId();
								fc2.setParentId(pid_);
								getDao().update(fc2);
							}
						}
					}
				}
			}
		}
	}
}
