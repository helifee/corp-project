package com.xinleju.erp.finance.dao;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Repository;

import com.xinleju.erp.finance.dto.FiBankCapDTO;
import com.xinleju.erp.finance.models.FiBankCap;
import com.xinleju.erp.flow.dao.impl.BaseDAO;

@Repository
public class FiBankCapDao extends BaseDAO {
	
	/**
	 * 根据账套id获得银行会计科目
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiBankCap> getFiBankCapList(Long accountSetId, String status,Long sysId,Long companyId) {
	    List<FiBankCap> fiBudgetList = new ArrayList<FiBankCap>();
//		fiBudgetList = getDao().findByHQL(FiBankCap.class, "from FiBankCap p where p.createDate = (select max(pp.createDate) from FiBankCap pp where pp.accountCapCode=p.accountCapCode and pp.accountSetId = ? and pp.sysId = ? and pp.companyId=?) and p.accountSetId = ? and p.sysId = ? and p.companyId = ?  order by p.accountCapCode asc",accountSetId,sysId,companyId,accountSetId,sysId,companyId);
	    fiBudgetList = getDao().findByHQL(FiBankCap.class, "from FiBankCap p where p.accountSetId = ? and p.sysId = ? and p.companyId = ?  order by p.accountCapCode asc",accountSetId,sysId,companyId);
		return fiBudgetList;
	}
	
	public List<FiBankCap> getFiBankCapListByBankId(Long accountSetId,String bid,Long companyId,Long sysId) {
		List<FiBankCap> fiBudgetList = new ArrayList<FiBankCap>();
		fiBudgetList = getDao().findByHQL(FiBankCap.class, "from FiBankCap p where p.accountSetId=? and p.bid = ?  and p.companyId = ? and p.sysId=?  order by p.accountCapCode asc",accountSetId,Long.valueOf(bid),companyId,sysId);
		return fiBudgetList;
	}
	
	public List<FiBankCap> getFiBankCapListByBankIdCo(Long accountSetId,String bankName,Long companyId,Long sysId) {
		List<FiBankCap> fiBudgetList = new ArrayList<FiBankCap>();
		fiBudgetList = getDao().findByHQL(FiBankCap.class, "from FiBankCap p where p.accountSetId=? and p.bankName = ?  and p.companyId = ? and p.sysId=?  order by p.accountCapCode asc",accountSetId,bankName,companyId,sysId);
		return fiBudgetList;
	}
	
	public List<FiBankCap> getFiBankCapListByCapAndBankCode(String accountCapCode,String bankCode,Long accountSetId,Long companyId,Long sysId){
		List<FiBankCap> fiBudgetList = new ArrayList<FiBankCap>();
		fiBudgetList = getDao().findByHQL(FiBankCap.class, "from FiBankCap p where p.accountCapCode=? and p.bankCode=? and p.accountSetId=? and p.companyId = ? and p.sysId=?  order by p.accountCapCode asc",accountCapCode,bankCode,accountSetId,companyId,sysId);
		return fiBudgetList;
	}

	/**
	 * 将FiBudgetCapDTO列表返回
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiBankCapDTO> getFiBankCapDTOList(Long accountSetId, String status,Long sysId,Long companyId) {
		List<FiBankCap> fiBudgetCapList = getFiBankCapList(accountSetId, status,sysId,companyId);
		List<FiBankCapDTO> dtoList = new ArrayList<FiBankCapDTO>(fiBudgetCapList.size());
		for (FiBankCap fiBudgetCap : fiBudgetCapList) {
			FiBankCapDTO subjectDTO = captionToSubjectDTO(fiBudgetCap);
			dtoList.add(subjectDTO);
		}
		return dtoList;
	}

	/**
	 * 将会计科目转换成Dto对象
	 * 
	 * @param accountCaption
	 * @return
	 */
	private FiBankCapDTO captionToSubjectDTO(FiBankCap fiBudgetCap) {
		FiBankCapDTO dto = new FiBankCapDTO();
		dto.setId(String.valueOf(fiBudgetCap.getId()));
		dto.setPid(fiBudgetCap.getParentId() == null ? "" : fiBudgetCap.getParentId().toString());
		dto.setBankCode(fiBudgetCap.getBankCode());
		dto.setBankName(fiBudgetCap.getBankName());
		dto.setAccountsetid(String.valueOf(fiBudgetCap.getAccountSetId()));
		dto.setAccountCapId(fiBudgetCap.getAccountCapId() == null ? "":fiBudgetCap.getAccountCapId().toString());
		dto.setAccountCapCode(fiBudgetCap.getAccountCapCode());
		dto.setAccountCapName(fiBudgetCap.getAccountCapName());
		dto.setBid(fiBudgetCap.getBid());
		dto.setCompanyId(fiBudgetCap.getCompanyId());
		try{
			SimpleDateFormat sf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
			if(fiBudgetCap.getCreateDate()!=null){
				dto.setCreateDate(sf.format(fiBudgetCap.getCreateDate()));
			}
		}catch(Exception e){
			e.printStackTrace();
		}
		return dto;
	}

	/**
	 * 将预算科目保存代码
	 * 
	 * @param fiBudgetCap
	 */
	public void saveOrUpdate(FiBankCap fiBudgetCap) {
		getDao().saveOrUpdate(fiBudgetCap);
	}

}
