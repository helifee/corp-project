package com.xinleju.erp.frame.service;

import java.util.Date;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.xinleju.erp.frame.dao.SendQueueDao;
import com.xinleju.erp.frame.dao.SmContentDao;
import com.xinleju.erp.frame.models.SendQueue;
import com.xinleju.erp.frame.models.SmContent;

@Service
@Transactional
public class SendSmService {

	@Autowired
	private SmContentDao smContentDao;

	@Autowired
	private SendQueueDao sendQueueDao;

	public Boolean sendSm() {
		Boolean flag = false;
		SmContent smContent = null;
		try {
			List<SendQueue> sendQueueList = sendQueueDao.findBySendByAndPriority(2);
			for (SendQueue sendQueue : sendQueueList) {

				smContent = smContentDao.findOne(sendQueue.getContentId());
				// 发送短信
				flag = send(smContent);

				if (flag == false) {
					return flag;
				}
				if (smContent.getFirstSendAt() == null) {
					smContent.setFirstSendAt(new Date());
				}
				smContent.setLastSendAt(new Date());
				smContent.setSendState(1);
				smContent.setSuccessSendTimes((smContent.getSuccessSendTimes() == null ? 0 : smContent.getSuccessSendTimes()) + 1);
				smContent.setFailureContinueTimes(0);
				smContentDao.save(smContent);

			}

		} catch (Exception e) {
			if (smContent != null) {
				smContent.setSendState(2);
				smContent.setFaliureSendTimes((smContent.getFaliureSendTimes() == null ? 0 : smContent.getFaliureSendTimes()) + 1);
				smContent.setFailureContinueTimes((smContent.getFailureContinueTimes() == null ? 0 : smContent.getFailureContinueTimes()) + 1);
				smContentDao.save(smContent);

			}

		}
		return flag;
	}

	public Boolean send(SmContent sm) {
		Boolean flag = false;
		return flag;
	}
}
