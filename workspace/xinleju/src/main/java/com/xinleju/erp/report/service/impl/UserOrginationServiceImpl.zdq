package com.xinleju.erp.report.service.impl;

import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import com.xinleju.erp.base.app.service.impl.BaseService;
import com.xinleju.erp.form.utils.DbType;
import com.xinleju.erp.report.models.UserOrgination;
import com.xinleju.erp.report.service.UserOrginationService;

@Service
public class UserOrginationServiceImpl extends BaseService implements UserOrginationService {
	@Autowired
	private JdbcTemplate jdbcTemplate;
	@Override
	public void sysUserOrgination() {
		// TODO Auto-generated method stub
		String sql = "select y.id, y.party_type_id,y.prefix,y.name ,r.loginname from sm_party_entity y,sm_user r where y.party_type_id=6 and y.ref_id=r.id"; 
		List<Map<String, Object>> list=jdbcTemplate.queryForList(sql);
		
		for(Map<String, Object> map :list){
			UserOrgination userOrgination=new UserOrgination();
			String prefix=(String) map.get("prefix");
			String name=(String) map.get("name");
			String loginname=(String) map.get("loginname");
			Long id=(Long) map.get("id");
			userOrgination.setPartId(id);
			userOrgination.setName(name);
			userOrgination.setLoginName(loginname);
			String orgSql = "select y.party_type_id,y.prefix,y.name ,y.name_prefix from sm_party_entity y where "+DbType.getType()+"locate(y.prefix,'"+prefix+"')>0 order  by y.prefix desc "; 
			List<Map<String, Object>> listOrg=jdbcTemplate.queryForList(orgSql);
			for(Map<String, Object> mapOrg :listOrg){
				String prefixOrg=(String) mapOrg.get("prefix");
				String name_prefixOrg=(String) mapOrg.get("name_prefix");
				String nameOrg=(String) mapOrg.get("name");
				Long party_type_id=(Long) mapOrg.get("party_type_id");
				if(2==party_type_id &&userOrgination.getCompany()==null ){
					userOrgination.setCompany(nameOrg);
				}
				
				if((party_type_id==3 ||party_type_id==4) &&userOrgination.getCompany()==null ){
					userOrgination.setDept(nameOrg);
					userOrgination.setDeptPath(name_prefixOrg);
				}
				
				if(party_type_id==5 &&userOrgination.getCompany()==null ){
					userOrgination.setPost(nameOrg);
					userOrgination.setPostPath(nameOrg);
				}
			}
			
			getDao().save(userOrgination);
		}
		
	}

}
