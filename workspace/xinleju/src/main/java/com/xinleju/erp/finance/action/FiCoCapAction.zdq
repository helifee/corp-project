package com.xinleju.erp.finance.action;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.springframework.beans.factory.annotation.Autowired;

import com.opensymphony.xwork2.ModelDriven;
import com.xinleju.erp.base.app.action.BaseAction;
import com.xinleju.erp.base.app.config.App;
import com.xinleju.erp.base.utils.JsonUtils;
import com.xinleju.erp.co.voucher.service.SyncFinaCoData;
import com.xinleju.erp.finance.dto.FiCoCapDTO;
import com.xinleju.erp.finance.models.FiAccountSetData;
import com.xinleju.erp.finance.models.FiCoCap;
import com.xinleju.erp.finance.models.extender.FiCoCapComboTreeExtender;
import com.xinleju.erp.finance.service.FiAccountSetDataService;
import com.xinleju.erp.finance.service.FiCoCapService;
import com.xinleju.erp.finance.utils.ExcelHandlerUtil;
import com.xinleju.erp.finance.utils.IExcelHandler;
import com.xinleju.erp.flow.utils.LoginInfoUtils;
import com.xinleju.erp.frame.dto.JsonTreeTableTemplete;
import com.xinleju.erp.frame.utils.CommonUtil;

import net.sf.json.JSONArray;

/**
 * 预算科目 ACTION
 * @author ztl
 *
 */
public class FiCoCapAction extends BaseAction implements ModelDriven<FiCoCap>{
	
	@Autowired
	private FiCoCapService fiCoCapService;
	@Autowired
	private FiAccountSetDataService fiAccountSetDataService;
	private FiCoCap fiCoCap = new FiCoCap();
	private File  uploadfile;
	/**
	 * 列表
	 * 
	 * @return
	 */
	public String list() {
		Long accountSetId = getParameterLong("accountSetId");
		String accountSetCode = request.getParameter("accountSetCode");
		Long sysId = getParameterLong("sysId");
		request.setAttribute("accountSetCode", accountSetCode);
		request.setAttribute("sysId", sysId);
		request.setAttribute("accountSetId", accountSetId);
		List<FiAccountSetData> fasds = fiAccountSetDataService.getFiAccountSetsDataByAccountId(accountSetId,sysId);
		if(fasds != null && fasds.size() > 0){
			List<Long> ids = new ArrayList<Long>();
			List<FiAccountSetData> companys = new ArrayList<FiAccountSetData>();
			for(FiAccountSetData f:fasds){
				if(!ids.contains(f.getCompanyId())){
					ids.add(f.getCompanyId());
					companys.add(f);
				}
			}
			String accountSetsjson = JsonUtils.toJSONString(companys);
			request.setAttribute("accountSetsjson", accountSetsjson);
			ids.clear();
		}else{
			request.setAttribute("accountSetsjson", "[]");
		}
		return "list";
	}

	
	/**
	 * 加载预算科目的treeGrid的json数据
	 */
	public void loadTreeGrid() {
		try{
		Long accountSetId = getParameterLong("accountSetId");
		String accountSetCode = request.getParameter("accountSetCode");
		Long sysId = getParameterLong("sysId");
		Long companyId = getParameterLong("companyId");
		String status = "1";
		List<FiCoCapDTO> fiCoCapDTOs = null;
		if (StringUtils.isNotBlank(accountSetCode))
			fiCoCapDTOs = fiCoCapService.getFiCoCapDTOList(accountSetId, status,sysId,companyId);
		else
			fiCoCapDTOs = new ArrayList<FiCoCapDTO>();
		JsonTreeTableTemplete jttt = new JsonTreeTableTemplete("id", "pid", FiCoCapDTO.class, FiCoCapComboTreeExtender.class);
		JSONArray jsonTree = CommonUtil.transTree(fiCoCapDTOs, jttt);
		renderJson(jsonTree.toString());
		}catch(Exception e){
			e.printStackTrace();
		}
	}
	
	public void loadComboTree() {
		Long sysId = getParameterLong("sysId");
		Long companyId = getParameterLong("companyId");
		List<FiCoCapDTO> fds = new ArrayList<FiCoCapDTO>();
		if(sysId.intValue()==2){
			SyncFinaCoData syncFinaCoData =  (SyncFinaCoData) App.getBean("syncFinaCoData");
			Map<Long,List<Map<String,Object>>> returnmap = syncFinaCoData.findSub(companyId);
			List<Map<String,Object>> list = returnmap.get(companyId);
			for(int i=0;i<list.size();i++){
				FiCoCapDTO bc = new FiCoCapDTO();
				Map<String,Object> mpa = list.get(i);
				String id = String.valueOf(mpa.get("id"));
				String pid = String.valueOf(mpa.get("parentId"));
				String code = String.valueOf(mpa.get("fullCode"));
				String name = String.valueOf(mpa.get("name"));
			   
				bc.setSubcode(code);
				bc.setSubname(name);
				try {
					bc.setPid(pid);
				} catch (Exception e) {
					bc.setPid("0");
				}
				bc.setId(id);
				bc.setCompanyId(companyId);
				fds.add(bc);
			}
		}
		JsonTreeTableTemplete jttt = new JsonTreeTableTemplete("id", "pid", FiCoCapDTO.class, FiCoCapComboTreeExtender.class);
		JSONArray jsonTree = CommonUtil.transTree(fds, jttt);
		renderJson(jsonTree.toString());
	}

	
	/**
	 * 保存或者更新会计科目
	 */
	public void saveOrUpdate() {
		Map<String, Object> result = new HashMap<String, Object>();
		if (fiCoCap.getId() != null) {
			fiCoCap.setEditDate(new Date());
			fiCoCap.setStatus(1);
			fiCoCap.setEditUserId(LoginInfoUtils.getLoginInfoUserDtoId(request));
		} else {
			fiCoCap.setCreateDate(new Date());
			fiCoCap.setStatus(1);
			fiCoCap.setCreateUserId(LoginInfoUtils.getLoginInfoUserDtoId(request));
		}

		try {
			fiCoCapService.saveOrUpdate(fiCoCap);
			result.put("success", true);
			result.put("msg", "操作成功");
			renderHtml(JsonUtils.toJSONString(result));
		} catch (Exception e) {
			result.put("success", false);
			result.put("msg", e.getMessage());
			renderHtml(JsonUtils.toJSONString(result));
		}
	}

	public void delete() {
		Map<String, Object> result = new HashMap<String, Object>();
		try {
			fiCoCapService.delete(fiCoCap);
			result.put("success", true);
			renderHtml(JsonUtils.toJSONString(result));
		} catch (Exception e) {
			result.put("success", false);
			result.put("msg", e.getMessage());
			renderHtml(JsonUtils.toJSONString(result));
		}
	}
	
	/*
	 * 成本科目对照 导出
	 */
	public void exportPr(){
		try {
			String accountSetCode = request.getParameter("accountSetCode");
			String sysId = request.getParameter("sysId");
			String accountSetId = request.getParameter("accountSetId");
			Long companyId = getParameterLong("companyId");
			List<IExcelHandler> iexcelHandlerList = new ArrayList<IExcelHandler>();
			iexcelHandlerList.add(fiCoCapService);
			HSSFWorkbook wb = ExcelHandlerUtil.onexport(iexcelHandlerList,accountSetCode,Long.parseLong(sysId),Long.parseLong(accountSetId),companyId);
			onExport(wb,"成本科目对照.xls");
		} catch (Exception e) {
			e.printStackTrace();
			Logger.getLogger(this.getClass()).error(e.getMessage());
		}
	}
	
	public void onExport(HSSFWorkbook wb,String fileName) throws UnsupportedEncodingException{
		response.setContentType("application/vnd.ms-excel");
		String downloadFileName=new String(fileName.getBytes("gb2312"), "iso8859-1");
		
		response.setHeader("Content-disposition","attachment;filename="+downloadFileName);
		OutputStream ouputStream = null;
		try {
			ouputStream = response.getOutputStream();
			wb.write(ouputStream);
			ouputStream.flush();
			ouputStream.close();
		} catch (IOException e) {
			Logger.getLogger(this.getClass()).error(e.getMessage());
			Logger.getLogger(this.getClass()).error("业务异常",e);
		}finally{
			if (ouputStream != null)
				try {
					ouputStream.close();
				} catch (IOException e) {
					Logger.getLogger(this.getClass()).error(e.getMessage());
					Logger.getLogger(this.getClass()).error("业务异常",e);
				}
            
		}
	}
	
	/**
	 * 成本科目对照导入
	 */
	public void  importPr(){
		try {
			String accountSetCode = request.getParameter("accountSetCode");//账套好
			String sysId = request.getParameter("sysId");//系统
			String companyCode = request.getParameter("companyCode");//公司编码
			String accountSetId = request.getParameter("accountSetId");
			Long companyId = getParameterLong("companyId");
			List<IExcelHandler> iexcelHandlerList = new ArrayList<IExcelHandler>();
			iexcelHandlerList.add(fiCoCapService);
			FileInputStream fileInputStream = new FileInputStream(uploadfile);
			ExcelHandlerUtil.importPr(fileInputStream,accountSetCode,sysId,companyCode,accountSetId,iexcelHandlerList,companyId);
		} catch (Exception e) {
			e.printStackTrace();
			Logger.getLogger(this.getClass()).error(e.getMessage());
			Logger.getLogger(this.getClass()).error("业务异常",e);
		}
	}
	
	public FiCoCap getModel() {
		return fiCoCap;
	}

	public FiCoCap getFiCoCap() {
		return fiCoCap;
	}

	public void setFiCoCap(FiCoCap fiCoCap) {
		this.fiCoCap = fiCoCap;
	}

	/**
	 * @return the uploadfile
	 */
	public File getUploadfile() {
		return uploadfile;
	}

	/**
	 * @param uploadfile the uploadfile to set
	 */
	public void setUploadfile(File uploadfile) {
		this.uploadfile = uploadfile;
	}
	
}
