package com.xinleju.erp.flowengine.dao.impl;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

import com.xinleju.erp.flow.dao.impl.BaseDAO;
import com.xinleju.erp.flowengine.dao.FlowInstanceStepWorkTaskDao;
import com.xinleju.erp.flowengine.models.FlowInstanceStepWorkTask;

@Repository
public class FlowInstanceStepWorkTaskDaoImpl extends BaseDAO implements FlowInstanceStepWorkTaskDao {
	@Autowired
	private JdbcTemplate jt;

	@Override
	public String getFlowInstanceStepWorkTaskType(String taskId) {
		// TODO Auto-generated method stub
		String sql="select t.type from flow_instance_step_work_task t where t.guid= ? ";
		return jt.queryForObject(sql, new Object[]{taskId}, String.class);
	}

	@Override
	public List<String> getFlowInstanceStepWorkTaskById(String assignTaskId,
			String operCtrl) {
		// TODO Auto-generated method stub
		String sql="select guid from flow_instance_step_work_task k where k.assign_task_id = ? and k.oper_ctrl='XBR' and k.status='1' ";
		return jt.queryForList(sql,  String.class,new Object[]{assignTaskId});
	}

	@Override
	public FlowInstanceStepWorkTask getFlowInstanceStepWorkTaskById(
			String taskId) {
		// TODO Auto-generated method stub
		return getDao().getById(FlowInstanceStepWorkTask.class, taskId, null);
	}

	@Override
	public String getCurrentTransactor(String fiId) {
		// TODO Auto-generated method stub
		StringBuffer sBuffer = new StringBuffer();
		String sqlStr = "select participant_user_name from flow_instance_step_work_task where status=1 and fi_id = ? ";
		List<String> list = jt.queryForList(sqlStr, String.class,
				new Object[] { fiId });
		if (list != null && list.size() > 0) {
			int i = 0;
			for (String str : list) {
				if (i == 0) {
					sBuffer.append(str);
					i += 1;
				} else {
					sBuffer.append(";").append(str);
				}
			}
		}

		return sBuffer.toString();
	}

	
}
