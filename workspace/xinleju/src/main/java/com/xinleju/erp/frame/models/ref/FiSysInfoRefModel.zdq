package com.xinleju.erp.frame.models.ref;

import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.MatchMode;
import org.hibernate.criterion.Restrictions;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.xinleju.erp.annotation.PageField;
import com.xinleju.erp.base.app.bean.Page;
import com.xinleju.erp.frame.dao.FiBusinessDao;
import com.xinleju.erp.frame.itf.IRefModel;
import com.xinleju.erp.frame.models.BaseEntity;
import com.xinleju.erp.frame.models.FiSysInfo;

@Component
public class FiSysInfoRefModel implements IRefModel {
	@Autowired
	FiBusinessDao fibusinessDao;
	@Override
	public Page getData(int start,int limit,String keywords) {
		DetachedCriteria dc = DetachedCriteria.forClass(FiSysInfo.class);
		dc.add(Restrictions.eqOrIsNull("status", 0));
		if (StringUtils.isNotBlank(keywords)) {
			dc.add(Restrictions.like("vtargetsysname", keywords, MatchMode.ANYWHERE));
		}
		Page page = fibusinessDao.getDao().findPage(dc, start, limit);
		List<Map<String,Object>> resList = new ArrayList<Map<String,Object>>();
		for(Object entity : page.getItems()){
			if(entity instanceof BaseEntity)
				resList.add( transform((BaseEntity)entity));
		}	
		page.setItems(resList);
		return page;
	}
	
	private Map<String,Object> transform(BaseEntity entity){
		Map<String,Object> map = new HashMap<String,Object>();
		map.put(getKeyField(), entity.getAttribute(getKeyField()));
		map.put(getNameField(), entity.getAttribute(getNameField()));
		for(String field : getShowFields()){
			Object value =  entity.getAttribute(field);
			map.put(field, value);
		}
		return map;
	}

	@Override
	public String getKeyField() {
		return "id";
	}

	@Override
	public String getNameField() {
		return "vtargetsysname";
	}

	@Override
	public String[] getShowFields() {
		return new String[]{"vtargetsyscode","vtargetsysname","vbusisyscode"};
	}
	
	@Override
	public String[] getShowNames() {
		List<String> list = new ArrayList<String>();
		for(String fieldname : getShowFields()){
			String name = fieldname;
			try {
				Field field = FiSysInfo.class.getDeclaredField(fieldname);
				if(field != null){
					PageField pagefield = field.getAnnotation(PageField.class);
					if(pagefield != null)
						name =pagefield.showname(); 
				}
			} catch (Exception e){
			}
			list.add(name);
		}
		return list.toArray(new String[0]);
	}

	@Override
	public String getTitle() {
		return "财务系统";
	}

	@Override
	public Boolean isMutil() {
		return false;
	}
	
	@Override
	public String getCodeField() {
		return "vtargetsyscode";
	}
}
