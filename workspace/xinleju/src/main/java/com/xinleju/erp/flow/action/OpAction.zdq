package com.xinleju.erp.flow.action;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.hibernate.criterion.Criterion;
import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.Restrictions;
import org.springframework.beans.factory.annotation.Autowired;

import com.xinleju.erp.base.app.action.BaseAction;
import com.xinleju.erp.flow.dao.impl.OpDAO;
import com.xinleju.erp.flow.models.Op;
import com.xinleju.erp.flow.service.extend.dto.FiOpDto;

/**
 * <p>
 * 操作维护
 * </p>
 * <p>
 * </p>
 * 
 * @author 孙朝辉
 * @version $Id: OpAction.java 1616 2014-10-31 07:40:39Z zhongjun $
 * @since
 * @see
 */
public class OpAction extends BaseAction {

    /**
     * 模型对象:操作
     */
    private Op op;

    /**
     * 操作按钮
     */
    private List<Op> opList;
    
    /**
     * 编号规则DTO
     */
    private FiOpDto fiOpDto;
    
    /**
     * 操作DAO
     */
    @Autowired
    private OpDAO opDAO;

    /**
     * 
     * 操作列表
     * 
     * @author 孙朝辉
     * @param
     * @return String
     * 
     */
    public String list() {
        Map<String, String> statusMap = new HashMap<String,String>();
        statusMap.put(FiOpDto.IS_DISABLED_N, "启用");
        statusMap.put(FiOpDto.IS_DISABLED_Y, "禁用");
        request.setAttribute("statusMap", statusMap);
        DetachedCriteria dc = DetachedCriteria.forClass(Op.class);
        if (null != fiOpDto){
            if (StringUtils.isNotEmpty(fiOpDto.getKeyword())) {
                dc.add(Restrictions.or(Restrictions.ilike("name", "%" + fiOpDto.getKeyword().trim() + "%"), Restrictions.ilike("code", "%" + fiOpDto.getKeyword().trim() + "%")));
            }
            if ("1".equals(fiOpDto.getStatus())) {
                dc.add(Restrictions.eq("isDisabled", 1));
            } else if ("0".equals(fiOpDto.getStatus())) {
                dc.add(Restrictions.or(new Criterion[] { Restrictions.eq("isDisabled", 0), Restrictions.isNull("isDisabled") }));
            }
        }
        page = getCommonService().findPage(dc, start, limit);
        return "list";
    }

    /**
     * 
     * 操作编辑
     * 
     * @author 孙朝辉
     * @param
     * @return String
     * 
     */
    public String edit() {

        op = super.edit(Op.class);

        return "edit";
    }

    /**
     * 
     * 〈简述〉 〈详细描述〉
     * 
     * @author Administrator [参考的 类、类#方法、类#成员]
     */
    public void save() {
        getCommonService().saveOrUpdate(op);
        
        super.renderJson("{}");
        // redirect("op!list.do", "isDisabled", "name");
    }

    public void updateOp(){
        Map<String,Object> result = new HashMap<String,Object>();
        try{
            String ids = getParameter("ids");
            Integer isdisabled = getParameterInt("isdisabled");
            if (null == isdisabled){
                isdisabled = 0;
            }
            if(StringUtils.isNotBlank(ids)) {
                String[] idAry = ids.split(";");
                for(String id : idAry) {
                    getCommonService().execute("update Op set isDisabled = ? where id = ?", isdisabled, Long.valueOf(id));
                }
            }
            result.put("success", true);
        }catch(Exception e){
            result.put("success", false);
            result.put("msg", e.getMessage());
        }
        renderJson(result);
    }
    
    /**
     * 
     * 操作禁用
     * 
     * @author 孙朝辉
     * @param
     * 
     */
    public void delete() {

        if (ids != null) {
            for (Long id : ids) {
                getCommonService().execute("update Op set isDisabled = 1 where id = ?", id);
            }
        }
        redirect("op!list.do", "isDisabled", "name");
    }

    /**
     * 
     * 操作解禁
     * 
     * @author 孙朝辉
     * @param
     * 
     */
    public void unDelete() {

        if (ids != null) {
            for (Long id : ids) {
                getCommonService().execute("update Op set isDisabled = 0 where id = ?", id);
            }
        }
        redirect("op!list.do", "isDisabled", "name");
    }
    
    public Op getOp() {
        return op;
    }

    public void setOp(Op op) {
        this.op = op;
    }

    public List<Op> getOpList() {
        return opList;
    }

    public void setOpList(List<Op> opList) {
        this.opList = opList;
    }

    public FiOpDto getFiOpDto() {
        return fiOpDto;
    }

    public void setFiOpDto(FiOpDto fiOpDto) {
        this.fiOpDto = fiOpDto;
    }

}
