package com.xinleju.erp.finance.dao;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Repository;

import com.xinleju.erp.finance.dto.FiCollectionTypeCapDTO;
import com.xinleju.erp.finance.models.FiCollectionTypeCap;
import com.xinleju.erp.flow.dao.impl.BaseDAO;

@Repository
public class FiCollectionTypeCapDao extends BaseDAO {
	
	/**
	 * 根据账套id获得银行会计科目
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiCollectionTypeCap> getFiCollectionTypeCapList(Long accountSetId, String status,Long sysId,Long companyId) {
	    List<FiCollectionTypeCap> fiBudgetList = new ArrayList<FiCollectionTypeCap>();
//		fiBudgetList = getDao().findByHQL(FiCollectionTypeCap.class, "from FiCollectionTypeCap p where p.createDate = (select max(pp.createDate) from FiCollectionTypeCap pp where pp.accountCapCode=p.accountCapCode and pp.accountSetId = ? and pp.sysId = ? and pp.companyId=?) and p.accountSetId = ? and p.sysId = ? and p.companyId = ?  order by p.accountCapCode asc",accountSetId,sysId,companyId,accountSetId,sysId,companyId);
	    fiBudgetList = getDao().findByHQL(FiCollectionTypeCap.class, "from FiCollectionTypeCap p where p.accountSetId = ? and p.sysId = ? and p.companyId = ?  order by p.accountCapCode asc",accountSetId,sysId,companyId);
		return fiBudgetList;
	}
	
	/**
	 * 根据银行id获得款项名称
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiCollectionTypeCap> getFiCollectionTypeCapListByTypeId(Long accountSetId,String bid) {
		List<FiCollectionTypeCap> fiBudgetList = new ArrayList<FiCollectionTypeCap>();
		fiBudgetList = getDao().findByHQL(FiCollectionTypeCap.class, "from FiCollectionTypeCap p where p.accountSetId = ? and p.saId = ?  order by p.accountCapCode asc",accountSetId,Long.valueOf(bid));
		return fiBudgetList;
	}

	/**
	 * 将FiBudgetCapDTO列表返回
	 * 
	 * @param accountSetId
	 * @param status
	 * @return
	 */
	public List<FiCollectionTypeCapDTO> getFiCollectionTypeCapDTOList(Long accountSetId, String status,Long sysId,Long companyId) {
		List<FiCollectionTypeCap> fiBudgetCapList = getFiCollectionTypeCapList(accountSetId, status,sysId,companyId);
		List<FiCollectionTypeCapDTO> dtoList = new ArrayList<FiCollectionTypeCapDTO>(fiBudgetCapList.size());
		for (FiCollectionTypeCap fiBudgetCap : fiBudgetCapList) {
			FiCollectionTypeCapDTO subjectDTO = captionToSubjectDTO(fiBudgetCap);
			dtoList.add(subjectDTO);
		}
		return dtoList;
	}

	/**
	 * 将会计科目转换成Dto对象
	 * 
	 * @param accountCaption
	 * @return
	 */
	private FiCollectionTypeCapDTO captionToSubjectDTO(FiCollectionTypeCap fiBudgetCap) {
		FiCollectionTypeCapDTO dto = new FiCollectionTypeCapDTO();
		dto.setId(String.valueOf(fiBudgetCap.getId()));
		dto.setPid(fiBudgetCap.getParentId() == null ? "" : fiBudgetCap.getParentId().toString());
		dto.setBankCode(fiBudgetCap.getBankCode());
		dto.setBankName(fiBudgetCap.getBankName());
		dto.setAccountsetid(String.valueOf(fiBudgetCap.getAccountSetId()));
//		dto.setAccountCapId(fiBudgetCap.getAccountCapId() == null ? "":fiBudgetCap.getAccountCapId().toString());
		dto.setAccountCapCode(fiBudgetCap.getAccountCapCode());
		dto.setAccountCapName(fiBudgetCap.getAccountCapName());
		dto.setBid(fiBudgetCap.getBid());
		dto.setCompanyId(fiBudgetCap.getCompanyId());
		try{
			SimpleDateFormat sf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
			if(fiBudgetCap.getCreateDate()!=null){
				dto.setCreateDate(sf.format(fiBudgetCap.getCreateDate()));
			}
		}catch(Exception e){
			e.printStackTrace();
		}
		return dto;
	}

	/**
	 * 将预算科目保存代码
	 * 
	 * @param fiBudgetCap
	 */
	public void saveOrUpdate(FiCollectionTypeCap fiBudgetCap) {
		getDao().saveOrUpdate(fiBudgetCap);
	}

}
