package com.xinleju.erp.frame.filter;

import java.io.IOException;

import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class CASUrlADLoginFilter  implements Filter{
	ScriptEngineManager sem = new ScriptEngineManager(); 
	ScriptEngine se = sem.getEngineByName("javascript"); 

	@Override
	public void doFilter(ServletRequest arg0, ServletResponse arg1,
			FilterChain chain) throws IOException, ServletException {
		// TODO Auto-generated method stub
		HttpServletRequest request = (HttpServletRequest) arg0;
		HttpServletResponse response = (HttpServletResponse) arg1;
		StringBuffer url=request.getRequestURL();
		
		//后台运算
		
//		 try {
//			
//	
//				se.eval("function showADUser(){"+"var   WshShell   =new   ActiveXObject('WScript.Shell');"+   "var user= WshShell.ExpandEnvironmentStrings('%USERNAME%'); " + "}");
//			    Invocable invocableEngine = (Invocable) se; 
//				 String callbackvalue=(String) invocableEngine.invokeFunction("showADUser"); 
//					 System.out.println(callbackvalue); 
//				
//		} catch (ScriptException e) {
//			// TODO Auto-generated catch block
//			e.printStackTrace();
//		} catch (NoSuchMethodException e) {
//			// TODO Auto-generated catch block
//			e.printStackTrace();
//		} 
//         
		
		 if(url.toString().toUpperCase().indexOf("HTTP")>=0){
			 boolean flag=false;
			 Cookie[] cookies=request.getCookies();
			 for(Cookie cookie:cookies){
				 if("CASTGC".equals(cookie.getName())){
					 flag=true;
				 }
			 }
			 //如果没有通过认证，则需要校验AD看看是否能登陆
			 if(!flag){
				 response.sendRedirect(request.getContextPath()+"/ADLogin.jsp");
			 }
		 }else{
			 chain.doFilter(arg0, response);
		 }
		
	}

	@Override
	public void destroy() {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void init(FilterConfig filterConfig) throws ServletException {
		// TODO Auto-generated method stub
		
	}

}
