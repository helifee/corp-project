package com.xinleju.erp.flow.action;

import java.util.HashMap;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.hibernate.FetchMode;
import org.hibernate.criterion.Criterion;
import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.Order;
import org.hibernate.criterion.Restrictions;
import org.springframework.beans.factory.annotation.Autowired;

import com.xinleju.erp.base.app.action.BaseAction;
import com.xinleju.erp.flow.frameapi.domain.User;
import com.xinleju.erp.flow.models.Fi;
import com.xinleju.erp.flow.models.Wi;
import com.xinleju.erp.flow.service.FlowService;
import com.xinleju.erp.flow.service.api.OrgnAPIService;

/**
 * 
 * 
 * 
 * <p>
 * 流程实例管理
 * </p>
 * 
 * <p>
 * </p>
 * 
 * @author 孙朝辉
 * @version $Id: FiAction.java 1014 2014-07-14 04:52:05Z sunchaohui $
 * @since
 * 
 */
public class FiAction extends BaseAction {

    /**
     * 流程Service
     */
    @Autowired
    private FlowService flowService;

    /**
     * 组织架构Service
     */
    @Autowired
    private OrgnAPIService orgnAPIService;

    /**
     * 
     * <p>
     * </p>
     * <p>
     * </p>
     * 
     * @author 孙朝辉
     * @return String JSP
     * 
     */
    public String list() {

        String fiName = getParameter("fiName");
        String isDisabled = getParameter("isDisabled", "0");

        DetachedCriteria dc = DetachedCriteria.forClass(Fi.class);
        dc.setFetchMode("fl", FetchMode.JOIN);

        if (StringUtils.isNotEmpty(fiName)) {
            dc.add(Restrictions.ilike("fiName", "%" + fiName + "%"));
        }
        if ("1".equals(isDisabled)) {
            dc.add(Restrictions.eq("isDisabled", 1));
        } else if ("0".equals(isDisabled)) {
            dc.add(Restrictions.or(new Criterion[] { Restrictions.eq("isDisabled", 0), Restrictions.isNull("isDisabled") }));
        }
        dc.addOrder(Order.desc("startTime"));
        page = getCommonService().findPage(dc, start, limit);

        return "list";
    }

    /**
     * 
     * 退回
     * 
     * @author 孙朝辉
     * 
     */
    public void previous1() {
        Long wiIdBackPoint = getParameterLong("wiId");
        User user = orgnAPIService.getUserByLoginName("admin");
        flowService.previous1ToAi(wiIdBackPoint, user, "", "aaa");
        Map<String, String> jsonMap = new HashMap<String, String>();

        super.renderJson(jsonMap);
    }

    /**
     * 
     * 结束工作
     * 
     * @author 孙朝辉
     * 
     */
    public void completeWi() {
        Long wiId = getParameterLong("wiId");
        User user = orgnAPIService.getUserByLoginName("admin");
        Wi i = getCommonService().getById(Wi.class, wiId);

        Fi fi = getCommonService().getById(Fi.class, i.getFiId());
        flowService.rebuildParticipant(fi);
        flowService.completeWi(wiId, user, "同意", Wi.OP_CODE_NEXT);
    }

    /**
     * 
     * 图形展示
     * 
     * @author 孙朝辉
     * @return 往往
     * 
     */
    public String graph() {
        return super.getReturnName();
    }

    /**
     * 
     * 禁用
     * 
     * @author 孙朝辉
     * 
     */
    public void delete() {
        if (ids != null) {
            for (Long id : ids) {
                getCommonService().execute("update Fi set isDisabled = 1 where id = ?", id);
            }
        }
        redirect("Fi!list.do", "isDisabled", "fiName", "start");
    }

    /**
     * 
     * 解禁
     * 
     * @author 孙朝辉
     * 
     */
    public void unDelete() {

        if (ids != null) {
            for (Long id : ids) {
                getCommonService().execute("update Fi set isDisabled = 0 where id = ?", id);
            }
        }
        redirect("Fi!list.do", "isDisabled", "fiName");
    }

    /**
     * 默认线条样式
     */
    private static final String STYLE_DEFAULT_EDGE = "shape=connector;labelBackgroundColor=white;rounded=1;edgeStyle=elbowEdgeStyle;"
            + "endArrow=classic;fontSize=12;align=center;verticalAlign:middle;strokeColor:blue;";

    /**
     * 折线条样式
     */
    private static final String STYLE_STRAIGHT_EDGE = "shape=connector;labelBackgroundColor=white;rounded=0;edgeStyle=;"
            + "endArrow=classic;fontSize=12;align=center;verticalAlign:middle;strokeColor:blue;";

    /**
     * 样式集合
     */
    private static Map<String, String> STYLE_MAP = new HashMap<String, String>();

    static {

        STYLE_MAP.put("deafultEgde", STYLE_DEFAULT_EDGE);
        STYLE_MAP.put("straightEdge", STYLE_STRAIGHT_EDGE);
    }
}
